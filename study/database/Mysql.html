<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>liuxiaowei | liuxiaowei</title>
    <meta name="description" content="liuxiaowei">
    <link rel="preload stylesheet" href="/assets/style.c16a06f1.css" as="style">
    <script type="module" src="/assets/app.1cd8677c.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
  <link rel="modulepreload" href="/assets/chunks/framework.0799945b.js">
  <link rel="modulepreload" href="/assets/chunks/theme.52324978.js">
  <link rel="modulepreload" href="/assets/study_database_mysql.md.1cc9680e.lean.js">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-b2cf3e0b><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c8616af1></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c8616af1> Skip to content </a><!--]--><!----><header class="VPNav" data-v-b2cf3e0b data-v-7e5bc4a5><div class="VPNavBar has-sidebar" data-v-7e5bc4a5 data-v-1d30fa41><div class="container" data-v-1d30fa41><div class="title" data-v-1d30fa41><div class="VPNavBarTitle has-sidebar" data-v-1d30fa41 data-v-f4ef19a3><a class="title" href="/" data-v-f4ef19a3><!--[--><!--]--><!--[--><img class="VPImage logo" src="/logo.png" alt data-v-6db2186b><!--]--><!--[-->liuxiaowei<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-1d30fa41><div class="curtain" data-v-1d30fa41></div><div class="content-body" data-v-1d30fa41><!--[--><!--]--><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-1d30fa41 data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="https://gitee.com/git_liuxiaowei" target="_blank" rel="noreferrer" tabindex="0" data-v-7f418b0f data-v-37adc828 data-v-8f4dc553><!--[-->gitee<!--]--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" height="24px" viewbox="0 0 24 24" width="24px" class="icon" data-v-8f4dc553><path d="M0 0h24v24H0V0z" fill="none"></path><path d="M9 5v2h6.59L4 18.59 5.41 20 17 8.41V15h2V5H9z"></path></svg></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-1d30fa41 data-v-f6a63727><label title="toggle dark mode" data-v-f6a63727 data-v-a9c8afb8><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-checked="false" data-v-a9c8afb8 data-v-f3c41672><span class="check" data-v-f3c41672><span class="icon" data-v-f3c41672><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-a9c8afb8><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-a9c8afb8><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></label></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-1d30fa41 data-v-0394ad82 data-v-f6988cfb><!--[--><a class="VPSocialLink" href="https://github.com/liuxiaowei2018" aria-label="github" target="_blank" rel="noopener" data-v-f6988cfb data-v-c530cc0a><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink" href="..." aria-label target="_blank" rel="noopener" data-v-f6988cfb data-v-c530cc0a><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Dribbble</title><path d="M12...6.38z"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-1d30fa41 data-v-40855f84 data-v-764effdf><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-764effdf><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-764effdf><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-764effdf><div class="VPMenu" data-v-764effdf data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-40855f84><div class="item appearance" data-v-40855f84><p class="label" data-v-40855f84>Appearance</p><div class="appearance-action" data-v-40855f84><label title="toggle dark mode" data-v-40855f84 data-v-a9c8afb8><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-checked="false" data-v-a9c8afb8 data-v-f3c41672><span class="check" data-v-f3c41672><span class="icon" data-v-f3c41672><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-a9c8afb8><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-a9c8afb8><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></label></div></div></div><div class="group" data-v-40855f84><div class="item social-links" data-v-40855f84><div class="VPSocialLinks social-links-list" data-v-40855f84 data-v-f6988cfb><!--[--><a class="VPSocialLink" href="https://github.com/liuxiaowei2018" aria-label="github" target="_blank" rel="noopener" data-v-f6988cfb data-v-c530cc0a><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink" href="..." aria-label target="_blank" rel="noopener" data-v-f6988cfb data-v-c530cc0a><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Dribbble</title><path d="M12...6.38z"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-1d30fa41 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav" data-v-b2cf3e0b data-v-f5a2ca58><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-f5a2ca58><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-f5a2ca58><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-f5a2ca58>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-f5a2ca58 data-v-079b16a8><button data-v-079b16a8>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-b2cf3e0b data-v-139a1f1d><div class="curtain" data-v-139a1f1d></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-139a1f1d><span class="visually-hidden" id="sidebar-aria-label" data-v-139a1f1d> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-139a1f1d><section class="VPSidebarItem level-0" data-v-139a1f1d data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>JavaSe</h2><!----></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/java/started.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Java基础</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/java/feature.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Java新特性</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/java/JUC.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Java多线程</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/java/JVM.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>JVM调优</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/java/reactive.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Java响应式编程</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-139a1f1d><section class="VPSidebarItem level-0" data-v-139a1f1d data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>数据结构&算法</h2><!----></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/algorithm/%E6%95%B0%E7%BB%84%E4%B8%8E%E9%93%BE%E8%A1%A8.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>数组与链表</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/algorithm/%E9%98%9F%E5%88%97%E4%B8%8E%E6%A0%88.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>队列与栈</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/algorithm/%E4%BA%8C%E5%8F%89%E6%A0%91.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>二叉树</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/algorithm/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>动态规划</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/algorithm/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>数据结构设计</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-139a1f1d><section class="VPSidebarItem level-0 has-active" data-v-139a1f1d data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>数据库</h2><!----></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link is-active has-active" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/database/mysql.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>mysql</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/database/oracle.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>oracle</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/database/postgreSQL.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>postgreSQL</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/database/mongoDB.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>mongoDB</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-139a1f1d><section class="VPSidebarItem level-0" data-v-139a1f1d data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>缓存</h2><!----></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/cache/redis.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>redis</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/cache/memcached.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>memcached</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-139a1f1d><section class="VPSidebarItem level-0" data-v-139a1f1d data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>Spring</h2><!----></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/framework/spring.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>spring</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/framework/springBoot.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>springBoot</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/framework/springcloud.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>springCloud</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-139a1f1d><section class="VPSidebarItem level-0" data-v-139a1f1d data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>中间件</h2><!----></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/middleware/mq.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>消息队列中间件</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/middleware/db.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>数据库中间件</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/middleware/search.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>搜索中间件</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/middleware/task.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>任务调度中间件</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/middleware/flow.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>工作流中间件</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/middleware/auth.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>权限框架中间件</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/middleware/server.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>服务器中间件</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/middleware/alibaba.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>阿里中间件</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-139a1f1d><section class="VPSidebarItem level-0" data-v-139a1f1d data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>容器化技术</h2><!----></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/container/linux.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>linux</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/container/docker.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>docker</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/container/k8s.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>k8s</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-139a1f1d><section class="VPSidebarItem level-0" data-v-139a1f1d data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>大数据</h2><!----></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/bigdata/hdfs.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>hdfs</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-139a1f1d><section class="VPSidebarItem level-0" data-v-139a1f1d data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>工具&插件</h2><!----></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/util/log.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>log</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/util/doc.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>doc</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/util/guava.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>guava</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/util/hutool.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>hutool</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/util/mapstruct.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>mapstruct</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/util/forest.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>forest</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/util/easyexcel.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>easyexcel</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/util/asyncTool.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>asyncTool</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/util/vavr.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>vavr</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/study/util/feilong.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>feilong</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-b2cf3e0b data-v-a494bd1d><div class="VPDoc has-sidebar has-aside" data-v-a494bd1d data-v-c4b0d3cf><!--[--><!--]--><div class="container" data-v-c4b0d3cf><div class="aside" data-v-c4b0d3cf><div class="aside-curtain" data-v-c4b0d3cf></div><div class="aside-container" data-v-c4b0d3cf><div class="aside-content" data-v-c4b0d3cf><div class="VPDocAside" data-v-c4b0d3cf data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-3f215769 data-v-ff0f39c8><div class="content" data-v-ff0f39c8><div class="outline-marker" data-v-ff0f39c8></div><div class="outline-title" data-v-ff0f39c8>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-ff0f39c8><span class="visually-hidden" id="doc-outline-aria-label" data-v-ff0f39c8> Table of Contents for current page </span><ul class="root" data-v-ff0f39c8 data-v-8f12e865><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-c4b0d3cf><div class="content-container" data-v-c4b0d3cf><!--[--><!--]--><!----><main class="main" data-v-c4b0d3cf><div style="position:relative;" class="vp-doc _study_database_mysql" data-v-c4b0d3cf><div><p>MySQL</p><nav class="table-of-contents"><ul><li><a href="#数据库设计">数据库设计</a></li><li><a href="#存储引擎">存储引擎</a></li><li><a href="#版本差异">版本差异</a></li><li><a href="#缓冲池-buffer-pool">缓冲池(buffer pool)</a></li><li><a href="#innodb-引擎详解">InnoDB 引擎详解</a></li><li><a href="#执行过程">执行过程</a></li><li><a href="#索引">索引</a></li><li><a href="#查询性能优化">查询性能优化</a></li><li><a href="#sql优化">SQL优化</a></li><li><a href="#事务">事务</a><ul><li><a href="#acid">ACID</a></li><li><a href="#隔离级别">隔离级别</a></li><li><a href="#事务问题">事务问题</a></li></ul></li><li><a href="#锁">锁</a><ul><li><a href="#mysql锁">Mysql锁</a></li><li><a href="#死锁问题">死锁问题</a></li><li><a href="#索引与锁">索引与锁</a></li></ul></li><li><a href="#分库分表">分库分表</a></li><li><a href="#主从复制">主从复制</a></li><li><a href="#读写分离">读写分离</a></li><li><a href="#常见参数">常见参数</a></li><li><a href="#使用篇">使用篇</a><ul><li><a href="#基本操作">基本操作</a></li><li><a href="#进阶操作">进阶操作</a></li></ul></li><li><a href="#练习篇">练习篇</a><ul><li><a href="#mysql基础练习题1">Mysql基础练习题1</a></li><li><a href="#mysql基础练习题2">Mysql基础练习题2</a></li><li><a href="#mysql进阶练习题">Mysql进阶练习题</a></li></ul></li></ul></nav><h2 id="数据库设计" tabindex="-1">数据库设计 <a class="header-anchor" href="#数据库设计" aria-label="Permalink to &quot;数据库设计&quot;">​</a></h2><p><img src="/assets/image-20220319133458045.7fc3d431.png" alt="image-20220319133458045"></p><h4 id="需求分析阶段" tabindex="-1">需求分析阶段 <a class="header-anchor" href="#需求分析阶段" aria-label="Permalink to &quot;需求分析阶段&quot;">​</a></h4><blockquote><p>要进行数据库设计首先要了解用户需求，参与到用户需求分析中去，需求分析常用SA（Structured Analysis：结构化分析方法）强调开发方法的结构合理性以及所开发软件的结构合理性的软件开发方法，是生命周期法的继承与发展，是生命周期法与结构化程序设计思想的结合。</p><p>其基本思想是用系统工程的思想和工程化得方法，根据用户至上的原则，自始自终按照结构化、模块化，自顶向下地对系统进行分析与设计。建立的主要步骤如下：</p><ol><li>首先画系统的输入输出，先画顶层数据流程图（DFD：Data Flow Diagram），顶层数据流程图只包含一个加工，用以表示被开发的系统，然后考虑该系统有哪些输入、输出数据流。</li><li>画系统内部，即画下层数据流层图。</li></ol><p><img src="/assets/image-20220319133621428.69b7b21a.png" alt="image-20220319133621428"></p></blockquote><h4 id="概念设计阶段" tabindex="-1">概念设计阶段 <a class="header-anchor" href="#概念设计阶段" aria-label="Permalink to &quot;概念设计阶段&quot;">​</a></h4><blockquote><p>概念设计是整个数据库设计的关键，它是对需求分析阶段的成果进行综合，归档以及抽象出一个独立具体的DBMS模型，与具体的RDBMS产品无关。</p><p>在实际的开发中，常用E-R（Entity-Relationship：实体关系）图来表示，常用的工具PowerDesigner，可以实现CDM（概念数据模型）-&gt;LDM（逻辑数据模型）-&gt;PDM（物理数据模型）-&gt;Database的自动转换，这个过程称为<strong>正向工程</strong>，如果有database建库脚本，也可以通过PowerDesigner工具生成CDM，即Database-&gt;PDM-&gt;LDM-&gt;CDM，称为<strong>反向工程</strong>。</p><p><img src="/assets/image-20220319133720174.dd6c7a02.png" alt="image-20220319133720174"></p></blockquote><h4 id="逻辑设计阶段" tabindex="-1">逻辑设计阶段 <a class="header-anchor" href="#逻辑设计阶段" aria-label="Permalink to &quot;逻辑设计阶段&quot;">​</a></h4><blockquote><p>逻辑设计阶段是将概念数据模型转换为具体的DBMS所支持的数据模型，并将进行优化。</p><p>虽然LDM独立于DBMS的，但可以进行外键，索引，视图等对象的设计工作。</p><p>在此阶段，各子模块的E-R图之间的冲突主要有三类：属性冲突，命名冲突和结构冲突，同时E-R图向关系模型的转换，要解决如何将实体性和实体间的联系转换为关系模式，确定这些关系模式的属性和码，实际开发中，逻辑设计阶段不是必须的，有些是从CDM直接到PDM了。</p></blockquote><h4 id="数据库选型" tabindex="-1">数据库选型 <a class="header-anchor" href="#数据库选型" aria-label="Permalink to &quot;数据库选型&quot;">​</a></h4><blockquote><p>数据库选型是非常重要的环节，一般在需求分析完成之后，通过架构评审会进行确认，数据库方面主要包括数据存储，检索，安全，读写分离，分库分表，数据归档，接入数据仓库都要进行确认，根据业务的场景对相关的数据库产品进行调研比对，选择最适合业务场景的数据库作为存储。</p></blockquote><h4 id="物理设计阶段" tabindex="-1">物理设计阶段 <a class="header-anchor" href="#物理设计阶段" aria-label="Permalink to &quot;物理设计阶段&quot;">​</a></h4><blockquote><p>逻辑设计阶段和数据库选型完成之后，就可以通过LDM生成PDM了，在物理设计阶段，需要设计跟RDBMS相关的对象，例如设计存储过程，触发器，用户自定义函数，表空间等。</p><p><img src="/assets/image-20220319133922185.8f02f0f1.png" alt="image-20220319133922185"></p></blockquote><h4 id="数据库实施阶段" tabindex="-1">数据库实施阶段 <a class="header-anchor" href="#数据库实施阶段" aria-label="Permalink to &quot;数据库实施阶段&quot;">​</a></h4><blockquote><p>例如选择的是sql数据库，通过PDM生成数据库的建库脚本之后，需要进行规范性检查，通过之后就可以创建表结构，规范性检查可以借助开源的SQL审核工具，如Yearning，Archery都可以设置规则，检查之后会给出整改建议，能够帮我们自动实现SQL Review。Yearning是用go开发，目前只支持sql数据库，Archery可以支持多种数据库。</p><p><img src="/assets/image-20220319133952992.18180bcb.png" alt="image-20220319133952992"></p></blockquote><h4 id="数据库维护阶段" tabindex="-1">数据库维护阶段 <a class="header-anchor" href="#数据库维护阶段" aria-label="Permalink to &quot;数据库维护阶段&quot;">​</a></h4><blockquote><p>数据库维护阶段主要包括业务支撑和数据库运维</p><p><img src="/assets/640-16476684267637.cfad965e.jpeg" alt="图片"></p></blockquote><h2 id="存储引擎" tabindex="-1">存储引擎 <a class="header-anchor" href="#存储引擎" aria-label="Permalink to &quot;存储引擎&quot;">​</a></h2><p><img src="/assets/image-20220329182103809.49e4cda0.png" alt="image-20220329182103809"></p><ul><li><p>连接层：主要完成客户端的连接处理，授权，检查连接数。</p></li><li><p>服务层：绝大部分的核心功能都是在服务层完成，sql接口，解析器，优化器，缓存。</p></li><li><p>引擎层：可插拔式的存储引擎。索引实在存储引擎层实现的。</p></li><li><p>存储层：日志，数据，索引等。</p></li></ul><h4 id="innodb" tabindex="-1">InnoDB <a class="header-anchor" href="#innodb" aria-label="Permalink to &quot;InnoDB&quot;">​</a></h4><blockquote><p>InnoDB 是 sql 默认的事务型存储引擎，只要在需要它不支持的特性时，才考虑使用其他存储引擎。</p><p>InnoDB 采用 MVCC 来支持高并发，并且实现了四个标准隔离级别(未提交读、提交读、可重复读、可串行化)。其默认级别时可重复读（REPEATABLE READ），在可重复读级别下，通过 MVCC + Next-Key Locking 防止幻读。</p><p>主索引时聚簇索引，在索引中保存了数据，从而避免直接读取磁盘，因此对主键查询有很高的性能。</p><p>InnoDB 内部做了很多优化，包括从磁盘读取数据时采用的可预测性读，能够自动在内存中创建 hash 索引以加速读操作的自适应哈希索引，以及能够加速插入操作的插入缓冲区等。</p><p>InnoDB 支持真正的在线热备份，sql 其他的存储引擎不支持在线热备份，要获取一致性视图需要停止对所有表的写入，而在读写混合的场景中，停止写入可能也意味着停止读取。</p></blockquote><p>存储文件</p><blockquote><p>xxx.ibd：xxx表示表名，InnoDB 引擎的每张表都会对应一个这样的表空间文件，存储该表的表结构（frm（8.0之后表结构存储到了sdi）、sdi）、数据和索引。</p><p>参数：innodb_file_per_table 8.0版本这个参数是打开的，每一张表有自己的表空间</p></blockquote><h4 id="myisam" tabindex="-1">MyISAM <a class="header-anchor" href="#myisam" aria-label="Permalink to &quot;MyISAM&quot;">​</a></h4><blockquote><p>提供了大量的特性，包括压缩表、空间数据索引等</p><p>不支持事务</p><p>不支持行级锁，只能对整张表加锁，读取时会对需要读到的所有表加共享锁，写入时则对表加排它锁。但在表有读取操作的同时，也可以往表中插入新的记录，这被称为并发插入（CONCURRENT INSERT）</p><p>如果指定了 DELAY_KEY_WRITE 选项，在每次修改执行完成时，不会立即将修改的索引数据写入磁盘，而是会写到内存中的键缓冲区，只有在清理键缓冲区或者关闭表的时候才会将对应的索引块写入磁盘。这种方式可以极大的提升写入性能，但是在数据库或者主机崩溃时会造成索引损坏，需要执行修复操作。</p></blockquote><p>存储文件</p><blockquote><p>xxx.sdi: 存储表结构信息</p><p>xxx.MYD: 存储表数据</p><p>xxx.MYI: 存储索引</p></blockquote><h4 id="memory" tabindex="-1">Memory <a class="header-anchor" href="#memory" aria-label="Permalink to &quot;Memory&quot;">​</a></h4><p>介绍</p><blockquote><p>Memory 引擎的表数据是存放在内存中的，由于受到硬件问题或断点问题的影响，只能将这些表作为临时表或者缓存使用。</p></blockquote><p>特点</p><blockquote><p>内存存放</p><p>hash索引(默认)</p></blockquote><p>文件</p><blockquote><p>xxx.sdi: 存储表结构信息</p></blockquote><h4 id="innodb-和-myisam-的比较" tabindex="-1">InnoDB 和 MyISAM 的比较 <a class="header-anchor" href="#innodb-和-myisam-的比较" aria-label="Permalink to &quot;InnoDB 和 MyISAM 的比较&quot;">​</a></h4><ul><li>事务：InnoDB 是事务型的，可以使用 Commit 和 Rollback 语句。</li><li>并发：MyISAM 只支持表级锁，而 InnoDB 还支持行级锁。</li><li>外键：InnoDB 支持外键。</li><li>备份：InnoDB 支持在线热备份。</li><li>崩溃恢复：MyISAM 崩溃后发生损坏的概率比 InnoDB 高很多，而且恢复的速度也更慢。</li><li>其它特性：MyISAM 支持压缩表和空间数据索引。</li></ul><table><thead><tr><th style="text-align:center;">特点</th><th style="text-align:center;">InnoDB</th><th style="text-align:center;">MyISAM</th><th style="text-align:center;">Memory</th></tr></thead><tbody><tr><td style="text-align:center;">存储限制</td><td style="text-align:center;">64TB</td><td style="text-align:center;">有</td><td style="text-align:center;">有</td></tr><tr><td style="text-align:center;">事务安全</td><td style="text-align:center;">支持</td><td style="text-align:center;">-</td><td style="text-align:center;">-</td></tr><tr><td style="text-align:center;">锁机制</td><td style="text-align:center;">行锁</td><td style="text-align:center;">表锁</td><td style="text-align:center;">表锁</td></tr><tr><td style="text-align:center;">B+Tree索引</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持</td></tr><tr><td style="text-align:center;">Hash索引</td><td style="text-align:center;">-</td><td style="text-align:center;">-</td><td style="text-align:center;">支持</td></tr><tr><td style="text-align:center;">全文索引</td><td style="text-align:center;">支持(5.6版本之后)</td><td style="text-align:center;">支持</td><td style="text-align:center;">-</td></tr><tr><td style="text-align:center;">空间使用</td><td style="text-align:center;">高</td><td style="text-align:center;">低</td><td style="text-align:center;">N/A</td></tr><tr><td style="text-align:center;">内存使用</td><td style="text-align:center;">高</td><td style="text-align:center;">低</td><td style="text-align:center;">中等</td></tr><tr><td style="text-align:center;">批量插入速度</td><td style="text-align:center;">低</td><td style="text-align:center;">高</td><td style="text-align:center;">高</td></tr><tr><td style="text-align:center;">支持外键</td><td style="text-align:center;">支持</td><td style="text-align:center;">-</td><td style="text-align:center;">-</td></tr></tbody></table><h4 id="存储引擎选择" tabindex="-1">存储引擎选择 <a class="header-anchor" href="#存储引擎选择" aria-label="Permalink to &quot;存储引擎选择&quot;">​</a></h4><p>在选择存储引擎时，应该根据应用系统的特点选择合适的存储引擎。对于复杂的应用系统，还可以更具实际情况选择多种引擎进行组合。</p><blockquote><p>InnoDB ：是sql 的默认引擎，支持事务外键，对事务完整性要求比较高，要求一定并发条件下数据一致性，除查询和插入外还包括更新删除操作，InnoDB 比较适合</p><p>MyISAM ：以读操作插入操作为主少有更新和删除操作，并对事务的完整性，并发要求不是很高，MyISAM 比较适合</p><p>Memory 访问速度快，对于大数据表无法缓存在内存中，而且无法保证数据安全性。</p></blockquote><p><strong>在实际业务开发过程中MyISAM 被MongoDB 取代了，Memory 被Redis 取代了</strong></p><h2 id="版本差异" tabindex="-1">版本差异 <a class="header-anchor" href="#版本差异" aria-label="Permalink to &quot;版本差异&quot;">​</a></h2><h2 id="缓冲池-buffer-pool" tabindex="-1">缓冲池(buffer pool) <a class="header-anchor" href="#缓冲池-buffer-pool" aria-label="Permalink to &quot;缓冲池(buffer pool)&quot;">​</a></h2><p>sql作为一个存储系统，具有<strong>缓冲池</strong>(buffer pool)机制，以避免每次查询数据都进行磁盘IO。</p><p><strong>InnoDB的缓冲池缓存什么？有什么用？</strong></p><p>缓存表数据与索引数据，把磁盘上的数据加载到缓冲池，避免每次访问都进行磁盘IO，起到加速访问的作用。</p><p>速度快，那<strong>为啥不把所有数据都放到缓冲池里</strong>？</p><p>凡事都具备两面性，抛开数据易失性不说，访问快速的反面是存储容量小：</p><p>（1）缓存访问快，但容量小，数据库存储了200G数据，缓存容量可能只有64G；</p><p>（2）内存访问快，但容量小，买一台笔记本磁盘有2T，内存可能只有16G；</p><p>因此，只能把“最热”的数据放到“最近”的地方，以“最大限度”的降低磁盘访问。</p><p><strong>什么是预读？</strong></p><p>磁盘读写，并不是按需读取，而是按页读取，一次至少读一页数据（一般是4K），如果未来要读取的数据就在页中，就能够省去后续的磁盘IO，提高效率。</p><p><strong>预读为什么有效？</strong></p><p>数据访问，通常都遵循“集中读写”的原则，使用一些数据，大概率会使用附近的数据，这就是所谓的“局部性原理”，它表明提前加载是有效的，确实能够减少磁盘IO。</p><p><strong>按页(4K)读取，和InnoDB的缓冲池设计有啥关系？</strong></p><p>（1）磁盘访问按页读取能够提高性能，所以缓冲池一般也是按页缓存数据；</p><p>（2）预读机制启示了我们，能把一些“可能要访问”的页提前加入缓冲池，避免未来的磁盘IO操作；</p><p><strong>InnoDB是以什么算法，来管理这些缓冲页呢？</strong></p><p>最容易想到的，就是LRU(Least recently used)。</p><p><em>画外音：memcache，OS都会用LRU来进行页置换管理，但sql的玩法并不一样。</em></p><p><strong>传统的LRU是如何进行缓冲页管理？</strong></p><p>最常见的玩法是，把入缓冲池的页放到LRU的头部，作为最近访问的元素，从而最晚被淘汰。这里又分两种情况：</p><p>（1）<strong>页已经在缓冲池里</strong>，那就只做“移至”LRU头部的动作，而没有页被淘汰；</p><p>（2）<strong>页不在缓冲池里</strong>，除了做“放入”LRU头部的动作，还要做“淘汰”LRU尾部页的动作；</p><p><strong>传统的LRU缓冲池算法十分直观</strong>，OS，memcache等很多软件都在用，<strong>sql为啥这么矫情，不能直接用呢？</strong></p><p>这里有两个问题：</p><p>（1）预读失效；</p><p>（2）缓冲池污染；</p><p><strong>什么是预读失效？</strong></p><p>由于预读(Read-Ahead)，提前把页放入了缓冲池，但最终sql并没有从页中读取数据，称为预读失效。</p><p><strong>如何对预读失效进行优化？</strong></p><p>要优化预读失效，思路是：</p><p>（1）让预读失败的页，停留在缓冲池LRU里的时间尽可能短；</p><p>（2）让真正被读取的页，才挪到缓冲池LRU的头部；</p><p>以保证，真正被读取的热数据留在缓冲池里的时间尽可能长。</p><p>具体方法是：</p><p>（1）将LRU分为两个部分：</p><p>- 新生代(new sublist)</p><p>- 老生代(old sublist)</p><p>（2）新老生代收尾相连，即：新生代的尾(tail)连接着老生代的头(head)；</p><p>（3）新页（例如被预读的页）加入缓冲池时，只加入到老生代头部：</p><p>- 如果数据真正被读取（预读成功），才会加入到新生代的头部</p><p>- 如果数据没有被读取，则会比新生代里的“热数据页”更早被淘汰出缓冲池</p><p><strong>上述原理，对应InnoDB里哪些参数？</strong></p><p>有三个比较重要的参数。</p><p><strong>参数</strong>：innodb_buffer_pool_size</p><p><strong>介绍</strong>：配置缓冲池的大小，在内存允许的情况下，DBA往往会建议调大这个参数，越多数据和索引放到内存里，数据库的性能会越好。</p><p><strong>参数</strong>：innodb_old_blocks_pct</p><p><strong>介绍</strong>：老生代占整个LRU链长度的比例，默认是37，即整个LRU中新生代与老生代长度比例是63:37。</p><p><em>画外音：如果把这个参数设为100，就退化为普通LRU了。</em></p><p><strong>参数</strong>：innodb_old_blocks_time</p><p><strong>介绍</strong>：老生代停留时间窗口，单位是毫秒，默认是1000，即同时满足“被访问”与“在老生代停留时间超过1秒”两个条件，才会被插入到新生代头部。</p><p><strong>总结</strong></p><p>（1）缓冲池(buffer pool)是一种<strong>常见的降低磁盘访问的机制；</strong></p><p>（2）缓冲池通常<strong>以页(page)为单位缓存数据；</strong></p><p>（3）缓冲池的<strong>常见管理算法是LRU</strong>，memcache，OS，InnoDB都使用了这种算法；</p><p>（4）InnoDB对普通LRU进行了优化：</p><p>- 将缓冲池分为<strong>老生代和新生代</strong>，入缓冲池的页，优先进入老生代，页被访问，才进入新生代，以解决预读失效的问题</p><p>- 页被访问，且在老生代<strong>停留时间超过配置阈值</strong>的，才进入新生代，以解决批量数据访问，大量热数据淘汰的问题</p><h2 id="innodb-引擎详解" tabindex="-1">InnoDB 引擎详解 <a class="header-anchor" href="#innodb-引擎详解" aria-label="Permalink to &quot;InnoDB 引擎详解&quot;">​</a></h2><p>InnoDB 是sql5.5 版本之后的默认的存储引擎。</p><h4 id="逻辑存储结构" tabindex="-1">逻辑存储结构 <a class="header-anchor" href="#逻辑存储结构" aria-label="Permalink to &quot;逻辑存储结构&quot;">​</a></h4><p><img src="/assets/7cb0c00ecaca4043ac877bce74192f83.322401ba.png" alt="在这里插入图片描述"></p><p>表空间（ibd文件），一个sql 实例可以对应多个表空间，用于存储记录、索引等数据。</p><p>段（Segment），分为数据段（Leaf node segment）、索引段（Non-leaf node segment）、回滚段（Rollbak segment）。InnoDB 是索引组织表，数据段就是B+tree的叶子节点，索引段即为B+Tree的非叶子节点。段用来管理多个Extent。</p><p>区（Extent）表空间的单元结构，每个区的大小为1M，默认情况下InnoDB 存储引擎页大小为16k，即一个区中一共有64个连续的页。</p><p>页（Page），是InnoDB 存储引擎磁盘管理的最小单元，每个页默认大小为16k。为了保证页的连续性，InnoDB 存储引擎每次从磁盘申请4-5个区。</p><p>行（Row），InnoDB 存储引擎数据是按行存放的。</p><blockquote><p>Trx_id: 每次对某条记录进行改动时，都会把对应的事务id 赋值给trx_id 隐藏列</p><p>Rool_pointer：每次对某条记录进行改动时，都会把旧的版本写入到undo日志中，然后这个隐藏列相当于一个指针，可以通过它来找到该记录的修改前的信息。</p></blockquote><h4 id="架构" tabindex="-1">架构 <a class="header-anchor" href="#架构" aria-label="Permalink to &quot;架构&quot;">​</a></h4><p>sql5.5 版本开始，默认使用InnoDB 存储引擎，它擅长事务处理，具有崩溃恢复特性，在日常开发中使用非常广泛，下面是InnoDB 架构图，左侧为内存结构，右侧为磁盘结构。</p><p><img src="/assets/2283e74ec8204095b88a9436281d2339.8315bf98.png" alt="在这里插入图片描述(https://img-blog.csdnimg.cn/7cb0c00ecaca4043ac877bce74192f83.png"></p><h5 id="内存结构" tabindex="-1">内存结构 <a class="header-anchor" href="#内存结构" aria-label="Permalink to &quot;内存结构&quot;">​</a></h5><p><img src="/assets/f3108f3468e2427abf81e0cffee424f3.3ab7a443.png" alt="在这里插入图片描述"></p><h6 id="buffer-pool" tabindex="-1">Buffer Pool <a class="header-anchor" href="#buffer-pool" aria-label="Permalink to &quot;Buffer Pool&quot;">​</a></h6><p>缓冲池是主内存中的一个区域，里面可以缓存磁盘上进场操作的真实数据，在执行增删改查操作时，先操作缓冲池的数据（若缓冲池没有数据，则从磁盘加载并缓存），然后再以一定频率刷新到磁盘，从而减少磁盘IO，加快处理速度。</p><p>缓冲池有一个一个的块，叫做缓冲池。缓冲池以Page页为单位，底层采用链表数据结构管理Page。根据状态Page 被分为3类：</p><ul><li>free page：空闲page，未被使用。</li><li>clean page：被使用page，数据没有被修改过。</li><li>dirty page：脏页，被使用page，数据被修改过，数据与磁盘的数据产生了不一致</li></ul><h6 id="change-buffer" tabindex="-1">Change Buffer <a class="header-anchor" href="#change-buffer" aria-label="Permalink to &quot;Change Buffer&quot;">​</a></h6><p>更改缓冲区（针对于非一二级所以页），在执行DML 语句时，如果这些数据Page 没有在Buffer Pool 中，不会直接操作磁盘，而会将数据变更存在缓冲区Change Buffer 中，在未来数据被读取时，再将数据合并恢复到Buffer Pool 中，再讲合并后的数据刷新到磁盘中。</p><p><img src="/assets/646c6d7df7044d03a75eeecb89023bdd.832edb9e.png" alt="在这里插入图片描述"></p><p><strong>Change Buffer的意义</strong></p><p>与聚集索引不同，二级索引通常是非唯一的，并且以相对随机的顺序插入二级索引。同样，删除和更新可能会影响数中不相邻的二级索引页。如果每一次都操作磁盘，会造成大量磁盘IO，有了Change Buffer 之后，我们可以在缓冲池进行合并处理，减少磁盘IO。</p><h6 id="adaptive-hash-index" tabindex="-1">Adaptive Hash Index <a class="header-anchor" href="#adaptive-hash-index" aria-label="Permalink to &quot;Adaptive Hash Index&quot;">​</a></h6><p>hash 索引最大优势在于快，因为他只需要一次匹配就可以完成（前提是不存在hash冲突的情况下），B+Tree 往往需要2-3次。但是他的弊端是不能够支持范围查询，只能做等值匹配。所以InnoDB 引擎就做了这个自适应hash 。</p><p>自适应hash 索引，用于优化对Buffer Pool 数据查询。InnoDB 存储引擎会监控对表上各索引的查询，如果观察到hash 索引可以提高速度，则建立hash 索引，称之为自适应hash 索引。</p><p><strong>自适应hash 索引，无须人工干预，是系统根据情况自动完成。</strong></p><p>参数：adaptive_hash_index</p><h6 id="log-buffer" tabindex="-1">Log Buffer <a class="header-anchor" href="#log-buffer" aria-label="Permalink to &quot;Log Buffer&quot;">​</a></h6><p>日志缓冲区，用来保存要写入到磁盘中的log日志数据（redo log，undo log），默认大小是16MB，日志缓冲区的日志会定期刷新到磁盘中。如果需要更新、插入删除许多行的事务，增加日志缓冲区的大小可以节省磁盘I/O。</p><p>参数：innodb_log_buffer_size（缓冲区大小），innodb_flush_log_at_trx_commit(日志刷新到磁盘的时机)</p><p>刷新时机默认是1,1 日志在每次事务提交时写入并刷新到磁盘，0 每秒将日志写入并刷新到磁盘一次， 2 日志在每次事务提交后写入并每秒刷新到磁盘一次。</p><h5 id="磁盘结构" tabindex="-1">磁盘结构 <a class="header-anchor" href="#磁盘结构" aria-label="Permalink to &quot;磁盘结构&quot;">​</a></h5><p><img src="/assets/a512f74dbdf7476191ccfd031c1dc2a1.a7cea57d.png" alt="在这里插入图片描述"></p><h6 id="system-tablespace" tabindex="-1">System Tablespace <a class="header-anchor" href="#system-tablespace" aria-label="Permalink to &quot;System Tablespace&quot;">​</a></h6><p>系统表空间是更新缓冲区存储的区域。如果表示在系统表空间而不是每个表文件或者通用表空间中创建的，它也可能包含表和索引的数据（在sql5.x版本中还包含InnoDB数据字典、undolog 等）</p><p>参数：innodb_data_file_path</p><h6 id="file-per-table-tablespaces" tabindex="-1">File-Per-Table Tablespaces <a class="header-anchor" href="#file-per-table-tablespaces" aria-label="Permalink to &quot;File-Per-Table Tablespaces&quot;">​</a></h6><p>每个表的文件表空间包含单个InnoDB 表的数据和索引，并存储在文件系统上的单个数据文件中。</p><p>参数：innodb_file_per_table</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 创建表空间</span></span>
<span class="line"><span style="color:#F78C6C;">create</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">tablespace</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">xxx</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">add</span><span style="color:#A6ACCD;"> datafile </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">xxx.ibd</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> engine </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> innodb;</span></span></code></pre></div><h6 id="general-tablespaces" tabindex="-1">General Tablespaces <a class="header-anchor" href="#general-tablespaces" aria-label="Permalink to &quot;General Tablespaces&quot;">​</a></h6><p>通用表空间，需要通过<code>Create tablespace</code>语法创建通用表空间，在创建表时，可以指定该表空间。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">xxx</span><span style="color:#A6ACCD;">(...) TABLESPACE xxxx;</span></span></code></pre></div><h6 id="undo-tablespaces" tabindex="-1">undo Tablespaces <a class="header-anchor" href="#undo-tablespaces" aria-label="Permalink to &quot;undo Tablespaces&quot;">​</a></h6><p>撤销表空间，sql 实例在初始化时会自动创建2个默认的undo表空间(初始大小为16M)，用于存储undo log日志。</p><h6 id="temporary-tablespaces" tabindex="-1">Temporary Tablespaces <a class="header-anchor" href="#temporary-tablespaces" aria-label="Permalink to &quot;Temporary Tablespaces&quot;">​</a></h6><p>InnoDB 使用会话临时表空间和全局临时表空间。存储用户会话和零时表等等数据。</p><h6 id="doublewrite-buffer-files" tabindex="-1">Doublewrite Buffer Files <a class="header-anchor" href="#doublewrite-buffer-files" aria-label="Permalink to &quot;Doublewrite Buffer Files&quot;">​</a></h6><p>双写缓冲区，innoDB 引擎将数据页从Buffer Pool 刷新到磁盘前，先将数据写入到双写缓冲区文件中，便于系统异常时恢复数据。</p><h6 id="redo-log" tabindex="-1">Redo Log <a class="header-anchor" href="#redo-log" aria-label="Permalink to &quot;Redo Log&quot;">​</a></h6><p>Redo Log 是用来实现事务的持久性。该日志文件由两部分组成。重做日志缓冲（redo log buffer）已经重做日志文件（redo log），前者是在内存中，后者在磁盘中。事务提交之后会把所有修改信息都会存到该日志中，用于在刷新脏页到磁盘时，发送错误时，进行数据恢复使用。以循环方式写入重做日志文件。</p><h5 id="后台线程" tabindex="-1">后台线程 <a class="header-anchor" href="#后台线程" aria-label="Permalink to &quot;后台线程&quot;">​</a></h5><p><img src="/assets/04c3467f0e0247df902eeb68ebb0fc8e.e92abc94.png" alt="在这里插入图片描述"></p><p>后台线程的作用就是将内存里缓冲池的数据在合适的时机刷新到磁盘文件当中。</p><h6 id="master-thread" tabindex="-1">Master Thread <a class="header-anchor" href="#master-thread" aria-label="Permalink to &quot;Master Thread&quot;">​</a></h6><p>核心后台线程，负责调度其他线程，还负责将缓冲池的数据异步刷新到磁盘中，保持数据一致性，还包括脏页的刷新、合并插入缓存、undo页的回收。</p><h6 id="io-thread" tabindex="-1">IO Thread <a class="header-anchor" href="#io-thread" aria-label="Permalink to &quot;IO Thread&quot;">​</a></h6><p>在InnoDB 存储引擎中大量使用了AIO 来处理IO 请求，这样可以极大地提高数据库的性能，从IO Thread 主要负责这些IO 请求的回调。</p><table><thead><tr><th style="text-align:center;">线程类型</th><th style="text-align:center;">默认个数</th><th style="text-align:center;">职责</th></tr></thead><tbody><tr><td style="text-align:center;">Read thread</td><td style="text-align:center;">4</td><td style="text-align:center;">负责读操作</td></tr><tr><td style="text-align:center;">Write thread</td><td style="text-align:center;">4</td><td style="text-align:center;">负责写操作</td></tr><tr><td style="text-align:center;">Log thread</td><td style="text-align:center;">1</td><td style="text-align:center;">负责将日志缓冲区刷新到磁盘</td></tr><tr><td style="text-align:center;">Insert buffer thread</td><td style="text-align:center;">1</td><td style="text-align:center;">负责将写缓冲区内容刷新到磁盘</td></tr></tbody></table><h6 id="purge-thread" tabindex="-1">Purge Thread <a class="header-anchor" href="#purge-thread" aria-label="Permalink to &quot;Purge Thread&quot;">​</a></h6><p>主要用于回收事务已经提交了的undo log，在事务提交之后，undo log 可能不用了，就用它来回收</p><h6 id="page-cleaner-thread" tabindex="-1">Page Cleaner Thread <a class="header-anchor" href="#page-cleaner-thread" aria-label="Permalink to &quot;Page Cleaner Thread&quot;">​</a></h6><p>协助 Master Thread 刷新脏页到磁盘的线程，他可以减轻Master Thread 的工作压力，减少阻塞。</p><p>当我们业务在操作的时候会直接操作sql 的缓冲区，如果缓冲区内没有数据，会将磁盘的数据加载进来，然后存储在缓冲区当中。在增删改查的时候会操作这个缓冲区里的数据。缓冲区的数据会以一定的频率，一定的时机通过后台线程刷新到磁盘当中，然后才持久化</p><h4 id="事务原理" tabindex="-1">事务原理 <a class="header-anchor" href="#事务原理" aria-label="Permalink to &quot;事务原理&quot;">​</a></h4><p>InnoDB 引擎很重要的一部分就是支持事务。</p><p>事务是一组操作的集合，他是一个不可分割的工作单位，事务会把所有的操作作为一个整体一起向系统提交或撤销操作请求，即这些操作要么同事成功，要么同事失败。</p><p>特性</p><ul><li>原子性（Atomicity）：事务是不可分割的最小操作单元，要么全部成功，要么全部失败。</li><li>一致性（Consistency）：事务完成时，必须使所有的数据都保持一致状态。</li><li>隔离性（Isolation）：数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行。</li><li>持久性（Durability）：事务一旦提交或回滚，它对数据库的数据改变就是永久的。</li></ul><p><img src="/assets/ead8e7ef676d47318f5131b3a79e441b.ae063464.png" alt="在这里插入图片描述"></p><h5 id="redo-log-1" tabindex="-1">redo log <a class="header-anchor" href="#redo-log-1" aria-label="Permalink to &quot;redo log&quot;">​</a></h5><p>我们所讲到的ACID 的持久性就是通过redo log 来保证的。</p><p>重做日志，记录的是事务提交时数据页的物理修改，是用来实现事务的持久性。</p><p>该日志文件由两部分组成：重做日志缓冲（redo log buffer）以及重做日志文件（redo log file），前者是在内存中，而后者在磁盘中当事务提交之后会把所有修改信息都存到该日志文件中，用于刷新脏页到磁盘，发生错误时，进行数据恢复使用。</p><p><img src="/assets/d8c3c8ec10a64f3f9c367bc67e6be53b.ff6ee27c.png" alt="在这里插入图片描述"></p><p>redo log 保证持久性。</p><h5 id="undo-log" tabindex="-1">undo log <a class="header-anchor" href="#undo-log" aria-label="Permalink to &quot;undo log&quot;">​</a></h5><p>回滚日志，用于记录数据被修改前的信息，作用包含2个：提供回滚和MVCC（多版本并发控制）。</p><p>undo log 和 redo log 记录物理日志不一样，它是逻辑日志。可以认为当delete 一条记录时，undo log 中会记录一条对应的insert 的记录，当update 一条记录时，它记录一条相对应相反的update 记录。当执行rollback 时，就可以从undo log 中逻辑记录读取到相应的内容并进行回滚。</p><p>undo log 销毁：undo log 在事务执行时，并不会立即删除undo log ，因为这些日志可能还用于MVCC 。</p><p>undo log 存储：undo log 采用段的方式进行管理记录。存放在rollback segment 回滚段中，内部包含了1024个undo log segment 。</p><p>undo log 保证事务的原子性，而undo log + redo log 保证事务的一致性。</p><h4 id="mvcc" tabindex="-1">MVCC <a class="header-anchor" href="#mvcc" aria-label="Permalink to &quot;MVCC&quot;">​</a></h4><h5 id="基本概念" tabindex="-1">基本概念 <a class="header-anchor" href="#基本概念" aria-label="Permalink to &quot;基本概念&quot;">​</a></h5><h6 id="当前读" tabindex="-1">当前读 <a class="header-anchor" href="#当前读" aria-label="Permalink to &quot;当前读&quot;">​</a></h6><p>读取的是当前记录的最新版本，读取时还要保证其他并发事务不能修改当前记录，会对读取的记录进行加锁。如：<code>select lock in share mode</code>，<code>select for update</code>，<code>update</code>，<code>insert</code>，<code>update</code>,<code>delete</code>（排他锁）都是一种当前读。</p><h6 id="快照读" tabindex="-1">快照读 <a class="header-anchor" href="#快照读" aria-label="Permalink to &quot;快照读&quot;">​</a></h6><p>简单的select(不加锁)就是快照读，读取的是记录数据的可见版本，有可能是历史数据，不加锁，是非阻塞读。</p><ul><li>RC 每次select，都生成快照读（因为每次都生成快照，所以会读到其他事务提交）。</li><li>RR 开启事务第一个select 语句才是快照读。</li><li>Serializable 快照读会退化为当前读。</li></ul><h6 id="mvcc-1" tabindex="-1">MVCC <a class="header-anchor" href="#mvcc-1" aria-label="Permalink to &quot;MVCC&quot;">​</a></h6><p>Mulit-Version Concurrency Control 多版本并发控制。指维护一个数据的多个版本，使得读写操作没有冲突，快照读为sql 实现的MVCC 提供了一个非阻塞读功能。MVCC 的具体实现，还需要依赖于数据库记录中的三个隐式字段、unlog 日志 readview。</p><h5 id="隐藏字段" tabindex="-1">隐藏字段 <a class="header-anchor" href="#隐藏字段" aria-label="Permalink to &quot;隐藏字段&quot;">​</a></h5><p>InnoDB 在创建表的时候会多创建2个字段，分别是<code>DB_TRX_ID</code>，<code>DB_ROLL_PTR</code>，<s><code>DB_ROW_ID</code></s>。</p><table><thead><tr><th style="text-align:center;">隐式字段</th><th style="text-align:center;">含义</th></tr></thead><tbody><tr><td style="text-align:center;">DB_TRX_ID</td><td style="text-align:center;">最近修改事务ID，记录插入这条记录或者最后修改该记录的事务ID</td></tr><tr><td style="text-align:center;">DB_ROLL_PTR</td><td style="text-align:center;">回滚指针，指向这条记录的上一个版本，用于配合undo log ,指向上一个版本</td></tr><tr><td style="text-align:center;">DB_ROW_ID</td><td style="text-align:center;">隐藏主键，如果表结果没有指定主键，将会生成该隐藏字段。</td></tr></tbody></table><h5 id="undo-log-版本链" tabindex="-1">undo log 版本链 <a class="header-anchor" href="#undo-log-版本链" aria-label="Permalink to &quot;undo log 版本链&quot;">​</a></h5><p>回滚日志，在insert update delete 的时候产生的便于数据回滚的日志。</p><p>当insert 的时候，产生的undo log 日志只在回滚时需要，在事务提交后，可被立即删除。</p><p>而update、delete 的时候产生的undo log 日志不仅在回滚是需要，在快照读时也需要，不会被立即删除。</p><p><img src="/assets/deda994a6d674820a58a2a7f90be6b0c.463fde62.png" alt="在这里插入图片描述"></p><p>不同事务或者相同事务对同一条记录进行修改，会导致该记录的undo log 生成一条记录版本链表，链表的头部是最新的旧记录，尾部是最旧的记录。</p><h5 id="readview-介绍" tabindex="-1">readview 介绍 <a class="header-anchor" href="#readview-介绍" aria-label="Permalink to &quot;readview 介绍&quot;">​</a></h5><p>读视图是快照读SQL 执行时MVCC 提取数据的一句，记录并维护系统当前活跃的事务（未提交的）ID</p><p>read view 包括了四个核心字段：</p><table><thead><tr><th style="text-align:center;">字段</th><th style="text-align:center;">含义</th></tr></thead><tbody><tr><td style="text-align:center;">m_ids</td><td style="text-align:center;">当前活跃的事务ID集合</td></tr><tr><td style="text-align:center;">min_trx_id</td><td style="text-align:center;">最小活跃事务ID</td></tr><tr><td style="text-align:center;">max_trx_id</td><td style="text-align:center;">预分配事务ID，当前最大事务ID+1（事务ID是自增的）</td></tr><tr><td style="text-align:center;">creator_trx_id</td><td style="text-align:center;">Read View 创建者的事务ID</td></tr></tbody></table><p cases="">$$ 版本链数据访问规则 \begin</p><ol><li>trx—id=creator—trx—id, &amp;可以访问该版本 (当前事务更改的)\</li><li>trx—id &lt; min—trx—id, &amp;可以访问该版本（数据已经提交）\</li><li>trx—id &gt; max—trx—id, &amp;不可以访问该版本（当前事务是在ReadView 生成之后开启的）\</li><li>min—trx—id \le trx—id \le max—trx—id, &amp;如果trx—id不在m-ids中是可以访问该版本的（事务已经提交） \end{cases} $$</li></ol><p>不同的事务隔离级别，生成的readview 的时机不同。</p><p>RC 每次都生成 readview ，RR 只在事务第一次执行快照读的时候生成readview，后续复用该readview。</p><h5 id="原理分析-rc" tabindex="-1">原理分析（RC） <a class="header-anchor" href="#原理分析-rc" aria-label="Permalink to &quot;原理分析（RC）&quot;">​</a></h5><p><strong>RC 每次都生成 readview 。</strong></p><p><img src="/assets/523bf7fa71a44597a819c24b2c572b26.9140b8b1.png" alt="在这里插入图片描述"></p><h5 id="原理分析-rr" tabindex="-1">原理分析（RR） <a class="header-anchor" href="#原理分析-rr" aria-label="Permalink to &quot;原理分析（RR）&quot;">​</a></h5><p><strong>事务在第一次执行快照读时生成ReadView，后续复用该ReadView。</strong></p><p><img src="/assets/7150cd69a4704ead84afc00af7e443d0.91efe162.png" alt="在这里插入图片描述"></p><p>MVCC 主要还是通过隐藏字段（事务id，回滚指针）、undo log 版本链，readview 实现，MVCC + 锁保证了事务的隔离性。</p><h2 id="执行过程" tabindex="-1">执行过程 <a class="header-anchor" href="#执行过程" aria-label="Permalink to &quot;执行过程&quot;">​</a></h2><h4 id="sql整体执行过程" tabindex="-1">sql整体执行过程 <a class="header-anchor" href="#sql整体执行过程" aria-label="Permalink to &quot;sql整体执行过程&quot;">​</a></h4><p><img src="/assets/1630733090640-66b4d893-01f9-4933-be98-2800a092bd8a.bba606ec.png" alt="img"></p><h4 id="执行状态" tabindex="-1">执行状态 <a class="header-anchor" href="#执行状态" aria-label="Permalink to &quot;执行状态&quot;">​</a></h4><p>通过命令:<code>show full processlist</code>，展示所有的处理进程</p><p><img src="/assets/1630733090517-4fe26933-f9a4-4687-9555-b6eff9ecfb7f.afba4daa.png" alt="2021-09-04-13-21-33-100573.png"></p><h4 id="sql执行顺序" tabindex="-1">sql执行顺序 <a class="header-anchor" href="#sql执行顺序" aria-label="Permalink to &quot;sql执行顺序&quot;">​</a></h4><p><img src="/assets/1630733090321-cab01f4c-e13d-4c7d-a959-04160f002c58.8e99cecf.png" alt="2021-09-04-13-21-33-280552.png"></p><h2 id="索引" tabindex="-1">索引 <a class="header-anchor" href="#索引" aria-label="Permalink to &quot;索引&quot;">​</a></h2><h4 id="b-tree" tabindex="-1">B+ Tree <a class="header-anchor" href="#b-tree" aria-label="Permalink to &quot;B+ Tree&quot;">​</a></h4><h5 id="数据结构" tabindex="-1">数据结构 <a class="header-anchor" href="#数据结构" aria-label="Permalink to &quot;数据结构&quot;">​</a></h5><blockquote><p>B Tree 指的是 Balance Tree，也就是平衡树，平衡树是一颗查找树，并且所有叶子节点位于同一层</p><p><strong>B+ Tree 是 B 树的一种变形，它是基于 B Tree 和叶子节点顺序访问指针进行实现，通常用于数据库和操作系统的文件系统中。</strong></p><p>B+ 树有两种类型的节点：内部节点（也称索引节点）和叶子节点，内部节点就是非叶子节点，内部节点不存储数据，只存储索引，数据都存在叶子节点。</p><p>内部节点中的 key 都按照从小到大的顺序排列，对于内部节点中的一个 key，左子树中的所有 key 都小于它，右子树中的 key 都大于等于它，叶子节点的记录也是按照从小到大排列的。每个叶子节点都存有相邻叶子节点的指针。</p><p><img src="/assets/image-20220319114855757.c0045009.png" alt="image-20220319114855757"></p></blockquote><h6 id="b-树与-b-树的比较" tabindex="-1">B + 树与 B 树的比较 <a class="header-anchor" href="#b-树与-b-树的比较" aria-label="Permalink to &quot;B + 树与 B 树的比较&quot;">​</a></h6><blockquote><p><strong>B+ 树的磁盘 IO 更低</strong></p><p>B+ 树的内部节点并没有指向关键字具体信息的指针。因此其内部节点相对 B 树更小。如果把所有同一内部结点的关键字存放在同一盘块中，那么盘块所能容纳的关键字数量也越多。一次性读入内存中的需要查找的关键字也就越多。相对来说IO读写次数也就降低了。</p><p><strong>B+ 树的查询效率更加稳定</strong></p><p>由于非叶子结点并不是最终指向文件内容的结点，而只是叶子结点中关键字的索引。所以任何关键字的查找必须走一条从根结点到叶子结点的路。所有关键字查询的路径长度相同，导致每一个数据的查询效率相当。</p><p><strong>B+ 树元素遍历效率高</strong></p><p>B 树在提高了磁盘IO性能的同时并没有解决元素遍历的效率低下的问题。正是为了解决这个问题，B+树应运而生。B+树只要遍历叶子节点就可以实现整棵树的遍历。而且在数据库中基于范围的查询是非常频繁的，而 B 树不支持这样的操作（或者说效率太低）。</p></blockquote><h5 id="操作" tabindex="-1">操作 <a class="header-anchor" href="#操作" aria-label="Permalink to &quot;操作&quot;">​</a></h5><h6 id="查找" tabindex="-1"><strong>查找</strong> <a class="header-anchor" href="#查找" aria-label="Permalink to &quot;**查找**&quot;">​</a></h6><blockquote><p>查找以典型的方式进行，类似于二叉查找树。起始于根节点，自顶向下遍历树，选择其分离值在要查找值的任意一边的子指针。在节点内部典型的使用是二分查找来确定这个位置。</p></blockquote><h6 id="插入" tabindex="-1"><strong>插入</strong> <a class="header-anchor" href="#插入" aria-label="Permalink to &quot;**插入**&quot;">​</a></h6><blockquote><p>二叉树插入</p></blockquote><h6 id="删除" tabindex="-1"><strong>删除</strong> <a class="header-anchor" href="#删除" aria-label="Permalink to &quot;**删除**&quot;">​</a></h6><blockquote><p>类似插入，只不过是自下而上的合并操作</p></blockquote><h4 id="sql-索引" tabindex="-1">sql 索引 <a class="header-anchor" href="#sql-索引" aria-label="Permalink to &quot;sql 索引&quot;">​</a></h4><p>索引（index）是帮助sql <strong>高效获取数据的有序数据结构</strong>。在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）数据，这样就可以在这些数据结构上实现高级查找算法，这种数据结构就是索引。</p><p>优缺点：</p><table><thead><tr><th style="text-align:center;">优点</th><th style="text-align:center;">缺点</th></tr></thead><tbody><tr><td style="text-align:center;">提高数据库检索的效率，降低数据库的IO成本</td><td style="text-align:center;">索引列也是需要占用空间的</td></tr><tr><td style="text-align:center;">通过索引列对数据进行排序，降低数据排序的成本，降低CPU的消耗。</td><td style="text-align:center;">索引大大提高了查询效率，同时也降低更新表的速度，如果对表进行INSERT，UPDATE，DELETE时，效率降低</td></tr></tbody></table><p>sql 的索引实在存储引擎层实现的，不同的存储引擎有不同的结构，主要包含以下几种：</p><table><thead><tr><th style="text-align:center;">索引结构</th><th style="text-align:center;">描述</th></tr></thead><tbody><tr><td style="text-align:center;">B+Tree索引</td><td style="text-align:center;">最常见的索引类型，大部分引擎都支持B+树索引</td></tr><tr><td style="text-align:center;">Hash索引</td><td style="text-align:center;">底层数据结构是hash表实现的，只有精确匹配索引列的查询才有效，不支持范围查询</td></tr><tr><td style="text-align:center;">R-Tree(空间索引)</td><td style="text-align:center;">空间索引是MyISAM 引擎的一个特殊索引类型，主要用于地理空间数据类型，通常使用较少</td></tr><tr><td style="text-align:center;">Full-Text(全文索引)</td><td style="text-align:center;">是一种通过建立倒排索引，快速匹配文档的方式。类似于Lucene，Solr，ES</td></tr></tbody></table><p>支持情况</p><table><thead><tr><th style="text-align:center;">索引</th><th style="text-align:center;">InnoDB</th><th style="text-align:center;">MyISAM</th><th style="text-align:center;">Memory</th></tr></thead><tbody><tr><td style="text-align:center;">B+Tree 索引</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持</td></tr><tr><td style="text-align:center;">Hash 索引</td><td style="text-align:center;">不支持</td><td style="text-align:center;">不支持</td><td style="text-align:center;">支持</td></tr><tr><td style="text-align:center;">R-Tree 索引</td><td style="text-align:center;">不支持</td><td style="text-align:center;">支持</td><td style="text-align:center;">不支持</td></tr><tr><td style="text-align:center;">Full-text</td><td style="text-align:center;">5.6版本之后支持</td><td style="text-align:center;">支持</td><td style="text-align:center;">不支持</td></tr></tbody></table><p>平时所说的索引，没有特别指明，都是B+Tree结构的索引。</p><h5 id="b-tree-索引" tabindex="-1">B+ Tree 索引 <a class="header-anchor" href="#b-tree-索引" aria-label="Permalink to &quot;B+ Tree 索引&quot;">​</a></h5><blockquote><p>sql 存储引擎的默认索引类型</p><ul><li>不需要进行全表扫描，只需要对树进行搜索即可，所以查找速度快很多。</li><li>因为 B+ Tree 的有序性，所以除了用于查找，还可以用于排序和分组。</li><li>可以指定多个列作为索引列，多个索引列共同组成键。</li><li>适用于全键值、键值范围和键前缀查找，其中键前缀查找只适用于最左前缀查找。如果不是按照索引列的顺序进行查找，则无法使用索引。</li></ul></blockquote><h6 id="聚簇索引" tabindex="-1">聚簇索引 <a class="header-anchor" href="#聚簇索引" aria-label="Permalink to &quot;聚簇索引&quot;">​</a></h6><blockquote><p>InnoDB 的 B+Tree 索引分为主索引和辅助索引。</p><p>主索引的叶子节点 data 域记录着完整的数据记录，这种索引方式被称为聚簇索引。</p><p>因为无法把数据行存放在两个不同的地方，所以一个表只能有一个聚簇索引。</p><p>每个InnoDB表都有一个聚簇索引 ，聚簇索引使用B+树构建，叶子节点存储的数据是整行记录。一般情况下，聚簇索引等同于主键索引，当一个表没有创建主键索引时，InnoDB会自动创建一个ROWID字段来构建聚簇索引。InnoDB创建索引的具体规则如下：</p><blockquote><ol><li>在表上定义主键PRIMARY KEY，InnoDB将主键索引用作聚簇索引。</li><li>如果表没有定义主键，InnoDB会选择第一个不为NULL的唯一索引列用作聚簇索引。</li><li>如果以上两个都没有，InnoDB 会使用一个6 字节长整型的隐式字段 ROWID字段构建聚簇索引。该ROWID字段会在插入新行时自动递增。</li></ol></blockquote><p><img src="/assets/image-20220319115633139.6f027030.png" alt="image-20220319115633139"></p></blockquote><h6 id="非聚簇索引-辅助索引" tabindex="-1">非聚簇索引(辅助索引) <a class="header-anchor" href="#非聚簇索引-辅助索引" aria-label="Permalink to &quot;非聚簇索引(辅助索引)&quot;">​</a></h6><blockquote><p>InnoDB辅助索引中的叶子节点存储的数据是该行的主键值。在检索时，InnoDB使用此主键值在聚簇索引中搜索行记录。</p><p>因此在使用辅助索引进行查找时，需要先查找到主键值，然后再到主索引中进行查找，这个过程也被称作<strong>回表</strong></p><p><img src="/assets/image-20220319115800358.39bacbe8.png" alt="image-20220319115800358"></p></blockquote><h5 id="哈希索引" tabindex="-1">哈希索引 <a class="header-anchor" href="#哈希索引" aria-label="Permalink to &quot;哈希索引&quot;">​</a></h5><blockquote><p>哈希索引能以 O(1) 时间进行查找，但是失去了有序性：</p><ul><li>无法用于排序与分组；</li><li>只支持精确查找，无法用于部分查找和范围查找。</li></ul><p>InnoDB 存储引擎有一个特殊的功能叫“自适应哈希索引”，当某个索引值被使用的非常频繁时，会在 B+Tree 索引之上再创建一个哈希索引，这样就让 B+Tree 索引具有哈希索引的一些优点，比如快速的哈希查找。</p></blockquote><h5 id="全文索引" tabindex="-1">全文索引 <a class="header-anchor" href="#全文索引" aria-label="Permalink to &quot;全文索引&quot;">​</a></h5><blockquote><p>MyISAM 存储引擎支持全文索引，用于查找文本中的关键词，而不是直接比较是否相等。</p><p>查找条件使用 MATCH AGAINST，而不是普通的 WHERE。</p><p>全文索引使用倒排索引实现，它记录着关键词到其所在文档的映射。</p><p>InnoDB 存储引擎在 sql 5.6.4 版本中也开始支持全文索引。</p><p>只能在文本类型CHAR,VARCHAR,TEXT类型字段上创建全文索引。字段长度比较大时，如果创建普通索引，在进行like模糊查询时效率比较低，这时可以创建全文索引。</p></blockquote><h5 id="空间数据索引" tabindex="-1">空间数据索引 <a class="header-anchor" href="#空间数据索引" aria-label="Permalink to &quot;空间数据索引&quot;">​</a></h5><blockquote><p>MyISAM 5.7之后存储引擎支持空间数据索引（R-Tree），可以用于地理数据存储。</p><p>空间数据索引从所有维度来索引数据，可以有效地使用任意维度来进行组合查询。</p><ul><li>必须使用 GIS 相关的函数来维护数据。</li></ul></blockquote><h5 id="索引分类1" tabindex="-1">索引分类1 <a class="header-anchor" href="#索引分类1" aria-label="Permalink to &quot;索引分类1&quot;">​</a></h5><ol><li><p>单列索引</p></li><li><p>组合索引</p><p>组合索引的使用，需要遵循<strong>最左前缀匹配原则（最左匹配原则）</strong>。一般情况下在条件允许的情况下使用组合索引替代多个单列索引使用。</p></li></ol><h5 id="索引分类2" tabindex="-1">索引分类2 <a class="header-anchor" href="#索引分类2" aria-label="Permalink to &quot;索引分类2&quot;">​</a></h5><table><thead><tr><th style="text-align:center;">分类</th><th style="text-align:center;">含义</th><th style="text-align:center;">特点</th><th style="text-align:center;">关键字</th></tr></thead><tbody><tr><td style="text-align:center;">主键索引</td><td style="text-align:center;">针对于表中主键的索引</td><td style="text-align:center;">默认自动创建，只能有一个</td><td style="text-align:center;">PRIMARY</td></tr><tr><td style="text-align:center;">唯一索引</td><td style="text-align:center;">避免同一个表中某数据列中的值重复</td><td style="text-align:center;">可以有多个</td><td style="text-align:center;">UNIQUE</td></tr><tr><td style="text-align:center;">常规索引</td><td style="text-align:center;">可以定位特定数据</td><td style="text-align:center;">可以有多个</td><td style="text-align:center;"></td></tr><tr><td style="text-align:center;">全文索引</td><td style="text-align:center;">全文索引查找的是文本中的关键字，而不是比较索引中的值</td><td style="text-align:center;">可以有多个</td><td style="text-align:center;">FULLTEXT</td></tr></tbody></table><h5 id="索引语法" tabindex="-1">索引语法 <a class="header-anchor" href="#索引语法" aria-label="Permalink to &quot;索引语法&quot;">​</a></h5><h6 id="创建索引" tabindex="-1"><strong>创建索引</strong> <a class="header-anchor" href="#创建索引" aria-label="Permalink to &quot;**创建索引**&quot;">​</a></h6><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> [UNIQUE|FULLTEXT] </span><span style="color:#F78C6C;">INDEX</span><span style="color:#A6ACCD;"> index_name </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> table_name (col0,col1,...);</span></span></code></pre></div><h6 id="查看索引" tabindex="-1"><strong>查看索引</strong> <a class="header-anchor" href="#查看索引" aria-label="Permalink to &quot;**查看索引**&quot;">​</a></h6><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">SHOW </span><span style="color:#F78C6C;">INDEX</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> table_name;</span></span></code></pre></div><h6 id="删除索引" tabindex="-1"><strong>删除索引</strong> <a class="header-anchor" href="#删除索引" aria-label="Permalink to &quot;**删除索引**&quot;">​</a></h6><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">DROP</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">INDEX</span><span style="color:#A6ACCD;"> index_name </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> table_name;</span></span></code></pre></div><h4 id="索引下推-icp" tabindex="-1">索引下推(ICP) <a class="header-anchor" href="#索引下推-icp" aria-label="Permalink to &quot;索引下推(ICP)&quot;">​</a></h4><blockquote><p>执行查询<code>explain</code>看见<code>Extra</code>中显示了<code>Using index condition</code>，表示出现了<strong>索引下推</strong>(代表可以使用，但是不一定真实使用)</p><p>某种场景下ICP通过联合索引中本来就有的数据直接过滤，不需要再查到一堆无用的数据去Server层进行过滤，这样的话减少了回表的次数和返回的数据，IO次数减少了，对性能有很好的提升。</p><ol><li>首先，ICP适用于range、ref、eq_ref和ref_or_null的场景下</li><li>InnoDB和MyISAM都支持ICP，sql partition分表的话也可以使用</li><li>对于InndoDB而言，ICP只支持二级索引，因为主键索引它用不上</li><li>子查询不支持</li></ol><p>sql5.6以上的版本，默认就是开启ICP</p><p>关闭命令<code>SET optimizer_switch = &#39;index_condition_pushdown=off&#39;;</code></p></blockquote><h4 id="索引失效" tabindex="-1">索引失效 <a class="header-anchor" href="#索引失效" aria-label="Permalink to &quot;索引失效&quot;">​</a></h4><blockquote><p><img src="/assets/image-20220319133051026.7e461954.png" alt="image-20220319133051026"></p><ul><li>当我们使用左或者左右模糊匹配的时候，也就是 <code>like %xx</code> 或者 <code>like %xx%</code> 这两种方式都会造成索引失效；</li><li>当我们在查询条件中对索引列使用函数，就会导致索引失效。</li><li>当我们在查询条件中对索引列进行表达式计算，也是无法走索引的。</li><li>sql 在遇到字符串和数字比较的时候，会自动把字符串转为数字，然后再进行比较。如果字符串是索引列，而条件语句中的输入参数是数字的话，那么索引列会发生隐式类型转换，由于隐式类型转换是通过 CAST 函数实现的，等同于对索引列使用了函数，所以就会导致索引失效。</li><li>联合索引要能正确使用需要遵循最左匹配原则，也就是按照最左优先的方式进行索引的匹配，否则就会导致索引失效。</li><li>在 WHERE 子句中，如果在 OR 前的条件列是索引列，而在 OR 后的条件列不是索引列，那么索引会失效。</li></ul></blockquote><h4 id="索引优化" tabindex="-1">索引优化 <a class="header-anchor" href="#索引优化" aria-label="Permalink to &quot;索引优化&quot;">​</a></h4><blockquote><p><strong>索引作用</strong></p><ul><li>大大减少了服务器需要扫描的数据行数。</li><li>帮助服务器避免进行排序和分组，以及避免创建临时表（B+Tree 索引是有序的，可以用于 ORDER BY 和 GROUP BY 操作。临时表主要是在排序和分组过程中创建，不需要排序和分组，也就不需要创建临时表）。</li><li>将随机 I/O 变为顺序 I/O（B+Tree 索引是有序的，会将相邻的数据都存储在一起）。</li></ul><p><strong>索引使用条件</strong></p><ul><li>对于非常小的表、大部分情况下简单的全表扫描比建立索引更高效(因为可能需要<strong>回表</strong>)</li><li>对于中到大型的表，索引就非常有效；</li><li>但是对于特大型的表，建立和维护索引的代价将会随之增长。这种情况下，需要用到一种技术可以直接区分出需要查询的一组数据，而不是一条记录一条记录地匹配，例如可以使用分区技术。</li></ul></blockquote><h5 id="独立列" tabindex="-1">独立列 <a class="header-anchor" href="#独立列" aria-label="Permalink to &quot;独立列&quot;">​</a></h5><blockquote><p>在进行查询时，索引列不能是表达式的一部分，也不能是函数的参数，否则无法使用索引</p></blockquote><h5 id="多列索引" tabindex="-1">多列索引 <a class="header-anchor" href="#多列索引" aria-label="Permalink to &quot;多列索引&quot;">​</a></h5><blockquote><p>在需要使用多个列作为条件进行查询时，使用多列索引比使用多个单列索引性能更好</p></blockquote><h5 id="索引列顺序" tabindex="-1">索引列顺序 <a class="header-anchor" href="#索引列顺序" aria-label="Permalink to &quot;索引列顺序&quot;">​</a></h5><blockquote><p>让选择性最强的索引列放在前面。</p><p>索引的选择性是指：不重复的索引值和记录总数的比值。最大值为 1，此时每个记录都有唯一的索引与其对应。</p><p>选择性越高，每个记录的区分度越高，查询效率也越高</p></blockquote><h5 id="前缀索引" tabindex="-1">前缀索引 <a class="header-anchor" href="#前缀索引" aria-label="Permalink to &quot;前缀索引&quot;">​</a></h5><p>表结构当中经常会出现文本类型的字段，当字段类型为字符串（varchar,text）时，有时候需要索引很长的字符串，这会让索引变得很大，查询时浪费大量的磁盘IO，影响查询效率，此时可以将字符串的一部分前缀建立索引，这样可以大大节约索引空间，从而提高索引效率。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">create</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">index</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">idx_xxx</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">on</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">table</span><span style="color:#A6ACCD;"> (column(N));</span></span></code></pre></div><p><strong>前缀长度</strong></p><p>可以根据索引的选择性来决定，而选择性是指不重复的索引值（基数）和表记录的总数的比值，索引选择性越高，查询效率越高。唯一索引的选择性是1，这是做好的索引选择性，性能也是最好的。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 查询截取前N个字符的不重复的记录 / 所有记录树 为该字段的选择性</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">count</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">DISTINCT</span><span style="color:#A6ACCD;">(</span><span style="color:#82AAFF;">substring</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">NAME</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">, N ))) </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">count</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span></span></code></pre></div><p><img src="/assets/8876a85413514db9ad70f8e55ab7c25d.4fc8501e.png" alt="在这里插入图片描述"></p><blockquote><p>对于 BLOB、TEXT 和 VARCHAR 类型的列，必须使用前缀索引，只索引开始的部分字符。</p><p>前缀长度的选取需要根据索引选择性来确定。</p></blockquote><h5 id="覆盖索引" tabindex="-1">覆盖索引 <a class="header-anchor" href="#覆盖索引" aria-label="Permalink to &quot;覆盖索引&quot;">​</a></h5><p>使用覆盖索引（查询使用了索引，并且需要返回的列，在该索引已经全部能够找到），减少<code>select * </code>。</p><p>在<code>Explain SQL</code>时关注Extra 列出现<code>using index condition</code>或者<code>NULL</code> 说明查找使用了索引，但是需要回表查询数据。</p><p><code>using where;using index</code>说明查找使用了索引，但是需要的数据都在索引列种能够找到，所以不需要回表查询。</p><p>当查询的字段不在索引种能够找到，从而查询聚集索引拿到数据，这样的操作称作回表。</p><p><img src="/assets/deaa720aeddd4c09aafe329969f8a3e8.64ec2dfd.png" alt="在这里插入图片描述"></p><blockquote><p>索引包含所有需要查询的字段的值。</p><p>具有以下优点：</p><ul><li>索引通常远小于数据行的大小，只读取索引能大大减少数据访问量。</li><li>一些存储引擎（例如 MyISAM）在内存中只缓存索引，而数据依赖于操作系统来缓存。因此，只访问索引可以不使用系统调用（通常比较费时）。</li><li>对于 InnoDB 引擎，若辅助索引能够覆盖查询，则无需访问主索引。</li></ul></blockquote><h5 id="sql-提示" tabindex="-1">SQL 提示 <a class="header-anchor" href="#sql-提示" aria-label="Permalink to &quot;SQL 提示&quot;">​</a></h5><p>SQL提示是优化数据库的一个重要手段，简单来说，在SQL语句种加入一些人为的提示来达到优化操作的目的。比如： 一个联合索引（name,id_card,status）和普通索引（name）到底用哪个索引呢？</p><h6 id="use-index" tabindex="-1">use index <a class="header-anchor" href="#use-index" aria-label="Permalink to &quot;use index&quot;">​</a></h6><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 使用某个索引</span></span>
<span class="line"><span style="color:#A6ACCD;">explain </span><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> emp </span><span style="color:#F78C6C;">use</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">index</span><span style="color:#A6ACCD;">(idx_name_gen_add) </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">韦一笑</span><span style="color:#89DDFF;">&#39;</span></span></code></pre></div><h6 id="ignore-index" tabindex="-1">ignore index <a class="header-anchor" href="#ignore-index" aria-label="Permalink to &quot;ignore index&quot;">​</a></h6><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 忽略某个索引</span></span>
<span class="line"><span style="color:#A6ACCD;">explain </span><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> emp </span><span style="color:#F78C6C;">ignore</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">index</span><span style="color:#A6ACCD;">(idx_name_gen_add) </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">韦一笑</span><span style="color:#89DDFF;">&#39;</span></span></code></pre></div><h6 id="force-index" tabindex="-1">force index <a class="header-anchor" href="#force-index" aria-label="Permalink to &quot;force index&quot;">​</a></h6><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 强制使用某个索引</span></span>
<span class="line"><span style="color:#A6ACCD;">explain </span><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> emp </span><span style="color:#F78C6C;">force</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">index</span><span style="color:#A6ACCD;">(idx_name_gen_add) </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">韦一笑</span><span style="color:#89DDFF;">&#39;</span></span></code></pre></div><h5 id="索引选择性分析" tabindex="-1">索引选择性分析 <a class="header-anchor" href="#索引选择性分析" aria-label="Permalink to &quot;索引选择性分析&quot;">​</a></h5><blockquote><p>通过如下 SQL 得到全列选择性：</p><div class="language-cobol"><button title="Copy Code" class="copy"></button><span class="lang">cobol</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">COUNT</span><span style="color:#A6ACCD;">(DISTINCT column_name) </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">COUNT</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">*</span><span style="color:#A6ACCD;">) </span><span style="color:#89DDFF;">FROM</span><span style="color:#A6ACCD;"> table_name;</span></span></code></pre></div><p>通过如下 SQL 得到某一长度前缀的选择性：</p><div class="language-cobol"><button title="Copy Code" class="copy"></button><span class="lang">cobol</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">COUNT</span><span style="color:#A6ACCD;">(DISTINCT </span><span style="color:#89DDFF;">LEFT</span><span style="color:#A6ACCD;">(column_name, prefix_length)) </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">COUNT</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">*</span><span style="color:#A6ACCD;">) </span><span style="color:#89DDFF;">FROM</span><span style="color:#A6ACCD;"> table_name;</span></span></code></pre></div></blockquote><h5 id="索引优化总结" tabindex="-1">索引优化总结 <a class="header-anchor" href="#索引优化总结" aria-label="Permalink to &quot;索引优化总结&quot;">​</a></h5><blockquote><ul><li>主键索引名为 pk_字段名；唯一索引名为 uk_字段名；普通索引名则为 idx_字段名。</li><li>数据量超过 300 的表应该有索引。</li><li>经常与其他表进行连接的表，在连接字段上应该建立索引。</li><li>经常出现在 WHERE 子句中的字段，特别是大表的字段，应该建立索引。</li><li>索引应该建在选择性高的字段上。</li><li>索引应该建在小字段上，对于大的文本字段甚至超长字段，不要建索引。</li><li>复合索引的建立需要进行仔细分析，尽量考虑用单字段索引代替。</li><li>正确选择复合索引中的主列字段，一般是选择性较好的字段。</li><li>经常同时以 AND 方式出现在 WHERE 子句中，则可以建立复合索引；否则考虑单字段索引。</li><li>如果复合索引中包含的字段经常单独出现在 WHERE 子句中，则分解为多个单字段索引。</li><li>如果复合索引所包含的字段超过 3 个，那么仔细考虑其必要性，考虑减少复合的字段。</li><li>如果既有单字段索引，又有这几个字段上的复合索引，一般可以删除复合索引。</li><li>频繁进行数据操作的表，不要建立太多的索引。</li><li>删除无用的索引，避免对执行计划造成负面影响。</li><li>表上建立的每个索引都会增加存储开销，索引对于插入、删除、更新操作也会增加处理上的开销。</li><li>尽量不要对数据库中某个含有大量重复的值的字段建立索引。</li></ul></blockquote><h4 id="索引设计原则" tabindex="-1">索引设计原则 <a class="header-anchor" href="#索引设计原则" aria-label="Permalink to &quot;索引设计原则&quot;">​</a></h4><ol><li>针对于数据量比较大，查询比较频繁的表</li><li>针对于常作为查询条件，排序，分组操作的字段建立索引。</li><li>尽量选择分区度高的列作为索引，尽量做唯一索引，区分度越高，效率越高。</li><li>如果是字符串且字符串长度较长，可以针对字段的特点，建立前缀索引。</li><li>尽量使用联合索引，减少单列索引，查询时联合索引喝多时候可以覆盖索引，节省存储空间避免回表。</li><li>索引越多，维护表结构的代价越大，影响增删改的效率。</li><li>如果所有列不能为空时，创建表时使用<code>NOT NULL</code>约束，当优化器知道每列包含<code>NULL</code> 值时，可以更好的确定哪个索引最有效地用于查询。</li></ol><h2 id="查询性能优化" tabindex="-1">查询性能优化 <a class="header-anchor" href="#查询性能优化" aria-label="Permalink to &quot;查询性能优化&quot;">​</a></h2><h4 id="查看执行频次" tabindex="-1">查看执行频次 <a class="header-anchor" href="#查看执行频次" aria-label="Permalink to &quot;查看执行频次&quot;">​</a></h4><p>sql 客户端连接成功后，通过<code>show [session|global] status</code> 命令可以提供服务器状态信息，通过如下指令可以查看数据的INSERT，UPDATE，DELETE，SELECT 的访问频次</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">SHOW </span><span style="color:#F78C6C;">GLOBAL</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">STATUS</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">LIKE</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Com_______</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><p><img src="/assets/e3fb80d22be34eb694edc78a1586e20a.34f95bc0.png" alt="在这里插入图片描述"></p><h4 id="慢查询日志" tabindex="-1">慢查询日志 <a class="header-anchor" href="#慢查询日志" aria-label="Permalink to &quot;慢查询日志&quot;">​</a></h4><p>慢查询日志记录了所有执行时间超过指定参数（long_query_time，单位：秒，默认10秒）的所有SQL 语句的日志。</p><p>sql 的慢查询日志默认没有开启，需要在sql 的配置文件（/etc/my.cnf）中配置如下信息：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;"># 开启慢查询日志开关</span></span>
<span class="line"><span style="color:#A6ACCD;">slow_query_log</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;"># 设置慢查询日志时间为2秒</span></span>
<span class="line"><span style="color:#A6ACCD;">long_query_time</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">2</span></span></code></pre></div><p>配置完毕之后，重启sql 服务器，查看慢日志文件中的记录信息 <code>/var/lib/sql/localhost-slow.log</code>。</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># Time 2022-03-05T15:45:39.688679Z</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># User@Host: root[root] @ locahost [] Id: 8</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Query_time: 13.350650 Lock_time 0.000358 Rows_sent: 1 Rows_examined: 0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">use</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">xxx</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#FFCB6B;">SET</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">timestamp=</span><span style="color:#F78C6C;">1635435926</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">select</span><span style="color:#A6ACCD;"> count(1) from user_operation_log</span><span style="color:#89DDFF;">;</span></span></code></pre></div><h4 id="show-profiles" tabindex="-1">show profiles <a class="header-anchor" href="#show-profiles" aria-label="Permalink to &quot;show profiles&quot;">​</a></h4><p><code>show profile</code>能够在做SQL优化是帮助我们了解时间都消耗到哪里去了，通过have_profiling 参数，能够看到当前sql 是否支持profile操作</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> @@have_profiling;</span></span></code></pre></div><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQEAAAB/CAYAAADvs3f4AAAOO0lEQVR4nO3df2iTdx4H8HfPG+UG04CU/TgONEYjrXeUIh1UlN1comlB5x9Z/GNodqK2FdqgK1u4rX+oI4xskhZm2npuUY7DLn9ohTY2sWM4LCxIKWwW08YoJxt63SDqGPTGkfvjeZ70SZqkP2yeJ+n3/YJA++RJnudpnuf9fD7fp31akUqlUlhGjx8/Tn/9/PPPL+dbP7PnnntO71UgKjm/L+ab//rrr8V8eyJaBr/TewWISF8MASLBFbUdWLNmTTHfvugmJyf1XgVdbNq0Se9VIA0VNQRWAtEOCFGDT2SahAB3rPLCz0tbep9oNKsEXnzxRa0WtWwePXqk9yroolw/q3Jdb71xYJBIcAwBIsExBMpKCEcrjiKk92rQilLeIRBxwepP6LgCcXRtq0BFheqxrQtxHddorhCOVlRgW1dprRWVjtIIgYgLBlck83urHzkP74gLBoNBetgDiLrrZr+XH+q30sKRoRRSKekxtMWFjUe1OFdLAZR/UUpAXQGOLNcyI3AZXMj9403Ab1U/N9+8BhgMVmia4Qk/rBk7R/Y6F6D7Cad4SiIEIoMTcMKbcXAj6kad+uBWh4IziGQymfMRdOq5JYDtzWU74p6RCe03U0ilevHmsr2nBW2eCXgXfTAoB73yqEOsI4lkMowW47Kt3NIl/LDmDSx5lviEZqujNf1DIOGHd2If2nzhvAd2MplEMtyC9P4SsM85+ysPe0DPjYmj63QfGqo3qqZJ5bjSLqjL8njXNlUrIff68S5sU/f92d+n33MjXKNAX6MGLYiq+qpzR1XVlwsRRODKqtoiLgMMBjsCCMBuMMDqvwugHp6x2c/TZynmCmdK+K2ZlWY2YwvCY2Z4lSBQV5s5t1u/qrMYdA6BBPzNbmDfLhjnnC3Uj6yULrFKoK9ROZAPAhdSuNlukp8J4WjFaVRPKe3CFN76cqNUwse7cNC1BUMp5ble2Ba8RBt6U1PwNcityM12mOZ/0dJZfBjz1MMZzPw5O4M+5DqWLb4kkmMe1MOJYDKJcMuGYq7dvIwtHXAGvPDfLTgTwkl5eyy+zP1qzIP6eiecTg/GsvY3LcOsWHQNgYS/Ge6o8p0RLeF8lUDWzlZilYAyJjB0ZBQur+qcHbqCPozCtVEJCens/f1kHDBtwhb0obFiG8phzM7Y0gOzV+rhE34rBpsKHwCJ4cuIIgB7uu+Pwl2X4zPLN/azrCxo8wCXB2MA4qqTTR3cUalaUdZnTt+f8MNaF0NH2AdfG9CsyfpqS9cQuBurRjB96i7fSkBh6x3Ckb7GzMG6Bh+mUrMDh6mUUinY0JtKIZW6ABysQEUJh4FU3tfBHZUO5Dp3FAF7oXI4gu7LkCuBDsSauxFTtwNSGTG3zSsiY0sY4TYzAJPqZBOEM6tNCacHKeT9sRno8EzAbvUjYWxBuAdozhUWZUzXELD41Gf48q0EZtnQ4WtA32m5R7e9iSOjLmQUB0dne/+uECAN4E3B1zCKiSllru8xKQdCfPBLjGq3ATlZfPnHanJVAwm/F+joQLX0avjCbTCjGiZdBwEjcNW5EVVPSsQxgSguD2ce0FLoNQM9UkhZWsIY23cZzf6E3DYk0YPm3JVDGdJ/YFBF+uHPUwlk92sL3DG1Ymq/AB+Uy4Q29E758H3j7MDglTfl3t/Ujk1XVG3CliH02qTpF3xItxAHJ7agIfeS0PRWgzYDg3mqtHwHwF3sQ5slc0osmnNWjUTgMnhhDnpQr57a7UZ1cAz7LndnVJpS6KmvXETQ7a5Gh+pShrElnFU5lK+SCoHsEeTZkk2hXHtWRqRzXG9O+GHVrG+TLsP12uZOSykTTe24qWoF1PPaelVtguoJU/vN2dahtxc304OGNvSqBhDT880zMGjrVQ9WLpU0yJf+XAr0XZaWrBI/MoiAsynnIKIWIi47EAwjY3wy4oJ9woM2ixEtHYA9q6+JuAxwRRLwW63wJyzwJZswqNrPIq6VUQUAJRcChUkfZq4WQkrthN8K6/AuqW9bgQM4+socQDOk+y4LfAX7+gT83gCcTfqVZxZfVnWY8MNqB4LKelt8CMKevoyY8FthRzCrorTAlwyjxSgFQ7xNbglWwDXCErupiDTw5J4z3YkmSB+m9LlsgBl21Bmy53QimDQCaEE4XPSVFYwTQfXYTMQFaxyQqjM7AgBQ78FY9ssSw7hcHUS4VC6lBewwBLK2BdK+FXQZYHAFkfSFkZSnm6qjsGfvk/UejBnllkC7NS+aimLecly5vdjk5GT+v/WOuGCNtyHcYkTEZUW8Lfu3yCJwGQbRlD04qIFHjx7pfsMHrRX8rEpYOd9PQO99TP9KwOJLnyUsvnCOA90CX7JUTiNEK09ZjQkQ0fJjCBAJjiFAJLiiDgyWwk0Un5XegzZa452GxaPJ1QEiKl1sB4gExxAgEhxDgEhwDAEiwRX1NwYnf/rvgudd9fgB/rfmT0VcGypnqx4/wIYN+t6mbKViJUAkOIYAkeAYAkSCYwgQCU7QELiGzqrtCKy4Ww/FEbBVwlxVic6ebjjS23gNnVWtuAEACfV0onIIgUQ3HFXSjq08HD0Fbqu52PlXkPs978BTPYDY9AxOWvVeGyoXJR0C93u2w/zqHRybnkFM9Tg2VQOzcmZ7hvlXmn9PRVG7Ub6hqLEN/dPfwJl9879800lYpRsCI63YNWDH8PRZ7Bhplc/qreg8UYnrjTMYPvUdDp+4tvT5iQhACYfAjaHzcLzbhnWJbjj2A+emZxCb3gNcrIdxPbCu+e9wXLyaPrsvdn4AQLh1tm1QB0RWS9E5Aij9trq1uN+zHWZbN+4DkPruhbYg0nt1jmS+RlpOjufzLENd3dw4UYnDF4HxD+WqJ9ENR67qJ2O6PDbS05pnvdXLk+dLrwutFCUaAtdw/eIhvLETuB8OAqeOYwcAwATj1j/DaFS+Xur8ABCFZ2qP1DJ860XtxY/kwbI4Ap8BHyvtxKVD6N/fihswwfnuIYwPDMkHQRxfD0Sl4ME1dFZ9BOO3SgtyG7aBGtVBnVv//qt4Y85ycjwfUpaxF7FTt2dbnUvAYfmA3vHpDM4dAGpP3UZs+qy8/QuR+XPAh++oBhP3ApeUbfoCGDi/4Hel8lGiIZDJrPS5iCNxCzm+Xsr89XAf2y19aWyELR0QJjg/bQN6tktnwP2qHX/nHjhuBfF1AkBiCKFbUvBg5Cr6EYXnVeWsWQPPLSA2VXhA0nFJdbDuPA731vO4PpLn+ZGr6N/qxcfNqn8ikuM1i5fn5yAv7287lfmkEKSVp0RDwATj1u+QkC9j9Q9Jpfr9nquIqXfSA3tUZ/zFzF+A3Aq8hy9mq4T0k7vxxoEoQuF4VsUBYKsXw1kDkv3NRf2H4TKp3SFaqpINgdf2Ap7PrmFd8xdwT+yFuaoS7+E4Pt77HQ5XVcL8yWYMf7p7ifMXcO8OxlVn3PvhIMZVT+845gUGzuDzAcBmlQ/ynXvguNWBz1Vn5Bsn5r8aoYQVIF/eUyqLXORlvKfu2UfOwAM7XivGSP+cbYoj8AnbgZVI//87kMe65m9w7kQlzDYvhkMzqv9H+A1izc8+f147j8P9SQ12VXUAAGoPHFJVApBKZnRI1+PTB99unPzWC8erlTDLUxyXZnBynkU5cBXmqr3yd4dwrmAvvxsnpwfQWVUD84dQvaYN6xaxeQuXvU31cJ86BAwUZWGko+LeaPS3Pyz4dXn/lHikNbMvB6TSO5Rn51/s/LqII2CrQeLdGZzMd+YvRSOtUkWlw8+Sf0pcPCVbCaTtPIvY9NnizU95xBGwnYExpFQn19C5/zxqT90uoTCl5VD6IVDWpMts/VlTHZduF/gvvqXCBOdnm+GoqsRheUrtqdsaDXaSlkq/HSAC24FiKtGrA0SkFYYAkeCKOiaw6vGDos5PRM+uqCGwmB5/1eMHMP3jtyKuDZWz5Psv670KKxbbASLBMQSIBMcQIBIcQ4BIcJqFgLmqUqtFEdEiaPprw+aqSsSmZ+ad78jbm9GLH1HxzyfpaQ3W9bi55RdsO/MEbx1fj/Yq9Sue4qj7B/QBAFZjyPMKbPIzof47aFT/LTARZdC8HVhIRdB3/WfEa9bC95IyZTU++CvQ9a9pjMpTQv13UOFWHpkBgPRz9zD5+h9xpChbQrQy6DImMG8QPHyCwelKNP1Fnq/2Bdimf8GXD+d545cqsXH6Z5xOn/ln4DqjBAQR5aLbwGDhIJiB66unMG1ZjQZUwvf6Cwh9NVsF5PVwBlNVa/FB7XwzEpFC16sDBYNg/Cd0YS0+sK5GE9Rnd4nNsRkpj/x4e7U89Qka+5/Kz7ENIFoIXe8nUHiQUKoGUo61CPXfmVMF5B3wG/8BFePyQKJnM3pvZw4wElEm3SqBhVwlwPhThPAUV5Ywuj8avocK948I1byCIbYHRHnpEgILCoCleKkKU+nWQDGDyfkGFIkEpnk7sFwBYHNsRsqhfDeDrq57cD2cxsH/rEfK80p6vlD/HbgYAkR5aXZ7sfl+UYh/SkyFJN9/GWvWrNF7NVYkzdqBorUARPRM+AdERIJjCBAJjiFAJDiGAJHgSupuw7yZJJH2inqJkJd0iEof2wEiwTEEiATHECASHEOASHAMASLBMQSIBMcQIBIcQ4BIcAwBIsExBIgExxAgEhxDgEhwDAEiwTEEiATHECASHEOASHAMASLBMQSIBMcQIBIcQ4BIcAwBIsExBIgExxAgEhxDgEhwDAEiwTEEiATHECASHEOASHAMASLBMQSIBMcQIBIcQ4BIcAwBIsExBIgExxAgEhxDgEhwDAEiwTEEiATHECASHEOASHAMASLBMQSIBMcQIBIcQ4BIcAwBIsExBIgExxAgEhxDgEhw/wcJWc5OELzaLgAAAABJRU5ErkJggg==" alt="在这里插入图片描述"></p><p>默认profiling 是关闭的 （<code>select @@profiling</code>），可以通过set 语句在session/global 级别开启profiling:</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> profiling </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><p>执行一系列的业务SQL的操作，然后通过如下指令查看SQL 的执行耗时</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 查看每一条SQL的耗时情况</span></span>
<span class="line"><span style="color:#A6ACCD;">show profiles;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 查看指定Query_id的SQL语句各个阶段的耗时情况</span></span>
<span class="line"><span style="color:#A6ACCD;">show </span><span style="color:#F78C6C;">profile</span><span style="color:#A6ACCD;"> for query query_id;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 查看query_id的SQL cpu使用情况</span></span>
<span class="line"><span style="color:#A6ACCD;">show </span><span style="color:#F78C6C;">profile</span><span style="color:#A6ACCD;"> cpu for query query_id;</span></span></code></pre></div><p>执行了3条SQL</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> user_operation_log </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">456465</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;">  user_operation_log </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> user_id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">15646</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> user_operation_log </span><span style="color:#F78C6C;">LIMIT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10000</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><p><img src="/assets/feb06621572b4498886df1922b8a2ddf.3a4adc03.png" alt="在这里插入图片描述"></p><p><img src="/assets/a13d01bcb8a842169e72682415691e07.a8fb1a32.png" alt="在这里插入图片描述"></p><p><img src="/assets/55f858cf2aea4f8f87edbcea0ca883e3.3f187186.png" alt="在这里插入图片描述"></p><h4 id="trace" tabindex="-1">trace <a class="header-anchor" href="#trace" aria-label="Permalink to &quot;trace&quot;">​</a></h4><p>trace 分析优化器如何选择执行计划，通过 trace 文件能够进一步了解为什么优惠券选择 A 执行计划而不选择 B 执行计划。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">set</span><span style="color:#A6ACCD;"> optimizer_trace</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">enabled=on</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">set</span><span style="color:#A6ACCD;"> optimizer_trace_max_mem_size</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">1000000</span><span style="color:#A6ACCD;">;	</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> information_schema.optimizer_trace;</span></span></code></pre></div><h4 id="explain-执行计划" tabindex="-1">explain 执行计划 <a class="header-anchor" href="#explain-执行计划" aria-label="Permalink to &quot;explain 执行计划&quot;">​</a></h4><blockquote><p>详见 <code>sql</code>官方文档 ：<a href="https://dev.sql.com/doc/refman/5.7/en/explain-output.html#jointype_index_merge" target="_blank" rel="noreferrer">https://dev.sql.com/doc/refman/5.7/en/explain-output.html#jointype_index_merge</a></p></blockquote><p>EXPLAIN 或者 DESC 命令获取sql 如何语句的信息，包括在SELECT 语句执行过程中表如何连接和连接顺序</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 在SQL语句前加上关键字 EXPLAIN</span></span>
<span class="line"><span style="color:#A6ACCD;">EXPLAIN </span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> col0,clo1,... </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> table_name </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> condition;</span></span></code></pre></div><p><img src="/assets/54fb8b7b886749c6924fee874bcdc11c.dd437782.png" alt="在这里插入图片描述"></p><p>当<code>Explain</code> 与 <code>SQL</code>语句一起使用时，<code>sql</code> 会显示来自优化器关于SQL执行的信息。也就是说，<code>sql</code>解释了它将如何处理该语句，包括如何连接表以及什么顺序连接表等。</p><ul><li>表的加载顺序</li><li><code>sql</code> 的查询类型</li><li>可能用到哪些索引，哪些索引又被实际使用</li><li>表与表之间的引用关系</li><li>一个表中有多少行被优化器查询</li></ul><p><code>Explain</code> 执行计划包含字段信息如下：分别是</p><p><code>id</code>、<code>select_type</code>、<code>table</code>、<code>partitions</code>、<code>type</code>、<code>possible_keys</code>、<code>key</code>、<code>key_len</code>、<code>ref</code>、<code>rows</code>、<code>filtered</code>、<code>Extra</code> 12个字段。</p><h5 id="_1-id-执行顺序" tabindex="-1">1.id 执行顺序 <a class="header-anchor" href="#_1-id-执行顺序" aria-label="Permalink to &quot;1.id 执行顺序&quot;">​</a></h5><p><code>id：</code> ：表示查询中执行select子句或者操作表的顺序，<strong><code>id</code>的值越大，代表优先级越高，越先执行</strong>。<code>id</code>大致会出现 3种情况：</p><h6 id="id相同" tabindex="-1">id相同 <a class="header-anchor" href="#id相同" aria-label="Permalink to &quot;id相同&quot;">​</a></h6><p>看到三条记录的<code>id</code>都相同，可以理解成这三个表为一组，具有同样的优先级，执行顺序由上而下，具体顺序由优化器决定。</p><h6 id="id不同" tabindex="-1">id不同 <a class="header-anchor" href="#id不同" aria-label="Permalink to &quot;id不同&quot;">​</a></h6><p>如果我们的 <code>SQL</code> 中存在子查询，那么 <code>id</code>的序号会递增，<code>id</code>值越大优先级越高，越先被执行 。当三个表依次嵌套，发现最里层的子查询 <code>id</code>最大，最先执行。</p><h6 id="以上两种同时存在" tabindex="-1">以上两种同时存在 <a class="header-anchor" href="#以上两种同时存在" aria-label="Permalink to &quot;以上两种同时存在&quot;">​</a></h6><p>相同<code>id</code>划分为一组，这样就有三个组，同组的从上往下顺序执行，不同组 <code>id</code>值越大，优先级越高，越先执行。</p><h5 id="_2-select-type-查询类型" tabindex="-1">2.select_type 查询类型 <a class="header-anchor" href="#_2-select-type-查询类型" aria-label="Permalink to &quot;2.select_type 查询类型&quot;">​</a></h5><blockquote><p><code>select_type</code>：表示 <code>select</code> 查询的类型，主要是用于区分各种复杂的查询，例如：<code>普通查询</code>、<code>联合查询</code>、<code>子查询</code>等。</p></blockquote><h6 id="simple" tabindex="-1">SIMPLE <a class="header-anchor" href="#simple" aria-label="Permalink to &quot;SIMPLE&quot;">​</a></h6><p>表示最简单的 select 查询语句，也就是在查询中不包含子查询或者 <code>union</code>交并差集等操作。</p><h6 id="primary" tabindex="-1">PRIMARY <a class="header-anchor" href="#primary" aria-label="Permalink to &quot;PRIMARY&quot;">​</a></h6><p>当查询语句中包含任何复杂的子部分，最外层查询则被标记为<code>PRIMARY</code>。</p><h6 id="subquery" tabindex="-1">SUBQUERY <a class="header-anchor" href="#subquery" aria-label="Permalink to &quot;SUBQUERY&quot;">​</a></h6><p>当 <code>select</code> 或 <code>where</code> 列表中包含了<strong>子查询</strong>，该子查询被标记为：<code>SUBQUERY</code> 。</p><h6 id="derived" tabindex="-1">DERIVED <a class="header-anchor" href="#derived" aria-label="Permalink to &quot;DERIVED&quot;">​</a></h6><p>表示包含在<code>from</code>子句中的子查询的select，在我们的 <code>from</code> 列表中包含的子查询会被标记为<code>derived</code> 。</p><h6 id="union" tabindex="-1">UNION <a class="header-anchor" href="#union" aria-label="Permalink to &quot;UNION&quot;">​</a></h6><p>如果<code>union</code>后边又出现的<code>select</code> 语句，则会被标记为<code>union</code>；若 <code>union</code> 包含在 <code>from</code> 子句的子查询中，外层 <code>select</code> 将被标记为 <code>derived</code>。</p><h6 id="union-result" tabindex="-1">UNION RESULT <a class="header-anchor" href="#union-result" aria-label="Permalink to &quot;UNION RESULT&quot;">​</a></h6><p>代表从<code>union</code>的临时表中读取数据</p><h5 id="_3-table-查询表名" tabindex="-1">3.table 查询表名 <a class="header-anchor" href="#_3-table-查询表名" aria-label="Permalink to &quot;3.table 查询表名&quot;">​</a></h5><blockquote><p>查询的表名，并不一定是真实存在的表，有别名显示别名，也可能为临时表</p></blockquote><h5 id="_4-partitions-分区信息" tabindex="-1">4.partitions 分区信息 <a class="header-anchor" href="#_4-partitions-分区信息" aria-label="Permalink to &quot;4.partitions 分区信息&quot;">​</a></h5><blockquote><p>查询时匹配到的分区信息，对于非分区表值为<code>NULL</code>，当查询的是分区表时，<code>partitions</code>显示分区表命中的分区情况。</p></blockquote><h5 id="_5-type-索引查询类型" tabindex="-1">5.type 索引查询类型 <a class="header-anchor" href="#_5-type-索引查询类型" aria-label="Permalink to &quot;5.type 索引查询类型&quot;">​</a></h5><blockquote><p><strong>由上至下，效率越来越高</strong></p><ul><li>ALL 全表扫描</li><li>index 索引全扫描</li><li>range 索引范围扫描，常用语&lt;,&lt;=,&gt;=,between,in等操作</li><li>ref 使用非唯一索引扫描或唯一索引前缀扫描，返回单条记录，常出现在关联查询中</li><li>eq_ref 类似ref，区别在于使用的是唯一索引，使用主键的关联查询</li><li>const/system 单条记录，系统会把匹配行中的其他列作为常数处理，如主键或唯一索引查询</li><li>null sql不访问任何表或索引，直接返回结果</li></ul><p><strong>经常用到的索引查询类型</strong></p><ul><li>const：使用主键或者唯一索引进行查询的时候只有一行匹配</li><li>ref：使用非唯一索引</li><li>range：使用主键、单个字段的辅助索引、多个字段的辅助索引的最后一个字段进行范围查询</li><li>index：和all的区别是扫描的是索引树</li><li>all：扫描全表</li></ul></blockquote><h6 id="system" tabindex="-1">system <a class="header-anchor" href="#system" aria-label="Permalink to &quot;system&quot;">​</a></h6><blockquote><p><strong>触发条件：表只有一行，这是一个 const type 的特殊情况</strong></p></blockquote><h6 id="const" tabindex="-1">const <a class="header-anchor" href="#const" aria-label="Permalink to &quot;const&quot;">​</a></h6><blockquote><p><strong>触发条件：在使用主键或者唯一索引进行查询的时候只有一行匹配。</strong></p></blockquote><h6 id="eq-ref" tabindex="-1">eq_ref <a class="header-anchor" href="#eq-ref" aria-label="Permalink to &quot;eq_ref&quot;">​</a></h6><blockquote><p><strong>触发条件：在进行联接查询的，使用主键或者唯一索引并且只匹配到一行记录的时候</strong></p></blockquote><h6 id="ref" tabindex="-1">ref <a class="header-anchor" href="#ref" aria-label="Permalink to &quot;ref&quot;">​</a></h6><blockquote><p>区别于<code>eq_ref</code> ，<code>ref</code>表示使用非唯一性索引，会找到很多个符合条件的行。</p><p><strong>触发条件：使用非唯一索引</strong></p></blockquote><h6 id="ref-or-null" tabindex="-1">ref_or_null <a class="header-anchor" href="#ref-or-null" aria-label="Permalink to &quot;ref_or_null&quot;">​</a></h6><blockquote><p>这种连接类型类似于 ref，区别在于 <code>sql</code>会额外搜索包含<code>NULL</code>值的行。</p></blockquote><h6 id="index-merge" tabindex="-1">index_merge <a class="header-anchor" href="#index-merge" aria-label="Permalink to &quot;index_merge&quot;">​</a></h6><blockquote><p><code>index_merge</code>：使用了索引合并优化方法，查询使用了两个以上的索引。</p></blockquote><h6 id="unique-subquery" tabindex="-1">unique_subquery <a class="header-anchor" href="#unique-subquery" aria-label="Permalink to &quot;unique_subquery&quot;">​</a></h6><blockquote><p><code>unique_subquery</code>：替换下面的 <code>IN</code>子查询，子查询返回不重复的集合。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">value</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">IN</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> primary_key </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> single_table </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> some_expr)</span></span></code></pre></div></blockquote><h6 id="index-subquery" tabindex="-1">index_subquery <a class="header-anchor" href="#index-subquery" aria-label="Permalink to &quot;index_subquery&quot;">​</a></h6><blockquote><p><code>index_subquery</code>：区别于<code>unique_subquery</code>，用于非唯一索引，可以返回重复值。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">value</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">IN</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> key_column </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> single_table </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> some_expr)</span></span></code></pre></div></blockquote><h6 id="range" tabindex="-1">range <a class="header-anchor" href="#range" aria-label="Permalink to &quot;range&quot;">​</a></h6><blockquote><p><strong>触发条件：只有在使用 主键、单个字段的辅助索引、多个字段的辅助索引的最后一个字段 进行范围查询 才是 range</strong></p><p>使用索引选择行，仅检索给定范围内的行。简单点说就是针对一个有索引的字段，给定范围检索数据。在<code>where</code>语句中使用 <code>bettween...and</code>、<code>&lt;</code>、<code>&gt;</code>、<code>&lt;=</code>、<code>in</code> 等条件查询 <code>type</code> 都是 <code>range</code>。</p></blockquote><h6 id="index" tabindex="-1">index <a class="header-anchor" href="#index" aria-label="Permalink to &quot;index&quot;">​</a></h6><blockquote><p>触发条件：只扫描索引树</p><p>1）查询的字段是索引的一部分，覆盖索引。</p><p>2）使用主键进行排序</p></blockquote><h6 id="all" tabindex="-1">ALL <a class="header-anchor" href="#all" aria-label="Permalink to &quot;ALL&quot;">​</a></h6><blockquote><p>触发条件：全表扫描，不走索引</p></blockquote><h5 id="_6-possible-keys-可能索引" tabindex="-1">6.possible_keys 可能索引 <a class="header-anchor" href="#_6-possible-keys-可能索引" aria-label="Permalink to &quot;6.possible_keys 可能索引&quot;">​</a></h5><blockquote><p><code>possible_keys</code>：表示在<code>sql</code>中通过哪些索引，能让我们在表中找到想要的记录，一旦查询涉及到的某个字段上存在索引，则索引将被列出，<strong>但这个索引并不定一会是最终查询数据时所被用到的索引</strong>。</p></blockquote><h5 id="_7-key-实际索引" tabindex="-1">7.key 实际索引 <a class="header-anchor" href="#_7-key-实际索引" aria-label="Permalink to &quot;7.key 实际索引&quot;">​</a></h5><blockquote><p><code>key</code>：区别于<code>possible_keys</code>，key是查询中实际使用到的索引，若没有使用索引，显示为<code>NULL</code>。</p><blockquote><p>当 <code>type</code> 为 <code>index_merge</code> 时，可能会显示多个索引。</p></blockquote></blockquote><h5 id="_8-key-len-索引长度" tabindex="-1">8.key_len 索引长度 <a class="header-anchor" href="#_8-key-len-索引长度" aria-label="Permalink to &quot;8.key_len 索引长度&quot;">​</a></h5><blockquote><p><code>key_len</code>：表示查询用到的索引长度（字节数），原则上长度越短越好 。</p><ul><li>单列索引，那么需要将整个索引长度算进去；</li><li>多列索引，不是所有列都能用到，需要计算查询中实际用到的列。</li></ul><blockquote><p>注意：<code>key_len</code>只计算<code>where</code>条件中用到的索引长度，而排序和分组即便是用到了索引，也不会计算到<code>key_len</code>中。</p></blockquote></blockquote><h5 id="_9-ref-关联字段名" tabindex="-1">9.ref 关联字段名 <a class="header-anchor" href="#_9-ref-关联字段名" aria-label="Permalink to &quot;9.ref  关联字段名&quot;">​</a></h5><blockquote><p><code>ref</code>：常见的有：<code>const</code>，<code>func</code>，<code>null</code>，字段名。</p><ul><li>当使用常量等值查询，显示<code>const</code>，</li><li>当关联查询时，会显示相应关联表的<code>关联字段</code></li><li>如果查询条件使用了<code>表达式</code>、<code>函数</code>，或者条件列发生内部隐式转换，可能显示为<code>func</code></li><li>其他情况<code>null</code></li></ul></blockquote><h5 id="_10-rows-读取行数" tabindex="-1">10.rows 读取行数 <a class="header-anchor" href="#_10-rows-读取行数" aria-label="Permalink to &quot;10.rows 读取行数&quot;">​</a></h5><blockquote><p><code>rows</code>：以表的统计信息和索引使用情况，估算要找到我们所需的记录，需要读取的行数。</p><p>这是评估<code>SQL</code> 性能的一个比较重要的数据，<code>sql</code>需要扫描的行数，很直观的显示 <code>SQL</code> 性能的好坏，一般情况下 <code>rows</code> 值越小越好。</p></blockquote><h5 id="_11-filtered-记录数百分比" tabindex="-1">11.filtered 记录数百分比 <a class="header-anchor" href="#_11-filtered-记录数百分比" aria-label="Permalink to &quot;11.filtered 记录数百分比&quot;">​</a></h5><blockquote><p><code>filtered</code> 这个是一个百分比的值，表里符合条件的记录数的百分比。这个字段表示存储引擎返回的数据在经过过滤后，剩下满足条件的记录数量的比例.在<code>sql5.7</code>以前版本想要显示<code>filtered</code>需要使用<code>explain extended</code>命令。<code>sql.5.7</code>后，默认<code>explain</code>直接显示<code>partitions</code>和<code>filtered</code>的信息</p></blockquote><h5 id="_12-extra-额外信息" tabindex="-1">12.Extra 额外信息 <a class="header-anchor" href="#_12-extra-额外信息" aria-label="Permalink to &quot;12.Extra 额外信息&quot;">​</a></h5><h6 id="using-index" tabindex="-1">Using index <a class="header-anchor" href="#using-index" aria-label="Permalink to &quot;Using index&quot;">​</a></h6><blockquote><p><code>Using index</code>：我们在相应的 <code>select</code> 操作中使用了覆盖索引，通俗一点讲就是查询的列被索引覆盖，使用到覆盖索引查询速度会非常快，<code>SQl</code>优化中理想的状态。</p></blockquote><h6 id="using-index-condition" tabindex="-1">Using index condition <a class="header-anchor" href="#using-index-condition" aria-label="Permalink to &quot;Using index condition&quot;">​</a></h6><blockquote><p>**Using index condition：**sql5.6 之后新增的 ICP，using index condtion 就是可能使用了 ICP（索引下推）</p><p>在存储引擎层进行数据过滤，而不是在服务层过滤，利用索引现有的数据减少回表的数据。</p></blockquote><h6 id="using-where" tabindex="-1">Using where <a class="header-anchor" href="#using-where" aria-label="Permalink to &quot;Using where&quot;">​</a></h6><blockquote><p><code>Using where</code>：查询时未找到可用的索引，进而通过<code>where</code>条件过滤获取所需数据，但要注意的是并不是所有带<code>where</code>语句的查询都会显示<code>Using where</code>。</p><p>下边示例<code>create_time</code> 并未用到索引，<code>type</code> 为 <code>ALL</code>，即<code>sql</code>通过全表扫描后再按<code>where</code>条件筛选数据。</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">sql&gt; EXPLAIN SELECT one_name from one where create_time =&#39;2020-05-18&#39;;</span></span></code></pre></div></blockquote><h6 id="using-temporary" tabindex="-1">Using temporary <a class="header-anchor" href="#using-temporary" aria-label="Permalink to &quot;Using temporary&quot;">​</a></h6><blockquote><p><code>Using temporary</code>：表示查询后结果需要使用临时表来存储，一般在排序或者分组查询时用到。<strong>性能很差</strong>，需要重点优化</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">sql&gt; EXPLAIN SELECT one_name from one where one_id in (1,2) group by one_name;</span></span></code></pre></div></blockquote><h6 id="using-filesort" tabindex="-1">Using filesort <a class="header-anchor" href="#using-filesort" aria-label="Permalink to &quot;Using filesort&quot;">​</a></h6><blockquote><p><code>Using filesort</code>：表示无法利用索引完成的排序操作，也就是<code>ORDER BY</code>的字段没有索引，<strong>性能较差</strong>，通常这样的SQL都是需要优化的。</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">sql&gt; EXPLAIN SELECT one_id from one  ORDER BY create_time;</span></span></code></pre></div><p>如果<code>ORDER BY</code>字段有索引就会用到覆盖索引，相比执行速度快很多。</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">sql&gt; EXPLAIN SELECT one_id from one  ORDER BY one_id;</span></span></code></pre></div></blockquote><h6 id="using-join-buffer" tabindex="-1">Using join buffer <a class="header-anchor" href="#using-join-buffer" aria-label="Permalink to &quot;Using join buffer&quot;">​</a></h6><blockquote><p><code>Using join buffer</code>：在我们联表查询的时候，如果表的连接条件没有用到索引，需要有一个连接缓冲区来存储中间结果。</p></blockquote><h6 id="impossible-where" tabindex="-1">Impossible where <a class="header-anchor" href="#impossible-where" aria-label="Permalink to &quot;Impossible where&quot;">​</a></h6><blockquote><p><code>Impossible where</code>：表示在我们用不太正确的<code>where</code>语句，导致没有符合条件的行。</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">sql&gt; EXPLAIN SELECT one_name from one WHERE 1=2;</span></span></code></pre></div></blockquote><h6 id="no-tables-used" tabindex="-1">No tables used <a class="header-anchor" href="#no-tables-used" aria-label="Permalink to &quot;No tables used&quot;">​</a></h6><blockquote><p><code>No tables used</code>：我们的查询语句中没有<code>FROM</code>子句，或者有 <code>FROM DUAL</code>子句。</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">sql&gt; EXPLAIN select now();</span></span></code></pre></div></blockquote><table><thead><tr><th style="text-align:center;">列</th><th style="text-align:center;">含义</th></tr></thead><tbody><tr><td style="text-align:center;">id</td><td style="text-align:center;">select 查询的序号，表示查询中的执行select 子句或者操作表的顺序（id相同，顺序从上到下，id 不同值越大越先执行）</td></tr><tr><td style="text-align:center;">select_type</td><td style="text-align:center;">表示 SELECT 的类型，常见的取值有 SIMPLE （简单表，不使用表连接和子查询），PRIMIAY（主查询，即外层的查询），UNION ，SUBQUERY （select/where 之后包含了子查询）等</td></tr><tr><td style="text-align:center;">table</td><td style="text-align:center;"></td></tr><tr><td style="text-align:center;">partitions</td><td style="text-align:center;"></td></tr><tr><td style="text-align:center;"><strong>type</strong></td><td style="text-align:center;">表示连接的类型，性能由好到差的连接类型为 NULL，system，const，eq_ref，ref，range，index，all</td></tr><tr><td style="text-align:center;"><strong>possible_keys</strong></td><td style="text-align:center;">可能用到的索引</td></tr><tr><td style="text-align:center;"><strong>key</strong></td><td style="text-align:center;">实际用到的索引</td></tr><tr><td style="text-align:center;"><strong>key_len</strong></td><td style="text-align:center;">表示索引使用的字节数</td></tr><tr><td style="text-align:center;">ref</td><td style="text-align:center;"></td></tr><tr><td style="text-align:center;">rows</td><td style="text-align:center;">查询预估值</td></tr><tr><td style="text-align:center;">filtered</td><td style="text-align:center;">返回结果占读取行数的百分比，越大越好</td></tr><tr><td style="text-align:center;">Extra</td><td style="text-align:center;">额外信息</td></tr></tbody></table><h4 id="优化数据访问" tabindex="-1">优化数据访问 <a class="header-anchor" href="#优化数据访问" aria-label="Permalink to &quot;优化数据访问&quot;">​</a></h4><blockquote><h6 id="减少请求的数据量" tabindex="-1">减少请求的数据量 <a class="header-anchor" href="#减少请求的数据量" aria-label="Permalink to &quot;减少请求的数据量&quot;">​</a></h6><ul><li>只返回必要的列：最好不要使用 SELECT * 语句。</li><li>只返回必要的行：使用 LIMIT 语句来限制返回的数据。</li><li>缓存重复查询的数据：使用缓存可以避免在数据库中进行查询，特别在要查询的数据经常被重复查询时，缓存带来的查询性能提升将会是非常明显的。</li></ul><h6 id="减少服务器端扫描的行数" tabindex="-1">减少服务器端扫描的行数 <a class="header-anchor" href="#减少服务器端扫描的行数" aria-label="Permalink to &quot;减少服务器端扫描的行数&quot;">​</a></h6><p>最有效的方式是使用索引来覆盖查询。</p></blockquote><h4 id="重构查询方式" tabindex="-1">重构查询方式 <a class="header-anchor" href="#重构查询方式" aria-label="Permalink to &quot;重构查询方式&quot;">​</a></h4><blockquote><h6 id="切分大查询" tabindex="-1">切分大查询 <a class="header-anchor" href="#切分大查询" aria-label="Permalink to &quot;切分大查询&quot;">​</a></h6><p>一个大查询如果一次性执行的话，可能一次锁住很多数据、占满整个事务日志、耗尽系统资源、阻塞很多小的但重要的查询。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">DELETE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> messages </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">create</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> DATE_SUB(</span><span style="color:#F78C6C;">NOW</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">, INTERVAL </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">MONTH</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">----------&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">rows_affected </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">do {</span></span>
<span class="line"><span style="color:#A6ACCD;">   rows_affected </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> do_query(</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">DELETE FROM messages WHERE create  &lt; DATE_SUB(NOW(), INTERVAL 3 MONTH) LIMIT 10000</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">} </span><span style="color:#F78C6C;">while</span><span style="color:#A6ACCD;"> rows_affected </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span></code></pre></div><h6 id="分解大连接查询" tabindex="-1">分解大连接查询 <a class="header-anchor" href="#分解大连接查询" aria-label="Permalink to &quot;分解大连接查询&quot;">​</a></h6><p>将一个大连接查询分解成对每一个表进行一次单表查询，然后在应用程序中进行关联，这样做的好处有：</p><ul><li>让缓存更高效。对于连接查询，如果其中一个表发生变化，那么整个查询缓存就无法使用。而分解后的多个查询，即使其中一个表发生变化，对其它表的查询缓存依然可以使用。</li><li>分解成多个单表查询，这些单表查询的缓存结果更可能被其它查询使用到，从而减少冗余记录的查询。</li><li>减少锁竞争；</li><li>在应用层进行连接，可以更容易对数据库进行拆分，从而更容易做到高性能和可伸缩。</li><li>查询本身效率也可能会有所提升。</li></ul></blockquote><h2 id="sql优化" tabindex="-1">SQL优化 <a class="header-anchor" href="#sql优化" aria-label="Permalink to &quot;SQL优化&quot;">​</a></h2><h4 id="插入数据" tabindex="-1">插入数据 <a class="header-anchor" href="#插入数据" aria-label="Permalink to &quot;插入数据&quot;">​</a></h4><h5 id="批量操作" tabindex="-1">批量操作 <a class="header-anchor" href="#批量操作" aria-label="Permalink to &quot;批量操作&quot;">​</a></h5><p>2-1000条</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> emp (</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">1</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">柳岩</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">女</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">20</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">123456789012345678</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">北京</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2000-01-01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">       (</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">张无忌</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">男</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">18</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">123456789012345670</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">北京</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2005-09-01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span></code></pre></div><p>手动提交事务</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">start transaction</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">insert</span><span style="color:#A6ACCD;"> ....</span></span>
<span class="line"><span style="color:#F78C6C;">commit</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><p>如果一次性涉及大批量数据，insert 语句性能较低，此时可以使用sql 的load 指令进行插入</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 客户端连接服务器时，加上参数，--local-infile</span></span>
<span class="line"><span style="color:#FFCB6B;">sql</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--local-infile</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-uroot</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-p</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 设置全局参数local-infile 为1 开启从本地加载文件导入数据的开关</span></span>
<span class="line"><span style="color:#82AAFF;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">global</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">local_infile</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 执行load 指令将准备好的数据，加载到表结构当中</span></span>
<span class="line"><span style="color:#FFCB6B;">load</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">data</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">local</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">file</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/home/xxx.log</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">into</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">table</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">xxx</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">fields</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">terminated</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">by</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">lines</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">terminated</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">\n</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span></code></pre></div><h4 id="主键优化" tabindex="-1">主键优化 <a class="header-anchor" href="#主键优化" aria-label="Permalink to &quot;主键优化&quot;">​</a></h4><p>在InnoDB 存储引擎中，表数据都是根据主键顺序组织存放的，这种存储方式的表称为索引组织表（Index Organized Table IOT）。</p><p><img src="/assets/1f1bab1f4d4c482c8ddae030497599e0.0e2cc131.png" alt="在这里插入图片描述"></p><p>一个Page 默认是16K ，一个Extent 是固定的，是1M。一个Page 是InnoDB 磁盘管理的最小单元。</p><h5 id="页分裂" tabindex="-1">页分裂 <a class="header-anchor" href="#页分裂" aria-label="Permalink to &quot;页分裂&quot;">​</a></h5><p>页可以为空，也可以填充一半，也可以填充满。每个页包含了2-N行数据（如果一行数据过大，会行溢出），根据主键排序。</p><p><img src="/assets/0121abb0031e4416aed791cf6eab0020.fe6f4d47.png" alt="在这里插入图片描述"></p><p><img src="/assets/571d2b173d9d447c8c1ab65f6ccb9ad9.f99b8c7e.png" alt="在这里插入图片描述"></p><p>首先会新获取一个page, 将page 页的50%之后的数据，迁移到新开辟的页面，就新数据50插入到新页面，然后重新设置页的表指针。这个操作成为页分裂。</p><h5 id="页合并" tabindex="-1">页合并 <a class="header-anchor" href="#页合并" aria-label="Permalink to &quot;页合并&quot;">​</a></h5><p>当删除一行记录时，实际上记录并没有被物理删除，而是被标记（flaged）为删除并且它的空间变得被其他记录声明使用。当页中删除的记录达到MERGE_THREADSHOLD(默认页的50%)，InnoDB 会开始寻找最靠近的页看看是否可以将2个页合并优化空间使用。</p><p><img src="/assets/358e489b152743578ef6e944277a2c5c.52fd7152.png" alt="在这里插入图片描述"></p><p>MERGE_THREADSHOLD：合并页的阈值，可以自己设置，在创建表或者创建索引时指定。</p><h5 id="主键设计原则" tabindex="-1">主键设计原则 <a class="header-anchor" href="#主键设计原则" aria-label="Permalink to &quot;主键设计原则&quot;">​</a></h5><ul><li>满足业务需求的情况下，尽量降低主键的长度（二级索引存储聚集索引的值）。</li><li>插入数据时，尽量选择顺序插入，选择AUTO_INCREMENT 自增主键。</li><li>尽量不要使用UUID 做主键或者是其他自然主键。</li><li>业务操作时，避免对主键的修改。</li></ul><h4 id="order-by-优化" tabindex="-1">order by 优化 <a class="header-anchor" href="#order-by-优化" aria-label="Permalink to &quot;order by 优化&quot;">​</a></h4><ul><li>using filesort : 通过表的索引或者扫描权标，读取满足条件的数据行，然后在排序缓冲区sort buffer 中完成排序操作，所有不是通过索引直接返回排序结果的排序都是 FileSort 排序。</li><li>using index : 通过有序索引顺序扫描直接返回有序数据，这种情况即为 using index，不需要额外排序，操作效率高。</li></ul><p>将<code>emp</code>中的<code>idcard</code>索引删除。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 删除索引</span></span>
<span class="line"><span style="color:#F78C6C;">DROP</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">INDEX</span><span style="color:#A6ACCD;"> idx_id_card </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> emp;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">EXPLAIN </span><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">emp</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">order by</span><span style="color:#A6ACCD;"> idcard;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">explain </span><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> id, workno, age,idcard  </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> emp </span><span style="color:#F78C6C;">order by</span><span style="color:#A6ACCD;"> workno </span><span style="color:#F78C6C;">desc</span><span style="color:#A6ACCD;">, age </span><span style="color:#F78C6C;">desc</span><span style="color:#A6ACCD;"> ,idcard </span><span style="color:#F78C6C;">desc</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><p><img src="/assets/24be6a4b98264ba28a4cdde6b15d5e77.59cb4efb.png" alt="在这里插入图片描述"></p><p><img src="/assets/5b61a7d2351e45439e3f8a33a56018e0.98097e42.png" alt="在这里插入图片描述"></p><p><img src="/assets/be783aeb6f4343588fd155125413e8b8.4be14166.png" alt="在这里插入图片描述"></p><p>然而根据最左原则，排序字段应该也要跟着索引指定的字段顺序进行排序</p><p><img src="/assets/67209c8abe554ef5b22a8388bd496cbd.d1352c66.png" alt="在这里插入图片描述"></p><p>当select 字段不出现在索引中，需要回表操作，此时，缓冲区会用filesort 进行排序。</p><p><strong>小结</strong></p><ul><li>根据排序字段建立合适的索引，多字段排序时，也遵循最左前缀法则。</li><li>尽量使用覆盖索引。</li><li>多字段排序，一个升序，一个降序，此时需要注意联合索引在创建时的规则（ASC/DESC ）。</li><li>如果不可避免的出现filesort，大数据量排序，可适当增大排序缓冲区大小 sort_buffer_size（默认256k）。</li></ul><h4 id="group-by-优化" tabindex="-1">group by 优化 <a class="header-anchor" href="#group-by-优化" aria-label="Permalink to &quot;group by 优化&quot;">​</a></h4><p>先删除表上其他索引</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">drop</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">index</span><span style="color:#A6ACCD;"> xxx </span><span style="color:#F78C6C;">on</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">explain </span><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> workaddress,</span><span style="color:#82AAFF;">count</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> emp </span><span style="color:#F78C6C;">group by</span><span style="color:#A6ACCD;">  workaddress</span></span></code></pre></div><p><img src="/assets/2c16b1190de04b2ab33950ec5635765f.edd3e419.png" alt="在这里插入图片描述"></p><p><code>Using temporary</code>使用临时表性能非常低。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 创建一个联合索引</span></span>
<span class="line"><span style="color:#F78C6C;">create</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">index</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">idx_add_gender</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">on</span><span style="color:#A6ACCD;"> emp(workaddress,gender);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">explain </span><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> workaddress,</span><span style="color:#82AAFF;">count</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> emp </span><span style="color:#F78C6C;">group by</span><span style="color:#A6ACCD;">  workaddress</span></span></code></pre></div><p><img src="/assets/e805ec86d63d411d89c2bec86aecd332.ea9eb10b.png" alt="在这里插入图片描述"></p><p>当group by 不满足最左前缀法则，则用不到索引，先会使用临时表。</p><p><img src="/assets/9c1e1ca845a840609ece72553b5fbda4.a98c319f.png" alt="在这里插入图片描述"></p><p>当查询涉及如上的查询，在查询条件添加where 条件且刚好满足最左原则则查询可以使用索引。</p><p><img src="/assets/5033bfc9073c47ae8bc44b3a6ce9fc3f.80422bd9.png" alt="在这里插入图片描述"></p><p>分组操作时，索引的适合用也是尽可能满足最左前缀法则。</p><h4 id="limit-优化" tabindex="-1">limit 优化 <a class="header-anchor" href="#limit-优化" aria-label="Permalink to &quot;limit 优化&quot;">​</a></h4><p><code>user_operation_log</code>这张表有1000w的数据。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> user_operation_log </span><span style="color:#F78C6C;">limit</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1000000</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">10</span></span></code></pre></div><p><img src="/assets/417ec01da5f74328a9926f28b7fce7c0.e0f2d1dc.png" alt="在这里插入图片描述"></p><p>时长显然是不可接受的。在对于limit 来说，大数据量的情况下，越往后效率越低，耗时越长。sql需要排序前N 条记录，仅仅返回N-(N+n)条记录，其他记录设计，查询排序的代价非常大。</p><p>官方推荐使用覆盖索引加子查询的方式。</p><p><img src="/assets/b9f8d65ce4664e3c80b235a135fac181.6ce03132.png" alt="在这里插入图片描述"></p><p>sql 不支持此类语法 <s><code>select * from user_operation_log where id in (select id from user_operation_log order by id limit 1000000,10)</code></s>，8.0的版本不支持在 in 条件的子查询里使用<code>limit</code>，所以要修改写法。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> user_operation_log u,(</span><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> id </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> user_operation_log </span><span style="color:#F78C6C;">order by</span><span style="color:#A6ACCD;"> id </span><span style="color:#F78C6C;">limit</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1000000</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">) a </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> u.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> a.id</span></span></code></pre></div><p><img src="/assets/7ffe0112af4046409abe8fc1942d78c5.3da8d946.png" alt="在这里插入图片描述"></p><p><img src="/assets/62e5907050104fdf9cdbacfaa111da6b.3014371d.png" alt="在这里插入图片描述"></p><h4 id="count-优化" tabindex="-1">count 优化 <a class="header-anchor" href="#count-优化" aria-label="Permalink to &quot;count 优化&quot;">​</a></h4><p>MyISAM 引擎把一个表的总行数存在了磁盘上，因此执行<code>count(*)</code>的时候会直接返回这个数，效率很高。而在InnoDB 引擎就麻烦了，他执行<code>count(*)</code>的时候，需要把数据一行一行地从引擎里读，然后累积计数。</p><h5 id="count" tabindex="-1">count <a class="header-anchor" href="#count" aria-label="Permalink to &quot;count&quot;">​</a></h5><p><code>count()</code>是一个聚合函数，对于返回的结果集，一行行地判断，如果count() 函数的参数不是<code>NULL </code>就累加1，否则不加，最后返回累计值。</p><p>InnoDB 在<code>count(主键)</code>时，会遍历整张表，把每一行的主键ID的值都取出来，返回给服务层。服务层拿到主键后，直接进行累加（主键不可能为<code>null</code>）。</p><p>count(1)，遍历整张表，不取值，对于返回的每一层，放一个数字1，进行累加。</p><p>count(*)，InnoDB引擎不会把全部字段取出来，而是专门做了优化，直接按行进行累加。</p><p>按照效率 count(字段)&lt; count(pk)&lt; count(1)≈count(*)</p><h4 id="update-优化" tabindex="-1">update 优化 <a class="header-anchor" href="#update-优化" aria-label="Permalink to &quot;update 优化&quot;">​</a></h4><p>update 时候尽量使用ID作为条件更新，不然update 会因为没有索引，从而将行锁升级为表锁。InnoDB 的行锁只针对索引加的锁，不是针对记录加的锁，并且索引不能失效，否则会从行锁升级为表锁。</p><h2 id="事务" tabindex="-1">事务 <a class="header-anchor" href="#事务" aria-label="Permalink to &quot;事务&quot;">​</a></h2><blockquote><p>事务是指满足 ACID 特性的一组操作，可以通过 Commit 提交一个事务，也可以使用 Rollback 进行回滚。</p></blockquote><h3 id="acid" tabindex="-1">ACID <a class="header-anchor" href="#acid" aria-label="Permalink to &quot;ACID&quot;">​</a></h3><p>事务最基本的莫过于 ACID 四个特性了，这四个特性分别是：</p><ul><li>Atomicity：原子性</li><li>Consistency：一致性</li><li>Isolation：隔离性</li><li>Durability：持久性</li></ul><blockquote><p><strong>原子性</strong></p><p>事务被视为不可分割的最小单元，事务的所有操作要么全部成功，要么全部失败回滚。</p><p><strong>一致性</strong></p><p>数据库在事务执行前后都保持一致性状态，在一致性状态下，所有事务对一个数据的读取结果都是相同的。</p><p><strong>隔离性</strong></p><p>一个事务所做的修改在最终提交以前，对其他事务是不可见的。</p><p><strong>持久性</strong></p><p>一旦事务提交，则其所做的修改将会永远保存到数据库中。即使系统发生崩溃，事务执行的结果也不能丢。</p><p><img src="/assets/image-20220319122922662.a93c50c6.png" alt="image-20220319122922662"></p></blockquote><h3 id="隔离级别" tabindex="-1">隔离级别 <a class="header-anchor" href="#隔离级别" aria-label="Permalink to &quot;隔离级别&quot;">​</a></h3><p><strong>未提交读（READ UNCOMMITTED）</strong></p><p>事务中的修改，即使没有提交，对其他事务也是可见的。</p><p><strong>提交读（READ COMMITTED）</strong></p><p>一个事务只能读取已经提交的事务所做的修改。换句话说，一个事务所做的修改在提交之前对其他事务是不可见的。</p><p><strong>可重复读（REPEATABLE READ）</strong></p><p>保证在同一个事务中多次读取同样数据的结果是一样的。</p><p><strong>可串行化（SERIALIZABLE）</strong></p><p>强制事务串行执行。</p><p>需要加锁实现，而其它隔离级别通常不需要。</p><table><thead><tr><th style="text-align:center;">隔离级别</th><th style="text-align:center;">脏读</th><th style="text-align:center;">不可重复读</th><th style="text-align:center;">幻影读</th></tr></thead><tbody><tr><td style="text-align:center;">未提交读</td><td style="text-align:center;">√</td><td style="text-align:center;">√</td><td style="text-align:center;">√</td></tr><tr><td style="text-align:center;">提交读</td><td style="text-align:center;">×</td><td style="text-align:center;">√</td><td style="text-align:center;">√</td></tr><tr><td style="text-align:center;">可重复读</td><td style="text-align:center;">×</td><td style="text-align:center;">×</td><td style="text-align:center;">√</td></tr><tr><td style="text-align:center;">可串行化</td><td style="text-align:center;">×</td><td style="text-align:center;">×</td><td style="text-align:center;">×</td></tr></tbody></table><h3 id="事务问题" tabindex="-1">事务问题 <a class="header-anchor" href="#事务问题" aria-label="Permalink to &quot;事务问题&quot;">​</a></h3><p><code>脏读</code></p><p>脏读指的是不同事务下，当前事务可以读取到另外事务未提交的数据。</p><p><code>不可重复读</code></p><p>不可重复读指的是同一事务内多次读取同一数据集合，读取到的数据是不一样的情况。</p><p><code>幻读</code></p><p>在同一事务下，连续执行两次同样的 sql 语句可能返回不同的结果，第二次的 sql 语句可能会返回之前不存在的行。幻读是一种特殊的不可重复读问题。</p><h4 id="事务失效场景" tabindex="-1">事务失效场景 <a class="header-anchor" href="#事务失效场景" aria-label="Permalink to &quot;事务失效场景&quot;">​</a></h4><p><img src="/assets/image-20220114111224311.9961011b.png" alt="image-20220114111224311"></p><h5 id="_1-访问权限问题" tabindex="-1">1.访问权限问题 <a class="header-anchor" href="#_1-访问权限问题" aria-label="Permalink to &quot;1.访问权限问题&quot;">​</a></h5><blockquote><p>java的访问权限主要有四种：private、default、protected、public，它们的权限从左到右，依次变大。</p><p>spring要求被代理方法必须是<code>public</code>的</p><p><code>AbstractFallbackTransactionAttributeSource</code>类的<code>computeTransactionAttribute</code>方法中有个判断，如果目标方法不是public，则<code>TransactionAttribute</code>返回null，即不支持事务。</p></blockquote><h5 id="_2-方法用final修饰" tabindex="-1">2. 方法用final修饰 <a class="header-anchor" href="#_2-方法用final修饰" aria-label="Permalink to &quot;2. 方法用final修饰&quot;">​</a></h5><blockquote><p>事务方法定义成final会导致事务失效</p><p>spring事务底层使用了aop，也就是通过jdk动态代理或者cglib，帮我们生成了代理类，在代理类中实现的事务功能。</p><p>但如果某个方法用final修饰了，那么在它的代理类中，就无法重写该方法，而添加事务功能。</p><blockquote><p>注意：如果某个方法是static的，同样无法通过动态代理，变成事务方法。</p></blockquote></blockquote><h5 id="_3-方法内部调用" tabindex="-1">3.方法内部调用 <a class="header-anchor" href="#_3-方法内部调用" aria-label="Permalink to &quot;3.方法内部调用&quot;">​</a></h5><blockquote><p>举例</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Service</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">UserService</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Autowired</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">UserMapper</span><span style="color:#A6ACCD;"> userMapper</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Transactional</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">UserModel</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">userModel</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       userMapper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">insertUser</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">userModel</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">updateStatus</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">userModel</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Transactional</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">updateStatus</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">UserModel</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">userModel</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">doSameThing</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 直接调用了this对象的方法,updateStatus方法不会生成事务</span></span></code></pre></div><p><code>原因</code></p><blockquote><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">Spring在扫描Bean的时候会自动为标注了@Transactional注解的类生成一个代理类（proxy）,当有注解的方法被调用的时候，实际上是代理类调用的，代理类在调用之前会开启事务，执行事务的操作，但是同类中的方法互相调用，相当于this.B()，此时的B方法并非是代理类调用，而是直接通过原有的Bean直接调用，所以注解会失效。</span></span></code></pre></div></blockquote><p><code>解决方案:</code> <strong>通过AopContent类</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Servcie</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ServiceA</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">save</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">User</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">user</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">queryData1</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">queryData2</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">ServiceA</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">AopContext</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentProxy</span><span style="color:#89DDFF;">()).</span><span style="color:#82AAFF;">doSave</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">user</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Transactional</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">rollbackFor</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">Exception</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">doSave</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">User</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">user</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">addData1</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">updateData2</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div></blockquote><h5 id="_4-未被spring管理" tabindex="-1">4.未被spring管理 <a class="header-anchor" href="#_4-未被spring管理" aria-label="Permalink to &quot;4.未被spring管理&quot;">​</a></h5><blockquote><p>使用spring事务的前提是：对象要被spring管理，需要创建bean实例。</p><p>通常情况下，我们通过@Controller、@Service、@Component、@Repository等注解，可以自动实现bean实例化和依赖注入的功能。</p></blockquote><h5 id="_5-多线程调用" tabindex="-1">5.多线程调用 <a class="header-anchor" href="#_5-多线程调用" aria-label="Permalink to &quot;5.多线程调用&quot;">​</a></h5><blockquote><p>在不同的线程，拿到的数据库连接肯定是不一样的，所以是不同的事务。</p></blockquote><h5 id="_6-表不支持事务" tabindex="-1">6.表不支持事务 <a class="header-anchor" href="#_6-表不支持事务" aria-label="Permalink to &quot;6.表不支持事务&quot;">​</a></h5><blockquote><p>myisam<code>不支持事务</code></p><p>innodb<code>支持事务</code></p></blockquote><h5 id="_7-错误的传播特性" tabindex="-1">7.错误的传播特性 <a class="header-anchor" href="#_7-错误的传播特性" aria-label="Permalink to &quot;7.错误的传播特性&quot;">​</a></h5><blockquote><p>使用<code>@Transactional</code>注解时，是可以指定<code>propagation</code>参数的。</p><p>该参数的作用是指定事务的传播特性，spring目前支持7种传播特性：</p><ul><li><code>REQUIRED</code> 如果当前上下文中存在事务，那么加入该事务，如果不存在事务，创建一个事务，这是默认的传播属性值。</li><li><code>SUPPORTS</code> 如果当前上下文存在事务，则支持事务加入事务，如果不存在事务，则使用非事务的方式执行。</li><li><code>MANDATORY</code> 如果当前上下文中存在事务，否则抛出异常。</li><li><code>REQUIRES_NEW</code> 每次都会新建一个事务，并且同时将上下文中的事务挂起，执行当前新建事务完成以后，上下文事务恢复再执行。</li><li><code>NOT_SUPPORTED</code> 如果当前上下文中存在事务，则挂起当前事务，然后新的方法在没有事务的环境中执行。</li><li><code>NEVER</code> 如果当前上下文中存在事务，则抛出异常，否则在无事务环境上执行代码。</li><li><code>NESTED</code> 如果当前上下文中存在事务，则嵌套事务执行，如果不存在事务，则新建事务。</li></ul><p>注解<code>@Transactional</code>中Propagation属性值设置错误</p><p>只有这三种传播特性才会创建新事务：REQUIRED，REQUIRES_NEW，NESTED。</p></blockquote><h5 id="_8-未抛出异常" tabindex="-1">8.未抛出异常 <a class="header-anchor" href="#_8-未抛出异常" aria-label="Permalink to &quot;8.未抛出异常&quot;">​</a></h5><blockquote><p>业务代码中存在异常时，使用try…catch…语句块捕获，而catch语句块没有throw new RuntimeExecption异常</p></blockquote><h5 id="_9-嵌套事务回滚超出预期" tabindex="-1">9.嵌套事务回滚超出预期 <a class="header-anchor" href="#_9-嵌套事务回滚超出预期" aria-label="Permalink to &quot;9.嵌套事务回滚超出预期&quot;">​</a></h5><blockquote><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">UserService</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Autowired</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">UserMapper</span><span style="color:#A6ACCD;"> userMapper</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Autowired</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">RoleService</span><span style="color:#A6ACCD;"> roleService</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Transactional</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">UserModel</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">userModel</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Exception</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          userMapper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">insertUser</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">userModel</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">          roleService</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">doOtherThing</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Service</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RoleService</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Transactional</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">propagation</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Propagation</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">NESTED</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">doOtherThing</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">保存role表数据</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><blockquote><p>使用了嵌套的内部事务，原本是希望调用roleService.doOtherThing方法时，如果出现了异常，只回滚doOtherThing方法里的内容，不回滚 userMapper.insertUser里的内容，即回滚保存点</p></blockquote><blockquote><p>但事实是，insertUser也回滚了</p></blockquote><blockquote><p>因为doOtherThing方法出现了异常，没有手动捕获，会继续往上抛，到外层add方法的代理方法中捕获了异常。所以，这种情况是直接回滚了整个事务，不只回滚单个保存点。</p></blockquote><p><code>解决方案</code></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Slf4j</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Service</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">UserService</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Autowired</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">UserMapper</span><span style="color:#A6ACCD;"> userMapper</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Autowired</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">RoleService</span><span style="color:#A6ACCD;"> roleService</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Transactional</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">UserModel</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">userModel</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Exception</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            userMapper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">insertUser</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">userModel</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;font-style:italic;">// 嵌套事务 try/catch</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                roleService</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">doOtherThing</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Exception</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                log</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">error</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getMessage</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><blockquote><p>将内部嵌套事务放在try/catch中，并且不继续往上抛异常。这样就能保证，如果内部嵌套事务中出现异常，只回滚内部事务，而不影响外部事务。</p></blockquote></blockquote><h5 id="_10-大事务问题" tabindex="-1">10.大事务问题 <a class="header-anchor" href="#_10-大事务问题" aria-label="Permalink to &quot;10.大事务问题&quot;">​</a></h5><p><img src="/assets/image-20220114113044661.30199ba1.png" alt="image-20220114113044661"></p><h6 id="_1-编程式事务解决方案" tabindex="-1">1.编程式事务解决方案 <a class="header-anchor" href="#_1-编程式事务解决方案" aria-label="Permalink to &quot;1.编程式事务解决方案&quot;">​</a></h6><blockquote><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Autowired</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TransactionTemplate</span><span style="color:#A6ACCD;"> transactionTemplate</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">save</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">User</span><span style="color:#A6ACCD;"> user</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#82AAFF;">queryData1</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#82AAFF;">queryData2</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">   transactionTemplate</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">execute</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">status</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">           </span><span style="color:#82AAFF;">addData1</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">           </span><span style="color:#82AAFF;">updateData2</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">           </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> Boolean</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">TRUE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">})</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    ```</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">TransactionTemplate，在它的execute方法中，就实现了事务的功能</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">相较于`</span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Transactional</span><span style="color:#A6ACCD;">`注解声明式事务，我更建议大家使用，基于`TransactionTemplate`的编程式事务。主要原因如下：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">1.</span><span style="color:#A6ACCD;"> 避免由于spring aop问题，导致事务失效的问题。</span></span>
<span class="line"><span style="color:#F78C6C;">2.</span><span style="color:#A6ACCD;"> 能够更小粒度的控制事务的范围，更直观。</span></span></code></pre></div></blockquote><h6 id="_2-将查询-select-方法放到事务外" tabindex="-1">2.将查询(select)方法放到事务外 <a class="header-anchor" href="#_2-将查询-select-方法放到事务外" aria-label="Permalink to &quot;2.将查询(select)方法放到事务外&quot;">​</a></h6><blockquote><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Autowired</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TransactionTemplate</span><span style="color:#A6ACCD;"> transactionTemplate</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">save</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">User</span><span style="color:#A6ACCD;"> user</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#82AAFF;">queryData1</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#82AAFF;">queryData2</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">       transactionTemplate</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">execute</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">status</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">           </span><span style="color:#82AAFF;">addData1</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">           </span><span style="color:#82AAFF;">updateData2</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> Boolean</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">TRUE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">})</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span></code></pre></div><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Servcie</span></span>
<span class="line"><span style="color:#A6ACCD;">publicclass ServiceA </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">save</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">User</span><span style="color:#A6ACCD;"> user</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">queryData1</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">queryData2</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">ServiceA</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">AopContext</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentProxy</span><span style="color:#89DDFF;">()).</span><span style="color:#82AAFF;">doSave</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">user</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Transactional</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">rollbackFor</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">Exception</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">doSave</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">User</span><span style="color:#A6ACCD;"> user</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">addData1</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">updateData2</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span></span></code></pre></div></blockquote><h6 id="_3-事务中避免远程调用" tabindex="-1">3.事务中避免远程调用 <a class="header-anchor" href="#_3-事务中避免远程调用" aria-label="Permalink to &quot;3.事务中避免远程调用&quot;">​</a></h6><h6 id="_4-事务中避免一次性处理太多数据" tabindex="-1">4.事务中避免一次性处理太多数据 <a class="header-anchor" href="#_4-事务中避免一次性处理太多数据" aria-label="Permalink to &quot;4.事务中避免一次性处理太多数据&quot;">​</a></h6><blockquote><p>分页处理，1000条数据，分50页，一次只处理20条数据，这样可以大大减少大事务的出现。</p></blockquote><h6 id="_5-非事务执行" tabindex="-1">5.非事务执行 <a class="header-anchor" href="#_5-非事务执行" aria-label="Permalink to &quot;5.非事务执行&quot;">​</a></h6><h6 id="_6-异步处理" tabindex="-1">6.异步处理 <a class="header-anchor" href="#_6-异步处理" aria-label="Permalink to &quot;6.异步处理&quot;">​</a></h6><h2 id="锁" tabindex="-1">锁 <a class="header-anchor" href="#锁" aria-label="Permalink to &quot;锁&quot;">​</a></h2><h3 id="mysql锁" tabindex="-1">Mysql锁 <a class="header-anchor" href="#mysql锁" aria-label="Permalink to &quot;Mysql锁&quot;">​</a></h3><p>锁是计算机协调多个进程或线程并发访问某一资源的机制。在数据库种，除传统的计算机资源（CPU，RAM，I/O）的争用以外，数据也是一种提供多用户共享的资源。如何保证数据并发访问的一致性，有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个角度来说，锁对数据库而言显得尤其重要，也更复杂。</p><p>按照锁的粒度来分，sql中的锁分为以下三类</p><ul><li>全局锁：锁定数据库中的所有表。</li><li>表级锁：每次操作锁住整张表</li><li>行级锁：每次操作锁住对于的行数据。</li></ul><h4 id="全局锁" tabindex="-1">全局锁 <a class="header-anchor" href="#全局锁" aria-label="Permalink to &quot;全局锁&quot;">​</a></h4><p>对整个数据库实例枷锁，枷锁后整个实例就处于制度状态，后续的DML的写语句，DDL语句，以及更新操作的事务提交语句都将被阻塞。通常用于备份数据<code>sqldump</code>。</p><h4 id="表级锁" tabindex="-1">表级锁 <a class="header-anchor" href="#表级锁" aria-label="Permalink to &quot;表级锁&quot;">​</a></h4><p>表级锁，每次操作锁住整张表。锁粒度打，发视锁冲突的概率高，并发度最低，应用在MyISAM，InnoDB等存储引擎中。</p><p>对于表级锁，主要分三类</p><ol><li>表锁</li><li>元数据锁</li><li>意向锁</li></ol><h5 id="表锁" tabindex="-1">表锁 <a class="header-anchor" href="#表锁" aria-label="Permalink to &quot;表锁&quot;">​</a></h5><p>表锁分为2类</p><ol><li>表共享读锁（read lock）</li><li>表独占写锁（write lock）</li></ol><p>加锁：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">lock tables </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">read</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">write</span></span></code></pre></div><p>释放锁：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">unlock</span><span style="color:#A6ACCD;"> tables</span></span></code></pre></div><h6 id="读锁" tabindex="-1">读锁 <a class="header-anchor" href="#读锁" aria-label="Permalink to &quot;读锁&quot;">​</a></h6><p><img src="/assets/bb1a4b876e1d4ea08beb31f5296da858.1aebb236.png" alt="在这里插入图片描述"></p><p>客户端1在表上加锁，客户端1和其他客户端都只能够查询，不能够写。当客户端1去写入数据会直接提示 <code>Table &#39;xxx&#39; was locked with a READ lock and can&#39;t be updated</code>，当其他客户端写入数据时，会直接阻塞，直到客户端1解锁。</p><h6 id="写锁" tabindex="-1">写锁 <a class="header-anchor" href="#写锁" aria-label="Permalink to &quot;写锁&quot;">​</a></h6><p><img src="/assets/a575cbf6f7984b49a9e5e39c5b339942.76bdbdda.png" alt="在这里插入图片描述"></p><p>客户端1在表上加锁，只有客户端1能够读写。当其他客户端读写数据时，都会直接阻塞，直到客户端1解锁。</p><h5 id="元数据锁" tabindex="-1">元数据锁 <a class="header-anchor" href="#元数据锁" aria-label="Permalink to &quot;元数据锁&quot;">​</a></h5><p>元数据锁（meta data lock ), MDL 加锁过程是系统自动控制，无需显示使用，在访问一张表的时候会自动加上。MDL锁主要作用是维护表元数据的数据一致性，在表上有活动事务的时候，不可以对元数据进行写入操作。<strong>为了避免DML和DDL冲突，保证读写的正确性</strong>。</p><p>在sql 5.5 中引用了MDL，当对一张表进行增删改查的时候，加MDL读锁（共享）；当表结构进行变更操作的时候，加上MDL写锁（排他）。</p><table><thead><tr><th style="text-align:center;">对应SQL</th><th style="text-align:center;">锁类型</th><th style="text-align:center;">说明</th></tr></thead><tbody><tr><td style="text-align:center;">lock tables xxx read/write</td><td style="text-align:center;">SHARED_READ_ONLY/SHARED_NO_READ_WRITE</td><td style="text-align:center;"></td></tr><tr><td style="text-align:center;">select ,select... lock in share mode</td><td style="text-align:center;">SHARED_READ</td><td style="text-align:center;">与SHARED_READ，SHARED_WRITE兼容。与EXCLUSIVE互斥</td></tr><tr><td style="text-align:center;">insert ,update, delete, select... for update</td><td style="text-align:center;">SHARED_WRITE</td><td style="text-align:center;">与SHARED_READ，SHARED_WRITE兼容。与EXCLUSIVE互斥</td></tr><tr><td style="text-align:center;">alter table...</td><td style="text-align:center;">EXCLUSIVE</td><td style="text-align:center;">与其他的MDL都互斥</td></tr></tbody></table><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> object_type,object_schema,object_name,lock_type,lock_duration </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> performace_schema.metadata_locks;</span></span></code></pre></div><p>当开启一个事务的时候不会产生元数据锁，只有增删查改，修改表结构的时候才会看到自动加锁。</p><h5 id="意向锁" tabindex="-1">意向锁 <a class="header-anchor" href="#意向锁" aria-label="Permalink to &quot;意向锁&quot;">​</a></h5><p>为了避免DML 在执行时，加的行锁与表锁的冲突，在InnoDB 中应如何了意向锁，使得表锁不用检查每行数据是否加锁，使用意向锁来减少表锁的检查。</p><p>不用逐行检查行锁，而是检查意向锁的情况，如果意向锁和当前加的锁是兼容的，如果兼容直接加锁，如果不兼容就会处于阻塞状态，知道A线程提交事务，解锁意向锁。</p><table><thead><tr><th style="text-align:center;">意向共享锁（IS）</th><th style="text-align:center;">意向拍打锁（IX）</th></tr></thead><tbody><tr><td style="text-align:center;">由语句select ... lock in share mode添加。</td><td style="text-align:center;">由 insert，update，delete，select ... for update添加。</td></tr><tr><td style="text-align:center;">与表锁共享锁read 兼容，与表锁排他write锁互斥</td><td style="text-align:center;">与表锁共享锁read ，表锁排他write锁互斥。意向锁之间不会互斥</td></tr><tr><td style="text-align:center;"></td><td style="text-align:center;"></td></tr></tbody></table><p>通过以下SQL 查看意向所以及行锁的加锁情况。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> object_schema,object_name,index_name,lock_type,lock_mode,lock_data </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> performance_schema.data_locks;</span></span></code></pre></div><p>意向锁主要解决的问题是在InnoDB 引擎在加表锁和行锁的冲突问题。</p><h4 id="行级锁" tabindex="-1">行级锁 <a class="header-anchor" href="#行级锁" aria-label="Permalink to &quot;行级锁&quot;">​</a></h4><p>行级锁，每次操作锁住对应的行数据。锁的力度小，发生锁冲突的概率低，并发度最高，应用在InnoDB 存储引擎中。</p><p>InnoDB 的数据是基于索引组织的。行锁是通过对表锁上的索引项加锁实现的，而不是对记录加的锁。对于行级锁，主要分一下三类：</p><ul><li>行锁（Record Lock）：锁定单个记录的锁，防止其他事务对此进行update 和 delete。在RC、RR 隔离级别下都支持。</li><li>间隙锁（Gap Lock）：锁定索引记录间隙（不含该记录），确保索引间隙不变，防止其他事务在这个间隙进行insert ，产生幻读。在RR 隔离级别下都支持。</li><li>临间锁（Next-key Lock）：行锁和间隙锁的组合，同时锁住数据，并锁住数据前面的间隙Gap 。在RR 隔离级别下支持。</li><li><img src="/assets/140070ee86d7430ba3649fe1fc418926.4847ec06.png" alt="在这里插入图片描述"></li></ul><h5 id="行锁" tabindex="-1">行锁 <a class="header-anchor" href="#行锁" aria-label="Permalink to &quot;行锁&quot;">​</a></h5><p>InnoDB 实现了一下两种类型的行锁：</p><ul><li>共享锁（S）：允许一个事务读取一行，阻止其他事物获得相同数据集的排他锁。</li><li>排他锁（X）：允许获取排他锁的事务更新数据，阻止其他事物相同数据集的共享锁和排他锁。</li></ul><table><thead><tr><th style="text-align:center;"></th><th style="text-align:center;">S 共享锁</th><th style="text-align:center;">X 排他锁</th></tr></thead><tbody><tr><td style="text-align:center;">S 共享锁</td><td style="text-align:center;">兼容</td><td style="text-align:center;">冲突</td></tr><tr><td style="text-align:center;">X 排他锁</td><td style="text-align:center;">冲突</td><td style="text-align:center;">冲突</td></tr></tbody></table><table><thead><tr><th style="text-align:center;">SQL</th><th style="text-align:center;">行锁类型</th><th style="text-align:center;">说明</th></tr></thead><tbody><tr><td style="text-align:center;">INSERT...</td><td style="text-align:center;">排他</td><td style="text-align:center;">自动加锁</td></tr><tr><td style="text-align:center;">UPDATE...</td><td style="text-align:center;">排他</td><td style="text-align:center;">自动加锁</td></tr><tr><td style="text-align:center;">DELETE...</td><td style="text-align:center;">排他</td><td style="text-align:center;">自动加锁</td></tr><tr><td style="text-align:center;">SELECT</td><td style="text-align:center;">不加锁</td><td style="text-align:center;"></td></tr><tr><td style="text-align:center;">SELECT LOCK IN SHARE MODE</td><td style="text-align:center;">共享</td><td style="text-align:center;">需要手动加LOCK IN SHARE MODE</td></tr><tr><td style="text-align:center;">SELECT FOR UPDATE</td><td style="text-align:center;">排他</td><td style="text-align:center;">需要手动加 FOR UPDATE</td></tr></tbody></table><p>默认情况下，InnoDB 在RR 事物隔离级运行 InnoDB 使用 Next-key Lock 锁进行搜索和索引扫描防止幻读。</p><ol><li>针对唯一所有检索时，对已存在的记录进行等值匹配时，将会自动优化为行锁。</li><li>InnoDB 的行锁是针对于索引加的锁，不通过索引检索数据，那么InnoDB 将对表中所有的记录加锁，此时就会升级为表锁。</li></ol><h5 id="间隙锁-临键锁" tabindex="-1">间隙锁/临键锁 <a class="header-anchor" href="#间隙锁-临键锁" aria-label="Permalink to &quot;间隙锁/临键锁&quot;">​</a></h5><ul><li>索引上的等值查询（唯一索引）,给不存在的记录加锁，优化为间隙锁。</li><li>索引上的等值查询（普通查询），向右遍历时最后一个值不满足查询需求时，next-key lock 退化为间隙锁。</li><li>索引上的范围查询（唯一索引）会访问到不满足条件的第一个值位置。</li></ul><p><strong>注意：间隙锁唯一的目的是防止其他事物插入间隙，间隙锁可以共存，一个事务采用的间隙所不会阻塞另一个间隙上采用的间隙锁。</strong></p><h4 id="锁算法" tabindex="-1">锁算法 <a class="header-anchor" href="#锁算法" aria-label="Permalink to &quot;锁算法&quot;">​</a></h4><h5 id="record-lock" tabindex="-1">Record Lock <a class="header-anchor" href="#record-lock" aria-label="Permalink to &quot;Record Lock&quot;">​</a></h5><blockquote><p>锁定一个记录上的索引，而不是记录本身。</p><p>如果表没有设置索引，InnoDB 会自动在主键上创建隐藏的聚簇索引，因此 Record Locks 依然可以使用。</p></blockquote><h5 id="gap-lock" tabindex="-1">Gap Lock <a class="header-anchor" href="#gap-lock" aria-label="Permalink to &quot;Gap Lock&quot;">​</a></h5><blockquote><p>锁定索引之间的间隙，但是不包含索引本身。例如当一个事务执行以下语句，其它事务就不能在 t.c 中插入 15。</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">SELECT c FROM t WHERE c BETWEEN 10 and 20 FOR UPDATE;</span></span></code></pre></div></blockquote><h5 id="next-key-lock" tabindex="-1">Next-Key Lock <a class="header-anchor" href="#next-key-lock" aria-label="Permalink to &quot;Next-Key Lock&quot;">​</a></h5><blockquote><p>它是 Record Locks 和 Gap Locks 的结合，不仅锁定一个记录上的索引，也锁定索引之间的间隙。例如一个索引包含以下值：10, 11, 13, and 20，那么就需要锁定以下区间：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">(-∞, 10]</span></span>
<span class="line"><span style="color:#A6ACCD;">(10, 11]</span></span>
<span class="line"><span style="color:#A6ACCD;">(11, 13]</span></span>
<span class="line"><span style="color:#A6ACCD;">(13, 20]</span></span>
<span class="line"><span style="color:#A6ACCD;">(20, +∞)</span></span></code></pre></div></blockquote><blockquote><p>在 InnoDB 存储引擎中，SELECT 操作的不可重复读问题通过 MVCC 得到了解决</p><p>而 UPDATE、DELETE 的不可重复读问题通过 Record Lock 解决，</p><p>INSERT 的不可重复读问题是通过 Next-Key Lock（Record Lock + Gap Lock）解决的。</p></blockquote><h3 id="死锁问题" tabindex="-1">死锁问题 <a class="header-anchor" href="#死锁问题" aria-label="Permalink to &quot;死锁问题&quot;">​</a></h3><blockquote><p>排查死锁问题步骤</p><p>（1）查看死锁日志 show engine innodb status;</p><p>（2）找出死锁Sql</p><p>（3）分析sql加锁情况</p><p>（4）模拟死锁案发</p><p>（5）分析死锁日志</p><p>（6）分析死锁结果</p></blockquote><h3 id="索引与锁" tabindex="-1">索引与锁 <a class="header-anchor" href="#索引与锁" aria-label="Permalink to &quot;索引与锁&quot;">​</a></h3><h4 id="什么-sql-语句会加行锁" tabindex="-1">什么 SQL 语句会加行锁？ <a class="header-anchor" href="#什么-sql-语句会加行锁" aria-label="Permalink to &quot;什么 SQL 语句会加行锁？&quot;">​</a></h4><p><code>InnoDB</code> 引擎是支持行级锁的，而 MyISAM 引擎不支持行级锁。</p><p>普通的 select 语句是不会对记录加锁，它属于快照读，是通过 MVCC（多版本并发控制）实现的。</p><p>要在查询时对记录加行级锁，可以采用如下方式:</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;"># 对读取的记录加共享锁(S型锁)</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> ... lock </span><span style="color:#F78C6C;">in</span><span style="color:#A6ACCD;"> share mode;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># 对读取的记录加独占锁(X型锁)</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> ... for </span><span style="color:#F78C6C;">update</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><blockquote><p>1.上面这两条语句必须在一个事务中，因为当事务提交了，锁就会被释放，所以在使用这两条语句的时候，要加上 begin 或者 start transaction 开启事务的语句。</p></blockquote><p>除了这两条锁定读语句会加行级锁之外，update 和 delete 操作都会加行级锁，且都是独占锁(X型锁)。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;"># 对操作的记录加独占锁(X型锁)</span></span>
<span class="line"><span style="color:#A6ACCD;">updaet </span><span style="color:#F78C6C;">table</span><span style="color:#A6ACCD;"> .... </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># 对操作的记录加独占锁(X型锁)</span></span>
<span class="line"><span style="color:#F78C6C;">delete</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">table</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><blockquote><p>共享锁与独占锁的解释:</p><p>1.共享锁（S锁）满足读读共享，读写互斥。</p><p>2.独占锁（X锁）满足写写互斥、读写互斥。</p></blockquote><p>不同<code>隔离级别</code>下，行级锁的种类是不同的。</p><p>在<code>读已提交</code>隔离级别下，行级锁的种类只有记录锁，也就是仅仅把一条记录锁上。</p><p>在<code>可重复读</code>隔离级别下(<code>Mysql默认隔离级别</code>)，行级锁的种类除了有记录锁，还有间隙锁（目的是为了避免幻 读），所以行级锁的种类主要有三类:</p><ul><li>Record Lock，记录锁，也就是仅仅把一条记录锁上；</li><li>Gap Lock，间隙锁，锁定一个范围，但是不包含记录本身；</li><li>Next-Key Lock：Record Lock + Gap Lock 的组合，锁定一个范围，并且锁定记录本身。</li></ul><p><code>Record Lock</code></p><p>Record Lock 称为记录锁，锁住的是一条记录。而且记录锁是有 S 锁和 X 锁之分的：</p><ul><li>当一个事务对一条记录加了 S 型记录锁后，其他事务也可以继续对该记录加 S 型记录锁（S 型与 S 锁兼容），但是不可以对该记录加 X 型记录锁（S 型与 X 锁不兼容）;</li><li>当一个事务对一条记录加了 X 型记录锁后，其他事务既不可以对该记录加 S 型记录锁（S 型与 X 锁不兼容），也不可以对该记录加 X 型记录锁（X 型与 X 锁不兼容）。</li></ul><p>执行如下 sql:</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">mysql </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">begin</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">mysql </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> t_test </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> for </span><span style="color:#F78C6C;">update</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><blockquote><p>1.事务会对表中主键 id = 1 的这条记录加上 X 型的记录锁，如果这时候其他事务对这条记录进行删除或者更新操作，那么这些操作都会被阻塞。</p><p>2.其他事务插入一条 id = 1 的新记录并不会被阻塞，会报主键冲突的错误，这是因为主键有唯一性的约束。</p><p>3.当事务执行 commit 后，事务过程中生成的锁都会被释放。</p></blockquote><p><code>Gap Lock</code></p><p>Gap Lock 称为间隙锁，只存在于可重复读隔离级别，目的是为了解决可重复读隔离级别下幻读的现象。</p><blockquote><p>假设表中有一个范围 id 为（3，5）间隙锁，那么其他事务就无法插入 id = 4 这条记录了，这样就有效的防止幻读现象的发生。</p></blockquote><p>间隙锁之间是兼容的，即<code>两个事务可以同时持有包含共同间隙范围的间隙锁</code>，并不存在互斥关系，因为间隙锁的目的是防止插入幻影记录而提出的。</p><p><code>Next-Key Lock</code></p><p>Next-Key Lock 称为临键锁，是 Record Lock + Gap Lock 的组合，锁定一个范围，并且锁定记录本身。</p><blockquote><p>假设表中有一个范围 id 为（3，5] 的 next-key lock，那么其他事务既不能插入 id = 4 记录，也不能修改和删除 id = 5 这条记录。next-key lock 即能保护该记录，又能阻止其他事务将新记录插入到被保护记录前面的间隙中。</p></blockquote><p>next-key lock 是包含间隙锁+记录锁的，如果一个事务获取了 X 型的 next-key lock，那么另外一个事务在获取相同范围的 X 型的 next-key lock 时，是会被<code>阻塞</code>的。</p><h4 id="mysql-是怎么加行级锁的" tabindex="-1">MySQL 是怎么加行级锁的？ <a class="header-anchor" href="#mysql-是怎么加行级锁的" aria-label="Permalink to &quot;MySQL 是怎么加行级锁的？&quot;">​</a></h4><p>加锁的对象是<code>索引</code>，加锁的基本单位是 <code>next-key lock</code>，它是由记录锁和间隙锁组合而成的，next-key lock 是前开后闭区间，而间隙锁是前开后开区间。</p><p>next-key lock 在一些场景下会<code>退化</code>成记录锁或间隙锁。</p><p>在<code>能使用记录锁或者间隙锁就能避免幻读现象</code>的场景下， next-key lock 就会退化成退化成记录锁或间隙锁。</p><p>举例如下:</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> `</span><span style="color:#82AAFF;">user</span><span style="color:#A6ACCD;">` (</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">bigint</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> AUTO_INCREMENT,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">name</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">varchar</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">30</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">COLLATE</span><span style="color:#A6ACCD;"> utf8mb4_unicode_ci </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">age</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">KEY</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">index_age</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">age</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">USING</span><span style="color:#A6ACCD;"> BTREE</span></span>
<span class="line"><span style="color:#A6ACCD;">) ENGINE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">InnoDB </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> CHARSET</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4 </span><span style="color:#C792EA;">COLLATE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4_unicode_ci;</span></span></code></pre></div><blockquote><p>1.id 是主键索引（唯一索引），age 是普通索引（非唯一索引），name 是普通列</p><p>2.实验环境的 MySQL 版本是 8.0.28，隔离级别是「可重复读」。</p></blockquote><p><code>唯一索引等值查询</code></p><p>用唯一索引进行等值查询时:</p><ul><li><p>当查询的记录是「存在」的，在索引树上定位到这一条记录后，将该记录的索引中的next-key lock 会退化成「记录锁」。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">begin</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> user </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> for </span><span style="color:#F78C6C;">update</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><blockquote><p>1.事务 A 会为 id 为 1 的这条记录就会加上 X 型的记录锁。</p></blockquote></li></ul><blockquote><p>2.如果有其他事务，对 id 为 1 的记录进行更新或者删除操作的话，这些操作都会被阻塞，因为更新或者删除操作也会对记录加 X 型的记录锁，而 X 锁和 X 锁之间是互斥关系。</p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;"># 查看事务执行 </span><span style="color:#F78C6C;">SQL</span><span style="color:#A6ACCD;"> 过程中加锁</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> performance_schema.data_locks;</span></span></code></pre></div><blockquote><ol><li>LOCK_TYPE 中的 RECORD 表示行级锁,TABLE表示表锁(案例里是X 类型的意向锁)</li><li>如果 LOCK_MODE 为 X ，说明是 next-key 锁</li><li>如果 LOCK_MODE 为 X, REC_NOT_GAP ，说明是记录锁(对应案例查询sql)</li><li>如果 LOCK_MODE 为 X, GAP ，说明是间隙锁；</li></ol></blockquote><p><strong>总结</strong></p><blockquote><p>问题: 为什么唯一索引等值查询并且查询记录存在的场景下，该记录的索引中的 next-key lock 会退化成记录锁？</p><p>原因就是<code>在唯一索引等值查询并且查询记录存在的场景下，仅靠记录锁也能避免幻读</code>的问题。</p><p>幻读的定义就是，当一个事务前后两次查询的结果集，不相同时，就认为发生幻读。所以，要避免幻读就是避免结果集某一条记录被其他事务删除，或者有其他事务插入了一条新记录，这样前后两次查询的结果集就不会出现不相同的情况。</p><ul><li>由于主键具有唯一性，所以其他事务插入 id = 1 的时候，会因为主键冲突，导致无法插入 id = 1 的新记录。事务 A 在多次查询 id = 1 的记录的时候，不会出现前后两次查询的结果集不同，也就避免了幻读的问题</li><li>由于对 id = 1 加了记录锁，其他事务无法删除该记录，这样事务 A 在多次查询 id = 1的记录的时候，不会出现前后两次查询的结果集不同，也就避免了幻读的问题。</li></ul></blockquote><ul><li><p>当查询的记录是「不存在」的，在索引树找到第一条大于该查询记录的记录后，将该记录的索引中的 next-key lock 会退化成「间隙锁」。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">begin</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> user </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> for </span><span style="color:#F78C6C;">update</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> performance_schema.data_locks;</span></span></code></pre></div><blockquote><p>1.从上图可以看到，共加了两个锁，分别是 表锁：X 类型的意向锁 和 行锁：<code>X 类型的间隙锁</code></p></blockquote></li></ul><blockquote><p>2.事务 在 id = 5 记录的主键索引上加的是间隙锁，锁住的范围是 (1, 5)</p><p>3.如果有其他事务插入 id 值为 2、3、4 这一些记录的话，这些插入语句都会发生阻塞。</p><p>4.如果其他事务插入的 id = 1 或者 id = 5 的记录话，并不会发生阻塞，而是报主键冲突的错误，因为表中已经存在 id = 1 和 id = 5 的记录了。</p></blockquote><p><strong>总结</strong></p><blockquote><p>问题: 为什么唯一索引等值查询并且查询记录「不存在」的场景下，在索引树找到第一条大于该查询记录的记录后，要将该记录的索引中的 next-key lock 会退化成「间隙锁」？</p><p>原因就是<code>在唯一索引等值查询并且查询记录不存在的场景下，仅靠间隙锁就能避免幻读</code>的问题。</p><ul><li>为什么 id = 5 记录上的主键索引的锁不可以是 next-key lock？如果是 next-key lock，就意味着其他事务无法删除 id = 5 这条记录，但是这次的案例是查询 id = 2 的记录，只要保证前后两次查询 id = 2 的结果集相同，就能避免幻读的问题了，所以即使 id =5被删除，也不会有什么影响，那就没必须加 next-key lock，因此只需要在 id = 5 加间隙锁，避免其他事务插入 id = 2 的新记录就行了。</li><li>为什么不可以针对不存在的记录加记录锁？锁是加在索引上的，而这个场景下查询的记录是不存在的，自然就没办法锁住这条不存在的记录。</li></ul></blockquote><p><code>唯一索引范围查询</code></p><p>当唯一索引进行范围查询时，会<code>对每一个扫描到的索引加 next-key 锁</code>，然后如果遇到下面这些情况，会退化成记录锁或者间隙锁：</p><ul><li><p>情况一：针对「大于等于」的范围查询，因为存在等值查询的条件，那么如果等值查询的记录是存在于表中，那么该记录的索引中的 next-key 锁会退化成记录锁。</p><p><strong>实验一</strong>：针对「大于」的范围查询的情况</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">begin</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> user </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">15</span><span style="color:#A6ACCD;"> for </span><span style="color:#F78C6C;">update</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><blockquote><p>加锁变化过程如下：</p></blockquote></li></ul><blockquote><p>1.最开始要找的第一行是 id = 20，由于查询该记录不是一个等值查询（不是大于等于条件查询），所以对该主键索引加的是范围为 (15, 20] 的 next-key 锁；</p><p>2.由于是范围查找，就会继续往后找存在的记录，虽然我们看见表中最后一条记录是 id =20 的记录，但是实际在 Innodb 存储引擎中，会用一个特殊的记录来标识最后一条记录，该特殊的记录的名字叫 supremum pseudo-record ，所以扫描第二行的时候，也就扫描到了这个特殊记录的时候，会对该主键索引加的是范围为 (20, +∞] 的 next-key锁。</p><p>3.停止扫描。</p><p>可以得知，事务 在主键索引上加了两个 X 型 的 next-key 锁：</p><ul><li>在 id = 20 这条记录的主键索引上，加了范围为 (15, 20] 的 next-key 锁，意味着其他事务即无法更新或者删除 id = 20 的记录，同时无法插入 id 值为 16、17、18、19 的这一些新记录。</li><li>在特殊记录（ supremum pseudo-record）的主键索引上，加了范围为 (20, +∞] 的next-key 锁，意味着其他事务无法插入 id 值大于 20 的这一些新记录。</li></ul></blockquote><p><strong>实验二</strong>：针对「大于等于」的范围查询的情况。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">begin</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> user </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">15</span><span style="color:#A6ACCD;"> for </span><span style="color:#F78C6C;">update</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><blockquote><p>事务 加锁变化过程如下：</p><p>1.最开始要找的第一行是 id = 15，由于查询该记录是一个等值查询（等于 15），所以该主键索引的 next-key 锁会退化成记录锁，也就是仅锁住 id = 15 这一行记录。</p><p>2.由于是范围查找，就会继续往后找存在的记录，扫描到的第二行是 id = 20，于是对该主键索引加的是范围为 (15, 20] 的 next-key 锁；</p><p>3.接着扫描到第三行的时候，扫描到了特殊记录（ supremum pseudo-record），于是对该主键索引加的是范围为 (20, +∞] 的 next-key 锁。</p><p>4.停止扫描。</p></blockquote><ul><li><p>情况二：针对「小于或者小于等于」的范围查询，要看条件值的记录是否存在于表中：</p><ul><li><p>当条件值的记录不在表中，那么不管是「小于」还是「小于等于」条件的范围查询，扫描到终止范围查询的记录时，该记录的索引的 next-key 锁会退化成间隙锁，其他扫描到的记录，都是在这些记录的索引上加 next-key 锁。</p><p><strong>实验一</strong>：针对「小于」的范围查询时，查询条件值的记录「不存在」表中的情况。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">begin</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> user </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">6</span><span style="color:#A6ACCD;"> for </span><span style="color:#F78C6C;">update</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><blockquote><p>事务 加锁变化过程如下：</p></blockquote></li></ul></li></ul><blockquote><p>1.最开始要找的第一行是 id = 1，于是对该主键索引加的是范围为 (-∞, 1] 的 next-key锁；</p><p>2.由于是范围查找，就会继续往后找存在的记录，扫描到的第二行是 id = 5，所以对该主键索引加的是范围为 (1, 5] 的 next-key 锁；</p><p>3.由于扫描到的第二行记录（id = 5），满足 id &lt; 6 条件，而且也没有达到终止扫描的条件，接着会继续扫描。</p><p>4.扫描到的第三行是 id = 10，该记录不满足 id &lt; 6 条件的记录，所以 id = 10 这一行记录的锁会<code>退化成间隙锁</code>，于是对该主键索引加的是范围为 (5, 10) 的间隙锁。</p><p>5.由于扫描到的第三行记录（id = 10），不满足 id &lt; 6 条件，达到了终止扫描的条件，于是停止扫描</p></blockquote><pre><code>&gt;事务  在主键索引上加了三个 X 型的锁:
</code></pre><blockquote><p>1.在 id = 1 这条记录的主键索引上，加了范围为 (-∞, 1] 的 next-key 锁，意味着其他事务即无法更新或者删除 id = 1 的这一条记录，同时也无法插入 id 小于 1 的这一些新记录</p><p>2.在 id = 5 这条记录的主键索引上，加了范围为 (1, 5] 的 next-key 锁，意味着其他事务即无法更新或者删除 id = 5 的这一条记录，同时也无法插入 id 值为 2、3、4 的这一些新记录。</p><p>3.在 id = 10 这条记录的主键索引上，加了范围为 (5, 10) 的间隙锁，意味着其他事务无法插入 id 值为 6、7、8、9 的这一些新记录。</p></blockquote><ul><li><p>当条件值的记录在表中，如果是「小于」条件的范围查询，扫描到终止范围查询的记录时，该记录的索引的 next-key 锁会退化成间隙锁，其他扫描到的记录，都是在这些记录的索引上加 next-key 锁；如果「小于等于」条件的范围查询，扫描到终止范围查询的记录时，该记录的索引 next-key 锁不会退化成间隙锁。其他扫描到的记录，都是在这些记录的索引上加 next-key 锁</p><p><strong>实验二</strong>：针对「小于等于」的范围查询时，查询条件值的记录「存在」表中的情况。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"></span></code></pre></div></li></ul><p>begin; select * from user where id &lt;= 5 for update; ```</p><pre><code>&gt;事务  加锁变化过程如下：
</code></pre><blockquote><ol><li>最开始要找的第一行是 id = 1，于是对该记录加的是范围为 (-∞, 1] 的 next-key 锁；</li><li>由于是范围查找，就会继续往后找存在的记录，扫描到的第二行是 id = 5，于是对该记录加的是范围为 (1, 5] 的 next-key 锁。</li><li>由于主键索引具有唯一性，不会存在两个 id = 5 的记录，所以不会再继续扫描，于是停止扫描。</li></ol></blockquote><pre><code>**实验三**：再来看针对「小于」的范围查询时，查询条件值的记录「存在」表中的情况。

```sql
</code></pre><p>begin; select * from user where id &lt; 5 for update;</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">&gt;事务 加锁变化过程如下：</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  &gt;1. 最开始要找的第一行是 id = 1，于是对该记录加的是范围为 (-∞, 1] 的 next-key 锁；</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;2. 由于是范围查找，就会继续往后找存在的记录，扫描到的第二行是 id = 5，该记录是第一条不满足 id &lt; 5 条件的记录，于是**该记录的锁会退化为间隙锁，锁范围是(1,5)**。</span></span>
<span class="line"><span style="color:#A6ACCD;">  &gt;3. 由于找到了第一条不满足 id &lt; 5 条件的记录，于是停止扫描。</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">`非唯一索引等值查询`</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">用非唯一索引进行等值查询的时候，因为存在两个索引，一个是主键索引，一个是非唯一索引（二级索引），所以在加锁时，同时会对这两个索引都加锁，但是对主键索引加锁的时候，只有满足查询条件的记录才会对它们的主键索引加锁。</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">针对非唯一索引等值查询时，查询的记录存不存在，加锁的规则也会不同：</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">- 当查询的记录「存在」时，由于不是唯一索引，所以肯定存在索引值相同的记录，于是非唯一索引等值查询的过程是一个扫描的过程，直到扫描到第一个不符合条件的二级索引记录就停止扫描，然后在扫描的过程中，对扫描到的二级索引记录加的是next-key 锁，而对于第一个不符合条件的二级索引记录，该二级索引的 next-key</span></span>
<span class="line"><span style="color:#A6ACCD;">锁会退化成间隙锁。同时，在符合查询条件的记录的主键索引上加记录锁。</span></span>
<span class="line"><span style="color:#A6ACCD;">- 当查询的记录「不存在」时，扫描到第一条不符合条件的二级索引记录，该二级索引的 next-key 锁会退化成间隙锁。因为不存在满足查询条件的记录，所以不会对主键索引加锁。</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">**实验一**：针对非唯一索引等值查询时，查询的值不存在的情况</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">```sql</span></span>
<span class="line"><span style="color:#A6ACCD;"># 假设事务对非唯一索引（age）进行了等值查询，且表中不存在 age = 25 的记录。</span></span>
<span class="line"><span style="color:#A6ACCD;">begin;</span></span>
<span class="line"><span style="color:#A6ACCD;">select * from user where age = 25 for update;</span></span></code></pre></div><blockquote><p>事务 A 加锁变化过程如下： 1.定位到第一条不符合查询条件的二级索引记录，即扫描到 age = 29，于是<strong>该二级索引的 next-key 锁会退化成间隙锁，范围是 (19,29 )</strong>。</p><p>2.停止查询</p></blockquote><blockquote><p>当有一个事务持有二级索引的间隙锁 (19, 29) 时，什么情况下，可以让其他事务的插入age = 19 或者 age = 29 记录的语句成功？又是什么情况下，插入 age = 19 或者 age = 29 记录时的语句会被阻塞？</p><p><strong>插入语句在插入一条记录之前，需要先定位到该记录在 B+树 的位置，如果插入的位置的下一条记录的索引上有间隙锁，才会发生阻塞。</strong></p><p><code>二级索引树是按照二级索引值（age列）按顺序存放的，在相同的二级索引值情况下， 再按主键 id 的顺序存放。知道了这个前提，我们才能知道执行插入语句的时候，插入的位置的下一条记录是谁。</code></p><p>当有一个事务持有二级索引的间隙锁 (19, 29) 时，插入 age = 19 或者 age = 29记录的语句是否可以执行成功，关键还要考虑插入记录的主键值，因为「二级索引值（age列）+主键值（id列）」才可以确定插入的位置，确定了插入位置后，就要<code>看插入的位置的下一条记录是否有间隙锁，如果有间隙锁，就会发生阻塞，如果没有间隙锁，则可以插入成功</code>。</p></blockquote><blockquote><p>LOCK_DATA：29，10 解释:</p><ul><li>LOCK_DATA 第一个数值，也就是 29， 它代表的是 age 值。LOCK_DATA 第一个数值是 next-key 锁和间隙锁锁住的范围的右边界值。</li><li>LOCK_DATA 第二个数值，也就是 10， 它代表的是 id 值。</li></ul><p>之所以 LOCK_DATA 要多显示一个数值（ID值），是因为针对「当某个事务持有非唯一索引的 (19, 29 ) 间隙锁的时候，其他事务是否可以插入 age = 29 新记录」的问题，还需要考虑插入记录的 id 值。而 <code>LOCK_DATA 的第二个数值，就是说明在插入 age = 29 新记录时，哪些范围的 id 值是不可以插入的</code>。</p><p>LOCK_DATA：29，10 + LOCK_MODE : X, GAP 解读:</p><p>事务 在 age = 29 记录的二级索引上（INDEX_NAME: index_age ），加了 age 值范围为 (19, 29) 的 X 型间隙锁，同时<code>针对其他事务插入 age 值为 29 的新记录时，不允许插入的新记录的 id 值小于 10</code>,如果插入的新记录的 id 值大于 20，则可以插入成功。</p></blockquote><p><strong>实验二</strong>：针对非唯一索引等值查询时，查询的值存在的情况。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;"># 假设事务 A 对非唯一索引（age）进行了等值查询，且表中存在 age </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">22</span><span style="color:#A6ACCD;"> 的记录</span></span>
<span class="line"><span style="color:#F78C6C;">begin</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> user </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> age </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">22</span><span style="color:#A6ACCD;"> for </span><span style="color:#F78C6C;">update</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><blockquote><p>事务 加锁变化过程如下：</p><p>1.由于不是唯一索引，所以肯定存在值相同的记录，于是非唯一索引等值查询的过程是一个扫描的过程，最开始要找的第一行是 age = 22，于是对该二级索引记录加上范围为(19, 22] 的 next-key 锁。同时，因为 age = 22 符合查询条件，于是对 age = 22 的记录的主键索引加上记录锁，即对 id = 20 这一行加记录锁。</p><p>2.接着继续扫描，扫描到的第二行是 age = 29，该记录是第一个不符合条件的二级索引记 录，所以该二级索引的 next-key 锁会退化成间隙锁，范围是 (22, 29)。</p><p>3.停止查询。</p></blockquote><blockquote><p>从上图的分析，可以看到，事务 A 对二级索引（INDEX_NAME: index_age ）加了两个 X 型锁</p></blockquote><p><code>非唯一索引范围查询</code></p><p>非唯一索引和主键索引的范围查询的加锁也有所不同，不同之处在于<code>非唯一索引范围查询，索引的 next-key lock 不会有退化为间隙锁和记录锁的情况，也就是非唯一索引进行范围查询时，对二级索引记录加锁都是加 next-key 锁</code>。</p><p><code>没有加索引的查询</code></p><p>如果锁定读查询语句，没有使用索引列作为查询条件，或者查询语句没有走索引查询，导致扫描是全表扫描。那么，<code>每一条记录的索引上都会加 next-key 锁，这样就相当于锁住的全表</code>，这时如果其他事务对该表进行增、删、改操作的时候，都会被阻塞。</p><p>update 和 delete 语句如果查询条件不加索引，那么由于扫描的方式是全表扫描，于是就会对每一条记录的索引上都会加 next-key 锁，这样就相当于锁住的全表。</p><h2 id="分库分表" tabindex="-1">分库分表 <a class="header-anchor" href="#分库分表" aria-label="Permalink to &quot;分库分表&quot;">​</a></h2><blockquote><p>分库分表包括分库和分表两个部分，通常包括：垂直分库、水平分库、垂直分表、水平分表四种方式。</p></blockquote><h4 id="垂直分表" tabindex="-1">垂直分表 <a class="header-anchor" href="#垂直分表" aria-label="Permalink to &quot;垂直分表&quot;">​</a></h4><blockquote><p>定义：将一个表按照字段分成多表，每个表存储其中一部分字段。</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">它带来的提升是：</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">.为了避免IO争抢并减少锁表的几率</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">.充分发挥热门数据的操作效率</span></span>
<span class="line"><span style="color:#A6ACCD;">一般来说，某业务实体中的各个数据项的访问频次是不一样的，部分数据项可能是占用存储空间比较大的BLOB或是TEXT。例如上例中的商品描述。所以，当表数据量很大时，可以将表按字段切开，将热门字段、冷门字段分开放置在不同库中，这些库可以放在不同的存储设备上，避免IO争抢。垂直切分带来的性能提升主要集中在热门数据的操作效率上，而且磁盘争用情况减少。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">通常我们按以下原则进行垂直拆分:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">. 把不常用的字段单独放在一张表;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">. 把text，blob等大字段拆分出来放在附表中;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">. 经常组合查询的列放在一张表中;</span></span></code></pre></div></blockquote><h4 id="垂直分库" tabindex="-1">垂直分库 <a class="header-anchor" href="#垂直分库" aria-label="Permalink to &quot;垂直分库&quot;">​</a></h4><blockquote><p>定义：垂直分库是指按照业务将表进行分类，分布到不同的数据库上面，每个库可以放在不同的服务器上，它的核心理念是专库专用。</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">它带来的提升是：</span></span>
<span class="line"><span style="color:#A6ACCD;">   解决业务层面的耦合，业务清晰</span></span>
<span class="line"><span style="color:#A6ACCD;">   能对不同业务的数据进行分级管理、维护、监控、扩展等</span></span>
<span class="line"><span style="color:#A6ACCD;">   高并发场景下，垂直分库一定程度的提升IO、数据库连接数、降低单机硬件资源的瓶颈</span></span>
<span class="line"><span style="color:#A6ACCD;">垂直分库通过将表按业务分类，然后分布在不同数据库，并且可以将这些数据库部署在不同服务器上，从而达到多个服务器共同分摊压力的效果，但是依然没有解决单表数据量过大的问题</span></span></code></pre></div></blockquote><h4 id="水平分库" tabindex="-1">水平分库 <a class="header-anchor" href="#水平分库" aria-label="Permalink to &quot;水平分库&quot;">​</a></h4><blockquote><p>定义：水平分库是把同一个表的数据按一定规则拆到不同的数据库中，每个库可以放在不同的服务器上</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">它带来的提升是：</span></span>
<span class="line"><span style="color:#A6ACCD;">   解决了单库大数据，高并发的性能瓶颈</span></span>
<span class="line"><span style="color:#A6ACCD;">   提高了系统的稳定性及可用性</span></span>
<span class="line"><span style="color:#A6ACCD;">当一个应用难以再细粒度的垂直切分，或切分后数据量行数巨大，存在单库读写、存储性能瓶颈，这时候就需要进行水平分库了，经过水平切分的优化，往往能解决单库存储量及性能瓶颈。但由于同一个表被分配在不同的数据库，需要额外进行数据操作的路由工作，因此大大提升了系统复杂度</span></span></code></pre></div></blockquote><h4 id="水平分表" tabindex="-1">水平分表 <a class="header-anchor" href="#水平分表" aria-label="Permalink to &quot;水平分表&quot;">​</a></h4><blockquote><p>定义：水平分表是在同一个数据库内，把同一个表的数据按一定规则拆到多个表中。</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">它带来的提升是：</span></span>
<span class="line"><span style="color:#A6ACCD;">优化单一表数据量过大而产生的性能问题</span></span>
<span class="line"><span style="color:#A6ACCD;">避免IO争抢并减少锁表的几率库内的水平分表，解决了单一表数据量过大的问题，分出来的小表中只包含一部分数据，使得单个表的数据量变小，提高检索性能。</span></span></code></pre></div></blockquote><h4 id="sharding-策略" tabindex="-1">Sharding 策略 <a class="header-anchor" href="#sharding-策略" aria-label="Permalink to &quot;Sharding 策略&quot;">​</a></h4><ul><li>哈希取模：hash(key)%N</li><li>范围：可以是 ID 范围也可以是时间范围</li><li>映射表：使用单独的一个数据库来存储映射关系</li></ul><h4 id="分库分表带来的问题" tabindex="-1">分库分表带来的问题 <a class="header-anchor" href="#分库分表带来的问题" aria-label="Permalink to &quot;分库分表带来的问题&quot;">​</a></h4><blockquote><p>事务一致性问题 - 分布式事务解决方案</p><p>跨节点关联查询 - 可以将原来的连接分解成多个单表查询，然后在用户程序中进行连接。</p><p>跨节点分页、排序函数</p><p>主键避重 - 单独设计全局主键，避免跨库主键重复问题</p><ul><li>使用全局唯一 ID （GUID）</li><li>为每个分片指定一个 ID 范围</li><li>分布式 ID 生成器（如 Twitter 的 Snowflake 算法）</li></ul><p>公共表</p></blockquote><h2 id="主从复制" tabindex="-1">主从复制 <a class="header-anchor" href="#主从复制" aria-label="Permalink to &quot;主从复制&quot;">​</a></h2><blockquote><p>主从复制是指将主数据库的DDL和DML操作通过二进制日志传到从数据库上，然后在从数据库上对这些日志进行重新执行，从而使从数据库和主数据库的数据保持一致。</p></blockquote><h4 id="主从复制原理" tabindex="-1">主从复制原理 <a class="header-anchor" href="#主从复制原理" aria-label="Permalink to &quot;主从复制原理&quot;">​</a></h4><blockquote><p>主要涉及三个线程：binlog 线程、I/O 线程和 SQL 线程。</p><ul><li>binlog 线程 ：负责将主服务器上的数据更改写入二进制日志（Binary log）中。</li><li>I/O 线程 ：负责从主服务器上读取- 二进制日志，并写入从服务器的中继日志（Relay log）。</li><li>SQL 线程 ：负责读取中继日志，解析出主服务器已经执行的数据更改并在从服务器中重放（Replay）。</li></ul><p><img src="/assets/image-20220319124728758.a823e6ab.png" alt="image-20220319124728758"></p><ul><li>sql主库在事务提交时会把数据变更作为事件记录在二进制日志Binlog中；</li><li>主库推送二进制日志文件Binlog中的事件到从库的中继日志Relay Log中，之后从库根据中继日志重做数据变更操作，通过逻辑复制来达到主库和从库的数据一致性；</li><li>sql通过三个线程来完成主从库间的数据复制，其中Binlog Dump线程跑在主库上，I/O线程和SQL线程跑着从库上；</li><li>当在从库上启动复制时，首先创建I/O线程连接主库，主库随后创建Binlog Dump线程读取数据库事件并发送给I/O线程，I/O线程获取到事件数据后更新到从库的中继日志Relay Log中去，之后从库上的SQL线程读取中继日志Relay Log中更新的数据库事件并应用，如下图所示。</li></ul><p><img src="/assets/image-20220319130219491.38cf87b8.png" alt="image-20220319130219491"></p></blockquote><h4 id="实例搭建" tabindex="-1">实例搭建 <a class="header-anchor" href="#实例搭建" aria-label="Permalink to &quot;实例搭建&quot;">​</a></h4><h5 id="主实例搭建" tabindex="-1">主实例搭建 <a class="header-anchor" href="#主实例搭建" aria-label="Permalink to &quot;主实例搭建&quot;">​</a></h5><ul><li>运行sql主实例：</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">docker run -p 3307:3306 --name sql-master \</span></span>
<span class="line"><span style="color:#A6ACCD;">-v /mydata/sql-master/log:/var/log/sql \</span></span>
<span class="line"><span style="color:#A6ACCD;">-v /mydata/sql-master/data:/var/lib/sql \</span></span>
<span class="line"><span style="color:#A6ACCD;">-v /mydata/sql-master/conf:/etc/sql \</span></span>
<span class="line"><span style="color:#A6ACCD;">-e sql_ROOT_PASSWORD=root  \</span></span>
<span class="line"><span style="color:#A6ACCD;">-d sql:5.7</span></span></code></pre></div><ul><li>在sql的配置文件夹<code>/mydata/sql-master/conf</code>中创建一个配置文件<code>my.cnf</code>：</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">touch my.cnf</span></span></code></pre></div><ul><li>修改配置文件my.cnf，配置信息如下：</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">[sqld]</span></span>
<span class="line"><span style="color:#A6ACCD;">## 设置server_id，同一局域网中需要唯一</span></span>
<span class="line"><span style="color:#A6ACCD;">server_id=101</span></span>
<span class="line"><span style="color:#A6ACCD;">## 指定不需要同步的数据库名称</span></span>
<span class="line"><span style="color:#A6ACCD;">binlog-ignore-db=sql</span></span>
<span class="line"><span style="color:#A6ACCD;">## 开启二进制日志功能</span></span>
<span class="line"><span style="color:#A6ACCD;">log-bin=mall-sql-bin</span></span>
<span class="line"><span style="color:#A6ACCD;">## 设置二进制日志使用内存大小（事务）</span></span>
<span class="line"><span style="color:#A6ACCD;">binlog_cache_size=1M</span></span>
<span class="line"><span style="color:#A6ACCD;">## 设置使用的二进制日志格式（mixed,statement,row）</span></span>
<span class="line"><span style="color:#A6ACCD;">binlog_format=mixed</span></span>
<span class="line"><span style="color:#A6ACCD;">## 二进制日志过期清理时间。默认值为0，表示不自动清理。</span></span>
<span class="line"><span style="color:#A6ACCD;">expire_logs_days=7</span></span>
<span class="line"><span style="color:#A6ACCD;">## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。</span></span>
<span class="line"><span style="color:#A6ACCD;">## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致</span></span>
<span class="line"><span style="color:#A6ACCD;">slave_skip_errors=1062</span></span></code></pre></div><ul><li>修改完配置后重启实例：</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">docker restart sql-master</span></span></code></pre></div><ul><li>进入<code>sql-master</code>容器中：</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">docker exec -it sql-master /bin/bash</span></span></code></pre></div><ul><li>在容器中使用sql的登录命令连接到客户端：</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">sql -uroot -proot</span></span></code></pre></div><ul><li>创建数据同步用户：</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">CREATE USER &#39;slave&#39;@&#39;%&#39; IDENTIFIED BY &#39;123456&#39;;</span></span>
<span class="line"><span style="color:#A6ACCD;">GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO &#39;slave&#39;@&#39;%&#39;;</span></span></code></pre></div><h5 id="从实例搭建" tabindex="-1">从实例搭建 <a class="header-anchor" href="#从实例搭建" aria-label="Permalink to &quot;从实例搭建&quot;">​</a></h5><ul><li>运行sql从实例：</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">docker run -p 3308:3306 --name sql-slave \</span></span>
<span class="line"><span style="color:#A6ACCD;">-v /mydata/sql-slave/log:/var/log/sql \</span></span>
<span class="line"><span style="color:#A6ACCD;">-v /mydata/sql-slave/data:/var/lib/sql \</span></span>
<span class="line"><span style="color:#A6ACCD;">-v /mydata/sql-slave/conf:/etc/sql \</span></span>
<span class="line"><span style="color:#A6ACCD;">-e sql_ROOT_PASSWORD=root  \</span></span>
<span class="line"><span style="color:#A6ACCD;">-d sql:5.7</span></span></code></pre></div><ul><li>在sql的配置文件夹<code>/mydata/sql-slave/conf</code>中创建一个配置文件<code>my.cnf</code>：</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">touch my.cnf</span></span></code></pre></div><ul><li>修改配置文件my.cnf：</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">[sqld]</span></span>
<span class="line"><span style="color:#A6ACCD;">## 设置server_id，同一局域网中需要唯一</span></span>
<span class="line"><span style="color:#A6ACCD;">server_id=102</span></span>
<span class="line"><span style="color:#A6ACCD;">## 指定不需要同步的数据库名称</span></span>
<span class="line"><span style="color:#A6ACCD;">binlog-ignore-db=sql</span></span>
<span class="line"><span style="color:#A6ACCD;">## 开启二进制日志功能，以备Slave作为其它数据库实例的Master时使用</span></span>
<span class="line"><span style="color:#A6ACCD;">log-bin=mall-sql-slave1-bin</span></span>
<span class="line"><span style="color:#A6ACCD;">## 设置二进制日志使用内存大小（事务）</span></span>
<span class="line"><span style="color:#A6ACCD;">binlog_cache_size=1M</span></span>
<span class="line"><span style="color:#A6ACCD;">## 设置使用的二进制日志格式（mixed,statement,row）</span></span>
<span class="line"><span style="color:#A6ACCD;">binlog_format=mixed</span></span>
<span class="line"><span style="color:#A6ACCD;">## 二进制日志过期清理时间。默认值为0，表示不自动清理。</span></span>
<span class="line"><span style="color:#A6ACCD;">expire_logs_days=7</span></span>
<span class="line"><span style="color:#A6ACCD;">## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。</span></span>
<span class="line"><span style="color:#A6ACCD;">## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致</span></span>
<span class="line"><span style="color:#A6ACCD;">slave_skip_errors=1062</span></span>
<span class="line"><span style="color:#A6ACCD;">## relay_log配置中继日志</span></span>
<span class="line"><span style="color:#A6ACCD;">relay_log=mall-sql-relay-bin</span></span>
<span class="line"><span style="color:#A6ACCD;">## log_slave_updates表示slave将复制事件写进自己的二进制日志</span></span>
<span class="line"><span style="color:#A6ACCD;">log_slave_updates=1</span></span>
<span class="line"><span style="color:#A6ACCD;">## slave设置为只读（具有super权限的用户除外）</span></span>
<span class="line"><span style="color:#A6ACCD;">read_only=1</span></span></code></pre></div><ul><li>修改完配置后重启实例：</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">docker restart sql-slave</span></span></code></pre></div><h5 id="主从连接" tabindex="-1">主从连接 <a class="header-anchor" href="#主从连接" aria-label="Permalink to &quot;主从连接&quot;">​</a></h5><ul><li>连接到主数据库的sql客户端，查看主数据库状态：</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">show master status;</span></span></code></pre></div><ul><li>主数据库状态显示如下：</li></ul><p><img src="/assets/640.5de5b79c.png" alt="图片"></p><ul><li>进入<code>sql-slave</code>容器中：</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">docker exec -it sql-slave /bin/bash</span></span></code></pre></div><ul><li>在容器中使用sql的登录命令连接到客户端：</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">sql -uroot -proot</span></span></code></pre></div><ul><li>在从数据库中配置主从复制：</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">change master to master_host=&#39;192.168.6.132&#39;, master_user=&#39;slave&#39;, master_password=&#39;123456&#39;, master_port=3307, master_log_file=&#39;mall-sql-bin.000001&#39;, master_log_pos=617, master_connect_retry=30;</span></span></code></pre></div><ul><li><p>主从复制命令参数说明：</p></li><li><ul><li>master_host：主数据库的IP地址；</li><li>master_port：主数据库的运行端口；</li><li>master_user：在主数据库创建的用于同步数据的用户账号；</li><li>master_password：在主数据库创建的用于同步数据的用户密码；</li><li>master_log_file：指定从数据库要复制数据的日志文件，通过查看主数据的状态，获取File参数；</li><li>master_log_pos：指定从数据库从哪个位置开始复制数据，通过查看主数据的状态，获取Position参数；</li><li>master_connect_retry：连接失败重试的时间间隔，单位为秒。</li></ul></li><li><p>查看主从同步状态：</p></li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">show slave status \G;</span></span></code></pre></div><p><img src="/assets/640-16476663411963.ef5c7301.jpeg" alt="图片"></p><ul><li>开启主从同步：</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">start slave;</span></span></code></pre></div><ul><li>查看从数据库状态发现已经同步：</li></ul><p><img src="/assets/640-16476663546765.c54bab87.png" alt="图片"></p><h5 id="主从复制测试" tabindex="-1">主从复制测试 <a class="header-anchor" href="#主从复制测试" aria-label="Permalink to &quot;主从复制测试&quot;">​</a></h5><blockquote><p>主从复制的测试方法有很多，可以在主实例中创建一个数据库，看看从实例中是否有该数据库，如果有，表示主从复制已经搭建成功。</p></blockquote><h2 id="读写分离" tabindex="-1">读写分离 <a class="header-anchor" href="#读写分离" aria-label="Permalink to &quot;读写分离&quot;">​</a></h2><p>主服务器处理写操作以及实时性要求比较高的读操作，而从服务器处理读操作。</p><p>读写分离能提高性能的原因在于：</p><ul><li>主从服务器负责各自的读和写，极大程度缓解了锁的争用；</li><li>从服务器可以使用 MyISAM，提升查询性能以及节约系统开销；</li><li>增加冗余，提高可用性。</li></ul><p>读写分离常用代理方式来实现，代理服务器接收应用层传来的读写请求，然后决定转发到哪个服务器。</p><p><img src="/assets/image-20220319124748987.e263302e.png" alt="image-20220319124748987"></p><h2 id="常见参数" tabindex="-1">常见参数 <a class="header-anchor" href="#常见参数" aria-label="Permalink to &quot;常见参数&quot;">​</a></h2><h4 id="连接数" tabindex="-1">连接数 <a class="header-anchor" href="#连接数" aria-label="Permalink to &quot;连接数&quot;">​</a></h4><blockquote><p><strong>最大连接数设置</strong>：</p><p>Max_used_connections / max_connections * 100% ≈ 85% 最大连接数占上限连接数的85%左右，如果发现比例在10%以下，sql服务器连接数上限设置的过高了。</p></blockquote><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">-- sql最大连接数</span></span>
<span class="line"><span style="color:#A6ACCD;">sql&gt; show variables like &#39;max_connections&#39;; </span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">-- 服务器响应的最大连接数</span></span>
<span class="line"><span style="color:#A6ACCD;">sql&gt; show global status like ‘Max_used_connections’;</span></span></code></pre></div><h4 id="临时表" tabindex="-1">临时表 <a class="header-anchor" href="#临时表" aria-label="Permalink to &quot;临时表&quot;">​</a></h4><blockquote><p>每次创建临时表，Created_tmp_tables增加</p><p>如果是在磁盘上创建临时表，Created_tmp_disk_tables也增加【Created_tmp_files表示sql服务创建的临时文件文件数】</p><p>比较理想的配置是： 　　Created_tmp_disk_tables / Created_tmp_tables * 100% &lt;= 25%</p></blockquote><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">-- 查询临时表</span></span>
<span class="line"><span style="color:#A6ACCD;">sql&gt; show global status like &#39;created_tmp%&#39;; </span></span>
<span class="line"><span style="color:#A6ACCD;">　　+-------------------------+---------+ </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| Variable_name | Value | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　+-------------------------+---------+ </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| Created_tmp_disk_tables | 21197 | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| Created_tmp_files | 58 | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| Created_tmp_tables | 1771587 | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　+-------------------------+---------+　　</span></span>
<span class="line"><span style="color:#A6ACCD;">　　</span></span>
<span class="line"><span style="color:#A6ACCD;">-- 只有256MB以下的临时表才能全部放内存，超过的就会用到硬盘临时表。</span></span>
<span class="line"><span style="color:#A6ACCD;">sql&gt; show variables where Variable_name in (&#39;tmp_table_size&#39;, &#39;max_heap_table_size&#39;); </span></span>
<span class="line"><span style="color:#A6ACCD;">　　+---------------------+-----------+ </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| Variable_name | Value | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　+---------------------+-----------+ </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| max_heap_table_size | 268435456 | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| tmp_table_size | 536870912 | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　+---------------------+-----------+</span></span></code></pre></div><h4 id="表锁-1" tabindex="-1">表锁 <a class="header-anchor" href="#表锁-1" aria-label="Permalink to &quot;表锁&quot;">​</a></h4><blockquote><p>Table_locks_immediate表示立即释放表锁数</p><p>Table_locks_waited表示需要等待的表锁数，</p><p>如果Table_locks_immediate / Table_locks_waited &gt; 5000，最好采用InnoDB引擎，因为InnoDB是行锁</p></blockquote><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">-- 查询表锁情况</span></span>
<span class="line"><span style="color:#A6ACCD;">sql&gt; show global status like &#39;table_locks%&#39;; </span></span>
<span class="line"><span style="color:#A6ACCD;">　　+-----------------------+-----------+ </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| Variable_name | Value | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　+-----------------------+-----------+ </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| Table_locks_immediate | 490206328 | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| Table_locks_waited | 2084912 | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　+-----------------------+-----------+</span></span></code></pre></div><h4 id="表扫描" tabindex="-1">表扫描 <a class="header-anchor" href="#表扫描" aria-label="Permalink to &quot;表扫描&quot;">​</a></h4><blockquote><p>计算表扫描率： 　　表扫描率 = Handler_read_rnd_next / Com_select 如果表扫描率超过4000，说明进行了太多表扫描，很有可能索引没有建好，增加read_buffer_size值(max=8MB)</p></blockquote><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">sql&gt; show global status like &#39;handler_read%&#39;; 、</span></span>
<span class="line"><span style="color:#A6ACCD;">　　+-----------------------+-------------+ </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| Variable_name | Value | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　+-----------------------+-------------+ </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| Handler_read_first | 5803750 | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| Handler_read_key | 6049319850 | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| Handler_read_next | 94440908210 | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| Handler_read_prev | 34822001724 | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| Handler_read_rnd | 405482605 | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| Handler_read_rnd_next | 18912877839 | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　+-----------------------+-------------+　　</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">-- 服务器完成的查询请求次数</span></span>
<span class="line"><span style="color:#A6ACCD;">sql&gt; show global status like &#39;com_select&#39;; </span></span>
<span class="line"><span style="color:#A6ACCD;">　　+---------------+-----------+ </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| Variable_name | Value | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　+---------------+-----------+ </span></span>
<span class="line"><span style="color:#A6ACCD;">　　| Com_select | 222693559 | </span></span>
<span class="line"><span style="color:#A6ACCD;">　　+---------------+-----------+</span></span></code></pre></div><h2 id="使用篇" tabindex="-1">使用篇 <a class="header-anchor" href="#使用篇" aria-label="Permalink to &quot;使用篇&quot;">​</a></h2><h3 id="基本操作" tabindex="-1">基本操作 <a class="header-anchor" href="#基本操作" aria-label="Permalink to &quot;基本操作&quot;">​</a></h3><h4 id="数据库操作" tabindex="-1">数据库操作 <a class="header-anchor" href="#数据库操作" aria-label="Permalink to &quot;数据库操作&quot;">​</a></h4><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 创建数据库</span></span>
<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">DATABASE</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">not</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">exists</span><span style="color:#A6ACCD;"> 数据库名 </span><span style="color:#C792EA;">default</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">character</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">utf8</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><h4 id="表操作" tabindex="-1">表操作 <a class="header-anchor" href="#表操作" aria-label="Permalink to &quot;表操作&quot;">​</a></h4><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 查看建表语句</span></span>
<span class="line"><span style="color:#A6ACCD;">show </span><span style="color:#F78C6C;">create</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">table</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> 表名</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 查看表详情</span></span>
<span class="line"><span style="color:#F78C6C;">desc</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> 表名</span></span></code></pre></div><h5 id="表查询" tabindex="-1">表查询 <a class="header-anchor" href="#表查询" aria-label="Permalink to &quot;表查询&quot;">​</a></h5><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span></span>
<span class="line"><span style="color:#A6ACCD;">[DISTINCT] </span></span>
<span class="line"><span style="color:#A6ACCD;">字段</span></span>
<span class="line"><span style="color:#F78C6C;">from</span></span>
<span class="line"><span style="color:#A6ACCD;">表1 </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> 别名1</span></span>
<span class="line"><span style="color:#A6ACCD;">[left|right|inner join 表2 on xx=xx]</span></span>
<span class="line"><span style="color:#F78C6C;">where</span></span>
<span class="line"><span style="color:#A6ACCD;">条件</span></span>
<span class="line"><span style="color:#F78C6C;">group by</span></span>
<span class="line"><span style="color:#A6ACCD;">分组字段</span></span>
<span class="line"><span style="color:#F78C6C;">having</span></span>
<span class="line"><span style="color:#A6ACCD;">分组条件</span></span>
<span class="line"><span style="color:#F78C6C;">order by</span></span>
<span class="line"><span style="color:#A6ACCD;">字段 </span><span style="color:#F78C6C;">asc</span><span style="color:#A6ACCD;">|</span><span style="color:#F78C6C;">desc</span></span>
<span class="line"><span style="color:#F78C6C;">limit</span></span>
<span class="line"><span style="color:#A6ACCD;">(currentPage</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">pageSzie,pageSzie</span></span></code></pre></div><blockquote><p>limit beginIndex,pageSize 详解</p></blockquote><p>beginIndex:表示从第多少条数据开始 pageSize:表示每页显示的数据条数</p><p>beginIndex=(当前页数-1)*pageSize</p><h4 id="数据操作" tabindex="-1">数据操作 <a class="header-anchor" href="#数据操作" aria-label="Permalink to &quot;数据操作&quot;">​</a></h4><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 插入单条数据</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> 表名(字段1,字段2..) </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;">(值1,值2..);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 插入多条数据</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> 表名(字段1,字段2) </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;">(值1,值2),(值1,值2);   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 针对全表所有字段进行插入操作</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> 表名 </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;">(值1,值2);  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 查询结果插入</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> 表名(字段) </span><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> 字段 </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> 表2;   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 查询结果，全表插入</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> 表名 </span><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> 字段 </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> 表2;      </span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 带条件修改指定数据，否则修改全表</span></span>
<span class="line"><span style="color:#F78C6C;">update</span><span style="color:#A6ACCD;"> 表 </span><span style="color:#F78C6C;">set</span><span style="color:#A6ACCD;"> 字段</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">值 </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> 条件;  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 删除数据带条件指定数据，否则删除全表数据</span></span>
<span class="line"><span style="color:#F78C6C;">delete</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> 表 </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> 条件;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 完全清空表数据</span></span>
<span class="line"><span style="color:#F78C6C;">TRUNCATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> 表名;</span></span></code></pre></div><h4 id="索引操作" tabindex="-1">索引操作 <a class="header-anchor" href="#索引操作" aria-label="Permalink to &quot;索引操作&quot;">​</a></h4><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 创建索引</span></span>
<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">INDEX</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">索引名称</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> 表名 (列名)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 删除索引</span></span>
<span class="line"><span style="color:#F78C6C;">DROP</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">INDEX</span><span style="color:#A6ACCD;"> 索引名 </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> 表名</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 修改索引</span></span>
<span class="line"><span style="color:#F78C6C;">ALTER</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> 表名 </span><span style="color:#F78C6C;">DROP</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">INDEX</span><span style="color:#A6ACCD;"> 索引名</span></span></code></pre></div><p><code>普通索引</code></p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">ALTER</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">table_name</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">ADD</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">INDEX</span><span style="color:#A6ACCD;"> index_name ( </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">column</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> )</span></span></code></pre></div><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">ALTER</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">table_name</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">ADD</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">INDEX</span><span style="color:#A6ACCD;"> index_name ( </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">column1</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">column2</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">column3</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> )</span></span></code></pre></div><p><code>主键索引</code></p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">ALTER</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">table_name</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">ADD</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;"> ( </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">column</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> )</span></span></code></pre></div><p><code>唯一索引</code></p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">ALTER</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">table_name</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">ADD</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">UNIQUE</span><span style="color:#A6ACCD;"> ( </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">column</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> )</span></span></code></pre></div><p><code>全文索引</code></p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">ALTER</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">table_name</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">ADD</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FULLTEXT</span><span style="color:#A6ACCD;"> ( </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">column</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><h4 id="函数操作" tabindex="-1">函数操作 <a class="header-anchor" href="#函数操作" aria-label="Permalink to &quot;函数操作&quot;">​</a></h4><h5 id="聚合函数" tabindex="-1">聚合函数 <a class="header-anchor" href="#聚合函数" aria-label="Permalink to &quot;聚合函数&quot;">​</a></h5><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">max 				</span><span style="color:#676E95;font-style:italic;">-- 最大值</span></span>
<span class="line"><span style="color:#A6ACCD;">min 				</span><span style="color:#676E95;font-style:italic;">-- 最小值</span></span>
<span class="line"><span style="color:#A6ACCD;">sum 				</span><span style="color:#676E95;font-style:italic;">-- 求和</span></span>
<span class="line"><span style="color:#A6ACCD;">avg 				</span><span style="color:#676E95;font-style:italic;">-- 平均值</span></span>
<span class="line"><span style="color:#A6ACCD;">count 				</span><span style="color:#676E95;font-style:italic;">-- 记录个数(若统计的是列，列中为Null，那么count将不会计算值)</span></span>
<span class="line"><span style="color:#A6ACCD;">ABS 				</span><span style="color:#676E95;font-style:italic;">-- 绝对值</span></span>
<span class="line"><span style="color:#82AAFF;">CEILING</span><span style="color:#A6ACCD;">() </span><span style="color:#82AAFF;">FLOOR</span><span style="color:#A6ACCD;">() 	</span><span style="color:#676E95;font-style:italic;">-- 向上取整 向下取整</span></span>
<span class="line"><span style="color:#82AAFF;">RAND</span><span style="color:#A6ACCD;">() 				</span><span style="color:#676E95;font-style:italic;">-- 返回0~1之间的随机数</span></span>
<span class="line"><span style="color:#82AAFF;">SIGN</span><span style="color:#A6ACCD;">() 				</span><span style="color:#676E95;font-style:italic;">-- 判断一个数的符号位。负数返回-1，正数返回1</span></span></code></pre></div><h5 id="数据函数" tabindex="-1">数据函数 <a class="header-anchor" href="#数据函数" aria-label="Permalink to &quot;数据函数&quot;">​</a></h5><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#82AAFF;">abs</span><span style="color:#A6ACCD;">(x) 			</span><span style="color:#676E95;font-style:italic;">-- 绝对值 abs(-10.9) = 10</span></span>
<span class="line"><span style="color:#82AAFF;">format</span><span style="color:#A6ACCD;">(x, d) 	</span><span style="color:#676E95;font-style:italic;">-- 格式化千分位数值 format(1234567.456, 2) =1,234,567.46</span></span>
<span class="line"><span style="color:#A6ACCD;">ceil(x) 		</span><span style="color:#676E95;font-style:italic;">-- 向上取整 ceil(10.1) = 11</span></span>
<span class="line"><span style="color:#82AAFF;">floor</span><span style="color:#A6ACCD;">(x) 		</span><span style="color:#676E95;font-style:italic;">-- 向下取整 floor (10.1) = 10</span></span>
<span class="line"><span style="color:#82AAFF;">round</span><span style="color:#A6ACCD;">(x) 		</span><span style="color:#676E95;font-style:italic;">-- 四舍五入去整</span></span>
<span class="line"><span style="color:#A6ACCD;">mod(m, n) 		</span><span style="color:#676E95;font-style:italic;">-- m%n m mod n 求余 10%3=1</span></span>
<span class="line"><span style="color:#82AAFF;">pi</span><span style="color:#A6ACCD;">() 			</span><span style="color:#676E95;font-style:italic;">-- 获得圆周率</span></span>
<span class="line"><span style="color:#A6ACCD;">pow(m, n) 		</span><span style="color:#676E95;font-style:italic;">-- m^n</span></span>
<span class="line"><span style="color:#82AAFF;">sqrt</span><span style="color:#A6ACCD;">(x) 		</span><span style="color:#676E95;font-style:italic;">-- 算术平方根</span></span>
<span class="line"><span style="color:#82AAFF;">rand</span><span style="color:#A6ACCD;">() 			</span><span style="color:#676E95;font-style:italic;">-- 随机数</span></span>
<span class="line"><span style="color:#F78C6C;">truncate</span><span style="color:#A6ACCD;">(x, d) 	</span><span style="color:#676E95;font-style:italic;">-- 截取d位小数</span></span></code></pre></div><h5 id="字符串函数" tabindex="-1">字符串函数 <a class="header-anchor" href="#字符串函数" aria-label="Permalink to &quot;字符串函数&quot;">​</a></h5><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">length</span><span style="color:#A6ACCD;">(string) 							</span><span style="color:#676E95;font-style:italic;">-- string长度，字节</span></span>
<span class="line"><span style="color:#A6ACCD;">char_length(string) 					</span><span style="color:#676E95;font-style:italic;">-- string的字符个数</span></span>
<span class="line"><span style="color:#82AAFF;">substring</span><span style="color:#A6ACCD;">(str, position [,length]) 		</span><span style="color:#676E95;font-style:italic;">-- 从str的position开始,取length个字符</span></span>
<span class="line"><span style="color:#82AAFF;">replace</span><span style="color:#A6ACCD;">(str ,search_str ,replace_str) 	</span><span style="color:#676E95;font-style:italic;">-- 在str中用replace_str替换search_str</span></span>
<span class="line"><span style="color:#A6ACCD;">instr(string ,substring) 				</span><span style="color:#676E95;font-style:italic;">-- 返回substring首次在string中出现的位置</span></span>
<span class="line"><span style="color:#82AAFF;">concat</span><span style="color:#A6ACCD;">(string [,...]) 					</span><span style="color:#676E95;font-style:italic;">-- 连接字串</span></span>
<span class="line"><span style="color:#A6ACCD;">charset(str) 							</span><span style="color:#676E95;font-style:italic;">-- 返回字串字符集</span></span>
<span class="line"><span style="color:#A6ACCD;">lcase(string) 							</span><span style="color:#676E95;font-style:italic;">-- 转换成小写</span></span>
<span class="line"><span style="color:#82AAFF;">left</span><span style="color:#A6ACCD;">(string, </span><span style="color:#F78C6C;">length</span><span style="color:#A6ACCD;">) 					</span><span style="color:#676E95;font-style:italic;">-- 从string2中的左边起取length个字符</span></span>
<span class="line"><span style="color:#A6ACCD;">load_file(file_name) 					</span><span style="color:#676E95;font-style:italic;">-- 从文件读取内容</span></span>
<span class="line"><span style="color:#F78C6C;">locate</span><span style="color:#A6ACCD;">(substring, string [,start_position]) 	</span><span style="color:#676E95;font-style:italic;">-- 同instr,但可指定开始位置</span></span>
<span class="line"><span style="color:#A6ACCD;">lpad(string, </span><span style="color:#F78C6C;">length</span><span style="color:#A6ACCD;">, pad) 				</span><span style="color:#676E95;font-style:italic;">-- 重复用pad加在string开头,直到字串长度为length</span></span>
<span class="line"><span style="color:#82AAFF;">ltrim</span><span style="color:#A6ACCD;">(string) 							</span><span style="color:#676E95;font-style:italic;">-- 去除前面空格</span></span>
<span class="line"><span style="color:#F78C6C;">repeat</span><span style="color:#A6ACCD;">(string, count) 					</span><span style="color:#676E95;font-style:italic;">-- 重复count次</span></span>
<span class="line"><span style="color:#A6ACCD;">rpad(string, </span><span style="color:#F78C6C;">length</span><span style="color:#A6ACCD;">, pad) 				</span><span style="color:#676E95;font-style:italic;">-- 在str后用pad补充,直到长度为length</span></span>
<span class="line"><span style="color:#82AAFF;">rtrim</span><span style="color:#A6ACCD;">(string) 							</span><span style="color:#676E95;font-style:italic;">-- 去除后端空格</span></span>
<span class="line"><span style="color:#A6ACCD;">strcmp(string1 ,string2) 				</span><span style="color:#676E95;font-style:italic;">-- 逐字符比较两字串大小</span></span></code></pre></div><h5 id="时间函数" tabindex="-1">时间函数 <a class="header-anchor" href="#时间函数" aria-label="Permalink to &quot;时间函数&quot;">​</a></h5><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> CURRENT_DATE</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">;  	</span><span style="color:#676E95;font-style:italic;">/*获取当前日期*/</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> CURDATE</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">;  			</span><span style="color:#676E95;font-style:italic;">/*获取当前日期*/</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NOW</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">;  				</span><span style="color:#676E95;font-style:italic;">/*获取当前日期和时间*/</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> LOCALTIME</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">;  		</span><span style="color:#676E95;font-style:italic;">/*获取当前日期和时间*/</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">SYSDATE</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">;  			</span><span style="color:#676E95;font-style:italic;">/*获取当前日期和时间*/</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 获取年月日,时分秒</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">YEAR</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">NOW</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MONTH</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">NOW</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">DAY</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">NOW</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">HOUR</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">NOW</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">MINUTE</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">NOW</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">SECOND</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">NOW</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 时间日期函数</span></span>
<span class="line"><span style="color:#F78C6C;">now</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">, </span><span style="color:#82AAFF;">current_timestamp</span><span style="color:#A6ACCD;">();   	</span><span style="color:#676E95;font-style:italic;">-- 当前日期时间</span></span>
<span class="line"><span style="color:#A6ACCD;">current_date</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">;          		</span><span style="color:#676E95;font-style:italic;">-- 当前日期</span></span>
<span class="line"><span style="color:#82AAFF;">current_time</span><span style="color:#A6ACCD;">();          		</span><span style="color:#676E95;font-style:italic;">-- 当前时间</span></span>
<span class="line"><span style="color:#C792EA;">date</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">yyyy-mm-dd hh:ii:ss</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);  	</span><span style="color:#676E95;font-style:italic;">-- 获取日期部分</span></span>
<span class="line"><span style="color:#C792EA;">time</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">yyyy-mm-dd hh:ii:ss</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);  	</span><span style="color:#676E95;font-style:italic;">-- 获取时间部分</span></span>
<span class="line"><span style="color:#F78C6C;">date_format</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">yyyy-mm-dd hh:ii:ss</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">%d %y %a %d %m %b %j</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);  </span><span style="color:#676E95;font-style:italic;">-- 格式化时间</span></span>
<span class="line"><span style="color:#A6ACCD;">unix_timestamp</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">;        		</span><span style="color:#676E95;font-style:italic;">-- 获得unix时间戳</span></span>
<span class="line"><span style="color:#A6ACCD;">from_unixtime</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">;        		</span><span style="color:#676E95;font-style:italic;">-- 从时间戳获得时间</span></span></code></pre></div><h5 id="排名函数" tabindex="-1">排名函数 <a class="header-anchor" href="#排名函数" aria-label="Permalink to &quot;排名函数&quot;">​</a></h5><blockquote><p>row_number()：依次递增排名，无重复排名 rank()：相同分数有重复排名，但是重复后下一个人按照实际排名 dense_rank()：分数一致排名一致，分数不一致排名+1 ntile(4)：分组排名，里面的数字是几，最多排名就是几，里面的数字是4，最多的排名就是4</p><p><img src="/assets/v2-274cb8b4951cae34bf85839de252e008_720w.ecb536e3.jpg" alt="img"></p></blockquote><h6 id="row-number" tabindex="-1">row_number() <a class="header-anchor" href="#row-number" aria-label="Permalink to &quot;row_number()&quot;">​</a></h6><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">,</span><span style="color:#82AAFF;">row_number</span><span style="color:#A6ACCD;">() </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">order by</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">number</span><span style="color:#A6ACCD;"> ) </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> row_num </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> num</span></span></code></pre></div><blockquote><p>注意：在使用row_number() 实现分页时需要特别注意一点，over子句中的order by 要与SQL排序记录中的order by保持一致，否则得到的序号可能不是连续</p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 错误例子</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">,</span><span style="color:#82AAFF;">row_number</span><span style="color:#A6ACCD;">() </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">order by</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">number</span><span style="color:#A6ACCD;"> ) </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> row_num </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> num </span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> id</span></span></code></pre></div><h6 id="rank" tabindex="-1">rank() <a class="header-anchor" href="#rank" aria-label="Permalink to &quot;rank()&quot;">​</a></h6><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">,</span><span style="color:#82AAFF;">rank</span><span style="color:#A6ACCD;">() </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">order by</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">number</span><span style="color:#A6ACCD;"> ) </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> row_num </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> num</span></span></code></pre></div><h6 id="dense-rank" tabindex="-1">dense_rank() <a class="header-anchor" href="#dense-rank" aria-label="Permalink to &quot;dense_rank()&quot;">​</a></h6><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">,</span><span style="color:#82AAFF;">dense_rank</span><span style="color:#A6ACCD;">() </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">order by</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">number</span><span style="color:#A6ACCD;"> ) </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> row_num </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> num</span></span></code></pre></div><h6 id="ntile" tabindex="-1">ntile() <a class="header-anchor" href="#ntile" aria-label="Permalink to &quot;ntile()&quot;">​</a></h6><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- Ntile(group_num) 将所有记录分成group_num个组，每组序号一样</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">,</span><span style="color:#82AAFF;">ntile</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">order by</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">number</span><span style="color:#A6ACCD;"> ) </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> row_num </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> num</span></span></code></pre></div><h3 id="进阶操作" tabindex="-1">进阶操作 <a class="header-anchor" href="#进阶操作" aria-label="Permalink to &quot;进阶操作&quot;">​</a></h3><blockquote><p>慢查询</p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 查看是否开启慢查询日志</span></span>
<span class="line"><span style="color:#F78C6C;">sql</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> show variables </span><span style="color:#F78C6C;">like</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">slow_query_log</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 设置慢查询日志的位置</span></span>
<span class="line"><span style="color:#F78C6C;">sql</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">global</span><span style="color:#A6ACCD;"> slow_query_log_file</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;"> /usr/share/sql/sql_log/sql-slow.log</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 开启慢查询日志</span></span>
<span class="line"><span style="color:#F78C6C;">sql</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">global</span><span style="color:#A6ACCD;"> log_queries_not_using_indexes</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">on</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 设置大于1秒钟的数据记录到慢日志</span></span>
<span class="line"><span style="color:#F78C6C;">sql</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">global</span><span style="color:#A6ACCD;"> long_query_time</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><blockquote><p>group_concat</p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">name</span><span style="color:#A6ACCD;">,group_concat(code) </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">user</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">group by</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">name</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><p><img src="/assets/image-20230519141703990.a709be74.png" alt="image-20230519141703990"></p><p>使用<code>group_concat</code>函数，可以轻松的把分组后name相同的数据拼接到一起，组成一个字符串，用<code>逗号</code>分隔。</p><blockquote><p>如何不批量插入重复数据?</p></blockquote><p><code>insert ignore into</code></p><p>当插入数据时，如出现错误时，如重复数据，将不返回错误，只以警告形式返回。所以使用ignore请确保语句本身没有问题，否则也会被忽略掉。</p><p>这种方法很简便，但是有一种可能，就是插入不是因为重复数据报错，而是因为其他原因报错的，也同样被忽略了</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">INSERT IGNORE INTO</span><span style="color:#A6ACCD;"> user (</span><span style="color:#F78C6C;">name</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">VALUES</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">telami</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p><code>on duplicate key update[建议]</code></p><p>当primary或者unique重复时，则执行update语句，如update后为无用语句，如id=id，则同1功能相同，但错误不会被忽略掉。</p><p>这种方法有个前提条件,需要插入的约束，是主键或者唯一约束（在你的业务中那个要作为唯一的判断就将那个字段设置为唯一约束也就是unique key）。</p><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">//mobile_number有唯一约束</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">insert</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">id</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">batchSaveUser</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">parameterType</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">list</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">insert into user (id,username,mobile_number)</span></span>
<span class="line"><span style="color:#A6ACCD;">values</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">foreach</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">collection</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">list</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">item</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">item</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">index</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">index</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">separator</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">#{item.id},</span></span>
<span class="line"><span style="color:#A6ACCD;">#{item.username},</span></span>
<span class="line"><span style="color:#A6ACCD;">#{item.mobileNumber}</span></span>
<span class="line"><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">foreach</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">ON duplicate KEY UPDATE id = id</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">insert</span><span style="color:#89DDFF;">&gt;</span></span></code></pre></div><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">INSERT INTO</span><span style="color:#A6ACCD;"> user (</span><span style="color:#F78C6C;">name</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">VALUES</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">telami</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> duplicate </span><span style="color:#F78C6C;">KEY</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> id</span></span></code></pre></div><p><code>insert … select … where not exist</code></p><p>根据select的条件判断是否插入，可以不光通过primary 和unique来判断，也可通过其它条件；</p><p>这种方法其实就是使用了sql的一个临时表的方式，但是里面使用到了子查询，效率受影响。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">INSERT INTO</span><span style="color:#A6ACCD;"> user (</span><span style="color:#F78C6C;">name</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">telami</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> dual </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NOT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> id </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> user </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p><code>replace into</code></p><p>如果存在primary or unique相同的记录，则先删除掉。再插入新记录。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">REPLACE </span><span style="color:#F78C6C;">INTO</span><span style="color:#A6ACCD;"> user </span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">telami</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> books</span></span></code></pre></div><blockquote><p>通过unsigned强制修改主键字段</p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 当主键无法修改时 加上 unsigned 标记</span></span>
<span class="line"><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) unsigned </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> AUTO_INCREMENT COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">主键</span><span style="color:#89DDFF;">&#39;</span></span></code></pre></div><blockquote><p>sql查询日期格式化</p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span></span>
<span class="line"><span style="color:#A6ACCD;">order_title</span></span>
<span class="line"><span style="color:#F78C6C;">WHERE</span></span>
<span class="line"><span style="color:#F78C6C;">DATE_FORMAT</span><span style="color:#A6ACCD;">(create_date,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">%Y-%m</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">in</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2021-01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2021-02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2021-03</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><blockquote><p>子查询减少回表SQL优化</p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 待优化SQL</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> 各种字段</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">table_name</span><span style="color:#89DDFF;">`</span></span>
<span class="line"><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> 各种条件</span></span>
<span class="line"><span style="color:#F78C6C;">LIMIT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 优化后SQL</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> 各种字段</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">table_name</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> main_tale</span></span>
<span class="line"><span style="color:#F78C6C;">RIGHT JOIN</span><span style="color:#A6ACCD;">(</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;">  子查询只查主键</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">table_name</span><span style="color:#89DDFF;">`</span></span>
<span class="line"><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> 各种条件</span></span>
<span class="line"><span style="color:#F78C6C;">LIMIT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">) temp_table </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> temp_table.主键 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> main_table.主键</span></span></code></pre></div><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 示例</span></span>
<span class="line"><span style="color:#A6ACCD;">#原SQL</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> test_user </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> age</span><span style="color:#89DDFF;">&gt;</span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">LIMIT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100000</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">#优化后SQL</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> test_user t0</span></span>
<span class="line"><span style="color:#F78C6C;">RIGHT JOIN</span><span style="color:#A6ACCD;">(</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> user_id</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> test_user</span></span>
<span class="line"><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> age</span><span style="color:#89DDFF;">&gt;</span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">LIMIT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100000</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">10</span></span>
<span class="line"><span style="color:#A6ACCD;">) t1 </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> t1.user_id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> t0.user_id;</span></span></code></pre></div><blockquote><p>select 1进行SQL查找是否&quot;存在&quot;</p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">table</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> a </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">AND</span><span style="color:#A6ACCD;"> b </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">LIMIT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span></code></pre></div><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// java写法:  </span></span>
<span class="line"><span style="color:#C792EA;">Integer</span><span style="color:#A6ACCD;"> exist </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> xxDao</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">existXxxxByXxx</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">params</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;"> exist </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> NULL </span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//当存在时，执行这里的代码  </span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//当不存在时，执行这里	的代码  </span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><blockquote><p>MySql 5.7 解锁超时的事务</p></blockquote><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">1、查询是否锁表 </span></span>
<span class="line"><span style="color:#A6ACCD;">	show OPEN TABLES where In_use &gt; 0; </span></span>
<span class="line"><span style="color:#A6ACCD;">2、查询进程 </span></span>
<span class="line"><span style="color:#A6ACCD;">	show processlist </span></span>
<span class="line"><span style="color:#A6ACCD;">3、查询到相对应的进程id</span></span>
<span class="line"><span style="color:#A6ACCD;">	kill id </span></span>
<span class="line"><span style="color:#A6ACCD;">补充： </span></span>
<span class="line"><span style="color:#A6ACCD;">查看正在锁的事务 </span></span>
<span class="line"><span style="color:#A6ACCD;">	SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCKS;  </span></span>
<span class="line"><span style="color:#A6ACCD;">查看等待锁的事务 </span></span>
<span class="line"><span style="color:#A6ACCD;">	SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS; </span></span>
<span class="line"><span style="color:#A6ACCD;">	SELECT * from information_schema.INNODB_TRX </span></span>
<span class="line"><span style="color:#A6ACCD;">	kill trx_sql_thread_id</span></span></code></pre></div><blockquote><p>sql日期比较</p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 对于比较的两个时间，时间小的放在前面，时间大的放在后面</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> TIMESTAMPDIFF(</span><span style="color:#F78C6C;">DAY</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2018-03-20 23:59:00</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2015-03-22 00:00:00</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> TIMESTAMPDIFF(</span><span style="color:#F78C6C;">HOUR</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2018-03-20 09:00:00</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2018-03-22 10:00:00</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> TIMESTAMPDIFF(</span><span style="color:#F78C6C;">MINUTE</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2018-03-20 09:00:00</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2018-03-22 10:00:00</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> TIMESTAMPDIFF(</span><span style="color:#F78C6C;">SECOND</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2018-03-20 09:00:00</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2018-03-22 10:00:00</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span></code></pre></div><blockquote><p>sql添加创建时间和修改时间</p></blockquote><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">-- 创建的时候设置当前时间</span></span>
<span class="line"><span style="color:#A6ACCD;">`create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;</span></span></code></pre></div><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">-- 更新的时候设置更新时间为当前时间</span></span>
<span class="line"><span style="color:#A6ACCD;">`update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP</span></span></code></pre></div><blockquote><p>mysql单表数据量过大 select count(1) from &#39;表名&#39; 会超时</p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 查询表信息</span></span>
<span class="line"><span style="color:#A6ACCD;">show </span><span style="color:#F78C6C;">table</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">status</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">like</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">表名</span><span style="color:#89DDFF;">&#39;</span></span></code></pre></div><p><img src="/assets/image-20230418144910852.d4690d8a.png" alt="image-20230418144910852"></p><blockquote><p>SQL 语句中 left join 后用 on 还是 where 的区别</p></blockquote><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">在使用left jion时，on和where条件的区别如下：</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">1.on条件是在生成临时表时使用的条件，它不管on中的条件是否为真，都会返回左边表中的记录。</span></span>
<span class="line"><span style="color:#A6ACCD;">2.where条件是在临时表生成好后，再对临时表进行过滤的条件。这时已经没有left join的含义（必须返回左边表的记录）了，条件不为真的就全部过滤掉。</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">left join,right join,full join 有相同的特殊性，不管on上的条件是否为真都会返回left或right表中的记录</span></span>
<span class="line"><span style="color:#A6ACCD;">full join 则具有left和right的特性的并集。</span></span>
<span class="line"><span style="color:#A6ACCD;">而inner jion没这个特殊性，则条件放在on中和where中，返回的结果集是相同的。</span></span></code></pre></div><blockquote><p>MySQL 添加虚拟唯一键</p></blockquote><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">`unique_key` varchar(500) GENERATED ALWAYS AS (md5(concat_ws(if((`is_deleted` = 1),`id`,0),_utf8mb4&#39;_&#39;,`xxx`))) VIRTUAL COMMENT &#39;虚拟唯一键&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">UNIQUE KEY `uniq_xxx` (`unique_key`),</span></span></code></pre></div><h2 id="练习篇" tabindex="-1">练习篇 <a class="header-anchor" href="#练习篇" aria-label="Permalink to &quot;练习篇&quot;">​</a></h2><h3 id="mysql基础练习题1" tabindex="-1">Mysql基础练习题1 <a class="header-anchor" href="#mysql基础练习题1" aria-label="Permalink to &quot;Mysql基础练习题1&quot;">​</a></h3><h4 id="数据表" tabindex="-1">数据表 <a class="header-anchor" href="#数据表" aria-label="Permalink to &quot;数据表&quot;">​</a></h4><blockquote><h6 id="学生表-student-sid-sname-sage-ssex" tabindex="-1">学生表 Student（SId，Sname，Sage，Ssex） <a class="header-anchor" href="#学生表-student-sid-sname-sage-ssex" aria-label="Permalink to &quot;学生表 Student（SId，Sname，Sage，Ssex）&quot;">​</a></h6><p>SId 学生编号，Sname 学生姓名，Sage 出生年月，Ssex 学生性别</p></blockquote><blockquote><h6 id="课程表-course-cid-cname-tid" tabindex="-1">课程表 Course（CId，Cname，TId） <a class="header-anchor" href="#课程表-course-cid-cname-tid" aria-label="Permalink to &quot;课程表 Course（CId，Cname，TId）&quot;">​</a></h6><p>CId 课程编号，Cname 课程名称，TId 教师编号</p></blockquote><blockquote><h6 id="教师表-teacher-tid-tname" tabindex="-1">教师表 Teacher（TId，Tname） <a class="header-anchor" href="#教师表-teacher-tid-tname" aria-label="Permalink to &quot;教师表 Teacher（TId，Tname）&quot;">​</a></h6><p>TId 教师编号，Tname 教师姓名</p></blockquote><blockquote><h6 id="成绩表-sc-sid-cid-score" tabindex="-1">成绩表 SC（SId，CId，score） <a class="header-anchor" href="#成绩表-sc-sid-cid-score" aria-label="Permalink to &quot;成绩表 SC（SId，CId，score）&quot;">​</a></h6><p>SId 学生编号，CId 课程编号，score 分数</p></blockquote><h4 id="sql语句" tabindex="-1">SQL语句 <a class="header-anchor" href="#sql语句" aria-label="Permalink to &quot;SQL语句&quot;">​</a></h4><blockquote><h6 id="学生表-sql" tabindex="-1">学生表 SQL <a class="header-anchor" href="#学生表-sql" aria-label="Permalink to &quot;学生表 SQL&quot;">​</a></h6><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">create</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">table</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Student</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">SId</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">varchar</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">),Sname </span><span style="color:#C792EA;">varchar</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">),Sage </span><span style="color:#F78C6C;">datetime</span><span style="color:#A6ACCD;">,Ssex </span><span style="color:#C792EA;">varchar</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">));</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> Student </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">赵雷</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">1990-01-01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">男</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> Student </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">钱电</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">1990-12-21</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">男</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> Student </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">03</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">孙风</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">1990-12-20</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">男</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> Student </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">04</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">李云</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">1990-12-06</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">男</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> Student </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">05</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">周梅</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">1991-12-01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">女</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> Student </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">06</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">吴兰</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">1992-01-01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">女</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> Student </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">07</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">郑竹</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">1989-01-01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">女</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> Student </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">09</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">张三</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2017-12-20</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">女</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> Student </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">10</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">李四</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2017-12-25</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">女</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> Student </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">11</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">李四</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2012-06-06</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">女</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> Student </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">12</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">赵六</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2013-06-13</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">女</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> Student </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">13</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">孙七</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2014-06-01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">女</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span></code></pre></div></blockquote><blockquote><h6 id="科目表-sql" tabindex="-1">科目表 SQL <a class="header-anchor" href="#科目表-sql" aria-label="Permalink to &quot;科目表 SQL&quot;">​</a></h6><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">create</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">table</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Course</span><span style="color:#A6ACCD;">(CId </span><span style="color:#C792EA;">varchar</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">),Cname </span><span style="color:#F78C6C;">nvarchar</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">),TId </span><span style="color:#C792EA;">varchar</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">));</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> Course </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">语文</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> Course </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">数学</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> Course </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">03</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">英语</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">03</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span></code></pre></div></blockquote><blockquote><h6 id="教师表-sql" tabindex="-1">教师表 SQL <a class="header-anchor" href="#教师表-sql" aria-label="Permalink to &quot;教师表 SQL&quot;">​</a></h6><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">create</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">table</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Teacher</span><span style="color:#A6ACCD;">(TId </span><span style="color:#C792EA;">varchar</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">),Tname </span><span style="color:#C792EA;">varchar</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">));</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> Teacher </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">张三</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> Teacher </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">李四</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> Teacher </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">03</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">王五</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span></code></pre></div></blockquote><blockquote><h6 id="成绩表-sql" tabindex="-1">成绩表 SQL <a class="header-anchor" href="#成绩表-sql" aria-label="Permalink to &quot;成绩表 SQL&quot;">​</a></h6><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">create</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">table</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SC</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">SId</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">varchar</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">),CId </span><span style="color:#C792EA;">varchar</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">),score </span><span style="color:#C792EA;">decimal</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">18</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">));</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">80</span><span style="color:#A6ACCD;"> );</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">90</span><span style="color:#A6ACCD;"> );</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">03</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">99</span><span style="color:#A6ACCD;"> );</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">70</span><span style="color:#A6ACCD;"> );</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">60</span><span style="color:#A6ACCD;"> );</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">03</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">80</span><span style="color:#A6ACCD;"> );</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">03</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">80</span><span style="color:#A6ACCD;"> );</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">03</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">80</span><span style="color:#A6ACCD;"> );</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">03</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">03</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">80</span><span style="color:#A6ACCD;"> );</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">04</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;"> );</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">04</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">30</span><span style="color:#A6ACCD;"> );</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">04</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">03</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">20</span><span style="color:#A6ACCD;"> );</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">05</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">76</span><span style="color:#A6ACCD;"> );</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">05</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">87</span><span style="color:#A6ACCD;"> );</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">06</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">31</span><span style="color:#A6ACCD;"> );</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">06</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">03</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">34</span><span style="color:#A6ACCD;"> );</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">07</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">89</span><span style="color:#A6ACCD;"> );</span></span>
<span class="line"><span style="color:#F78C6C;">insert into</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">values</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">07</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">03</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">98</span><span style="color:#A6ACCD;"> );</span></span></code></pre></div></blockquote><h4 id="问题集" tabindex="-1">问题集 <a class="header-anchor" href="#问题集" aria-label="Permalink to &quot;问题集&quot;">​</a></h4><blockquote><p>1.<code>查询&quot; 01 &quot;课程比&quot; 02 &quot;课程成绩高的学生的信息及课程分数</code></p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- student表 右连接 （课程01比课程02分数高的分数表）</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Student stu </span><span style="color:#F78C6C;">RIGHT JOIN</span><span style="color:#A6ACCD;"> (</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> t1.SId,score1,score2 </span><span style="color:#F78C6C;">FROM</span></span>
<span class="line"><span style="color:#A6ACCD;">		(</span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">SId</span><span style="color:#A6ACCD;">, score </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> score1 </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> SC.CId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">) t1,</span></span>
<span class="line"><span style="color:#A6ACCD;">		(</span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">SId</span><span style="color:#A6ACCD;">, score </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> score2 </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> SC.CId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">) t2</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> t1.SId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> t2.SId </span><span style="color:#F78C6C;">and</span><span style="color:#A6ACCD;"> t1.score1 </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> t2.score2</span></span>
<span class="line"><span style="color:#A6ACCD;">) temp </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> stu.SId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> temp.SId;</span></span></code></pre></div><p><img src="/assets/image-20230210113700837.8e743771.png" alt="image-20230210113700837"></p><blockquote><p>2.<code>查询同时存在&quot; 01 &quot;课程和&quot; 02 &quot;课程的情况</code></p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 在分数表中查询学生既存在01课程分数也存在02课程分数</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span></span>
<span class="line"><span style="color:#A6ACCD;">	( </span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> SC.CId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> ) t1,</span></span>
<span class="line"><span style="color:#A6ACCD;">	( </span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> SC.CId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> ) t2 </span></span>
<span class="line"><span style="color:#F78C6C;">WHERE</span></span>
<span class="line"><span style="color:#A6ACCD;">	t1.SId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> t2.SId</span></span></code></pre></div><p><img src="/assets/image-20230210113642079.ad8e6657.png" alt="image-20230210113642079"></p><blockquote><p>3.<code>查询存在&quot; 01 &quot;课程但可能不存在&quot; 02 &quot;课程的情况(不存在时显示为 null)</code></p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 02课程可能不存在，即为 课程01分数 left join 课程02分数</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> SC.CId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">) t1 </span></span>
<span class="line"><span style="color:#F78C6C;">LEFT JOIN</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> SC.CId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> ) t2</span></span>
<span class="line"><span style="color:#F78C6C;">on</span><span style="color:#A6ACCD;"> t1.SId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> t2.SId</span></span></code></pre></div><p><img src="/assets/image-20230210114836685.a5c07fe8.png" alt="image-20230210114836685"></p><blockquote><p>4.<code>查询不存在&quot; 01 &quot;课程但存在&quot; 02 &quot;课程的情况</code></p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 过滤存在课程01的学生再过滤课程02的结果</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> SC.SId </span><span style="color:#F78C6C;">not</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">in</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">SId</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> SC.CId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">and</span><span style="color:#A6ACCD;"> SC.CId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">02</span><span style="color:#89DDFF;">&#39;</span></span></code></pre></div><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANEAAABKCAYAAAAlm7FvAAANHklEQVR4nO2dT2gj6ZmHn9qEmD1kRjDTPbMbAjsayUocBwYTDC2THHYiZSUvO+6Duuc0LTKsZOdgV28QrGGYQ8ZggsO61Ieopf2Dew7LdOvQzrKWpiVmA1msBhPMkHG8a0vWLoSF7ekeqGZOnhAqh1JJVWXJklz65/b3QB30VZXq/arqV+/7vdL3lqSqqvb8888DcHh4yHllfHx82CYMlPN8rc4rre6xL9sbXnrppb4b02sePXo0bBOGwnm9VufV7lb8yQDtEAieSYSIBAKHCBH1hTxxKU5+2GYIBsJgRFSUCaaqAzlUcyokZyQkybTMJKkM0aKT5IlLEjPJ0bJK0J7uRFSUcclF6+dgiqbyKMq4XC59iWywszzV+FxbzF81CGI5DU3Tl9ykjDc+CF+hC7j1oQyBb0KsV8csIrtkmp/eKqmgeV27bV24XEEG+gyspghabg67zacwhAd2VyIqbu0TZc0iDnaWmTKLwyyqaBZVVZsu2WjvO9MNobme3bEO8bC0raFpaeZ69p0BFlf3Wev6ZjJEYyxTHCRUVLXAgrtnxp2daopgS8HXNqnsD8wcg85FVE2xtn+VRaXQUhiqqqIWFqif743ICe9jLJGNvvSnQyokVzL4J7ymNj2cMsI9c1hVSc6YQsHaWKeSZMY87rF/rn+nF7kEmfAAQkiT959a3jF5f5kiRWRb1FCUXbhcETbYIOJyEUwdAdOs7jaupxLop8FWqqmgNdKx416gsOtjzRCSOdpp2u/BRD0diqhKan4Zrv4A94mnlXmxPSVGzBNlwoYQbsAdje0lT21Nnri0wkTZCPfKXLvn1UOwSpIb8iQ5zViXJtTxEUOktTKKvxZKbi/hab/T2Qko7K5OE81az3M0q9BMCwFFRd1dZZooWVWlsPBqP61ri3shQXRjjdTRqRtRUGv9CSjW+2p3lenpKNHoKru2+62fD4OORFRNzbO8Y3xys1Bo5YlsF2vEPJExJsrFSshrJp+R3yRDCdlriEz3HnuHFfCMM0mGsDTDeRjzuxdu41vTxzDVVJCt2dNvoOqD++ywQaQ+7tlhearJNWs19u0pARZX4f7WAVAxPaynWN7RvaVhz4lxTzVFcOqAREFBWYT5gdir05GIjg4myNZdx/n1RAahdI5YJmwd7PsVyloj8aBphqcKkdY0NO0O3JCQRlhMeng2xfKOLoSp5R02IqeFM0Vu3afmiRIczN/iwBzO6W7sZJjeR9wLBQqLPsBjelhnidrCzEJ9kFa7H+chsbpPJJii6l6gcBvmm4mtD3QkooBi9jDn1xM1CJFQ/GRWamOU0ByxkozFOcUbY59kHvQEQBnFX2K/bGy1x2FNUJWte5QG14GmBJTWY9Vm3qiaWoNEggl9b5TCIj4m8Aw1iVBEnlpmx9xUrbDPDvcfWAWhPzTm4bYu8sBCgd2r95lPVWthn8pt5pt7rh5ypt+JdOPbeCJ7vNrhhR0UnqU7KBhp7hDpssJeuJFY2JyrjX08S4xvmsK8yRzpkN5+R6EeAt7Yn8Tf/EjMXvMPJrHQIkpodQMdcZXFgLXlYKfppgOiiOxaw5ddZdrcemuZiewuV+/fskQ6+kPDnDkscmt5goQpleheKNg8V+8544+tVtfacLkGxm8PRkaoye8N1RTBgcWteho5HTrZphmNniW2TaGcedtQ2hTmmVZ4lrYboV86zXY96RAibUpA1Ldrk1gIpc3JjrOiJwnq1+WUuDmwYAvRiltsRGebJiEGQVGOQLaAJb9RlInsr7IYcLOQgIgtLi3KLuRilVQwSKoaQFFn2TLdZ0W5/yFdX/6xoJ+MZiGg/tSopoIEH/xAj1sHOAC8GFgH4K563BxAOXVcUyW1tkF0dnjhQUCxRSfVFMEIZA27AwpZIvU0eDUVJELWFtEEUNQCC25dWJXFWkjXxxz3iakQnaEPXJdPtEeZRT8Zer9exUeEKZd9yyhZ1Q0sUCiczQJBK6JkzWPTokywAnp0EGEDYHqVXftu1Qfcn8hSGGKIbWEjgmvD1hf0eysru3DJWVSlgFpr90zsELHfk9Or7LprIV0fTZXsk/JazvUoygQrixQW3BTlIJVF+6/YRWTXFrP25MIAePTo0YWclHde5+WcV7s7npTXkoBSf0oFlEIToQRQ1FF5jAkEg0NMhRAIHCJEJBA4RIhIIHCIpKqq9iwU+riIiQXBaGDJzgkEgu4R4ZxA4BAhIoHAIUJEAoFDhIgEAod0/d+5o6Mj/vD81/thy0D50tPf8eqrw50O3SuOjo6emb50yyj0XXgigcAhQkQCgUOEiAQChwgRCQQOGa6IPvoRvtAt/neoRvSIfBzJr4xYfW/BIOiBiD7k3Utj+GrLux811vzqx2Ncv32ebitrFVTJVFMrH5fwK+epL4JB4VBEH/LupTfgg2MOHh9z8Pi3uH/2I37VG9sGSz6OJIXBVPRem9sUwhG05Yw1FmpUDzn4zho/fd1o8BDN/9yxUYMnTzycIZazVQQKpSl1XjNYcEFx5onc4/h+neBfPmq/qY419PO9+c+ODt8z8ptkrqyT6EowttAvnOmXdV1TUfwnC/ADdpv9dS9r64tlnwqKXyKer21TH/e1+q6Lh8Nw7q/4yQdvc/fNMXyX2oVx9tDvmH98y9nRh0eeuC30y43Km1oqCm/d/HaTAvy6zZ+sl+s2l2RP03YtB2HbGy4y4U3mNA2tJOMhT1x6j282ewHABcR5YuH1n3Pw+JgH733C314aw/fjD5tv99G/cfc7a/zw9UbT98JvOz78UGjiuUbmfUceH98mQ1jyY3EONZvfl23FIZu1hxKsX8mwaRJFLGd6G0Z+kwwPuWl6AcDNh/DJwcX0Rj1Lcf/F/H9y8PgXXH//DUuG7lwQmiP28B7//kzcA0YB/vfhLQnJLqaOucI3vaetXj/xAoCSXaAXBGciqt7i+gnPM437lSbbvv43XLeMnyps/GxExkSESKzDTa/96R1vHuuH5og9vGkqgF9BeW9ExkQVBaVWgF8ulVm/8pD/KtPE5jyKUqm3v2XuZ36Nm1zjr1tp4sR3mV4AcAFxlp1zL/JT73fxXXqj3nT9g2OiTWvV6uMn35tj3AVgmuX33oZfOLKgZ3jkEpovjuSVuGk0xnJo6WZ3Uoh0LoYUltClc4X19RjcG5S1p+CR8a1JSOHa51gOLQR60f51/F4JSV9BTksDHtJajrjkRWp0nJwmn1I33P5d+ruf0n3p0OjTdY0FMRVi9BiF6QDDYhT6Lv47JxA4RIhIIHCIEJFA4BAhIoHAIUJEAoFDJFVVtSdPngzbDoHgzAw7O/dloKuU9Zee/g7PP/2+bwYNCvXv/4xnpXzy06dPn5m+dMvTp0+HbYII5wQCpwgRCQQOESISCBwiRCQQOOSEiHyXxoZhh0BwbmnqiboT0nPkVr+BtvoNtNVXUF7WW/3BV2pt1iX3Wg+s7gvm6c4zJG1TIqRW6wTOqCSZMU0zt8yOtawb3fPeMpzrTEhjKH/353h/+T9Iy/+NdPcLlpa+RgwoFWptxpL8jAqfs/lx74zvHRWSM2H2lNoU6dwksteYH5MnvjLRmIBmWSdwRp64V2bSmGafi5EJm867Zd0k8o3kSNb1O3VM1FZILz/H7KXPWSsc658/fkLy8VeZa+JtYt9/gfLd/2NEpq5ZqWxxrxTjnaXaDJpQAsVvTI8Okd5easytCc0RY4/DUbya55IYc8a8c/O5zW+S8SuNKfihBAr32BrB8942sXCqkF7+Cp7ffm4SxjH7n4L3sm2f175G+vJnrIykFwLK+5Ric40aAngYn4S9ZkrJb5JhkvGLORO6x4RIKHusGHFafpNM7B2WWp7bEvvlQdnWOR1l51oJyX/5Kx3sPYbyl18l/x+PKXVj2QCpHO51uGGSmXDGWrRD4JiS7K2XHfNP1Ao7eCfwl+TGFPT8GvKI3kAdiejg8XHT9tKnX7TfuRbyjeZYSMczPtl2m0pyBsl7j2tlW4FHwdmpJLkhg1IvvZVjUq6V3vIssZ2LkQnXEgsrEygxPxOnFU8ZEm1F1EpAdS6P4a9/GGPiMpQ/bewT+/4L8MsnozkWMrN3aBq0Vjjcg8lazJaPS3j330HTtk8JNQTdUtm6R8kSvoWYi5nC6FC6UU1oe5z9zGiG0aeKqK2APn5Ckhd4x0gkvPYiS5jHPs8x961jtn7T5nuGTSiBgi10oDaorSRZycTICffTczyz1/BnVkyp6zybmcbDy0w+HmZPSYxkGN1SRG0FBMAx8r9+hvd67Xeg6xD/B9PY5+UxvHzB/v/3xNY+4mHpjsKeETqEIWdk5Mr7lMgQtpTZlS5stc+e4lliOzeJXC8CqVeV1Z9XFZIzjfO9MlFme0TDAElVVe3R7/+03uC7NHaqgMRUiNHjok+FGHbfT3iizjyQQCAwEH9AFQgcIkQkEDhEiEggcIgQkUDgkDNV+3nxxRf7ZI5A0D3Dzs51XdBeIBBYEeGcQOCQPwIPr4Cw8THSyQAAAABJRU5ErkJggg==" alt="image-20230210115308976"></p><blockquote><p>5.<code>查询平均成绩大于等于 60 分的同学的学生编号、学生姓名、平均成绩。</code></p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 1.根据学生 ID 把成绩分组，对分组中的 score 求平均值，最后在选取结果中 AVG 大于 60 的即可。</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 2.内联学生表和1的结果</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> Student.SId,Student.Sname,avgScore </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Student,</span></span>
<span class="line"><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">SId</span><span style="color:#A6ACCD;">,</span><span style="color:#82AAFF;">AVG</span><span style="color:#A6ACCD;">(Score) avgScore </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> SC.SId </span><span style="color:#F78C6C;">HAVING</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">AVG</span><span style="color:#A6ACCD;">(Score) </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">60</span><span style="color:#A6ACCD;">) temp </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> Student.SId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> temp.SId;</span></span></code></pre></div><p><img src="/assets/image-20230210120117001.1715989e.png" alt="image-20230210120117001"></p><blockquote><p>6.<code>查询所有同学的学生编号、学生姓名、选课总数、所有课程的成绩总和联合查询没选课的学生</code></p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 显示没选课的学生(显示为 NULL)，用学生表left join 聚合好的分数表</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> Student.SId,Student.Sname,temp.countCourse,temp.sumScore </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Student</span></span>
<span class="line"><span style="color:#F78C6C;">LEFT JOIN</span></span>
<span class="line"><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> SC.SId,</span><span style="color:#82AAFF;">count</span><span style="color:#A6ACCD;">(SC.CId) </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> countCourse,</span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(Score) </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> sumScore </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> SC.SId) temp </span></span>
<span class="line"><span style="color:#F78C6C;">on</span><span style="color:#A6ACCD;"> Student.SId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> temp.SId;</span></span></code></pre></div><p><img src="/assets/image-20230210121313795.76f87b68.png" alt="image-20230210121313795"></p><blockquote><p>7.<code>查有成绩的学生信息</code></p><p>tip: 这一题涉及到 in 和 exists 的用法，在这种小表中，两种方法的效率都差不多，但是请参考 SQL 查询中 in 和 exists 的区别分析，当表2的记录数量非常大的时候，选用 exists 比 in 要高效很多。exists 用于检查子查询是否至少会返回一行数据，该子查询实际上并不返回任何数据，而是返回值 True 或 False。</p><p>结论：<code>IN() 适合B表比A表数据小的情况</code></p><p>结论：<code>EXISTS() 适合B表比A表数据大的情况</code></p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- EXISTS()查询是否存在</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Student </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> SC.SId </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> SC.SId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Student.SId);</span></span></code></pre></div><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- IN()查询是否存在</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Student </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> Student.SId </span><span style="color:#F78C6C;">in</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> SC.SId </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> SC);</span></span></code></pre></div><p><img src="/assets/image-20230210122028343.b1c3b251.png" alt="image-20230210122028343"></p><blockquote><p>8.<code>查询「李」姓老师的数量</code></p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 左模糊查询</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">count</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> teacher </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> tname </span><span style="color:#F78C6C;">LIKE</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">李%</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><blockquote><p>9.<code>查询学过「张三」老师授课的同学的信息</code></p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 多表联合查询</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> Student.</span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Student, Teacher, Course, SC</span></span>
<span class="line"><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> Student.sid </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> SC.sid</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">AND</span><span style="color:#A6ACCD;"> Course.cid </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> SC.cid</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">AND</span><span style="color:#A6ACCD;"> Course.tid </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Teacher.tid</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">AND</span><span style="color:#A6ACCD;"> tname </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">张三</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><p><img src="/assets/image-20230210122422787.c771fa65.png" alt="image-20230210122422787"></p><blockquote><p>10.<code>查询没有学全所有课程的同学的信息</code></p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 先查询选了所有课的学生，再反向思选择这些人之外的学生</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Student</span></span>
<span class="line"><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> Student.sid </span><span style="color:#F78C6C;">NOT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">IN</span><span style="color:#A6ACCD;"> (</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> SC.SId </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> SC </span><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> SC.SId </span><span style="color:#F78C6C;">HAVING</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">count</span><span style="color:#A6ACCD;">(SC.CId) </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">count</span><span style="color:#A6ACCD;">(cid) </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Course)</span></span>
<span class="line"><span style="color:#A6ACCD;">)</span></span></code></pre></div><p><img src="/assets/image-20230210123938941.86580deb.png" alt="image-20230210123938941"></p><blockquote><p>11.<code>查询至少有一门课与学号为&quot; 01 &quot;的同学所学相同的同学的信息</code></p></blockquote><blockquote><p>12.<code>查询没学过&quot;张三&quot;老师讲授的任一门课程的学生姓名</code></p></blockquote><blockquote><p>13.<code>查询两门及其以上不及格课程的同学的学号，姓名及其平均成绩</code></p></blockquote><blockquote><p>14.<code>检索&quot; 01 &quot;课程分数小于 60 ，按分数降序排列的学生信息</code></p></blockquote><blockquote><p>15.<code>按平均成绩从高到低显示所有学生的所有课程的成绩以及平均成绩</code></p></blockquote><blockquote><p>16.<code>查询各科成绩最高分、最低分和平均分</code></p></blockquote><blockquote><p>17.<code>按各科成绩进行排序，并显示排名， Score重复时保留名次空缺</code></p></blockquote><blockquote><p>18.<code>查询学生的总成绩，并进行排名，总分重复时不保留名次空缺</code></p></blockquote><blockquote><p>19.<code>统计各科成绩各分数段人数：课程编号，课程名称，[ 100 - 85 ]，[ 85 - 70 ]，[ 70 - 60 ]，[ 60 - 0 ]及所占百分比</code></p></blockquote><blockquote><p>20.<code>查询各科成绩前三名的记录</code></p></blockquote><blockquote><p>21.<code>查询每门课程被选修的学生数</code></p></blockquote><blockquote><p>22.<code>查询出只选修两门课程的学生学号和姓名</code></p></blockquote><blockquote><p>23.<code>查询男生、女生人数</code></p></blockquote><blockquote><p>24.<code>查询名字中含有「风」字的学生信息</code></p></blockquote><blockquote><p>25.<code> 查询同名学生名单，并统计同名人数</code></p></blockquote><blockquote><p>26.<code>查询 1990 年出生的学生名单</code></p></blockquote><blockquote><p>27.<code>查询每门课程的平均成绩，结果按平均成绩降序排列，平均成绩相同时，按课程编号升序排列</code></p></blockquote><blockquote><p>28.<code>查询平均成绩大于等于 85 的所有学生的学号、姓名和平均成绩</code></p></blockquote><blockquote><p>29.<code>查询课程名称为「数学」，且分数低于 60 的学生姓名和分数</code></p></blockquote><blockquote><p>30.<code>查询所有学生的课程及分数情况（存在学生没成绩，没选课的情况）</code></p></blockquote><blockquote><p>31.<code>查询任何一门课程成绩在 70 分以上的姓名、课程名称和分数</code></p></blockquote><blockquote><p>32.<code> 查询存在不及格的课程</code></p></blockquote><blockquote><p>33.<code>查询课程编号为 01 且课程成绩在 80 分及以上的学生的学号和姓名</code></p></blockquote><blockquote><p>34.<code>求每门课程的学生人数</code></p></blockquote><blockquote><p>35.<code>成绩不重复，查询选修「张三」老师所授课程的学生中，成绩最高的学生信息及其成绩</code></p></blockquote><blockquote><p>36.<code>成绩有重复的情况下，查询选修「张三」老师所授课程的学生中，成绩最高的学生信息及其成绩</code></p></blockquote><blockquote><p>37.<code>查询不同课程成绩相同的学生的学生编号、课程编号、学生成绩</code></p></blockquote><blockquote><p>38.<code>查询每门功成绩最好的前两名</code></p></blockquote><blockquote><p>39.<code>统计每门课程的学生选修人数（超过 5 人的课程才统计）</code></p></blockquote><blockquote><p>40.<code>检索至少选修两门课程的学生学号</code></p></blockquote><blockquote><p>41.<code>查询选修了全部课程的学生信息</code></p></blockquote><blockquote><p>42.<code>查询各学生的年龄，只按年份来算</code></p></blockquote><blockquote><p>43.<code>查询本周过生日的学生</code></p></blockquote><blockquote><p>44.<code>查询本月过生日的学生</code></p></blockquote><blockquote><p>45.<code>查询下月过生日的学生</code></p></blockquote><blockquote><p>46.<code>附加题</code></p><p>...</p></blockquote><h3 id="mysql基础练习题2" tabindex="-1">Mysql基础练习题2 <a class="header-anchor" href="#mysql基础练习题2" aria-label="Permalink to &quot;Mysql基础练习题2&quot;">​</a></h3><p>现有一表user_login_table代表表名</p><p>user_name代表用户ID</p><p>date代表用户登录时间</p><p>其结构数据如下：</p><p><img src="/assets/image-20230209191600655.72191b5f.png" alt="image-20230209191600655"></p><blockquote><p><code>统计每天的访问量</code></p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 通过cast函数得到日期后 group by 然后 count distinct</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CAST</span><span style="color:#A6ACCD;">(</span><span style="color:#C792EA;">date</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">date</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> new_date,</span><span style="color:#82AAFF;">COUNT</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">DISTINCT</span><span style="color:#A6ACCD;">(user_name)) </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">user_login_table</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> new_date</span></span></code></pre></div><blockquote><p><code>统计前20%的数据记录的user_name</code></p></blockquote><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 通过row_number函数新建一列自增数据，在通过where条件判断低于20%的列</span></span></code></pre></div><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 通过mysql中的用户变量（@）自增一列数据，在通过where条件判断低于20%的列</span></span></code></pre></div><h3 id="mysql进阶练习题" tabindex="-1">Mysql进阶练习题 <a class="header-anchor" href="#mysql进阶练习题" aria-label="Permalink to &quot;Mysql进阶练习题&quot;">​</a></h3><h4 id="_1-查找第n高的数据" tabindex="-1">1.查找第N高的数据 <a class="header-anchor" href="#_1-查找第n高的数据" aria-label="Permalink to &quot;1.查找第N高的数据&quot;">​</a></h4><h5 id="思路1" tabindex="-1">思路1 <a class="header-anchor" href="#思路1" aria-label="Permalink to &quot;思路1&quot;">​</a></h5><p>第二高 通过max函数</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">max</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">distinct</span><span style="color:#A6ACCD;"> 成绩) </span></span>
<span class="line"><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> 成绩表</span></span>
<span class="line"><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> 课程</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">语文</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">and</span></span>
<span class="line"><span style="color:#A6ACCD;">      成绩 </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">max</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">distinct</span><span style="color:#A6ACCD;"> 成绩) </span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> 成绩表 </span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> 课程</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">语文</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">ifnull</span><span style="color:#A6ACCD;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">max</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">distinct</span><span style="color:#A6ACCD;"> 成绩) </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> 成绩表</span></span>
<span class="line"><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> 成绩</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">max</span><span style="color:#A6ACCD;">(成绩) </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> 成绩表 </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> 课程</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">语文</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#F78C6C;">and</span><span style="color:#A6ACCD;"> 课程</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">语文</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">null</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">语文课第二名成绩</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><h5 id="思路2" tabindex="-1">思路2 <a class="header-anchor" href="#思路2" aria-label="Permalink to &quot;思路2&quot;">​</a></h5><blockquote><p>limit n子句表示查询结果返回前n条数据</p><p>offset n表示跳过x条语句</p><p>limit y offset x 分句表示查询结果跳过 x 条数据，读取前 y 条数据</p><p>使用limit和offset，降序排列再返回第二条记录可以得到第二大的值</p><p>考虑特殊情况:</p><p>如果没有第二高的成绩，返回空值，所以这里用判断空值的函数（ifnull）函数来处理特殊情况。</p><p>ifnull(a,b)函数解释：</p><p>如果value1不是空，结果返回a</p><p>如果value1是空，结果返回b</p></blockquote><p>第二高 通过 LIMIT OFFSET 函数</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">IFNULL</span><span style="color:#A6ACCD;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">      (</span><span style="color:#F78C6C;">SELECT DISTINCT</span><span style="color:#A6ACCD;"> Salary</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Employee</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> Salary </span><span style="color:#F78C6C;">DESC</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">LIMIT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> OFFSET </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">NULL</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> SecondHighestSalary</span></span></code></pre></div><p>第N高</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FUNCTION</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getNthHighestSalary</span><span style="color:#A6ACCD;">(N </span><span style="color:#C792EA;">INT</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">RETURNS</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">INT</span></span>
<span class="line"><span style="color:#F78C6C;">BEGIN</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">declare</span><span style="color:#A6ACCD;"> m </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">set</span><span style="color:#A6ACCD;"> m </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> N </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">RETURN</span><span style="color:#A6ACCD;"> (</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#A6ACCD;"># Write your MySQL query </span><span style="color:#F78C6C;">statement</span><span style="color:#A6ACCD;"> below.</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">ifnull</span><span style="color:#A6ACCD;">((</span><span style="color:#F78C6C;">select DISTINCT</span><span style="color:#A6ACCD;"> salary </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> Employee </span><span style="color:#F78C6C;">order by</span><span style="color:#A6ACCD;"> salary </span><span style="color:#F78C6C;">DESC</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">limit</span><span style="color:#A6ACCD;"> m,</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">),</span><span style="color:#F78C6C;">null</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  );</span></span>
<span class="line"><span style="color:#F78C6C;">END</span></span></code></pre></div><h4 id="_2-分数排名" tabindex="-1">2.<a href="https://leetcode-cn.com/problems/rank-scores/" target="_blank" rel="noreferrer">分数排名</a> <a class="header-anchor" href="#_2-分数排名" aria-label="Permalink to &quot;2.[分数排名](https://leetcode-cn.com/problems/rank-scores/)&quot;">​</a></h4><blockquote><p>编写 SQL 查询对分数进行排序。排名按以下规则计算:</p><p>分数应按从高到低排列。 如果两个分数相等，那么两个分数的排名应该相同。 在排名相同的分数后，排名数应该是下一个连续的整数。换句话说，排名之间不应该有空缺的数字。</p></blockquote><h5 id="解法1" tabindex="-1">解法1 <a class="header-anchor" href="#解法1" aria-label="Permalink to &quot;解法1&quot;">​</a></h5><blockquote><p>最后的结果包含两个部分，第一部分是降序排列的分数，第二部分是每个分数对应的排名</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> a.Score </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> Score</span></span>
<span class="line"><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> Scores a</span></span>
<span class="line"><span style="color:#F78C6C;">order by</span><span style="color:#A6ACCD;"> a.Score </span><span style="color:#F78C6C;">DESC</span></span></code></pre></div><p>比较难的是第二部分。假设现在给你一个分数X，如何算出它的排名Rank呢？ 我们可以先提取出大于等于X的所有分数集合H，将H去重后的元素个数就是X的排名。比如你考了99分，但最高的就只有99分，那么去重之后集合H里就只有99一个元素，个数为1，因此你的Rank为1。 先提取集合H：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> b.Score </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> Scores b </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> b.Score </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> X;</span></span></code></pre></div><p>集合H去重之后的元素个数:</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">count</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">distinct</span><span style="color:#A6ACCD;"> b.Score) </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> Scores b </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> b.Score </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> X </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> Rank;</span></span></code></pre></div><p>从结果的角度来看，第二部分的Rank是对应第一部分的分数来的，所以这里的X就是上面的a.Score，把两部分结合在一起为：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> a.Score </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> Score,</span></span>
<span class="line"><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">count</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">distinct</span><span style="color:#A6ACCD;"> b.Score) </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> Scores b </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> b.Score </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> a.Score) </span><span style="color:#F78C6C;">as</span><span style="color:#A6ACCD;"> Rank</span></span>
<span class="line"><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> Scores a</span></span>
<span class="line"><span style="color:#F78C6C;">order by</span><span style="color:#A6ACCD;"> a.Score </span><span style="color:#F78C6C;">DESC</span></span></code></pre></div></blockquote><h5 id="解法2" tabindex="-1">解法2 <a class="header-anchor" href="#解法2" aria-label="Permalink to &quot;解法2&quot;">​</a></h5><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 窗口函数</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> Score,</span><span style="color:#82AAFF;">dense_rank</span><span style="color:#A6ACCD;">() </span><span style="color:#F78C6C;">over</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">Order By</span><span style="color:#A6ACCD;"> Score </span><span style="color:#F78C6C;">desc</span><span style="color:#A6ACCD;">) </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Rank</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Scores;</span></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-c4b0d3cf data-v-face870a><!--[--><!--]--><!----><div class="prev-next" data-v-face870a><div class="pager" data-v-face870a><a class="pager-link prev" href="/study/algorithm/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1.html" data-v-face870a><span class="desc" data-v-face870a>Previous page</span><span class="title" data-v-face870a>数据结构设计</span></a></div><div class="has-prev pager" data-v-face870a><a class="pager-link next" href="/study/database/oracle.html" data-v-face870a><span class="desc" data-v-face870a>Next page</span><span class="title" data-v-face870a>oracle</span></a></div></div></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"book0002_03演进-缓存_16-cdn：静态资源如何加速？.md\":\"5de30bb1\",\"book0002_03演进-缓存_12-缓存：数据库成为瓶颈后，动态数据的查询要如何加速？.md\":\"02fb98bd\",\"book0002_00开篇_00-开篇词-为什么你要学习高并发系统设计？.md\":\"adeb0cda\",\"book0002_04演进-消息队列_20-当问到项目经历时，面试官究竟想要了解什么？.md\":\"2b63f5ba\",\"book0002_01基础_05-系统设计目标（三）：如何让系统易于扩展？.md\":\"ec2705b4\",\"book0002_02演进-数据库_09-数据库优化方案（二）：写入数据量增加时，如何实现分库分表？.md\":\"ac5c2789\",\"book0002_05演进-分布式服务_29-service mesh：如何屏蔽服务化系统的服务治理细节？.md\":\"86089e52\",\"book0002_04演进-消息队列_17-消息队列：秒杀如何处理每秒上万的下单请求？.md\":\"52e423a6\",\"book0002_01基础_03-系统设计目标（一）：如何提升系统性能？.md\":\"d47ebaf1\",\"book0002_04演进-消息队列_19-消息队列如何降低消息队列系统中消息的延迟？.md\":\"a56c7394\",\"book0002_01基础_01-高并发系统：它的通用设计方法是什么？.md\":\"5f45747f\",\"book0002_02演进-数据库_11-nosql：在高并发场景下，数据库和nosql如何做到互补？.md\":\"7f97c174\",\"book0002_02演进-数据库_07-池化技术：如何减少频繁创建数据库连接的性能损耗？.md\":\"4905d20c\",\"book0002_05演进-分布式服务_24-注册中心：分布式系统如何寻址？.md\":\"db06ad9e\",\"rycatalogue_index.md\":\"2087c963\",\"book0002_06演进-维护_30-给系统加上眼睛：服务端监控要怎么做？.md\":\"e97bb827\",\"book0002_05演进-分布式服务_25-分布式trace：横跨几十个分布式组件的慢请求要如何排查？.md\":\"389101ee\",\"book0002_05演进-分布式服务_22-微服务架构：微服务化后系统架构要如何改造？.md\":\"aa59f66d\",\"book0002_01基础_04-系统设计目标（二）：系统怎样做到高可用？.md\":\"30a0d8b6\",\"book0002_05演进-分布式服务_21-系统架构：每秒1万次请求的系统要做服务化拆分吗？.md\":\"9a9a2cf3\",\"book0002_02演进-数据库_08-数据库优化方案（一）：查询请求增加时，如何做主从分离？.md\":\"559e167c\",\"book0002_03演进-缓存_13-缓存的使用姿势（一）：如何选择缓存的读写策略？.md\":\"f0fc5b65\",\"book0002_01基础_02-架构分层：我们为什么一定要这么做？.md\":\"bf4e6cea\",\"book0002_05演进-分布式服务_23-rpc框架：10万qps下如何实现毫秒级的服务调用？.md\":\"0192b1c4\",\"design_日志系统架构设计.md\":\"9791e8b8\",\"design_灰度方案设计.md\":\"d0eb79cd\",\"book0002_06演进-维护_35-流量控制：高并发系统中我们如何操纵流量？.md\":\"a6e05824\",\"second_cloud_hystrix.md\":\"742c8715\",\"book0002_04演进-消息队列_18-消息投递：如何保证消息仅仅被消费一次？.md\":\"f1c5ff0d\",\"book0002_05演进-分布式服务_26-负载均衡：怎样提升系统的横向扩展能力？.md\":\"da4827f7\",\"problem_20230519q1.md\":\"044dfb44\",\"book0002_05演进-分布式服务_28-多机房部署：跨地域的分布式系统如何做？.md\":\"378ee208\",\"study_database_postgresql.md\":\"b0448f0e\",\"second_db_druid.md\":\"b133c817\",\"second_test_charles.md\":\"42a24be6\",\"second_standard_sonarlint.md\":\"a766868c\",\"second_server_nginx.md\":\"9db78cfd\",\"study_cache_memcached.md\":\"6c5d9359\",\"book0002_06演进-维护_33-配置管理：成千上万的配置项要如何管理？.md\":\"77b0b44c\",\"second_server_openresty.md\":\"3daf729a\",\"second_cloud_springcloudstream.md\":\"eab227c3\",\"book0002_06演进-维护_31-应用性能管理：用户的使用体验应该如何监控？.md\":\"6b30207f\",\"book0002_07实战_39-信息流设计（一）：通用信息流系统的推模式要如何做？.md\":\"db407316\",\"design_分布式事务方案.md\":\"c8067b62\",\"second_alibaba_nacos.md\":\"20679633\",\"second_cloud_openfeign.md\":\"e9115e43\",\"design_多级缓存架构设计.md\":\"1e527c35\",\"design_单点登录架构设计.md\":\"680088ff\",\"second_cloud_skywalking.md\":\"9d195bfd\",\"design_秒杀系统架构设计.md\":\"09efd57b\",\"study_algorithm_队列与栈.md\":\"283be74a\",\"second_test_apachejmeter.md\":\"39eee2be\",\"design_index.md\":\"1e830a76\",\"second_mq_rabbitmq.md\":\"f48287cf\",\"second_standard_p3c.md\":\"1c200d3e\",\"second_test_testablemock.md\":\"1e8ef215\",\"second_mq_kafka.md\":\"f8e6645e\",\"book0002_07实战_37-计数系统设计（一）：面对海量数据的计数器要如何做？.md\":\"ccb2f466\",\"book0002_08结束_结束语-学不可以已.md\":\"78a420d3\",\"study_database_oracle.md\":\"69e3db14\",\"study_algorithm_二叉树.md\":\"5043bea0\",\"study_middleware_alibaba.md\":\"52dae21d\",\"study_database_mongodb.md\":\"cba61c26\",\"recatalogue_index.md\":\"c02b4c9a\",\"book0002_06演进-维护_32-压力测试：怎样设计全链路压力测试平台？.md\":\"255028e0\",\"book0002_03演进-缓存_14-缓存的使用姿势（二）：缓存如何做到高可用？.md\":\"73b0a09a\",\"book0002_02演进-数据库_10-发号器：如何保证分库分表后id的全局唯一性？.md\":\"6089362e\",\"book0002_03演进-缓存_15-缓存的使用姿势（三）：缓存穿透了怎么办？.md\":\"1177eda7\",\"book0002_03演进-缓存_加餐-数据的签约应该如何做？.md\":\"2b4e2a21\",\"study_util_asynctool.md\":\"938426db\",\"second_alibaba_zookeeper.md\":\"67d856f6\",\"second_flow_liteflow.md\":\"4ed5d733\",\"book0002_05演进-分布式服务_27-api网关：系统的门面要如何做呢？.md\":\"7ebb0982\",\"design_分布式id方案.md\":\"27accbcf\",\"study_algorithm_动态规划.md\":\"8823ad5e\",\"book0002_07实战_40-信息流设计（二）：通用信息流系统的拉模式要如何做？.md\":\"47e8901d\",\"second_db_canal.md\":\"513ed124\",\"second_flow_compileflow.md\":\"cc525bb3\",\"second_authority_satoken.md\":\"6c81ca75\",\"second_search_elasticsearch.md\":\"852b25ef\",\"second_alibaba_seata.md\":\"31851af7\",\"study_java_reactive.md\":\"6e08c532\",\"design_订单系统架构设计.md\":\"bea7df20\",\"study_bigdata_hdfs.md\":\"a3f41e61\",\"study_framework_springcloud.md\":\"9369466d\",\"second_db_mybatisplus.md\":\"829548c9\",\"design_电商业务架构设计.md\":\"97af5514\",\"book0002_07实战_38-计数系统设计（二）：50万qps下如何设计未读数系统？.md\":\"917bfe1d\",\"study_container_k8s.md\":\"11736fd5\",\"study_middleware_search.md\":\"9966a774\",\"study_middleware_mq.md\":\"739ab4d9\",\"study_middleware_task.md\":\"8ca1a08c\",\"second_alibaba_dubbo.md\":\"9586be3d\",\"second_server_netty.md\":\"b2c461b6\",\"study_middleware_flow.md\":\"af506f07\",\"study_util_feilong.md\":\"91c5d1ce\",\"study_util_doc.md\":\"f6a9187e\",\"second_test_mockito.md\":\"27495254\",\"problem_20220328q1.md\":\"81553158\",\"study_middleware_server.md\":\"0bbaae47\",\"second_task_xxljob.md\":\"d3133312\",\"updated_index.md\":\"c81c4e83\",\"index.md\":\"fa778d2d\",\"second_db_shardingjdbc.md\":\"6dad1140\",\"study_cache_redis.md\":\"a9d15ec7\",\"second_task_powerjob.md\":\"4473d1bc\",\"book0003_如何设计一个秒杀系统-许令波.md\":\"141af2b7\",\"book0002_06演进-维护_34-降级熔断：如何屏蔽非核心系统故障的影响？.md\":\"16171163\",\"design_接口性能优化方案.md\":\"26ace88d\",\"study_middleware_auth.md\":\"9f6bbb51\",\"second_cloud_springcloudgateway.md\":\"54df40df\",\"study_util_vavr.md\":\"cadff288\",\"second_test_jmh.md\":\"a29cb5a3\",\"second_alibaba_sentinel.md\":\"444d9cb0\",\"study_util_forest.md\":\"e688ae37\",\"second_standard_checkstyle.md\":\"607e5def\",\"study_middleware_db.md\":\"0008750b\",\"study_util_hutool.md\":\"6b7c76bf\",\"study_util_mapstruct.md\":\"9adde0f8\",\"study_util_log.md\":\"587f2041\",\"study_util_easyexcel.md\":\"ffc40e8c\",\"study_container_linux.md\":\"db1dd053\",\"study_java_feature.md\":\"c5262a79\",\"study_algorithm_数据结构设计.md\":\"54e84688\",\"study_container_docker.md\":\"db2ef32c\",\"study_util_guava.md\":\"fc37410e\",\"second_standard_ide.md\":\"5d9d8c96\",\"study_framework_springboot.md\":\"3acf1231\",\"second_db_mybatis.md\":\"09bb0584\",\"study_algorithm_数组与链表.md\":\"a6f8fc2e\",\"second_mq_rocketmq.md\":\"4c62a74a\",\"study_java_jvm.md\":\"089a627f\",\"study_database_mysql.md\":\"1cc9680e\",\"study_java_started.md\":\"653553ca\",\"study_framework_spring.md\":\"2d4a483a\",\"study_java_juc.md\":\"75332a6c\"}")
__VP_SITE_DATA__ = JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"liuxiaowei\",\"description\":\"liuxiaowei\",\"base\":\"/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"siteTitle\":\"liuxiaowei\",\"logo\":\"/logo.png\",\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/liuxiaowei2018\"},{\"icon\":{\"svg\":\"<svg role=\\\"img\\\" viewBox=\\\"0 0 24 24\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\"><title>Dribbble</title><path d=\\\"M12...6.38z\\\"/></svg>\"},\"link\":\"...\"}],\"lastUpdated\":\"Last Updated\",\"smoothScroll\":true,\"nav\":[{\"text\":\"gitee\",\"link\":\"https://gitee.com/git_liuxiaowei\"}],\"sidebar\":{\"/study/\":[{\"text\":\"JavaSe\",\"collapsible\":true,\"items\":[{\"text\":\"Java基础\",\"link\":\"/study/java/started\"},{\"text\":\"Java新特性\",\"link\":\"/study/java/feature\"},{\"text\":\"Java多线程\",\"link\":\"/study/java/JUC\"},{\"text\":\"JVM调优\",\"link\":\"/study/java/JVM\"},{\"text\":\"Java响应式编程\",\"link\":\"/study/java/reactive\"}]},{\"text\":\"数据结构&算法\",\"collapsible\":true,\"items\":[{\"text\":\"数组与链表\",\"link\":\"/study/algorithm/数组与链表\"},{\"text\":\"队列与栈\",\"link\":\"/study/algorithm/队列与栈\"},{\"text\":\"二叉树\",\"link\":\"/study/algorithm/二叉树\"},{\"text\":\"动态规划\",\"link\":\"/study/algorithm/动态规划\"},{\"text\":\"数据结构设计\",\"link\":\"/study/algorithm/数据结构设计\"}]},{\"text\":\"数据库\",\"collapsible\":true,\"items\":[{\"text\":\"mysql\",\"link\":\"/study/database/mysql\"},{\"text\":\"oracle\",\"link\":\"/study/database/oracle\"},{\"text\":\"postgreSQL\",\"link\":\"/study/database/postgreSQL\"},{\"text\":\"mongoDB\",\"link\":\"/study/database/mongoDB\"}]},{\"text\":\"缓存\",\"collapsible\":true,\"items\":[{\"text\":\"redis\",\"link\":\"/study/cache/redis\"},{\"text\":\"memcached\",\"link\":\"/study/cache/memcached\"}]},{\"text\":\"Spring\",\"collapsible\":true,\"items\":[{\"text\":\"spring\",\"link\":\"/study/framework/spring\"},{\"text\":\"springBoot\",\"link\":\"/study/framework/springBoot\"},{\"text\":\"springCloud\",\"link\":\"/study/framework/springcloud\"}]},{\"text\":\"中间件\",\"collapsible\":true,\"items\":[{\"text\":\"消息队列中间件\",\"link\":\"/study/middleware/mq\"},{\"text\":\"数据库中间件\",\"link\":\"/study/middleware/db\"},{\"text\":\"搜索中间件\",\"link\":\"/study/middleware/search\"},{\"text\":\"任务调度中间件\",\"link\":\"/study/middleware/task\"},{\"text\":\"工作流中间件\",\"link\":\"/study/middleware/flow\"},{\"text\":\"权限框架中间件\",\"link\":\"/study/middleware/auth\"},{\"text\":\"服务器中间件\",\"link\":\"/study/middleware/server\"},{\"text\":\"阿里中间件\",\"link\":\"/study/middleware/alibaba\"}]},{\"text\":\"容器化技术\",\"collapsible\":true,\"items\":[{\"text\":\"linux\",\"link\":\"/study/container/linux\"},{\"text\":\"docker\",\"link\":\"/study/container/docker\"},{\"text\":\"k8s\",\"link\":\"/study/container/k8s\"}]},{\"text\":\"大数据\",\"collapsible\":true,\"items\":[{\"text\":\"hdfs\",\"link\":\"/study/bigdata/hdfs\"}]},{\"text\":\"工具&插件\",\"collapsible\":true,\"items\":[{\"text\":\"log\",\"link\":\"/study/util/log\"},{\"text\":\"doc\",\"link\":\"/study/util/doc\"},{\"text\":\"guava\",\"link\":\"/study/util/guava\"},{\"text\":\"hutool\",\"link\":\"/study/util/hutool\"},{\"text\":\"mapstruct\",\"link\":\"/study/util/mapstruct\"},{\"text\":\"forest\",\"link\":\"/study/util/forest\"},{\"text\":\"easyexcel\",\"link\":\"/study/util/easyexcel\"},{\"text\":\"asyncTool\",\"link\":\"/study/util/asyncTool\"},{\"text\":\"vavr\",\"link\":\"/study/util/vavr\"},{\"text\":\"feilong\",\"link\":\"/study/util/feilong\"}]}],\"/second/mq\":[{\"text\":\"消息中间件\",\"collapsible\":true,\"items\":[{\"text\":\"rabbitMQ\",\"link\":\"/second/mq/rabbitMQ\"},{\"text\":\"rocketMQ\",\"link\":\"/second/mq/rocketMQ\"},{\"text\":\"kafka\",\"link\":\"/second/mq/kafka\"}]}],\"/second/db\":[{\"text\":\"数据库中间件\",\"collapsible\":true,\"items\":[{\"text\":\"mybatis\",\"link\":\"/second/db/mybatis\"},{\"text\":\"mybatisPlus\",\"link\":\"/second/db/mybatisPlus\"},{\"text\":\"druid\",\"link\":\"/second/db/druid\"},{\"text\":\"shardingJdbc\",\"link\":\"/second/db/shardingJdbc\"},{\"text\":\"canal\",\"link\":\"/second/db/canal\"}]}],\"/second/search\":[{\"text\":\"搜索中间件\",\"collapsible\":true,\"items\":[{\"text\":\"elasticsearch\",\"link\":\"/second/search/elasticsearch\"}]}],\"/second/task\":[{\"text\":\"任务调度中间件\",\"collapsible\":true,\"items\":[{\"text\":\"xxlJob\",\"link\":\"/second/task/xxlJob\"},{\"text\":\"powerJob\",\"link\":\"/second/task/powerJob\"}]}],\"/second/flow\":[{\"text\":\"工作流中间件\",\"collapsible\":true,\"items\":[{\"text\":\"compileflow\",\"link\":\"/second/flow/compileflow\"},{\"text\":\"liteflow\",\"link\":\"/second/flow/liteflow\"}]}],\"/second/server\":[{\"text\":\"服务器中间件\",\"collapsible\":true,\"items\":[{\"text\":\"netty\",\"link\":\"/second/server/netty\"},{\"text\":\"nginx\",\"link\":\"/second/server/nginx\"},{\"text\":\"openResty\",\"link\":\"/second/server/openResty\"}]}],\"/second/alibaba\":[{\"text\":\"阿里中间件\",\"collapsible\":true,\"items\":[{\"text\":\"dubbo\",\"link\":\"/second/alibaba/dubbo\"},{\"text\":\"nacos\",\"link\":\"/second/alibaba/nacos\"},{\"text\":\"seata\",\"link\":\"/second/alibaba/seata\"},{\"text\":\"sentinel\",\"link\":\"/second/alibaba/sentinel\"},{\"text\":\"zookeeper\",\"link\":\"/second/alibaba/zookeeper\"}]}],\"/second/cloud\":[{\"text\":\"SpringCloud\",\"collapsible\":true,\"items\":[{\"text\":\"openFeign\",\"link\":\"/second/cloud/openFeign\"},{\"text\":\"hystrix\",\"link\":\"/second/cloud/hystrix\"},{\"text\":\"springCloudGateway\",\"link\":\"/second/cloud/springCloudGateway\"},{\"text\":\"springCloudStream\",\"link\":\"/second/cloud/springCloudStream\"},{\"text\":\"skywalking\",\"link\":\"/second/cloud/skywalking\"}]}],\"/rycatalogue\":[{\"text\":\"知识库\",\"collapsible\":true,\"items\":[{\"text\":\"架构设计&解决方案\",\"link\":\"/design/单点登录架构设计\"},{\"text\":\"生产问题排查&复盘\",\"link\":\"/problem/20220328q1\"}]}],\"/design/\":[{\"text\":\"架构设计&解决方案\",\"collapsible\":true,\"items\":[{\"text\":\"如何做好架构设计\",\"link\":\"/design/index\"},{\"text\":\"单点登录架构设计\",\"link\":\"/design/单点登录架构设计\"},{\"text\":\"多级缓存架构设计\",\"link\":\"/design/多级缓存架构设计\"},{\"text\":\"分布式ID方案\",\"link\":\"/design/分布式ID方案\"},{\"text\":\"分布式事务方案\",\"link\":\"/design/分布式事务方案\"},{\"text\":\"灰度方案设计\",\"link\":\"/design/灰度方案设计\"},{\"text\":\"接口性能优化方案\",\"link\":\"/design/接口性能优化方案\"},{\"text\":\"秒杀系统架构设计\",\"link\":\"/design/秒杀系统架构设计\"},{\"text\":\"日志系统架构设计\",\"link\":\"/design/日志系统架构设计\"},{\"text\":\"电商业务架构设计\",\"link\":\"/design/电商业务架构设计\"},{\"text\":\"订单系统架构设计\",\"link\":\"/design/订单系统架构设计\"}]}],\"/recatalogue\":[{\"text\":\"参考文献\",\"collapsible\":true,\"items\":[{\"text\":\"高并发系统设计40问-唐扬\",\"link\":\"/book0002/00开篇/00-开篇词-为什么你要学习高并发系统设计？\"},{\"text\":\"如何设计一个秒杀系统-许令波\",\"link\":\"/book0003/如何设计一个秒杀系统-许令波\"}]}],\"/problem\":[{\"text\":\"生产问题排查&复盘\",\"collapsible\":true,\"items\":[{\"text\":\"如何排查线上问题\",\"link\":\"/problem/20220328q1\"},{\"text\":\"服务器端口不通故障解决\",\"link\":\"/problem/20230519q1\"}]}],\"/book0002\":[{\"text\":\"开篇\",\"collapsible\":true,\"items\":[{\"text\":\"00-开篇词-为什么你要学习高并发系统设计？\",\"link\":\"/book0002/00开篇/00-开篇词-为什么你要学习高并发系统设计？\"}]},{\"text\":\"基础\",\"collapsible\":true,\"items\":[{\"text\":\"01-高并发系统：它的通用设计方法是什么？\",\"link\":\"/book0002/01基础/01-高并发系统：它的通用设计方法是什么？\"},{\"text\":\"02-架构分层：我们为什么一定要这么做？\",\"link\":\"/book0002/01基础/02-架构分层：我们为什么一定要这么做？\"},{\"text\":\"03-系统设计目标（一）：如何提升系统性能？\",\"link\":\"/book0002/01基础/03-系统设计目标（一）：如何提升系统性能？\"},{\"text\":\"04-系统设计目标（二）：系统怎样做到高可用？\",\"link\":\"/book0002/01基础/04-系统设计目标（二）：系统怎样做到高可用？\"},{\"text\":\"05-系统设计目标（三）：如何让系统易于扩展？\",\"link\":\"/book0002/01基础/05-系统设计目标（三）：如何让系统易于扩展？\"}]},{\"text\":\"演进 - 数据库篇\",\"collapsible\":true,\"items\":[{\"text\":\"07-池化技术：如何减少频繁创建数据库连接的性能损耗？\",\"link\":\"/book0002/02演进-数据库/07-池化技术：如何减少频繁创建数据库连接的性能损耗？\"},{\"text\":\"08-数据库优化方案（一）：查询请求增加时，如何做主从分离？\",\"link\":\"/book0002/02演进-数据库/08-数据库优化方案（一）：查询请求增加时，如何做主从分离？\"},{\"text\":\"09-数据库优化方案（二）：写入数据量增加时，如何实现分库分表？\",\"link\":\"/book0002/02演进-数据库/09-数据库优化方案（二）：写入数据量增加时，如何实现分库分表？\"},{\"text\":\"10-发号器：如何保证分库分表后ID的全局唯一性？\",\"link\":\"/book0002/02演进-数据库/10-发号器：如何保证分库分表后ID的全局唯一性？\"},{\"text\":\"11-NoSQL：在高并发场景下，数据库和NoSQL如何做到互补？\",\"link\":\"/book0002/02演进-数据库/11-NoSQL：在高并发场景下，数据库和NoSQL如何做到互补？\"}]},{\"text\":\"演进 - 缓存篇\",\"collapsible\":true,\"items\":[{\"text\":\"12-缓存：数据库成为瓶颈后，动态数据的查询要如何加速？\",\"link\":\"/book0002/03演进-缓存/12-缓存：数据库成为瓶颈后，动态数据的查询要如何加速？\"},{\"text\":\"13-缓存的使用姿势（一）：如何选择缓存的读写策略？\",\"link\":\"/book0002/03演进-缓存/13-缓存的使用姿势（一）：如何选择缓存的读写策略？\"},{\"text\":\"14-缓存的使用姿势（二）：缓存如何做到高可用？\",\"link\":\"/book0002/03演进-缓存/14-缓存的使用姿势（二）：缓存如何做到高可用？\"},{\"text\":\"15-缓存的使用姿势（三）：缓存穿透了怎么办？\",\"link\":\"/book0002/03演进-缓存/15-缓存的使用姿势（三）：缓存穿透了怎么办？\"},{\"text\":\"加餐-数据的签约应该如何做？\",\"link\":\"/book0002/03演进-缓存/加餐-数据的签约应该如何做？\"}]},{\"text\":\"演进 - 消息队列篇\",\"collapsible\":true,\"items\":[{\"text\":\"17-消息队列：秒杀如何处理每秒上万的下单请求？\",\"link\":\"/book0002/04演进-消息队列/17-消息队列：秒杀如何处理每秒上万的下单请求？\"},{\"text\":\"18-消息投递：如何保证消息仅仅被消费一次？\",\"link\":\"/book0002/04演进-消息队列/18-消息投递：如何保证消息仅仅被消费一次？\"},{\"text\":\"19-消息队列如何降低消息队列系统中消息的延迟？\",\"link\":\"/book0002/04演进-消息队列/19-消息队列如何降低消息队列系统中消息的延迟？\"},{\"text\":\"20-当问到项目经历时，面试官究竟想要了解什么？\",\"link\":\"/book0002/04演进-消息队列/20-当问到项目经历时，面试官究竟想要了解什么？\"}]},{\"text\":\"演进 - 分布式服务\",\"collapsible\":true,\"items\":[{\"text\":\"21-系统架构：每秒1万次请求的系统要做服务化拆分吗？\",\"link\":\"/book0002/05演进-分布式服务/21-系统架构：每秒1万次请求的系统要做服务化拆分吗？\"},{\"text\":\"22-微服务架构：微服务化后系统架构要如何改造？\",\"link\":\"/book0002/05演进-分布式服务/22-微服务架构：微服务化后系统架构要如何改造？\"},{\"text\":\"23-系统架构：每秒1万次请求的系统要做服务化拆分吗？\",\"link\":\"/book0002/05演进-分布式服务/23-RPC框架：10万QPS下如何实现毫秒级的服务调用？\"},{\"text\":\"24-注册中心：分布式系统如何寻址？\",\"link\":\"/book0002/05演进-分布式服务/24-注册中心：分布式系统如何寻址？\"},{\"text\":\"25-分布式Trace：横跨几十个分布式组件的慢请求要如何排查？\",\"link\":\"/book0002/05演进-分布式服务/25-分布式Trace：横跨几十个分布式组件的慢请求要如何排查？\"},{\"text\":\"26-负载均衡：怎样提升系统的横向扩展能力？\",\"link\":\"/book0002/05演进-分布式服务/26-负载均衡：怎样提升系统的横向扩展能力？\"},{\"text\":\"27-API网关：系统的门面要如何做呢？\",\"link\":\"/book0002/05演进-分布式服务/27-API网关：系统的门面要如何做呢？\"},{\"text\":\"28-多机房部署：跨地域的分布式系统如何做？\",\"link\":\"/book0002/05演进-分布式服务/28-多机房部署：跨地域的分布式系统如何做？\"},{\"text\":\"29-Service Mesh：如何屏蔽服务化系统的服务治理细节？\",\"link\":\"/book0002/05演进-分布式服务/29-Service Mesh：如何屏蔽服务化系统的服务治理细节？\"}]},{\"text\":\"演进 - 维护\",\"collapsible\":true,\"items\":[{\"text\":\"30-为什么你要学习高并发系统设计？\",\"link\":\"/book0002/06演进-维护/30-给系统加上眼睛：服务端监控要怎么做？\"},{\"text\":\"31-应用性能管理：用户的使用体验应该如何监控？\",\"link\":\"/book0002/06演进-维护/31-应用性能管理：用户的使用体验应该如何监控？\"},{\"text\":\"32-压力测试：怎样设计全链路压力测试平台？\",\"link\":\"/book0002/06演进-维护/32-压力测试：怎样设计全链路压力测试平台？\"},{\"text\":\"33-配置管理：成千上万的配置项要如何管理？\",\"link\":\"/book0002/06演进-维护/33-配置管理：成千上万的配置项要如何管理？\"},{\"text\":\"34-降级熔断：如何屏蔽非核心系统故障的影响？\",\"link\":\"/book0002/06演进-维护/34-降级熔断：如何屏蔽非核心系统故障的影响？\"},{\"text\":\"35-流量控制：高并发系统中我们如何操纵流量？\",\"link\":\"/book0002/06演进-维护/35-流量控制：高并发系统中我们如何操纵流量？\"}]},{\"text\":\"实战\",\"collapsible\":true,\"items\":[{\"text\":\"37-计数系统设计（一）：面对海量数据的计数器要如何做？\",\"link\":\"/book0002/07实战/37-计数系统设计（一）：面对海量数据的计数器要如何做？\"},{\"text\":\"38-计数系统设计（二）：50万QPS下如何设计未读数系统？\",\"link\":\"/book0002/07实战/38-计数系统设计（二）：50万QPS下如何设计未读数系统？\"},{\"text\":\"39-信息流设计（一）：通用信息流系统的推模式要如何做？\",\"link\":\"/book0002/07实战/39-信息流设计（一）：通用信息流系统的推模式要如何做？\"},{\"text\":\"40-信息流设计（二）：通用信息流系统的拉模式要如何做？\",\"link\":\"/book0002/07实战/40-信息流设计（二）：通用信息流系统的拉模式要如何做？\"}]},{\"text\":\"结束\",\"collapsible\":true,\"items\":[{\"text\":\"结束语-学不可以已\",\"link\":\"/book0002/08结束/结束语-学不可以已\"}]}],\"/book0003\":[{\"text\":\"如何设计一个秒杀系统\",\"collapsible\":true,\"items\":[{\"text\":\"如何设计一个秒杀系统-许令波\",\"link\":\"/book0003/如何设计一个秒杀系统-许令波\"}]}]}},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}")</script>
    
  </body>
</html>