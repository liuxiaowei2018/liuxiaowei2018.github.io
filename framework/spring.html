<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring | 某不知名小开发</title>
    <meta name="description" content="在线文档">
    <link rel="preload stylesheet" href="/assets/style.edc773f7.css" as="style">
    
    <script type="module" src="/assets/app.75f2b3d2.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.8048b864.js">
    <link rel="modulepreload" href="/assets/chunks/theme.f5b741e0.js">
    <link rel="modulepreload" href="/assets/framework_spring.md.35ad7748.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5a346dfe><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-5a346dfe data-v-ae24b3ad><div class="VPNavBar has-sidebar" data-v-ae24b3ad data-v-a0fd61f4><div class="container" data-v-a0fd61f4><div class="title" data-v-a0fd61f4><div class="VPNavBarTitle has-sidebar" data-v-a0fd61f4 data-v-86d1bed8><a class="title" href="/" data-v-86d1bed8><!--[--><!--]--><!--[--><img class="VPImage logo" src="/logo.png" alt data-v-8426fc1a><!--]--><!--[-->TheWe1<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-a0fd61f4><div class="curtain" data-v-a0fd61f4></div><div class="content-body" data-v-a0fd61f4><!--[--><!--]--><div class="VPNavBarSearch search" data-v-a0fd61f4><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-a0fd61f4 data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/updated/index.html" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>更新日志</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-9c007e85><span class="text" data-v-9c007e85><!----><span data-v-9c007e85>大数据</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-9c007e85><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/bigdata/path.html" data-v-43f1e123><!--[-->大数据学习路线<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/bigdata/layering.html" data-v-43f1e123><!--[-->数仓分层设计架构<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-9c007e85><span class="text" data-v-9c007e85><!----><span data-v-9c007e85>算法</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-9c007e85><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/alg/structure/%E6%95%B0%E7%BB%84%E4%B8%8E%E9%93%BE%E8%A1%A8.html" data-v-43f1e123><!--[-->数据结构<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/alg/algorithm/%E5%A4%8D%E6%9D%82%E5%BA%A6.html" data-v-43f1e123><!--[-->Java算法<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/alg/topic/%E5%89%91%E6%8C%87Offer/index.html" data-v-43f1e123><!--[-->剑指Offer<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link vp-external-link-icon" href="https://www.baidu.com" target="_blank" rel="noreferrer" data-v-43f1e123><!--[-->LeetCode<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-9c007e85><span class="text" data-v-9c007e85><!----><span data-v-9c007e85>经验</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-9c007e85><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/problem/20220328q1.html" data-v-43f1e123><!--[-->生产问题排查<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/utils/index.html" data-v-43f1e123><!--[-->常用工具类库<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-9c007e85><span class="text" data-v-9c007e85><!----><span data-v-9c007e85>文献</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-9c007e85><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/books/book0001/index.html" data-v-43f1e123><!--[-->如何设计一个秒杀系统<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/books/book0002/00%E5%BC%80%E7%AF%87/index.html" data-v-43f1e123><!--[-->高并发系统设计40问<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-a0fd61f4 data-v-e6aabb21><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-e6aabb21 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-a0fd61f4 data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/liuxiaowei2018" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-f80f8133><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-a0fd61f4 data-v-40855f84 data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-9c007e85><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-9c007e85><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-40855f84><div class="item appearance" data-v-40855f84><p class="label" data-v-40855f84>Appearance</p><div class="appearance-action" data-v-40855f84><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-40855f84 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-40855f84><div class="item social-links" data-v-40855f84><div class="VPSocialLinks social-links-list" data-v-40855f84 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/liuxiaowei2018" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-f80f8133><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-a0fd61f4 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav reached-top" data-v-5a346dfe data-v-79c8c1df><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-79c8c1df><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-79c8c1df><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-79c8c1df>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-79c8c1df data-v-1c15a60a><button data-v-1c15a60a>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-5a346dfe data-v-b00e2fdd><div class="curtain" data-v-b00e2fdd></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-b00e2fdd><span class="visually-hidden" id="sidebar-aria-label" data-v-b00e2fdd> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 has-active" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>spring框架</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/framework/spring.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>spring</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/framework/springBoot.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>springBoot</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/framework/springCloud.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>springCloud</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5a346dfe data-v-669faec9><div class="VPDoc has-sidebar has-aside" data-v-669faec9 data-v-6b87e69f><!--[--><!--]--><div class="container" data-v-6b87e69f><div class="aside" data-v-6b87e69f><div class="aside-curtain" data-v-6b87e69f></div><div class="aside-container" data-v-6b87e69f><div class="aside-content" data-v-6b87e69f><div class="VPDocAside" data-v-6b87e69f data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-3f215769 data-v-d330b1bb><div class="content" data-v-d330b1bb><div class="outline-marker" data-v-d330b1bb></div><div class="outline-title" role="heading" aria-level="2" data-v-d330b1bb>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-d330b1bb><span class="visually-hidden" id="doc-outline-aria-label" data-v-d330b1bb> Table of Contents for current page </span><ul class="root" data-v-d330b1bb data-v-d0ee3533><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-6b87e69f><div class="content-container" data-v-6b87e69f><!--[--><!--]--><!----><main class="main" data-v-6b87e69f><div style="position:relative;" class="vp-doc _framework_spring" data-v-6b87e69f><div><h1 id="spring" tabindex="-1">Spring <a class="header-anchor" href="#spring" aria-label="Permalink to &quot;Spring&quot;">​</a></h1><nav class="table-of-contents"><ul><li><a href="#原理篇">原理篇</a><ul><li><a href="#spring-ioc">Spring IOC</a></li><li><a href="#spring-di">Spring DI</a></li><li><a href="#spring-bean加载">Spring Bean加载</a></li><li><a href="#bean-生命周期">Bean 生命周期</a></li><li><a href="#spring-aop">Spring AOP</a></li><li><a href="#spring-transaction">Spring Transaction</a></li><li><a href="#spring-循环依赖">Spring 循环依赖</a></li><li><a href="#spring-mvc">Spring MVC</a></li><li><a href="#spring-设计模式">Spring 设计模式</a></li></ul></li><li><a href="#组件篇">组件篇</a><ul><li><a href="#resource">Resource</a></li><li><a href="#beanfactory">BeanFactory</a></li><li><a href="#beandefinition">BeanDefinition</a></li><li><a href="#beanpostprocessor">BeanPostProcessor</a></li><li><a href="#initializingbean">InitializingBean</a></li><li><a href="#applicationcontext">ApplicationContext</a></li></ul></li><li><a href="#问题篇">问题篇</a><ul><li><a href="#jdk-cglib-动态代理">JDK &amp;CGLIB 动态代理</a></li><li><a href="#aop-切面编程">AOP 切面编程</a></li></ul></li><li><a href="#应用篇">应用篇</a><ul><li><a href="#springtask">SpringTask</a></li><li><a href="#stopwatch">StopWatch</a></li><li><a href="#springasync">SpringAsync</a></li><li><a href="#springretry">SpringRetry</a></li></ul></li></ul></nav><h2 id="原理篇" tabindex="-1">原理篇 <a class="header-anchor" href="#原理篇" aria-label="Permalink to &quot;原理篇&quot;">​</a></h2><h3 id="spring-ioc" tabindex="-1">Spring IOC <a class="header-anchor" href="#spring-ioc" aria-label="Permalink to &quot;Spring IOC&quot;">​</a></h3><blockquote><p>IoC ，就是<code>由 Spring IoC 容器来负责对象的生命周期和对象之间的关系</code></p><p>推荐文档: <a href="https://www.zhihu.com/question/23277575/answer/169698662" target="_blank" rel="noreferrer">https://www.zhihu.com/question/23277575/answer/169698662</a></p></blockquote><blockquote><p>转移创建对象的控制权，将创建对象的控制权从开发者转移到了 Spring 框架</p><p><img src="/assets/image-20220512203238024.ecc6ad3a.png" alt="image-20220512203238024"></p><p>在没有引入 IoC 的时候，被注入的对象直接依赖于被依赖的对象，有了 IoC 后，两者及其他们的关系都是通过 Ioc Service Provider 来统一管理维护的。被注入的对象需要什么，直接跟 IoC Service Provider 打声招呼，后者就会把相应的被依赖对象注入到被注入的对象中，从而达到 IoC Service Provider 为被注入对象服务的目的。</p><p>IoC 主要由 <code>spring-beans</code> 和 <code>spring-context</code> 项目，进行实现。</p></blockquote><h3 id="spring-di" tabindex="-1">Spring DI <a class="header-anchor" href="#spring-di" aria-label="Permalink to &quot;Spring DI&quot;">​</a></h3><blockquote><p>IoC Service Provider 为被注入对象提供被依赖对象也有如下几种方式：</p><p><strong>构造方法注入</strong>、<strong>stter方法注入</strong>、<strong>接口注入</strong> 从形式上分为：</p><p><strong>通过 xml 的注入方式、基于注解的注入方式</strong></p></blockquote><h6 id="构造器注入" tabindex="-1">构造器注入 <a class="header-anchor" href="#构造器注入" aria-label="Permalink to &quot;构造器注入&quot;">​</a></h6><blockquote><p>构造器注入，顾名思义就是被注入的对象通过在其构造方法中声明依赖对象的参数列表，让外部知道它需要哪些依赖对象。</p></blockquote><h6 id="setter-注入" tabindex="-1">setter 注入 <a class="header-anchor" href="#setter-注入" aria-label="Permalink to &quot;setter 注入&quot;">​</a></h6><blockquote><p>对于 JavaBean 对象而言，我们一般都是通过 getter 和 setter 方法来访问和设置对象的属性。所以，当前对象只需要为其所依赖的对象提供相对应的 setter 方法，通过该方法将相应的依赖对象设置到被注入对象中。</p></blockquote><h6 id="接口注入" tabindex="-1">接口注入 <a class="header-anchor" href="#接口注入" aria-label="Permalink to &quot;接口注入&quot;">​</a></h6><blockquote><p>它是在一个接口中定义需要注入的信息，并通过接口完成注入。</p></blockquote><h3 id="spring-bean加载" tabindex="-1">Spring Bean加载 <a class="header-anchor" href="#spring-bean加载" aria-label="Permalink to &quot;Spring Bean加载&quot;">​</a></h3><p><img src="/assets/image-20230202140324462.9af5682c.png" alt="image-20230202140324462"></p><p>Spring IoC 容器 以某种方式加载 Configuration Metadata，将其解析注册到容器内部，然后回根据这些信息绑定整个系统的对象，最终组装成一个可用的基于轻量级容器的应用系统。</p><p>Spring 在实现上述功能中，将整个流程分为两个阶段：容器初始化阶段和加载bean 阶段。分别如下：</p><p>1.容器初始化阶段</p><ul><li><p>首先，通过某种方式加载 Configuration Metadata (主要是依据 Resource、ResourceLoader 两个体系) 。</p></li><li><p>然后，容器会对加载的 Configuration MetaData 进行解析和分析，并将分析的信息组装成 BeanDefinition 。</p></li><li><p>最后，将 BeanDefinition 保存注册到相应的 BeanDefinitionRegistry 中。</p></li><li><p>至此，Spring IoC 的初始化工作完成。</p></li></ul><p>2.加载 Bean 阶段</p><ul><li>经过容器初始化阶段后，应用程序中定义的 bean 信息已经全部加载到系统中了，当我们显示或者隐式地调用 <code>BeanFactory#getBean(...)</code> 方法时，则会触发加载 Bean 阶段。</li><li>在这阶段，容器会首先检查所请求的对象是否已经初始化完成了，如果没有，则会根据注册的 Bean 信息实例化请求的对象，并为其注册依赖，然后将其返回给请求方。</li><li>至此第二个阶段也已经完成</li></ul><h4 id="getbean" tabindex="-1">getBean() <a class="header-anchor" href="#getbean" aria-label="Permalink to &quot;getBean()&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Object </span><span style="color:#B392F0;">getBean</span><span style="color:#E1E4E8;">(String name) throws BeansException {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">doGetBean</span><span style="color:#E1E4E8;">(name, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Object </span><span style="color:#6F42C1;">getBean</span><span style="color:#24292E;">(String name) throws BeansException {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">doGetBean</span><span style="color:#24292E;">(name, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li>内部调用 <code>doGetBean(String name, final Class&lt;T&gt; requiredType, Object[] args, boolean typeCheckOnly)</code> 方法，其接受四个方法参数： <ul><li><code>name</code> ：要获取 Bean 的名字</li><li><code>requiredType</code> ：要获取 bean 的类型</li><li><code>args</code> ：创建 Bean 时传递的参数。这个参数仅限于创建 Bean 时使用。</li><li><code>typeCheckOnly</code> ：是否为类型检查。</li></ul></li></ul><h4 id="dogetbean" tabindex="-1">doGetBean() <a class="header-anchor" href="#dogetbean" aria-label="Permalink to &quot;doGetBean()&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">T</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> T </span><span style="color:#B392F0;">doGetBean</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> String name, @</span><span style="color:#F97583;">Nullable</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Class</span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">T</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> requiredType,</span></span>
<span class="line"><span style="color:#E1E4E8;">        @</span><span style="color:#F97583;">Nullable</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">[] args, </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> typeCheckOnly) throws BeansException {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;1&gt; 返回 bean 名称，剥离工厂引用前缀。</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 如果 name 是 alias ，则获取对应映射的 beanName 。</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> String beanName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">transformedBeanName</span><span style="color:#E1E4E8;">(name);</span></span>
<span class="line"><span style="color:#E1E4E8;">    Object bean;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 从缓存中或者实例工厂中获取 Bean 对象</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// Eagerly check singleton cache for manually registered singletons.</span></span>
<span class="line"><span style="color:#E1E4E8;">    Object sharedInstance </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getSingleton</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (sharedInstance </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> args </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (logger.</span><span style="color:#B392F0;">isTraceEnabled</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">isSingletonCurrentlyInCreation</span><span style="color:#E1E4E8;">(beanName)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                logger.</span><span style="color:#B392F0;">trace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Returning eagerly cached instance of singleton bean &#39;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> beanName </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&quot;&#39; that is not fully initialized yet - a consequence of a circular reference&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                logger.</span><span style="color:#B392F0;">trace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Returning cached instance of singleton bean &#39;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> beanName </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&#39;&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// &lt;2&gt; 完成 FactoryBean 的相关处理，并用来获取 FactoryBean 的处理结果</span></span>
<span class="line"><span style="color:#E1E4E8;">        bean </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getObjectForBeanInstance</span><span style="color:#E1E4E8;">(sharedInstance, name, beanName, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// Fail if we&#39;re already creating this bean instance:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// We&#39;re assumably within a circular reference.</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// &lt;3&gt; 因为 Spring 只解决单例模式下得循环依赖，在原型模式下如果存在循环依赖则会抛出异常。</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">isPrototypeCurrentlyInCreation</span><span style="color:#E1E4E8;">(beanName)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanCurrentlyInCreationException</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// &lt;4&gt; 如果容器中没有找到，则从父类容器中加载</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// Check if bean definition exists in this factory.</span></span>
<span class="line"><span style="color:#E1E4E8;">        BeanFactory parentBeanFactory </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getParentBeanFactory</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (parentBeanFactory </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!</span><span style="color:#B392F0;">containsBeanDefinition</span><span style="color:#E1E4E8;">(beanName)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// Not found -&gt; check parent.</span></span>
<span class="line"><span style="color:#E1E4E8;">            String nameToLookup </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">originalBeanName</span><span style="color:#E1E4E8;">(name);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (parentBeanFactory </span><span style="color:#F97583;">instanceof</span><span style="color:#E1E4E8;"> AbstractBeanFactory) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> ((AbstractBeanFactory) parentBeanFactory).</span><span style="color:#B392F0;">doGetBean</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">                        nameToLookup, requiredType, args, typeCheckOnly);</span></span>
<span class="line"><span style="color:#E1E4E8;">            } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (args </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// Delegation to parent with explicit args.</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> (T) parentBeanFactory.</span><span style="color:#B392F0;">getBean</span><span style="color:#E1E4E8;">(nameToLookup, args);</span></span>
<span class="line"><span style="color:#E1E4E8;">            } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (requiredType </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// No args -&gt; delegate to standard getBean method.</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> parentBeanFactory.</span><span style="color:#B392F0;">getBean</span><span style="color:#E1E4E8;">(nameToLookup, requiredType);</span></span>
<span class="line"><span style="color:#E1E4E8;">            } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> (T) parentBeanFactory.</span><span style="color:#B392F0;">getBean</span><span style="color:#E1E4E8;">(nameToLookup);</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// &lt;5&gt; 如果不是仅仅做类型检查则是创建bean，这里需要记录</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">typeCheckOnly) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">markBeanAsCreated</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// &lt;6&gt; 从容器中获取 beanName 相应的 GenericBeanDefinition 对象，并将其转换为 RootBeanDefinition 对象</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> RootBeanDefinition mbd </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getMergedLocalBeanDefinition</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 检查给定的合并的 BeanDefinition</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">checkMergedBeanDefinition</span><span style="color:#E1E4E8;">(mbd, beanName, args);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// Guarantee initialization of beans that the current bean depends on.</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// &lt;7&gt; 处理所依赖的 bean</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] dependsOn </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> mbd.</span><span style="color:#B392F0;">getDependsOn</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (dependsOn </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (String dep </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> dependsOn) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 若给定的依赖 bean 已经注册为依赖给定的 bean</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 循环依赖的情况</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">isDependent</span><span style="color:#E1E4E8;">(beanName, dep)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanCreationException</span><span style="color:#E1E4E8;">(mbd.</span><span style="color:#B392F0;">getResourceDescription</span><span style="color:#E1E4E8;">(), beanName,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#9ECBFF;">&quot;Circular depends-on relationship between &#39;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> beanName </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&#39; and &#39;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> dep </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&#39;&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    }</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 缓存依赖调用</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">registerDependentBean</span><span style="color:#E1E4E8;">(dep, beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#B392F0;">getBean</span><span style="color:#E1E4E8;">(dep);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (NoSuchBeanDefinitionException </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanCreationException</span><span style="color:#E1E4E8;">(mbd.</span><span style="color:#B392F0;">getResourceDescription</span><span style="color:#E1E4E8;">(), beanName,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#9ECBFF;">&quot;&#39;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> beanName </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&#39; depends on missing bean &#39;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> dep </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&#39;&quot;</span><span style="color:#E1E4E8;">, ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    }</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// &lt;8&gt; bean 实例化</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// Create bean instance.</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (mbd.</span><span style="color:#B392F0;">isSingleton</span><span style="color:#E1E4E8;">()) { </span><span style="color:#6A737D;">// 单例模式</span></span>
<span class="line"><span style="color:#E1E4E8;">                sharedInstance </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getSingleton</span><span style="color:#E1E4E8;">(beanName, () </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">createBean</span><span style="color:#E1E4E8;">(beanName, mbd, args);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    }</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (BeansException </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#6A737D;">// Explicitly remove instance from singleton cache: It might have been put there</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#6A737D;">// eagerly by the creation process, to allow for circular reference resolution.</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#6A737D;">// Also remove any beans that received a temporary reference to the bean.</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#6A737D;">// 显式从单例缓存中删除 Bean 实例</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#6A737D;">// 因为单例模式下为了解决循环依赖，可能他已经存在了，所以销毁它。 TODO 芋艿</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#B392F0;">destroySingleton</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> ex;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    }</span></span>
<span class="line"><span style="color:#E1E4E8;">                });</span></span>
<span class="line"><span style="color:#E1E4E8;">                bean </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getObjectForBeanInstance</span><span style="color:#E1E4E8;">(sharedInstance, name, beanName, mbd);</span></span>
<span class="line"><span style="color:#E1E4E8;">            } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (mbd.</span><span style="color:#B392F0;">isPrototype</span><span style="color:#E1E4E8;">()) { </span><span style="color:#6A737D;">// 原型模式</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// It&#39;s a prototype -&gt; create a new instance.</span></span>
<span class="line"><span style="color:#E1E4E8;">                Object prototypeInstance;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">beforePrototypeCreation</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    prototypeInstance </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">createBean</span><span style="color:#E1E4E8;">(beanName, mbd, args);</span></span>
<span class="line"><span style="color:#E1E4E8;">                } </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">afterPrototypeCreation</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">                bean </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getObjectForBeanInstance</span><span style="color:#E1E4E8;">(prototypeInstance, name, beanName, mbd);</span></span>
<span class="line"><span style="color:#E1E4E8;">            } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 从指定的 scope 下创建 bean</span></span>
<span class="line"><span style="color:#E1E4E8;">                String scopeName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> mbd.</span><span style="color:#B392F0;">getScope</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Scope scope </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.scopes.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(scopeName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (scope </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IllegalStateException</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;No Scope registered for scope name &#39;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> scopeName </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&#39;&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    Object scopedInstance </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> scope.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(beanName, () </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#B392F0;">beforePrototypeCreation</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">createBean</span><span style="color:#E1E4E8;">(beanName, mbd, args);</span></span>
<span class="line"><span style="color:#E1E4E8;">                        } </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#B392F0;">afterPrototypeCreation</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                        }</span></span>
<span class="line"><span style="color:#E1E4E8;">                    });</span></span>
<span class="line"><span style="color:#E1E4E8;">                    bean </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getObjectForBeanInstance</span><span style="color:#E1E4E8;">(scopedInstance, name, beanName, mbd);</span></span>
<span class="line"><span style="color:#E1E4E8;">                } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (IllegalStateException </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanCreationException</span><span style="color:#E1E4E8;">(beanName,</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#9ECBFF;">&quot;Scope &#39;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> scopeName </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&#39; is not active for the current thread; consider &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#9ECBFF;">&quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                            ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (BeansException </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">cleanupAfterBeanCreationFailure</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> ex;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;9&gt; 检查需要的类型是否符合 bean 的实际类型</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// Check if required type matches the type of the actual bean instance.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (requiredType </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">requiredType.</span><span style="color:#B392F0;">isInstance</span><span style="color:#E1E4E8;">(bean)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            T convertedBean </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getTypeConverter</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">convertIfNecessary</span><span style="color:#E1E4E8;">(bean, requiredType);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (convertedBean </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanNotOfRequiredTypeException</span><span style="color:#E1E4E8;">(name, requiredType, bean.</span><span style="color:#B392F0;">getClass</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> convertedBean;</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (TypeMismatchException </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (logger.</span><span style="color:#B392F0;">isTraceEnabled</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                logger.</span><span style="color:#B392F0;">trace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Failed to convert bean &#39;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> name </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&#39; to required type &#39;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                        ClassUtils.</span><span style="color:#B392F0;">getQualifiedName</span><span style="color:#E1E4E8;">(requiredType) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&#39;&quot;</span><span style="color:#E1E4E8;">, ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanNotOfRequiredTypeException</span><span style="color:#E1E4E8;">(name, requiredType, bean.</span><span style="color:#B392F0;">getClass</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> (T) bean;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">T</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> T </span><span style="color:#6F42C1;">doGetBean</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String name, @</span><span style="color:#D73A49;">Nullable</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Class</span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">T</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> requiredType,</span></span>
<span class="line"><span style="color:#24292E;">        @</span><span style="color:#D73A49;">Nullable</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">[] args, </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> typeCheckOnly) throws BeansException {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;1&gt; 返回 bean 名称，剥离工厂引用前缀。</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 如果 name 是 alias ，则获取对应映射的 beanName 。</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String beanName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">transformedBeanName</span><span style="color:#24292E;">(name);</span></span>
<span class="line"><span style="color:#24292E;">    Object bean;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 从缓存中或者实例工厂中获取 Bean 对象</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// Eagerly check singleton cache for manually registered singletons.</span></span>
<span class="line"><span style="color:#24292E;">    Object sharedInstance </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getSingleton</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (sharedInstance </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> args </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (logger.</span><span style="color:#6F42C1;">isTraceEnabled</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">isSingletonCurrentlyInCreation</span><span style="color:#24292E;">(beanName)) {</span></span>
<span class="line"><span style="color:#24292E;">                logger.</span><span style="color:#6F42C1;">trace</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Returning eagerly cached instance of singleton bean &#39;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> beanName </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&quot;&#39; that is not fully initialized yet - a consequence of a circular reference&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                logger.</span><span style="color:#6F42C1;">trace</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Returning cached instance of singleton bean &#39;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> beanName </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&#39;&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// &lt;2&gt; 完成 FactoryBean 的相关处理，并用来获取 FactoryBean 的处理结果</span></span>
<span class="line"><span style="color:#24292E;">        bean </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getObjectForBeanInstance</span><span style="color:#24292E;">(sharedInstance, name, beanName, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// Fail if we&#39;re already creating this bean instance:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// We&#39;re assumably within a circular reference.</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// &lt;3&gt; 因为 Spring 只解决单例模式下得循环依赖，在原型模式下如果存在循环依赖则会抛出异常。</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">isPrototypeCurrentlyInCreation</span><span style="color:#24292E;">(beanName)) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanCurrentlyInCreationException</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// &lt;4&gt; 如果容器中没有找到，则从父类容器中加载</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// Check if bean definition exists in this factory.</span></span>
<span class="line"><span style="color:#24292E;">        BeanFactory parentBeanFactory </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getParentBeanFactory</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (parentBeanFactory </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!</span><span style="color:#6F42C1;">containsBeanDefinition</span><span style="color:#24292E;">(beanName)) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// Not found -&gt; check parent.</span></span>
<span class="line"><span style="color:#24292E;">            String nameToLookup </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">originalBeanName</span><span style="color:#24292E;">(name);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (parentBeanFactory </span><span style="color:#D73A49;">instanceof</span><span style="color:#24292E;"> AbstractBeanFactory) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> ((AbstractBeanFactory) parentBeanFactory).</span><span style="color:#6F42C1;">doGetBean</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                        nameToLookup, requiredType, args, typeCheckOnly);</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (args </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// Delegation to parent with explicit args.</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> (T) parentBeanFactory.</span><span style="color:#6F42C1;">getBean</span><span style="color:#24292E;">(nameToLookup, args);</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (requiredType </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// No args -&gt; delegate to standard getBean method.</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> parentBeanFactory.</span><span style="color:#6F42C1;">getBean</span><span style="color:#24292E;">(nameToLookup, requiredType);</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> (T) parentBeanFactory.</span><span style="color:#6F42C1;">getBean</span><span style="color:#24292E;">(nameToLookup);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// &lt;5&gt; 如果不是仅仅做类型检查则是创建bean，这里需要记录</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">typeCheckOnly) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">markBeanAsCreated</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// &lt;6&gt; 从容器中获取 beanName 相应的 GenericBeanDefinition 对象，并将其转换为 RootBeanDefinition 对象</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> RootBeanDefinition mbd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getMergedLocalBeanDefinition</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 检查给定的合并的 BeanDefinition</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">checkMergedBeanDefinition</span><span style="color:#24292E;">(mbd, beanName, args);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// Guarantee initialization of beans that the current bean depends on.</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// &lt;7&gt; 处理所依赖的 bean</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] dependsOn </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> mbd.</span><span style="color:#6F42C1;">getDependsOn</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (dependsOn </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (String dep </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> dependsOn) {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 若给定的依赖 bean 已经注册为依赖给定的 bean</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 循环依赖的情况</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">isDependent</span><span style="color:#24292E;">(beanName, dep)) {</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanCreationException</span><span style="color:#24292E;">(mbd.</span><span style="color:#6F42C1;">getResourceDescription</span><span style="color:#24292E;">(), beanName,</span></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#032F62;">&quot;Circular depends-on relationship between &#39;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> beanName </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&#39; and &#39;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> dep </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&#39;&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                    }</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 缓存依赖调用</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">registerDependentBean</span><span style="color:#24292E;">(dep, beanName);</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#6F42C1;">getBean</span><span style="color:#24292E;">(dep);</span></span>
<span class="line"><span style="color:#24292E;">                    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (NoSuchBeanDefinitionException </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanCreationException</span><span style="color:#24292E;">(mbd.</span><span style="color:#6F42C1;">getResourceDescription</span><span style="color:#24292E;">(), beanName,</span></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#032F62;">&quot;&#39;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> beanName </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&#39; depends on missing bean &#39;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> dep </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&#39;&quot;</span><span style="color:#24292E;">, ex);</span></span>
<span class="line"><span style="color:#24292E;">                    }</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// &lt;8&gt; bean 实例化</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// Create bean instance.</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (mbd.</span><span style="color:#6F42C1;">isSingleton</span><span style="color:#24292E;">()) { </span><span style="color:#6A737D;">// 单例模式</span></span>
<span class="line"><span style="color:#24292E;">                sharedInstance </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getSingleton</span><span style="color:#24292E;">(beanName, () </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">createBean</span><span style="color:#24292E;">(beanName, mbd, args);</span></span>
<span class="line"><span style="color:#24292E;">                    }</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (BeansException </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#6A737D;">// Explicitly remove instance from singleton cache: It might have been put there</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#6A737D;">// eagerly by the creation process, to allow for circular reference resolution.</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#6A737D;">// Also remove any beans that received a temporary reference to the bean.</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#6A737D;">// 显式从单例缓存中删除 Bean 实例</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#6A737D;">// 因为单例模式下为了解决循环依赖，可能他已经存在了，所以销毁它。 TODO 芋艿</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#6F42C1;">destroySingleton</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> ex;</span></span>
<span class="line"><span style="color:#24292E;">                    }</span></span>
<span class="line"><span style="color:#24292E;">                });</span></span>
<span class="line"><span style="color:#24292E;">                bean </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getObjectForBeanInstance</span><span style="color:#24292E;">(sharedInstance, name, beanName, mbd);</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (mbd.</span><span style="color:#6F42C1;">isPrototype</span><span style="color:#24292E;">()) { </span><span style="color:#6A737D;">// 原型模式</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// It&#39;s a prototype -&gt; create a new instance.</span></span>
<span class="line"><span style="color:#24292E;">                Object prototypeInstance;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">beforePrototypeCreation</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">                    prototypeInstance </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">createBean</span><span style="color:#24292E;">(beanName, mbd, args);</span></span>
<span class="line"><span style="color:#24292E;">                } </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">afterPrototypeCreation</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">                bean </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getObjectForBeanInstance</span><span style="color:#24292E;">(prototypeInstance, name, beanName, mbd);</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 从指定的 scope 下创建 bean</span></span>
<span class="line"><span style="color:#24292E;">                String scopeName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> mbd.</span><span style="color:#6F42C1;">getScope</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Scope scope </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.scopes.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(scopeName);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (scope </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IllegalStateException</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;No Scope registered for scope name &#39;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> scopeName </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&#39;&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                }</span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                    Object scopedInstance </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> scope.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(beanName, () </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#6F42C1;">beforePrototypeCreation</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">createBean</span><span style="color:#24292E;">(beanName, mbd, args);</span></span>
<span class="line"><span style="color:#24292E;">                        } </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#6F42C1;">afterPrototypeCreation</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">                        }</span></span>
<span class="line"><span style="color:#24292E;">                    });</span></span>
<span class="line"><span style="color:#24292E;">                    bean </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getObjectForBeanInstance</span><span style="color:#24292E;">(scopedInstance, name, beanName, mbd);</span></span>
<span class="line"><span style="color:#24292E;">                } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (IllegalStateException </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanCreationException</span><span style="color:#24292E;">(beanName,</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#032F62;">&quot;Scope &#39;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> scopeName </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&#39; is not active for the current thread; consider &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#032F62;">&quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                            ex);</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (BeansException </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">cleanupAfterBeanCreationFailure</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> ex;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;9&gt; 检查需要的类型是否符合 bean 的实际类型</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// Check if required type matches the type of the actual bean instance.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (requiredType </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!</span><span style="color:#24292E;">requiredType.</span><span style="color:#6F42C1;">isInstance</span><span style="color:#24292E;">(bean)) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            T convertedBean </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getTypeConverter</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">convertIfNecessary</span><span style="color:#24292E;">(bean, requiredType);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (convertedBean </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanNotOfRequiredTypeException</span><span style="color:#24292E;">(name, requiredType, bean.</span><span style="color:#6F42C1;">getClass</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> convertedBean;</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (TypeMismatchException </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (logger.</span><span style="color:#6F42C1;">isTraceEnabled</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">                logger.</span><span style="color:#6F42C1;">trace</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Failed to convert bean &#39;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> name </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&#39; to required type &#39;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                        ClassUtils.</span><span style="color:#6F42C1;">getQualifiedName</span><span style="color:#24292E;">(requiredType) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&#39;&quot;</span><span style="color:#24292E;">, ex);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanNotOfRequiredTypeException</span><span style="color:#24292E;">(name, requiredType, bean.</span><span style="color:#6F42C1;">getClass</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> (T) bean;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h5 id="transformedbeanname-name" tabindex="-1">transformedBeanName(name) <a class="header-anchor" href="#transformedbeanname-name" aria-label="Permalink to &quot;transformedBeanName(name)&quot;">​</a></h5><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> String beanName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">transformedBeanName</span><span style="color:#E1E4E8;">(name);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String beanName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">transformedBeanName</span><span style="color:#24292E;">(name);</span></span></code></pre></div><ul><li><p>这里传递的是 <code>name</code> 方法，不一定就是 beanName，可能是 aliasName ，也有可能是 FactoryBean ，所以这里需要调用 <code>#transformedBeanName(String name)</code> 方法，对 <code>name</code> 进行一番转换。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> String </span><span style="color:#B392F0;">transformedBeanName</span><span style="color:#E1E4E8;">(String name) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">canonicalName</span><span style="color:#E1E4E8;">(BeanFactoryUtils.</span><span style="color:#B392F0;">transformedBeanName</span><span style="color:#E1E4E8;">(name));</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> String </span><span style="color:#6F42C1;">transformedBeanName</span><span style="color:#24292E;">(String name) {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">canonicalName</span><span style="color:#24292E;">(BeanFactoryUtils.</span><span style="color:#6F42C1;">transformedBeanName</span><span style="color:#24292E;">(name));</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>1.调用 <code>BeanFactoryUtils#transformedBeanName(String name)</code> 方法，去除 FactoryBean 的修饰符。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// BeanFactoryUtils.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Cache from name with factory bean prefix to stripped name without dereference.</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 缓存 {</span><span style="color:#F97583;">@link</span><span style="color:#6A737D;"> #</span><span style="color:#FFAB70;">transformedBeanName(String)</span><span style="color:#6A737D;">} 已经转换好的结果。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@since</span><span style="color:#6A737D;"> 5.1</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@see</span><span style="color:#6A737D;"> BeanFactory#FACTORY_BEAN_PREFIX</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Map&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; transformedBeanNameCache </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> ConcurrentHashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 去除 FactoryBean 的修饰符 &amp;</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 如果 name 以 “&amp;” 为前缀，那么会去掉该 &quot;&amp;&quot; 。</span></span>
<span class="line"><span style="color:#6A737D;"> * 例如，name = &quot;&amp;studentService&quot; ，则会是 name = &quot;studentService&quot;。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * Return the actual bean name, stripping out the factory dereference</span></span>
<span class="line"><span style="color:#6A737D;"> * prefix (if any, also stripping repeated factory prefixes if found).</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@param</span><span style="color:#6A737D;"> </span><span style="color:#FFAB70;">name</span><span style="color:#6A737D;"> the name of the bean</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@return</span><span style="color:#6A737D;"> the transformed name</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@see</span><span style="color:#6A737D;"> BeanFactory#FACTORY_BEAN_PREFIX</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> String </span><span style="color:#B392F0;">transformedBeanName</span><span style="color:#E1E4E8;">(String name) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    Assert.</span><span style="color:#B392F0;">notNull</span><span style="color:#E1E4E8;">(name, </span><span style="color:#9ECBFF;">&quot;&#39;name&#39; must not be null&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">name.</span><span style="color:#B392F0;">startsWith</span><span style="color:#E1E4E8;">(BeanFactory.FACTORY_BEAN_PREFIX)) { </span><span style="color:#6A737D;">// BeanFactory.FACTORY_BEAN_PREFIX = $</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> name;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// computeIfAbsent 方法，分成两种情况：</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">//      1. 未存在，则进行计算执行，并将结果添加到缓存、</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">//      2. 已存在，则直接返回，无需计算。</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> transformedBeanNameCache.</span><span style="color:#B392F0;">computeIfAbsent</span><span style="color:#E1E4E8;">(name, beanName </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            beanName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> beanName.</span><span style="color:#B392F0;">substring</span><span style="color:#E1E4E8;">(BeanFactory.FACTORY_BEAN_PREFIX.</span><span style="color:#B392F0;">length</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> (beanName.</span><span style="color:#B392F0;">startsWith</span><span style="color:#E1E4E8;">(BeanFactory.FACTORY_BEAN_PREFIX));</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> beanName;</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// BeanFactoryUtils.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Cache from name with factory bean prefix to stripped name without dereference.</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 缓存 {</span><span style="color:#D73A49;">@link</span><span style="color:#6A737D;"> #</span><span style="color:#E36209;">transformedBeanName(String)</span><span style="color:#6A737D;">} 已经转换好的结果。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@since</span><span style="color:#6A737D;"> 5.1</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@see</span><span style="color:#6A737D;"> BeanFactory#FACTORY_BEAN_PREFIX</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; transformedBeanNameCache </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> ConcurrentHashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 去除 FactoryBean 的修饰符 &amp;</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 如果 name 以 “&amp;” 为前缀，那么会去掉该 &quot;&amp;&quot; 。</span></span>
<span class="line"><span style="color:#6A737D;"> * 例如，name = &quot;&amp;studentService&quot; ，则会是 name = &quot;studentService&quot;。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * Return the actual bean name, stripping out the factory dereference</span></span>
<span class="line"><span style="color:#6A737D;"> * prefix (if any, also stripping repeated factory prefixes if found).</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@param</span><span style="color:#6A737D;"> </span><span style="color:#E36209;">name</span><span style="color:#6A737D;"> the name of the bean</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@return</span><span style="color:#6A737D;"> the transformed name</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@see</span><span style="color:#6A737D;"> BeanFactory#FACTORY_BEAN_PREFIX</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> String </span><span style="color:#6F42C1;">transformedBeanName</span><span style="color:#24292E;">(String name) {</span></span>
<span class="line"><span style="color:#24292E;">    Assert.</span><span style="color:#6F42C1;">notNull</span><span style="color:#24292E;">(name, </span><span style="color:#032F62;">&quot;&#39;name&#39; must not be null&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">name.</span><span style="color:#6F42C1;">startsWith</span><span style="color:#24292E;">(BeanFactory.FACTORY_BEAN_PREFIX)) { </span><span style="color:#6A737D;">// BeanFactory.FACTORY_BEAN_PREFIX = $</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> name;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// computeIfAbsent 方法，分成两种情况：</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//      1. 未存在，则进行计算执行，并将结果添加到缓存、</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//      2. 已存在，则直接返回，无需计算。</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> transformedBeanNameCache.</span><span style="color:#6F42C1;">computeIfAbsent</span><span style="color:#24292E;">(name, beanName </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            beanName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> beanName.</span><span style="color:#6F42C1;">substring</span><span style="color:#24292E;">(BeanFactory.FACTORY_BEAN_PREFIX.</span><span style="color:#6F42C1;">length</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> (beanName.</span><span style="color:#6F42C1;">startsWith</span><span style="color:#24292E;">(BeanFactory.FACTORY_BEAN_PREFIX));</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> beanName;</span></span>
<span class="line"><span style="color:#24292E;">    });</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li>实际上，逻辑比较简单，就是去除传入 <code>name</code> 参数的 <code>&quot;&amp;&quot;</code> 的前缀。</li><li><code>transformedBeanNameCache</code> 集合的存在，是为了缓存转换后的结果。下次再获取相同的 <code>name</code> 时，直接返回缓存中的结果即可。</li></ul><p>2.调用 <code>#canonicalName(String name)</code> 方法，取指定的 <code>alias</code> 所表示的最终 beanName 。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// SimpleAliasRegistry.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/** Map from alias to canonical name. */</span></span>
<span class="line"><span style="color:#6A737D;">// key: alias</span></span>
<span class="line"><span style="color:#6A737D;">// value: beanName</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Map&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; aliasMap </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> ConcurrentHashMap&lt;&gt;(</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> String </span><span style="color:#B392F0;">canonicalName</span><span style="color:#E1E4E8;">(String name) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	String canonicalName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> name;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// Handle aliasing...</span></span>
<span class="line"><span style="color:#E1E4E8;">	String resolvedName;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// 循环，从 aliasMap 中，获取到最终的 beanName</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">		resolvedName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.aliasMap.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(canonicalName);</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (resolvedName </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">			canonicalName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> resolvedName;</span></span>
<span class="line"><span style="color:#E1E4E8;">		}</span></span>
<span class="line"><span style="color:#E1E4E8;">	} </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> (resolvedName </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> canonicalName;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// SimpleAliasRegistry.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/** Map from alias to canonical name. */</span></span>
<span class="line"><span style="color:#6A737D;">// key: alias</span></span>
<span class="line"><span style="color:#6A737D;">// value: beanName</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; aliasMap </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> ConcurrentHashMap&lt;&gt;(</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> String </span><span style="color:#6F42C1;">canonicalName</span><span style="color:#24292E;">(String name) {</span></span>
<span class="line"><span style="color:#24292E;">	String canonicalName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> name;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// Handle aliasing...</span></span>
<span class="line"><span style="color:#24292E;">	String resolvedName;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// 循环，从 aliasMap 中，获取到最终的 beanName</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">		resolvedName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.aliasMap.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(canonicalName);</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (resolvedName </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">			canonicalName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> resolvedName;</span></span>
<span class="line"><span style="color:#24292E;">		}</span></span>
<span class="line"><span style="color:#24292E;">	} </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> (resolvedName </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> canonicalName;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li>主要是一个循环获取 beanName 的过程，例如，别名 A 指向名称为 B 的 bean 则返回 B，若 别名 A 指向别名 B，别名 B 指向名称为 C 的 bean，则返回 C。</li></ul></li></ul><h5 id="getsingleton-name" tabindex="-1">getSingleton(name) <a class="header-anchor" href="#getsingleton-name" aria-label="Permalink to &quot;getSingleton(name)&quot;">​</a></h5><blockquote><p>Spring 对单例模式的 bean 只会创建一次。后续，如果再获取该 Bean ，则是直接从单例缓存中获取，该过程就体现在 <code>#getSingleton(String beanName)</code> 方法中</p></blockquote><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// DefaultSingletonBeanRegistry.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Nullable</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Object </span><span style="color:#B392F0;">getSingleton</span><span style="color:#E1E4E8;">(String beanName) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getSingleton</span><span style="color:#E1E4E8;">(beanName, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Nullable</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> Object </span><span style="color:#B392F0;">getSingleton</span><span style="color:#E1E4E8;">(String beanName, </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> allowEarlyReference) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 从单例缓冲中加载 bean</span></span>
<span class="line"><span style="color:#E1E4E8;">    Object singletonObject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonObjects.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 缓存中的 bean 为空，且当前 bean 正在创建</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 注: 在 Bean 创建过程中都会将其加入到 singletonsCurrentlyInCreation 集合中</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (singletonObject </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">isSingletonCurrentlyInCreation</span><span style="color:#E1E4E8;">(beanName)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 加锁</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">synchronized</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonObjects) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 从 earlySingletonObjects 获取</span></span>
<span class="line"><span style="color:#E1E4E8;">            singletonObject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.earlySingletonObjects.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// earlySingletonObjects 中没有，且允许提前创建</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (singletonObject </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> allowEarlyReference) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 从 singletonFactories 中获取对应的 ObjectFactory</span></span>
<span class="line"><span style="color:#E1E4E8;">                ObjectFactory&lt;</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">&gt; singletonFactory </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonFactories.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (singletonFactory </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 获得 bean</span></span>
<span class="line"><span style="color:#E1E4E8;">                    singletonObject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> singletonFactory.</span><span style="color:#B392F0;">getObject</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 添加 bean 到 earlySingletonObjects 中</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.earlySingletonObjects.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(beanName, singletonObject);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 从 singletonFactories 中移除对应的 ObjectFactory</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonFactories.</span><span style="color:#B392F0;">remove</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> singletonObject;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// DefaultSingletonBeanRegistry.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Nullable</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Object </span><span style="color:#6F42C1;">getSingleton</span><span style="color:#24292E;">(String beanName) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getSingleton</span><span style="color:#24292E;">(beanName, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Nullable</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> Object </span><span style="color:#6F42C1;">getSingleton</span><span style="color:#24292E;">(String beanName, </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> allowEarlyReference) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 从单例缓冲中加载 bean</span></span>
<span class="line"><span style="color:#24292E;">    Object singletonObject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonObjects.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 缓存中的 bean 为空，且当前 bean 正在创建</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 注: 在 Bean 创建过程中都会将其加入到 singletonsCurrentlyInCreation 集合中</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (singletonObject </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">isSingletonCurrentlyInCreation</span><span style="color:#24292E;">(beanName)) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 加锁</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">synchronized</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonObjects) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 从 earlySingletonObjects 获取</span></span>
<span class="line"><span style="color:#24292E;">            singletonObject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.earlySingletonObjects.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// earlySingletonObjects 中没有，且允许提前创建</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (singletonObject </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> allowEarlyReference) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 从 singletonFactories 中获取对应的 ObjectFactory</span></span>
<span class="line"><span style="color:#24292E;">                ObjectFactory&lt;</span><span style="color:#D73A49;">?</span><span style="color:#24292E;">&gt; singletonFactory </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonFactories.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (singletonFactory </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 获得 bean</span></span>
<span class="line"><span style="color:#24292E;">                    singletonObject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> singletonFactory.</span><span style="color:#6F42C1;">getObject</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 添加 bean 到 earlySingletonObjects 中</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.earlySingletonObjects.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(beanName, singletonObject);</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 从 singletonFactories 中移除对应的 ObjectFactory</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonFactories.</span><span style="color:#6F42C1;">remove</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> singletonObject;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>过程如下：</p><ul><li><p>第一步，从 <code>singletonObjects</code> 中，获取 Bean 对象。</p></li><li><p>第二步，若为空且当前 bean 正在创建中，则从 <code>earlySingletonObjects</code> 中获取 Bean 对象。</p></li><li><p>第三步，若为空且允许提前创建，则从 <code>singletonFactories</code> 中获取相应的 ObjectFactory 对象。若不为空，则调用其 <code>ObjectFactory#getObject(String name)</code> 方法，创建 Bean 对象，然后将其加入到 <code>earlySingletonObjects</code> ，然后从 <code>singletonFactories</code> 删除。</p></li><li><p>总体逻辑，就是根据 <code>beanName</code> 依次检测这三个 Map，若为空，从下一个，否则返回。这三个 Map 存放的都有各自的功能，代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// DefaultSingletonBeanRegistry.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Cache of singleton objects: bean name to bean instance.</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 存放的是单例 bean 的映射。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 对应关系为 bean name --&gt; bean instance</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Map&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">&gt; singletonObjects </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> ConcurrentHashMap&lt;&gt;(</span><span style="color:#79B8FF;">256</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Cache of singleton factories: bean name to ObjectFactory.</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 存放的是 ObjectFactory，可以理解为创建单例 bean 的 factory 。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 对应关系是 bean name --&gt; ObjectFactory</span></span>
<span class="line"><span style="color:#6A737D;"> **/</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Map&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, ObjectFactory&lt;</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">&gt;&gt; singletonFactories </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> HashMap&lt;&gt;(</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Cache of early singleton objects: bean name to bean instance.</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 存放的是早期的 bean，对应关系也是 bean name --&gt; bean instance。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 它与 {@link #singletonFactories} 区别在于 earlySingletonObjects 中存放的 bean 不一定是完整。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 从 {</span><span style="color:#F97583;">@link</span><span style="color:#6A737D;"> #</span><span style="color:#FFAB70;">getSingleton(String)</span><span style="color:#6A737D;">} 方法中，我们可以了解，bean 在创建过程中就已经加入到 earlySingletonObjects 中了。</span></span>
<span class="line"><span style="color:#6A737D;"> * 所以当在 bean 的创建过程中，就可以通过 getBean() 方法获取。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 这个 Map 也是【循环依赖】的关键所在。</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Map&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">&gt; earlySingletonObjects </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> HashMap&lt;&gt;(</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// DefaultSingletonBeanRegistry.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Cache of singleton objects: bean name to bean instance.</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 存放的是单例 bean 的映射。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 对应关系为 bean name --&gt; bean instance</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; singletonObjects </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> ConcurrentHashMap&lt;&gt;(</span><span style="color:#005CC5;">256</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Cache of singleton factories: bean name to ObjectFactory.</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 存放的是 ObjectFactory，可以理解为创建单例 bean 的 factory 。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 对应关系是 bean name --&gt; ObjectFactory</span></span>
<span class="line"><span style="color:#6A737D;"> **/</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, ObjectFactory&lt;</span><span style="color:#D73A49;">?</span><span style="color:#24292E;">&gt;&gt; singletonFactories </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> HashMap&lt;&gt;(</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Cache of early singleton objects: bean name to bean instance.</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 存放的是早期的 bean，对应关系也是 bean name --&gt; bean instance。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 它与 {@link #singletonFactories} 区别在于 earlySingletonObjects 中存放的 bean 不一定是完整。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 从 {</span><span style="color:#D73A49;">@link</span><span style="color:#6A737D;"> #</span><span style="color:#E36209;">getSingleton(String)</span><span style="color:#6A737D;">} 方法中，我们可以了解，bean 在创建过程中就已经加入到 earlySingletonObjects 中了。</span></span>
<span class="line"><span style="color:#6A737D;"> * 所以当在 bean 的创建过程中，就可以通过 getBean() 方法获取。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 这个 Map 也是【循环依赖】的关键所在。</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; earlySingletonObjects </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> HashMap&lt;&gt;(</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">);</span></span></code></pre></div></li></ul><h5 id="getobjectforbeaninstance" tabindex="-1">getObjectForBeanInstance() <a class="header-anchor" href="#getobjectforbeaninstance" aria-label="Permalink to &quot;getObjectForBeanInstance()&quot;">​</a></h5><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 从缓存中或者实例工厂中获取 Bean 对象</span></span>
<span class="line"><span style="color:#6A737D;">// Eagerly check singleton cache for manually registered singletons.</span></span>
<span class="line"><span style="color:#E1E4E8;">Object sharedInstance </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getSingleton</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (sharedInstance </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> args </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// &lt;x&gt; 完成 FactoryBean 的相关处理，并用来获取 FactoryBean 的处理结果</span></span>
<span class="line"><span style="color:#E1E4E8;">	bean </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getObjectForBeanInstance</span><span style="color:#E1E4E8;">(sharedInstance, name, beanName, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 从缓存中或者实例工厂中获取 Bean 对象</span></span>
<span class="line"><span style="color:#6A737D;">// Eagerly check singleton cache for manually registered singletons.</span></span>
<span class="line"><span style="color:#24292E;">Object sharedInstance </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getSingleton</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (sharedInstance </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> args </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// &lt;x&gt; 完成 FactoryBean 的相关处理，并用来获取 FactoryBean 的处理结果</span></span>
<span class="line"><span style="color:#24292E;">	bean </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getObjectForBeanInstance</span><span style="color:#24292E;">(sharedInstance, name, beanName, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li><code>&lt;x&gt;</code> 处，如果从缓存中得到了 Bean 对象，则需要调用 <code>#getObjectForBeanInstance(Object beanInstance, String name, String beanName, RootBeanDefinition mbd)</code> 方法，对 Bean 进行实例化处理。因为，缓存中记录的是最原始的 Bean 状态，我们得到的不一定是我们<strong>最终</strong>想要的 Bean</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> Object </span><span style="color:#B392F0;">getObjectForBeanInstance</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        Object beanInstance, String name, String beanName, @</span><span style="color:#F97583;">Nullable</span><span style="color:#E1E4E8;"> RootBeanDefinition mbd) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;1&gt; 若为工厂类引用（name 以 &amp; 开头）</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// Don&#39;t let calling code try to dereference the factory if the bean isn&#39;t a factory.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (BeanFactoryUtils.</span><span style="color:#B392F0;">isFactoryDereference</span><span style="color:#E1E4E8;">(name)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 如果是 NullBean，则直接返回</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (beanInstance </span><span style="color:#F97583;">instanceof</span><span style="color:#E1E4E8;"> NullBean) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> beanInstance;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 如果 beanInstance 不是 FactoryBean 类型，则抛出异常</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">(beanInstance </span><span style="color:#F97583;">instanceof</span><span style="color:#E1E4E8;"> FactoryBean)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanIsNotAFactoryException</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">transformedBeanName</span><span style="color:#E1E4E8;">(name), beanInstance.</span><span style="color:#B392F0;">getClass</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 到这里我们就有了一个 Bean 实例，当然该实例可能是会是是一个正常的 bean 又或者是一个 FactoryBean</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;2&gt;如果是 FactoryBean，我们则创建该 Bean</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// Now we have the bean instance, which may be a normal bean or a FactoryBean.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// If it&#39;s a FactoryBean, we use it to create a bean instance, unless the</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// caller actually wants a reference to the factory.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">(beanInstance </span><span style="color:#F97583;">instanceof</span><span style="color:#E1E4E8;"> FactoryBean) </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> BeanFactoryUtils.</span><span style="color:#B392F0;">isFactoryDereference</span><span style="color:#E1E4E8;">(name)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> beanInstance;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    Object object </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;3&gt; 若 BeanDefinition 为 null，则从缓存中加载 Bean 对象</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (mbd </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        object </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getCachedObjectForFactoryBean</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 若 object 依然为空，则可以确认，beanInstance 一定是 FactoryBean 。从而，使用 FactoryBean 获得 Bean 对象</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (object </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// Return bean instance from factory.</span></span>
<span class="line"><span style="color:#E1E4E8;">        FactoryBean&lt;</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">&gt; factory </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (FactoryBean</span><span style="color:#F97583;">&lt;?&gt;</span><span style="color:#E1E4E8;">) beanInstance;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// containsBeanDefinition 检测 beanDefinitionMap 中也就是在所有已经加载的类中</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 检测是否定义 beanName</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// Caches object obtained from FactoryBean if it is a singleton.</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (mbd </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">containsBeanDefinition</span><span style="color:#E1E4E8;">(beanName)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 将存储 XML 配置文件的 GenericBeanDefinition 转换为 RootBeanDefinition，</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 如果指定 BeanName 是子 Bean 的话同时会合并父类的相关属性</span></span>
<span class="line"><span style="color:#E1E4E8;">            mbd </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getMergedLocalBeanDefinition</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 是否是用户定义的，而不是应用程序本身定义的</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> synthetic </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (mbd </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> mbd.</span><span style="color:#B392F0;">isSynthetic</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 核心处理方法，使用 FactoryBean 获得 Bean 对象</span></span>
<span class="line"><span style="color:#E1E4E8;">        object </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getObjectFromFactoryBean</span><span style="color:#E1E4E8;">(factory, beanName, </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">synthetic);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> object;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> Object </span><span style="color:#6F42C1;">getObjectForBeanInstance</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        Object beanInstance, String name, String beanName, @</span><span style="color:#D73A49;">Nullable</span><span style="color:#24292E;"> RootBeanDefinition mbd) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;1&gt; 若为工厂类引用（name 以 &amp; 开头）</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// Don&#39;t let calling code try to dereference the factory if the bean isn&#39;t a factory.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (BeanFactoryUtils.</span><span style="color:#6F42C1;">isFactoryDereference</span><span style="color:#24292E;">(name)) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 如果是 NullBean，则直接返回</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (beanInstance </span><span style="color:#D73A49;">instanceof</span><span style="color:#24292E;"> NullBean) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> beanInstance;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 如果 beanInstance 不是 FactoryBean 类型，则抛出异常</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">(beanInstance </span><span style="color:#D73A49;">instanceof</span><span style="color:#24292E;"> FactoryBean)) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanIsNotAFactoryException</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">transformedBeanName</span><span style="color:#24292E;">(name), beanInstance.</span><span style="color:#6F42C1;">getClass</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 到这里我们就有了一个 Bean 实例，当然该实例可能是会是是一个正常的 bean 又或者是一个 FactoryBean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;2&gt;如果是 FactoryBean，我们则创建该 Bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// Now we have the bean instance, which may be a normal bean or a FactoryBean.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// If it&#39;s a FactoryBean, we use it to create a bean instance, unless the</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// caller actually wants a reference to the factory.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">(beanInstance </span><span style="color:#D73A49;">instanceof</span><span style="color:#24292E;"> FactoryBean) </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> BeanFactoryUtils.</span><span style="color:#6F42C1;">isFactoryDereference</span><span style="color:#24292E;">(name)) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> beanInstance;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    Object object </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;3&gt; 若 BeanDefinition 为 null，则从缓存中加载 Bean 对象</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (mbd </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        object </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getCachedObjectForFactoryBean</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 若 object 依然为空，则可以确认，beanInstance 一定是 FactoryBean 。从而，使用 FactoryBean 获得 Bean 对象</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (object </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// Return bean instance from factory.</span></span>
<span class="line"><span style="color:#24292E;">        FactoryBean&lt;</span><span style="color:#D73A49;">?</span><span style="color:#24292E;">&gt; factory </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (FactoryBean</span><span style="color:#D73A49;">&lt;?&gt;</span><span style="color:#24292E;">) beanInstance;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// containsBeanDefinition 检测 beanDefinitionMap 中也就是在所有已经加载的类中</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 检测是否定义 beanName</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// Caches object obtained from FactoryBean if it is a singleton.</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (mbd </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">containsBeanDefinition</span><span style="color:#24292E;">(beanName)) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 将存储 XML 配置文件的 GenericBeanDefinition 转换为 RootBeanDefinition，</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 如果指定 BeanName 是子 Bean 的话同时会合并父类的相关属性</span></span>
<span class="line"><span style="color:#24292E;">            mbd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getMergedLocalBeanDefinition</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 是否是用户定义的，而不是应用程序本身定义的</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> synthetic </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (mbd </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> mbd.</span><span style="color:#6F42C1;">isSynthetic</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 核心处理方法，使用 FactoryBean 获得 Bean 对象</span></span>
<span class="line"><span style="color:#24292E;">        object </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getObjectFromFactoryBean</span><span style="color:#24292E;">(factory, beanName, </span><span style="color:#D73A49;">!</span><span style="color:#24292E;">synthetic);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> object;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>该方法主要是进行检测工作的，主要如下：</p><ul><li><code>&lt;1&gt;</code> 处，若 <code>name</code> 为工厂相关的（以 &amp; 开头），且 <code>beanInstance</code> 为 NullBean 类型则直接返回，如果 <code>beanInstance</code> 不为 FactoryBean 类型则抛出 BeanIsNotAFactoryException 异常。这里主要是<strong>校验</strong> <code>beanInstance</code> 的<strong>正确性</strong>。</li><li><code>&lt;2&gt;</code> 处，如果 <code>beanInstance</code> 不为 FactoryBean 类型或者 <code>name</code> 也不是与工厂相关的，则直接返回 <code>beanInstance</code> 这个 Bean 对象。<strong>这里主要是对非 FactoryBean 类型处理</strong>。</li><li><code>&lt;3&gt;</code> 处，如果 BeanDefinition 为空，则从 <code>factoryBeanObjectCache</code> 中加载 Bean 对象。如果还是空，则可以断定 <code>beanInstance</code> 一定是 FactoryBean 类型，则委托 <code>#getObjectFromFactoryBean(FactoryBean&lt;?&gt; factory, String beanName, boolean shouldPostProcess)</code> 方法，进行处理，<strong>使用 FactoryBean 获得 Bean 对象</strong>。</li></ul><blockquote><p>所以实际上，<code>#getObjectForBeanInstance(...)</code> 方法的<strong>重心</strong>，就是使用 FactoryBean 对象，获得( 或者创建 )其 Bean 对象，即调用 <code>#getObjectFromFactoryBean(...)</code> 方法。</p></blockquote><h5 id="getobjectfromfactorybean" tabindex="-1">getObjectFromFactoryBean() <a class="header-anchor" href="#getobjectfromfactorybean" aria-label="Permalink to &quot;getObjectFromFactoryBean()&quot;">​</a></h5><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// FactoryBeanRegistrySupport.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Cache of singleton objects created by FactoryBeans: FactoryBean name to object.</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 缓存 FactoryBean 创建的单例 Bean 对象的映射</span></span>
<span class="line"><span style="color:#6A737D;"> * beanName ===&gt; Bean 对象</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Map&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">&gt; factoryBeanObjectCache </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> ConcurrentHashMap&lt;&gt;(</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> Object </span><span style="color:#B392F0;">getObjectFromFactoryBean</span><span style="color:#E1E4E8;">(FactoryBean</span><span style="color:#F97583;">&lt;?&gt;</span><span style="color:#E1E4E8;"> factory, String beanName, </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> shouldPostProcess) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;1&gt; 为单例模式且缓存中存在</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (factory.</span><span style="color:#B392F0;">isSingleton</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">containsSingleton</span><span style="color:#E1E4E8;">(beanName)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">synchronized</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">getSingletonMutex</span><span style="color:#E1E4E8;">()) { </span><span style="color:#6A737D;">// &lt;1.1&gt; 单例锁</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// &lt;1.2&gt; 从缓存中获取指定的 factoryBean</span></span>
<span class="line"><span style="color:#E1E4E8;">            Object object </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.factoryBeanObjectCache.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (object </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 为空，则从 FactoryBean 中获取对象</span></span>
<span class="line"><span style="color:#E1E4E8;">                object </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">doGetObjectFromFactoryBean</span><span style="color:#E1E4E8;">(factory, beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 从缓存中获取</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// Only post-process and store if not put there already during getObject() call above</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// (e.g. because of circular reference processing triggered by custom getBean calls)</span></span>
<span class="line"><span style="color:#E1E4E8;">                Object alreadyThere </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.factoryBeanObjectCache.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (alreadyThere </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    object </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> alreadyThere;</span></span>
<span class="line"><span style="color:#E1E4E8;">                } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// &lt;1.3&gt; 需要后续处理</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (shouldPostProcess) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#6A737D;">// 若该 Bean 处于创建中，则返回非处理对象，而不是存储它</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">isSingletonCurrentlyInCreation</span><span style="color:#E1E4E8;">(beanName)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#6A737D;">// Temporarily return non-post-processed object, not storing it yet..</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> object;</span></span>
<span class="line"><span style="color:#E1E4E8;">                        }</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#6A737D;">// 单例 Bean 的前置处理</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#B392F0;">beforeSingletonCreation</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#6A737D;">// 对从 FactoryBean 获取的对象进行后处理</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#6A737D;">// 生成的对象将暴露给 bean 引用</span></span>
<span class="line"><span style="color:#E1E4E8;">                            object </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">postProcessObjectFromFactoryBean</span><span style="color:#E1E4E8;">(object, beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                        } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (Throwable </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanCreationException</span><span style="color:#E1E4E8;">(beanName,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                    </span><span style="color:#9ECBFF;">&quot;Post-processing of FactoryBean&#39;s singleton object failed&quot;</span><span style="color:#E1E4E8;">, ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">                        } </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#6A737D;">// 单例 Bean 的后置处理</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#B392F0;">afterSingletonCreation</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                        }</span></span>
<span class="line"><span style="color:#E1E4E8;">                    }</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// &lt;1.4&gt; 添加到 factoryBeanObjectCache 中，进行缓存</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">containsSingleton</span><span style="color:#E1E4E8;">(beanName)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.factoryBeanObjectCache.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(beanName, object);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    }</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> object;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;2&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 为空，则从 FactoryBean 中获取对象</span></span>
<span class="line"><span style="color:#E1E4E8;">        Object object </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">doGetObjectFromFactoryBean</span><span style="color:#E1E4E8;">(factory, beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 需要后续处理</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (shouldPostProcess) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 对从 FactoryBean 获取的对象进行后处理</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 生成的对象将暴露给 bean 引用</span></span>
<span class="line"><span style="color:#E1E4E8;">                object </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">postProcessObjectFromFactoryBean</span><span style="color:#E1E4E8;">(object, beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (Throwable </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanCreationException</span><span style="color:#E1E4E8;">(beanName, </span><span style="color:#9ECBFF;">&quot;Post-processing of FactoryBean&#39;s object failed&quot;</span><span style="color:#E1E4E8;">, ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> object;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// FactoryBeanRegistrySupport.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Cache of singleton objects created by FactoryBeans: FactoryBean name to object.</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 缓存 FactoryBean 创建的单例 Bean 对象的映射</span></span>
<span class="line"><span style="color:#6A737D;"> * beanName ===&gt; Bean 对象</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; factoryBeanObjectCache </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> ConcurrentHashMap&lt;&gt;(</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> Object </span><span style="color:#6F42C1;">getObjectFromFactoryBean</span><span style="color:#24292E;">(FactoryBean</span><span style="color:#D73A49;">&lt;?&gt;</span><span style="color:#24292E;"> factory, String beanName, </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> shouldPostProcess) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;1&gt; 为单例模式且缓存中存在</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (factory.</span><span style="color:#6F42C1;">isSingleton</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">containsSingleton</span><span style="color:#24292E;">(beanName)) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">synchronized</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">getSingletonMutex</span><span style="color:#24292E;">()) { </span><span style="color:#6A737D;">// &lt;1.1&gt; 单例锁</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// &lt;1.2&gt; 从缓存中获取指定的 factoryBean</span></span>
<span class="line"><span style="color:#24292E;">            Object object </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.factoryBeanObjectCache.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (object </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 为空，则从 FactoryBean 中获取对象</span></span>
<span class="line"><span style="color:#24292E;">                object </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">doGetObjectFromFactoryBean</span><span style="color:#24292E;">(factory, beanName);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 从缓存中获取</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// Only post-process and store if not put there already during getObject() call above</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// (e.g. because of circular reference processing triggered by custom getBean calls)</span></span>
<span class="line"><span style="color:#24292E;">                Object alreadyThere </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.factoryBeanObjectCache.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (alreadyThere </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                    object </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> alreadyThere;</span></span>
<span class="line"><span style="color:#24292E;">                } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// &lt;1.3&gt; 需要后续处理</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (shouldPostProcess) {</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#6A737D;">// 若该 Bean 处于创建中，则返回非处理对象，而不是存储它</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">isSingletonCurrentlyInCreation</span><span style="color:#24292E;">(beanName)) {</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#6A737D;">// Temporarily return non-post-processed object, not storing it yet..</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> object;</span></span>
<span class="line"><span style="color:#24292E;">                        }</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#6A737D;">// 单例 Bean 的前置处理</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#6F42C1;">beforeSingletonCreation</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#6A737D;">// 对从 FactoryBean 获取的对象进行后处理</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#6A737D;">// 生成的对象将暴露给 bean 引用</span></span>
<span class="line"><span style="color:#24292E;">                            object </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">postProcessObjectFromFactoryBean</span><span style="color:#24292E;">(object, beanName);</span></span>
<span class="line"><span style="color:#24292E;">                        } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (Throwable </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanCreationException</span><span style="color:#24292E;">(beanName,</span></span>
<span class="line"><span style="color:#24292E;">                                    </span><span style="color:#032F62;">&quot;Post-processing of FactoryBean&#39;s singleton object failed&quot;</span><span style="color:#24292E;">, ex);</span></span>
<span class="line"><span style="color:#24292E;">                        } </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#6A737D;">// 单例 Bean 的后置处理</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#6F42C1;">afterSingletonCreation</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">                        }</span></span>
<span class="line"><span style="color:#24292E;">                    }</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// &lt;1.4&gt; 添加到 factoryBeanObjectCache 中，进行缓存</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">containsSingleton</span><span style="color:#24292E;">(beanName)) {</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.factoryBeanObjectCache.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(beanName, object);</span></span>
<span class="line"><span style="color:#24292E;">                    }</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> object;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;2&gt;</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 为空，则从 FactoryBean 中获取对象</span></span>
<span class="line"><span style="color:#24292E;">        Object object </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">doGetObjectFromFactoryBean</span><span style="color:#24292E;">(factory, beanName);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 需要后续处理</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (shouldPostProcess) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 对从 FactoryBean 获取的对象进行后处理</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 生成的对象将暴露给 bean 引用</span></span>
<span class="line"><span style="color:#24292E;">                object </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">postProcessObjectFromFactoryBean</span><span style="color:#24292E;">(object, beanName);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (Throwable </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanCreationException</span><span style="color:#24292E;">(beanName, </span><span style="color:#032F62;">&quot;Post-processing of FactoryBean&#39;s object failed&quot;</span><span style="color:#24292E;">, ex);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> object;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>主要流程如下：</p><blockquote><ul><li><code>#beforeSingletonCreation(String beanName)</code></li><li><code>#afterSingletonCreation(String beanName)</code></li><li><code>#postProcessObjectFromFactoryBean(Object object, String beanName)</code></li></ul></blockquote><ul><li><p>若为单例且单例 Bean 缓存中存在 <code>beanName</code> ，则 <code>&lt;1&gt;</code> 进行后续处理（跳转到下一步），否则，则 <code>&lt;2&gt;</code> 从 FactoryBean 中获取 Bean 实例对象。</p></li><li><p><code>&lt;1.1&gt;</code> 首先，获取锁。其实我们在前面篇幅中发现了大量的同步锁，锁住的对象都是 <code>this.singletonObjects</code>，主要是因为在单例模式中必须要<strong>保证全局唯一</strong>。</p></li><li><p><code>&lt;1.2&gt;</code> 然后，从 <code>factoryBeanObjectCache</code> 缓存中获取实例对象 <code>object</code> 。若 <code>object</code> 为空，则调用 <code>#doGetObjectFromFactoryBean(FactoryBean&lt;?&gt; factory, String beanName)</code> 方法，从 FactoryBean 获取对象，其实内部就是调用 <code>FactoryBean#getObject()</code> 方法。代码如下:</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> Object </span><span style="color:#B392F0;">doGetObjectFromFactoryBean</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> FactoryBean</span><span style="color:#F97583;">&lt;?&gt;</span><span style="color:#E1E4E8;"> factory, </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> String beanName)</span></span>
<span class="line"><span style="color:#E1E4E8;">    throws BeanCreationException {</span></span>
<span class="line"><span style="color:#E1E4E8;">    Object object;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 需要权限验证</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (System.</span><span style="color:#B392F0;">getSecurityManager</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            AccessControlContext acc </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getAccessControlContext</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// &lt;x&gt; 从 FactoryBean 中，获得 Bean 对象</span></span>
<span class="line"><span style="color:#E1E4E8;">                object </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> AccessController.</span><span style="color:#B392F0;">doPrivileged</span><span style="color:#E1E4E8;">((PrivilegedExceptionAction</span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">Object</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">) factory</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">getObject, acc);</span></span>
<span class="line"><span style="color:#E1E4E8;">            } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (PrivilegedActionException </span><span style="color:#FFAB70;">pae</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> pae.</span><span style="color:#B392F0;">getException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// &lt;x&gt; 从 FactoryBean 中，获得 Bean 对象</span></span>
<span class="line"><span style="color:#E1E4E8;">            object </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> factory.</span><span style="color:#B392F0;">getObject</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (FactoryBeanNotInitializedException </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanCurrentlyInCreationException</span><span style="color:#E1E4E8;">(beanName, ex.</span><span style="color:#B392F0;">toString</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (Throwable </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanCreationException</span><span style="color:#E1E4E8;">(beanName, </span><span style="color:#9ECBFF;">&quot;FactoryBean threw exception on object creation&quot;</span><span style="color:#E1E4E8;">, ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// Do not accept a null value for a FactoryBean that&#39;s not fully</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// initialized yet: Many FactoryBeans just return null then.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (object </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">isSingletonCurrentlyInCreation</span><span style="color:#E1E4E8;">(beanName)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanCurrentlyInCreationException</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">                    beanName, </span><span style="color:#9ECBFF;">&quot;FactoryBean which is currently in creation returned null from getObject&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        object </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">NullBean</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> object;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> Object </span><span style="color:#6F42C1;">doGetObjectFromFactoryBean</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> FactoryBean</span><span style="color:#D73A49;">&lt;?&gt;</span><span style="color:#24292E;"> factory, </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String beanName)</span></span>
<span class="line"><span style="color:#24292E;">    throws BeanCreationException {</span></span>
<span class="line"><span style="color:#24292E;">    Object object;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 需要权限验证</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (System.</span><span style="color:#6F42C1;">getSecurityManager</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            AccessControlContext acc </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getAccessControlContext</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// &lt;x&gt; 从 FactoryBean 中，获得 Bean 对象</span></span>
<span class="line"><span style="color:#24292E;">                object </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> AccessController.</span><span style="color:#6F42C1;">doPrivileged</span><span style="color:#24292E;">((PrivilegedExceptionAction</span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">Object</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">) factory</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">getObject, acc);</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (PrivilegedActionException </span><span style="color:#E36209;">pae</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> pae.</span><span style="color:#6F42C1;">getException</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// &lt;x&gt; 从 FactoryBean 中，获得 Bean 对象</span></span>
<span class="line"><span style="color:#24292E;">            object </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> factory.</span><span style="color:#6F42C1;">getObject</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (FactoryBeanNotInitializedException </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanCurrentlyInCreationException</span><span style="color:#24292E;">(beanName, ex.</span><span style="color:#6F42C1;">toString</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (Throwable </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanCreationException</span><span style="color:#24292E;">(beanName, </span><span style="color:#032F62;">&quot;FactoryBean threw exception on object creation&quot;</span><span style="color:#24292E;">, ex);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// Do not accept a null value for a FactoryBean that&#39;s not fully</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// initialized yet: Many FactoryBeans just return null then.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (object </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">isSingletonCurrentlyInCreation</span><span style="color:#24292E;">(beanName)) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanCurrentlyInCreationException</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                    beanName, </span><span style="color:#032F62;">&quot;FactoryBean which is currently in creation returned null from getObject&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        object </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">NullBean</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> object;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div></li><li><p><code>&lt;1.3&gt;</code> 如果需要后续处理( <code>shouldPostProcess = true</code> )，则进行进一步处理，步骤如下：</p><ul><li>若该 Bean 处于创建中（<code>#isSingletonCurrentlyInCreation(String beanName)</code> 方法返回 <code>true</code> ），则返回<strong>非处理的 Bean 对象</strong>，而不是存储它。</li><li>调用 <code>#beforeSingletonCreation(String beanName)</code> 方法，进行创建之前的处理。默认实现将该 Bean 标志为当前创建的。</li><li>调用 <code>#postProcessObjectFromFactoryBean(Object object, String beanName)</code> 方法，对从 FactoryBean 获取的 Bean 实例对象进行后置处理。</li><li>调用 <code>#afterSingletonCreation(String beanName)</code> 方法，进行创建 Bean 之后的处理，默认实现是将该 bean 标记为不再在创建中。</li></ul></li><li><p><code>&lt;1.4&gt;</code> 最后，加入到 <code>factoryBeanObjectCache</code> 缓存中。</p></li></ul><h5 id="getmergedlocalbeandefinition-name" tabindex="-1">getMergedLocalBeanDefinition(name) <a class="header-anchor" href="#getmergedlocalbeandefinition-name" aria-label="Permalink to &quot;getMergedLocalBeanDefinition(name)&quot;">​</a></h5><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 从容器中获取 beanName 相应的 GenericBeanDefinition 对象，并将其转换为 RootBeanDefinition 对象</span></span>
<span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> RootBeanDefinition mbd </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getMergedLocalBeanDefinition</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#6A737D;">// 检查给定的合并的 BeanDefinition</span></span>
<span class="line"><span style="color:#B392F0;">checkMergedBeanDefinition</span><span style="color:#E1E4E8;">(mbd, beanName, args);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 从容器中获取 beanName 相应的 GenericBeanDefinition 对象，并将其转换为 RootBeanDefinition 对象</span></span>
<span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> RootBeanDefinition mbd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getMergedLocalBeanDefinition</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#6A737D;">// 检查给定的合并的 BeanDefinition</span></span>
<span class="line"><span style="color:#6F42C1;">checkMergedBeanDefinition</span><span style="color:#24292E;">(mbd, beanName, args);</span></span></code></pre></div><blockquote><p>从 XML 配置文件中读取到的 Bean 信息是存储在GenericBeanDefinition 中的。但是，所有的 Bean 后续处理都是针对于 RootBeanDefinition 的，所以这里需要进行一个转换。</p><p>转换的同时，如果父类 bean 不为空的话，则会一并合并父类的属性。</p></blockquote><h4 id="createbean" tabindex="-1">createBean() <a class="header-anchor" href="#createbean" aria-label="Permalink to &quot;createBean()&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">abstract</span><span style="color:#E1E4E8;"> Object </span><span style="color:#B392F0;">createBean</span><span style="color:#E1E4E8;">(String beanName, RootBeanDefinition mbd, @</span><span style="color:#F97583;">Nullable</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">[] args)</span></span>
<span class="line"><span style="color:#E1E4E8;">		throws BeanCreationException;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">abstract</span><span style="color:#24292E;"> Object </span><span style="color:#6F42C1;">createBean</span><span style="color:#24292E;">(String beanName, RootBeanDefinition mbd, @</span><span style="color:#D73A49;">Nullable</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">[] args)</span></span>
<span class="line"><span style="color:#24292E;">		throws BeanCreationException;</span></span></code></pre></div><ul><li>该方法定义在 AbstractBeanFactory 中，其含义是根据给定的 BeanDefinition 和 <code>args</code> 实例化一个 Bean 对象。</li><li>如果该 BeanDefinition 存在父类，则该 BeanDefinition 已经合并了父类的属性。</li><li>所有 Bean 实例的创建，都会委托给该方法实现。</li><li>该方法接受三个方法参数： <ul><li><code>beanName</code> ：bean 的名字。</li><li><code>mbd</code> ：已经合并了父类属性的（如果有的话）BeanDefinition 对象。</li><li><code>args</code> ：用于构造函数或者工厂方法创建 Bean 实例对象的参数。</li></ul></li></ul><p>该抽象方法的默认实现是在类 AbstractAutowireCapableBeanFactory 中实现，代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> Object </span><span style="color:#B392F0;">createBean</span><span style="color:#E1E4E8;">(String beanName, RootBeanDefinition mbd, @</span><span style="color:#F97583;">Nullable</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">[] args)</span></span>
<span class="line"><span style="color:#E1E4E8;">        throws BeanCreationException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (logger.</span><span style="color:#B392F0;">isTraceEnabled</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        logger.</span><span style="color:#B392F0;">trace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Creating instance of bean &#39;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> beanName </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&#39;&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    RootBeanDefinition mbdToUse </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> mbd;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// Make sure bean class is actually resolved at this point, and</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// clone the bean definition in case of a dynamically resolved Class</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// which cannot be stored in the shared merged bean definition.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;1&gt; 确保此时的 bean 已经被解析了</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 如果获取的class 属性不为null，则克隆该 BeanDefinition</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 主要是因为该动态解析的 class 无法保存到到共享的 BeanDefinition</span></span>
<span class="line"><span style="color:#E1E4E8;">    Class&lt;</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">&gt; resolvedClass </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">resolveBeanClass</span><span style="color:#E1E4E8;">(mbd, beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (resolvedClass </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">mbd.</span><span style="color:#B392F0;">hasBeanClass</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> mbd.</span><span style="color:#B392F0;">getBeanClassName</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        mbdToUse </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">RootBeanDefinition</span><span style="color:#E1E4E8;">(mbd);</span></span>
<span class="line"><span style="color:#E1E4E8;">        mbdToUse.</span><span style="color:#B392F0;">setBeanClass</span><span style="color:#E1E4E8;">(resolvedClass);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// Prepare method overrides.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// &lt;2&gt; 验证和准备覆盖方法</span></span>
<span class="line"><span style="color:#E1E4E8;">        mbdToUse.</span><span style="color:#B392F0;">prepareMethodOverrides</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (BeanDefinitionValidationException </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanDefinitionStoreException</span><span style="color:#E1E4E8;">(mbdToUse.</span><span style="color:#B392F0;">getResourceDescription</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">                beanName, </span><span style="color:#9ECBFF;">&quot;Validation of method overrides failed&quot;</span><span style="color:#E1E4E8;">, ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// &lt;3&gt; 实例化的前置处理</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 给 BeanPostProcessors 一个机会用来返回一个代理类而不是真正的类实例</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// AOP 的功能就是基于这个地方</span></span>
<span class="line"><span style="color:#E1E4E8;">        Object bean </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">resolveBeforeInstantiation</span><span style="color:#E1E4E8;">(beanName, mbdToUse);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (bean </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> bean;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (Throwable </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanCreationException</span><span style="color:#E1E4E8;">(mbdToUse.</span><span style="color:#B392F0;">getResourceDescription</span><span style="color:#E1E4E8;">(), beanName,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;BeanPostProcessor before instantiation of bean failed&quot;</span><span style="color:#E1E4E8;">, ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// &lt;4&gt; 创建 Bean 对象</span></span>
<span class="line"><span style="color:#E1E4E8;">        Object beanInstance </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">doCreateBean</span><span style="color:#E1E4E8;">(beanName, mbdToUse, args);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (logger.</span><span style="color:#B392F0;">isTraceEnabled</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            logger.</span><span style="color:#B392F0;">trace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Finished creating instance of bean &#39;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> beanName </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&#39;&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> beanInstance;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (BeanCreationException | ImplicitlyAppearedSingletonException </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// A previously detected exception with proper bean creation context already,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> ex;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (Throwable </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanCreationException</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">                mbdToUse.</span><span style="color:#B392F0;">getResourceDescription</span><span style="color:#E1E4E8;">(), beanName, </span><span style="color:#9ECBFF;">&quot;Unexpected exception during bean creation&quot;</span><span style="color:#E1E4E8;">, ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> Object </span><span style="color:#6F42C1;">createBean</span><span style="color:#24292E;">(String beanName, RootBeanDefinition mbd, @</span><span style="color:#D73A49;">Nullable</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">[] args)</span></span>
<span class="line"><span style="color:#24292E;">        throws BeanCreationException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (logger.</span><span style="color:#6F42C1;">isTraceEnabled</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">        logger.</span><span style="color:#6F42C1;">trace</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Creating instance of bean &#39;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> beanName </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&#39;&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    RootBeanDefinition mbdToUse </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> mbd;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// Make sure bean class is actually resolved at this point, and</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// clone the bean definition in case of a dynamically resolved Class</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// which cannot be stored in the shared merged bean definition.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;1&gt; 确保此时的 bean 已经被解析了</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 如果获取的class 属性不为null，则克隆该 BeanDefinition</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 主要是因为该动态解析的 class 无法保存到到共享的 BeanDefinition</span></span>
<span class="line"><span style="color:#24292E;">    Class&lt;</span><span style="color:#D73A49;">?</span><span style="color:#24292E;">&gt; resolvedClass </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">resolveBeanClass</span><span style="color:#24292E;">(mbd, beanName);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (resolvedClass </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!</span><span style="color:#24292E;">mbd.</span><span style="color:#6F42C1;">hasBeanClass</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> mbd.</span><span style="color:#6F42C1;">getBeanClassName</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        mbdToUse </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RootBeanDefinition</span><span style="color:#24292E;">(mbd);</span></span>
<span class="line"><span style="color:#24292E;">        mbdToUse.</span><span style="color:#6F42C1;">setBeanClass</span><span style="color:#24292E;">(resolvedClass);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// Prepare method overrides.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// &lt;2&gt; 验证和准备覆盖方法</span></span>
<span class="line"><span style="color:#24292E;">        mbdToUse.</span><span style="color:#6F42C1;">prepareMethodOverrides</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (BeanDefinitionValidationException </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanDefinitionStoreException</span><span style="color:#24292E;">(mbdToUse.</span><span style="color:#6F42C1;">getResourceDescription</span><span style="color:#24292E;">(),</span></span>
<span class="line"><span style="color:#24292E;">                beanName, </span><span style="color:#032F62;">&quot;Validation of method overrides failed&quot;</span><span style="color:#24292E;">, ex);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// &lt;3&gt; 实例化的前置处理</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 给 BeanPostProcessors 一个机会用来返回一个代理类而不是真正的类实例</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// AOP 的功能就是基于这个地方</span></span>
<span class="line"><span style="color:#24292E;">        Object bean </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">resolveBeforeInstantiation</span><span style="color:#24292E;">(beanName, mbdToUse);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (bean </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> bean;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (Throwable </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanCreationException</span><span style="color:#24292E;">(mbdToUse.</span><span style="color:#6F42C1;">getResourceDescription</span><span style="color:#24292E;">(), beanName,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;BeanPostProcessor before instantiation of bean failed&quot;</span><span style="color:#24292E;">, ex);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// &lt;4&gt; 创建 Bean 对象</span></span>
<span class="line"><span style="color:#24292E;">        Object beanInstance </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">doCreateBean</span><span style="color:#24292E;">(beanName, mbdToUse, args);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (logger.</span><span style="color:#6F42C1;">isTraceEnabled</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">            logger.</span><span style="color:#6F42C1;">trace</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Finished creating instance of bean &#39;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> beanName </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&#39;&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> beanInstance;</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (BeanCreationException | ImplicitlyAppearedSingletonException </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// A previously detected exception with proper bean creation context already,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> ex;</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (Throwable </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanCreationException</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                mbdToUse.</span><span style="color:#6F42C1;">getResourceDescription</span><span style="color:#24292E;">(), beanName, </span><span style="color:#032F62;">&quot;Unexpected exception during bean creation&quot;</span><span style="color:#24292E;">, ex);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>过程如下：</p><ul><li><code>&lt;1&gt;</code> 处，解析指定 BeanDefinition 的 class 属性。</li><li><code>&lt;2&gt;</code> 处，处理 <code>override</code> 属性。</li><li><code>&lt;3&gt;</code> 处，实例化的前置处理。</li><li><code>&lt;4&gt;</code> 处，创建 Bean 对象。</li></ul><p><code>#resolveBeforeInstantiation(String beanName, RootBeanDefinition mbd)</code> 方法的作用，是给 BeanPostProcessors 后置处理器返回一个<strong>代理对象</strong>的机会。其，实在调用该方法之前 Spring 一直都没有创建 bean ，那么这里返回一个 bean 的代理类有什么作用呢？作用体现在后面的 <code>if</code> 判断，代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">Object bean </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">resolveBeforeInstantiation</span><span style="color:#E1E4E8;">(beanName, mbdToUse);</span></span>
<span class="line"><span style="color:#6A737D;">// ↓↓↓ </span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (bean </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> bean;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">Object bean </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">resolveBeforeInstantiation</span><span style="color:#24292E;">(beanName, mbdToUse);</span></span>
<span class="line"><span style="color:#6A737D;">// ↓↓↓ </span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (bean </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> bean;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li><p>如果代理对象不为空，则直接返回代理对象，这一步骤有非常重要的作用，Spring 后续实现 AOP 就是基于这个地方判断的。</p></li><li><p><code>#resolveBeforeInstantiation(String beanName, RootBeanDefinition mbd)</code> 方法，代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Nullable</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> Object </span><span style="color:#B392F0;">resolveBeforeInstantiation</span><span style="color:#E1E4E8;">(String beanName, RootBeanDefinition mbd) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    Object bean </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">Boolean.FALSE.</span><span style="color:#B392F0;">equals</span><span style="color:#E1E4E8;">(mbd.beforeInstantiationResolved)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// Make sure bean class is actually resolved at this point.</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">mbd.</span><span style="color:#B392F0;">isSynthetic</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hasInstantiationAwareBeanPostProcessors</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            Class&lt;</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">&gt; targetType </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">determineTargetType</span><span style="color:#E1E4E8;">(beanName, mbd);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (targetType </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 前置</span></span>
<span class="line"><span style="color:#E1E4E8;">                bean </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">applyBeanPostProcessorsBeforeInstantiation</span><span style="color:#E1E4E8;">(targetType, beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (bean </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 后置</span></span>
<span class="line"><span style="color:#E1E4E8;">                    bean </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">applyBeanPostProcessorsAfterInitialization</span><span style="color:#E1E4E8;">(bean, beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        mbd.beforeInstantiationResolved </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (bean </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> bean;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Nullable</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> Object </span><span style="color:#6F42C1;">resolveBeforeInstantiation</span><span style="color:#24292E;">(String beanName, RootBeanDefinition mbd) {</span></span>
<span class="line"><span style="color:#24292E;">    Object bean </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">Boolean.FALSE.</span><span style="color:#6F42C1;">equals</span><span style="color:#24292E;">(mbd.beforeInstantiationResolved)) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// Make sure bean class is actually resolved at this point.</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">mbd.</span><span style="color:#6F42C1;">isSynthetic</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hasInstantiationAwareBeanPostProcessors</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">            Class&lt;</span><span style="color:#D73A49;">?</span><span style="color:#24292E;">&gt; targetType </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">determineTargetType</span><span style="color:#24292E;">(beanName, mbd);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (targetType </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 前置</span></span>
<span class="line"><span style="color:#24292E;">                bean </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">applyBeanPostProcessorsBeforeInstantiation</span><span style="color:#24292E;">(targetType, beanName);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (bean </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 后置</span></span>
<span class="line"><span style="color:#24292E;">                    bean </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">applyBeanPostProcessorsAfterInitialization</span><span style="color:#24292E;">(bean, beanName);</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        mbd.beforeInstantiationResolved </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (bean </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> bean;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li>这个方法核心就在于 <code>applyBeanPostProcessorsBeforeInstantiation()</code> 和 <code>applyBeanPostProcessorsAfterInitialization()</code> 两个方法，before 为实例化前的后处理器应用，after 为实例化后的后处理器应用。</li><li>由于本文的主题是创建 bean ，关于 Bean 的增强处理后续 LZ 会单独出博文来做详细说明。</li></ul></li></ul><h4 id="docreatebean" tabindex="-1">doCreateBean() <a class="header-anchor" href="#docreatebean" aria-label="Permalink to &quot;doCreateBean()&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> Object </span><span style="color:#B392F0;">doCreateBean</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> String beanName, </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> RootBeanDefinition mbd, </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> @</span><span style="color:#F97583;">Nullable</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">[] args)</span></span>
<span class="line"><span style="color:#E1E4E8;">        throws BeanCreationException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// Instantiate the bean.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// BeanWrapper 是对 Bean 的包装，其接口中所定义的功能很简单包括设置获取被包装的对象，获取被包装 bean 的属性描述器</span></span>
<span class="line"><span style="color:#E1E4E8;">    BeanWrapper instanceWrapper </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;1&gt; 单例模型，则从未完成的 FactoryBean 缓存中删除</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (mbd.</span><span style="color:#B392F0;">isSingleton</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        instanceWrapper </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.factoryBeanInstanceCache.</span><span style="color:#B392F0;">remove</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;2&gt; 使用合适的实例化策略来创建新的实例：工厂方法、构造函数自动注入、简单初始化</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (instanceWrapper </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        instanceWrapper </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">createBeanInstance</span><span style="color:#E1E4E8;">(beanName, mbd, args);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 包装的实例对象</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Object bean </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> instanceWrapper.</span><span style="color:#B392F0;">getWrappedInstance</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 包装的实例对象的类型</span></span>
<span class="line"><span style="color:#E1E4E8;">    Class&lt;</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">&gt; beanType </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> instanceWrapper.</span><span style="color:#B392F0;">getWrappedClass</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (beanType </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> NullBean.class) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        mbd.resolvedTargetType </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> beanType;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// Allow post-processors to modify the merged bean definition.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;3&gt; 判断是否有后置处理</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 如果有后置处理，则允许后置处理修改 BeanDefinition</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">synchronized</span><span style="color:#E1E4E8;"> (mbd.postProcessingLock) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">mbd.postProcessed) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 后置处理修改 BeanDefinition</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#B392F0;">applyMergedBeanDefinitionPostProcessors</span><span style="color:#E1E4E8;">(mbd, beanType, beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">            } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (Throwable </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanCreationException</span><span style="color:#E1E4E8;">(mbd.</span><span style="color:#B392F0;">getResourceDescription</span><span style="color:#E1E4E8;">(), beanName,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&quot;Post-processing of merged bean definition failed&quot;</span><span style="color:#E1E4E8;">, ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            mbd.postProcessed </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// Eagerly cache singletons to be able to resolve circular references</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;4&gt; 解决单例模式的循环依赖</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> earlySingletonExposure </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (mbd.</span><span style="color:#B392F0;">isSingleton</span><span style="color:#E1E4E8;">() </span><span style="color:#6A737D;">// 单例模式</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.allowCircularReferences </span><span style="color:#6A737D;">// 运行循环依赖</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">isSingletonCurrentlyInCreation</span><span style="color:#E1E4E8;">(beanName)); </span><span style="color:#6A737D;">// 当前单例 bean 是否正在被创建</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (earlySingletonExposure) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (logger.</span><span style="color:#B392F0;">isTraceEnabled</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            logger.</span><span style="color:#B392F0;">trace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Eagerly caching bean &#39;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> beanName </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#9ECBFF;">&quot;&#39; to allow for resolving potential circular references&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 提前将创建的 bean 实例加入到 singletonFactories 中</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 这里是为了后期避免循环依赖</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">addSingletonFactory</span><span style="color:#E1E4E8;">(beanName, () </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getEarlyBeanReference</span><span style="color:#E1E4E8;">(beanName, mbd, bean));</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// Initialize the bean instance.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 开始初始化 bean 实例对象</span></span>
<span class="line"><span style="color:#E1E4E8;">    Object exposedObject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> bean;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// &lt;5&gt; 对 bean 进行填充，将各个属性值注入，其中，可能存在依赖于其他 bean 的属性</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 则会递归初始依赖 bean</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">populateBean</span><span style="color:#E1E4E8;">(beanName, mbd, instanceWrapper);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// &lt;6&gt; 调用初始化方法</span></span>
<span class="line"><span style="color:#E1E4E8;">        exposedObject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">initializeBean</span><span style="color:#E1E4E8;">(beanName, exposedObject, mbd);</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (Throwable </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (ex </span><span style="color:#F97583;">instanceof</span><span style="color:#E1E4E8;"> BeanCreationException </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> beanName.</span><span style="color:#B392F0;">equals</span><span style="color:#E1E4E8;">(((BeanCreationException) ex).</span><span style="color:#B392F0;">getBeanName</span><span style="color:#E1E4E8;">())) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> (BeanCreationException) ex;</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanCreationException</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">                    mbd.</span><span style="color:#B392F0;">getResourceDescription</span><span style="color:#E1E4E8;">(), beanName, </span><span style="color:#9ECBFF;">&quot;Initialization of bean failed&quot;</span><span style="color:#E1E4E8;">, ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;7&gt; 循环依赖处理</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (earlySingletonExposure) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 获取 earlySingletonReference</span></span>
<span class="line"><span style="color:#E1E4E8;">        Object earlySingletonReference </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getSingleton</span><span style="color:#E1E4E8;">(beanName, </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 只有在存在循环依赖的情况下，earlySingletonReference 才不会为空</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (earlySingletonReference </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 如果 exposedObject 没有在初始化方法中被改变，也就是没有被增强</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (exposedObject </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> bean) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                exposedObject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> earlySingletonReference;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 处理依赖</span></span>
<span class="line"><span style="color:#E1E4E8;">            } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.allowRawInjectionDespiteWrapping </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hasDependentBean</span><span style="color:#E1E4E8;">(beanName)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] dependentBeans </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getDependentBeans</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                Set&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; actualDependentBeans </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> LinkedHashSet&lt;&gt;(dependentBeans.length);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (String dependentBean </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> dependentBeans) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">removeSingletonIfCreatedForTypeCheckOnly</span><span style="color:#E1E4E8;">(dependentBean)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        actualDependentBeans.</span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(dependentBean);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    }</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">actualDependentBeans.</span><span style="color:#B392F0;">isEmpty</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanCurrentlyInCreationException</span><span style="color:#E1E4E8;">(beanName,</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#9ECBFF;">&quot;Bean with name &#39;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> beanName </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&#39; has been injected into other beans [&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                            StringUtils.</span><span style="color:#B392F0;">collectionToCommaDelimitedString</span><span style="color:#E1E4E8;">(actualDependentBeans) </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#9ECBFF;">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#9ECBFF;">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#9ECBFF;">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#9ECBFF;">&quot;&#39;getBeanNamesOfType&#39; with the &#39;allowEagerInit&#39; flag turned off, for example.&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// Register bean as disposable.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;8&gt; 注册 bean</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">registerDisposableBeanIfNecessary</span><span style="color:#E1E4E8;">(beanName, bean, mbd);</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (BeanDefinitionValidationException </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanCreationException</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">                mbd.</span><span style="color:#B392F0;">getResourceDescription</span><span style="color:#E1E4E8;">(), beanName, </span><span style="color:#9ECBFF;">&quot;Invalid destruction signature&quot;</span><span style="color:#E1E4E8;">, ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> exposedObject;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> Object </span><span style="color:#6F42C1;">doCreateBean</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String beanName, </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> RootBeanDefinition mbd, </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> @</span><span style="color:#D73A49;">Nullable</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">[] args)</span></span>
<span class="line"><span style="color:#24292E;">        throws BeanCreationException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// Instantiate the bean.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// BeanWrapper 是对 Bean 的包装，其接口中所定义的功能很简单包括设置获取被包装的对象，获取被包装 bean 的属性描述器</span></span>
<span class="line"><span style="color:#24292E;">    BeanWrapper instanceWrapper </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;1&gt; 单例模型，则从未完成的 FactoryBean 缓存中删除</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (mbd.</span><span style="color:#6F42C1;">isSingleton</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">        instanceWrapper </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.factoryBeanInstanceCache.</span><span style="color:#6F42C1;">remove</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;2&gt; 使用合适的实例化策略来创建新的实例：工厂方法、构造函数自动注入、简单初始化</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (instanceWrapper </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        instanceWrapper </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">createBeanInstance</span><span style="color:#24292E;">(beanName, mbd, args);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 包装的实例对象</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Object bean </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> instanceWrapper.</span><span style="color:#6F42C1;">getWrappedInstance</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 包装的实例对象的类型</span></span>
<span class="line"><span style="color:#24292E;">    Class&lt;</span><span style="color:#D73A49;">?</span><span style="color:#24292E;">&gt; beanType </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> instanceWrapper.</span><span style="color:#6F42C1;">getWrappedClass</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (beanType </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> NullBean.class) {</span></span>
<span class="line"><span style="color:#24292E;">        mbd.resolvedTargetType </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> beanType;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// Allow post-processors to modify the merged bean definition.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;3&gt; 判断是否有后置处理</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 如果有后置处理，则允许后置处理修改 BeanDefinition</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">synchronized</span><span style="color:#24292E;"> (mbd.postProcessingLock) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">mbd.postProcessed) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 后置处理修改 BeanDefinition</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">applyMergedBeanDefinitionPostProcessors</span><span style="color:#24292E;">(mbd, beanType, beanName);</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (Throwable </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanCreationException</span><span style="color:#24292E;">(mbd.</span><span style="color:#6F42C1;">getResourceDescription</span><span style="color:#24292E;">(), beanName,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&quot;Post-processing of merged bean definition failed&quot;</span><span style="color:#24292E;">, ex);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            mbd.postProcessed </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// Eagerly cache singletons to be able to resolve circular references</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;4&gt; 解决单例模式的循环依赖</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> earlySingletonExposure </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (mbd.</span><span style="color:#6F42C1;">isSingleton</span><span style="color:#24292E;">() </span><span style="color:#6A737D;">// 单例模式</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.allowCircularReferences </span><span style="color:#6A737D;">// 运行循环依赖</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">isSingletonCurrentlyInCreation</span><span style="color:#24292E;">(beanName)); </span><span style="color:#6A737D;">// 当前单例 bean 是否正在被创建</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (earlySingletonExposure) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (logger.</span><span style="color:#6F42C1;">isTraceEnabled</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">            logger.</span><span style="color:#6F42C1;">trace</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Eagerly caching bean &#39;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> beanName </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#032F62;">&quot;&#39; to allow for resolving potential circular references&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 提前将创建的 bean 实例加入到 singletonFactories 中</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 这里是为了后期避免循环依赖</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">addSingletonFactory</span><span style="color:#24292E;">(beanName, () </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getEarlyBeanReference</span><span style="color:#24292E;">(beanName, mbd, bean));</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// Initialize the bean instance.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 开始初始化 bean 实例对象</span></span>
<span class="line"><span style="color:#24292E;">    Object exposedObject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> bean;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// &lt;5&gt; 对 bean 进行填充，将各个属性值注入，其中，可能存在依赖于其他 bean 的属性</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 则会递归初始依赖 bean</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">populateBean</span><span style="color:#24292E;">(beanName, mbd, instanceWrapper);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// &lt;6&gt; 调用初始化方法</span></span>
<span class="line"><span style="color:#24292E;">        exposedObject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">initializeBean</span><span style="color:#24292E;">(beanName, exposedObject, mbd);</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (Throwable </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (ex </span><span style="color:#D73A49;">instanceof</span><span style="color:#24292E;"> BeanCreationException </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> beanName.</span><span style="color:#6F42C1;">equals</span><span style="color:#24292E;">(((BeanCreationException) ex).</span><span style="color:#6F42C1;">getBeanName</span><span style="color:#24292E;">())) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> (BeanCreationException) ex;</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanCreationException</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                    mbd.</span><span style="color:#6F42C1;">getResourceDescription</span><span style="color:#24292E;">(), beanName, </span><span style="color:#032F62;">&quot;Initialization of bean failed&quot;</span><span style="color:#24292E;">, ex);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;7&gt; 循环依赖处理</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (earlySingletonExposure) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 获取 earlySingletonReference</span></span>
<span class="line"><span style="color:#24292E;">        Object earlySingletonReference </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getSingleton</span><span style="color:#24292E;">(beanName, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 只有在存在循环依赖的情况下，earlySingletonReference 才不会为空</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (earlySingletonReference </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 如果 exposedObject 没有在初始化方法中被改变，也就是没有被增强</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (exposedObject </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> bean) {</span></span>
<span class="line"><span style="color:#24292E;">                exposedObject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> earlySingletonReference;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 处理依赖</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.allowRawInjectionDespiteWrapping </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hasDependentBean</span><span style="color:#24292E;">(beanName)) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] dependentBeans </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getDependentBeans</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">                Set&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; actualDependentBeans </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> LinkedHashSet&lt;&gt;(dependentBeans.length);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (String dependentBean </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> dependentBeans) {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#6F42C1;">removeSingletonIfCreatedForTypeCheckOnly</span><span style="color:#24292E;">(dependentBean)) {</span></span>
<span class="line"><span style="color:#24292E;">                        actualDependentBeans.</span><span style="color:#6F42C1;">add</span><span style="color:#24292E;">(dependentBean);</span></span>
<span class="line"><span style="color:#24292E;">                    }</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">actualDependentBeans.</span><span style="color:#6F42C1;">isEmpty</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanCurrentlyInCreationException</span><span style="color:#24292E;">(beanName,</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#032F62;">&quot;Bean with name &#39;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> beanName </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&#39; has been injected into other beans [&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                            StringUtils.</span><span style="color:#6F42C1;">collectionToCommaDelimitedString</span><span style="color:#24292E;">(actualDependentBeans) </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#032F62;">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#032F62;">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#032F62;">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#032F62;">&quot;&#39;getBeanNamesOfType&#39; with the &#39;allowEagerInit&#39; flag turned off, for example.&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// Register bean as disposable.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;8&gt; 注册 bean</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">registerDisposableBeanIfNecessary</span><span style="color:#24292E;">(beanName, bean, mbd);</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (BeanDefinitionValidationException </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanCreationException</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                mbd.</span><span style="color:#6F42C1;">getResourceDescription</span><span style="color:#24292E;">(), beanName, </span><span style="color:#032F62;">&quot;Invalid destruction signature&quot;</span><span style="color:#24292E;">, ex);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> exposedObject;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>整体的思路：</p><ul><li><code>&lt;1&gt;</code> 处，如果是单例模式，则清除缓存。</li><li><code>&lt;2&gt;</code> 处，调用 <code>#createBeanInstance(String beanName, RootBeanDefinition mbd, Object[] args)</code> 方法，实例化 bean ，主要是将 BeanDefinition 转换为 <code>org.springframework.beans.BeanWrapper</code> 对象。</li><li><code>&lt;3&gt;</code> 处，MergedBeanDefinitionPostProcessor 的应用。</li><li><code>&lt;4&gt;</code> 处，单例模式的循环依赖处理</li><li><code>&lt;5&gt;</code> 处，调用 <code>#populateBean(String beanName, RootBeanDefinition mbd, BeanWrapper bw)</code> 方法，进行属性填充。将所有属性填充至 bean 的实例中。</li><li><code>&lt;6&gt;</code> 处，调用 <code>#initializeBean(final String beanName, final Object bean, RootBeanDefinition mbd)</code> 方法，初始化 bean 。</li><li><code>&lt;7&gt;</code> 处，依赖检查</li><li><code>&lt;8&gt;</code> 处，注册 DisposableBean</li></ul><h5 id="createbeaninstance" tabindex="-1">createBeanInstance(...) <a class="header-anchor" href="#createbeaninstance" aria-label="Permalink to &quot;createBeanInstance(...)&quot;">​</a></h5><p>对于 <code>#createBeanInstance(...)</code> 方法而言，他就是<strong>选择合适实例化策略</strong>来为 bean 创建实例对象，具体的策略有：</p><ul><li>Supplier 回调方式</li><li>工厂方法初始化</li><li>构造函数自动注入初始化</li><li>默认构造函数注入。</li></ul><p>其中，工厂方法初始化和构造函数自动注入初始化两种方式<strong>最为复杂</strong>，主要是因为构造函数和构造参数的不确定性，Spring 需要花大量的精力来确定构造函数和构造参数，如果确定了则好办，直接选择实例化策略即可。</p><p>当然，在实例化的时候会根据是否有需要覆盖或者动态替换掉的方法，因为存在覆盖或者织入的话需要创建动态代理将方法织入，这个时候就只能选择 CGLIB 的方式来实例化，否则直接利用反射的方式即可，方便快捷。</p><h5 id="addsingletonfactory" tabindex="-1">addSingletonFactory(...) <a class="header-anchor" href="#addsingletonfactory" aria-label="Permalink to &quot;addSingletonFactory(...)&quot;">​</a></h5><blockquote><p>解析见 Spring 循环依赖</p></blockquote><h5 id="populatebean" tabindex="-1">populateBean(...) <a class="header-anchor" href="#populatebean" aria-label="Permalink to &quot;populateBean(...)&quot;">​</a></h5><blockquote><p>该函数的作用是将 BeanDefinition 中的属性值赋值给 BeanWrapper 实例对象</p></blockquote><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">populateBean</span><span style="color:#E1E4E8;">(String beanName, RootBeanDefinition mbd, @</span><span style="color:#F97583;">Nullable</span><span style="color:#E1E4E8;"> BeanWrapper bw) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 没有实例化对象</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (bw </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 有属性，则抛出 BeanCreationException 异常</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (mbd.</span><span style="color:#B392F0;">hasPropertyValues</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanCreationException</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">                    mbd.</span><span style="color:#B392F0;">getResourceDescription</span><span style="color:#E1E4E8;">(), beanName, </span><span style="color:#9ECBFF;">&quot;Cannot apply property values to null instance&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 没有属性，直接 return 返回</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// Skip property population phase for null instance.</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;1&gt; 在设置属性之前给 InstantiationAwareBeanPostProcessors 最后一次改变 bean 的机会</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// Give any InstantiationAwareBeanPostProcessors the opportunity to modify the</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// state of the bean before properties are set. This can be used, for example,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// to support styles of field injection.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> continueWithPropertyPopulation </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">mbd.</span><span style="color:#B392F0;">isSynthetic</span><span style="color:#E1E4E8;">()  </span><span style="color:#6A737D;">// bean 不是&quot;合成&quot;的，即未由应用程序本身定义</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hasInstantiationAwareBeanPostProcessors</span><span style="color:#E1E4E8;">()) { </span><span style="color:#6A737D;">// 是否持有 InstantiationAwareBeanPostProcessor</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 迭代所有的 BeanPostProcessors</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (BeanPostProcessor bp </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getBeanPostProcessors</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (bp </span><span style="color:#F97583;">instanceof</span><span style="color:#E1E4E8;"> InstantiationAwareBeanPostProcessor) { </span><span style="color:#6A737D;">// 如果为 InstantiationAwareBeanPostProcessor</span></span>
<span class="line"><span style="color:#E1E4E8;">                InstantiationAwareBeanPostProcessor ibp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (InstantiationAwareBeanPostProcessor) bp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 返回值为是否继续填充 bean</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// postProcessAfterInstantiation：如果应该在 bean上面设置属性则返回 true，否则返回 false</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 一般情况下，应该是返回true 。</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 返回 false 的话，将会阻止在此 Bean 实例上调用任何后续的 InstantiationAwareBeanPostProcessor 实例。</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">ibp.</span><span style="color:#B392F0;">postProcessAfterInstantiation</span><span style="color:#E1E4E8;">(bw.</span><span style="color:#B392F0;">getWrappedInstance</span><span style="color:#E1E4E8;">(), beanName)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    continueWithPropertyPopulation </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 如果后续处理器发出停止填充命令，则终止后续操作</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">continueWithPropertyPopulation) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// bean 的属性值</span></span>
<span class="line"><span style="color:#E1E4E8;">    PropertyValues pvs </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (mbd.</span><span style="color:#B392F0;">hasPropertyValues</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> mbd.</span><span style="color:#B392F0;">getPropertyValues</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;2&gt; 自动注入</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (mbd.</span><span style="color:#B392F0;">getResolvedAutowireMode</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> AUTOWIRE_BY_NAME </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> mbd.</span><span style="color:#B392F0;">getResolvedAutowireMode</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> AUTOWIRE_BY_TYPE) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 将 PropertyValues 封装成 MutablePropertyValues 对象</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// MutablePropertyValues 允许对属性进行简单的操作，并提供构造函数以支持Map的深度复制和构造。</span></span>
<span class="line"><span style="color:#E1E4E8;">        MutablePropertyValues newPvs </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">MutablePropertyValues</span><span style="color:#E1E4E8;">(pvs);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// Add property values based on autowire by name if applicable.</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 根据名称自动注入</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (mbd.</span><span style="color:#B392F0;">getResolvedAutowireMode</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> AUTOWIRE_BY_NAME) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">autowireByName</span><span style="color:#E1E4E8;">(beanName, mbd, bw, newPvs);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// Add property values based on autowire by type if applicable.</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 根据类型自动注入</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (mbd.</span><span style="color:#B392F0;">getResolvedAutowireMode</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> AUTOWIRE_BY_TYPE) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">autowireByType</span><span style="color:#E1E4E8;">(beanName, mbd, bw, newPvs);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        pvs </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> newPvs;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 是否已经注册了 InstantiationAwareBeanPostProcessors</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> hasInstAwareBpps </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hasInstantiationAwareBeanPostProcessors</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 是否需要进行【依赖检查】</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> needsDepCheck </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (mbd.</span><span style="color:#B392F0;">getDependencyCheck</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> AbstractBeanDefinition.DEPENDENCY_CHECK_NONE);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;3&gt; BeanPostProcessor 处理</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">PropertyDescriptor</span><span style="color:#E1E4E8;">[] filteredPds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (hasInstAwareBpps) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (pvs </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            pvs </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> mbd.</span><span style="color:#B392F0;">getPropertyValues</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 遍历 BeanPostProcessor 数组</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (BeanPostProcessor bp </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getBeanPostProcessors</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (bp </span><span style="color:#F97583;">instanceof</span><span style="color:#E1E4E8;"> InstantiationAwareBeanPostProcessor) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                InstantiationAwareBeanPostProcessor ibp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (InstantiationAwareBeanPostProcessor) bp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 对所有需要依赖检查的属性进行后处理</span></span>
<span class="line"><span style="color:#E1E4E8;">                PropertyValues pvsToUse </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ibp.</span><span style="color:#B392F0;">postProcessProperties</span><span style="color:#E1E4E8;">(pvs, bw.</span><span style="color:#B392F0;">getWrappedInstance</span><span style="color:#E1E4E8;">(), beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (pvsToUse </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 从 bw 对象中提取 PropertyDescriptor 结果集</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// PropertyDescriptor：可以通过一对存取方法提取一个属性</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (filteredPds </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        filteredPds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">filterPropertyDescriptorsForDependencyCheck</span><span style="color:#E1E4E8;">(bw, mbd.allowCaching);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    }</span></span>
<span class="line"><span style="color:#E1E4E8;">                    pvsToUse </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ibp.</span><span style="color:#B392F0;">postProcessPropertyValues</span><span style="color:#E1E4E8;">(pvs, filteredPds, bw.</span><span style="color:#B392F0;">getWrappedInstance</span><span style="color:#E1E4E8;">(), beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (pvsToUse </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    }</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">                pvs </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> pvsToUse;</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;4&gt; 依赖检查</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (needsDepCheck) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (filteredPds </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            filteredPds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">filterPropertyDescriptorsForDependencyCheck</span><span style="color:#E1E4E8;">(bw, mbd.allowCaching);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 依赖检查，对应 depends-on 属性</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">checkDependencies</span><span style="color:#E1E4E8;">(beanName, mbd, filteredPds, pvs);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;5&gt; 将属性应用到 bean 中</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (pvs </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">applyPropertyValues</span><span style="color:#E1E4E8;">(beanName, mbd, bw, pvs);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">populateBean</span><span style="color:#24292E;">(String beanName, RootBeanDefinition mbd, @</span><span style="color:#D73A49;">Nullable</span><span style="color:#24292E;"> BeanWrapper bw) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 没有实例化对象</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (bw </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 有属性，则抛出 BeanCreationException 异常</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (mbd.</span><span style="color:#6F42C1;">hasPropertyValues</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanCreationException</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                    mbd.</span><span style="color:#6F42C1;">getResourceDescription</span><span style="color:#24292E;">(), beanName, </span><span style="color:#032F62;">&quot;Cannot apply property values to null instance&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 没有属性，直接 return 返回</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// Skip property population phase for null instance.</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;1&gt; 在设置属性之前给 InstantiationAwareBeanPostProcessors 最后一次改变 bean 的机会</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// Give any InstantiationAwareBeanPostProcessors the opportunity to modify the</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// state of the bean before properties are set. This can be used, for example,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// to support styles of field injection.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> continueWithPropertyPopulation </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">mbd.</span><span style="color:#6F42C1;">isSynthetic</span><span style="color:#24292E;">()  </span><span style="color:#6A737D;">// bean 不是&quot;合成&quot;的，即未由应用程序本身定义</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hasInstantiationAwareBeanPostProcessors</span><span style="color:#24292E;">()) { </span><span style="color:#6A737D;">// 是否持有 InstantiationAwareBeanPostProcessor</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 迭代所有的 BeanPostProcessors</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (BeanPostProcessor bp </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getBeanPostProcessors</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (bp </span><span style="color:#D73A49;">instanceof</span><span style="color:#24292E;"> InstantiationAwareBeanPostProcessor) { </span><span style="color:#6A737D;">// 如果为 InstantiationAwareBeanPostProcessor</span></span>
<span class="line"><span style="color:#24292E;">                InstantiationAwareBeanPostProcessor ibp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (InstantiationAwareBeanPostProcessor) bp;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 返回值为是否继续填充 bean</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// postProcessAfterInstantiation：如果应该在 bean上面设置属性则返回 true，否则返回 false</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 一般情况下，应该是返回true 。</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 返回 false 的话，将会阻止在此 Bean 实例上调用任何后续的 InstantiationAwareBeanPostProcessor 实例。</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">ibp.</span><span style="color:#6F42C1;">postProcessAfterInstantiation</span><span style="color:#24292E;">(bw.</span><span style="color:#6F42C1;">getWrappedInstance</span><span style="color:#24292E;">(), beanName)) {</span></span>
<span class="line"><span style="color:#24292E;">                    continueWithPropertyPopulation </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 如果后续处理器发出停止填充命令，则终止后续操作</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">continueWithPropertyPopulation) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// bean 的属性值</span></span>
<span class="line"><span style="color:#24292E;">    PropertyValues pvs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (mbd.</span><span style="color:#6F42C1;">hasPropertyValues</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> mbd.</span><span style="color:#6F42C1;">getPropertyValues</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;2&gt; 自动注入</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (mbd.</span><span style="color:#6F42C1;">getResolvedAutowireMode</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> AUTOWIRE_BY_NAME </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> mbd.</span><span style="color:#6F42C1;">getResolvedAutowireMode</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> AUTOWIRE_BY_TYPE) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 将 PropertyValues 封装成 MutablePropertyValues 对象</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// MutablePropertyValues 允许对属性进行简单的操作，并提供构造函数以支持Map的深度复制和构造。</span></span>
<span class="line"><span style="color:#24292E;">        MutablePropertyValues newPvs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MutablePropertyValues</span><span style="color:#24292E;">(pvs);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// Add property values based on autowire by name if applicable.</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 根据名称自动注入</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (mbd.</span><span style="color:#6F42C1;">getResolvedAutowireMode</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> AUTOWIRE_BY_NAME) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">autowireByName</span><span style="color:#24292E;">(beanName, mbd, bw, newPvs);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// Add property values based on autowire by type if applicable.</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 根据类型自动注入</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (mbd.</span><span style="color:#6F42C1;">getResolvedAutowireMode</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> AUTOWIRE_BY_TYPE) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">autowireByType</span><span style="color:#24292E;">(beanName, mbd, bw, newPvs);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        pvs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> newPvs;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 是否已经注册了 InstantiationAwareBeanPostProcessors</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> hasInstAwareBpps </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hasInstantiationAwareBeanPostProcessors</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 是否需要进行【依赖检查】</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> needsDepCheck </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (mbd.</span><span style="color:#6F42C1;">getDependencyCheck</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> AbstractBeanDefinition.DEPENDENCY_CHECK_NONE);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;3&gt; BeanPostProcessor 处理</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">PropertyDescriptor</span><span style="color:#24292E;">[] filteredPds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (hasInstAwareBpps) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (pvs </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            pvs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> mbd.</span><span style="color:#6F42C1;">getPropertyValues</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 遍历 BeanPostProcessor 数组</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (BeanPostProcessor bp </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getBeanPostProcessors</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (bp </span><span style="color:#D73A49;">instanceof</span><span style="color:#24292E;"> InstantiationAwareBeanPostProcessor) {</span></span>
<span class="line"><span style="color:#24292E;">                InstantiationAwareBeanPostProcessor ibp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (InstantiationAwareBeanPostProcessor) bp;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 对所有需要依赖检查的属性进行后处理</span></span>
<span class="line"><span style="color:#24292E;">                PropertyValues pvsToUse </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ibp.</span><span style="color:#6F42C1;">postProcessProperties</span><span style="color:#24292E;">(pvs, bw.</span><span style="color:#6F42C1;">getWrappedInstance</span><span style="color:#24292E;">(), beanName);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (pvsToUse </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 从 bw 对象中提取 PropertyDescriptor 结果集</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// PropertyDescriptor：可以通过一对存取方法提取一个属性</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (filteredPds </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                        filteredPds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">filterPropertyDescriptorsForDependencyCheck</span><span style="color:#24292E;">(bw, mbd.allowCaching);</span></span>
<span class="line"><span style="color:#24292E;">                    }</span></span>
<span class="line"><span style="color:#24292E;">                    pvsToUse </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ibp.</span><span style="color:#6F42C1;">postProcessPropertyValues</span><span style="color:#24292E;">(pvs, filteredPds, bw.</span><span style="color:#6F42C1;">getWrappedInstance</span><span style="color:#24292E;">(), beanName);</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (pvsToUse </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                    }</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">                pvs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> pvsToUse;</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;4&gt; 依赖检查</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (needsDepCheck) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (filteredPds </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            filteredPds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">filterPropertyDescriptorsForDependencyCheck</span><span style="color:#24292E;">(bw, mbd.allowCaching);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 依赖检查，对应 depends-on 属性</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">checkDependencies</span><span style="color:#24292E;">(beanName, mbd, filteredPds, pvs);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;5&gt; 将属性应用到 bean 中</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (pvs </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">applyPropertyValues</span><span style="color:#24292E;">(beanName, mbd, bw, pvs);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>处理流程如下：</p><ul><li><p><code>&lt;1&gt;</code> ，根据 <code>hasInstantiationAwareBeanPostProcessors</code> 属性来判断，是否需要在注入属性之前给 InstantiationAwareBeanPostProcessors 最后一次改变 bean 的机会。<strong>此过程可以控制 Spring 是否继续进行属性填充</strong>。</p></li><li><p>统一存入到 PropertyValues 中，PropertyValues 用于描述 bean 的属性。</p><p><code>&lt;2&gt;</code>根据注入类型(AbstractBeanDefinition#getResolvedAutowireMode()方法的返回值 )的不同来判断：</p><ul><li><p>是根据名称来自动注入（<code>#autowireByName(...)</code>）</p></li><li><p>还是根据类型来自动注入（<code>#autowireByType(...)</code>）</p></li><li><p><code>&lt;3&gt;</code> ，进行 BeanPostProcessor 处理。</p></li><li><p><code>&lt;4&gt;</code> ，依赖检测。</p></li></ul></li><li><p><code>&lt;5&gt;</code> ，将所有 PropertyValues 中的属性，填充到 BeanWrapper 中。</p></li></ul><h5 id="initializebean" tabindex="-1">initializeBean(...) <a class="header-anchor" href="#initializebean" aria-label="Permalink to &quot;initializeBean(...)&quot;">​</a></h5><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> Object </span><span style="color:#B392F0;">initializeBean</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> String beanName, </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Object bean, @</span><span style="color:#F97583;">Nullable</span><span style="color:#E1E4E8;"> RootBeanDefinition mbd) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (System.</span><span style="color:#B392F0;">getSecurityManager</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// 安全模式</span></span>
<span class="line"><span style="color:#E1E4E8;">        AccessController.</span><span style="color:#B392F0;">doPrivileged</span><span style="color:#E1E4E8;">((PrivilegedAction</span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">Object</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">) () </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// &lt;1&gt; 激活 Aware 方法，对特殊的 bean 处理：Aware、BeanClassLoaderAware、BeanFactoryAware</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">invokeAwareMethods</span><span style="color:#E1E4E8;">(beanName, bean);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }, </span><span style="color:#B392F0;">getAccessControlContext</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// &lt;1&gt; 激活 Aware 方法，对特殊的 bean 处理：Aware、BeanClassLoaderAware、BeanFactoryAware</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">invokeAwareMethods</span><span style="color:#E1E4E8;">(beanName, bean);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;2&gt; 后处理器，before</span></span>
<span class="line"><span style="color:#E1E4E8;">    Object wrappedBean </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> bean;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (mbd </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">mbd.</span><span style="color:#B392F0;">isSynthetic</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        wrappedBean </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">applyBeanPostProcessorsBeforeInitialization</span><span style="color:#E1E4E8;">(wrappedBean, beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;3&gt; 激活用户自定义的 init 方法</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">invokeInitMethods</span><span style="color:#E1E4E8;">(beanName, wrappedBean, mbd);</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (Throwable </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanCreationException</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">                (mbd </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> mbd.</span><span style="color:#B392F0;">getResourceDescription</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">                beanName, </span><span style="color:#9ECBFF;">&quot;Invocation of init method failed&quot;</span><span style="color:#E1E4E8;">, ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;2&gt; 后处理器，after</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (mbd </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">mbd.</span><span style="color:#B392F0;">isSynthetic</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        wrappedBean </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">applyBeanPostProcessorsAfterInitialization</span><span style="color:#E1E4E8;">(wrappedBean, beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> wrappedBean;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> Object </span><span style="color:#6F42C1;">initializeBean</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String beanName, </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Object bean, @</span><span style="color:#D73A49;">Nullable</span><span style="color:#24292E;"> RootBeanDefinition mbd) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (System.</span><span style="color:#6F42C1;">getSecurityManager</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// 安全模式</span></span>
<span class="line"><span style="color:#24292E;">        AccessController.</span><span style="color:#6F42C1;">doPrivileged</span><span style="color:#24292E;">((PrivilegedAction</span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">Object</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">) () </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// &lt;1&gt; 激活 Aware 方法，对特殊的 bean 处理：Aware、BeanClassLoaderAware、BeanFactoryAware</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">invokeAwareMethods</span><span style="color:#24292E;">(beanName, bean);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }, </span><span style="color:#6F42C1;">getAccessControlContext</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// &lt;1&gt; 激活 Aware 方法，对特殊的 bean 处理：Aware、BeanClassLoaderAware、BeanFactoryAware</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">invokeAwareMethods</span><span style="color:#24292E;">(beanName, bean);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;2&gt; 后处理器，before</span></span>
<span class="line"><span style="color:#24292E;">    Object wrappedBean </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> bean;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (mbd </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!</span><span style="color:#24292E;">mbd.</span><span style="color:#6F42C1;">isSynthetic</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">        wrappedBean </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">applyBeanPostProcessorsBeforeInitialization</span><span style="color:#24292E;">(wrappedBean, beanName);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;3&gt; 激活用户自定义的 init 方法</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">invokeInitMethods</span><span style="color:#24292E;">(beanName, wrappedBean, mbd);</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (Throwable </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanCreationException</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                (mbd </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> mbd.</span><span style="color:#6F42C1;">getResourceDescription</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">                beanName, </span><span style="color:#032F62;">&quot;Invocation of init method failed&quot;</span><span style="color:#24292E;">, ex);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;2&gt; 后处理器，after</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (mbd </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!</span><span style="color:#24292E;">mbd.</span><span style="color:#6F42C1;">isSynthetic</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">        wrappedBean </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">applyBeanPostProcessorsAfterInitialization</span><span style="color:#24292E;">(wrappedBean, beanName);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> wrappedBean;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>初始化 bean 的方法其实就是三个步骤的处理，而这三个步骤主要还是根据<strong>用户设定</strong>的来进行初始化，这三个过程为：</p><ul><li><p><code>&lt;1&gt;</code> 激活 Aware 方法。</p></li><li><p><code>&lt;2&gt;</code> 后置处理器的应用。</p><ul><li><p><code>#applyBeanPostProcessorsBeforeInitialization(...)</code> 方法，代码如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">@Override</span></span>
<span class="line"><span style="color:#e1e4e8;">public Object applyBeanPostProcessorsBeforeInitialization(Object existingBean, String beanName)</span></span>
<span class="line"><span style="color:#e1e4e8;">        throws BeansException {</span></span>
<span class="line"><span style="color:#e1e4e8;">    Object result = existingBean;</span></span>
<span class="line"><span style="color:#e1e4e8;">    // 遍历 BeanPostProcessor 数组</span></span>
<span class="line"><span style="color:#e1e4e8;">    for (BeanPostProcessor processor : getBeanPostProcessors()) {</span></span>
<span class="line"><span style="color:#e1e4e8;">        // 处理</span></span>
<span class="line"><span style="color:#e1e4e8;">        Object current = processor.postProcessBeforeInitialization(result, beanName);</span></span>
<span class="line"><span style="color:#e1e4e8;">        // 返回空，则返回 result</span></span>
<span class="line"><span style="color:#e1e4e8;">        if (current == null) {</span></span>
<span class="line"><span style="color:#e1e4e8;">            return result;</span></span>
<span class="line"><span style="color:#e1e4e8;">        }</span></span>
<span class="line"><span style="color:#e1e4e8;">        // 修改 result</span></span>
<span class="line"><span style="color:#e1e4e8;">        result = current;</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;">    return result;</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">@Override</span></span>
<span class="line"><span style="color:#24292e;">public Object applyBeanPostProcessorsBeforeInitialization(Object existingBean, String beanName)</span></span>
<span class="line"><span style="color:#24292e;">        throws BeansException {</span></span>
<span class="line"><span style="color:#24292e;">    Object result = existingBean;</span></span>
<span class="line"><span style="color:#24292e;">    // 遍历 BeanPostProcessor 数组</span></span>
<span class="line"><span style="color:#24292e;">    for (BeanPostProcessor processor : getBeanPostProcessors()) {</span></span>
<span class="line"><span style="color:#24292e;">        // 处理</span></span>
<span class="line"><span style="color:#24292e;">        Object current = processor.postProcessBeforeInitialization(result, beanName);</span></span>
<span class="line"><span style="color:#24292e;">        // 返回空，则返回 result</span></span>
<span class="line"><span style="color:#24292e;">        if (current == null) {</span></span>
<span class="line"><span style="color:#24292e;">            return result;</span></span>
<span class="line"><span style="color:#24292e;">        }</span></span>
<span class="line"><span style="color:#24292e;">        // 修改 result</span></span>
<span class="line"><span style="color:#24292e;">        result = current;</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;">    return result;</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div></li><li><p><code>#applyBeanPostProcessorsAfterInitialization(...)</code> 方法，代码如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">@Override</span></span>
<span class="line"><span style="color:#e1e4e8;">public Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName)</span></span>
<span class="line"><span style="color:#e1e4e8;">        throws BeansException {</span></span>
<span class="line"><span style="color:#e1e4e8;">    Object result = existingBean;</span></span>
<span class="line"><span style="color:#e1e4e8;">    // 遍历 BeanPostProcessor</span></span>
<span class="line"><span style="color:#e1e4e8;">    for (BeanPostProcessor processor : getBeanPostProcessors()) {</span></span>
<span class="line"><span style="color:#e1e4e8;">        // 处理</span></span>
<span class="line"><span style="color:#e1e4e8;">        Object current = processor.postProcessAfterInitialization(result, beanName);</span></span>
<span class="line"><span style="color:#e1e4e8;">        // 返回空，则返回 result</span></span>
<span class="line"><span style="color:#e1e4e8;">        if (current == null) {</span></span>
<span class="line"><span style="color:#e1e4e8;">            return result;</span></span>
<span class="line"><span style="color:#e1e4e8;">        }</span></span>
<span class="line"><span style="color:#e1e4e8;">        // 修改 result</span></span>
<span class="line"><span style="color:#e1e4e8;">        result = current;</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;">    return result;</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">@Override</span></span>
<span class="line"><span style="color:#24292e;">public Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName)</span></span>
<span class="line"><span style="color:#24292e;">        throws BeansException {</span></span>
<span class="line"><span style="color:#24292e;">    Object result = existingBean;</span></span>
<span class="line"><span style="color:#24292e;">    // 遍历 BeanPostProcessor</span></span>
<span class="line"><span style="color:#24292e;">    for (BeanPostProcessor processor : getBeanPostProcessors()) {</span></span>
<span class="line"><span style="color:#24292e;">        // 处理</span></span>
<span class="line"><span style="color:#24292e;">        Object current = processor.postProcessAfterInitialization(result, beanName);</span></span>
<span class="line"><span style="color:#24292e;">        // 返回空，则返回 result</span></span>
<span class="line"><span style="color:#24292e;">        if (current == null) {</span></span>
<span class="line"><span style="color:#24292e;">            return result;</span></span>
<span class="line"><span style="color:#24292e;">        }</span></span>
<span class="line"><span style="color:#24292e;">        // 修改 result</span></span>
<span class="line"><span style="color:#24292e;">        result = current;</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;">    return result;</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div></li></ul><p>其实，逻辑就是通过 <code>#getBeanPostProcessors()</code> 方法，获取定义的 BeanPostProcessor ，然后分别调用其 <code>#postProcessBeforeInitialization(...)</code>、<code>#postProcessAfterInitialization(...)</code> 方法，进行<strong>自定义</strong>的业务处理。</p></li><li><p><code>&lt;3&gt;</code> 激活自定义的 init 方法。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">invokeInitMethods</span><span style="color:#E1E4E8;">(String beanName, </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Object bean, @</span><span style="color:#F97583;">Nullable</span><span style="color:#E1E4E8;"> RootBeanDefinition mbd)</span></span>
<span class="line"><span style="color:#E1E4E8;">        throws Throwable {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 首先会检查是否是 InitializingBean ，如果是的话需要调用 afterPropertiesSet()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> isInitializingBean </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (bean </span><span style="color:#F97583;">instanceof</span><span style="color:#E1E4E8;"> InitializingBean);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (isInitializingBean </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> (mbd </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">mbd.</span><span style="color:#B392F0;">isExternallyManagedInitMethod</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;afterPropertiesSet&quot;</span><span style="color:#E1E4E8;">))) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (logger.</span><span style="color:#B392F0;">isTraceEnabled</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            logger.</span><span style="color:#B392F0;">trace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Invoking afterPropertiesSet() on bean with name &#39;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> beanName </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&#39;&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (System.</span><span style="color:#B392F0;">getSecurityManager</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// 安全模式</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                AccessController.</span><span style="color:#B392F0;">doPrivileged</span><span style="color:#E1E4E8;">((PrivilegedExceptionAction</span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">Object</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">) () </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// &lt;1&gt; 属性初始化的处理</span></span>
<span class="line"><span style="color:#E1E4E8;">                    ((InitializingBean) bean).</span><span style="color:#B392F0;">afterPropertiesSet</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                }, </span><span style="color:#B392F0;">getAccessControlContext</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">            } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (PrivilegedActionException </span><span style="color:#FFAB70;">pae</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> pae.</span><span style="color:#B392F0;">getException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// &lt;1&gt; 属性初始化的处理</span></span>
<span class="line"><span style="color:#E1E4E8;">            ((InitializingBean) bean).</span><span style="color:#B392F0;">afterPropertiesSet</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (mbd </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> bean.</span><span style="color:#B392F0;">getClass</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> NullBean.class) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        String initMethodName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> mbd.</span><span style="color:#B392F0;">getInitMethodName</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (StringUtils.</span><span style="color:#B392F0;">hasLength</span><span style="color:#E1E4E8;">(initMethodName) </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">(isInitializingBean </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;afterPropertiesSet&quot;</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">equals</span><span style="color:#E1E4E8;">(initMethodName)) </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">mbd.</span><span style="color:#B392F0;">isExternallyManagedInitMethod</span><span style="color:#E1E4E8;">(initMethodName)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// &lt;2&gt; 激活用户自定义的初始化方法</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">invokeCustomInitMethod</span><span style="color:#E1E4E8;">(beanName, bean, mbd);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">invokeInitMethods</span><span style="color:#24292E;">(String beanName, </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Object bean, @</span><span style="color:#D73A49;">Nullable</span><span style="color:#24292E;"> RootBeanDefinition mbd)</span></span>
<span class="line"><span style="color:#24292E;">        throws Throwable {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 首先会检查是否是 InitializingBean ，如果是的话需要调用 afterPropertiesSet()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> isInitializingBean </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (bean </span><span style="color:#D73A49;">instanceof</span><span style="color:#24292E;"> InitializingBean);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (isInitializingBean </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> (mbd </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!</span><span style="color:#24292E;">mbd.</span><span style="color:#6F42C1;">isExternallyManagedInitMethod</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;afterPropertiesSet&quot;</span><span style="color:#24292E;">))) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (logger.</span><span style="color:#6F42C1;">isTraceEnabled</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">            logger.</span><span style="color:#6F42C1;">trace</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Invoking afterPropertiesSet() on bean with name &#39;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> beanName </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&#39;&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (System.</span><span style="color:#6F42C1;">getSecurityManager</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// 安全模式</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                AccessController.</span><span style="color:#6F42C1;">doPrivileged</span><span style="color:#24292E;">((PrivilegedExceptionAction</span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">Object</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">) () </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// &lt;1&gt; 属性初始化的处理</span></span>
<span class="line"><span style="color:#24292E;">                    ((InitializingBean) bean).</span><span style="color:#6F42C1;">afterPropertiesSet</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                }, </span><span style="color:#6F42C1;">getAccessControlContext</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (PrivilegedActionException </span><span style="color:#E36209;">pae</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> pae.</span><span style="color:#6F42C1;">getException</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// &lt;1&gt; 属性初始化的处理</span></span>
<span class="line"><span style="color:#24292E;">            ((InitializingBean) bean).</span><span style="color:#6F42C1;">afterPropertiesSet</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (mbd </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> bean.</span><span style="color:#6F42C1;">getClass</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> NullBean.class) {</span></span>
<span class="line"><span style="color:#24292E;">        String initMethodName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> mbd.</span><span style="color:#6F42C1;">getInitMethodName</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (StringUtils.</span><span style="color:#6F42C1;">hasLength</span><span style="color:#24292E;">(initMethodName) </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">!</span><span style="color:#24292E;">(isInitializingBean </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;afterPropertiesSet&quot;</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">equals</span><span style="color:#24292E;">(initMethodName)) </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">!</span><span style="color:#24292E;">mbd.</span><span style="color:#6F42C1;">isExternallyManagedInitMethod</span><span style="color:#24292E;">(initMethodName)) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// &lt;2&gt; 激活用户自定义的初始化方法</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">invokeCustomInitMethod</span><span style="color:#24292E;">(beanName, bean, mbd);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li>首先，检查是否为 InitializingBean 。如果<strong>是</strong>的话，需要执行 <code>#afterPropertiesSet()</code> 方法，因为我们除了可以使用 <code>init-method</code> 来自定初始化方法外，还可以实现 InitializingBean 接口。接口仅有一个 <code>#afterPropertiesSet()</code> 方法。</li><li>两者的执行先后顺序是先 <code>&lt;1&gt;</code> 的 <code>#afterPropertiesSet()</code> 方法，后 <code>&lt;2&gt;</code> 的 <code>init-method</code> 对应的方法。</li></ul></li></ul><h3 id="bean-生命周期" tabindex="-1">Bean 生命周期 <a class="header-anchor" href="#bean-生命周期" aria-label="Permalink to &quot;Bean 生命周期&quot;">​</a></h3><p>Spring 并不是一启动容器就开启 bean 的实例化进程，只有当客户端通过显示或者隐式的方式调用 BeanFactory 的 <code>#getBean(...)</code> 方法来请求某个实例对象的时候，它才会触发相应 bean 的实例化进程。当然，也可以选择直接使用 ApplicationContext 容器，因为该容器启动的时候会立刻调用注册到该容器所有 bean 定义的实例化方法。当然，对于 BeanFactory 容器而言，并不是所有的 <code>#getBean(...)</code> 方法都会触发实例化进程，比如 singleton 类型的 bean，该类型的 bean 只会在第一次调用 <code>getBean()</code> 的时候才会触发，而后续的调用则会直接返回容器缓存中的实例对象。</p><p><code>#getBean(...)</code> 方法，只是 bean 实例化进程的入口，真正的实现逻辑其实是在 AbstractAutowireCapableBeanFactory 的 <code>#doCreateBean(...)</code> 中实现，实例化过程如下图：</p><p><img src="/assets/image-20220512223328166.6cf3a13d.png" alt="image-20220512223328166"></p><p>Spring Bean 的声明周期过程如下（方法级别）：</p><ol><li>Spring 容器根据实例化策略对 Bean 进行实例化。</li><li>实例化完成后，如果该 bean 设置了一些属性的话，则利用 set 方法设置一些属性。</li><li>如果该 Bean 实现了 BeanNameAware 接口，则调用 <code>#setBeanName(String beanName)</code> 方法。</li><li>如果该 bean 实现了 BeanClassLoaderAware 接口，则调用 <code>setBeanClassLoader(ClassLoader classLoader)</code> 方法。</li><li>如果该 bean 实现了 BeanFactoryAware接口，则调用 <code>setBeanFactory(BeanFactory beanFactory)</code> 方法。</li><li>如果该容器注册了 BeanPostProcessor，则会调用<code>#postProcessBeforeInitialization(Object bean, String beanName)</code> 方法,完成 bean 前置处理</li><li>如果该 bean 实现了 InitializingBean 接口，则调用<code>#afterPropertiesSet()</code> 方法。</li><li>如果该 bean 配置了 <code>init-method</code> 方法，则调用其指定的方法。</li><li>初始化完成后，如果该容器注册了 BeanPostProcessor 则会调用 <code>#postProcessAfterInitialization(Object bean, String beanName)</code> 方法,完成 bean 的后置处理。</li><li>对象完成初始化，开始方法调用。</li><li>在容器进行关闭之前，如果该 bean 实现了 DisposableBean 接口，则调用 <code>#destroy()</code> 方法。</li><li>在容器进行关闭之前，如果该 bean 配置了 <code>destroy-method</code> ，则调用其指定的方法。</li><li>到这里一个 bean 也就完成了它的一生。</li></ol><h3 id="spring-aop" tabindex="-1">Spring AOP <a class="header-anchor" href="#spring-aop" aria-label="Permalink to &quot;Spring AOP&quot;">​</a></h3><p>Spring AOP 结构如下：</p><ul><li>Advice <ul><li>Interceptor <ul><li>MethodInterceptor</li></ul></li></ul></li><li>Joinpoint ，连接点接口。每个方法，都对应一个 Joinpoint 对象。 <ul><li>Invocation ，调用接口。 <ul><li>MethodInvocation ，方法调用接口。 <ul><li>ProxyMethodInvocation ，代理方法调用接口。在根目录的包里。 <ul><li>ReflectiveMethodInvocation ，反射方法调用实现类。 <ul><li>CglibMethodInvocation ，基于 CGLIB 方法调用实现类。</li></ul></li></ul></li></ul></li></ul></li></ul></li><li>Advice ，定义的横切逻辑。在如下几个时机，可以进行执行： <ul><li>Before ：在目标方便调用前执行通知。</li><li>After ：在目标方法完成后执行通知。</li><li>After Returning ： 在目标方法执行成功后，调用通知。</li><li>After Throwing ：在目标方法抛出异常后，执行通知。</li><li>Around ：在目标方法调用前后均可执行自定义逻辑。</li></ul></li></ul><blockquote><p><code>spring aop 的执行过程 需要了解！！！</code></p></blockquote><h3 id="spring-transaction" tabindex="-1">Spring Transaction <a class="header-anchor" href="#spring-transaction" aria-label="Permalink to &quot;Spring Transaction&quot;">​</a></h3><p>Spring 框架中，事务管理相关最重要的 3 个接口如下：</p><ul><li><code>PlatformTransactionManager</code>： （平台）事务管理器，Spring 事务策略的核心。</li><li><code>TransactionDefinition</code>： 事务定义信息(事务隔离级别、传播行为、超时、只读、回滚规则)。</li><li><code>TransactionStatus</code>： 事务运行状态。</li></ul><p>我们可以把 <code>PlatformTransactionManager</code> 接口可以被看作是事务上层的管理者，而 <code>TransactionDefinition</code> 和 <code>TransactionStatus</code> 这两个接口可以看作是事务的描述。</p><p><code>PlatformTransactionManager</code> 会根据 <code>TransactionDefinition</code>的定义比如事务超时时间、隔离级别、传播行为等来进行事务管理 ，而 <code>TransactionStatus</code> 接口则提供了一些方法来获取事务相应的状态比如是否新事务、是否可以回滚等等。</p><p><code>PlatformTransactionManager</code>接口中定义了三个方法：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> org.springframework.transaction;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.springframework.lang.Nullable;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">PlatformTransactionManager</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">//获得事务</span></span>
<span class="line"><span style="color:#E1E4E8;">    TransactionStatus </span><span style="color:#B392F0;">getTransaction</span><span style="color:#E1E4E8;">(@</span><span style="color:#F97583;">Nullable</span><span style="color:#E1E4E8;"> TransactionDefinition </span><span style="color:#FFAB70;">var1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> TransactionException;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">//提交事务</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">commit</span><span style="color:#E1E4E8;">(TransactionStatus </span><span style="color:#FFAB70;">var1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> TransactionException;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">//回滚事务</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">rollback</span><span style="color:#E1E4E8;">(TransactionStatus </span><span style="color:#FFAB70;">var1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> TransactionException;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> org.springframework.transaction;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.springframework.lang.Nullable;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">interface</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">PlatformTransactionManager</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//获得事务</span></span>
<span class="line"><span style="color:#24292E;">    TransactionStatus </span><span style="color:#6F42C1;">getTransaction</span><span style="color:#24292E;">(@</span><span style="color:#D73A49;">Nullable</span><span style="color:#24292E;"> TransactionDefinition </span><span style="color:#E36209;">var1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> TransactionException;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//提交事务</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">commit</span><span style="color:#24292E;">(TransactionStatus </span><span style="color:#E36209;">var1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> TransactionException;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//回滚事务</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">rollback</span><span style="color:#24292E;">(TransactionStatus </span><span style="color:#E36209;">var1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> TransactionException;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>事务管理器接口 <code>PlatformTransactionManager</code> 通过 <code>getTransaction(TransactionDefinition definition)</code> 方法来得到一个事务，这个方法里面的参数是 <code>TransactionDefinition</code> 类 ，这个类就定义了一些基本的事务属性。</p><p>事务属性包含了 5 个方面：</p><ul><li>隔离级别</li><li>传播行为</li><li>回滚规则</li><li>是否只读</li><li>事务超时</li></ul><p><code>TransactionDefinition</code> 接口中定义了 5 个方法以及一些表示事务属性的常量比如隔离级别、传播行为等等。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> org.springframework.transaction;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.springframework.lang.Nullable;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TransactionDefinition</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> PROPAGATION_REQUIRED </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> PROPAGATION_SUPPORTS </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> PROPAGATION_MANDATORY </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> PROPAGATION_REQUIRES_NEW </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> PROPAGATION_NOT_SUPPORTED </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> PROPAGATION_NEVER </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> PROPAGATION_NESTED </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> ISOLATION_DEFAULT </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> ISOLATION_READ_UNCOMMITTED </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> ISOLATION_READ_COMMITTED </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> ISOLATION_REPEATABLE_READ </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> ISOLATION_SERIALIZABLE </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> TIMEOUT_DEFAULT </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 返回事务的传播行为，默认值为 REQUIRED。</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getPropagationBehavior</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">//返回事务的隔离级别，默认值是 DEFAULT</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getIsolationLevel</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 返回事务的超时时间，默认值为-1。如果超过该时间限制但事务还没有完成，则自动回滚事务。</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getTimeout</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 返回是否为只读事务，默认值为 false</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">isReadOnly</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">Nullable</span></span>
<span class="line"><span style="color:#E1E4E8;">    String </span><span style="color:#B392F0;">getName</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> org.springframework.transaction;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.springframework.lang.Nullable;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">interface</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TransactionDefinition</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> PROPAGATION_REQUIRED </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> PROPAGATION_SUPPORTS </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> PROPAGATION_MANDATORY </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> PROPAGATION_REQUIRES_NEW </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> PROPAGATION_NOT_SUPPORTED </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> PROPAGATION_NEVER </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> PROPAGATION_NESTED </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> ISOLATION_DEFAULT </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> ISOLATION_READ_UNCOMMITTED </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> ISOLATION_READ_COMMITTED </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> ISOLATION_REPEATABLE_READ </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> ISOLATION_SERIALIZABLE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> TIMEOUT_DEFAULT </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 返回事务的传播行为，默认值为 REQUIRED。</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getPropagationBehavior</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//返回事务的隔离级别，默认值是 DEFAULT</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getIsolationLevel</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 返回事务的超时时间，默认值为-1。如果超过该时间限制但事务还没有完成，则自动回滚事务。</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getTimeout</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 返回是否为只读事务，默认值为 false</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">isReadOnly</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Nullable</span></span>
<span class="line"><span style="color:#24292E;">    String </span><span style="color:#6F42C1;">getName</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p><code>TransactionStatus</code>接口用来记录事务的状态 该接口定义了一组方法,用来获取或判断事务的相应状态信息。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TransactionStatus</span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">isNewTransaction</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 是否是新的事务</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hasSavepoint</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 是否有恢复点</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">setRollbackOnly</span><span style="color:#E1E4E8;">();  </span><span style="color:#6A737D;">// 设置为只回滚</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">isRollbackOnly</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 是否为只回滚</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> isCompleted; </span><span style="color:#6A737D;">// 是否已完成</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">interface</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TransactionStatus</span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">isNewTransaction</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 是否是新的事务</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hasSavepoint</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 是否有恢复点</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">setRollbackOnly</span><span style="color:#24292E;">();  </span><span style="color:#6A737D;">// 设置为只回滚</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">isRollbackOnly</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 是否为只回滚</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> isCompleted; </span><span style="color:#6A737D;">// 是否已完成</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="transactional" tabindex="-1">@Transactional <a class="header-anchor" href="#transactional" aria-label="Permalink to &quot;@Transactional&quot;">​</a></h4><p><code>@Transactional</code> 的工作机制是基于 AOP 实现的，AOP 又是使用动态代理实现的。如果目标对象实现了接口，默认情况下会采用 JDK 的动态代理，如果目标对象没有实现了接口,会使用 CGLIB 动态代理。</p><p>如果一个类或者一个类中的 public 方法上被标注<code>@Transactional</code> 注解的话，Spring 容器就会在启动的时候为其创建一个代理类，在调用被<code>@Transactional</code> 注解的 public 方法的时候，实际调用的是，<code>TransactionInterceptor</code> 类中的 <code>invoke()</code>方法。这个方法的作用就是在目标方法之前开启事务，方法执行过程中如果遇到异常的时候回滚事务，方法调用完成之后提交事务。</p><blockquote><p><code>TransactionInterceptor</code> 类中的 <code>invoke()</code>方法内部实际调用的是 <code>TransactionAspectSupport</code> 类的 <code>invokeWithinTransaction()</code>方法。</p></blockquote><h4 id="事务的传播行为" tabindex="-1">事务的传播行为 <a class="header-anchor" href="#事务的传播行为" aria-label="Permalink to &quot;事务的传播行为&quot;">​</a></h4><p>事务的传播行为是指，如果在开始当前事务之前，一个事务上下文已经存在，此时有若干选项可以指定一个事务性方法的执行行为。在<code>TransactionDefinition</code>定义中包括了如下几个表示传播行为的常量：</p><ul><li><code>TransactionDefinition.PROPAGATION_REQUIRED</code>：如果当前存在事务，则加入该事务；如果当前没有事务，则创建一个新的事务。这是默认值。</li><li><code>TransactionDefinition.PROPAGATION_REQUIRES_NEW</code>：创建一个新的事务，如果当前存在事务，则把当前事务挂起。</li><li><code>TransactionDefinition.PROPAGATION_SUPPORTS</code>：如果当前存在事务，则加入该事务；如果当前没有事务，则以非事务的方式继续运行。</li><li><code>TransactionDefinition.PROPAGATION_NOT_SUPPORTED</code>：以非事务方式运行，如果当前存在事务，则把当前事务挂起。</li><li><code>TransactionDefinition.PROPAGATION_NEVER</code>：以非事务方式运行，如果当前存在事务，则抛出异常。</li><li><code>TransactionDefinition.PROPAGATION_MANDATORY</code>：如果当前存在事务，则加入该事务；如果当前没有事务，则抛出异常。</li><li><code>TransactionDefinition.PROPAGATION_NESTED</code>：如果当前存在事务，则创建一个事务作为当前事务的嵌套事务来运行；如果当前没有事务，则该取值等价于<code>TransactionDefinition.PROPAGATION_REQUIRED</code>。</li></ul><blockquote><p><code>Spring 如何在当前类方法中调用本类中其他方法也保证事务正常执行？</code></p></blockquote><p>通过<code>AopContext.currentProxy ()</code>获取到本类的代理对象，再去调用（基于CGLIB实现，所以要开启AOP，在springboot启动类上加上注解<code>@EnableAspectJAutoProxy(exposeProxy = true)</code>）</p><h3 id="spring-循环依赖" tabindex="-1">Spring 循环依赖 <a class="header-anchor" href="#spring-循环依赖" aria-label="Permalink to &quot;Spring 循环依赖&quot;">​</a></h3><p>循环依赖，其实就是循环引用，就是两个或者两个以上的 bean 互相引用对方，最终形成一个闭环，如 A 依赖 B，B 依赖 C，C 依赖 A。如下图所示：</p><p><img src="/assets/image-20220512220452508.e122118e.png" alt="image-20220512220452508"></p><p>循环依赖，其实就是一个<strong>死循环</strong>的过程，在初始化 A 的时候发现引用了 B，这时就会去初始化 B，然后又发现 B 引用 C，跑去初始化 C，初始化 C 的时候发现引用了 A，则又会去初始化 A，依次循环永不退出，除非有<strong>终结条件</strong>。</p><p>Spring 循环依赖的<strong>场景</strong>有两种：</p><ol><li>构造器的循环依赖。</li><li>field 属性的循环依赖。</li></ol><p>对于构造器的循环依赖，Spring 是无法解决的，只能抛出 BeanCurrentlyInCreationException 异常表示循环依赖，<strong>所以下面我们分析的都是基于 field 属性的循环依赖</strong>。</p><p>Spring 只解决 scope 为 singleton 的循环依赖。对于scope 为 prototype 的 bean ，Spring 无法解决，直接抛出 BeanCurrentlyInCreationException 异常。</p><p>为什么 Spring 不处理 prototype bean 呢？其实如果理解 Spring 是如何解决 singleton bean 的循环依赖就明白了。这里先卖一个关子，我们先来关注 Spring 是如何解决 singleton bean 的循环依赖的。</p><h4 id="getsingleton" tabindex="-1">getSingleton <a class="header-anchor" href="#getsingleton" aria-label="Permalink to &quot;getSingleton&quot;">​</a></h4><p>我们先从加载 bean 最初始的方法 AbstractBeanFactory 的 <code>#doGetBean(final String name, final Class&lt;T&gt; requiredType, final Object[] args, boolean typeCheckOnly)</code> 方法开始。</p><p>在 <code>#doGetBean(...)</code> 方法中，首先会根据 <code>beanName</code> 从单例 bean 缓存中获取，<strong>如果不为空则直接返回</strong>。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"><span style="color:#E1E4E8;">Object sharedInstance </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getSingleton</span><span style="color:#E1E4E8;">(beanName);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"><span style="color:#24292E;">Object sharedInstance </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getSingleton</span><span style="color:#24292E;">(beanName);</span></span></code></pre></div><p>调用 <code>#getSingleton(String beanName, boolean allowEarlyReference)</code> 方法，从单例缓存中获取。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// DefaultSingletonBeanRegistry.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Nullable</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> Object </span><span style="color:#B392F0;">getSingleton</span><span style="color:#E1E4E8;">(String beanName, </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> allowEarlyReference) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 从单例缓冲中加载 bean</span></span>
<span class="line"><span style="color:#E1E4E8;">    Object singletonObject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonObjects.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 缓存中的 bean 为空，且当前 bean 正在创建</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (singletonObject </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">isSingletonCurrentlyInCreation</span><span style="color:#E1E4E8;">(beanName)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 加锁</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">synchronized</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonObjects) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 从 earlySingletonObjects 获取</span></span>
<span class="line"><span style="color:#E1E4E8;">            singletonObject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.earlySingletonObjects.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// earlySingletonObjects 中没有，且允许提前创建</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (singletonObject </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> allowEarlyReference) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 从 singletonFactories 中获取对应的 ObjectFactory</span></span>
<span class="line"><span style="color:#E1E4E8;">                ObjectFactory&lt;</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">&gt; singletonFactory </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonFactories.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (singletonFactory </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 获得 bean</span></span>
<span class="line"><span style="color:#E1E4E8;">                    singletonObject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> singletonFactory.</span><span style="color:#B392F0;">getObject</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 添加 bean 到 earlySingletonObjects 中</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.earlySingletonObjects.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(beanName, singletonObject);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 从 singletonFactories 中移除对应的 ObjectFactory</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonFactories.</span><span style="color:#B392F0;">remove</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> singletonObject;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// DefaultSingletonBeanRegistry.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Nullable</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> Object </span><span style="color:#6F42C1;">getSingleton</span><span style="color:#24292E;">(String beanName, </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> allowEarlyReference) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 从单例缓冲中加载 bean</span></span>
<span class="line"><span style="color:#24292E;">    Object singletonObject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonObjects.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 缓存中的 bean 为空，且当前 bean 正在创建</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (singletonObject </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">isSingletonCurrentlyInCreation</span><span style="color:#24292E;">(beanName)) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 加锁</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">synchronized</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonObjects) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 从 earlySingletonObjects 获取</span></span>
<span class="line"><span style="color:#24292E;">            singletonObject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.earlySingletonObjects.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// earlySingletonObjects 中没有，且允许提前创建</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (singletonObject </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> allowEarlyReference) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 从 singletonFactories 中获取对应的 ObjectFactory</span></span>
<span class="line"><span style="color:#24292E;">                ObjectFactory&lt;</span><span style="color:#D73A49;">?</span><span style="color:#24292E;">&gt; singletonFactory </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonFactories.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (singletonFactory </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 获得 bean</span></span>
<span class="line"><span style="color:#24292E;">                    singletonObject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> singletonFactory.</span><span style="color:#6F42C1;">getObject</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 添加 bean 到 earlySingletonObjects 中</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.earlySingletonObjects.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(beanName, singletonObject);</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 从 singletonFactories 中移除对应的 ObjectFactory</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonFactories.</span><span style="color:#6F42C1;">remove</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> singletonObject;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>这个方法主要是从三个缓存中获取，分别是：<code>singletonObjects</code>、<code>earlySingletonObjects</code>、<code>singletonFactories</code> 。三者定义如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// DefaultSingletonBeanRegistry.java</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Cache of singleton objects: bean name to bean instance.</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 一级缓存，存放的是单例 bean 的映射。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 注意，这里的 bean 是已经创建完成的。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 对应关系为 bean name --&gt; bean instance</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Map&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">&gt; singletonObjects </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> ConcurrentHashMap&lt;&gt;(</span><span style="color:#79B8FF;">256</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Cache of early singleton objects: bean name to bean instance.</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 二级缓存，存放的是早期半成品（未初始化完）的 bean，对应关系也是 bean name --&gt; bean instance。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 它与 {@link #singletonObjects} 区别在于， 它自己存放的 bean 不一定是完整。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 这个 Map 也是【循环依赖】的关键所在。</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Map&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">&gt; earlySingletonObjects </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> HashMap&lt;&gt;(</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Cache of singleton factories: bean name to ObjectFactory.</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 三级缓存，存放的是 ObjectFactory，可以理解为创建早期半成品（未初始化完）的 bean 的 factory ，最终添加到二级缓存 {@link #earlySingletonObjects} 中</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 对应关系是 bean name --&gt; ObjectFactory</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 这个 Map 也是【循环依赖】的关键所在。</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Map&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, ObjectFactory&lt;</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">&gt;&gt; singletonFactories </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> HashMap&lt;&gt;(</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// DefaultSingletonBeanRegistry.java</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Cache of singleton objects: bean name to bean instance.</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 一级缓存，存放的是单例 bean 的映射。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 注意，这里的 bean 是已经创建完成的。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 对应关系为 bean name --&gt; bean instance</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; singletonObjects </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> ConcurrentHashMap&lt;&gt;(</span><span style="color:#005CC5;">256</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Cache of early singleton objects: bean name to bean instance.</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 二级缓存，存放的是早期半成品（未初始化完）的 bean，对应关系也是 bean name --&gt; bean instance。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 它与 {@link #singletonObjects} 区别在于， 它自己存放的 bean 不一定是完整。</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 这个 Map 也是【循环依赖】的关键所在。</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; earlySingletonObjects </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> HashMap&lt;&gt;(</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Cache of singleton factories: bean name to ObjectFactory.</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 三级缓存，存放的是 ObjectFactory，可以理解为创建早期半成品（未初始化完）的 bean 的 factory ，最终添加到二级缓存 {@link #earlySingletonObjects} 中</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 对应关系是 bean name --&gt; ObjectFactory</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 这个 Map 也是【循环依赖】的关键所在。</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, ObjectFactory&lt;</span><span style="color:#D73A49;">?</span><span style="color:#24292E;">&gt;&gt; singletonFactories </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> HashMap&lt;&gt;(</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">);</span></span></code></pre></div><ul><li><code>singletonObjects</code> ：单例对象的 Cache 。</li><li><code>earlySingletonObjects</code> ：<strong>提前曝光</strong>的单例对象的 Cache 。</li><li><code>singletonFactories</code> ： 单例对象工厂的 Cache 。</li></ul><p>它们三，就是 Spring 解决 singleton bean 的关键因素所在，我称他们为<strong>三级缓存</strong>：</p><ul><li>第一级为 <code>singletonObjects</code></li><li>第二级为 <code>earlySingletonObjects</code></li><li>第三级为 <code>singletonFactories</code></li></ul><p>这里，我们已经通过 <code>#getSingleton(String beanName, boolean allowEarlyReference)</code> 方法，看到他们是如何配合的。详细分析该方法之前，提下其中的 <code>#isSingletonCurrentlyInCreation(String beanName)</code> 方法和 <code>allowEarlyReference</code> 变量：</p><ul><li><code>#isSingletonCurrentlyInCreation(String beanName)</code> 方法：判断当前 singleton bean 是否处于创建中。bean 处于创建中，也就是说 bean 在初始化但是没有完成初始化，有一个这样的过程其实和 Spring 解决 bean 循环依赖的理念相辅相成。<strong>因为 Spring 解决 singleton bean 的核心就在于提前曝光 bean</strong> 。</li><li><code>allowEarlyReference</code> 变量：从字面意思上面理解就是允许提前拿到引用。其实真正的意思是，是否允许从 <code>singletonFactories</code> 缓存中通过 <code>#getObject()</code> 方法，拿到对象。为什么会有这样一个字段呢？<strong>原因就在于 <code>singletonFactories</code> 才是 Spring 解决 singleton bean 的诀窍所在</strong>，这个我们后续分析。</li></ul><p><code>#getSingleton(String beanName, boolean allowEarlyReference)</code> 方法，整个过程如下：</p><ul><li><p>首先，从一级缓存 <code>singletonObjects</code> 获取。</p></li><li><p>如果，没有且当前指定的 <code>beanName</code> 正在创建，就再从二级缓存 <code>earlySingletonObjects</code> 中获取。</p></li><li><p>如果，还是没有获取到且允许 <code>singletonFactories</code> 通过 <code>#getObject()</code> 获取，则从三级缓存 <code>singletonFactories</code> 获取。如果获取到，则通过其 <code>#getObject()</code> 方法，获取对象，并将其加入到二级缓存 <code>earlySingletonObjects</code> 中，并从三级缓存 <code>singletonFactories</code> 删除。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// DefaultSingletonBeanRegistry.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">singletonObject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> singletonFactory.</span><span style="color:#B392F0;">getObject</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.earlySingletonObjects.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(beanName, singletonObject);</span></span>
<span class="line"><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonFactories.</span><span style="color:#B392F0;">remove</span><span style="color:#E1E4E8;">(beanName);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// DefaultSingletonBeanRegistry.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">singletonObject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> singletonFactory.</span><span style="color:#6F42C1;">getObject</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#005CC5;">this</span><span style="color:#24292E;">.earlySingletonObjects.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(beanName, singletonObject);</span></span>
<span class="line"><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonFactories.</span><span style="color:#6F42C1;">remove</span><span style="color:#24292E;">(beanName);</span></span></code></pre></div><ul><li><ul><li>这样，就从三级缓存<strong>升级</strong>到二级缓存了。</li><li>😈 所以，二级缓存存在的<strong>意义</strong>，就是缓存三级缓存中的 ObjectFactory 的 <code>#getObject()</code> 方法的执行结果，提早曝光的<strong>单例</strong> Bean 对象。</li></ul></li></ul></li></ul><h4 id="addsingletonfactory-1" tabindex="-1">addSingletonFactory <a class="header-anchor" href="#addsingletonfactory-1" aria-label="Permalink to &quot;addSingletonFactory&quot;">​</a></h4><p>上面是从缓存中获取，但是缓存中的数据从哪里添加进来的呢？一直往下跟会发现在 AbstractAutowireCapableBeanFactory 的 <code>#doCreateBean(final String beanName, final RootBeanDefinition mbd, final Object[] args)</code> 方法中，有这么一段代码：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> earlySingletonExposure </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (mbd.</span><span style="color:#B392F0;">isSingleton</span><span style="color:#E1E4E8;">() </span><span style="color:#6A737D;">// 单例模式</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.allowCircularReferences </span><span style="color:#6A737D;">// 运行循环依赖</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">isSingletonCurrentlyInCreation</span><span style="color:#E1E4E8;">(beanName)); </span><span style="color:#6A737D;">// 当前单例 bean 是否正在被创建</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (earlySingletonExposure) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (logger.</span><span style="color:#B392F0;">isTraceEnabled</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        logger.</span><span style="color:#B392F0;">trace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Eagerly caching bean &#39;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> beanName </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;&#39; to allow for resolving potential circular references&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 提前将创建的 bean 实例加入到 singletonFactories 中</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;X&gt; 这里是为了后期避免循环依赖</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">addSingletonFactory</span><span style="color:#E1E4E8;">(beanName, () </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getEarlyBeanReference</span><span style="color:#E1E4E8;">(beanName, mbd, bean));</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> earlySingletonExposure </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (mbd.</span><span style="color:#6F42C1;">isSingleton</span><span style="color:#24292E;">() </span><span style="color:#6A737D;">// 单例模式</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.allowCircularReferences </span><span style="color:#6A737D;">// 运行循环依赖</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">isSingletonCurrentlyInCreation</span><span style="color:#24292E;">(beanName)); </span><span style="color:#6A737D;">// 当前单例 bean 是否正在被创建</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (earlySingletonExposure) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (logger.</span><span style="color:#6F42C1;">isTraceEnabled</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">        logger.</span><span style="color:#6F42C1;">trace</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Eagerly caching bean &#39;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> beanName </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;&#39; to allow for resolving potential circular references&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 提前将创建的 bean 实例加入到 singletonFactories 中</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;X&gt; 这里是为了后期避免循环依赖</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">addSingletonFactory</span><span style="color:#24292E;">(beanName, () </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getEarlyBeanReference</span><span style="color:#24292E;">(beanName, mbd, bean));</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li><p>当一个 Bean 满足三个条件时，则调用<code>#addSingletonFactory(...)</code>方法，将它添加到缓存中。三个条件如下：</p><ul><li>单例</li><li>运行提前暴露 bean</li><li>当前 bean 正在创建中</li></ul></li><li><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// DefaultSingletonBeanRegistry.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">addSingletonFactory</span><span style="color:#E1E4E8;">(String beanName, ObjectFactory</span><span style="color:#F97583;">&lt;?&gt;</span><span style="color:#E1E4E8;"> singletonFactory) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	Assert.</span><span style="color:#B392F0;">notNull</span><span style="color:#E1E4E8;">(singletonFactory, </span><span style="color:#9ECBFF;">&quot;Singleton factory must not be null&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">synchronized</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonObjects) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonObjects.</span><span style="color:#B392F0;">containsKey</span><span style="color:#E1E4E8;">(beanName)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonFactories.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(beanName, singletonFactory);</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.earlySingletonObjects.</span><span style="color:#B392F0;">remove</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.registeredSingletons.</span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">		}</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// DefaultSingletonBeanRegistry.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">addSingletonFactory</span><span style="color:#24292E;">(String beanName, ObjectFactory</span><span style="color:#D73A49;">&lt;?&gt;</span><span style="color:#24292E;"> singletonFactory) {</span></span>
<span class="line"><span style="color:#24292E;">	Assert.</span><span style="color:#6F42C1;">notNull</span><span style="color:#24292E;">(singletonFactory, </span><span style="color:#032F62;">&quot;Singleton factory must not be null&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">synchronized</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonObjects) {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonObjects.</span><span style="color:#6F42C1;">containsKey</span><span style="color:#24292E;">(beanName)) {</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonFactories.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(beanName, singletonFactory);</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.earlySingletonObjects.</span><span style="color:#6F42C1;">remove</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.registeredSingletons.</span><span style="color:#6F42C1;">add</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">		}</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div></li><li><p>从这段代码我们可以看出，<code>singletonFactories</code> 这个三级缓存才是解决 Spring Bean 循环依赖的诀窍所在。同时这段代码发生在 <code>#createBeanInstance(...)</code> 方法之后，也就是说这个 bean 其实已经被创建出来了，<strong>但是它还不是很完美（没有进行属性填充和初始化），但是对于其他依赖它的对象而言已经足够了（可以根据对象引用定位到堆中对象），能够被认出来了</strong>。所以 Spring 在这个时候，选择将该对象提前曝光出来让大家认识认识。</p></li></ul><p>另外，<code>&lt;X&gt;</code> 处的 <code>#getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean)</code> 方法也<strong>非常重要</strong>，这里会创建早期初始化 Bean 可能存在的 AOP 代理等等。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 对创建的早期半成品（未初始化）的 Bean 处理引用</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 例如说，AOP 就是在这里动态织入，创建其代理 Bean 返回</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * Obtain a reference for early access to the specified bean,</span></span>
<span class="line"><span style="color:#6A737D;"> * typically for the purpose of resolving a circular reference.</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@param</span><span style="color:#6A737D;"> </span><span style="color:#FFAB70;">beanName</span><span style="color:#6A737D;"> the name of the bean (for error handling purposes)</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@param</span><span style="color:#6A737D;"> </span><span style="color:#FFAB70;">mbd</span><span style="color:#6A737D;"> the merged bean definition for the bean</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@param</span><span style="color:#6A737D;"> </span><span style="color:#FFAB70;">bean</span><span style="color:#6A737D;"> the raw bean instance</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@return</span><span style="color:#6A737D;"> the object to expose as bean reference</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> Object </span><span style="color:#B392F0;">getEarlyBeanReference</span><span style="color:#E1E4E8;">(String beanName, RootBeanDefinition mbd, Object bean) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	Object exposedObject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> bean;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">mbd.</span><span style="color:#B392F0;">isSynthetic</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hasInstantiationAwareBeanPostProcessors</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (BeanPostProcessor bp </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getBeanPostProcessors</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (bp </span><span style="color:#F97583;">instanceof</span><span style="color:#E1E4E8;"> SmartInstantiationAwareBeanPostProcessor) {</span></span>
<span class="line"><span style="color:#E1E4E8;">				SmartInstantiationAwareBeanPostProcessor ibp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (SmartInstantiationAwareBeanPostProcessor) bp;</span></span>
<span class="line"><span style="color:#E1E4E8;">				exposedObject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ibp.</span><span style="color:#B392F0;">getEarlyBeanReference</span><span style="color:#E1E4E8;">(exposedObject, beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">			}</span></span>
<span class="line"><span style="color:#E1E4E8;">		}</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> exposedObject;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 对创建的早期半成品（未初始化）的 Bean 处理引用</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * 例如说，AOP 就是在这里动态织入，创建其代理 Bean 返回</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * Obtain a reference for early access to the specified bean,</span></span>
<span class="line"><span style="color:#6A737D;"> * typically for the purpose of resolving a circular reference.</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@param</span><span style="color:#6A737D;"> </span><span style="color:#E36209;">beanName</span><span style="color:#6A737D;"> the name of the bean (for error handling purposes)</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@param</span><span style="color:#6A737D;"> </span><span style="color:#E36209;">mbd</span><span style="color:#6A737D;"> the merged bean definition for the bean</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@param</span><span style="color:#6A737D;"> </span><span style="color:#E36209;">bean</span><span style="color:#6A737D;"> the raw bean instance</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@return</span><span style="color:#6A737D;"> the object to expose as bean reference</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> Object </span><span style="color:#6F42C1;">getEarlyBeanReference</span><span style="color:#24292E;">(String beanName, RootBeanDefinition mbd, Object bean) {</span></span>
<span class="line"><span style="color:#24292E;">	Object exposedObject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> bean;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">mbd.</span><span style="color:#6F42C1;">isSynthetic</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hasInstantiationAwareBeanPostProcessors</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (BeanPostProcessor bp </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getBeanPostProcessors</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (bp </span><span style="color:#D73A49;">instanceof</span><span style="color:#24292E;"> SmartInstantiationAwareBeanPostProcessor) {</span></span>
<span class="line"><span style="color:#24292E;">				SmartInstantiationAwareBeanPostProcessor ibp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (SmartInstantiationAwareBeanPostProcessor) bp;</span></span>
<span class="line"><span style="color:#24292E;">				exposedObject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ibp.</span><span style="color:#6F42C1;">getEarlyBeanReference</span><span style="color:#24292E;">(exposedObject, beanName);</span></span>
<span class="line"><span style="color:#24292E;">			}</span></span>
<span class="line"><span style="color:#24292E;">		}</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> exposedObject;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li>这也是为什么 Spring 需要额外增加 <code>singletonFactories</code> 三级缓存的原因，解决 Spring 循环依赖情况下的 Bean 存在动态代理等情况，不然循环注入到别人的 Bean 就是原始的，而不是经过动态代理的！</li><li>另外，这里在推荐一篇<a href="https://segmentfault.com/a/1190000023647227" target="_blank" rel="noreferrer">《Spring循环依赖三级缓存是否可以减少为二级缓存？》</a>文章，解释的也非常不错。</li></ul><h4 id="addsingleton" tabindex="-1">addSingleton <a class="header-anchor" href="#addsingleton" aria-label="Permalink to &quot;addSingleton&quot;">​</a></h4><p>三级缓存 <code>singletonFactories</code> 和 二级缓存 <code>earlySingletonObjects</code> 中的值都有出处了，那一级缓存在哪里设置的呢？在类 DefaultSingletonBeanRegistry 中，可以发现这个 <code>#addSingleton(String beanName, Object singletonObject)</code> 方法，代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// DefaultSingletonBeanRegistry.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">addSingleton</span><span style="color:#E1E4E8;">(String beanName, Object singletonObject) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">synchronized</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonObjects) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonObjects.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(beanName, singletonObject);</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonFactories.</span><span style="color:#B392F0;">remove</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.earlySingletonObjects.</span><span style="color:#B392F0;">remove</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.registeredSingletons.</span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// DefaultSingletonBeanRegistry.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">addSingleton</span><span style="color:#24292E;">(String beanName, Object singletonObject) {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">synchronized</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonObjects) {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonObjects.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(beanName, singletonObject);</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonFactories.</span><span style="color:#6F42C1;">remove</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.earlySingletonObjects.</span><span style="color:#6F42C1;">remove</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.registeredSingletons.</span><span style="color:#6F42C1;">add</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li>添加至一级缓存，同时从二级、三级缓存中删除。</li><li>这个方法在我们创建 bean 的链路中有哪个地方引用呢？其实在前面博客 LZ 已经提到过了，在 <code>#doGetBean(...)</code> 方法中，处理不同 scope 时，如果是 singleton，则调用 <code>#getSingleton(...)</code> 方法，如下图所示：</li></ul><p><img src="/assets/image-20220512221632266.d1689295.png" alt="image-20220512221632266"></p><p>我们关注 <code>#getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</code> 方法，代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Object </span><span style="color:#B392F0;">getSingleton</span><span style="color:#E1E4E8;">(String beanName, ObjectFactory</span><span style="color:#F97583;">&lt;?&gt;</span><span style="color:#E1E4E8;"> singletonFactory) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    Assert.</span><span style="color:#B392F0;">notNull</span><span style="color:#E1E4E8;">(beanName, </span><span style="color:#9ECBFF;">&quot;Bean name must not be null&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">synchronized</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonObjects) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        Object singletonObject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonObjects.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (singletonObject </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">//....</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                singletonObject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> singletonFactory.</span><span style="color:#B392F0;">getObject</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                newSingleton </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">//.....</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (newSingleton) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#B392F0;">addSingleton</span><span style="color:#E1E4E8;">(beanName, singletonObject);</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> singletonObject;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Object </span><span style="color:#6F42C1;">getSingleton</span><span style="color:#24292E;">(String beanName, ObjectFactory</span><span style="color:#D73A49;">&lt;?&gt;</span><span style="color:#24292E;"> singletonFactory) {</span></span>
<span class="line"><span style="color:#24292E;">    Assert.</span><span style="color:#6F42C1;">notNull</span><span style="color:#24292E;">(beanName, </span><span style="color:#032F62;">&quot;Bean name must not be null&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">synchronized</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonObjects) {</span></span>
<span class="line"><span style="color:#24292E;">        Object singletonObject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonObjects.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (singletonObject </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">//....</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                singletonObject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> singletonFactory.</span><span style="color:#6F42C1;">getObject</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                newSingleton </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">//.....</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (newSingleton) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">addSingleton</span><span style="color:#24292E;">(beanName, singletonObject);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> singletonObject;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li>😈 注意，此处的 <code>#getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</code> 方法，在 AbstractBeanFactory 类中实现，和 <a href="http://svip.iocoder.cn/Spring/IoC-get-Bean-createBean-5/#" target="_blank" rel="noreferrer">「2.1 getSingleton」</a> <strong>不同</strong>。</li></ul><p><strong>我们基本上可以确定 Spring 解决循环依赖的方案了</strong>：</p><ul><li>Spring 在创建 bean 的时候并不是等它完全完成，而是在创建过程中将创建中的 bean 的 ObjectFactory 提前曝光（即加入到 <code>singletonFactories</code> 缓存中）。</li><li>这样，一旦下一个 bean 创建的时候需要依赖 bean ，则直接使用 ObjectFactory 的 <code>#getObject()</code> 方法来获取了，也就是 <a href="http://svip.iocoder.cn/Spring/IoC-get-Bean-createBean-5/#" target="_blank" rel="noreferrer">「2.1 getSingleton」</a> 小结中的方法中的代码片段了。</li></ul><p>到这里，关于 Spring 解决 bean 循环依赖就已经分析完毕了。最后来描述下就上面那个循环依赖 Spring 解决的过程：</p><ul><li>首先 A 完成初始化第一步并将自己提前曝光出来（通过 ObjectFactory 将自己提前曝光），在初始化的时候，发现自己依赖对象 B，此时就会去尝试 get(B)，这个时候发现 B 还没有被创建出来</li><li>然后 B 就走创建流程，在 B 初始化的时候，同样发现自己依赖 C，C 也没有被创建出来</li><li>这个时候 C 又开始初始化进程，但是在初始化的过程中发现自己依赖 A，于是尝试 get(A)，这个时候由于 A 已经添加至缓存中（一般都是添加至三级缓存 <code>singletonFactories</code> ），通过 ObjectFactory 提前曝光，所以可以通过 <code>ObjectFactory#getObject()</code> 方法来拿到 A 对象，C 拿到 A 对象后顺利完成初始化，然后将自己添加到一级缓存中</li><li>回到 B ，B 也可以拿到 C 对象，完成初始化，A 可以顺利拿到 B 完成初始化。到这里整个链路就已经完成了初始化过程了</li></ul><blockquote><p><img src="/assets/image-20220512222000668.1bfddc1f.png" alt="image-20220512222000668"></p></blockquote><p><img src="/assets/image-20220402172526040.274fb4f6.png" alt="	"></p><h3 id="spring-mvc" tabindex="-1">Spring MVC <a class="header-anchor" href="#spring-mvc" aria-label="Permalink to &quot;Spring MVC&quot;">​</a></h3><p><img src="/assets/image-20230131153633725.0206d47e.png" alt="image-20230131153633725"></p><blockquote><p>DispatcherServlet（入口）-&gt;DispatcherServlet.properties（会初始化的对象）-&gt;HandlerMapping（映射器）-&gt;HandlerExecutionChain(映射器+拦截器List) -&gt;HttpRequestHandlerAdapter(适配器)-&gt;HttpMessageConverter(数据转换)</p></blockquote><p><img src="/assets/image-20230131173747867.d43e9287.png" alt="image-20230131173747867"></p><p>（1）用户发送请求至前端控制器DispatcherServlet；</p><p>（2） DispatcherServlet收到请求后，调用HandlerMapping处理器映射器，请求获取Handler；</p><p>（3）处理器映射器根据请求url找到具体的处理器，生成处理器对象及处理器拦截器(如果有则生成)一并返回给DispatcherServlet；</p><p>（4）DispatcherServlet 调用 HandlerAdapter处理器适配器；</p><p>（5）HandlerAdapter 经过适配调用 具体处理器(Handler，也叫后端控制器)；</p><p>（6）Handler执行完成返回ModelAndView；</p><p>（7）HandlerAdapter将Handler执行结果ModelAndView返回给DispatcherServlet；</p><p>（8）DispatcherServlet将ModelAndView传给ViewResolver视图解析器进行解析；</p><p>（9）ViewResolver解析后返回具体View；</p><p>（10）DispatcherServlet对View进行渲染视图（即将模型数据填充至视图中）</p><p>（11）DispatcherServlet响应用户。</p><h3 id="spring-设计模式" tabindex="-1">Spring 设计模式 <a class="header-anchor" href="#spring-设计模式" aria-label="Permalink to &quot;Spring 设计模式&quot;">​</a></h3><h4 id="工厂模式" tabindex="-1">工厂模式 <a class="header-anchor" href="#工厂模式" aria-label="Permalink to &quot;工厂模式&quot;">​</a></h4><p>Spring 使用工厂模式可以通过 <code>BeanFactory</code> 或 <code>ApplicationContext</code> 创建 bean 对象。</p><p><strong>两者对比：</strong></p><ul><li><code>BeanFactory</code> ：延迟注入(使用到某个 bean 的时候才会注入),相比于<code>ApplicationContext</code> 来说会占用更少的内存，程序启动速度更快。</li><li><code>ApplicationContext</code> ：容器启动的时候，不管你用没用到，一次性创建所有 bean 。<code>BeanFactory</code> 仅提供了最基本的依赖注入支持，<code>ApplicationContext</code> 扩展了 <code>BeanFactory</code> ,除了有<code>BeanFactory</code>的功能还有额外更多功能，所以一般开发人员使用<code>ApplicationContext</code>会更多。</li></ul><p><code>ApplicationContext</code> 的三个实现类：</p><ol><li><code>ClassPathXmlApplication</code>：把上下文文件当成类路径资源。</li><li><code>FileSystemXmlApplication</code>：从文件系统中的 XML 文件载入上下文定义信息。</li><li><code>XmlWebApplicationContext</code>：从 Web 系统中的 XML 文件载入上下文定义信息。</li></ol><h4 id="单例模式" tabindex="-1">单例模式 <a class="header-anchor" href="#单例模式" aria-label="Permalink to &quot;单例模式&quot;">​</a></h4><p><strong>Spring 中 bean 的默认作用域就是 singleton(单例)的。</strong></p><p>Spring 通过 <code>ConcurrentHashMap</code> 实现单例注册表的特殊方式实现单例模式。</p><p>Spring 实现单例的核心代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 通过 ConcurrentHashMap（线程安全） 实现单例注册表</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Map&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">&gt; singletonObjects </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> ConcurrentHashMap&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">&gt;(</span><span style="color:#79B8FF;">64</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Object </span><span style="color:#B392F0;">getSingleton</span><span style="color:#E1E4E8;">(String beanName, ObjectFactory</span><span style="color:#F97583;">&lt;?&gt;</span><span style="color:#E1E4E8;"> singletonFactory) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    Assert.</span><span style="color:#B392F0;">notNull</span><span style="color:#E1E4E8;">(beanName, </span><span style="color:#9ECBFF;">&quot;&#39;beanName&#39; must not be null&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">synchronized</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonObjects) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 检查缓存中是否存在实例</span></span>
<span class="line"><span style="color:#E1E4E8;">        Object singletonObject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonObjects.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(beanName);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (singletonObject </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">//...省略了很多代码</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                singletonObject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> singletonFactory.</span><span style="color:#B392F0;">getObject</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">//...省略了很多代码</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 如果实例对象在不存在，我们注册到单例注册表中。</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">addSingleton</span><span style="color:#E1E4E8;">(beanName, singletonObject);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> (singletonObject </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> NULL_OBJECT </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> singletonObject </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#6A737D;">//将对象添加到单例注册表</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">addSingleton</span><span style="color:#E1E4E8;">(String beanName, Object singletonObject) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">synchronized</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonObjects) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.singletonObjects.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(beanName, (singletonObject </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> singletonObject </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> NULL_OBJECT));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 通过 ConcurrentHashMap（线程安全） 实现单例注册表</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; singletonObjects </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> ConcurrentHashMap&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt;(</span><span style="color:#005CC5;">64</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Object </span><span style="color:#6F42C1;">getSingleton</span><span style="color:#24292E;">(String beanName, ObjectFactory</span><span style="color:#D73A49;">&lt;?&gt;</span><span style="color:#24292E;"> singletonFactory) {</span></span>
<span class="line"><span style="color:#24292E;">    Assert.</span><span style="color:#6F42C1;">notNull</span><span style="color:#24292E;">(beanName, </span><span style="color:#032F62;">&quot;&#39;beanName&#39; must not be null&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">synchronized</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonObjects) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 检查缓存中是否存在实例</span></span>
<span class="line"><span style="color:#24292E;">        Object singletonObject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonObjects.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(beanName);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (singletonObject </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">//...省略了很多代码</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                singletonObject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> singletonFactory.</span><span style="color:#6F42C1;">getObject</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">//...省略了很多代码</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 如果实例对象在不存在，我们注册到单例注册表中。</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">addSingleton</span><span style="color:#24292E;">(beanName, singletonObject);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> (singletonObject </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> NULL_OBJECT </span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> singletonObject </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#6A737D;">//将对象添加到单例注册表</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">addSingleton</span><span style="color:#24292E;">(String beanName, Object singletonObject) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">synchronized</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonObjects) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.singletonObjects.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(beanName, (singletonObject </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> singletonObject </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> NULL_OBJECT));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p><strong>单例 Bean 存在线程安全问题吗？</strong></p><p>大部分时候我们并没有在项目中使用多线程，所以很少有人会关注这个问题。单例 Bean 存在线程问题，主要是因为当多个线程操作同一个对象的时候是存在资源竞争的。</p><p>常见的有两种解决办法：</p><ol><li>在 Bean 中尽量避免定义可变的成员变量。</li><li>在类中定义一个 <code>ThreadLocal</code> 成员变量，将需要的可变成员变量保存在 <code>ThreadLocal</code> 中（推荐的一种方式）。</li></ol><p>不过，大部分 Bean 实际都是无状态（没有实例变量）的（比如 Dao、Service），这种情况下， Bean 是线程安全的。</p><h4 id="代理模式" tabindex="-1">代理模式 <a class="header-anchor" href="#代理模式" aria-label="Permalink to &quot;代理模式&quot;">​</a></h4><p><strong>Spring AOP 就是基于动态代理的</strong>，如果要代理的对象，实现了某个接口，那么 Spring AOP 会使用 <strong>JDK Proxy</strong> 去创建代理对象，而对于没有实现接口的对象，就无法使用 JDK Proxy 去进行代理了，这时候 Spring AOP 会使用 <strong>Cglib</strong> 生成一个被代理对象的子类来作为代理，如下图所示：</p><p><img src="/assets/image-20230112170317124.5f2fd8da.png" alt="image-20230112170317124"></p><p><strong>Spring AOP 和 AspectJ AOP 有什么区别?</strong></p><p><strong>Spring AOP 属于运行时增强，而 AspectJ 是编译时增强。</strong> Spring AOP 基于代理(Proxying)，而 AspectJ 基于字节码操作(Bytecode Manipulation)。</p><p>Spring AOP 已经集成了 AspectJ ，AspectJ 应该算的上是 Java 生态系统中最完整的 AOP 框架了。AspectJ 相比于 Spring AOP 功能更加强大，但是 Spring AOP 相对来说更简单，</p><p>如果我们的切面比较少，那么两者性能差异不大。但是，当切面太多的话，最好选择 AspectJ ，它比 Spring AOP 快很多。</p><h4 id="模板方法" tabindex="-1">模板方法 <a class="header-anchor" href="#模板方法" aria-label="Permalink to &quot;模板方法&quot;">​</a></h4><p>模板方法模式是一种行为设计模式，它定义一个操作中的算法的骨架，而将一些步骤延迟到子类中。 模板方法使得子类可以不改变一个算法的结构即可重定义该算法的某些特定步骤的实现方式。</p><p>Spring 中 <code>JdbcTemplate</code>、<code>HibernateTemplate</code> 等以 Template 结尾的对数据库操作的类，它们就使用到了模板模式。一般情况下，我们都是使用继承的方式来实现模板模式，但是 Spring 并没有使用这种方式，而是使用 Callback 模式与模板方法模式配合，既达到了代码复用的效果，同时增加了灵活性。</p><h4 id="观察者模式" tabindex="-1">观察者模式 <a class="header-anchor" href="#观察者模式" aria-label="Permalink to &quot;观察者模式&quot;">​</a></h4><p>Spring 事件驱动模型中包含三种角色: 事件角色 事件监听者角色 事件发布者角色</p><h5 id="事件角色" tabindex="-1">事件角色 <a class="header-anchor" href="#事件角色" aria-label="Permalink to &quot;事件角色&quot;">​</a></h5><p><code>ApplicationEvent</code> (<code>org.springframework.context</code>包下)充当事件的角色,这是一个抽象类，它继承了<code>java.util.EventObject</code>并实现了 <code>java.io.Serializable</code>接口。</p><p>Spring 中默认存在以下事件，他们都是对 <code>ApplicationContextEvent</code> 的实现(继承自<code>ApplicationContextEvent</code>)：</p><ul><li><code>ContextStartedEvent</code>：<code>ApplicationContext</code> 启动后触发的事件;</li><li><code>ContextStoppedEvent</code>：<code>ApplicationContext</code> 停止后触发的事件;</li><li><code>ContextRefreshedEvent</code>：<code>ApplicationContext</code> 初始化或刷新完成后触发的事件;</li><li><code>ContextClosedEvent</code>：<code>ApplicationContext</code> 关闭后触发的事件。</li></ul><p><img src="/assets/image-20230112170633641.fb32c4bb.png" alt="image-20230112170633641"></p><h5 id="事件监听者角色" tabindex="-1">事件监听者角色 <a class="header-anchor" href="#事件监听者角色" aria-label="Permalink to &quot;事件监听者角色&quot;">​</a></h5><p><code>ApplicationListener</code> 充当了事件监听者角色，它是一个接口，里面只定义了一个 <code>onApplicationEvent（）</code>方法来处理<code>ApplicationEvent</code>。<code>ApplicationListener</code>接口类源码如下，可以看出接口定义看出接口中的事件只要实现了 <code>ApplicationEvent</code>就可以了。所以，在 Spring 中我们只要实现 <code>ApplicationListener</code> 接口的 <code>onApplicationEvent()</code> 方法即可完成监听事件</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> org.springframework.context;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> java.util.EventListener;</span></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">FunctionalInterface</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ApplicationListener</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">E</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ApplicationEvent</span><span style="color:#E1E4E8;">&gt; </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">EventListener</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">onApplicationEvent</span><span style="color:#E1E4E8;">(E </span><span style="color:#FFAB70;">var1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> org.springframework.context;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> java.util.EventListener;</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">FunctionalInterface</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">interface</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ApplicationListener</span><span style="color:#24292E;">&lt;</span><span style="color:#D73A49;">E</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ApplicationEvent</span><span style="color:#24292E;">&gt; </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">EventListener</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">onApplicationEvent</span><span style="color:#24292E;">(E </span><span style="color:#E36209;">var1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h5 id="事件发布者角色" tabindex="-1">事件发布者角色 <a class="header-anchor" href="#事件发布者角色" aria-label="Permalink to &quot;事件发布者角色&quot;">​</a></h5><p><code>ApplicationEventPublisher</code> 充当了事件的发布者，它也是一个接口。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">FunctionalInterface</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ApplicationEventPublisher</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">default</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">publishEvent</span><span style="color:#E1E4E8;">(ApplicationEvent </span><span style="color:#FFAB70;">event</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">publishEvent</span><span style="color:#E1E4E8;">((Object)event);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">publishEvent</span><span style="color:#E1E4E8;">(Object </span><span style="color:#FFAB70;">var1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">FunctionalInterface</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">interface</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ApplicationEventPublisher</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">default</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">publishEvent</span><span style="color:#24292E;">(ApplicationEvent </span><span style="color:#E36209;">event</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">publishEvent</span><span style="color:#24292E;">((Object)event);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">publishEvent</span><span style="color:#24292E;">(Object </span><span style="color:#E36209;">var1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p><code>ApplicationEventPublisher</code> 接口的<code>publishEvent（）</code>这个方法在<code>AbstractApplicationContext</code>类中被实现，阅读这个方法的实现，你会发现实际上事件真正是通过<code>ApplicationEventMulticaster</code>来广播出去的。</p><h5 id="spring-的事件流程总结" tabindex="-1">Spring 的事件流程总结 <a class="header-anchor" href="#spring-的事件流程总结" aria-label="Permalink to &quot;Spring 的事件流程总结&quot;">​</a></h5><ol><li>定义一个事件: 实现一个继承自 <code>ApplicationEvent</code>，并且写相应的构造函数；</li><li>定义一个事件监听者：实现 <code>ApplicationListener</code> 接口，重写 <code>onApplicationEvent()</code> 方法；</li><li>使用事件发布者发布消息: 可以通过 <code>ApplicationEventPublisher</code> 的 <code>publishEvent()</code> 方法发布消息。</li></ol><p>Example:</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 定义一个事件,继承自ApplicationEvent并且写相应的构造函数</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">DemoEvent</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ApplicationEvent</span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> serialVersionUID </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1L</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> String message;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">DemoEvent</span><span style="color:#E1E4E8;">(Object </span><span style="color:#FFAB70;">source</span><span style="color:#E1E4E8;">,String </span><span style="color:#FFAB70;">message</span><span style="color:#E1E4E8;">){</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">super</span><span style="color:#E1E4E8;">(source);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.message </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> message;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> String </span><span style="color:#B392F0;">getMessage</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> message;</span></span>
<span class="line"><span style="color:#E1E4E8;">          }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 定义一个事件监听者,实现ApplicationListener接口，重写 onApplicationEvent() 方法；</span></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Component</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">DemoListener</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">implements</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ApplicationListener</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">DemoEvent</span><span style="color:#E1E4E8;">&gt;{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">//使用onApplicationEvent接收消息</span></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">onApplicationEvent</span><span style="color:#E1E4E8;">(DemoEvent </span><span style="color:#FFAB70;">event</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        String msg </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> event.</span><span style="color:#B392F0;">getMessage</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;接收到的信息是：&quot;</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">msg);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#6A737D;">// 发布事件，可以通过ApplicationEventPublisher  的 publishEvent() 方法发布消息。</span></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Component</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">DemoPublisher</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">Autowired</span></span>
<span class="line"><span style="color:#E1E4E8;">    ApplicationContext applicationContext;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">publish</span><span style="color:#E1E4E8;">(String </span><span style="color:#FFAB70;">message</span><span style="color:#E1E4E8;">){</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">//发布事件</span></span>
<span class="line"><span style="color:#E1E4E8;">        applicationContext.</span><span style="color:#B392F0;">publishEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">DemoEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, message));</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 定义一个事件,继承自ApplicationEvent并且写相应的构造函数</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DemoEvent</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ApplicationEvent</span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> serialVersionUID </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1L</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> String message;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DemoEvent</span><span style="color:#24292E;">(Object </span><span style="color:#E36209;">source</span><span style="color:#24292E;">,String </span><span style="color:#E36209;">message</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">super</span><span style="color:#24292E;">(source);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.message </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> message;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> String </span><span style="color:#6F42C1;">getMessage</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> message;</span></span>
<span class="line"><span style="color:#24292E;">          }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 定义一个事件监听者,实现ApplicationListener接口，重写 onApplicationEvent() 方法；</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Component</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DemoListener</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">implements</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ApplicationListener</span><span style="color:#24292E;">&lt;</span><span style="color:#D73A49;">DemoEvent</span><span style="color:#24292E;">&gt;{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//使用onApplicationEvent接收消息</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">onApplicationEvent</span><span style="color:#24292E;">(DemoEvent </span><span style="color:#E36209;">event</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        String msg </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> event.</span><span style="color:#6F42C1;">getMessage</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;接收到的信息是：&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">msg);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#6A737D;">// 发布事件，可以通过ApplicationEventPublisher  的 publishEvent() 方法发布消息。</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Component</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DemoPublisher</span><span style="color:#24292E;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Autowired</span></span>
<span class="line"><span style="color:#24292E;">    ApplicationContext applicationContext;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">publish</span><span style="color:#24292E;">(String </span><span style="color:#E36209;">message</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//发布事件</span></span>
<span class="line"><span style="color:#24292E;">        applicationContext.</span><span style="color:#6F42C1;">publishEvent</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DemoEvent</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, message));</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="适配器模式" tabindex="-1">适配器模式 <a class="header-anchor" href="#适配器模式" aria-label="Permalink to &quot;适配器模式&quot;">​</a></h4><h5 id="spring-aop-中的适配器模式" tabindex="-1">Spring AOP 中的适配器模式 <a class="header-anchor" href="#spring-aop-中的适配器模式" aria-label="Permalink to &quot;Spring AOP 中的适配器模式&quot;">​</a></h5><p>Spring AOP 的实现是基于代理模式，但是 Spring AOP 的增强或通知(Advice)使用到了适配器模式，与之相关的接口是<code>AdvisorAdapter</code> 。</p><p>Advice 常用的类型有：<code>BeforeAdvice</code>（目标方法调用前,前置通知）、<code>AfterAdvice</code>（目标方法调用后,后置通知）、<code>AfterReturningAdvice</code>(目标方法执行结束后，return 之前)等等。每个类型 Advice（通知）都有对应的拦截器:<code>MethodBeforeAdviceInterceptor</code>、<code>AfterReturningAdviceInterceptor</code>、<code>ThrowsAdviceInterceptor</code> 等等。</p><p>Spring 预定义的通知要通过对应的适配器，适配成 <code>MethodInterceptor</code> 接口(方法拦截器)类型的对象（如：<code>MethodBeforeAdviceAdapter</code> 通过调用 <code>getInterceptor</code> 方法，将 <code>MethodBeforeAdvice</code> 适配成 <code>MethodBeforeAdviceInterceptor</code> ）。</p><h5 id="spring-mvc-中的适配器模式" tabindex="-1">Spring MVC 中的适配器模式 <a class="header-anchor" href="#spring-mvc-中的适配器模式" aria-label="Permalink to &quot;Spring MVC 中的适配器模式&quot;">​</a></h5><p>在 Spring MVC 中，<code>DispatcherServlet</code> 根据请求信息调用 <code>HandlerMapping</code>，解析请求对应的 <code>Handler</code>。解析到对应的 <code>Handler</code>（也就是我们平常说的 <code>Controller</code> 控制器）后，开始由<code>HandlerAdapter</code> 适配器处理。<code>HandlerAdapter</code> 作为期望接口，具体的适配器实现类用于对目标类进行适配，<code>Controller</code> 作为需要适配的类。</p><h4 id="装饰者模式" tabindex="-1">装饰者模式 <a class="header-anchor" href="#装饰者模式" aria-label="Permalink to &quot;装饰者模式&quot;">​</a></h4><p>Spring 中配置 DataSource 的时候，DataSource 可能是不同的数据库和数据源。我们能否根据客户的需求在少修改原有类的代码下动态切换不同的数据源？这个时候就要用到装饰者模式(这一点我自己还没太理解具体原理)。Spring 中用到的包装器模式在类名上含有 <code>Wrapper</code>或者 <code>Decorator</code>。这些类基本上都是动态地给一个对象添加一些额外的职责</p><h2 id="组件篇" tabindex="-1">组件篇 <a class="header-anchor" href="#组件篇" aria-label="Permalink to &quot;组件篇&quot;">​</a></h2><p><img src="/assets/b12d2b0775b788c80247c9a7363011b6.0e176562.jpeg" alt="组件类图"></p><p>该图为 ClassPathXmlApplicationContext 的类继承体系结构，虽然只有一部分，但是它基本上包含了 IoC 体系中大部分的核心类和接口。</p><h3 id="resource" tabindex="-1">Resource <a class="header-anchor" href="#resource" aria-label="Permalink to &quot;Resource&quot;">​</a></h3><p><code>org.springframework.core.io.Resource</code>，对资源的抽象。它的每一个实现类都代表了一种资源的访问策略，如 ClassPathResource、RLResource、FileSystemResource 等。<img src="/assets/143162657d5f8c7cb7712d0996bf2a38.033f6d89.jpeg" alt="Resource 类图"></p><p>有了资源，就应该有资源加载，Spring 利用 <code>org.springframework.core.io.ResourceLoader</code> 来进行统一资源加载，类图如下：</p><p><img src="/assets/2446cc9fba90605b691ea250cf340ebb.479b4a45.png" alt="ResourceLoader 类图"></p><blockquote><ul><li>Spring 提供 Resource 和 ResourceLoader 统一抽象整个资源及其定位,并提供对应的Default类,便于自定义实现</li><li>AbstractResource 为 Resource 的默认抽象实现，它对 Resource 接口做了一个统一的实现，子类继承该类后只需要覆盖相应的方法即可，同时对于自定义的 Resource 我们也是继承该类</li><li>DefaultResourceLoader 同样也是 ResourceLoader 的默认实现，在自定义 ResourceLoader 的时候我们除了可以继承该类外还可以实现 ProtocolResolver 接口来实现自定资源加载协议。</li><li>DefaultResourceLoader 每次只能返回单一的资源，所以 Spring 针对这个提供了另外一个接口 ResourcePatternResolver ，该接口提供了根据指定的 locationPattern 返回多个资源的策略。其子类 PathMatchingResourcePatternResolver 是一个集大成者的 ResourceLoader ，因为它即实现了 <code>Resource getResource(String location)</code> 方法，也实现了 <code>Resource[] getResources(String locationPattern)</code> 方法。</li></ul></blockquote><h3 id="beanfactory" tabindex="-1">BeanFactory <a class="header-anchor" href="#beanfactory" aria-label="Permalink to &quot;BeanFactory&quot;">​</a></h3><p><code>org.springframework.beans.factory.BeanFactory</code>，是一个非常纯粹的 bean 容器，它是 IoC 必备的数据结构，其中 BeanDefinition 是它的基本结构。BeanFactory 内部维护着一个BeanDefinition map ，并可根据 BeanDefinition 的描述进行 bean 的创建和管理。</p><p><img src="/assets/4a0a9d810fad631a5f0263bc411e6606.b8d5973d.png" alt="BeanFactory 类图"></p><ul><li>BeanFactory 有三个直接子类 ListableBeanFactory、HierarchicalBeanFactory 和 AutowireCapableBeanFactory 。</li><li>DefaultListableBeanFactory 为最终默认实现，它实现了所有接口。</li></ul><h3 id="beandefinition" tabindex="-1">BeanDefinition <a class="header-anchor" href="#beandefinition" aria-label="Permalink to &quot;BeanDefinition&quot;">​</a></h3><p><code>org.springframework.beans.factory.config.BeanDefinition</code> ，用来描述 Spring 中的 Bean 对象。</p><p><img src="/assets/0e80d7996e6a8642b66873b0f0a31680.86f5b6be.png" alt="BeanDefinition 类图"></p><p><code>org.springframework.beans.factory.support.BeanDefinitionReader</code> 的作用是读取 Spring 的配置文件的内容，并将其转换成 Ioc 容器内部的数据结构 ：BeanDefinition 。<img src="/assets/8560e3437ba97621cffb794d629d4928.0c26dfd5.png" alt="BeanDefinitionReader 类图"></p><p>如下代码：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ClassPathResource resource </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ClassPathResource</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;bean.xml&quot;</span><span style="color:#E1E4E8;">); </span><span style="color:#6A737D;">// &lt;1&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">DefaultListableBeanFactory factory </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">DefaultListableBeanFactory</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// &lt;2&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">XmlBeanDefinitionReader reader </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">XmlBeanDefinitionReader</span><span style="color:#E1E4E8;">(factory); </span><span style="color:#6A737D;">// &lt;3&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">reader.</span><span style="color:#B392F0;">loadBeanDefinitions</span><span style="color:#E1E4E8;">(resource); </span><span style="color:#6A737D;">// &lt;4&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ClassPathResource resource </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ClassPathResource</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;bean.xml&quot;</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">// &lt;1&gt;</span></span>
<span class="line"><span style="color:#24292E;">DefaultListableBeanFactory factory </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DefaultListableBeanFactory</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// &lt;2&gt;</span></span>
<span class="line"><span style="color:#24292E;">XmlBeanDefinitionReader reader </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">XmlBeanDefinitionReader</span><span style="color:#24292E;">(factory); </span><span style="color:#6A737D;">// &lt;3&gt;</span></span>
<span class="line"><span style="color:#24292E;">reader.</span><span style="color:#6F42C1;">loadBeanDefinitions</span><span style="color:#24292E;">(resource); </span><span style="color:#6A737D;">// &lt;4&gt;</span></span></code></pre></div><p>这段代码是 Spring 中编程式使用 IoC 容器，通过这四段简单的代码，我们可以初步判断 IoC 容器的使用过程。</p><ol><li>获取资源</li><li>获取 BeanFactory</li><li>根据新建的 BeanFactory 创建一个 BeanDefinitionReader 对象，该 Reader 对象为资源的<strong>解析器</strong></li><li>装载资源</li></ol><p>整个过程就分为三个步骤：资源定位、装载、注册，如下：</p><p><img src="/assets/1e395ffbda4fe58a49897854a7d72ce9.7a02162c.png" alt="整体步骤"></p><ul><li><p><strong>资源定位</strong>。我们一般用外部资源来描述 Bean 对象，所以在初始化 IoC 容器的第一步就是需要定位这个外部资源。</p></li><li><p><strong>装载</strong>。装载就是 BeanDefinition 的载入。BeanDefinitionReader 读取、解析 Resource 资源，也就是将用户定义的 Bean 表示成 IoC 容器的内部数据结构：BeanDefinition 。</p><ul><li>在 IoC 容器内部维护着一个 BeanDefinition Map 的数据结构</li><li>在配置文件中每一个 <code>&lt;bean&gt;</code> 都对应着一个 BeanDefinition 对象。</li></ul></li><li><p><strong>注册</strong>。向 IoC 容器注册在第二步解析好的 BeanDefinition，这个过程是通过 BeanDefinitionRegistry 接口来实现的。在 IoC 容器内部其实是将第二个过程解析得到的 BeanDefinition 注入到一个 HashMap 容器中，IoC 容器就是通过这个 HashMap 来维护这些 BeanDefinition 的。</p><ul><li>在这里需要注意的一点是这个过程并没有完成依赖注入（Bean 创建），Bean 创建是发生在应用第一次调用 <code>#getBean(...)</code> 方法，向容器索要 Bean 时。</li><li>当然我们可以通过设置预处理，即对某个 Bean 设置 <code>lazyinit = false</code> 属性，那么这个 Bean 的依赖注入就会在容器初始化的时候完成。</li></ul></li></ul><h4 id="loadbeandefinitions" tabindex="-1">loadBeanDefinitions() <a class="header-anchor" href="#loadbeandefinitions" aria-label="Permalink to &quot;loadBeanDefinitions()&quot;">​</a></h4><p>上面看到的 <code>reader.loadBeanDefinitions(resource)</code> 代码，才是加载资源的真正实现，所以我们直接从该方法入手。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// XmlBeanDefinitionReader.java</span></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">loadBeanDefinitions</span><span style="color:#E1E4E8;">(Resource resource) throws BeanDefinitionStoreException {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">loadBeanDefinitions</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">EncodedResource</span><span style="color:#E1E4E8;">(resource));</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// XmlBeanDefinitionReader.java</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">loadBeanDefinitions</span><span style="color:#24292E;">(Resource resource) throws BeanDefinitionStoreException {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">loadBeanDefinitions</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">EncodedResource</span><span style="color:#24292E;">(resource));</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li>从指定的 xml 文件加载 Bean Definition ，这里会先对 Resource 资源封装成 <code>org.springframework.core.io.support.EncodedResource</code> 对象。这里为什么需要将 Resource 封装成 EncodedResource 呢？主要是为了对 Resource 进行编码，保证内容读取的正确性。</li><li>然后，再调用 <code>#loadBeanDefinitions(EncodedResource encodedResource)</code> 方法，执行真正的逻辑实现。</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 当前线程，正在加载的 EncodedResource 集合。</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> ThreadLocal&lt;Set&lt;</span><span style="color:#F97583;">EncodedResource</span><span style="color:#E1E4E8;">&gt;&gt; resourcesCurrentlyBeingLoaded </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> NamedThreadLocal&lt;&gt;(</span><span style="color:#9ECBFF;">&quot;XML bean definition resources currently being loaded&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">loadBeanDefinitions</span><span style="color:#E1E4E8;">(EncodedResource encodedResource) throws BeanDefinitionStoreException {</span></span>
<span class="line"><span style="color:#E1E4E8;">	Assert.</span><span style="color:#B392F0;">notNull</span><span style="color:#E1E4E8;">(encodedResource, </span><span style="color:#9ECBFF;">&quot;EncodedResource must not be null&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (logger.</span><span style="color:#B392F0;">isTraceEnabled</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		logger.</span><span style="color:#B392F0;">trace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Loading XML bean definitions from &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> encodedResource);</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// &lt;1&gt; 获取已经加载过的资源</span></span>
<span class="line"><span style="color:#E1E4E8;">	Set&lt;</span><span style="color:#F97583;">EncodedResource</span><span style="color:#E1E4E8;">&gt; currentResources </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.resourcesCurrentlyBeingLoaded.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (currentResources </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		currentResources </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> HashSet&lt;&gt;(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.resourcesCurrentlyBeingLoaded.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(currentResources);</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">currentResources.</span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(encodedResource)) { </span><span style="color:#6A737D;">// 将当前资源加入记录中。如果已存在，抛出异常</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanDefinitionStoreException</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Detected cyclic loading of &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> encodedResource </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot; - check your import definitions!&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">// &lt;2&gt; 从 EncodedResource 获取封装的 Resource ，并从 Resource 中获取其中的 InputStream</span></span>
<span class="line"><span style="color:#E1E4E8;">		InputStream inputStream </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> encodedResource.</span><span style="color:#B392F0;">getResource</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">getInputStream</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">			InputSource inputSource </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">InputSource</span><span style="color:#E1E4E8;">(inputStream);</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (encodedResource.</span><span style="color:#B392F0;">getEncoding</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// 设置编码</span></span>
<span class="line"><span style="color:#E1E4E8;">				inputSource.</span><span style="color:#B392F0;">setEncoding</span><span style="color:#E1E4E8;">(encodedResource.</span><span style="color:#B392F0;">getEncoding</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">			}</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#6A737D;">// 核心逻辑部分，执行加载 BeanDefinition</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">doLoadBeanDefinitions</span><span style="color:#E1E4E8;">(inputSource, encodedResource.</span><span style="color:#B392F0;">getResource</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">		} </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">			inputStream.</span><span style="color:#B392F0;">close</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">		}</span></span>
<span class="line"><span style="color:#E1E4E8;">	} </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (IOException </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanDefinitionStoreException</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;IOException parsing XML document from &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> encodedResource.</span><span style="color:#B392F0;">getResource</span><span style="color:#E1E4E8;">(), ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">	} </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">// 从缓存中剔除该资源 &lt;3&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">		currentResources.</span><span style="color:#B392F0;">remove</span><span style="color:#E1E4E8;">(encodedResource);</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (currentResources.</span><span style="color:#B392F0;">isEmpty</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.resourcesCurrentlyBeingLoaded.</span><span style="color:#B392F0;">remove</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">		}</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 当前线程，正在加载的 EncodedResource 集合。</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> ThreadLocal&lt;Set&lt;</span><span style="color:#D73A49;">EncodedResource</span><span style="color:#24292E;">&gt;&gt; resourcesCurrentlyBeingLoaded </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> NamedThreadLocal&lt;&gt;(</span><span style="color:#032F62;">&quot;XML bean definition resources currently being loaded&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">loadBeanDefinitions</span><span style="color:#24292E;">(EncodedResource encodedResource) throws BeanDefinitionStoreException {</span></span>
<span class="line"><span style="color:#24292E;">	Assert.</span><span style="color:#6F42C1;">notNull</span><span style="color:#24292E;">(encodedResource, </span><span style="color:#032F62;">&quot;EncodedResource must not be null&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (logger.</span><span style="color:#6F42C1;">isTraceEnabled</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">		logger.</span><span style="color:#6F42C1;">trace</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Loading XML bean definitions from &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> encodedResource);</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// &lt;1&gt; 获取已经加载过的资源</span></span>
<span class="line"><span style="color:#24292E;">	Set&lt;</span><span style="color:#D73A49;">EncodedResource</span><span style="color:#24292E;">&gt; currentResources </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.resourcesCurrentlyBeingLoaded.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (currentResources </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">		currentResources </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> HashSet&lt;&gt;(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.resourcesCurrentlyBeingLoaded.</span><span style="color:#6F42C1;">set</span><span style="color:#24292E;">(currentResources);</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">currentResources.</span><span style="color:#6F42C1;">add</span><span style="color:#24292E;">(encodedResource)) { </span><span style="color:#6A737D;">// 将当前资源加入记录中。如果已存在，抛出异常</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanDefinitionStoreException</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Detected cyclic loading of &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> encodedResource </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot; - check your import definitions!&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;">// &lt;2&gt; 从 EncodedResource 获取封装的 Resource ，并从 Resource 中获取其中的 InputStream</span></span>
<span class="line"><span style="color:#24292E;">		InputStream inputStream </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> encodedResource.</span><span style="color:#6F42C1;">getResource</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getInputStream</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">			InputSource inputSource </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">InputSource</span><span style="color:#24292E;">(inputStream);</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (encodedResource.</span><span style="color:#6F42C1;">getEncoding</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// 设置编码</span></span>
<span class="line"><span style="color:#24292E;">				inputSource.</span><span style="color:#6F42C1;">setEncoding</span><span style="color:#24292E;">(encodedResource.</span><span style="color:#6F42C1;">getEncoding</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">			}</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#6A737D;">// 核心逻辑部分，执行加载 BeanDefinition</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">doLoadBeanDefinitions</span><span style="color:#24292E;">(inputSource, encodedResource.</span><span style="color:#6F42C1;">getResource</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">		} </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">			inputStream.</span><span style="color:#6F42C1;">close</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">		}</span></span>
<span class="line"><span style="color:#24292E;">	} </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (IOException </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanDefinitionStoreException</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;IOException parsing XML document from &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> encodedResource.</span><span style="color:#6F42C1;">getResource</span><span style="color:#24292E;">(), ex);</span></span>
<span class="line"><span style="color:#24292E;">	} </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;">// 从缓存中剔除该资源 &lt;3&gt;</span></span>
<span class="line"><span style="color:#24292E;">		currentResources.</span><span style="color:#6F42C1;">remove</span><span style="color:#24292E;">(encodedResource);</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (currentResources.</span><span style="color:#6F42C1;">isEmpty</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.resourcesCurrentlyBeingLoaded.</span><span style="color:#6F42C1;">remove</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">		}</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li>&lt;1&gt;处，通过<code>resourcesCurrentlyBeingLoaded.get()</code>代码，来获取已经加载过的资源，然后将<code>encodedResource</code>加入其中，如果<code>resourcesCurrentlyBeingLoaded</code>中已经存在该资源，则抛出 BeanDefinitionStoreException 异常。 <ul><li>为什么需要这么做呢？答案在 <code>&quot;Detected cyclic loading&quot;</code> ，避免一个 EncodedResource 在加载时，还没加载完成，又加载自身，从而导致<strong>死循环</strong>。</li><li>也因此，在 <code>&lt;3&gt;</code> 处，当一个 EncodedResource 加载完成后，需要从缓存中剔除。</li></ul></li><li><code>&lt;2&gt;</code> 处理，从 <code>encodedResource</code> 获取封装的 Resource 资源，并从 Resource 中获取相应的 InputStream ，然后将 InputStream 封装为 InputSource ，最后调用 <code>#doLoadBeanDefinitions(InputSource inputSource, Resource resource)</code> 方法，执行加载 Bean Definition 的真正逻辑。</li></ul><h4 id="doloadbeandefinitions" tabindex="-1">doLoadBeanDefinitions() <a class="header-anchor" href="#doloadbeandefinitions" aria-label="Permalink to &quot;doLoadBeanDefinitions()&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Actually load bean definitions from the specified XML file.</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@param</span><span style="color:#6A737D;"> </span><span style="color:#FFAB70;">inputSource</span><span style="color:#6A737D;"> the SAX InputSource to read from</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@param</span><span style="color:#6A737D;"> </span><span style="color:#FFAB70;">resource</span><span style="color:#6A737D;"> the resource descriptor for the XML file</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@return</span><span style="color:#6A737D;"> the number of bean definitions found</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@throws</span><span style="color:#6A737D;"> </span><span style="color:#B392F0;">BeanDefinitionStoreException</span><span style="color:#6A737D;"> in case of loading or parsing errors</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@see</span><span style="color:#6A737D;"> #doLoadDocument</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@see</span><span style="color:#6A737D;"> #registerBeanDefinitions</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">doLoadBeanDefinitions</span><span style="color:#E1E4E8;">(InputSource inputSource, Resource resource)</span></span>
<span class="line"><span style="color:#E1E4E8;">		throws BeanDefinitionStoreException {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">// &lt;1&gt; 获取 XML Document 实例</span></span>
<span class="line"><span style="color:#E1E4E8;">		Document doc </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">doLoadDocument</span><span style="color:#E1E4E8;">(inputSource, resource);</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">// &lt;2&gt; 根据 Document 实例，注册 Bean 信息</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> count </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">registerBeanDefinitions</span><span style="color:#E1E4E8;">(doc, resource);</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (logger.</span><span style="color:#B392F0;">isDebugEnabled</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">			logger.</span><span style="color:#B392F0;">debug</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Loaded &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> count </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot; bean definitions from &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> resource);</span></span>
<span class="line"><span style="color:#E1E4E8;">		}</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> count;</span></span>
<span class="line"><span style="color:#E1E4E8;">	} </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (BeanDefinitionStoreException </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> ex;</span></span>
<span class="line"><span style="color:#E1E4E8;">	} </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (SAXParseException </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">XmlBeanDefinitionStoreException</span><span style="color:#E1E4E8;">(resource.</span><span style="color:#B392F0;">getDescription</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;Line &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> ex.</span><span style="color:#B392F0;">getLineNumber</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot; in XML document from &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> resource </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot; is invalid&quot;</span><span style="color:#E1E4E8;">, ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">	} </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (SAXException </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">XmlBeanDefinitionStoreException</span><span style="color:#E1E4E8;">(resource.</span><span style="color:#B392F0;">getDescription</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#9ECBFF;">&quot;XML document from &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> resource </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot; is invalid&quot;</span><span style="color:#E1E4E8;">, ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">	} </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (ParserConfigurationException </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanDefinitionStoreException</span><span style="color:#E1E4E8;">(resource.</span><span style="color:#B392F0;">getDescription</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#9ECBFF;">&quot;Parser configuration exception parsing XML from &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> resource, ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">	} </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (IOException </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanDefinitionStoreException</span><span style="color:#E1E4E8;">(resource.</span><span style="color:#B392F0;">getDescription</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#9ECBFF;">&quot;IOException parsing XML document from &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> resource, ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">	} </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (Throwable </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanDefinitionStoreException</span><span style="color:#E1E4E8;">(resource.</span><span style="color:#B392F0;">getDescription</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#9ECBFF;">&quot;Unexpected exception parsing XML document from &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> resource, ex);</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Actually load bean definitions from the specified XML file.</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@param</span><span style="color:#6A737D;"> </span><span style="color:#E36209;">inputSource</span><span style="color:#6A737D;"> the SAX InputSource to read from</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@param</span><span style="color:#6A737D;"> </span><span style="color:#E36209;">resource</span><span style="color:#6A737D;"> the resource descriptor for the XML file</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@return</span><span style="color:#6A737D;"> the number of bean definitions found</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@throws</span><span style="color:#6A737D;"> </span><span style="color:#6F42C1;">BeanDefinitionStoreException</span><span style="color:#6A737D;"> in case of loading or parsing errors</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@see</span><span style="color:#6A737D;"> #doLoadDocument</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@see</span><span style="color:#6A737D;"> #registerBeanDefinitions</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">doLoadBeanDefinitions</span><span style="color:#24292E;">(InputSource inputSource, Resource resource)</span></span>
<span class="line"><span style="color:#24292E;">		throws BeanDefinitionStoreException {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;">// &lt;1&gt; 获取 XML Document 实例</span></span>
<span class="line"><span style="color:#24292E;">		Document doc </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">doLoadDocument</span><span style="color:#24292E;">(inputSource, resource);</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;">// &lt;2&gt; 根据 Document 实例，注册 Bean 信息</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> count </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">registerBeanDefinitions</span><span style="color:#24292E;">(doc, resource);</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (logger.</span><span style="color:#6F42C1;">isDebugEnabled</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">			logger.</span><span style="color:#6F42C1;">debug</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Loaded &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> count </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot; bean definitions from &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> resource);</span></span>
<span class="line"><span style="color:#24292E;">		}</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> count;</span></span>
<span class="line"><span style="color:#24292E;">	} </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (BeanDefinitionStoreException </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> ex;</span></span>
<span class="line"><span style="color:#24292E;">	} </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (SAXParseException </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">XmlBeanDefinitionStoreException</span><span style="color:#24292E;">(resource.</span><span style="color:#6F42C1;">getDescription</span><span style="color:#24292E;">(),</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;Line &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> ex.</span><span style="color:#6F42C1;">getLineNumber</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot; in XML document from &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> resource </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot; is invalid&quot;</span><span style="color:#24292E;">, ex);</span></span>
<span class="line"><span style="color:#24292E;">	} </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (SAXException </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">XmlBeanDefinitionStoreException</span><span style="color:#24292E;">(resource.</span><span style="color:#6F42C1;">getDescription</span><span style="color:#24292E;">(),</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#032F62;">&quot;XML document from &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> resource </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot; is invalid&quot;</span><span style="color:#24292E;">, ex);</span></span>
<span class="line"><span style="color:#24292E;">	} </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (ParserConfigurationException </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanDefinitionStoreException</span><span style="color:#24292E;">(resource.</span><span style="color:#6F42C1;">getDescription</span><span style="color:#24292E;">(),</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#032F62;">&quot;Parser configuration exception parsing XML from &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> resource, ex);</span></span>
<span class="line"><span style="color:#24292E;">	} </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (IOException </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanDefinitionStoreException</span><span style="color:#24292E;">(resource.</span><span style="color:#6F42C1;">getDescription</span><span style="color:#24292E;">(),</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#032F62;">&quot;IOException parsing XML document from &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> resource, ex);</span></span>
<span class="line"><span style="color:#24292E;">	} </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (Throwable </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanDefinitionStoreException</span><span style="color:#24292E;">(resource.</span><span style="color:#6F42C1;">getDescription</span><span style="color:#24292E;">(),</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#032F62;">&quot;Unexpected exception parsing XML document from &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> resource, ex);</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li>在 <code>&lt;1&gt;</code> 处，调用 <code>#doLoadDocument(InputSource inputSource, Resource resource)</code> 方法，根据 xml 文件，获取 Document 实例。</li><li>在 <code>&lt;2&gt;</code> 处，调用 <code>#registerBeanDefinitions(Document doc, Resource resource)</code> 方法，根据获取的 Document 实例，注册 Bean 信息。</li></ul><h5 id="doloaddocument" tabindex="-1">doLoadDocument() <a class="header-anchor" href="#doloaddocument" aria-label="Permalink to &quot;doLoadDocument()&quot;">​</a></h5><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 获取 XML Document 实例</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * Actually load the specified document using the configured DocumentLoader.</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@param</span><span style="color:#6A737D;"> </span><span style="color:#FFAB70;">inputSource</span><span style="color:#6A737D;"> the SAX InputSource to read from</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@param</span><span style="color:#6A737D;"> </span><span style="color:#FFAB70;">resource</span><span style="color:#6A737D;"> the resource descriptor for the XML file</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@return</span><span style="color:#6A737D;"> the DOM Document</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@throws</span><span style="color:#6A737D;"> </span><span style="color:#B392F0;">Exception</span><span style="color:#6A737D;"> when thrown from the DocumentLoader</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@see</span><span style="color:#6A737D;"> #setDocumentLoader</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@see</span><span style="color:#6A737D;"> DocumentLoader#loadDocument</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> Document </span><span style="color:#B392F0;">doLoadDocument</span><span style="color:#E1E4E8;">(InputSource inputSource, Resource resource) throws Exception {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.documentLoader.</span><span style="color:#B392F0;">loadDocument</span><span style="color:#E1E4E8;">(inputSource, </span><span style="color:#B392F0;">getEntityResolver</span><span style="color:#E1E4E8;">(), </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.errorHandler,</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#B392F0;">getValidationModeForResource</span><span style="color:#E1E4E8;">(resource), </span><span style="color:#B392F0;">isNamespaceAware</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 获取 XML Document 实例</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * Actually load the specified document using the configured DocumentLoader.</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@param</span><span style="color:#6A737D;"> </span><span style="color:#E36209;">inputSource</span><span style="color:#6A737D;"> the SAX InputSource to read from</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@param</span><span style="color:#6A737D;"> </span><span style="color:#E36209;">resource</span><span style="color:#6A737D;"> the resource descriptor for the XML file</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@return</span><span style="color:#6A737D;"> the DOM Document</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@throws</span><span style="color:#6A737D;"> </span><span style="color:#6F42C1;">Exception</span><span style="color:#6A737D;"> when thrown from the DocumentLoader</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@see</span><span style="color:#6A737D;"> #setDocumentLoader</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@see</span><span style="color:#6A737D;"> DocumentLoader#loadDocument</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> Document </span><span style="color:#6F42C1;">doLoadDocument</span><span style="color:#24292E;">(InputSource inputSource, Resource resource) throws Exception {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.documentLoader.</span><span style="color:#6F42C1;">loadDocument</span><span style="color:#24292E;">(inputSource, </span><span style="color:#6F42C1;">getEntityResolver</span><span style="color:#24292E;">(), </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.errorHandler,</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#6F42C1;">getValidationModeForResource</span><span style="color:#24292E;">(resource), </span><span style="color:#6F42C1;">isNamespaceAware</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ol><li>调用 <code>#getValidationModeForResource(Resource resource)</code> 方法，获取指定资源（xml）的<strong>验证模式</strong>。</li><li>调用 <code>DocumentLoader#loadDocument(InputSource inputSource, EntityResolver entityResolver, ErrorHandler errorHandler, int validationMode, boolean namespaceAware)</code> 方法，获取 XML Document 实例。</li></ol><h5 id="registerbeandefinitions" tabindex="-1">registerBeanDefinitions() <a class="header-anchor" href="#registerbeandefinitions" aria-label="Permalink to &quot;registerBeanDefinitions()&quot;">​</a></h5><p>获取 XML Document 对象后，会根据该对象和 Resource 资源对象调用 <code>XmlBeanDefinitionReader#registerBeanDefinitions(Document doc, Resource resource)</code> 方法，开始注册 BeanDefinitions 之旅。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanDefinitionReader.java</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> BeanDefinitionRegistry registry;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// XmlBeanDefinitionReader.java</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">registerBeanDefinitions</span><span style="color:#E1E4E8;">(Document doc, Resource resource) throws BeanDefinitionStoreException {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// &lt;1&gt; 创建 BeanDefinitionDocumentReader 对象</span></span>
<span class="line"><span style="color:#E1E4E8;">	BeanDefinitionDocumentReader documentReader </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">createBeanDefinitionDocumentReader</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// &lt;2&gt; 获取已注册的 BeanDefinition 数量</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> countBefore </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getRegistry</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">getBeanDefinitionCount</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// &lt;3&gt; 创建 XmlReaderContext 对象</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// &lt;4&gt; 注册 BeanDefinition</span></span>
<span class="line"><span style="color:#E1E4E8;">	documentReader.</span><span style="color:#B392F0;">registerBeanDefinitions</span><span style="color:#E1E4E8;">(doc, </span><span style="color:#B392F0;">createReaderContext</span><span style="color:#E1E4E8;">(resource));</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// 计算新注册的 BeanDefinition 数量</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getRegistry</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">getBeanDefinitionCount</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> countBefore;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanDefinitionReader.java</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> BeanDefinitionRegistry registry;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// XmlBeanDefinitionReader.java</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">registerBeanDefinitions</span><span style="color:#24292E;">(Document doc, Resource resource) throws BeanDefinitionStoreException {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// &lt;1&gt; 创建 BeanDefinitionDocumentReader 对象</span></span>
<span class="line"><span style="color:#24292E;">	BeanDefinitionDocumentReader documentReader </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">createBeanDefinitionDocumentReader</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// &lt;2&gt; 获取已注册的 BeanDefinition 数量</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> countBefore </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getRegistry</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getBeanDefinitionCount</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// &lt;3&gt; 创建 XmlReaderContext 对象</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// &lt;4&gt; 注册 BeanDefinition</span></span>
<span class="line"><span style="color:#24292E;">	documentReader.</span><span style="color:#6F42C1;">registerBeanDefinitions</span><span style="color:#24292E;">(doc, </span><span style="color:#6F42C1;">createReaderContext</span><span style="color:#24292E;">(resource));</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// 计算新注册的 BeanDefinition 数量</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getRegistry</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getBeanDefinitionCount</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> countBefore;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li><p><code>&lt;1&gt;</code> 处，调用 <code>#createBeanDefinitionDocumentReader()</code> 方法，实例化 BeanDefinitionDocumentReader 对象。</p></li><li><p><code>&lt;2&gt;</code> 处，调用 <code>BeanDefinitionRegistry#getBeanDefinitionCount()</code> 方法，获取<strong>已注册</strong>的 BeanDefinition 数量。</p></li><li><p><code>&lt;3&gt;</code> 处，调用 <code>#createReaderContext(Resource resource)</code> 方法，创建 XmlReaderContext 对象。</p></li><li><p><code>&lt;4&gt;</code> 处，调用 <code>BeanDefinitionDocumentReader#registerBeanDefinitions(Document doc, XmlReaderContext readerContext)</code> 方法，读取 XML 元素，注册 BeanDefinition 们。</p></li><li><p><code>&lt;5&gt;</code> 处，计<strong>算新注册</strong>的 BeanDefinition 数量。</p></li></ul><h5 id="createbeandefinitiondocumentreader" tabindex="-1">createBeanDefinitionDocumentReader() <a class="header-anchor" href="#createbeandefinitiondocumentreader" aria-label="Permalink to &quot;createBeanDefinitionDocumentReader()&quot;">​</a></h5><p><code>#createBeanDefinitionDocumentReader()</code>，实例化 BeanDefinitionDocumentReader 对象。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * documentReader 的类</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@see</span><span style="color:#6A737D;"> #createBeanDefinitionDocumentReader() </span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> Class&lt;</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">BeanDefinitionDocumentReader</span><span style="color:#E1E4E8;">&gt; documentReaderClass </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> DefaultBeanDefinitionDocumentReader.class;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> BeanDefinitionDocumentReader </span><span style="color:#B392F0;">createBeanDefinitionDocumentReader</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> BeanUtils.</span><span style="color:#B392F0;">instantiateClass</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.documentReaderClass);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * documentReader 的类</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@see</span><span style="color:#6A737D;"> #createBeanDefinitionDocumentReader() </span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> Class&lt;</span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">BeanDefinitionDocumentReader</span><span style="color:#24292E;">&gt; documentReaderClass </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> DefaultBeanDefinitionDocumentReader.class;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> BeanDefinitionDocumentReader </span><span style="color:#6F42C1;">createBeanDefinitionDocumentReader</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> BeanUtils.</span><span style="color:#6F42C1;">instantiateClass</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.documentReaderClass);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li><code>documentReaderClass</code> 的默认值为 <code>DefaultBeanDefinitionDocumentReader.class</code> 。</li></ul><h5 id="registerbeandefinitions-1" tabindex="-1">registerBeanDefinitions() <a class="header-anchor" href="#registerbeandefinitions-1" aria-label="Permalink to &quot;registerBeanDefinitions()&quot;">​</a></h5><p><code>BeanDefinitionDocumentReader#registerBeanDefinitions(Document doc, XmlReaderContext readerContext)</code> 方法，注册 BeanDefinition ，在接口 BeanDefinitionDocumentReader 中定义。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanDefinitionDocumentReader</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">	/**</span></span>
<span class="line"><span style="color:#6A737D;">	 * Read bean definitions from the given DOM document and</span></span>
<span class="line"><span style="color:#6A737D;">	 * register them with the registry in the given reader context.</span></span>
<span class="line"><span style="color:#6A737D;">	 * </span><span style="color:#F97583;">@param</span><span style="color:#6A737D;"> </span><span style="color:#FFAB70;">doc</span><span style="color:#6A737D;"> the DOM document</span></span>
<span class="line"><span style="color:#6A737D;">	 * </span><span style="color:#F97583;">@param</span><span style="color:#6A737D;"> </span><span style="color:#FFAB70;">readerContext</span><span style="color:#6A737D;"> the current context of the reader</span></span>
<span class="line"><span style="color:#6A737D;">	 * (includes the target registry and the resource being parsed)</span></span>
<span class="line"><span style="color:#6A737D;">	 * </span><span style="color:#F97583;">@throws</span><span style="color:#6A737D;"> </span><span style="color:#B392F0;">BeanDefinitionStoreException</span><span style="color:#6A737D;"> in case of parsing errors</span></span>
<span class="line"><span style="color:#6A737D;">	 */</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">registerBeanDefinitions</span><span style="color:#E1E4E8;">(Document </span><span style="color:#FFAB70;">doc</span><span style="color:#E1E4E8;">, XmlReaderContext </span><span style="color:#FFAB70;">readerContext</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> BeanDefinitionStoreException;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">interface</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanDefinitionDocumentReader</span><span style="color:#24292E;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">	/**</span></span>
<span class="line"><span style="color:#6A737D;">	 * Read bean definitions from the given DOM document and</span></span>
<span class="line"><span style="color:#6A737D;">	 * register them with the registry in the given reader context.</span></span>
<span class="line"><span style="color:#6A737D;">	 * </span><span style="color:#D73A49;">@param</span><span style="color:#6A737D;"> </span><span style="color:#E36209;">doc</span><span style="color:#6A737D;"> the DOM document</span></span>
<span class="line"><span style="color:#6A737D;">	 * </span><span style="color:#D73A49;">@param</span><span style="color:#6A737D;"> </span><span style="color:#E36209;">readerContext</span><span style="color:#6A737D;"> the current context of the reader</span></span>
<span class="line"><span style="color:#6A737D;">	 * (includes the target registry and the resource being parsed)</span></span>
<span class="line"><span style="color:#6A737D;">	 * </span><span style="color:#D73A49;">@throws</span><span style="color:#6A737D;"> </span><span style="color:#6F42C1;">BeanDefinitionStoreException</span><span style="color:#6A737D;"> in case of parsing errors</span></span>
<span class="line"><span style="color:#6A737D;">	 */</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">registerBeanDefinitions</span><span style="color:#24292E;">(Document </span><span style="color:#E36209;">doc</span><span style="color:#24292E;">, XmlReaderContext </span><span style="color:#E36209;">readerContext</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> BeanDefinitionStoreException;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p><strong>从给定的 Document 对象中解析定义的 BeanDefinition 并将他们注册到注册表中</strong>。方法接收两个参数：</p><ul><li><code>doc</code> 方法参数：待解析的 Document 对象。</li><li><code>readerContext</code> 方法，解析器的当前上下文，包括目标注册表和被解析的资源。它是根据 Resource 来创建</li></ul><p>这里涉及到两个重要的组件</p><ul><li><p>DefaultBeanDefinitionDocumentReader</p><ul><li><p>BeanDefinitionDocumentReader 有且只有一个默认实现类 DefaultBeanDefinitionDocumentReader 。它对 <code>#registerBeanDefinitions(...)</code> 方法的实现代码如下：</p><p>DefaultBeanDefinitionDocumentReader 对该方法提供了实现：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Nullable</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> XmlReaderContext readerContext;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Nullable</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> BeanDefinitionParserDelegate delegate;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * This implementation parses bean definitions according to the &quot;spring-beans&quot; XSD</span></span>
<span class="line"><span style="color:#6A737D;"> * (or DTD, historically).</span></span>
<span class="line"><span style="color:#6A737D;"> * &lt;p&gt;Opens a DOM Document; then initializes the default settings</span></span>
<span class="line"><span style="color:#6A737D;"> * specified at the {@code &lt;beans/&gt;} level; then parses the contained bean definitions.</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">registerBeanDefinitions</span><span style="color:#E1E4E8;">(Document doc, XmlReaderContext readerContext) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.readerContext </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> readerContext;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 获得 XML Document Root Element</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 执行注册 BeanDefinition</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">doRegisterBeanDefinitions</span><span style="color:#E1E4E8;">(doc.</span><span style="color:#B392F0;">getDocumentElement</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Register each bean definition within the given root {@code &lt;beans/&gt;} element.</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">SuppressWarnings</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;deprecation&quot;</span><span style="color:#E1E4E8;">)  </span><span style="color:#6A737D;">// for Environment.acceptsProfiles(String...)</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">doRegisterBeanDefinitions</span><span style="color:#E1E4E8;">(Element root) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// Any nested &lt;beans&gt; elements will cause recursion in this method. In</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// order to propagate and preserve &lt;beans&gt; default-* attributes correctly,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// keep track of the current (parent) delegate, which may be null. Create</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// the new (child) delegate with a reference to the parent for fallback purposes,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// then ultimately reset this.delegate back to its original (parent) reference.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// this behavior emulates a stack of delegates without actually necessitating one.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 记录老的 BeanDefinitionParserDelegate 对象</span></span>
<span class="line"><span style="color:#E1E4E8;">    BeanDefinitionParserDelegate parent </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.delegate;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;1&gt; 创建 BeanDefinitionParserDelegate 对象，并进行设置到 delegate</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.delegate </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">createDelegate</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">getReaderContext</span><span style="color:#E1E4E8;">(), root, parent);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;2&gt; 检查 &lt;beans /&gt; 根标签的命名空间是否为空，或者是 http://www.springframework.org/schema/beans</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.delegate.</span><span style="color:#B392F0;">isDefaultNamespace</span><span style="color:#E1E4E8;">(root)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// &lt;2.1&gt; 处理 profile 属性。可参见《Spring3自定义环境配置 &lt;beans profile=&quot;&quot;&gt;》http://nassir.iteye.com/blog/1535799</span></span>
<span class="line"><span style="color:#E1E4E8;">        String profileSpec </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> root.</span><span style="color:#B392F0;">getAttribute</span><span style="color:#E1E4E8;">(PROFILE_ATTRIBUTE);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (StringUtils.</span><span style="color:#B392F0;">hasText</span><span style="color:#E1E4E8;">(profileSpec)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// &lt;2.2&gt; 使用分隔符切分，可能有多个 profile 。</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] specifiedProfiles </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> StringUtils.</span><span style="color:#B392F0;">tokenizeToStringArray</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">                    profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// &lt;2.3&gt; 如果所有 profile 都无效，则不进行注册</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// We cannot use Profiles.of(...) since profile expressions are not supported</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// in XML config. See SPR-12458 for details.</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">getReaderContext</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">getEnvironment</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">acceptsProfiles</span><span style="color:#E1E4E8;">(specifiedProfiles)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (logger.</span><span style="color:#B392F0;">isDebugEnabled</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    logger.</span><span style="color:#B392F0;">debug</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Skipped XML bean definition file due to specified profiles [&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> profileSpec </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#9ECBFF;">&quot;] not matching: &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getReaderContext</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">getResource</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;3&gt; 解析前处理</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">preProcessXml</span><span style="color:#E1E4E8;">(root);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;4&gt; 解析</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">parseBeanDefinitions</span><span style="color:#E1E4E8;">(root, </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.delegate);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;5&gt; 解析后处理</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">postProcessXml</span><span style="color:#E1E4E8;">(root);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 设置 delegate 回老的 BeanDefinitionParserDelegate 对象</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.delegate </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> parent;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Nullable</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> XmlReaderContext readerContext;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Nullable</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> BeanDefinitionParserDelegate delegate;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * This implementation parses bean definitions according to the &quot;spring-beans&quot; XSD</span></span>
<span class="line"><span style="color:#6A737D;"> * (or DTD, historically).</span></span>
<span class="line"><span style="color:#6A737D;"> * &lt;p&gt;Opens a DOM Document; then initializes the default settings</span></span>
<span class="line"><span style="color:#6A737D;"> * specified at the {@code &lt;beans/&gt;} level; then parses the contained bean definitions.</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">registerBeanDefinitions</span><span style="color:#24292E;">(Document doc, XmlReaderContext readerContext) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.readerContext </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> readerContext;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 获得 XML Document Root Element</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 执行注册 BeanDefinition</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">doRegisterBeanDefinitions</span><span style="color:#24292E;">(doc.</span><span style="color:#6F42C1;">getDocumentElement</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Register each bean definition within the given root {@code &lt;beans/&gt;} element.</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">SuppressWarnings</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;deprecation&quot;</span><span style="color:#24292E;">)  </span><span style="color:#6A737D;">// for Environment.acceptsProfiles(String...)</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">doRegisterBeanDefinitions</span><span style="color:#24292E;">(Element root) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// Any nested &lt;beans&gt; elements will cause recursion in this method. In</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// order to propagate and preserve &lt;beans&gt; default-* attributes correctly,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// keep track of the current (parent) delegate, which may be null. Create</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// the new (child) delegate with a reference to the parent for fallback purposes,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// then ultimately reset this.delegate back to its original (parent) reference.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// this behavior emulates a stack of delegates without actually necessitating one.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 记录老的 BeanDefinitionParserDelegate 对象</span></span>
<span class="line"><span style="color:#24292E;">    BeanDefinitionParserDelegate parent </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.delegate;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;1&gt; 创建 BeanDefinitionParserDelegate 对象，并进行设置到 delegate</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.delegate </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">createDelegate</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">getReaderContext</span><span style="color:#24292E;">(), root, parent);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;2&gt; 检查 &lt;beans /&gt; 根标签的命名空间是否为空，或者是 http://www.springframework.org/schema/beans</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.delegate.</span><span style="color:#6F42C1;">isDefaultNamespace</span><span style="color:#24292E;">(root)) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// &lt;2.1&gt; 处理 profile 属性。可参见《Spring3自定义环境配置 &lt;beans profile=&quot;&quot;&gt;》http://nassir.iteye.com/blog/1535799</span></span>
<span class="line"><span style="color:#24292E;">        String profileSpec </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> root.</span><span style="color:#6F42C1;">getAttribute</span><span style="color:#24292E;">(PROFILE_ATTRIBUTE);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (StringUtils.</span><span style="color:#6F42C1;">hasText</span><span style="color:#24292E;">(profileSpec)) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// &lt;2.2&gt; 使用分隔符切分，可能有多个 profile 。</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] specifiedProfiles </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> StringUtils.</span><span style="color:#6F42C1;">tokenizeToStringArray</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">                    profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// &lt;2.3&gt; 如果所有 profile 都无效，则不进行注册</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// We cannot use Profiles.of(...) since profile expressions are not supported</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// in XML config. See SPR-12458 for details.</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#6F42C1;">getReaderContext</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getEnvironment</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">acceptsProfiles</span><span style="color:#24292E;">(specifiedProfiles)) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (logger.</span><span style="color:#6F42C1;">isDebugEnabled</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">                    logger.</span><span style="color:#6F42C1;">debug</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Skipped XML bean definition file due to specified profiles [&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> profileSpec </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#032F62;">&quot;] not matching: &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getReaderContext</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getResource</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">return</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;3&gt; 解析前处理</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">preProcessXml</span><span style="color:#24292E;">(root);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;4&gt; 解析</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">parseBeanDefinitions</span><span style="color:#24292E;">(root, </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.delegate);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;5&gt; 解析后处理</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">postProcessXml</span><span style="color:#24292E;">(root);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 设置 delegate 回老的 BeanDefinitionParserDelegate 对象</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.delegate </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> parent;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p><code>&lt;1&gt;</code> 处，创建 BeanDefinitionParserDelegate 对象，并进行设置到 <code>delegate</code> 。BeanDefinitionParserDelegate 是一个重要的类，它负责<strong>解析 BeanDefinition</strong>。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> BeanDefinitionParserDelegate </span><span style="color:#B392F0;">createDelegate</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        XmlReaderContext readerContext, Element root, @</span><span style="color:#F97583;">Nullable</span><span style="color:#E1E4E8;"> BeanDefinitionParserDelegate parentDelegate) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 创建 BeanDefinitionParserDelegate 对象</span></span>
<span class="line"><span style="color:#E1E4E8;">    BeanDefinitionParserDelegate delegate </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanDefinitionParserDelegate</span><span style="color:#E1E4E8;">(readerContext);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 初始化默认</span></span>
<span class="line"><span style="color:#E1E4E8;">    delegate.</span><span style="color:#B392F0;">initDefaults</span><span style="color:#E1E4E8;">(root, parentDelegate);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> delegate;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> BeanDefinitionParserDelegate </span><span style="color:#6F42C1;">createDelegate</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        XmlReaderContext readerContext, Element root, @</span><span style="color:#D73A49;">Nullable</span><span style="color:#24292E;"> BeanDefinitionParserDelegate parentDelegate) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 创建 BeanDefinitionParserDelegate 对象</span></span>
<span class="line"><span style="color:#24292E;">    BeanDefinitionParserDelegate delegate </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanDefinitionParserDelegate</span><span style="color:#24292E;">(readerContext);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 初始化默认</span></span>
<span class="line"><span style="color:#24292E;">    delegate.</span><span style="color:#6F42C1;">initDefaults</span><span style="color:#24292E;">(root, parentDelegate);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> delegate;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>&lt;2&gt;<code>处，检查</code><!---->` <strong>根</strong>标签的命名空间是否为空，或者是 <a href="http://www.springframework.org/schema/beans" target="_blank" rel="noreferrer">http://www.springframework.org/schema/beans</a> 。</p><ul><li><code>&lt;2.1&gt;</code> 处，判断是否 <code>&lt;beans /&gt;</code> 上配置了 <code>profile</code> 属性。参考 <a href="http://nassir.iteye.com/blog/1535799" target="_blank" rel="noreferrer">《《Spring3自定义环境配置 》》</a> 。</li><li><code>&lt;2.2&gt;</code> 处，使用分隔符切分，可能有<strong>多个</strong> profile 。</li><li><code>&lt;2.3&gt;</code> 处，判断，如果所有 profile 都无效，则 <code>return</code> 不进行注册。</li></ul><p><code>&lt;4&gt;</code> 处，调用 <code>#parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate)</code> 方法，进行解析逻辑。详细解析，见 <a href="http://svip.iocoder.cn/Spring/IoC-register-BeanDefinitions/#" target="_blank" rel="noreferrer">「3.1 parseBeanDefinitions」</a> 。</p><p><code>&lt;3&gt;</code> / <code>&lt;5&gt;</code> 处，解析<strong>前后</strong>的处理，目前这两个方法都是空实现，交由子类来实现。代码如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">protected void preProcessXml(Element root) {}</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">protected void postProcessXml(Element root) {}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">protected void preProcessXml(Element root) {}</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">protected void postProcessXml(Element root) {}</span></span></code></pre></div></li></ul></li><li><p>parseBeanDefinitions</p><ul><li><p><code>#parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate)</code> 方法，进行解析逻辑。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Parse the elements at the root level in the document:</span></span>
<span class="line"><span style="color:#6A737D;"> * &quot;import&quot;, &quot;alias&quot;, &quot;bean&quot;.</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#F97583;">@param</span><span style="color:#6A737D;"> </span><span style="color:#FFAB70;">root</span><span style="color:#6A737D;"> the DOM root element of the document</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">parseBeanDefinitions</span><span style="color:#E1E4E8;">(Element root, BeanDefinitionParserDelegate delegate) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;1&gt; 如果根节点使用默认命名空间，执行默认解析</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (delegate.</span><span style="color:#B392F0;">isDefaultNamespace</span><span style="color:#E1E4E8;">(root)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 遍历子节点</span></span>
<span class="line"><span style="color:#E1E4E8;">        NodeList nl </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> root.</span><span style="color:#B392F0;">getChildNodes</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> nl.</span><span style="color:#B392F0;">getLength</span><span style="color:#E1E4E8;">(); i</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            Node node </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nl.</span><span style="color:#B392F0;">item</span><span style="color:#E1E4E8;">(i);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (node </span><span style="color:#F97583;">instanceof</span><span style="color:#E1E4E8;"> Element) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                Element ele </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (Element) node;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// &lt;1&gt; 如果该节点使用默认命名空间，执行默认解析</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (delegate.</span><span style="color:#B392F0;">isDefaultNamespace</span><span style="color:#E1E4E8;">(ele)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#B392F0;">parseDefaultElement</span><span style="color:#E1E4E8;">(ele, delegate);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// 如果该节点非默认命名空间，执行自定义解析</span></span>
<span class="line"><span style="color:#E1E4E8;">                } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    delegate.</span><span style="color:#B392F0;">parseCustomElement</span><span style="color:#E1E4E8;">(ele);</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// &lt;2&gt; 如果根节点非默认命名空间，执行自定义解析</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        delegate.</span><span style="color:#B392F0;">parseCustomElement</span><span style="color:#E1E4E8;">(root);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Parse the elements at the root level in the document:</span></span>
<span class="line"><span style="color:#6A737D;"> * &quot;import&quot;, &quot;alias&quot;, &quot;bean&quot;.</span></span>
<span class="line"><span style="color:#6A737D;"> * </span><span style="color:#D73A49;">@param</span><span style="color:#6A737D;"> </span><span style="color:#E36209;">root</span><span style="color:#6A737D;"> the DOM root element of the document</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">parseBeanDefinitions</span><span style="color:#24292E;">(Element root, BeanDefinitionParserDelegate delegate) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;1&gt; 如果根节点使用默认命名空间，执行默认解析</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (delegate.</span><span style="color:#6F42C1;">isDefaultNamespace</span><span style="color:#24292E;">(root)) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 遍历子节点</span></span>
<span class="line"><span style="color:#24292E;">        NodeList nl </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> root.</span><span style="color:#6F42C1;">getChildNodes</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; i </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> nl.</span><span style="color:#6F42C1;">getLength</span><span style="color:#24292E;">(); i</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            Node node </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nl.</span><span style="color:#6F42C1;">item</span><span style="color:#24292E;">(i);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (node </span><span style="color:#D73A49;">instanceof</span><span style="color:#24292E;"> Element) {</span></span>
<span class="line"><span style="color:#24292E;">                Element ele </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (Element) node;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// &lt;1&gt; 如果该节点使用默认命名空间，执行默认解析</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (delegate.</span><span style="color:#6F42C1;">isDefaultNamespace</span><span style="color:#24292E;">(ele)) {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6F42C1;">parseDefaultElement</span><span style="color:#24292E;">(ele, delegate);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// 如果该节点非默认命名空间，执行自定义解析</span></span>
<span class="line"><span style="color:#24292E;">                } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                    delegate.</span><span style="color:#6F42C1;">parseCustomElement</span><span style="color:#24292E;">(ele);</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// &lt;2&gt; 如果根节点非默认命名空间，执行自定义解析</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        delegate.</span><span style="color:#6F42C1;">parseCustomElement</span><span style="color:#24292E;">(root);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li><p>Spring 有两种Bean 声明方式：</p><ul><li>配置文件式声明：<code>&lt;bean id=&quot;studentService&quot; class=&quot;org.springframework.core.StudentService&quot; /&gt;</code> 。对应 <code>&lt;1&gt;</code> 处。</li><li>自定义注解方式：<code>&lt;tx:annotation-driven&gt;</code> 。对应 <code>&lt;2&gt;</code> 处。</li></ul><p><code>&lt;1&gt;</code> 处，如果<strong>根</strong>节点或<strong>子</strong>节点<strong>使用</strong>默认命名空间，调用 <code>#parseDefaultElement(Element ele, BeanDefinitionParserDelegate delegate)</code> 方法，执行默认解析。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">parseDefaultElement</span><span style="color:#E1E4E8;">(Element ele, BeanDefinitionParserDelegate delegate) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (delegate.</span><span style="color:#B392F0;">nodeNameEquals</span><span style="color:#E1E4E8;">(ele, IMPORT_ELEMENT)) { </span><span style="color:#6A737D;">// import</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#B392F0;">importBeanDefinitionResource</span><span style="color:#E1E4E8;">(ele);</span></span>
<span class="line"><span style="color:#E1E4E8;">	} </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (delegate.</span><span style="color:#B392F0;">nodeNameEquals</span><span style="color:#E1E4E8;">(ele, ALIAS_ELEMENT)) { </span><span style="color:#6A737D;">// alias</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#B392F0;">processAliasRegistration</span><span style="color:#E1E4E8;">(ele);</span></span>
<span class="line"><span style="color:#E1E4E8;">	} </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (delegate.</span><span style="color:#B392F0;">nodeNameEquals</span><span style="color:#E1E4E8;">(ele, BEAN_ELEMENT)) { </span><span style="color:#6A737D;">// bean</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#B392F0;">processBeanDefinition</span><span style="color:#E1E4E8;">(ele, delegate);</span></span>
<span class="line"><span style="color:#E1E4E8;">	} </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (delegate.</span><span style="color:#B392F0;">nodeNameEquals</span><span style="color:#E1E4E8;">(ele, NESTED_BEANS_ELEMENT)) { </span><span style="color:#6A737D;">// beans</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">// recurse</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#B392F0;">doRegisterBeanDefinitions</span><span style="color:#E1E4E8;">(ele);</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">parseDefaultElement</span><span style="color:#24292E;">(Element ele, BeanDefinitionParserDelegate delegate) {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (delegate.</span><span style="color:#6F42C1;">nodeNameEquals</span><span style="color:#24292E;">(ele, IMPORT_ELEMENT)) { </span><span style="color:#6A737D;">// import</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6F42C1;">importBeanDefinitionResource</span><span style="color:#24292E;">(ele);</span></span>
<span class="line"><span style="color:#24292E;">	} </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (delegate.</span><span style="color:#6F42C1;">nodeNameEquals</span><span style="color:#24292E;">(ele, ALIAS_ELEMENT)) { </span><span style="color:#6A737D;">// alias</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6F42C1;">processAliasRegistration</span><span style="color:#24292E;">(ele);</span></span>
<span class="line"><span style="color:#24292E;">	} </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (delegate.</span><span style="color:#6F42C1;">nodeNameEquals</span><span style="color:#24292E;">(ele, BEAN_ELEMENT)) { </span><span style="color:#6A737D;">// bean</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6F42C1;">processBeanDefinition</span><span style="color:#24292E;">(ele, delegate);</span></span>
<span class="line"><span style="color:#24292E;">	} </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (delegate.</span><span style="color:#6F42C1;">nodeNameEquals</span><span style="color:#24292E;">(ele, NESTED_BEANS_ELEMENT)) { </span><span style="color:#6A737D;">// beans</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;">// recurse</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6F42C1;">doRegisterBeanDefinitions</span><span style="color:#24292E;">(ele);</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p><code>&lt;2&gt;</code> 处，如果<strong>根</strong>节点或<strong>子</strong>节点<strong>不使用</strong>默认命名空间，调用 <code>BeanDefinitionParserDelegate#parseCustomElement(Element ele)</code> 方法，执行<strong>自定义</strong>解析。</p></li></ul></li></ul></li></ul><p><strong>createBeanDefinitionDocumentReader</strong></p><p><code>#createReaderContext(Resource resource)</code> 方法，创建 XmlReaderContext 对象。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> ProblemReporter problemReporter </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">FailFastProblemReporter</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> ReaderEventListener eventListener </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">EmptyReaderEventListener</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> SourceExtractor sourceExtractor </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">NullSourceExtractor</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Nullable</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> NamespaceHandlerResolver namespaceHandlerResolver;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Create the {@link XmlReaderContext} to pass over to the document reader.</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> XmlReaderContext </span><span style="color:#B392F0;">createReaderContext</span><span style="color:#E1E4E8;">(Resource resource) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">XmlReaderContext</span><span style="color:#E1E4E8;">(resource, </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.problemReporter, </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.eventListener,</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.sourceExtractor, </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">getNamespaceHandlerResolver</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> ProblemReporter problemReporter </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">FailFastProblemReporter</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> ReaderEventListener eventListener </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">EmptyReaderEventListener</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> SourceExtractor sourceExtractor </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">NullSourceExtractor</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Nullable</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> NamespaceHandlerResolver namespaceHandlerResolver;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * Create the {@link XmlReaderContext} to pass over to the document reader.</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> XmlReaderContext </span><span style="color:#6F42C1;">createReaderContext</span><span style="color:#24292E;">(Resource resource) {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">XmlReaderContext</span><span style="color:#24292E;">(resource, </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.problemReporter, </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.eventListener,</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.sourceExtractor, </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">, </span><span style="color:#6F42C1;">getNamespaceHandlerResolver</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p><code>XmlBeanDefinitionReader#doLoadBeanDefinitions(InputSource inputSource, Resource resource)</code> 方法中，做的三件事情已经全部分析完毕，下面将对 <strong>BeanDefinition 的解析过程</strong>做详细分析说明。</p><p>另外，<code>XmlBeanDefinitionReader#doLoadBeanDefinitions(InputSource inputSource, Resource resource)</code> 方法，整体时序图如下：</p><p><img src="/assets/01.bcdacc6a.jpg" alt="时序图"></p><ul><li>红框部分，就是 <strong>BeanDefinition 的解析过程</strong>。</li></ul><h3 id="beanpostprocessor" tabindex="-1">BeanPostProcessor <a class="header-anchor" href="#beanpostprocessor" aria-label="Permalink to &quot;BeanPostProcessor&quot;">​</a></h3><h4 id="beanpostprocessortest" tabindex="-1">BeanPostProcessorTest <a class="header-anchor" href="#beanpostprocessortest" aria-label="Permalink to &quot;BeanPostProcessorTest&quot;">​</a></h4><p>首先定义一个类，该类实现 BeanPostProcessor 接口，代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanPostProcessorTest</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">implements</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanPostProcessor</span><span style="color:#E1E4E8;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Object </span><span style="color:#B392F0;">postProcessBeforeInitialization</span><span style="color:#E1E4E8;">(Object </span><span style="color:#FFAB70;">bean</span><span style="color:#E1E4E8;">, String </span><span style="color:#FFAB70;">beanName</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> BeansException {</span></span>
<span class="line"><span style="color:#E1E4E8;">        System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Bean [&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> beanName </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;] 开始初始化&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 这里一定要返回 bean，不能返回 null</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> bean;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Object </span><span style="color:#B392F0;">postProcessAfterInitialization</span><span style="color:#E1E4E8;">(Object </span><span style="color:#FFAB70;">bean</span><span style="color:#E1E4E8;">, String </span><span style="color:#FFAB70;">beanName</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> BeansException {</span></span>
<span class="line"><span style="color:#E1E4E8;">        System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Bean [&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> beanName </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;] 完成初始化&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> bean;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">display</span><span style="color:#E1E4E8;">(){</span></span>
<span class="line"><span style="color:#E1E4E8;">        System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;hello BeanPostProcessor!!!&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanPostProcessorTest</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">implements</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanPostProcessor</span><span style="color:#24292E;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Object </span><span style="color:#6F42C1;">postProcessBeforeInitialization</span><span style="color:#24292E;">(Object </span><span style="color:#E36209;">bean</span><span style="color:#24292E;">, String </span><span style="color:#E36209;">beanName</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> BeansException {</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Bean [&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> beanName </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;] 开始初始化&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 这里一定要返回 bean，不能返回 null</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> bean;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Object </span><span style="color:#6F42C1;">postProcessAfterInitialization</span><span style="color:#24292E;">(Object </span><span style="color:#E36209;">bean</span><span style="color:#24292E;">, String </span><span style="color:#E36209;">beanName</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> BeansException {</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Bean [&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> beanName </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;] 完成初始化&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> bean;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">display</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;hello BeanPostProcessor!!!&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>测试方法如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ClassPathResource resource </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ClassPathResource</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;spring.xml&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">DefaultListableBeanFactory factory </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">DefaultListableBeanFactory</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">XmlBeanDefinitionReader reader </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">XmlBeanDefinitionReader</span><span style="color:#E1E4E8;">(factory);</span></span>
<span class="line"><span style="color:#E1E4E8;">reader.</span><span style="color:#B392F0;">loadBeanDefinitions</span><span style="color:#E1E4E8;">(resource);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">BeanPostProcessorTest test </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (BeanPostProcessorTest) factory.</span><span style="color:#B392F0;">getBean</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;beanPostProcessorTest&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">test.</span><span style="color:#B392F0;">display</span><span style="color:#E1E4E8;">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ClassPathResource resource </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ClassPathResource</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;spring.xml&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">DefaultListableBeanFactory factory </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DefaultListableBeanFactory</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">XmlBeanDefinitionReader reader </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">XmlBeanDefinitionReader</span><span style="color:#24292E;">(factory);</span></span>
<span class="line"><span style="color:#24292E;">reader.</span><span style="color:#6F42C1;">loadBeanDefinitions</span><span style="color:#24292E;">(resource);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">BeanPostProcessorTest test </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (BeanPostProcessorTest) factory.</span><span style="color:#6F42C1;">getBean</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;beanPostProcessorTest&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">test.</span><span style="color:#6F42C1;">display</span><span style="color:#24292E;">();</span></span></code></pre></div><p>debug 跟踪下代码，这两个方法在 AbstractAutowireCapableBeanFactory 的 <code>#initializeBean(final String beanName, final Object bean, RootBeanDefinition mbd)</code> 方法处调用下，如下：</p><p><img src="/assets/image-20220512223159371.e421e450.png" alt="image-20220512223159371"></p><p><code>#getBeanPostProcessors()</code> 方法，该方法定义如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/** BeanPostProcessors to apply in createBean. */</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> List&lt;</span><span style="color:#F97583;">BeanPostProcessor</span><span style="color:#E1E4E8;">&gt; beanPostProcessors </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> CopyOnWriteArrayList&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> List</span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">BeanPostProcessor</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getBeanPostProcessors</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.beanPostProcessors;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/** BeanPostProcessors to apply in createBean. */</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> List&lt;</span><span style="color:#D73A49;">BeanPostProcessor</span><span style="color:#24292E;">&gt; beanPostProcessors </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> CopyOnWriteArrayList&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> List</span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">BeanPostProcessor</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getBeanPostProcessors</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.beanPostProcessors;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li><p>返回的 <code>beanPostProcessors</code> 是一个 <code>private</code> 的 List ，也就是说只要该类中存在 <code>beanPostProcessors.add(BeanPostProcessor beanPostProcessor)</code> 的调用，我们就找到了入口，在类 AbstractBeanFactory 中找到了如下代码：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">addBeanPostProcessor</span><span style="color:#E1E4E8;">(BeanPostProcessor beanPostProcessor) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	Assert.</span><span style="color:#B392F0;">notNull</span><span style="color:#E1E4E8;">(beanPostProcessor, </span><span style="color:#9ECBFF;">&quot;BeanPostProcessor must not be null&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// Remove from old position, if any</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.beanPostProcessors.</span><span style="color:#B392F0;">remove</span><span style="color:#E1E4E8;">(beanPostProcessor);</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// Track whether it is instantiation/destruction aware</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (beanPostProcessor </span><span style="color:#F97583;">instanceof</span><span style="color:#E1E4E8;"> InstantiationAwareBeanPostProcessor) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.hasInstantiationAwareBeanPostProcessors </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (beanPostProcessor </span><span style="color:#F97583;">instanceof</span><span style="color:#E1E4E8;"> DestructionAwareBeanPostProcessor) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.hasDestructionAwareBeanPostProcessors </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// Add to end of list</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.beanPostProcessors.</span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(beanPostProcessor);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">addBeanPostProcessor</span><span style="color:#24292E;">(BeanPostProcessor beanPostProcessor) {</span></span>
<span class="line"><span style="color:#24292E;">	Assert.</span><span style="color:#6F42C1;">notNull</span><span style="color:#24292E;">(beanPostProcessor, </span><span style="color:#032F62;">&quot;BeanPostProcessor must not be null&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// Remove from old position, if any</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.beanPostProcessors.</span><span style="color:#6F42C1;">remove</span><span style="color:#24292E;">(beanPostProcessor);</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// Track whether it is instantiation/destruction aware</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (beanPostProcessor </span><span style="color:#D73A49;">instanceof</span><span style="color:#24292E;"> InstantiationAwareBeanPostProcessor) {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.hasInstantiationAwareBeanPostProcessors </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (beanPostProcessor </span><span style="color:#D73A49;">instanceof</span><span style="color:#24292E;"> DestructionAwareBeanPostProcessor) {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.hasDestructionAwareBeanPostProcessors </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// Add to end of list</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.beanPostProcessors.</span><span style="color:#6F42C1;">add</span><span style="color:#24292E;">(beanPostProcessor);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li>该方法是由 AbstractBeanFactory 的父类 <code>org.springframework.beans.factory.config.ConfigurableBeanFactory</code> 接口定义，它的核心意思就是将指定 BeanPostProcessor 注册到该 BeanFactory 创建的 bean 中，同时它是<strong>按照插入的顺序进行注册的</strong>，完全忽略 Ordered 接口所表达任何排序语义</li></ul></li></ul><p><code>#getBeanPostProcessors()</code> 方法，返回的是 <code>beanPostProcessors</code> 集合，该集合里面存放就是我们自定义的 BeanPostProcessor ，如果该集合中存在元素则调用相应的方法，否则就直接返回 bean 了。这也是为什么使用 BeanFactory 容器是无法输出自定义 BeanPostProcessor 里面的内容，因为在 <code>BeanFactory#getBean(...)</code> 方法的过程中根本就没有将我们自定义的 BeanPostProcessor 注入进来，所以要想 BeanFactory 容器 的 BeanPostProcessor 生效我们必须手动调用 <code>#addBeanPostProcessor(BeanPostProcessor beanPostProcessor)</code> 方法，将定义的 BeanPostProcessor 注册到相应的 BeanFactory 中</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">BeanPostProcessorTest beanPostProcessorTest </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanPostProcessorTest</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">factory.</span><span style="color:#B392F0;">addBeanPostProcessor</span><span style="color:#E1E4E8;">(beanPostProcessorTest);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">BeanPostProcessorTest beanPostProcessorTest </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanPostProcessorTest</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">factory.</span><span style="color:#6F42C1;">addBeanPostProcessor</span><span style="color:#24292E;">(beanPostProcessorTest);</span></span></code></pre></div><p>一般普通的 BeanFactory 是不支持自动注册 BeanPostProcessor 的，需要我们手动调用 <code>#addBeanPostProcessor(BeanPostProcessor beanPostProcessor)</code> 方法进行注册。注册后的 BeanPostProcessor 适用于所有该 BeanFactory 创建的 bean，但是 <strong>ApplicationContext 可以在其 bean 定义中自动检测所有的 BeanPostProcessor 并自动完成注册，同时将他们应用到随后创建的任何 Bean 中</strong>。</p><h4 id="applicationcontext-beanpostprocessor" tabindex="-1">ApplicationContext.BeanPostProcessor <a class="header-anchor" href="#applicationcontext-beanpostprocessor" aria-label="Permalink to &quot;ApplicationContext.BeanPostProcessor&quot;">​</a></h4><p><strong>自动检测并注册机制</strong></p><p>ApplicationContext 实现自动注册的原因，在于我们构造一个 ApplicationContext 实例对象的时候会调用 <code>#registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory)</code> 方法，将检测到的 BeanPostProcessor 注入到 ApplicationContext 容器中，同时应用到该容器创建的 bean 中。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractApplicationContext.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 实例化并调用已经注入的 BeanPostProcessor</span></span>
<span class="line"><span style="color:#6A737D;"> * 必须在应用中 bean 实例化之前调用</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">registerBeanPostProcessors</span><span style="color:#E1E4E8;">(ConfigurableListableBeanFactory beanFactory) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    PostProcessorRegistrationDelegate.</span><span style="color:#B392F0;">registerBeanPostProcessors</span><span style="color:#E1E4E8;">(beanFactory, </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// PostProcessorRegistrationDelegate.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">registerBeanPostProcessors</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">		ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 获取所有的 BeanPostProcessor 的 beanName</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 这些 beanName 都已经全部加载到容器中去，但是没有实例化</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] postProcessorNames </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> beanFactory.</span><span style="color:#B392F0;">getBeanNamesForType</span><span style="color:#E1E4E8;">(BeanPostProcessor.class, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// Register BeanPostProcessorChecker that logs an info message when</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// a bean is created during BeanPostProcessor instantiation, i.e. when</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// a bean is not eligible for getting processed by all BeanPostProcessors.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 记录所有的beanProcessor数量</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> beanProcessorTargetCount </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> beanFactory.</span><span style="color:#B392F0;">getBeanPostProcessorCount</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> postProcessorNames.length;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// 注册 BeanPostProcessorChecker，它主要是用于在 BeanPostProcessor 实例化期间记录日志</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 当 Spring 中高配置的后置处理器还没有注册就已经开始了 bean 的实例化过程，这个时候便会打印 BeanPostProcessorChecker 中的内容</span></span>
<span class="line"><span style="color:#E1E4E8;">	beanFactory.</span><span style="color:#B392F0;">addBeanPostProcessor</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BeanPostProcessorChecker</span><span style="color:#E1E4E8;">(beanFactory, beanProcessorTargetCount));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// Separate between BeanPostProcessors that implement PriorityOrdered,</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// Ordered, and the rest.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// PriorityOrdered 保证顺序</span></span>
<span class="line"><span style="color:#E1E4E8;">	List&lt;</span><span style="color:#F97583;">BeanPostProcessor</span><span style="color:#E1E4E8;">&gt; priorityOrderedPostProcessors </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// MergedBeanDefinitionPostProcessor</span></span>
<span class="line"><span style="color:#E1E4E8;">	List&lt;</span><span style="color:#F97583;">BeanPostProcessor</span><span style="color:#E1E4E8;">&gt; internalPostProcessors </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 使用 Ordered 保证顺序</span></span>
<span class="line"><span style="color:#E1E4E8;">	List&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; orderedPostProcessorNames </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 没有顺序</span></span>
<span class="line"><span style="color:#E1E4E8;">	List&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; nonOrderedPostProcessorNames </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (String ppName </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> postProcessorNames) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// PriorityOrdered</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (beanFactory.</span><span style="color:#B392F0;">isTypeMatch</span><span style="color:#E1E4E8;">(ppName, PriorityOrdered.class)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 调用 getBean 获取 bean 实例对象</span></span>
<span class="line"><span style="color:#E1E4E8;">			BeanPostProcessor pp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> beanFactory.</span><span style="color:#B392F0;">getBean</span><span style="color:#E1E4E8;">(ppName, BeanPostProcessor.class);</span></span>
<span class="line"><span style="color:#E1E4E8;">			priorityOrderedPostProcessors.</span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(pp);</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (pp </span><span style="color:#F97583;">instanceof</span><span style="color:#E1E4E8;"> MergedBeanDefinitionPostProcessor) {</span></span>
<span class="line"><span style="color:#E1E4E8;">				internalPostProcessors.</span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(pp);</span></span>
<span class="line"><span style="color:#E1E4E8;">			}</span></span>
<span class="line"><span style="color:#E1E4E8;">		} </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (beanFactory.</span><span style="color:#B392F0;">isTypeMatch</span><span style="color:#E1E4E8;">(ppName, Ordered.class)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 有序 Ordered</span></span>
<span class="line"><span style="color:#E1E4E8;">			orderedPostProcessorNames.</span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(ppName);</span></span>
<span class="line"><span style="color:#E1E4E8;">		} </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 无序</span></span>
<span class="line"><span style="color:#E1E4E8;">			nonOrderedPostProcessorNames.</span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(ppName);</span></span>
<span class="line"><span style="color:#E1E4E8;">		}</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// First, register the BeanPostProcessors that implement PriorityOrdered.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 第一步，注册所有实现了 PriorityOrdered 的 BeanPostProcessor</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 先排序</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">sortPostProcessors</span><span style="color:#E1E4E8;">(priorityOrderedPostProcessors, beanFactory);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 后注册</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">registerBeanPostProcessors</span><span style="color:#E1E4E8;">(beanFactory, priorityOrderedPostProcessors);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// Next, register the BeanPostProcessors that implement Ordered.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 第二步，注册所有实现了 Ordered 的 BeanPostProcessor</span></span>
<span class="line"><span style="color:#E1E4E8;">	List&lt;</span><span style="color:#F97583;">BeanPostProcessor</span><span style="color:#E1E4E8;">&gt; orderedPostProcessors </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (String ppName </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> orderedPostProcessorNames) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		BeanPostProcessor pp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> beanFactory.</span><span style="color:#B392F0;">getBean</span><span style="color:#E1E4E8;">(ppName, BeanPostProcessor.class);</span></span>
<span class="line"><span style="color:#E1E4E8;">		orderedPostProcessors.</span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(pp);</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (pp </span><span style="color:#F97583;">instanceof</span><span style="color:#E1E4E8;"> MergedBeanDefinitionPostProcessor) {</span></span>
<span class="line"><span style="color:#E1E4E8;">			internalPostProcessors.</span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(pp);</span></span>
<span class="line"><span style="color:#E1E4E8;">		}</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 先排序</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">sortPostProcessors</span><span style="color:#E1E4E8;">(orderedPostProcessors, beanFactory);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 后注册</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">registerBeanPostProcessors</span><span style="color:#E1E4E8;">(beanFactory, orderedPostProcessors);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// Now, register all regular BeanPostProcessors.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 第三步注册所有无序的 BeanPostProcessor</span></span>
<span class="line"><span style="color:#E1E4E8;">	List&lt;</span><span style="color:#F97583;">BeanPostProcessor</span><span style="color:#E1E4E8;">&gt; nonOrderedPostProcessors </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (String ppName </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> nonOrderedPostProcessorNames) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		BeanPostProcessor pp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> beanFactory.</span><span style="color:#B392F0;">getBean</span><span style="color:#E1E4E8;">(ppName, BeanPostProcessor.class);</span></span>
<span class="line"><span style="color:#E1E4E8;">		nonOrderedPostProcessors.</span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(pp);</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (pp </span><span style="color:#F97583;">instanceof</span><span style="color:#E1E4E8;"> MergedBeanDefinitionPostProcessor) {</span></span>
<span class="line"><span style="color:#E1E4E8;">			internalPostProcessors.</span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(pp);</span></span>
<span class="line"><span style="color:#E1E4E8;">		}</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// 注册，无需排序</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">registerBeanPostProcessors</span><span style="color:#E1E4E8;">(beanFactory, nonOrderedPostProcessors);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// Finally, re-register all internal BeanPostProcessors.</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 最后，注册所有的 MergedBeanDefinitionPostProcessor 类型的 BeanPostProcessor</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">sortPostProcessors</span><span style="color:#E1E4E8;">(internalPostProcessors, beanFactory);</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">registerBeanPostProcessors</span><span style="color:#E1E4E8;">(beanFactory, internalPostProcessors);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// Re-register post-processor for detecting inner beans as ApplicationListeners,</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// moving it to the end of the processor chain (for picking up proxies etc).</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 加入ApplicationListenerDetector（探测器）</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 重新注册 BeanPostProcessor 以检测内部 bean，因为 ApplicationListeners 将其移动到处理器链的末尾</span></span>
<span class="line"><span style="color:#E1E4E8;">	beanFactory.</span><span style="color:#B392F0;">addBeanPostProcessor</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ApplicationListenerDetector</span><span style="color:#E1E4E8;">(applicationContext));</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractApplicationContext.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * 实例化并调用已经注入的 BeanPostProcessor</span></span>
<span class="line"><span style="color:#6A737D;"> * 必须在应用中 bean 实例化之前调用</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">registerBeanPostProcessors</span><span style="color:#24292E;">(ConfigurableListableBeanFactory beanFactory) {</span></span>
<span class="line"><span style="color:#24292E;">    PostProcessorRegistrationDelegate.</span><span style="color:#6F42C1;">registerBeanPostProcessors</span><span style="color:#24292E;">(beanFactory, </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// PostProcessorRegistrationDelegate.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">registerBeanPostProcessors</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">		ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 获取所有的 BeanPostProcessor 的 beanName</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 这些 beanName 都已经全部加载到容器中去，但是没有实例化</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] postProcessorNames </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> beanFactory.</span><span style="color:#6F42C1;">getBeanNamesForType</span><span style="color:#24292E;">(BeanPostProcessor.class, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// Register BeanPostProcessorChecker that logs an info message when</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// a bean is created during BeanPostProcessor instantiation, i.e. when</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// a bean is not eligible for getting processed by all BeanPostProcessors.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 记录所有的beanProcessor数量</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> beanProcessorTargetCount </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> beanFactory.</span><span style="color:#6F42C1;">getBeanPostProcessorCount</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> postProcessorNames.length;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// 注册 BeanPostProcessorChecker，它主要是用于在 BeanPostProcessor 实例化期间记录日志</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 当 Spring 中高配置的后置处理器还没有注册就已经开始了 bean 的实例化过程，这个时候便会打印 BeanPostProcessorChecker 中的内容</span></span>
<span class="line"><span style="color:#24292E;">	beanFactory.</span><span style="color:#6F42C1;">addBeanPostProcessor</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BeanPostProcessorChecker</span><span style="color:#24292E;">(beanFactory, beanProcessorTargetCount));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// Separate between BeanPostProcessors that implement PriorityOrdered,</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// Ordered, and the rest.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// PriorityOrdered 保证顺序</span></span>
<span class="line"><span style="color:#24292E;">	List&lt;</span><span style="color:#D73A49;">BeanPostProcessor</span><span style="color:#24292E;">&gt; priorityOrderedPostProcessors </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// MergedBeanDefinitionPostProcessor</span></span>
<span class="line"><span style="color:#24292E;">	List&lt;</span><span style="color:#D73A49;">BeanPostProcessor</span><span style="color:#24292E;">&gt; internalPostProcessors </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 使用 Ordered 保证顺序</span></span>
<span class="line"><span style="color:#24292E;">	List&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; orderedPostProcessorNames </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 没有顺序</span></span>
<span class="line"><span style="color:#24292E;">	List&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; nonOrderedPostProcessorNames </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (String ppName </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> postProcessorNames) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// PriorityOrdered</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (beanFactory.</span><span style="color:#6F42C1;">isTypeMatch</span><span style="color:#24292E;">(ppName, PriorityOrdered.class)) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 调用 getBean 获取 bean 实例对象</span></span>
<span class="line"><span style="color:#24292E;">			BeanPostProcessor pp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> beanFactory.</span><span style="color:#6F42C1;">getBean</span><span style="color:#24292E;">(ppName, BeanPostProcessor.class);</span></span>
<span class="line"><span style="color:#24292E;">			priorityOrderedPostProcessors.</span><span style="color:#6F42C1;">add</span><span style="color:#24292E;">(pp);</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (pp </span><span style="color:#D73A49;">instanceof</span><span style="color:#24292E;"> MergedBeanDefinitionPostProcessor) {</span></span>
<span class="line"><span style="color:#24292E;">				internalPostProcessors.</span><span style="color:#6F42C1;">add</span><span style="color:#24292E;">(pp);</span></span>
<span class="line"><span style="color:#24292E;">			}</span></span>
<span class="line"><span style="color:#24292E;">		} </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (beanFactory.</span><span style="color:#6F42C1;">isTypeMatch</span><span style="color:#24292E;">(ppName, Ordered.class)) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 有序 Ordered</span></span>
<span class="line"><span style="color:#24292E;">			orderedPostProcessorNames.</span><span style="color:#6F42C1;">add</span><span style="color:#24292E;">(ppName);</span></span>
<span class="line"><span style="color:#24292E;">		} </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 无序</span></span>
<span class="line"><span style="color:#24292E;">			nonOrderedPostProcessorNames.</span><span style="color:#6F42C1;">add</span><span style="color:#24292E;">(ppName);</span></span>
<span class="line"><span style="color:#24292E;">		}</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// First, register the BeanPostProcessors that implement PriorityOrdered.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 第一步，注册所有实现了 PriorityOrdered 的 BeanPostProcessor</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 先排序</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">sortPostProcessors</span><span style="color:#24292E;">(priorityOrderedPostProcessors, beanFactory);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 后注册</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">registerBeanPostProcessors</span><span style="color:#24292E;">(beanFactory, priorityOrderedPostProcessors);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// Next, register the BeanPostProcessors that implement Ordered.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 第二步，注册所有实现了 Ordered 的 BeanPostProcessor</span></span>
<span class="line"><span style="color:#24292E;">	List&lt;</span><span style="color:#D73A49;">BeanPostProcessor</span><span style="color:#24292E;">&gt; orderedPostProcessors </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (String ppName </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> orderedPostProcessorNames) {</span></span>
<span class="line"><span style="color:#24292E;">		BeanPostProcessor pp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> beanFactory.</span><span style="color:#6F42C1;">getBean</span><span style="color:#24292E;">(ppName, BeanPostProcessor.class);</span></span>
<span class="line"><span style="color:#24292E;">		orderedPostProcessors.</span><span style="color:#6F42C1;">add</span><span style="color:#24292E;">(pp);</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (pp </span><span style="color:#D73A49;">instanceof</span><span style="color:#24292E;"> MergedBeanDefinitionPostProcessor) {</span></span>
<span class="line"><span style="color:#24292E;">			internalPostProcessors.</span><span style="color:#6F42C1;">add</span><span style="color:#24292E;">(pp);</span></span>
<span class="line"><span style="color:#24292E;">		}</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 先排序</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">sortPostProcessors</span><span style="color:#24292E;">(orderedPostProcessors, beanFactory);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 后注册</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">registerBeanPostProcessors</span><span style="color:#24292E;">(beanFactory, orderedPostProcessors);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// Now, register all regular BeanPostProcessors.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 第三步注册所有无序的 BeanPostProcessor</span></span>
<span class="line"><span style="color:#24292E;">	List&lt;</span><span style="color:#D73A49;">BeanPostProcessor</span><span style="color:#24292E;">&gt; nonOrderedPostProcessors </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (String ppName </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> nonOrderedPostProcessorNames) {</span></span>
<span class="line"><span style="color:#24292E;">		BeanPostProcessor pp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> beanFactory.</span><span style="color:#6F42C1;">getBean</span><span style="color:#24292E;">(ppName, BeanPostProcessor.class);</span></span>
<span class="line"><span style="color:#24292E;">		nonOrderedPostProcessors.</span><span style="color:#6F42C1;">add</span><span style="color:#24292E;">(pp);</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (pp </span><span style="color:#D73A49;">instanceof</span><span style="color:#24292E;"> MergedBeanDefinitionPostProcessor) {</span></span>
<span class="line"><span style="color:#24292E;">			internalPostProcessors.</span><span style="color:#6F42C1;">add</span><span style="color:#24292E;">(pp);</span></span>
<span class="line"><span style="color:#24292E;">		}</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// 注册，无需排序</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">registerBeanPostProcessors</span><span style="color:#24292E;">(beanFactory, nonOrderedPostProcessors);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// Finally, re-register all internal BeanPostProcessors.</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 最后，注册所有的 MergedBeanDefinitionPostProcessor 类型的 BeanPostProcessor</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">sortPostProcessors</span><span style="color:#24292E;">(internalPostProcessors, beanFactory);</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">registerBeanPostProcessors</span><span style="color:#24292E;">(beanFactory, internalPostProcessors);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// Re-register post-processor for detecting inner beans as ApplicationListeners,</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// moving it to the end of the processor chain (for picking up proxies etc).</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 加入ApplicationListenerDetector（探测器）</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 重新注册 BeanPostProcessor 以检测内部 bean，因为 ApplicationListeners 将其移动到处理器链的末尾</span></span>
<span class="line"><span style="color:#24292E;">	beanFactory.</span><span style="color:#6F42C1;">addBeanPostProcessor</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ApplicationListenerDetector</span><span style="color:#24292E;">(applicationContext));</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li><p>方法首先 <code>beanFactory</code> 获取注册到该 BeanFactory 中所有 BeanPostProcessor 类型的 <code>beanName</code> 数组，其实就是找所有实现了 BeanPostProcessor 接口的 bean ，然后迭代这些 bean ，将其按照 PriorityOrdered、Ordered、无序的顺序，添加至相应的 List 集合中，最后依次调用 <code>#sortPostProcessors(List&lt;?&gt; postProcessors, ConfigurableListableBeanFactory beanFactory)</code> 方法来进行排序处理、 <code>#registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory, List&lt;BeanPostProcessor&gt; postProcessors)</code> 方法来完成注册。</p></li><li><p>【<strong>排序</strong>】很简单，如果 <code>beanFactory</code> 为 DefaultListableBeanFactory ，则返回 BeanFactory 所依赖的比较器，否则反正默认的比较器(OrderComparator)，然后调用 <code>List#sort(Comparator&lt;? super E&gt; c)</code> 方法即可。</p></li><li><p>【<strong>注册</strong>】，同样是调用 <code>AbstractBeanFactory#addBeanPostProcessor(BeanPostProcessor beanPostProcessor)</code> 方法完成注册。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// PostProcessorRegistrationDelegate.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">registerBeanPostProcessors</span><span style="color:#E1E4E8;">(ConfigurableListableBeanFactory beanFactory, List</span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">BeanPostProcessor</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> postProcessors) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 遍历 BeanPostProcessor 数组，注册</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (BeanPostProcessor postProcessor </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> postProcessors) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		beanFactory.</span><span style="color:#B392F0;">addBeanPostProcessor</span><span style="color:#E1E4E8;">(postProcessor);</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// PostProcessorRegistrationDelegate.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">registerBeanPostProcessors</span><span style="color:#24292E;">(ConfigurableListableBeanFactory beanFactory, List</span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">BeanPostProcessor</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> postProcessors) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 遍历 BeanPostProcessor 数组，注册</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (BeanPostProcessor postProcessor </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> postProcessors) {</span></span>
<span class="line"><span style="color:#24292E;">		beanFactory.</span><span style="color:#6F42C1;">addBeanPostProcessor</span><span style="color:#24292E;">(postProcessor);</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div></li></ul><h3 id="initializingbean" tabindex="-1">InitializingBean <a class="header-anchor" href="#initializingbean" aria-label="Permalink to &quot;InitializingBean&quot;">​</a></h3><p>Spring 的 <code>org.springframework.beans.factory.InitializingBean</code> 接口，为 bean 提供了定义初始化方法的方式，它仅包含了一个方法：<code>#afterPropertiesSet()</code> 。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">InitializingBean</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">afterPropertiesSet</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> Exception;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">interface</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">InitializingBean</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">afterPropertiesSet</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>Spring 在完成实例化后，设置完所有属性，进行 “Aware 接口” 和 “BeanPostProcessor 前置处理”之后，会接着检测当前 bean 对象是否实现了 InitializingBean 接口。如果是，则会调用其 <code>#afterPropertiesSet()</code> 方法，进一步调整 bean 实例对象的状态。</p><h4 id="initializingbeantest" tabindex="-1">InitializingBeanTest <a class="header-anchor" href="#initializingbeantest" aria-label="Permalink to &quot;InitializingBeanTest&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">InitializingBeanTest</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">implements</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">InitializingBean</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> String name;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">afterPropertiesSet</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> Exception {</span></span>
<span class="line"><span style="color:#E1E4E8;">        System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;InitializingBeanTest initializing...&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;chenssy 2 号&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> String </span><span style="color:#B392F0;">getName</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> name;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">setName</span><span style="color:#E1E4E8;">(String </span><span style="color:#FFAB70;">name</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> name;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">InitializingBeanTest</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">implements</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">InitializingBean</span><span style="color:#24292E;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> String name;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">afterPropertiesSet</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;InitializingBeanTest initializing...&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;chenssy 2 号&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> String </span><span style="color:#6F42C1;">getName</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> name;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">setName</span><span style="color:#24292E;">(String </span><span style="color:#E36209;">name</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> name;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">&lt;</span><span style="color:#85E89D;">bean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">id</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;initializingBeanTest&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">class</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;org.springframework.core.test.InitializingBeanTest&quot;</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">property</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">name</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;name&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">value</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;chenssy 1 号&quot;</span><span style="color:#E1E4E8;">/&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">&lt;/</span><span style="color:#85E89D;">bean</span><span style="color:#E1E4E8;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">&lt;</span><span style="color:#22863A;">bean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">id</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;initializingBeanTest&quot;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">class</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;org.springframework.core.test.InitializingBeanTest&quot;</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">property</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">name</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;name&quot;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">value</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;chenssy 1 号&quot;</span><span style="color:#24292E;">/&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;/</span><span style="color:#22863A;">bean</span><span style="color:#24292E;">&gt;</span></span></code></pre></div><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">InitializingBeanTest test </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (InitializingBeanTest) factory.</span><span style="color:#B392F0;">getBean</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;initializingBeanTest&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;name ：&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> test.</span><span style="color:#B392F0;">getName</span><span style="color:#E1E4E8;">());</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">InitializingBeanTest test </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (InitializingBeanTest) factory.</span><span style="color:#6F42C1;">getBean</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;initializingBeanTest&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;name ：&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> test.</span><span style="color:#6F42C1;">getName</span><span style="color:#24292E;">());</span></span></code></pre></div><p><img src="/assets/image-20230204211713576.c87a2735.png" alt="image-20230204211713576"></p><p>在这个示例中，改变了 InitializingBeanTest 示例的 <code>name</code> 属性，也就是说 在 <code>#afterPropertiesSet()</code> 方法中，我们是可以改变 bean 的属性的，这相当于 Spring 容器又给我们提供了一种可以改变 bean 实例对象的方法</p><h4 id="invokeinitmethods" tabindex="-1">invokeInitMethods(...) <a class="header-anchor" href="#invokeinitmethods" aria-label="Permalink to &quot;invokeInitMethods(...)&quot;">​</a></h4><p>bean 初始化阶段（ <code>#initializeBean(final String beanName, final Object bean, RootBeanDefinition mbd)</code> 方法）， Spring 容器会主动检查当前 bean 是否已经实现了 InitializingBean 接口，如果实现了，则会调用其 <code>#afterPropertiesSet()</code> 方法。这个主动检查、调用的动作是由 <code>#invokeInitMethods(String beanName, final Object bean, @Nullable RootBeanDefinition mbd)</code> 方法来完成的。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">invokeInitMethods</span><span style="color:#E1E4E8;">(String beanName, </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Object bean, @</span><span style="color:#F97583;">Nullable</span><span style="color:#E1E4E8;"> RootBeanDefinition mbd)</span></span>
<span class="line"><span style="color:#E1E4E8;">        throws Throwable {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 首先会检查是否是 InitializingBean ，如果是的话需要调用 afterPropertiesSet()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> isInitializingBean </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (bean </span><span style="color:#F97583;">instanceof</span><span style="color:#E1E4E8;"> InitializingBean);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (isInitializingBean </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> (mbd </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">mbd.</span><span style="color:#B392F0;">isExternallyManagedInitMethod</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;afterPropertiesSet&quot;</span><span style="color:#E1E4E8;">))) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (logger.</span><span style="color:#B392F0;">isTraceEnabled</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            logger.</span><span style="color:#B392F0;">trace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Invoking afterPropertiesSet() on bean with name &#39;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> beanName </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&#39;&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (System.</span><span style="color:#B392F0;">getSecurityManager</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// 安全模式</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                AccessController.</span><span style="color:#B392F0;">doPrivileged</span><span style="color:#E1E4E8;">((PrivilegedExceptionAction</span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">Object</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">) () </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">// 属性初始化的处理</span></span>
<span class="line"><span style="color:#E1E4E8;">                    ((InitializingBean) bean).</span><span style="color:#B392F0;">afterPropertiesSet</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                }, </span><span style="color:#B392F0;">getAccessControlContext</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">            } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (PrivilegedActionException </span><span style="color:#FFAB70;">pae</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> pae.</span><span style="color:#B392F0;">getException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 属性初始化的处理</span></span>
<span class="line"><span style="color:#E1E4E8;">            ((InitializingBean) bean).</span><span style="color:#B392F0;">afterPropertiesSet</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (mbd </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> bean.</span><span style="color:#B392F0;">getClass</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> NullBean.class) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 判断是否指定了 init-method()，</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 如果指定了 init-method()，则再调用制定的init-method</span></span>
<span class="line"><span style="color:#E1E4E8;">        String initMethodName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> mbd.</span><span style="color:#B392F0;">getInitMethodName</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (StringUtils.</span><span style="color:#B392F0;">hasLength</span><span style="color:#E1E4E8;">(initMethodName) </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">(isInitializingBean </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;afterPropertiesSet&quot;</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">equals</span><span style="color:#E1E4E8;">(initMethodName)) </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">mbd.</span><span style="color:#B392F0;">isExternallyManagedInitMethod</span><span style="color:#E1E4E8;">(initMethodName)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 激活用户自定义的初始化方法</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 利用反射机制执行</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">invokeCustomInitMethod</span><span style="color:#E1E4E8;">(beanName, bean, mbd);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// AbstractAutowireCapableBeanFactory.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">invokeInitMethods</span><span style="color:#24292E;">(String beanName, </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Object bean, @</span><span style="color:#D73A49;">Nullable</span><span style="color:#24292E;"> RootBeanDefinition mbd)</span></span>
<span class="line"><span style="color:#24292E;">        throws Throwable {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 首先会检查是否是 InitializingBean ，如果是的话需要调用 afterPropertiesSet()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> isInitializingBean </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (bean </span><span style="color:#D73A49;">instanceof</span><span style="color:#24292E;"> InitializingBean);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (isInitializingBean </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> (mbd </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!</span><span style="color:#24292E;">mbd.</span><span style="color:#6F42C1;">isExternallyManagedInitMethod</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;afterPropertiesSet&quot;</span><span style="color:#24292E;">))) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (logger.</span><span style="color:#6F42C1;">isTraceEnabled</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">            logger.</span><span style="color:#6F42C1;">trace</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Invoking afterPropertiesSet() on bean with name &#39;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> beanName </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&#39;&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (System.</span><span style="color:#6F42C1;">getSecurityManager</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// 安全模式</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                AccessController.</span><span style="color:#6F42C1;">doPrivileged</span><span style="color:#24292E;">((PrivilegedExceptionAction</span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">Object</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">) () </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">// 属性初始化的处理</span></span>
<span class="line"><span style="color:#24292E;">                    ((InitializingBean) bean).</span><span style="color:#6F42C1;">afterPropertiesSet</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                }, </span><span style="color:#6F42C1;">getAccessControlContext</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (PrivilegedActionException </span><span style="color:#E36209;">pae</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> pae.</span><span style="color:#6F42C1;">getException</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 属性初始化的处理</span></span>
<span class="line"><span style="color:#24292E;">            ((InitializingBean) bean).</span><span style="color:#6F42C1;">afterPropertiesSet</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (mbd </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> bean.</span><span style="color:#6F42C1;">getClass</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> NullBean.class) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 判断是否指定了 init-method()，</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 如果指定了 init-method()，则再调用制定的init-method</span></span>
<span class="line"><span style="color:#24292E;">        String initMethodName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> mbd.</span><span style="color:#6F42C1;">getInitMethodName</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (StringUtils.</span><span style="color:#6F42C1;">hasLength</span><span style="color:#24292E;">(initMethodName) </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">!</span><span style="color:#24292E;">(isInitializingBean </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;afterPropertiesSet&quot;</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">equals</span><span style="color:#24292E;">(initMethodName)) </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">!</span><span style="color:#24292E;">mbd.</span><span style="color:#6F42C1;">isExternallyManagedInitMethod</span><span style="color:#24292E;">(initMethodName)) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 激活用户自定义的初始化方法</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 利用反射机制执行</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">invokeCustomInitMethod</span><span style="color:#24292E;">(beanName, bean, mbd);</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li>首先检测当前 bean 是否实现了 InitializingBean 接口，如果实现则调用其 <code>#afterPropertiesSet()</code> 方法。</li><li>然后再检查是否也指定了 <code>init-method</code>，如果指定了则通过反射机制调用指定的 <code>init-method</code> 方法。</li></ul><h4 id="init-method" tabindex="-1">init-method <a class="header-anchor" href="#init-method" aria-label="Permalink to &quot;init-method&quot;">​</a></h4><p><code>init-method</code> 属性用于在 bean 初始化时指定执行方法，可以用来替代实现 InitializingBean 接口</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">InitializingBeanTest</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> String name;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> String </span><span style="color:#B392F0;">getName</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> name;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">setName</span><span style="color:#E1E4E8;">(String </span><span style="color:#FFAB70;">name</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> name;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">setOtherName</span><span style="color:#E1E4E8;">(){</span></span>
<span class="line"><span style="color:#E1E4E8;">        System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;InitializingBeanTest setOtherName...&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;chenssy 3 号&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">InitializingBeanTest</span><span style="color:#24292E;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> String name;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> String </span><span style="color:#6F42C1;">getName</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> name;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">setName</span><span style="color:#24292E;">(String </span><span style="color:#E36209;">name</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> name;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">setOtherName</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;InitializingBeanTest setOtherName...&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">.name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;chenssy 3 号&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">&lt;</span><span style="color:#85E89D;">bean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">id</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;initializingBeanTest&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">class</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;org.springframework.core.test.InitializingBeanTest&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">init-method</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;setOtherName&quot;</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">property</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">name</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;name&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">value</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;chenssy 1 号&quot;</span><span style="color:#E1E4E8;">/&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">&lt;/</span><span style="color:#85E89D;">bean</span><span style="color:#E1E4E8;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">&lt;</span><span style="color:#22863A;">bean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">id</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;initializingBeanTest&quot;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">class</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;org.springframework.core.test.InitializingBeanTest&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">init-method</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;setOtherName&quot;</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    &lt;</span><span style="color:#22863A;">property</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">name</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;name&quot;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">value</span><span style="color:#24292E;">=</span><span style="color:#032F62;">&quot;chenssy 1 号&quot;</span><span style="color:#24292E;">/&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;/</span><span style="color:#22863A;">bean</span><span style="color:#24292E;">&gt;</span></span></code></pre></div><p><img src="/assets/image-20230204212437630.cf0f1993.png" alt="image-20230204212437630"></p><p>达到和 InitializingBean 一样的效果，而且在代码中我们没有看到丝毫 Spring 侵入的现象。所以通过 <code>init-method</code> 我们可以使用业务对象中定义的任何方法来实现 bean 实例对象的初始化定制化，而不再受制于 InitializingBean的 <code>#afterPropertiesSet()</code> 方法。同时我们可以使用 <code>&lt;beans&gt;</code> 标签的 <code>default-init-method</code> 属性来统一指定初始化方法，这样就省了需要在每个 <code>&lt;bean&gt;</code> 标签中都设置 <code>init-method</code> 这样的繁琐工作了。</p><h3 id="applicationcontext" tabindex="-1">ApplicationContext <a class="header-anchor" href="#applicationcontext" aria-label="Permalink to &quot;ApplicationContext&quot;">​</a></h3><p><code>org.springframework.context.ApplicationContext</code> ， Spring 容器，它叫做应用上下文，继承 BeanFactory ，其主要区别有：</p><ol><li>继承 <code>org.springframework.context.MessageSource</code> 接口，提供国际化的标准访问策略。</li><li>继承 <code>org.springframework.context.ApplicationEventPublisher</code> 接口，提供强大的<strong>事件</strong>机制。</li><li>扩展 ResourceLoader ，可以用来加载多种 Resource ，可以灵活访问不同的资源。</li><li>对 Web 应用的支持。</li></ol><p><img src="/assets/bfdcd6b07c6f5434ba01895efd174cdc.de53e0ae.png" alt="ApplicationContext 类图"></p><h4 id="webapplicationcontext" tabindex="-1">WebApplicationContext <a class="header-anchor" href="#webapplicationcontext" aria-label="Permalink to &quot;WebApplicationContext&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// WebApplicationContext.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">WebApplicationContext</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ApplicationContext</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    ServletContext </span><span style="color:#B392F0;">getServletContext</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// WebApplicationContext.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">interface</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">WebApplicationContext</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ApplicationContext</span><span style="color:#24292E;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    ServletContext </span><span style="color:#6F42C1;">getServletContext</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>该接口只有一个 <code>#getServletContext()</code> 方法，用于给 Servlet 提供上下文信息。</p><h4 id="configurableapplicationcontext" tabindex="-1">ConfigurableApplicationContext <a class="header-anchor" href="#configurableapplicationcontext" aria-label="Permalink to &quot;ConfigurableApplicationContext&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// ConfigurableApplicationContext.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ConfigurableApplicationContext</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ApplicationContext</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">Lifecycle</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">Closeable</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 为 ApplicationContext 设置唯一 ID</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">setId</span><span style="color:#E1E4E8;">(String </span><span style="color:#FFAB70;">id</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 为 ApplicationContext 设置 parent</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 父类不应该被修改：如果创建的对象不可用时，则应该在构造函数外部设置它</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">setParent</span><span style="color:#E1E4E8;">(@</span><span style="color:#F97583;">Nullable</span><span style="color:#E1E4E8;"> ApplicationContext </span><span style="color:#FFAB70;">parent</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 设置 Environment</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">setEnvironment</span><span style="color:#E1E4E8;">(ConfigurableEnvironment </span><span style="color:#FFAB70;">environment</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 获取 Environment</span></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">    ConfigurableEnvironment </span><span style="color:#B392F0;">getEnvironment</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 添加 BeanFactoryPostProcessor</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">addBeanFactoryPostProcessor</span><span style="color:#E1E4E8;">(BeanFactoryPostProcessor </span><span style="color:#FFAB70;">postProcessor</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 添加 ApplicationListener</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">addApplicationListener</span><span style="color:#E1E4E8;">(ApplicationListener&lt;</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">&gt; </span><span style="color:#FFAB70;">listener</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 添加 ProtocolResolver</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">addProtocolResolver</span><span style="color:#E1E4E8;">(ProtocolResolver </span><span style="color:#FFAB70;">resolver</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 加载或者刷新配置</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 这是一个非常重要的方法</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">refresh</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> BeansException, IllegalStateException;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 注册 shutdown hook</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">registerShutdownHook</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 关闭 ApplicationContext</span></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">close</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// ApplicationContext 是否处于激活状态</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">isActive</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 获取当前上下文的 BeanFactory</span></span>
<span class="line"><span style="color:#E1E4E8;">    ConfigurableListableBeanFactory </span><span style="color:#B392F0;">getBeanFactory</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> IllegalStateException;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// ConfigurableApplicationContext.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">interface</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ConfigurableApplicationContext</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ApplicationContext</span><span style="color:#24292E;">, </span><span style="color:#6F42C1;">Lifecycle</span><span style="color:#24292E;">, </span><span style="color:#6F42C1;">Closeable</span><span style="color:#24292E;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 为 ApplicationContext 设置唯一 ID</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">setId</span><span style="color:#24292E;">(String </span><span style="color:#E36209;">id</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 为 ApplicationContext 设置 parent</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 父类不应该被修改：如果创建的对象不可用时，则应该在构造函数外部设置它</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">setParent</span><span style="color:#24292E;">(@</span><span style="color:#D73A49;">Nullable</span><span style="color:#24292E;"> ApplicationContext </span><span style="color:#E36209;">parent</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 设置 Environment</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">setEnvironment</span><span style="color:#24292E;">(ConfigurableEnvironment </span><span style="color:#E36209;">environment</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 获取 Environment</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">    ConfigurableEnvironment </span><span style="color:#6F42C1;">getEnvironment</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 添加 BeanFactoryPostProcessor</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">addBeanFactoryPostProcessor</span><span style="color:#24292E;">(BeanFactoryPostProcessor </span><span style="color:#E36209;">postProcessor</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 添加 ApplicationListener</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">addApplicationListener</span><span style="color:#24292E;">(ApplicationListener&lt;</span><span style="color:#D73A49;">?</span><span style="color:#24292E;">&gt; </span><span style="color:#E36209;">listener</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 添加 ProtocolResolver</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">addProtocolResolver</span><span style="color:#24292E;">(ProtocolResolver </span><span style="color:#E36209;">resolver</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 加载或者刷新配置</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 这是一个非常重要的方法</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">refresh</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> BeansException, IllegalStateException;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 注册 shutdown hook</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">registerShutdownHook</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 关闭 ApplicationContext</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">close</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// ApplicationContext 是否处于激活状态</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">isActive</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 获取当前上下文的 BeanFactory</span></span>
<span class="line"><span style="color:#24292E;">    ConfigurableListableBeanFactory </span><span style="color:#6F42C1;">getBeanFactory</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> IllegalStateException;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>ConfigurableApplicationContext 接口提供的方法都是对 ApplicationContext 进行配置的，例如 <code>#setEnvironment(ConfigurableEnvironment environment)</code>、<code>#addBeanFactoryPostProcessor(BeanFactoryPostProcessor postProcessor)</code>，同时它还继承了如下两个接口：</p><ul><li>Lifecycle：对 context 生命周期的管理，它提供 <code>#start()</code> 和 <code>#stop()</code> 方法启动和暂停组件。</li><li>Closeable：标准 JDK 所提供的一个接口，用于最后关闭组件释放资源等。</li></ul><h4 id="configurablewebapplicationcontext" tabindex="-1">ConfigurableWebApplicationContext <a class="header-anchor" href="#configurablewebapplicationcontext" aria-label="Permalink to &quot;ConfigurableWebApplicationContext&quot;">​</a></h4><p>WebApplicationContext 接口和 ConfigurableApplicationContext 接口有一个共同的子类接口 ConfigurableWebApplicationContext，该接口将这两个接口进行合并，提供了一个可配置、可管理、可关闭的 WebApplicationContext ，同时该接口还增加了 <code>#setServletContext(ServletContext servletContext)</code>，<code>setServletConfig(ServletConfig servletConfig)</code> 等方法，用于装配 WebApplicationContext 。代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// ConfigurableWebApplicationContext.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ConfigurableWebApplicationContext</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">WebApplicationContext</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">ConfigurableApplicationContext</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">setServletContext</span><span style="color:#E1E4E8;">(@</span><span style="color:#F97583;">Nullable</span><span style="color:#E1E4E8;"> ServletContext </span><span style="color:#FFAB70;">servletContext</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">setServletConfig</span><span style="color:#E1E4E8;">(@</span><span style="color:#F97583;">Nullable</span><span style="color:#E1E4E8;"> ServletConfig </span><span style="color:#FFAB70;">servletConfig</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    ServletConfig </span><span style="color:#B392F0;">getServletConfig</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">setNamespace</span><span style="color:#E1E4E8;">(@</span><span style="color:#F97583;">Nullable</span><span style="color:#E1E4E8;"> String </span><span style="color:#FFAB70;">namespace</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    String </span><span style="color:#B392F0;">getNamespace</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">setConfigLocation</span><span style="color:#E1E4E8;">(String </span><span style="color:#FFAB70;">configLocation</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">setConfigLocations</span><span style="color:#E1E4E8;">(String... </span><span style="color:#FFAB70;">configLocations</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#B392F0;">getConfigLocations</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// ConfigurableWebApplicationContext.java</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">interface</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ConfigurableWebApplicationContext</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">WebApplicationContext</span><span style="color:#24292E;">, </span><span style="color:#6F42C1;">ConfigurableApplicationContext</span><span style="color:#24292E;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">setServletContext</span><span style="color:#24292E;">(@</span><span style="color:#D73A49;">Nullable</span><span style="color:#24292E;"> ServletContext </span><span style="color:#E36209;">servletContext</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">setServletConfig</span><span style="color:#24292E;">(@</span><span style="color:#D73A49;">Nullable</span><span style="color:#24292E;"> ServletConfig </span><span style="color:#E36209;">servletConfig</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    ServletConfig </span><span style="color:#6F42C1;">getServletConfig</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">setNamespace</span><span style="color:#24292E;">(@</span><span style="color:#D73A49;">Nullable</span><span style="color:#24292E;"> String </span><span style="color:#E36209;">namespace</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    String </span><span style="color:#6F42C1;">getNamespace</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">setConfigLocation</span><span style="color:#24292E;">(String </span><span style="color:#E36209;">configLocation</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">setConfigLocations</span><span style="color:#24292E;">(String... </span><span style="color:#E36209;">configLocations</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#6F42C1;">getConfigLocations</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="问题篇" tabindex="-1">问题篇 <a class="header-anchor" href="#问题篇" aria-label="Permalink to &quot;问题篇&quot;">​</a></h2><h3 id="jdk-cglib-动态代理" tabindex="-1">JDK &amp;CGLIB 动态代理 <a class="header-anchor" href="#jdk-cglib-动态代理" aria-label="Permalink to &quot;JDK &amp;CGLIB 动态代理&quot;">​</a></h3><h4 id="两者有何区别" tabindex="-1">两者有何区别 <a class="header-anchor" href="#两者有何区别" aria-label="Permalink to &quot;两者有何区别&quot;">​</a></h4><p>1、<strong>Jdk动态代理</strong>：利用拦截器（必须实现InvocationHandler接口）加上<strong>反射机制</strong>生成一个代理接口的匿名类，在调用具体方法前调用InvokeHandler来处理</p><p>2、 <strong>Cglib动态代理</strong>：利用ASM框架，对代理对象类生成的class文件加载进来，通过<strong>修改其字节码生成子类来进行代理</strong></p><p><strong>所以：</strong></p><ul><li><strong>如果想要实现JDK动态代理那么代理类必须实现接口，否则不能使用;</strong></li><li><strong>如果想要使用CGlib动态代理，那么代理类不能使用final修饰类和方法；</strong></li></ul><p>还有： 在jdk6、jdk7、jdk8逐步对JDK动态代理优化之后，在调用次数较少的情况下，JDK代理效率高于CGLIB代理效率，只有当进行大量调用的时候，jdk6和jdk7比CGLIB代理效率低一点，但是到jdk8的时候，jdk代理效率高于CGLIB代理。</p><h4 id="jdk动态代理" tabindex="-1">JDK动态代理 <a class="header-anchor" href="#jdk动态代理" aria-label="Permalink to &quot;JDK动态代理&quot;">​</a></h4><p><img src="/assets/v2-7dcee9f19c6558d5f8e4ff778e674396_720w.80b497da.jpg" alt="img"></p><p><strong>UserService接口</strong></p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">public interface UserService {</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    void addUser();</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    void updateUser(String str);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">public interface UserService {</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    void addUser();</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    void updateUser(String str);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><p><strong>UserServiceImpl实现类</strong></p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">public class UserServiceImpl implements UserService {</span></span>
<span class="line"><span style="color:#e1e4e8;">    @Override</span></span>
<span class="line"><span style="color:#e1e4e8;">    public void addUser() {</span></span>
<span class="line"><span style="color:#e1e4e8;">        System.out.println(&quot;添加用户&quot;);</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    @Override</span></span>
<span class="line"><span style="color:#e1e4e8;">    public void updateUser(String str) {</span></span>
<span class="line"><span style="color:#e1e4e8;">        System.out.println(&quot;更新用户信息&quot; + str);</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">public class UserServiceImpl implements UserService {</span></span>
<span class="line"><span style="color:#24292e;">    @Override</span></span>
<span class="line"><span style="color:#24292e;">    public void addUser() {</span></span>
<span class="line"><span style="color:#24292e;">        System.out.println(&quot;添加用户&quot;);</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    @Override</span></span>
<span class="line"><span style="color:#24292e;">    public void updateUser(String str) {</span></span>
<span class="line"><span style="color:#24292e;">        System.out.println(&quot;更新用户信息&quot; + str);</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><p><strong>UserProxy代理类，实现InvocationHandler接口重写invoke方法</strong></p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">public class UserProxy implements InvocationHandler {</span></span>
<span class="line"><span style="color:#e1e4e8;">    private Object target;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    public UserProxy(Object target) {</span></span>
<span class="line"><span style="color:#e1e4e8;">        this.target = target;</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    @Override</span></span>
<span class="line"><span style="color:#e1e4e8;">    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">        Object res = method.invoke(target, args);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">        System.out.println(&quot;记录日志&quot;);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">        return res;</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">public class UserProxy implements InvocationHandler {</span></span>
<span class="line"><span style="color:#24292e;">    private Object target;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    public UserProxy(Object target) {</span></span>
<span class="line"><span style="color:#24292e;">        this.target = target;</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    @Override</span></span>
<span class="line"><span style="color:#24292e;">    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">        Object res = method.invoke(target, args);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">        System.out.println(&quot;记录日志&quot;);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">        return res;</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><p><strong>test测试类</strong></p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">public class test {</span></span>
<span class="line"><span style="color:#e1e4e8;">    public static void main(String[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">        UserServiceImpl impl = new UserServiceImpl();</span></span>
<span class="line"><span style="color:#e1e4e8;">        UserProxy userProxy = new UserProxy(impl);</span></span>
<span class="line"><span style="color:#e1e4e8;">        UserService userService = (UserService) Proxy.newProxyInstance(impl.getClass().getClassLoader(),impl.getClass().getInterfaces(),userProxy);</span></span>
<span class="line"><span style="color:#e1e4e8;">        userService.addUser();</span></span>
<span class="line"><span style="color:#e1e4e8;">        userService.updateUser(&quot;：我是皮皮虾&quot;);</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">public class test {</span></span>
<span class="line"><span style="color:#24292e;">    public static void main(String[] args) {</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">        UserServiceImpl impl = new UserServiceImpl();</span></span>
<span class="line"><span style="color:#24292e;">        UserProxy userProxy = new UserProxy(impl);</span></span>
<span class="line"><span style="color:#24292e;">        UserService userService = (UserService) Proxy.newProxyInstance(impl.getClass().getClassLoader(),impl.getClass().getInterfaces(),userProxy);</span></span>
<span class="line"><span style="color:#24292e;">        userService.addUser();</span></span>
<span class="line"><span style="color:#24292e;">        userService.updateUser(&quot;：我是皮皮虾&quot;);</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><h4 id="cglib动态代理" tabindex="-1">CGlib动态代理 <a class="header-anchor" href="#cglib动态代理" aria-label="Permalink to &quot;CGlib动态代理&quot;">​</a></h4><p><strong>CGlib不像是JDK动态代理，CGlib需要导入Jar包，那么我用SpringBoot直接导入依赖</strong></p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">&lt;dependency&gt;</span></span>
<span class="line"><span style="color:#e1e4e8;">    &lt;groupId&gt;cglib&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#e1e4e8;">    &lt;artifactId&gt;cglib&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#e1e4e8;">    &lt;version&gt;3.3.0&lt;/version&gt;</span></span>
<span class="line"><span style="color:#e1e4e8;">&lt;/dependency&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">&lt;dependency&gt;</span></span>
<span class="line"><span style="color:#24292e;">    &lt;groupId&gt;cglib&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#24292e;">    &lt;artifactId&gt;cglib&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#24292e;">    &lt;version&gt;3.3.0&lt;/version&gt;</span></span>
<span class="line"><span style="color:#24292e;">&lt;/dependency&gt;</span></span></code></pre></div><p><strong>UserServiceImpl被代理类</strong></p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">public class UserServiceImpl {</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    public void addUser() {</span></span>
<span class="line"><span style="color:#e1e4e8;">        System.out.println(&quot;添加了一个用户&quot;);</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    public void deleteUser() {</span></span>
<span class="line"><span style="color:#e1e4e8;">        System.out.println(&quot;删除了一个用户&quot;);</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">public class UserServiceImpl {</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    public void addUser() {</span></span>
<span class="line"><span style="color:#24292e;">        System.out.println(&quot;添加了一个用户&quot;);</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    public void deleteUser() {</span></span>
<span class="line"><span style="color:#24292e;">        System.out.println(&quot;删除了一个用户&quot;);</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><p><strong>UserServiceCGlib代理</strong></p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">public class UserServiceCGlib implements MethodInterceptor {</span></span>
<span class="line"><span style="color:#e1e4e8;">    private Object target;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    public UserServiceCGlib() {</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    public UserServiceCGlib(Object target) {</span></span>
<span class="line"><span style="color:#e1e4e8;">        this.target = target;</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    //返回一个代理对象:    是 target对象的代理对象</span></span>
<span class="line"><span style="color:#e1e4e8;">    public Object getProxyInstance() {</span></span>
<span class="line"><span style="color:#e1e4e8;">        //1. 创建一个工具类</span></span>
<span class="line"><span style="color:#e1e4e8;">        Enhancer enhancer = new Enhancer();</span></span>
<span class="line"><span style="color:#e1e4e8;">        //2. 设置父类</span></span>
<span class="line"><span style="color:#e1e4e8;">        enhancer.setSuperclass(target.getClass());</span></span>
<span class="line"><span style="color:#e1e4e8;">        //3. 设置回调函数</span></span>
<span class="line"><span style="color:#e1e4e8;">        enhancer.setCallback(this);</span></span>
<span class="line"><span style="color:#e1e4e8;">        //4. 创建子类对象，即代理对象</span></span>
<span class="line"><span style="color:#e1e4e8;">        return enhancer.create();</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    @Override</span></span>
<span class="line"><span style="color:#e1e4e8;">    public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable {</span></span>
<span class="line"><span style="color:#e1e4e8;">        System.out.println(&quot;增强开始~~~&quot;);</span></span>
<span class="line"><span style="color:#e1e4e8;">        Object result = methodProxy.invokeSuper(o, objects);</span></span>
<span class="line"><span style="color:#e1e4e8;">        System.out.println(&quot;增强结束~~~&quot;);</span></span>
<span class="line"><span style="color:#e1e4e8;">        return result;</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">public class UserServiceCGlib implements MethodInterceptor {</span></span>
<span class="line"><span style="color:#24292e;">    private Object target;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    public UserServiceCGlib() {</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    public UserServiceCGlib(Object target) {</span></span>
<span class="line"><span style="color:#24292e;">        this.target = target;</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    //返回一个代理对象:    是 target对象的代理对象</span></span>
<span class="line"><span style="color:#24292e;">    public Object getProxyInstance() {</span></span>
<span class="line"><span style="color:#24292e;">        //1. 创建一个工具类</span></span>
<span class="line"><span style="color:#24292e;">        Enhancer enhancer = new Enhancer();</span></span>
<span class="line"><span style="color:#24292e;">        //2. 设置父类</span></span>
<span class="line"><span style="color:#24292e;">        enhancer.setSuperclass(target.getClass());</span></span>
<span class="line"><span style="color:#24292e;">        //3. 设置回调函数</span></span>
<span class="line"><span style="color:#24292e;">        enhancer.setCallback(this);</span></span>
<span class="line"><span style="color:#24292e;">        //4. 创建子类对象，即代理对象</span></span>
<span class="line"><span style="color:#24292e;">        return enhancer.create();</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    @Override</span></span>
<span class="line"><span style="color:#24292e;">    public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable {</span></span>
<span class="line"><span style="color:#24292e;">        System.out.println(&quot;增强开始~~~&quot;);</span></span>
<span class="line"><span style="color:#24292e;">        Object result = methodProxy.invokeSuper(o, objects);</span></span>
<span class="line"><span style="color:#24292e;">        System.out.println(&quot;增强结束~~~&quot;);</span></span>
<span class="line"><span style="color:#24292e;">        return result;</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><p><strong>test测试类</strong></p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">public class test {</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    public static void main(String[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8;">        UserServiceCGlib serviceCGlib = new UserServiceCGlib(new UserServiceImpl());</span></span>
<span class="line"><span style="color:#e1e4e8;">        UserServiceImpl userService = (UserServiceImpl)serviceCGlib.getProxyInstance();</span></span>
<span class="line"><span style="color:#e1e4e8;">        userService.addUser();</span></span>
<span class="line"><span style="color:#e1e4e8;">        System.out.println();</span></span>
<span class="line"><span style="color:#e1e4e8;">        userService.deleteUser();</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">public class test {</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    public static void main(String[] args) {</span></span>
<span class="line"><span style="color:#24292e;">        UserServiceCGlib serviceCGlib = new UserServiceCGlib(new UserServiceImpl());</span></span>
<span class="line"><span style="color:#24292e;">        UserServiceImpl userService = (UserServiceImpl)serviceCGlib.getProxyInstance();</span></span>
<span class="line"><span style="color:#24292e;">        userService.addUser();</span></span>
<span class="line"><span style="color:#24292e;">        System.out.println();</span></span>
<span class="line"><span style="color:#24292e;">        userService.deleteUser();</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><h3 id="aop-切面编程" tabindex="-1">AOP 切面编程 <a class="header-anchor" href="#aop-切面编程" aria-label="Permalink to &quot;AOP 切面编程&quot;">​</a></h3><blockquote><p>将公共行为（如记录日志，权限校验等）封装到可重用的模块中，而使原本的模块内只需关注自身的个性化行为</p></blockquote><p><strong>以下是Spring AOP创建代理的方法</strong></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> AopProxy </span><span style="color:#B392F0;">createAopProxy</span><span style="color:#E1E4E8;">(AdvisedSupport config) throws AopConfigException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (config.</span><span style="color:#B392F0;">isOptimize</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> config.</span><span style="color:#B392F0;">isProxyTargetClass</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hasNoUserSuppliedProxyInterfaces</span><span style="color:#E1E4E8;">(config)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      Class&lt;</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">&gt; targetClass </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> config.</span><span style="color:#B392F0;">getTargetClass</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (targetClass </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">AopConfigException</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;TargetSource cannot determine target class: &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">&quot;Either an interface or a target is required for proxy creation.&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (targetClass.</span><span style="color:#B392F0;">isInterface</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> Proxy.</span><span style="color:#B392F0;">isProxyClass</span><span style="color:#E1E4E8;">(targetClass)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">JdkDynamicAopProxy</span><span style="color:#E1E4E8;">(config);</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ObjenesisCglibAopProxy</span><span style="color:#E1E4E8;">(config);</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">JdkDynamicAopProxy</span><span style="color:#E1E4E8;">(config);</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> AopProxy </span><span style="color:#6F42C1;">createAopProxy</span><span style="color:#24292E;">(AdvisedSupport config) throws AopConfigException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (config.</span><span style="color:#6F42C1;">isOptimize</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> config.</span><span style="color:#6F42C1;">isProxyTargetClass</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hasNoUserSuppliedProxyInterfaces</span><span style="color:#24292E;">(config)) {</span></span>
<span class="line"><span style="color:#24292E;">      Class&lt;</span><span style="color:#D73A49;">?</span><span style="color:#24292E;">&gt; targetClass </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> config.</span><span style="color:#6F42C1;">getTargetClass</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (targetClass </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">AopConfigException</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;TargetSource cannot determine target class: &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#032F62;">&quot;Either an interface or a target is required for proxy creation.&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (targetClass.</span><span style="color:#6F42C1;">isInterface</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> Proxy.</span><span style="color:#6F42C1;">isProxyClass</span><span style="color:#24292E;">(targetClass)) {</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">JdkDynamicAopProxy</span><span style="color:#24292E;">(config);</span></span>
<span class="line"><span style="color:#24292E;">      }</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ObjenesisCglibAopProxy</span><span style="color:#24292E;">(config);</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">JdkDynamicAopProxy</span><span style="color:#24292E;">(config);</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>1、如果目标对象实现了接口，<strong>默认情况下会采用JDK的动态代理</strong> 2、如果目标对象实现了接口，也可以<strong>强制使用CGLIB</strong> 3、如果目标对象<strong>没有实现了接口，必须采用CGLIB库</strong>，spring会自动在JDK动态代理和CGLIB之间转换</p><blockquote><p>如果需要强制使用CGLIB来实现AOP，需要配置spring.aop.proxy-target-class=true或@EnableAspectJAutoProxy(proxyTargetClass = true)</p></blockquote><h2 id="应用篇" tabindex="-1">应用篇 <a class="header-anchor" href="#应用篇" aria-label="Permalink to &quot;应用篇&quot;">​</a></h2><h3 id="springtask" tabindex="-1">SpringTask <a class="header-anchor" href="#springtask" aria-label="Permalink to &quot;SpringTask&quot;">​</a></h3><blockquote><p><code>@Scheduled</code></p><blockquote><ul><li><code>cron</code> 属性：Spring Cron 表达式。</li><li><code>fixedDelay</code> 属性：固定执行间隔，单位：毫秒。注意，以调用<strong>完成时刻</strong>为开始计时时间。</li><li><code>fixedRate</code> 属性：固定执行间隔，单位：毫秒。注意，以调用<strong>开始时刻</strong>为开始计时时间。</li></ul></blockquote><blockquote><ul><li><code>initialDelay</code> 属性：初始化的定时任务执行延迟，单位：毫秒。</li><li><code>zone</code> 属性：解析 Spring Cron 表达式的所属的时区。默认情况下，使用服务器的本地时区。</li><li><code>initialDelayString</code> 属性：<code>initialDelay</code> 的字符串形式。</li><li><code>fixedDelayString</code> 属性：<code>fixedDelay</code> 的字符串形式。</li><li><code>fixedRateString</code> 属性：<code>fixedRate</code> 的字符串形式。</li></ul></blockquote><p><code>application.yml</code></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">spring</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">task</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#6A737D;"># Spring Task 调度任务的配置，对应 TaskSchedulingProperties 配置类</span></span>
<span class="line"><span style="color:#85E89D;">scheduling</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">thread-name-prefix</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pikaqiu-demo-</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 线程池的线程名的前缀。默认为 scheduling- ，建议根据自己应用来设置</span></span>
<span class="line"><span style="color:#85E89D;">pool</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">size</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 线程池大小。默认为 1 ，根据自己应用来设置</span></span>
<span class="line"><span style="color:#85E89D;">shutdown</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">await-termination</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 应用关闭时，是否等待定时任务执行完成。默认为 false ，建议设置为 true</span></span>
<span class="line"><span style="color:#85E89D;">await-termination-period</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">60</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 等待任务完成的最大时长，单位为秒。默认为 0 ，根据自己应用来设置</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">spring</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#22863A;">task</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#6A737D;"># Spring Task 调度任务的配置，对应 TaskSchedulingProperties 配置类</span></span>
<span class="line"><span style="color:#22863A;">scheduling</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#22863A;">thread-name-prefix</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pikaqiu-demo-</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 线程池的线程名的前缀。默认为 scheduling- ，建议根据自己应用来设置</span></span>
<span class="line"><span style="color:#22863A;">pool</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#22863A;">size</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 线程池大小。默认为 1 ，根据自己应用来设置</span></span>
<span class="line"><span style="color:#22863A;">shutdown</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#22863A;">await-termination</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 应用关闭时，是否等待定时任务执行完成。默认为 false ，建议设置为 true</span></span>
<span class="line"><span style="color:#22863A;">await-termination-period</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">60</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 等待任务完成的最大时长，单位为秒。默认为 0 ，根据自己应用来设置</span></span></code></pre></div></blockquote><h3 id="stopwatch" tabindex="-1">StopWatch <a class="header-anchor" href="#stopwatch" aria-label="Permalink to &quot;StopWatch&quot;">​</a></h3><blockquote><p>优缺点：</p><ul><li><p>优点： spring自带工具类，可直接使用 代码实现简单，使用更简单 统一归纳，展示每项任务耗时与占用总时间的百分比，展示结果直观 性能消耗相对较小，并且最大程度的保证了start与stop之间的时间记录的准确性 可在start时直接指定任务名字，从而更加直观的显示记录结果</p></li><li><p>缺点： 一个StopWatch实例一次只能开启一个task，不能同时start多个task，并且在该task未stop之前不能start一个新的task，必须在该task stop之后才能开启新的task，若要一次开启多个，需要new不同的StopWatch实例代码侵入式使用，需要改动多处代码</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"></span></code></pre></div></li></ul><p>public static void test1() throws InterruptedException { StopWatch sw = new StopWatch(&quot;test&quot;); try{ sw.start(&quot;task1&quot;); // do something Thread.sleep(100); sw.stop(); sw.start(&quot;task2&quot;); // do something Thread.sleep(200); }catch(InterruptedException e){ throws new InterruptedException(); }finally{ sw.stop(); System.out.println(sw.prettyPrint()); System.out.println(sw.shortSummary()); System.out.println(sw.getTotalTimeMillis()) } }</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"></span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"></span></span></code></pre></div></blockquote><h3 id="springasync" tabindex="-1">SpringAsync <a class="header-anchor" href="#springasync" aria-label="Permalink to &quot;SpringAsync&quot;">​</a></h3><blockquote><p><code>AsyncConfig.java </code></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.springframework.aop.interceptor.AsyncUncaughtExceptionHandler;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.springframework.context.annotation.Bean;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.springframework.context.annotation.Configuration;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.springframework.scheduling.annotation.AsyncConfigurerSupport;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.springframework.scheduling.annotation.EnableAsync;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> java.util.concurrent.Executor;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> java.util.concurrent.ThreadPoolExecutor;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Configuration</span></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">EnableAsync</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">AsyncConfig</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">AsyncConfigurerSupport</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> AsyncUncaughtExceptionHandler </span><span style="color:#B392F0;">getAsyncUncaughtExceptionHandler</span><span style="color:#E1E4E8;">(){</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CusAsyncExceptionHandler</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">       }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       @</span><span style="color:#F97583;">Bean</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;executor&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Executor </span><span style="color:#B392F0;">executor</span><span style="color:#E1E4E8;">(){</span></span>
<span class="line"><span style="color:#E1E4E8;">            System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;executor 线程启动---&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            ThreadPoolTaskExecutor scheduler </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ThreadPoolTaskExecutor</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">            scheduler.</span><span style="color:#B392F0;">setCorePoolSize</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">);    </span><span style="color:#6A737D;">//基本线程数量</span></span>
<span class="line"><span style="color:#E1E4E8;">            scheduler.</span><span style="color:#B392F0;">setQueueCapacity</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">500</span><span style="color:#E1E4E8;">);  </span><span style="color:#6A737D;">//队列最大长度</span></span>
<span class="line"><span style="color:#E1E4E8;">            scheduler.</span><span style="color:#B392F0;">setMaxPoolSize</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">);    </span><span style="color:#6A737D;">//最大线程数量</span></span>
<span class="line"><span style="color:#E1E4E8;">            scheduler.</span><span style="color:#B392F0;">setRejectedExecutionHandler</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> ThreadPoolExecutor.</span><span style="color:#B392F0;">CallerRunsPolicy</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">            scheduler.</span><span style="color:#B392F0;">setThreadNamePrefix</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Myself-Executor-&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            scheduler.</span><span style="color:#B392F0;">setKeepAliveSeconds</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;">); </span><span style="color:#6A737D;">//允许空闲时间</span></span>
<span class="line"><span style="color:#E1E4E8;">            scheduler.</span><span style="color:#B392F0;">initialize</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> scheduler;</span></span>
<span class="line"><span style="color:#E1E4E8;">       }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.springframework.aop.interceptor.AsyncUncaughtExceptionHandler;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.springframework.context.annotation.Bean;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.springframework.context.annotation.Configuration;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.springframework.scheduling.annotation.AsyncConfigurerSupport;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.springframework.scheduling.annotation.EnableAsync;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> java.util.concurrent.Executor;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> java.util.concurrent.ThreadPoolExecutor;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Configuration</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">EnableAsync</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">AsyncConfig</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">AsyncConfigurerSupport</span><span style="color:#24292E;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> AsyncUncaughtExceptionHandler </span><span style="color:#6F42C1;">getAsyncUncaughtExceptionHandler</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CusAsyncExceptionHandler</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">       }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       @</span><span style="color:#D73A49;">Bean</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;executor&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Executor </span><span style="color:#6F42C1;">executor</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;executor 线程启动---&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            ThreadPoolTaskExecutor scheduler </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ThreadPoolTaskExecutor</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            scheduler.</span><span style="color:#6F42C1;">setCorePoolSize</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">5</span><span style="color:#24292E;">);    </span><span style="color:#6A737D;">//基本线程数量</span></span>
<span class="line"><span style="color:#24292E;">            scheduler.</span><span style="color:#6F42C1;">setQueueCapacity</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">500</span><span style="color:#24292E;">);  </span><span style="color:#6A737D;">//队列最大长度</span></span>
<span class="line"><span style="color:#24292E;">            scheduler.</span><span style="color:#6F42C1;">setMaxPoolSize</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">5</span><span style="color:#24292E;">);    </span><span style="color:#6A737D;">//最大线程数量</span></span>
<span class="line"><span style="color:#24292E;">            scheduler.</span><span style="color:#6F42C1;">setRejectedExecutionHandler</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> ThreadPoolExecutor.</span><span style="color:#6F42C1;">CallerRunsPolicy</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">            scheduler.</span><span style="color:#6F42C1;">setThreadNamePrefix</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Myself-Executor-&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            scheduler.</span><span style="color:#6F42C1;">setKeepAliveSeconds</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">30</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">//允许空闲时间</span></span>
<span class="line"><span style="color:#24292E;">            scheduler.</span><span style="color:#6F42C1;">initialize</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> scheduler;</span></span>
<span class="line"><span style="color:#24292E;">       }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p><code>AsyncMethod.java</code></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.springframework.scheduling.annotation.Async;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.springframework.scheduling.annotation.AsyncResult;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.springframework.stereotype.Component;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> java.util.Date;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> java.util.concurrent.Future;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Component</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">AsyncMethod</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       @</span><span style="color:#F97583;">Async</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;executor&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">asyncMethod</span><span style="color:#E1E4E8;">(){</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> i</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;i</span><span style="color:#F97583;">&lt;</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">;i</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">){</span></span>
<span class="line"><span style="color:#E1E4E8;">                System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;i: &quot;</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">i</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&quot; threadName: &quot;</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> i</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">100</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span><span style="color:#6A737D;">//抛出异常</span></span>
<span class="line"><span style="color:#E1E4E8;">       }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       @</span><span style="color:#F97583;">Async</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;executor&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Future&lt;</span><span style="color:#F97583;">Integer</span><span style="color:#E1E4E8;">&gt; </span><span style="color:#B392F0;">asyncSquare</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">x</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;calling asyncSquare,&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">getName</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;,&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Date</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                Thread.</span><span style="color:#B392F0;">sleep</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (InterruptedException </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// TODO Auto-generated catch block</span></span>
<span class="line"><span style="color:#E1E4E8;">                e.</span><span style="color:#B392F0;">printStackTrace</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;asyncSquare Finished,&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">getName</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;,&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Date</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> AsyncResult&lt;</span><span style="color:#F97583;">Integer</span><span style="color:#E1E4E8;">&gt;(x</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">x);</span></span>
<span class="line"><span style="color:#E1E4E8;">       }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.springframework.scheduling.annotation.Async;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.springframework.scheduling.annotation.AsyncResult;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.springframework.stereotype.Component;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> java.util.Date;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> java.util.concurrent.Future;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Component</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">AsyncMethod</span><span style="color:#24292E;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       @</span><span style="color:#D73A49;">Async</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;executor&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">asyncMethod</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">for</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;i</span><span style="color:#D73A49;">&lt;</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">;i</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">                System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;i: &quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">i</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&quot; threadName: &quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">100</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span><span style="color:#6A737D;">//抛出异常</span></span>
<span class="line"><span style="color:#24292E;">       }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       @</span><span style="color:#D73A49;">Async</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;executor&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Future&lt;</span><span style="color:#D73A49;">Integer</span><span style="color:#24292E;">&gt; </span><span style="color:#6F42C1;">asyncSquare</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#E36209;">x</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;calling asyncSquare,&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getName</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;,&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Date</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                Thread.</span><span style="color:#6F42C1;">sleep</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (InterruptedException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// TODO Auto-generated catch block</span></span>
<span class="line"><span style="color:#24292E;">                e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;asyncSquare Finished,&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getName</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;,&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Date</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> AsyncResult&lt;</span><span style="color:#D73A49;">Integer</span><span style="color:#24292E;">&gt;(x</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">x);</span></span>
<span class="line"><span style="color:#24292E;">       }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p><code>AsyncController.java</code></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> jdk.nashorn.internal.runtime.logging.Logger;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.apache.commons.logging.Log;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.apache.commons.logging.LogFactory;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.springframework.beans.factory.annotation.Autowired;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.springframework.web.bind.annotation.RequestMapping;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.springframework.web.bind.annotation.RestController;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> java.util.concurrent.ExecutionException;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> java.util.concurrent.Future;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">RestController</span></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Logger</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">AsyncController</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Log log </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> LogFactory.</span><span style="color:#B392F0;">getLog</span><span style="color:#E1E4E8;">(AsyncController.class);</span></span>
<span class="line"><span style="color:#E1E4E8;">       @</span><span style="color:#F97583;">Autowired</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> AsyncMethod asyncMethod;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       @</span><span style="color:#F97583;">RequestMapping</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/async/method&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">asyncTestMethod</span><span style="color:#E1E4E8;">(){</span></span>
<span class="line"><span style="color:#E1E4E8;">            asyncMethod.</span><span style="color:#B392F0;">asyncMethod</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">            System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;检测异步执行&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">       }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       @</span><span style="color:#F97583;">RequestMapping</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/async/add&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">asyncTestMethodAdd</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> ExecutionException, InterruptedException {</span></span>
<span class="line"><span style="color:#E1E4E8;">            Future&lt;</span><span style="color:#F97583;">Integer</span><span style="color:#E1E4E8;">&gt; result </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  asyncMethod.</span><span style="color:#B392F0;">asyncSquare</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">9</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">){</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;">(result.</span><span style="color:#B392F0;">isCancelled</span><span style="color:#E1E4E8;">()){</span></span>
<span class="line"><span style="color:#E1E4E8;">                    log.</span><span style="color:#B392F0;">info</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;async task is Cancelled&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;">(result.</span><span style="color:#B392F0;">isDone</span><span style="color:#E1E4E8;">()){</span></span>
<span class="line"><span style="color:#E1E4E8;">                    log.</span><span style="color:#B392F0;">info</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;async task is Done&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    log.</span><span style="color:#B392F0;">info</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;result is &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> result.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;检测异步执行&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">       }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> jdk.nashorn.internal.runtime.logging.Logger;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.apache.commons.logging.Log;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.apache.commons.logging.LogFactory;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.springframework.beans.factory.annotation.Autowired;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.springframework.web.bind.annotation.RequestMapping;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.springframework.web.bind.annotation.RestController;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> java.util.concurrent.ExecutionException;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> java.util.concurrent.Future;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">RestController</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Logger</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">AsyncController</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Log log </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> LogFactory.</span><span style="color:#6F42C1;">getLog</span><span style="color:#24292E;">(AsyncController.class);</span></span>
<span class="line"><span style="color:#24292E;">       @</span><span style="color:#D73A49;">Autowired</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> AsyncMethod asyncMethod;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       @</span><span style="color:#D73A49;">RequestMapping</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">value</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/async/method&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">asyncTestMethod</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">            asyncMethod.</span><span style="color:#6F42C1;">asyncMethod</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;检测异步执行&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">       }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       @</span><span style="color:#D73A49;">RequestMapping</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">value</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/async/add&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">asyncTestMethodAdd</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> ExecutionException, InterruptedException {</span></span>
<span class="line"><span style="color:#24292E;">            Future&lt;</span><span style="color:#D73A49;">Integer</span><span style="color:#24292E;">&gt; result </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  asyncMethod.</span><span style="color:#6F42C1;">asyncSquare</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">9</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">(result.</span><span style="color:#6F42C1;">isCancelled</span><span style="color:#24292E;">()){</span></span>
<span class="line"><span style="color:#24292E;">                    log.</span><span style="color:#6F42C1;">info</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;async task is Cancelled&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">(result.</span><span style="color:#6F42C1;">isDone</span><span style="color:#24292E;">()){</span></span>
<span class="line"><span style="color:#24292E;">                    log.</span><span style="color:#6F42C1;">info</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;async task is Done&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                    log.</span><span style="color:#6F42C1;">info</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;result is &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> result.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;检测异步执行&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">       }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div></blockquote><h3 id="springretry" tabindex="-1">SpringRetry <a class="header-anchor" href="#springretry" aria-label="Permalink to &quot;SpringRetry&quot;">​</a></h3><blockquote><p>spring系列的<code>spring-retry</code>是一个实用程序模块，可以帮助我们以标准方式处理任何特定操作的重试。</p><p>1.依赖</p><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">&lt;</span><span style="color:#85E89D;">dependency</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;"> &lt;</span><span style="color:#85E89D;">groupId</span><span style="color:#E1E4E8;">&gt;org.springframework.retry&lt;/</span><span style="color:#85E89D;">groupId</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;"> &lt;</span><span style="color:#85E89D;">artifactId</span><span style="color:#E1E4E8;">&gt;spring-retry&lt;/</span><span style="color:#85E89D;">artifactId</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">&lt;/</span><span style="color:#85E89D;">dependency</span><span style="color:#E1E4E8;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">&lt;</span><span style="color:#22863A;">dependency</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;"> &lt;</span><span style="color:#22863A;">groupId</span><span style="color:#24292E;">&gt;org.springframework.retry&lt;/</span><span style="color:#22863A;">groupId</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;"> &lt;</span><span style="color:#22863A;">artifactId</span><span style="color:#24292E;">&gt;spring-retry&lt;/</span><span style="color:#22863A;">artifactId</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;/</span><span style="color:#22863A;">dependency</span><span style="color:#24292E;">&gt;</span></span></code></pre></div><p>2.配置类加 <code>@Retryable</code>注解 启用重试</p><p>3.在方法上添加<code>@Retryable</code></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Service</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TestRetryServiceImpl</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">implements</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TestRetryService</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">   @</span><span style="color:#F97583;">Retryable</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Exception.class,</span><span style="color:#79B8FF;">maxAttempts</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">backoff</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @</span><span style="color:#F97583;">Backoff</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">delay</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2000</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">multiplier</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1.5</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">test</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">code</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> Exception{</span></span>
<span class="line"><span style="color:#E1E4E8;">       System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;test被调用,时间：&quot;</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">LocalTime.</span><span style="color:#B392F0;">now</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (code</span><span style="color:#F97583;">==</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">){</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Exception</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;情况不对头！&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">         }</span></span>
<span class="line"><span style="color:#E1E4E8;">       System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;test被调用,情况对头了！&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Service</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TestRetryServiceImpl</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">implements</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TestRetryService</span><span style="color:#24292E;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">   @</span><span style="color:#D73A49;">Retryable</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">value</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Exception.class,</span><span style="color:#005CC5;">maxAttempts</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">backoff</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @</span><span style="color:#D73A49;">Backoff</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">delay</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2000</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">multiplier</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1.5</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">test</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#E36209;">code</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception{</span></span>
<span class="line"><span style="color:#24292E;">       System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;test被调用,时间：&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">LocalTime.</span><span style="color:#6F42C1;">now</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (code</span><span style="color:#D73A49;">==</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Exception</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;情况不对头！&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">         }</span></span>
<span class="line"><span style="color:#24292E;">       System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;test被调用,情况对头了！&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>参数含义：</p><ul><li><code>value</code>：抛出指定异常才会重试</li><li><code>include</code>：和value一样，默认为空，当exclude也为空时，默认所有异常</li><li><code>exclude</code>：指定不处理的异常</li><li><code>maxAttempts</code>：最大重试次数，默认3次</li><li><code>backoff</code>：重试等待策略，默认使用<code>@Backoff</code>，<code>@Backoff</code>的value默认为1000L，我们设置为2000L；<code>multiplier</code>（指定延迟倍数）默认为0，表示固定暂停1秒后进行重试，如果把<code>multiplier</code>设置为1.5，则第一次重试为2秒，第二次为3秒，第三次为4.5秒。</li></ul><p>当重试耗尽时，<code>RetryOperations</code>可以将控制传递给另一个回调，即<code>RecoveryCallback</code>。<code>Spring-Retry</code>还提供了<code>@Recover</code>注解，用于@Retryable重试失败后处理方法。如果不需要回调方法，可以直接不写回调方法，那么实现的效果是，重试次数完了后，如果还是没成功没符合业务判断，就抛出异常。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Recover</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">recover</span><span style="color:#E1E4E8;">(Exception e, </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> code){</span></span>
<span class="line"><span style="color:#E1E4E8;">  System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;回调方法执行！！！！&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">//记日志到数据库 或者调用其余的方法</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">400</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Recover</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">recover</span><span style="color:#24292E;">(Exception e, </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> code){</span></span>
<span class="line"><span style="color:#24292E;">  System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;回调方法执行！！！！&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">//记日志到数据库 或者调用其余的方法</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">400</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>可以看到传参里面写的是 <code>Exception e</code>，这个是作为回调的接头暗号（重试次数用完了，还是失败，我们抛出这个<code>Exception e</code>通知触发这个回调方法）。对于<code>@Recover</code>注解的方法，需要特别注意的是：</p><ul><li>方法的返回值必须与<code>@Retryable</code>方法一致</li><li>方法的第一个参数，必须是Throwable类型的，建议是与<code>@Retryable</code>配置的异常一致，其他的参数，需要哪个参数，写进去就可以了（<code>@Recover</code>方法中有的）</li><li>该回调方法与重试方法写在同一个实现类里面</li></ul><p><strong>注意事项</strong></p><ul><li>由于是基于AOP实现，所以不支持类里自调用方法</li><li>如果重试失败需要给<code>@Recover</code>注解的方法做后续处理，那这个重试的方法不能有返回值，只能是void</li><li>方法内不能使用<code>try catch</code>，只能往外抛异常</li><li><code>@Recover</code>注解来开启重试失败后调用的方法(注意,需跟重处理方法在同一个类中)，此注解注释的方法参数一定要是<code>@Retryable</code>抛出的异常，否则无法识别，可以在该方法中进行日志处理。</li></ul></blockquote></div></div></main><footer class="VPDocFooter" data-v-6b87e69f data-v-ef5dee53><!--[--><!--]--><div class="edit-info" data-v-ef5dee53><!----><div class="last-updated" data-v-ef5dee53><p class="VPLastUpdated" data-v-ef5dee53 data-v-7e05ebdb>Last updated: <time datetime="2023-10-13T05:48:28.000Z" data-v-7e05ebdb></time></p></div></div><nav class="prev-next" data-v-ef5dee53><div class="pager" data-v-ef5dee53><!----></div><div class="pager" data-v-ef5dee53><a class="pager-link next" href="/framework/springBoot.html" data-v-ef5dee53><span class="desc" data-v-ef5dee53>Next page</span><span class="title" data-v-ef5dee53>springBoot</span></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"alg_algorithm_二分查找.md\":\"5daae138\",\"books_book0002_00开篇_index.md\":\"bd860ba8\",\"alg_algorithm_复杂度.md\":\"8261d15f\",\"alg_structure_哈希表.md\":\"31ee2697\",\"books_book0002_01基础_01-高并发系统：它的通用设计方法是什么？.md\":\"7b0fe2a2\",\"books_book0002_05演进-分布式服务_23-rpc框架：10万qps下如何实现毫秒级的服务调用？.md\":\"7014f621\",\"books_book0002_08结束_结束语-学不可以已.md\":\"e2d8c12a\",\"books_book0002_01基础_03-系统设计目标（一）：如何提升系统性能？.md\":\"828a371b\",\"alg_algorithm_滑动窗口.md\":\"f23b7fce\",\"books_book0002_04演进-消息队列_18-消息投递：如何保证消息仅仅被消费一次？.md\":\"2d4f0eb6\",\"books_book0002_05演进-分布式服务_28-多机房部署：跨地域的分布式系统如何做？.md\":\"6eaeeda8\",\"books_book0002_06演进-维护_33-配置管理：成千上万的配置项要如何管理？.md\":\"362a8aa7\",\"books_book0002_05演进-分布式服务_21-系统架构：每秒1万次请求的系统要做服务化拆分吗？.md\":\"2a72629a\",\"books_book0002_06演进-维护_31-应用性能管理：用户的使用体验应该如何监控？.md\":\"ed99301a\",\"alg_structure_二叉树.md\":\"a07eeca0\",\"books_book0002_02演进-数据库_09-数据库优化方案（二）：写入数据量增加时，如何实现分库分表？.md\":\"18bd6529\",\"books_book0002_02演进-数据库_10-发号器：如何保证分库分表后id的全局唯一性？.md\":\"89e17cad\",\"books_book0002_02演进-数据库_11-nosql：在高并发场景下，数据库和nosql如何做到互补？.md\":\"62bf4f30\",\"books_book0002_03演进-缓存_12-缓存：数据库成为瓶颈后，动态数据的查询要如何加速？.md\":\"cc6fbde1\",\"alg_algorithm_动态规划.md\":\"b4f02bd3\",\"books_book0002_07实战_38-计数系统设计（二）：50万qps下如何设计未读数系统？.md\":\"c4e51a03\",\"books_book0002_06演进-维护_34-降级熔断：如何屏蔽非核心系统故障的影响？.md\":\"cb20466b\",\"books_book0002_04演进-消息队列_20-当问到项目经历时，面试官究竟想要了解什么？.md\":\"e548f8e8\",\"alg_structure_队列与栈.md\":\"57bbdf01\",\"books_book0002_05演进-分布式服务_29-service mesh：如何屏蔽服务化系统的服务治理细节？.md\":\"95031c26\",\"books_book0002_03演进-缓存_16-cdn：静态资源如何加速？.md\":\"1dfd8901\",\"books_book0002_03演进-缓存_14-缓存的使用姿势（二）：缓存如何做到高可用？.md\":\"9690b5eb\",\"books_book0002_05演进-分布式服务_24-注册中心：分布式系统如何寻址？.md\":\"6247e583\",\"books_book0002_02演进-数据库_07-池化技术：如何减少频繁创建数据库连接的性能损耗？.md\":\"9bd7a64d\",\"books_book0002_06演进-维护_35-流量控制：高并发系统中我们如何操纵流量？.md\":\"b7bc10d8\",\"books_book0002_04演进-消息队列_17-消息队列：秒杀如何处理每秒上万的下单请求？.md\":\"653b9831\",\"bigdata_path.md\":\"2a944453\",\"alg_topic_剑指offer_index.md\":\"eaa28d56\",\"books_book0002_01基础_02-架构分层：我们为什么一定要这么做？.md\":\"68fea887\",\"books_book0002_02演进-数据库_08-数据库优化方案（一）：查询请求增加时，如何做主从分离？.md\":\"54d40457\",\"books_book0002_05演进-分布式服务_22-微服务架构：微服务化后系统架构要如何改造？.md\":\"cbdf5050\",\"books_book0002_03演进-缓存_加餐-数据的签约应该如何做？.md\":\"bc42e56f\",\"books_book0003_20230807002.md\":\"b4b18c6d\",\"books_book0002_01基础_05-系统设计目标（三）：如何让系统易于扩展？.md\":\"11e2466b\",\"books_book0002_05演进-分布式服务_26-负载均衡：怎样提升系统的横向扩展能力？.md\":\"11cb1eb0\",\"books_book0002_07实战_40-信息流设计（二）：通用信息流系统的拉模式要如何做？.md\":\"a41541be\",\"container_k8s.md\":\"98437acd\",\"books_book0002_05演进-分布式服务_27-api网关：系统的门面要如何做呢？.md\":\"f2b1d784\",\"books_book0002_05演进-分布式服务_25-分布式trace：横跨几十个分布式组件的慢请求要如何排查？.md\":\"05519a66\",\"books_book0002_03演进-缓存_15-缓存的使用姿势（三）：缓存穿透了怎么办？.md\":\"b4235165\",\"books_book0002_01基础_04-系统设计目标（二）：系统怎样做到高可用？.md\":\"14bcff24\",\"cache_memcached.md\":\"4093dca1\",\"books_book0002_07实战_39-信息流设计（一）：通用信息流系统的推模式要如何做？.md\":\"7613f5ef\",\"books_book0002_06演进-维护_32-压力测试：怎样设计全链路压力测试平台？.md\":\"e49818f2\",\"alg_algorithm_排序算法.md\":\"268d62ae\",\"books_book0002_04演进-消息队列_19-消息队列如何降低消息队列系统中消息的延迟？.md\":\"664abede\",\"database_mongodb.md\":\"1be1ec64\",\"design_灰度方案设计.md\":\"eb682bbf\",\"design_单点登录架构设计.md\":\"47c41a20\",\"design_订单系统架构设计.md\":\"57671dd0\",\"design_秒杀系统架构设计.md\":\"670a5af1\",\"books_book0002_06演进-维护_30-给系统加上眼睛：服务端监控要怎么做？.md\":\"fb165392\",\"design_接口性能优化方案.md\":\"749df1cf\",\"books_book0002_07实战_37-计数系统设计（一）：面对海量数据的计数器要如何做？.md\":\"40916437\",\"books_book0002_03演进-缓存_13-缓存的使用姿势（一）：如何选择缓存的读写策略？.md\":\"4b10b9a2\",\"database_tidb.md\":\"268bc219\",\"middleware_alibaba.md\":\"8befaba9\",\"index.md\":\"ca4aa61a\",\"container_docker.md\":\"28326345\",\"problem_20230721q1.md\":\"78773fb9\",\"bigdata_layering.md\":\"dc637b1c\",\"design_日志系统架构设计.md\":\"19d84948\",\"second_mq_kafka.md\":\"b6af4a2b\",\"middleware_task.md\":\"3018d5ce\",\"design_商城系统bff演进架构.md\":\"95aa5570\",\"database_oracle.md\":\"df608eec\",\"zeleted_standard_sonarlint.md\":\"8455cf55\",\"design_分布式id方案.md\":\"a71c7476\",\"second_cloud_hystrix.md\":\"8beb1257\",\"second_cloud_springcloudstream.md\":\"559a679a\",\"design_时间分片按照消息id查询.md\":\"1bbc8397\",\"middleware_db.md\":\"b96c9eba\",\"second_alibaba_zookeeper.md\":\"7f9df5a8\",\"second_server_nginx.md\":\"93af28d7\",\"design_电商业务架构设计.md\":\"e9f8ac41\",\"zeleted_test_jmh.md\":\"fe129a8a\",\"design_分布式事务方案.md\":\"6e891e34\",\"design_亿级数据如何快速同步es.md\":\"1deee565\",\"framework_springcloud.md\":\"986494d5\",\"books_book0001_index.md\":\"aaaefa7e\",\"problem_20230621q1.md\":\"120d174f\",\"second_flow_compileflow.md\":\"ea54f4c8\",\"second_search_elasticsearch.md\":\"c06fc2cf\",\"middleware_server.md\":\"1f16bf7e\",\"zeleted_test_mockito.md\":\"b0291a0d\",\"zeleted_util_vavr.md\":\"f5d0420f\",\"second_alibaba_seata.md\":\"ddac62d9\",\"zeleted_standard_p3c.md\":\"c02fd853\",\"container_linux.md\":\"145374a6\",\"middleware_auth.md\":\"32de4acb\",\"zeleted_test_apachejmeter.md\":\"af5b8efa\",\"zeleted_util_log.md\":\"10772815\",\"second_cloud_springcloudgateway.md\":\"3cf1cd4d\",\"second_task_powerjob.md\":\"7279e649\",\"problem_20220328q1.md\":\"4e1b5681\",\"updated_index.md\":\"019b263f\",\"java_reactive.md\":\"361e5ce1\",\"second_task_xxljob.md\":\"21d42831\",\"zeleted_test_testablemock.md\":\"35199cd9\",\"books_book0003_20230807001.md\":\"f2acc3cf\",\"zeleted_util_feilong.md\":\"4ac0997c\",\"middleware_search.md\":\"81225559\",\"second_db_druid.md\":\"8263cea6\",\"database_postgresql.md\":\"80dc00d2\",\"second_alibaba_nacos.md\":\"2c543b0c\",\"second_db_mybatisplus.md\":\"24c04436\",\"framework_springboot.md\":\"a42b6c31\",\"design_多级缓存架构设计.md\":\"7b82196a\",\"second_server_openresty.md\":\"70113c28\",\"books_book0003_20230807003.md\":\"dee40e6a\",\"zeleted_test_charles.md\":\"567b4067\",\"second_alibaba_sentinel.md\":\"0341ad0c\",\"second_cloud_openfeign.md\":\"f662bdd9\",\"zeleted_standard_ide.md\":\"675dc240\",\"middleware_mq.md\":\"ab6571a8\",\"problem_20230519q1.md\":\"92959ef3\",\"design_index.md\":\"660f7902\",\"second_flow_liteflow.md\":\"0a2139fe\",\"second_db_mybatis.md\":\"8f6fad94\",\"middleware_flow.md\":\"7a758632\",\"second_mq_rabbitmq.md\":\"bfff57ae\",\"java_jvm2.md\":\"eaab6db9\",\"second_db_canal.md\":\"4b6c5d94\",\"second_authority_satoken.md\":\"d18d5e57\",\"zeleted_standard_checkstyle.md\":\"cb78f461\",\"java_feature.md\":\"74b48f43\",\"alg_structure_数组与链表.md\":\"21b94db5\",\"second_alibaba_dubbo.md\":\"38c1ca9b\",\"second_db_shardingjdbc.md\":\"923aff3c\",\"cache_redis.md\":\"3fef8825\",\"second_mq_pulsar.md\":\"ea7a7fb3\",\"second_mq_rocketmq.md\":\"95153e7c\",\"java_jvm.md\":\"53b46b16\",\"utils_index.md\":\"7fde036e\",\"second_server_netty.md\":\"734d9475\",\"database_mysql.md\":\"77c74493\",\"java_index.md\":\"62ae0e46\",\"framework_spring.md\":\"35ad7748\",\"java_juc.md\":\"b0df85b0\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"某不知名小开发\",\"description\":\"在线文档\",\"base\":\"/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"siteTitle\":\"TheWe1\",\"logo\":\"/logo.png\",\"nav\":[{\"text\":\"更新日志\",\"link\":\"/updated/index\"},{\"text\":\"大数据\",\"items\":[{\"text\":\"大数据学习路线\",\"link\":\"/bigdata/path\"},{\"text\":\"数仓分层设计架构\",\"link\":\"/bigdata/layering\"}]},{\"text\":\"算法\",\"items\":[{\"text\":\"数据结构\",\"link\":\"/alg/structure/数组与链表\"},{\"text\":\"Java算法\",\"link\":\"/alg/algorithm/复杂度\"},{\"text\":\"剑指Offer\",\"link\":\"/alg/topic/剑指Offer/index\"},{\"text\":\"LeetCode\",\"link\":\"https://www.baidu.com\"}]},{\"text\":\"经验\",\"items\":[{\"text\":\"生产问题排查\",\"link\":\"/problem/20220328q1\"},{\"text\":\"常用工具类库\",\"link\":\"/utils/index\"}]},{\"text\":\"文献\",\"items\":[{\"text\":\"如何设计一个秒杀系统\",\"link\":\"/books/book0001/index\"},{\"text\":\"高并发系统设计40问\",\"link\":\"/books/book0002/00开篇/index\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/liuxiaowei2018\"}],\"search\":{\"provider\":\"local\"},\"lastUpdated\":\"Last Updated\",\"smoothScroll\":true,\"sidebar\":{\"/java\":[{\"text\":\"JavaSe\",\"collapsible\":true,\"items\":[{\"text\":\"Java基础\",\"link\":\"/java/index\"},{\"text\":\"Java新特性\",\"link\":\"/java/feature\"},{\"text\":\"Java多线程\",\"link\":\"/java/juc\"},{\"text\":\"Java响应式编程\",\"link\":\"/java/reactive\"},{\"text\":\"Java虚拟机\",\"link\":\"/java/jvm\"},{\"text\":\"JVM调优\",\"link\":\"/java/jvm2\"}]}],\"/alg/structure\":[{\"text\":\"数据结构\",\"collapsible\":true,\"items\":[{\"text\":\"数组与链表\",\"link\":\"/alg/structure/数组与链表\"},{\"text\":\"队列与栈\",\"link\":\"/alg/structure/队列与栈\"},{\"text\":\"哈希表\",\"link\":\"/alg/structure/哈希表\"},{\"text\":\"二叉树\",\"link\":\"/alg/structure/二叉树\"}]}],\"/alg/algorithm\":[{\"text\":\"算法\",\"collapsible\":true,\"items\":[{\"text\":\"复杂度\",\"link\":\"/alg/algorithm/复杂度\"},{\"text\":\"排序算法\",\"link\":\"/alg/algorithm/排序算法\"},{\"text\":\"二分查找\",\"link\":\"/alg/algorithm/二分查找\"},{\"text\":\"滑动窗口\",\"link\":\"/alg/algorithm/滑动窗口\"},{\"text\":\"动态规划\",\"link\":\"/alg/algorithm/动态规划\"}]}],\"/framework\":[{\"text\":\"spring框架\",\"collapsible\":true,\"items\":[{\"text\":\"spring\",\"link\":\"/framework/spring\"},{\"text\":\"springBoot\",\"link\":\"/framework/springBoot\"},{\"text\":\"springCloud\",\"link\":\"/framework/springCloud\"}]}],\"/database\":[{\"text\":\"数据库\",\"collapsible\":true,\"items\":[{\"text\":\"mysql\",\"link\":\"/database/mysql\"},{\"text\":\"oracle\",\"link\":\"/database/oracle\"},{\"text\":\"postgreSQL\",\"link\":\"/database/postgreSQL\"},{\"text\":\"mongoDB\",\"link\":\"/database/mongoDB\"}]}],\"/cache\":[{\"text\":\"缓存\",\"collapsible\":true,\"items\":[{\"text\":\"redis\",\"link\":\"/cache/redis\"},{\"text\":\"memcached\",\"link\":\"/cache/memcached\"}]}],\"/middleware\":[{\"text\":\"中间件\",\"collapsible\":true,\"items\":[{\"text\":\"消息队列中间件\",\"link\":\"/middleware/mq\"},{\"text\":\"数据库中间件\",\"link\":\"/middleware/db\"},{\"text\":\"搜索中间件\",\"link\":\"/middleware/search\"},{\"text\":\"任务调度中间件\",\"link\":\"/middleware/task\"},{\"text\":\"工作流中间件\",\"link\":\"/middleware/flow\"},{\"text\":\"权限框架中间件\",\"link\":\"/middleware/auth\"},{\"text\":\"服务器中间件\",\"link\":\"/middleware/server\"},{\"text\":\"阿里中间件\",\"link\":\"/middleware/alibaba\"},{\"text\":\"工具类库\",\"link\":\"/middleware/utils\"}]}],\"/container\":[{\"text\":\"容器化技术\",\"collapsible\":true,\"items\":[{\"text\":\"linux\",\"link\":\"/container/linux\"},{\"text\":\"docker\",\"link\":\"/container/docker\"},{\"text\":\"k8s\",\"link\":\"/container/k8s\"}]}],\"/second/mq\":[{\"text\":\"消息中间件\",\"collapsible\":true,\"items\":[{\"text\":\"rabbitMQ\",\"link\":\"/second/mq/rabbitMQ\"},{\"text\":\"rocketMQ\",\"link\":\"/second/mq/rocketMQ\"},{\"text\":\"kafka\",\"link\":\"/second/mq/kafka\"},{\"text\":\"pluar\",\"link\":\"/second/mq/pulsar\"}]}],\"/second/db\":[{\"text\":\"数据库中间件\",\"collapsible\":true,\"items\":[{\"text\":\"mybatis\",\"link\":\"/second/db/mybatis\"},{\"text\":\"mybatisPlus\",\"link\":\"/second/db/mybatisPlus\"},{\"text\":\"druid\",\"link\":\"/second/db/druid\"},{\"text\":\"shardingJdbc\",\"link\":\"/second/db/shardingJdbc\"},{\"text\":\"canal\",\"link\":\"/second/db/canal\"}]}],\"/second/search\":[{\"text\":\"搜索中间件\",\"collapsible\":true,\"items\":[{\"text\":\"elasticsearch\",\"link\":\"/second/search/elasticsearch\"}]}],\"/second/task\":[{\"text\":\"任务调度中间件\",\"collapsible\":true,\"items\":[{\"text\":\"xxlJob\",\"link\":\"/second/task/xxlJob\"},{\"text\":\"powerJob\",\"link\":\"/second/task/powerJob\"}]}],\"/second/flow\":[{\"text\":\"工作流中间件\",\"collapsible\":true,\"items\":[{\"text\":\"compileflow\",\"link\":\"/second/flow/compileflow\"},{\"text\":\"liteflow\",\"link\":\"/second/flow/liteflow\"}]}],\"/second/server\":[{\"text\":\"服务器中间件\",\"collapsible\":true,\"items\":[{\"text\":\"nginx\",\"link\":\"/second/server/nginx\"},{\"text\":\"netty\",\"link\":\"/second/server/netty\"},{\"text\":\"openResty\",\"link\":\"/second/server/openresty\"}]}],\"/second/alibaba\":[{\"text\":\"阿里中间件\",\"collapsible\":true,\"items\":[{\"text\":\"dubbo\",\"link\":\"/second/alibaba/dubbo\"},{\"text\":\"nacos\",\"link\":\"/second/alibaba/nacos\"},{\"text\":\"seata\",\"link\":\"/second/alibaba/seata\"},{\"text\":\"sentinel\",\"link\":\"/second/alibaba/sentinel\"},{\"text\":\"zookeeper\",\"link\":\"/second/alibaba/zookeeper\"}]}],\"/second/cloud\":[{\"text\":\"SpringCloud\",\"collapsible\":true,\"items\":[{\"text\":\"springCloudOpenFeign\",\"link\":\"/second/cloud/openFeign\"},{\"text\":\"springCloudHystrix\",\"link\":\"/second/cloud/hystrix\"},{\"text\":\"springCloudGateway\",\"link\":\"/second/cloud/springCloudGateway\"},{\"text\":\"springCloudStream\",\"link\":\"/second/cloud/springCloudStream\"}]}],\"/design/\":[{\"text\":\"架构设计\",\"collapsible\":true,\"items\":[{\"text\":\"如何做好架构设计\",\"link\":\"/design/index\"},{\"text\":\"单点登录架构设计\",\"link\":\"/design/单点登录架构设计\"},{\"text\":\"多级缓存架构设计\",\"link\":\"/design/多级缓存架构设计\"},{\"text\":\"分布式ID方案\",\"link\":\"/design/分布式ID方案\"},{\"text\":\"分布式事务方案\",\"link\":\"/design/分布式事务方案\"},{\"text\":\"灰度方案设计\",\"link\":\"/design/灰度方案设计\"},{\"text\":\"接口性能优化方案\",\"link\":\"/design/接口性能优化方案\"},{\"text\":\"秒杀系统架构设计\",\"link\":\"/design/秒杀系统架构设计\"},{\"text\":\"日志系统架构设计\",\"link\":\"/design/日志系统架构设计\"},{\"text\":\"电商业务架构设计\",\"link\":\"/design/电商业务架构设计\"},{\"text\":\"订单系统架构设计\",\"link\":\"/design/订单系统架构设计\"},{\"text\":\"亿级数据如何快速同步ES\",\"link\":\"/design/亿级数据如何快速同步ES\"},{\"text\":\"商城系统BFF演进架构\",\"link\":\"/design/商城系统BFF演进架构\"},{\"text\":\"时间分片按照消息ID查询\",\"link\":\"/design/时间分片按照消息ID查询\"}]}],\"/problem\":[{\"text\":\"生产问题排查\",\"collapsible\":true,\"items\":[{\"text\":\"如何排查线上问题\",\"link\":\"/problem/20220328q1\"},{\"text\":\"服务器端口不通故障解决\",\"link\":\"/problem/20230519q1\"},{\"text\":\"k8s pod反复重启问题解决\",\"link\":\"/problem/20230621q1\"},{\"text\":\"k8s pod OMM问题修复\",\"link\":\"/problem/20230721q1\"}]}],\"/books/book0001\":[{\"text\":\"如何设计一个秒杀系统\",\"collapsible\":true,\"items\":[{\"text\":\"如何设计一个秒杀系统-许令波\",\"link\":\"/books/book0001/index\"}]}],\"/books/book0002\":[{\"text\":\"开篇\",\"collapsible\":true,\"items\":[{\"text\":\"00-开篇词-为什么你要学习高并发系统设计？\",\"link\":\"/books/book0002/00开篇/index\"}]},{\"text\":\"基础\",\"collapsible\":true,\"items\":[{\"text\":\"01-高并发系统：它的通用设计方法是什么？\",\"link\":\"/books/book0002/01基础/01-高并发系统：它的通用设计方法是什么？\"},{\"text\":\"02-架构分层：我们为什么一定要这么做？\",\"link\":\"/books/book0002/01基础/02-架构分层：我们为什么一定要这么做？\"},{\"text\":\"03-系统设计目标（一）：如何提升系统性能？\",\"link\":\"/books/book0002/01基础/03-系统设计目标（一）：如何提升系统性能？\"},{\"text\":\"04-系统设计目标（二）：系统怎样做到高可用？\",\"link\":\"/books/book0002/01基础/04-系统设计目标（二）：系统怎样做到高可用？\"},{\"text\":\"05-系统设计目标（三）：如何让系统易于扩展？\",\"link\":\"/books/book0002/01基础/05-系统设计目标（三）：如何让系统易于扩展？\"}]},{\"text\":\"演进 - 数据库篇\",\"collapsible\":true,\"items\":[{\"text\":\"07-池化技术：如何减少频繁创建数据库连接的性能损耗？\",\"link\":\"/books/book0002/02演进-数据库/07-池化技术：如何减少频繁创建数据库连接的性能损耗？\"},{\"text\":\"08-数据库优化方案（一）：查询请求增加时，如何做主从分离？\",\"link\":\"/books/book0002/02演进-数据库/08-数据库优化方案（一）：查询请求增加时，如何做主从分离？\"},{\"text\":\"09-数据库优化方案（二）：写入数据量增加时，如何实现分库分表？\",\"link\":\"/books/book0002/02演进-数据库/09-数据库优化方案（二）：写入数据量增加时，如何实现分库分表？\"},{\"text\":\"10-发号器：如何保证分库分表后ID的全局唯一性？\",\"link\":\"/books/book0002/02演进-数据库/10-发号器：如何保证分库分表后ID的全局唯一性？\"},{\"text\":\"11-NoSQL：在高并发场景下，数据库和NoSQL如何做到互补？\",\"link\":\"/books/book0002/02演进-数据库/11-NoSQL：在高并发场景下，数据库和NoSQL如何做到互补？\"}]},{\"text\":\"演进 - 缓存篇\",\"collapsible\":true,\"items\":[{\"text\":\"12-缓存：数据库成为瓶颈后，动态数据的查询要如何加速？\",\"link\":\"/books/book0002/03演进-缓存/12-缓存：数据库成为瓶颈后，动态数据的查询要如何加速？\"},{\"text\":\"13-缓存的使用姿势（一）：如何选择缓存的读写策略？\",\"link\":\"/books/book0002/03演进-缓存/13-缓存的使用姿势（一）：如何选择缓存的读写策略？\"},{\"text\":\"14-缓存的使用姿势（二）：缓存如何做到高可用？\",\"link\":\"/books/book0002/03演进-缓存/14-缓存的使用姿势（二）：缓存如何做到高可用？\"},{\"text\":\"15-缓存的使用姿势（三）：缓存穿透了怎么办？\",\"link\":\"/books/book0002/03演进-缓存/15-缓存的使用姿势（三）：缓存穿透了怎么办？\"},{\"text\":\"加餐-数据的签约应该如何做？\",\"link\":\"/books/book0002/03演进-缓存/加餐-数据的签约应该如何做？\"}]},{\"text\":\"演进 - 消息队列篇\",\"collapsible\":true,\"items\":[{\"text\":\"17-消息队列：秒杀如何处理每秒上万的下单请求？\",\"link\":\"/books/book0002/04演进-消息队列/17-消息队列：秒杀如何处理每秒上万的下单请求？\"},{\"text\":\"18-消息投递：如何保证消息仅仅被消费一次？\",\"link\":\"/books/book0002/04演进-消息队列/18-消息投递：如何保证消息仅仅被消费一次？\"},{\"text\":\"19-消息队列如何降低消息队列系统中消息的延迟？\",\"link\":\"/books/book0002/04演进-消息队列/19-消息队列如何降低消息队列系统中消息的延迟？\"},{\"text\":\"20-当问到项目经历时，面试官究竟想要了解什么？\",\"link\":\"/books/book0002/04演进-消息队列/20-当问到项目经历时，面试官究竟想要了解什么？\"}]},{\"text\":\"演进 - 分布式服务\",\"collapsible\":true,\"items\":[{\"text\":\"21-系统架构：每秒1万次请求的系统要做服务化拆分吗？\",\"link\":\"/books/book0002/05演进-分布式服务/21-系统架构：每秒1万次请求的系统要做服务化拆分吗？\"},{\"text\":\"22-微服务架构：微服务化后系统架构要如何改造？\",\"link\":\"/books/book0002/05演进-分布式服务/22-微服务架构：微服务化后系统架构要如何改造？\"},{\"text\":\"23-系统架构：每秒1万次请求的系统要做服务化拆分吗？\",\"link\":\"/books/book0002/05演进-分布式服务/23-RPC框架：10万QPS下如何实现毫秒级的服务调用？\"},{\"text\":\"24-注册中心：分布式系统如何寻址？\",\"link\":\"/books/book0002/05演进-分布式服务/24-注册中心：分布式系统如何寻址？\"},{\"text\":\"25-分布式Trace：横跨几十个分布式组件的慢请求要如何排查？\",\"link\":\"/books/book0002/05演进-分布式服务/25-分布式Trace：横跨几十个分布式组件的慢请求要如何排查？\"},{\"text\":\"26-负载均衡：怎样提升系统的横向扩展能力？\",\"link\":\"/books/book0002/05演进-分布式服务/26-负载均衡：怎样提升系统的横向扩展能力？\"},{\"text\":\"27-API网关：系统的门面要如何做呢？\",\"link\":\"/books/book0002/05演进-分布式服务/27-API网关：系统的门面要如何做呢？\"},{\"text\":\"28-多机房部署：跨地域的分布式系统如何做？\",\"link\":\"/books/book0002/05演进-分布式服务/28-多机房部署：跨地域的分布式系统如何做？\"},{\"text\":\"29-Service Mesh：如何屏蔽服务化系统的服务治理细节？\",\"link\":\"/books/book0002/05演进-分布式服务/29-Service Mesh：如何屏蔽服务化系统的服务治理细节？\"}]},{\"text\":\"演进 - 维护\",\"collapsible\":true,\"items\":[{\"text\":\"30-为什么你要学习高并发系统设计？\",\"link\":\"/books/book0002/06演进-维护/30-给系统加上眼睛：服务端监控要怎么做？\"},{\"text\":\"31-应用性能管理：用户的使用体验应该如何监控？\",\"link\":\"/books/book0002/06演进-维护/31-应用性能管理：用户的使用体验应该如何监控？\"},{\"text\":\"32-压力测试：怎样设计全链路压力测试平台？\",\"link\":\"/books/book0002/06演进-维护/32-压力测试：怎样设计全链路压力测试平台？\"},{\"text\":\"33-配置管理：成千上万的配置项要如何管理？\",\"link\":\"/books/book0002/06演进-维护/33-配置管理：成千上万的配置项要如何管理？\"},{\"text\":\"34-降级熔断：如何屏蔽非核心系统故障的影响？\",\"link\":\"/books/book0002/06演进-维护/34-降级熔断：如何屏蔽非核心系统故障的影响？\"},{\"text\":\"35-流量控制：高并发系统中我们如何操纵流量？\",\"link\":\"/books/book0002/06演进-维护/35-流量控制：高并发系统中我们如何操纵流量？\"}]},{\"text\":\"实战\",\"collapsible\":true,\"items\":[{\"text\":\"37-计数系统设计（一）：面对海量数据的计数器要如何做？\",\"link\":\"/books/book0002/07实战/37-计数系统设计（一）：面对海量数据的计数器要如何做？\"},{\"text\":\"38-计数系统设计（二）：50万QPS下如何设计未读数系统？\",\"link\":\"/books/book0002/07实战/38-计数系统设计（二）：50万QPS下如何设计未读数系统？\"},{\"text\":\"39-信息流设计（一）：通用信息流系统的推模式要如何做？\",\"link\":\"/books/book0002/07实战/39-信息流设计（一）：通用信息流系统的推模式要如何做？\"},{\"text\":\"40-信息流设计（二）：通用信息流系统的拉模式要如何做？\",\"link\":\"/books/book0002/07实战/40-信息流设计（二）：通用信息流系统的拉模式要如何做？\"}]},{\"text\":\"结束\",\"collapsible\":true,\"items\":[{\"text\":\"结束语-学不可以已\",\"link\":\"/books/book0002/08结束/结束语-学不可以已\"}]}]}},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}");</script>
    
  </body>
</html>