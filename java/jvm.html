<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Java虚拟机 | 某不知名小开发</title>
    <meta name="description" content="在线文档">
    <link rel="preload stylesheet" href="/assets/style.edc773f7.css" as="style">
    
    <script type="module" src="/assets/app.562b944e.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.8048b864.js">
    <link rel="modulepreload" href="/assets/chunks/theme.0499af2d.js">
    <link rel="modulepreload" href="/assets/java_jvm.md.9e61a16e.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5a346dfe><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-5a346dfe data-v-ae24b3ad><div class="VPNavBar has-sidebar" data-v-ae24b3ad data-v-a0fd61f4><div class="container" data-v-a0fd61f4><div class="title" data-v-a0fd61f4><div class="VPNavBarTitle has-sidebar" data-v-a0fd61f4 data-v-86d1bed8><a class="title" href="/" data-v-86d1bed8><!--[--><!--]--><!--[--><img class="VPImage logo" src="/logo.png" alt data-v-8426fc1a><!--]--><!--[-->TheWe1<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-a0fd61f4><div class="curtain" data-v-a0fd61f4></div><div class="content-body" data-v-a0fd61f4><!--[--><!--]--><div class="VPNavBarSearch search" data-v-a0fd61f4><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-a0fd61f4 data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/updated/index.html" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>更新日志</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-9c007e85><span class="text" data-v-9c007e85><!----><span data-v-9c007e85>大数据</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-9c007e85><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/bigdata/path.html" data-v-43f1e123><!--[-->大数据学习路线<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/bigdata/layering.html" data-v-43f1e123><!--[-->数仓分层设计架构<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-9c007e85><span class="text" data-v-9c007e85><!----><span data-v-9c007e85>算法</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-9c007e85><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/alg/structure/index.html" data-v-43f1e123><!--[-->数据结构<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/alg/algorithm/index.html" data-v-43f1e123><!--[-->算法提升<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link vp-external-link-icon" href="https://doocs.github.io/leetcode/#/lcof2/README" target="_blank" rel="noreferrer" data-v-43f1e123><!--[-->剑指Offer<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link vp-external-link-icon" href="https://doocs.github.io/leetcode/#/" target="_blank" rel="noreferrer" data-v-43f1e123><!--[-->LeetCode<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-9c007e85><span class="text" data-v-9c007e85><!----><span data-v-9c007e85>经验</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-9c007e85><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/problem/index.html" data-v-43f1e123><!--[-->生产问题排查<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/optimize/index.html" data-v-43f1e123><!--[-->生产性能优化<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/shorthand/index.html" data-v-43f1e123><!--[-->开发过程速记<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/utils/index.html" data-v-43f1e123><!--[-->常用工具类库<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/ide/index.html" data-v-43f1e123><!--[-->常用开发工具<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-9c007e85><span class="text" data-v-9c007e85><!----><span data-v-9c007e85>文献</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-9c007e85><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/books/book0001/index.html" data-v-43f1e123><!--[-->如何设计一个秒杀系统<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/books/book0002/00%E5%BC%80%E7%AF%87/index.html" data-v-43f1e123><!--[-->高并发系统设计40问<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link" href="/books/book0003/index.html" data-v-43f1e123><!--[-->DDD领域驱动设计<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-a0fd61f4 data-v-e6aabb21><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-e6aabb21 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-a0fd61f4 data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/liuxiaowei2018" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-f80f8133><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-a0fd61f4 data-v-40855f84 data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-9c007e85><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-9c007e85><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-40855f84><div class="item appearance" data-v-40855f84><p class="label" data-v-40855f84>Appearance</p><div class="appearance-action" data-v-40855f84><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-40855f84 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-40855f84><div class="item social-links" data-v-40855f84><div class="VPSocialLinks social-links-list" data-v-40855f84 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/liuxiaowei2018" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-f80f8133><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-a0fd61f4 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav reached-top" data-v-5a346dfe data-v-79c8c1df><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-79c8c1df><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-79c8c1df><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-79c8c1df>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-79c8c1df data-v-1c15a60a><button data-v-1c15a60a>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-5a346dfe data-v-b00e2fdd><div class="curtain" data-v-b00e2fdd></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-b00e2fdd><span class="visually-hidden" id="sidebar-aria-label" data-v-b00e2fdd> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 has-active" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>JavaSe</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/java/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java基础</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/java/feature.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java新特性</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/java/juc.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java多线程</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/java/reactive.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java响应式编程</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/java/jvm.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Jvm基础</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/java/jvm2.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Jvm调优</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5a346dfe data-v-669faec9><div class="VPDoc has-sidebar has-aside" data-v-669faec9 data-v-6b87e69f><!--[--><!--]--><div class="container" data-v-6b87e69f><div class="aside" data-v-6b87e69f><div class="aside-curtain" data-v-6b87e69f></div><div class="aside-container" data-v-6b87e69f><div class="aside-content" data-v-6b87e69f><div class="VPDocAside" data-v-6b87e69f data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-3f215769 data-v-d330b1bb><div class="content" data-v-d330b1bb><div class="outline-marker" data-v-d330b1bb></div><div class="outline-title" role="heading" aria-level="2" data-v-d330b1bb>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-d330b1bb><span class="visually-hidden" id="doc-outline-aria-label" data-v-d330b1bb> Table of Contents for current page </span><ul class="root" data-v-d330b1bb data-v-d0ee3533><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-6b87e69f><div class="content-container" data-v-6b87e69f><!--[--><!--]--><!----><main class="main" data-v-6b87e69f><div style="position:relative;" class="vp-doc _java_jvm" data-v-6b87e69f><div><h1 id="java虚拟机" tabindex="-1">Java虚拟机 <a class="header-anchor" href="#java虚拟机" aria-label="Permalink to &quot;Java虚拟机&quot;">​</a></h1><nav class="table-of-contents"><ul><li><a href="#_1、jvm基础">1、jvm基础</a><ul><li><a href="#跨平台特性">跨平台特性</a></li><li><a href="#类反编译">类反编译</a></li><li><a href="#引用类型">引用类型</a></li><li><a href="#jvm启动流程">jvm启动流程</a></li><li><a href="#jni本地方法">jni本地方法</a></li><li><a href="#jvm内存模型">jvm内存模型</a></li><li><a href="#jvm堆外内存">jvm堆外内存</a></li><li><a href="#垃圾回收机制">垃圾回收机制</a></li><li><a href="#类加载机制">类加载机制</a></li></ul></li></ul></nav><h2 id="_1、jvm基础" tabindex="-1">1、jvm基础 <a class="header-anchor" href="#_1、jvm基础" aria-label="Permalink to &quot;1、jvm基础&quot;">​</a></h2><h3 id="跨平台特性" tabindex="-1">跨平台特性 <a class="header-anchor" href="#跨平台特性" aria-label="Permalink to &quot;跨平台特性&quot;">​</a></h3><p><img src="/assets/image-20220326114042857.cd840665.png" alt="image-20220326114042857"></p><blockquote><p>Java程序之所以能够实现跨平台，本质就是因为它是运行在虚拟机之上的，而不同平台只需要安装对应平台的Java虚拟机即可运行（在JRE中包含），所有的Java程序都采用统一的标准，在任何平台编译出来的字节码文件(.class)也是同样的，最后实际上是将编译后的字节码交给JVM处理执行。</p><p>除了Java以外，还有多种JVM语言，比如Kotlin、Groovy等，它们的语法虽然和Java不一样，但是最终编译得到的字节码文件，和Java是同样的规范，同样可以交给JVM处理。</p></blockquote><blockquote><p>Java利用了JVM，它提供了很好的平台无关性（当然，JVM本身是不跨平台的），我们的Java程序编译之后，并不是可以由平台直接运行的程序，而是由JVM运行，同时，JVM（如HotSpot虚拟机），实际上采用的是<code>基于栈的指令集架构</code>，它并没有依赖于寄存器，而是更多的利用操作栈来完成，这样不仅设计和实现起来更简单，并且也能够更加方便地实现跨平台，不太依赖于硬件的支持。</p></blockquote><h3 id="类反编译" tabindex="-1">类反编译 <a class="header-anchor" href="#类反编译" aria-label="Permalink to &quot;类反编译&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">test</span><span style="color:#E1E4E8;">(){</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> b;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> c;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">test</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> b;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> c;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><blockquote><p><code>javap -v Main.class</code></p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">...</span></span>
<span class="line"><span style="color:#e1e4e8;">public int test();</span></span>
<span class="line"><span style="color:#e1e4e8;">descriptor: ()I</span></span>
<span class="line"><span style="color:#e1e4e8;">flags: ACC_PUBLIC</span></span>
<span class="line"><span style="color:#e1e4e8;">Code:</span></span>
<span class="line"><span style="color:#e1e4e8;"> stack=2, locals=4, args_size=1</span></span>
<span class="line"><span style="color:#e1e4e8;">    0: bipush        10</span></span>
<span class="line"><span style="color:#e1e4e8;">    2: istore_1</span></span>
<span class="line"><span style="color:#e1e4e8;">    3: bipush        20</span></span>
<span class="line"><span style="color:#e1e4e8;">    5: istore_2</span></span>
<span class="line"><span style="color:#e1e4e8;">    6: iload_1</span></span>
<span class="line"><span style="color:#e1e4e8;">    7: iload_2</span></span>
<span class="line"><span style="color:#e1e4e8;">    8: iadd</span></span>
<span class="line"><span style="color:#e1e4e8;">    9: istore_3</span></span>
<span class="line"><span style="color:#e1e4e8;">   10: iload_3</span></span>
<span class="line"><span style="color:#e1e4e8;">   11: ireturn</span></span>
<span class="line"><span style="color:#e1e4e8;"> LineNumberTable:</span></span>
<span class="line"><span style="color:#e1e4e8;">   line 5: 0</span></span>
<span class="line"><span style="color:#e1e4e8;">   line 6: 3</span></span>
<span class="line"><span style="color:#e1e4e8;">   line 7: 6</span></span>
<span class="line"><span style="color:#e1e4e8;">   line 8: 10</span></span>
<span class="line"><span style="color:#e1e4e8;"> LocalVariableTable:</span></span>
<span class="line"><span style="color:#e1e4e8;">   Start  Length  Slot  Name   Signature</span></span>
<span class="line"><span style="color:#e1e4e8;">       0      12     0  this   Lcom/test/Main;</span></span>
<span class="line"><span style="color:#e1e4e8;">       3       9     1     a   I</span></span>
<span class="line"><span style="color:#e1e4e8;">       6       6     2     b   I</span></span>
<span class="line"><span style="color:#e1e4e8;">      10       2     3     c   I</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">...</span></span>
<span class="line"><span style="color:#24292e;">public int test();</span></span>
<span class="line"><span style="color:#24292e;">descriptor: ()I</span></span>
<span class="line"><span style="color:#24292e;">flags: ACC_PUBLIC</span></span>
<span class="line"><span style="color:#24292e;">Code:</span></span>
<span class="line"><span style="color:#24292e;"> stack=2, locals=4, args_size=1</span></span>
<span class="line"><span style="color:#24292e;">    0: bipush        10</span></span>
<span class="line"><span style="color:#24292e;">    2: istore_1</span></span>
<span class="line"><span style="color:#24292e;">    3: bipush        20</span></span>
<span class="line"><span style="color:#24292e;">    5: istore_2</span></span>
<span class="line"><span style="color:#24292e;">    6: iload_1</span></span>
<span class="line"><span style="color:#24292e;">    7: iload_2</span></span>
<span class="line"><span style="color:#24292e;">    8: iadd</span></span>
<span class="line"><span style="color:#24292e;">    9: istore_3</span></span>
<span class="line"><span style="color:#24292e;">   10: iload_3</span></span>
<span class="line"><span style="color:#24292e;">   11: ireturn</span></span>
<span class="line"><span style="color:#24292e;"> LineNumberTable:</span></span>
<span class="line"><span style="color:#24292e;">   line 5: 0</span></span>
<span class="line"><span style="color:#24292e;">   line 6: 3</span></span>
<span class="line"><span style="color:#24292e;">   line 7: 6</span></span>
<span class="line"><span style="color:#24292e;">   line 8: 10</span></span>
<span class="line"><span style="color:#24292e;"> LocalVariableTable:</span></span>
<span class="line"><span style="color:#24292e;">   Start  Length  Slot  Name   Signature</span></span>
<span class="line"><span style="color:#24292e;">       0      12     0  this   Lcom/test/Main;</span></span>
<span class="line"><span style="color:#24292e;">       3       9     1     a   I</span></span>
<span class="line"><span style="color:#24292e;">       6       6     2     b   I</span></span>
<span class="line"><span style="color:#24292e;">      10       2     3     c   I</span></span></code></pre></div><blockquote><p>java文件编译之后，也会生成类似于C语言那样的汇编指令，但是这些命令都是交给JVM去执行的命令（实际上虚拟机提供了一个类似于物理机的运行环境，也有程序计数器之类的东西），最下方存放的是本地变量（局部变量）表，表示此方法中出现的本地变量，实际上this也在其中，所以我们才能在非静态方法中使用<code>this</code>关键字，在最上方标记了方法的返回值类型、访问权限等。</p><ul><li>bipush 将单字节的常量值推到栈顶 <ul><li>istore_1 将栈顶的int类型数值存入到第二个本地变量</li><li>istore_2 将栈顶的int类型数值存入到第三个本地变量</li><li>istore_3 将栈顶的int类型数值存入到第四个本地变量</li><li>iload_1 将第二个本地变量推向栈顶</li></ul></li><li>iload_2 将第三个本地变量推向栈顶</li><li>iload_3 将第四个本地变量推向栈顶</li><li>iadd 将栈顶的两个int类型变量相加，并将结果压入栈顶</li><li>ireturn 方法的返回操作</li></ul><p>JVM运行字节码时，所有的操作基本都是围绕两种数据结构，一种是堆栈（本质是栈结构），还有一种是队列，如果JVM执行某条指令时，该指令需要对数据进行操作，那么被操作的数据在指令执行前，必须要压到堆栈上，JVM会自动将栈顶数据作为操作数。如果堆栈上的数据需要暂时保存起来时，那么它就会被存储到局部变量队列上。</p><p>我们从第一条指令来依次向下解读，显示方法相关属性：</p><pre><code>  descriptor: ()I     //参数以及返回值类型，()I就表示没有形式参数，返回值为基本类型int
  flags: ACC_PUBLIC   //public访问权限
  Code:
     stack=2, locals=4, args_size=1    //stack表示要用到的最大栈深度，本地变量数，堆栈上最大对象数量（这里指的是this）
</code></pre></blockquote><blockquote><p>接着我们来看指令：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"> 0: bipush        10     //0是程序偏移地址，然后是指令，最后是操作数</span></span>
<span class="line"><span style="color:#e1e4e8;"> 2: istore_1</span></span>
<span class="line"><span style="color:#e1e4e8;"> ```</span></span>
<span class="line"><span style="color:#e1e4e8;"> </span></span>
<span class="line"><span style="color:#e1e4e8;">这一步操作实际上就是使用`bipush`将10推向栈顶，接着使用`istore_1`将当前栈顶数据存放到第二个局部变量中，也就是a，所以这一步执行的是`int a = 10`操作。</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"> 0: bipush        10     //0是程序偏移地址，然后是指令，最后是操作数</span></span>
<span class="line"><span style="color:#24292e;"> 2: istore_1</span></span>
<span class="line"><span style="color:#24292e;"> ```</span></span>
<span class="line"><span style="color:#24292e;"> </span></span>
<span class="line"><span style="color:#24292e;">这一步操作实际上就是使用`bipush`将10推向栈顶，接着使用`istore_1`将当前栈顶数据存放到第二个局部变量中，也就是a，所以这一步执行的是`int a = 10`操作。</span></span></code></pre></div><p>3: bipush 20 5: istore_2</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">同上，这里执行的是`int b = 20`操作。</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">同上，这里执行的是`int b = 20`操作。</span></span></code></pre></div><p>6: iload_1 7: iload_2 8: iadd ```</p><pre><code>这里是将第二和第三个局部变量放到栈中，也就是取a和b的值到栈中，最后`iadd`操作将栈中的两个值相加，结果依然放在栈顶。

```
9: istore_3
10: iload_3
11: ireturn
```

将栈顶数据存放到第四个局部变量中，也就是c，执行的是`int c = 30`，最后取出c的值放入栈顶，使用`ireturn`返回栈顶值，也就是方法的返回值。

至此，方法执行完毕。
</code></pre></blockquote><blockquote><p>实际上我们发现，JVM执行的命令基本都是入栈出栈等，而且大部分指令都是没有操作数的，传统的汇编指令有一操作数、二操作数甚至三操作数的指令，Java相比C编译出来的汇编指令，执行起来会更加复杂，实现某个功能的指令条数也会更多，所以Java的执行效率实际上是不如C/C++的，虽然能够很方便地实现跨平台，但是性能上大打折扣，所以在性能要求比较苛刻的Android上，采用的是定制版的JVM，并且是基于寄存器的指令集架构。此外，在某些情况下，我们还可以使用JNI机制来通过Java调用C/C++编写的程序以提升性能（也就是本地方法，使用到native关键字）</p></blockquote><h3 id="引用类型" tabindex="-1">引用类型 <a class="header-anchor" href="#引用类型" aria-label="Permalink to &quot;引用类型&quot;">​</a></h3><blockquote><p>Java中4种引用的级别由高到低依次为： <strong>强引用 &gt; 软引用 &gt; 弱引用 &gt; 虚引用</strong></p></blockquote><h4 id="强引用" tabindex="-1">强引用 <a class="header-anchor" href="#强引用" aria-label="Permalink to &quot;强引用&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">Object obj = new Object();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">Object obj = new Object();</span></span></code></pre></div><h4 id="软引用" tabindex="-1">软引用 <a class="header-anchor" href="#软引用" aria-label="Permalink to &quot;软引用&quot;">​</a></h4><blockquote><p>软引用不像强引用那样不可回收，当 JVM 认为内存不足时，会去试图回收软引用指向的对象，即JVM 会确保在抛出 OutOfMemoryError 之前，清理软引用指向的对象。当然，如果内存充足，那么是不会轻易被回收的。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">//强引用写法：Object obj = new Object();</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">//软引用写法：</span></span>
<span class="line"><span style="color:#E1E4E8;">  SoftReference&lt;</span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">&gt; reference </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> SoftReference&lt;&gt;(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Object</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">//使用get方法就可以获取到软引用所指向的对象了</span></span>
<span class="line"><span style="color:#E1E4E8;">  System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(reference.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">//强引用写法：Object obj = new Object();</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">//软引用写法：</span></span>
<span class="line"><span style="color:#24292E;">  SoftReference&lt;</span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; reference </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> SoftReference&lt;&gt;(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Object</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">//使用get方法就可以获取到软引用所指向的对象了</span></span>
<span class="line"><span style="color:#24292E;">  System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(reference.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>软引用还存在一个带队列的构造方法，软引用可以和一个引用队列（ReferenceQueue）联合使用，如果软引用所引用的对象被垃圾回收器回收，Java虚拟机就会把这个软引用加入到与之关联的引用队列中。</p></blockquote><h4 id="弱应用" tabindex="-1">弱应用 <a class="header-anchor" href="#弱应用" aria-label="Permalink to &quot;弱应用&quot;">​</a></h4><blockquote><p>弱引用比软引用的生命周期还要短，在进行垃圾回收时，不管当前内存空间是否充足，都会回收它的内存。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">//弱引用写法：</span></span>
<span class="line"><span style="color:#E1E4E8;">  WeakReference&lt;</span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">&gt; reference </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> WeakReference&lt;&gt;(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Object</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">  System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(reference.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">//弱引用写法：</span></span>
<span class="line"><span style="color:#24292E;">  WeakReference&lt;</span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; reference </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> WeakReference&lt;&gt;(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Object</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">  System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(reference.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>使用方法和软引用是差不多的，但是如果我们在这之前手动进行一次GC：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">       SoftReference&lt;</span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">&gt; softReference </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> SoftReference&lt;&gt;(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Object</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">       WeakReference&lt;</span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">&gt; weakReference </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> WeakReference&lt;&gt;(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Object</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">//手动GC</span></span>
<span class="line"><span style="color:#E1E4E8;">       System.</span><span style="color:#B392F0;">gc</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;软引用对象：&quot;</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">softReference.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">       System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;弱引用对象：&quot;</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">weakReference.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">       SoftReference&lt;</span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; softReference </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> SoftReference&lt;&gt;(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Object</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">       WeakReference&lt;</span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; weakReference </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> WeakReference&lt;&gt;(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Object</span><span style="color:#24292E;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6A737D;">//手动GC</span></span>
<span class="line"><span style="color:#24292E;">       System.</span><span style="color:#6F42C1;">gc</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;软引用对象：&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">softReference.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">       System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;弱引用对象：&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">weakReference.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>可以看到，弱引用对象直接就被回收了，而软引用对象没有被回收。同样的，它也支持ReferenceQueue</p><p><code>WeakHashMap</code>正是一种类似于弱引用的HashMap类，如果Map中的Key没有其他引用那么此Map会自动丢弃此键值对。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">       Integer a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Integer</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       WeakHashMap&lt;</span><span style="color:#F97583;">Integer</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">&gt; weakHashMap </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> WeakHashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#E1E4E8;">       weakHashMap.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(a, </span><span style="color:#9ECBFF;">&quot;yyds&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">       System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(weakHashMap);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">       System.</span><span style="color:#B392F0;">gc</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(weakHashMap);</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">       Integer a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Integer</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       WeakHashMap&lt;</span><span style="color:#D73A49;">Integer</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">String</span><span style="color:#24292E;">&gt; weakHashMap </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> WeakHashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#24292E;">       weakHashMap.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(a, </span><span style="color:#032F62;">&quot;yyds&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">       System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(weakHashMap);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">       System.</span><span style="color:#6F42C1;">gc</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(weakHashMap);</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>可以看到，当变量a的引用断开后，这时只有WeakHashMap本身对此对象存在引用，所以在GC之后，这个键值对就自动被舍弃了。所以说这玩意，就挺适合拿去做缓存的。</p></blockquote><h4 id="虚引用" tabindex="-1">虚引用 <a class="header-anchor" href="#虚引用" aria-label="Permalink to &quot;虚引用&quot;">​</a></h4><blockquote><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">PhantomReference</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">T</span><span style="color:#E1E4E8;">&gt; </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Reference</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">T</span><span style="color:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> T </span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">PhantomReference</span><span style="color:#E1E4E8;">(T </span><span style="color:#FFAB70;">referent</span><span style="color:#E1E4E8;">, ReferenceQueue&lt;</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">super</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">T</span><span style="color:#E1E4E8;">&gt; </span><span style="color:#FFAB70;">q</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">super</span><span style="color:#E1E4E8;">(referent, q);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">PhantomReference</span><span style="color:#24292E;">&lt;</span><span style="color:#D73A49;">T</span><span style="color:#24292E;">&gt; </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Reference</span><span style="color:#24292E;">&lt;</span><span style="color:#D73A49;">T</span><span style="color:#24292E;">&gt; {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> T </span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">PhantomReference</span><span style="color:#24292E;">(T </span><span style="color:#E36209;">referent</span><span style="color:#24292E;">, ReferenceQueue&lt;</span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">super</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">T</span><span style="color:#24292E;">&gt; </span><span style="color:#E36209;">q</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">super</span><span style="color:#24292E;">(referent, q);</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>无论调用多少次<code>get()</code>方法得到的永远都是<code>null</code>，因为虚引用本身就不算是个引用，相当于这个对象不存在任何引用，并且只能使用带队列的构造方法，以便对象被回收时接到通知。</p></blockquote><h3 id="jvm启动流程" tabindex="-1">jvm启动流程 <a class="header-anchor" href="#jvm启动流程" aria-label="Permalink to &quot;jvm启动流程&quot;">​</a></h3><blockquote><p><img src="/assets/image-20220326132516954.a3d3c088.png" alt="image-20220326132516954"></p></blockquote><p>虚拟机的启动入口位于<code>jdk/src/share/bin/java.c</code>的<code>JLI_Launch</code>函数，整个流程分为如下几个步骤：</p><ol><li>配置JVM装载环境</li><li>解析虚拟机参数</li><li>设置线程栈大小</li><li>执行JavaMain方法</li></ol><p><code>JLI_Launch</code>函数</p><blockquote><p>入口点的参数有很多个，其中包括当前的完整版本名称、简短版本名称、运行参数、程序名称、启动器名称等</p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">int</span></span>
<span class="line"><span style="color:#e1e4e8;">JLI_Launch(int argc, char ** argv,              /* main argc, argc */</span></span>
<span class="line"><span style="color:#e1e4e8;">        int jargc, const char** jargv,          /* java args */</span></span>
<span class="line"><span style="color:#e1e4e8;">        int appclassc, const char** appclassv,  /* app classpath */</span></span>
<span class="line"><span style="color:#e1e4e8;">        const char* fullversion,                /* full version defined */</span></span>
<span class="line"><span style="color:#e1e4e8;">        const char* dotversion,                 /* dot version defined */</span></span>
<span class="line"><span style="color:#e1e4e8;">        const char* pname,                      /* program name */</span></span>
<span class="line"><span style="color:#e1e4e8;">        const char* lname,                      /* launcher name */</span></span>
<span class="line"><span style="color:#e1e4e8;">        jboolean javaargs,                      /* JAVA_ARGS */</span></span>
<span class="line"><span style="color:#e1e4e8;">        jboolean cpwildcard,                    /* classpath wildcard */</span></span>
<span class="line"><span style="color:#e1e4e8;">        jboolean javaw,                         /* windows-only javaw */</span></span>
<span class="line"><span style="color:#e1e4e8;">        jint     ergo_class                     /* ergnomics policy */</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">int</span></span>
<span class="line"><span style="color:#24292e;">JLI_Launch(int argc, char ** argv,              /* main argc, argc */</span></span>
<span class="line"><span style="color:#24292e;">        int jargc, const char** jargv,          /* java args */</span></span>
<span class="line"><span style="color:#24292e;">        int appclassc, const char** appclassv,  /* app classpath */</span></span>
<span class="line"><span style="color:#24292e;">        const char* fullversion,                /* full version defined */</span></span>
<span class="line"><span style="color:#24292e;">        const char* dotversion,                 /* dot version defined */</span></span>
<span class="line"><span style="color:#24292e;">        const char* pname,                      /* program name */</span></span>
<span class="line"><span style="color:#24292e;">        const char* lname,                      /* launcher name */</span></span>
<span class="line"><span style="color:#24292e;">        jboolean javaargs,                      /* JAVA_ARGS */</span></span>
<span class="line"><span style="color:#24292e;">        jboolean cpwildcard,                    /* classpath wildcard */</span></span>
<span class="line"><span style="color:#24292e;">        jboolean javaw,                         /* windows-only javaw */</span></span>
<span class="line"><span style="color:#24292e;">        jint     ergo_class                     /* ergnomics policy */</span></span>
<span class="line"><span style="color:#24292e;">);</span></span></code></pre></div><blockquote><p>首先进行一些初始化操作以及Debug信息打印配置等：</p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">InitLauncher(javaw);</span></span>
<span class="line"><span style="color:#e1e4e8;">DumpState();</span></span>
<span class="line"><span style="color:#e1e4e8;">if (JLI_IsTraceLauncher()) {</span></span>
<span class="line"><span style="color:#e1e4e8;">    int i;</span></span>
<span class="line"><span style="color:#e1e4e8;">    printf(&quot;Command line args:\n&quot;);</span></span>
<span class="line"><span style="color:#e1e4e8;">    for (i = 0; i &lt; argc ; i++) {</span></span>
<span class="line"><span style="color:#e1e4e8;">        printf(&quot;argv[%d] = %s\n&quot;, i, argv[i]);</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;">    AddOption(&quot;-Dsun.java.launcher.diag=true&quot;, NULL);</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">InitLauncher(javaw);</span></span>
<span class="line"><span style="color:#24292e;">DumpState();</span></span>
<span class="line"><span style="color:#24292e;">if (JLI_IsTraceLauncher()) {</span></span>
<span class="line"><span style="color:#24292e;">    int i;</span></span>
<span class="line"><span style="color:#24292e;">    printf(&quot;Command line args:\n&quot;);</span></span>
<span class="line"><span style="color:#24292e;">    for (i = 0; i &lt; argc ; i++) {</span></span>
<span class="line"><span style="color:#24292e;">        printf(&quot;argv[%d] = %s\n&quot;, i, argv[i]);</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;">    AddOption(&quot;-Dsun.java.launcher.diag=true&quot;, NULL);</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><blockquote><p>接着就是选择一个合适的JRE版本</p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">/*</span></span>
<span class="line"><span style="color:#e1e4e8;"> * Make sure the specified version of the JRE is running.</span></span>
<span class="line"><span style="color:#e1e4e8;"> *</span></span>
<span class="line"><span style="color:#e1e4e8;"> * There are three things to note about the SelectVersion() routine:</span></span>
<span class="line"><span style="color:#e1e4e8;"> *  1) If the version running isn&#39;t correct, this routine doesn&#39;t</span></span>
<span class="line"><span style="color:#e1e4e8;"> *     return (either the correct version has been exec&#39;d or an error</span></span>
<span class="line"><span style="color:#e1e4e8;"> *     was issued).</span></span>
<span class="line"><span style="color:#e1e4e8;"> *  2) Argc and Argv in this scope are *not* altered by this routine.</span></span>
<span class="line"><span style="color:#e1e4e8;"> *     It is the responsibility of subsequent code to ignore the</span></span>
<span class="line"><span style="color:#e1e4e8;"> *     arguments handled by this routine.</span></span>
<span class="line"><span style="color:#e1e4e8;"> *  3) As a side-effect, the variable &quot;main_class&quot; is guaranteed to</span></span>
<span class="line"><span style="color:#e1e4e8;"> *     be set (if it should ever be set).  This isn&#39;t exactly the</span></span>
<span class="line"><span style="color:#e1e4e8;"> *     poster child for structured programming, but it is a small</span></span>
<span class="line"><span style="color:#e1e4e8;"> *     price to pay for not processing a jar file operand twice.</span></span>
<span class="line"><span style="color:#e1e4e8;"> *     (Note: This side effect has been disabled.  See comment on</span></span>
<span class="line"><span style="color:#e1e4e8;"> *     bugid 5030265 below.)</span></span>
<span class="line"><span style="color:#e1e4e8;"> */</span></span>
<span class="line"><span style="color:#e1e4e8;">SelectVersion(argc, argv, &amp;main_class);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">/*</span></span>
<span class="line"><span style="color:#24292e;"> * Make sure the specified version of the JRE is running.</span></span>
<span class="line"><span style="color:#24292e;"> *</span></span>
<span class="line"><span style="color:#24292e;"> * There are three things to note about the SelectVersion() routine:</span></span>
<span class="line"><span style="color:#24292e;"> *  1) If the version running isn&#39;t correct, this routine doesn&#39;t</span></span>
<span class="line"><span style="color:#24292e;"> *     return (either the correct version has been exec&#39;d or an error</span></span>
<span class="line"><span style="color:#24292e;"> *     was issued).</span></span>
<span class="line"><span style="color:#24292e;"> *  2) Argc and Argv in this scope are *not* altered by this routine.</span></span>
<span class="line"><span style="color:#24292e;"> *     It is the responsibility of subsequent code to ignore the</span></span>
<span class="line"><span style="color:#24292e;"> *     arguments handled by this routine.</span></span>
<span class="line"><span style="color:#24292e;"> *  3) As a side-effect, the variable &quot;main_class&quot; is guaranteed to</span></span>
<span class="line"><span style="color:#24292e;"> *     be set (if it should ever be set).  This isn&#39;t exactly the</span></span>
<span class="line"><span style="color:#24292e;"> *     poster child for structured programming, but it is a small</span></span>
<span class="line"><span style="color:#24292e;"> *     price to pay for not processing a jar file operand twice.</span></span>
<span class="line"><span style="color:#24292e;"> *     (Note: This side effect has been disabled.  See comment on</span></span>
<span class="line"><span style="color:#24292e;"> *     bugid 5030265 below.)</span></span>
<span class="line"><span style="color:#24292e;"> */</span></span>
<span class="line"><span style="color:#24292e;">SelectVersion(argc, argv, &amp;main_class);</span></span></code></pre></div><blockquote><p>接着是创建JVM执行环境，例如需要确定数据模型，是32位还是64位，以及jvm本身的一些配置在jvm.cfg文件中读取和解析</p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">CreateExecutionEnvironment(&amp;argc, &amp;argv,</span></span>
<span class="line"><span style="color:#e1e4e8;">                               jrepath, sizeof(jrepath),</span></span>
<span class="line"><span style="color:#e1e4e8;">                               jvmpath, sizeof(jvmpath),</span></span>
<span class="line"><span style="color:#e1e4e8;">                               jvmcfg,  sizeof(jvmcfg));</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">CreateExecutionEnvironment(&amp;argc, &amp;argv,</span></span>
<span class="line"><span style="color:#24292e;">                               jrepath, sizeof(jrepath),</span></span>
<span class="line"><span style="color:#24292e;">                               jvmpath, sizeof(jvmpath),</span></span>
<span class="line"><span style="color:#24292e;">                               jvmcfg,  sizeof(jvmcfg));</span></span></code></pre></div><blockquote><p>此函数只在头文件中定义，具体的实现是根据不同平台而定的。接着会动态加载jvm.so这个共享库，并把jvm.so中的相关函数导出并且初始化，而启动JVM的函数也在其中</p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">if (!LoadJavaVM(jvmpath, &amp;ifn)) {</span></span>
<span class="line"><span style="color:#e1e4e8;">    return(6);</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">if (!LoadJavaVM(jvmpath, &amp;ifn)) {</span></span>
<span class="line"><span style="color:#24292e;">    return(6);</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><blockquote><p>最后就是对JVM进行初始化</p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">return JVMInit(&amp;ifn, threadStackSize, argc, argv, mode, what, ret);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">//mac实现</span></span>
<span class="line"><span style="color:#e1e4e8;">int</span></span>
<span class="line"><span style="color:#e1e4e8;">JVMInit(InvocationFunctions* ifn, jlong threadStackSize,</span></span>
<span class="line"><span style="color:#e1e4e8;">                 int argc, char **argv,</span></span>
<span class="line"><span style="color:#e1e4e8;">                 int mode, char *what, int ret) {</span></span>
<span class="line"><span style="color:#e1e4e8;">    if (sameThread) {</span></span>
<span class="line"><span style="color:#e1e4e8;">        //无需关心....</span></span>
<span class="line"><span style="color:#e1e4e8;">    } else {</span></span>
<span class="line"><span style="color:#e1e4e8;">      	//正常情况下走这个</span></span>
<span class="line"><span style="color:#e1e4e8;">        return ContinueInNewThread(ifn, threadStackSize, argc, argv, mode, what, ret);</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">return JVMInit(&amp;ifn, threadStackSize, argc, argv, mode, what, ret);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">//mac实现</span></span>
<span class="line"><span style="color:#24292e;">int</span></span>
<span class="line"><span style="color:#24292e;">JVMInit(InvocationFunctions* ifn, jlong threadStackSize,</span></span>
<span class="line"><span style="color:#24292e;">                 int argc, char **argv,</span></span>
<span class="line"><span style="color:#24292e;">                 int mode, char *what, int ret) {</span></span>
<span class="line"><span style="color:#24292e;">    if (sameThread) {</span></span>
<span class="line"><span style="color:#24292e;">        //无需关心....</span></span>
<span class="line"><span style="color:#24292e;">    } else {</span></span>
<span class="line"><span style="color:#24292e;">      	//正常情况下走这个</span></span>
<span class="line"><span style="color:#24292e;">        return ContinueInNewThread(ifn, threadStackSize, argc, argv, mode, what, ret);</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><blockquote><p>最后进入了一个<code>ContinueInNewThread</code>函数,这个函数会创建一个新的线程来执行</p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">int</span></span>
<span class="line"><span style="color:#e1e4e8;">ContinueInNewThread(InvocationFunctions* ifn, jlong threadStackSize,</span></span>
<span class="line"><span style="color:#e1e4e8;">                    int argc, char **argv,</span></span>
<span class="line"><span style="color:#e1e4e8;">                    int mode, char *what, int ret)</span></span>
<span class="line"><span style="color:#e1e4e8;">{</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    ...</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">      rslt = ContinueInNewThread0(JavaMain, threadStackSize, (void*)&amp;args);</span></span>
<span class="line"><span style="color:#e1e4e8;">      /* If the caller has deemed there is an error we</span></span>
<span class="line"><span style="color:#e1e4e8;">       * simply return that, otherwise we return the value of</span></span>
<span class="line"><span style="color:#e1e4e8;">       * the callee</span></span>
<span class="line"><span style="color:#e1e4e8;">       */</span></span>
<span class="line"><span style="color:#e1e4e8;">      return (ret != 0) ? ret : rslt;</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">int</span></span>
<span class="line"><span style="color:#24292e;">ContinueInNewThread(InvocationFunctions* ifn, jlong threadStackSize,</span></span>
<span class="line"><span style="color:#24292e;">                    int argc, char **argv,</span></span>
<span class="line"><span style="color:#24292e;">                    int mode, char *what, int ret)</span></span>
<span class="line"><span style="color:#24292e;">{</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    ...</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">      rslt = ContinueInNewThread0(JavaMain, threadStackSize, (void*)&amp;args);</span></span>
<span class="line"><span style="color:#24292e;">      /* If the caller has deemed there is an error we</span></span>
<span class="line"><span style="color:#24292e;">       * simply return that, otherwise we return the value of</span></span>
<span class="line"><span style="color:#24292e;">       * the callee</span></span>
<span class="line"><span style="color:#24292e;">       */</span></span>
<span class="line"><span style="color:#24292e;">      return (ret != 0) ? ret : rslt;</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><blockquote><p>接着进入了一个名为<code>ContinueInNewThread0</code>的函数，可以看到它将<code>JavaMain</code>函数传入作为参数，而此函数定义的第一个参数类型是一个函数指针：</p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">int</span></span>
<span class="line"><span style="color:#e1e4e8;">ContinueInNewThread0(int (JNICALL *continuation)(void *), jlong stack_size, void * args) {</span></span>
<span class="line"><span style="color:#e1e4e8;">    int rslt;</span></span>
<span class="line"><span style="color:#e1e4e8;">    pthread_t tid;</span></span>
<span class="line"><span style="color:#e1e4e8;">    pthread_attr_t attr;</span></span>
<span class="line"><span style="color:#e1e4e8;">    pthread_attr_init(&amp;attr);</span></span>
<span class="line"><span style="color:#e1e4e8;">    pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_JOINABLE);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    if (stack_size &gt; 0) {</span></span>
<span class="line"><span style="color:#e1e4e8;">      pthread_attr_setstacksize(&amp;attr, stack_size);</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    if (pthread_create(&amp;tid, &amp;attr, (void *(*)(void*))continuation, (void*)args) == 0) {</span></span>
<span class="line"><span style="color:#e1e4e8;">      void * tmp;</span></span>
<span class="line"><span style="color:#e1e4e8;">      pthread_join(tid, &amp;tmp);</span></span>
<span class="line"><span style="color:#e1e4e8;">      rslt = (int)tmp;</span></span>
<span class="line"><span style="color:#e1e4e8;">    } else {</span></span>
<span class="line"><span style="color:#e1e4e8;">     /*</span></span>
<span class="line"><span style="color:#e1e4e8;">      * Continue execution in current thread if for some reason (e.g. out of</span></span>
<span class="line"><span style="color:#e1e4e8;">      * memory/LWP)  a new thread can&#39;t be created. This will likely fail</span></span>
<span class="line"><span style="color:#e1e4e8;">      * later in continuation as JNI_CreateJavaVM needs to create quite a</span></span>
<span class="line"><span style="color:#e1e4e8;">      * few new threads, anyway, just give it a try..</span></span>
<span class="line"><span style="color:#e1e4e8;">      */</span></span>
<span class="line"><span style="color:#e1e4e8;">      rslt = continuation(args);</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    pthread_attr_destroy(&amp;attr);</span></span>
<span class="line"><span style="color:#e1e4e8;">    return rslt;</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">int</span></span>
<span class="line"><span style="color:#24292e;">ContinueInNewThread0(int (JNICALL *continuation)(void *), jlong stack_size, void * args) {</span></span>
<span class="line"><span style="color:#24292e;">    int rslt;</span></span>
<span class="line"><span style="color:#24292e;">    pthread_t tid;</span></span>
<span class="line"><span style="color:#24292e;">    pthread_attr_t attr;</span></span>
<span class="line"><span style="color:#24292e;">    pthread_attr_init(&amp;attr);</span></span>
<span class="line"><span style="color:#24292e;">    pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_JOINABLE);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    if (stack_size &gt; 0) {</span></span>
<span class="line"><span style="color:#24292e;">      pthread_attr_setstacksize(&amp;attr, stack_size);</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    if (pthread_create(&amp;tid, &amp;attr, (void *(*)(void*))continuation, (void*)args) == 0) {</span></span>
<span class="line"><span style="color:#24292e;">      void * tmp;</span></span>
<span class="line"><span style="color:#24292e;">      pthread_join(tid, &amp;tmp);</span></span>
<span class="line"><span style="color:#24292e;">      rslt = (int)tmp;</span></span>
<span class="line"><span style="color:#24292e;">    } else {</span></span>
<span class="line"><span style="color:#24292e;">     /*</span></span>
<span class="line"><span style="color:#24292e;">      * Continue execution in current thread if for some reason (e.g. out of</span></span>
<span class="line"><span style="color:#24292e;">      * memory/LWP)  a new thread can&#39;t be created. This will likely fail</span></span>
<span class="line"><span style="color:#24292e;">      * later in continuation as JNI_CreateJavaVM needs to create quite a</span></span>
<span class="line"><span style="color:#24292e;">      * few new threads, anyway, just give it a try..</span></span>
<span class="line"><span style="color:#24292e;">      */</span></span>
<span class="line"><span style="color:#24292e;">      rslt = continuation(args);</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    pthread_attr_destroy(&amp;attr);</span></span>
<span class="line"><span style="color:#24292e;">    return rslt;</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><blockquote><p>最后实际上是在新的线程中执行<code>JavaMain</code>函数，最后我们再来看看此函数里面做了什么事情：</p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">/* Initialize the virtual machine */</span></span>
<span class="line"><span style="color:#e1e4e8;">start = CounterGet();</span></span>
<span class="line"><span style="color:#e1e4e8;">if (!InitializeJVM(&amp;vm, &amp;env, &amp;ifn)) {</span></span>
<span class="line"><span style="color:#e1e4e8;">    JLI_ReportErrorMessage(JVM_ERROR1);</span></span>
<span class="line"><span style="color:#e1e4e8;">    exit(1);</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">/* Initialize the virtual machine */</span></span>
<span class="line"><span style="color:#24292e;">start = CounterGet();</span></span>
<span class="line"><span style="color:#24292e;">if (!InitializeJVM(&amp;vm, &amp;env, &amp;ifn)) {</span></span>
<span class="line"><span style="color:#24292e;">    JLI_ReportErrorMessage(JVM_ERROR1);</span></span>
<span class="line"><span style="color:#24292e;">    exit(1);</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><blockquote><p>第一步初始化虚拟机，如果报错直接退出。接着就是加载主类（至于具体如何加载一个类，我们会放在后面进行讲解），因为主类是我们Java程序的入口点：</p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">/*</span></span>
<span class="line"><span style="color:#e1e4e8;"> * Get the application&#39;s main class.</span></span>
<span class="line"><span style="color:#e1e4e8;"> *</span></span>
<span class="line"><span style="color:#e1e4e8;"> * See bugid 5030265.  The Main-Class name has already been parsed</span></span>
<span class="line"><span style="color:#e1e4e8;"> * from the manifest, but not parsed properly for UTF-8 support.</span></span>
<span class="line"><span style="color:#e1e4e8;"> * Hence the code here ignores the value previously extracted and</span></span>
<span class="line"><span style="color:#e1e4e8;"> * uses the pre-existing code to reextract the value.  This is</span></span>
<span class="line"><span style="color:#e1e4e8;"> * possibly an end of release cycle expedient.  However, it has</span></span>
<span class="line"><span style="color:#e1e4e8;"> * also been discovered that passing some character sets through</span></span>
<span class="line"><span style="color:#e1e4e8;"> * the environment has &quot;strange&quot; behavior on some variants of</span></span>
<span class="line"><span style="color:#e1e4e8;"> * Windows.  Hence, maybe the manifest parsing code local to the</span></span>
<span class="line"><span style="color:#e1e4e8;"> * launcher should never be enhanced.</span></span>
<span class="line"><span style="color:#e1e4e8;"> *</span></span>
<span class="line"><span style="color:#e1e4e8;"> * Hence, future work should either:</span></span>
<span class="line"><span style="color:#e1e4e8;"> *     1)   Correct the local parsing code and verify that the</span></span>
<span class="line"><span style="color:#e1e4e8;"> *          Main-Class attribute gets properly passed through</span></span>
<span class="line"><span style="color:#e1e4e8;"> *          all environments,</span></span>
<span class="line"><span style="color:#e1e4e8;"> *     2)   Remove the vestages of maintaining main_class through</span></span>
<span class="line"><span style="color:#e1e4e8;"> *          the environment (and remove these comments).</span></span>
<span class="line"><span style="color:#e1e4e8;"> *</span></span>
<span class="line"><span style="color:#e1e4e8;"> * This method also correctly handles launching existing JavaFX</span></span>
<span class="line"><span style="color:#e1e4e8;"> * applications that may or may not have a Main-Class manifest entry.</span></span>
<span class="line"><span style="color:#e1e4e8;"> */</span></span>
<span class="line"><span style="color:#e1e4e8;">mainClass = LoadMainClass(env, mode, what);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">/*</span></span>
<span class="line"><span style="color:#24292e;"> * Get the application&#39;s main class.</span></span>
<span class="line"><span style="color:#24292e;"> *</span></span>
<span class="line"><span style="color:#24292e;"> * See bugid 5030265.  The Main-Class name has already been parsed</span></span>
<span class="line"><span style="color:#24292e;"> * from the manifest, but not parsed properly for UTF-8 support.</span></span>
<span class="line"><span style="color:#24292e;"> * Hence the code here ignores the value previously extracted and</span></span>
<span class="line"><span style="color:#24292e;"> * uses the pre-existing code to reextract the value.  This is</span></span>
<span class="line"><span style="color:#24292e;"> * possibly an end of release cycle expedient.  However, it has</span></span>
<span class="line"><span style="color:#24292e;"> * also been discovered that passing some character sets through</span></span>
<span class="line"><span style="color:#24292e;"> * the environment has &quot;strange&quot; behavior on some variants of</span></span>
<span class="line"><span style="color:#24292e;"> * Windows.  Hence, maybe the manifest parsing code local to the</span></span>
<span class="line"><span style="color:#24292e;"> * launcher should never be enhanced.</span></span>
<span class="line"><span style="color:#24292e;"> *</span></span>
<span class="line"><span style="color:#24292e;"> * Hence, future work should either:</span></span>
<span class="line"><span style="color:#24292e;"> *     1)   Correct the local parsing code and verify that the</span></span>
<span class="line"><span style="color:#24292e;"> *          Main-Class attribute gets properly passed through</span></span>
<span class="line"><span style="color:#24292e;"> *          all environments,</span></span>
<span class="line"><span style="color:#24292e;"> *     2)   Remove the vestages of maintaining main_class through</span></span>
<span class="line"><span style="color:#24292e;"> *          the environment (and remove these comments).</span></span>
<span class="line"><span style="color:#24292e;"> *</span></span>
<span class="line"><span style="color:#24292e;"> * This method also correctly handles launching existing JavaFX</span></span>
<span class="line"><span style="color:#24292e;"> * applications that may or may not have a Main-Class manifest entry.</span></span>
<span class="line"><span style="color:#24292e;"> */</span></span>
<span class="line"><span style="color:#24292e;">mainClass = LoadMainClass(env, mode, what);</span></span></code></pre></div><blockquote><p>某些没有主方法的Java程序比如JavaFX应用，会获取ApplicationMainClass：</p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">/*</span></span>
<span class="line"><span style="color:#e1e4e8;"> * In some cases when launching an application that needs a helper, e.g., a</span></span>
<span class="line"><span style="color:#e1e4e8;"> * JavaFX application with no main method, the mainClass will not be the</span></span>
<span class="line"><span style="color:#e1e4e8;"> * applications own main class but rather a helper class. To keep things</span></span>
<span class="line"><span style="color:#e1e4e8;"> * consistent in the UI we need to track and report the application main class.</span></span>
<span class="line"><span style="color:#e1e4e8;"> */</span></span>
<span class="line"><span style="color:#e1e4e8;">appClass = GetApplicationClass(env);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">/*</span></span>
<span class="line"><span style="color:#24292e;"> * In some cases when launching an application that needs a helper, e.g., a</span></span>
<span class="line"><span style="color:#24292e;"> * JavaFX application with no main method, the mainClass will not be the</span></span>
<span class="line"><span style="color:#24292e;"> * applications own main class but rather a helper class. To keep things</span></span>
<span class="line"><span style="color:#24292e;"> * consistent in the UI we need to track and report the application main class.</span></span>
<span class="line"><span style="color:#24292e;"> */</span></span>
<span class="line"><span style="color:#24292e;">appClass = GetApplicationClass(env);</span></span></code></pre></div><blockquote><p>初始化完成：</p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">/*</span></span>
<span class="line"><span style="color:#e1e4e8;"> * PostJVMInit uses the class name as the application name for GUI purposes,</span></span>
<span class="line"><span style="color:#e1e4e8;"> * for example, on OSX this sets the application name in the menu bar for</span></span>
<span class="line"><span style="color:#e1e4e8;"> * both SWT and JavaFX. So we&#39;ll pass the actual application class here</span></span>
<span class="line"><span style="color:#e1e4e8;"> * instead of mainClass as that may be a launcher or helper class instead</span></span>
<span class="line"><span style="color:#e1e4e8;"> * of the application class.</span></span>
<span class="line"><span style="color:#e1e4e8;"> */</span></span>
<span class="line"><span style="color:#e1e4e8;">PostJVMInit(env, appClass, vm);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">/*</span></span>
<span class="line"><span style="color:#24292e;"> * PostJVMInit uses the class name as the application name for GUI purposes,</span></span>
<span class="line"><span style="color:#24292e;"> * for example, on OSX this sets the application name in the menu bar for</span></span>
<span class="line"><span style="color:#24292e;"> * both SWT and JavaFX. So we&#39;ll pass the actual application class here</span></span>
<span class="line"><span style="color:#24292e;"> * instead of mainClass as that may be a launcher or helper class instead</span></span>
<span class="line"><span style="color:#24292e;"> * of the application class.</span></span>
<span class="line"><span style="color:#24292e;"> */</span></span>
<span class="line"><span style="color:#24292e;">PostJVMInit(env, appClass, vm);</span></span></code></pre></div><blockquote><p>接着就是获取主类中的主方法：</p></blockquote><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/*</span></span>
<span class="line"><span style="color:#6A737D;"> * The LoadMainClass not only loads the main class, it will also ensure</span></span>
<span class="line"><span style="color:#6A737D;"> * that the main method&#39;s signature is correct, therefore further checking</span></span>
<span class="line"><span style="color:#6A737D;"> * is not required. The main method is invoked here so that extraneous java</span></span>
<span class="line"><span style="color:#6A737D;"> * stacks are not in the application stack trace.</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#E1E4E8;">mainID </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">env)</span><span style="color:#F97583;">-&gt;</span><span style="color:#B392F0;">GetStaticMethodID</span><span style="color:#E1E4E8;">(env, mainClass, </span><span style="color:#9ECBFF;">&quot;main&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                   </span><span style="color:#9ECBFF;">&quot;([Ljava/lang/String;)V&quot;</span><span style="color:#E1E4E8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/*</span></span>
<span class="line"><span style="color:#6A737D;"> * The LoadMainClass not only loads the main class, it will also ensure</span></span>
<span class="line"><span style="color:#6A737D;"> * that the main method&#39;s signature is correct, therefore further checking</span></span>
<span class="line"><span style="color:#6A737D;"> * is not required. The main method is invoked here so that extraneous java</span></span>
<span class="line"><span style="color:#6A737D;"> * stacks are not in the application stack trace.</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#24292E;">mainID </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">env)</span><span style="color:#D73A49;">-&gt;</span><span style="color:#6F42C1;">GetStaticMethodID</span><span style="color:#24292E;">(env, mainClass, </span><span style="color:#032F62;">&quot;main&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                   </span><span style="color:#032F62;">&quot;([Ljava/lang/String;)V&quot;</span><span style="color:#24292E;">);</span></span></code></pre></div><blockquote><p>在字节码中<code>void main(String[] args)</code>表示为<code>([Ljava/lang/String;)V</code>我们之后会详细介绍。接着就是调用主方法了：</p></blockquote><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/* Invoke main method. */</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">env)</span><span style="color:#F97583;">-&gt;</span><span style="color:#B392F0;">CallStaticVoidMethod</span><span style="color:#E1E4E8;">(env, mainClass, mainID, mainArgs);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/* Invoke main method. */</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">env)</span><span style="color:#D73A49;">-&gt;</span><span style="color:#6F42C1;">CallStaticVoidMethod</span><span style="color:#24292E;">(env, mainClass, mainID, mainArgs);</span></span></code></pre></div><blockquote><p>调用后，我们的Java程序就开飞速运行起来，直到走到主方法的最后一行返回：</p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">/*</span></span>
<span class="line"><span style="color:#e1e4e8;"> * The launcher&#39;s exit code (in the absence of calls to</span></span>
<span class="line"><span style="color:#e1e4e8;"> * System.exit) will be non-zero if main threw an exception.</span></span>
<span class="line"><span style="color:#e1e4e8;"> */</span></span>
<span class="line"><span style="color:#e1e4e8;">ret = (*env)-&gt;ExceptionOccurred(env) == NULL ? 0 : 1;</span></span>
<span class="line"><span style="color:#e1e4e8;">LEAVE();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">/*</span></span>
<span class="line"><span style="color:#24292e;"> * The launcher&#39;s exit code (in the absence of calls to</span></span>
<span class="line"><span style="color:#24292e;"> * System.exit) will be non-zero if main threw an exception.</span></span>
<span class="line"><span style="color:#24292e;"> */</span></span>
<span class="line"><span style="color:#24292e;">ret = (*env)-&gt;ExceptionOccurred(env) == NULL ? 0 : 1;</span></span>
<span class="line"><span style="color:#24292e;">LEAVE();</span></span></code></pre></div><blockquote><p>至此，一个Java程序的运行流程结束，在最后LEAVE函数中会销毁JVM。</p></blockquote><h3 id="jni本地方法" tabindex="-1">jni本地方法 <a class="header-anchor" href="#jni本地方法" aria-label="Permalink to &quot;jni本地方法&quot;">​</a></h3><blockquote><p>Java的JNI机制，它的全称：Java Native Interface，即Java本地接口。它允许在Java虚拟机内运行的Java代码与其他编程语言（如C/C++和汇编语言）编写的程序和库进行交互（在Android开发中用得比较多）</p></blockquote><p>比如我们现在想要让C语言程序帮助我们的Java程序实现a+b的运算，首先我们需要创建一个本地方法：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">sum</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">//本地方法使用native关键字标记，无需任何实现，交给C语言实现</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">native</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">sum</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">a</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">b</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">sum</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//本地方法使用native关键字标记，无需任何实现，交给C语言实现</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">native</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sum</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#E36209;">a</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#E36209;">b</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>创建好后，接着点击构建按钮，会出现一个out文件夹，也就是生成的class文件在其中，接着我们直接生成对应的C头文件：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">javah</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-classpath</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">out/production/SimpleHelloWorld</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">./jni</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">com.test.Main</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">javah</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-classpath</span><span style="color:#24292E;"> </span><span style="color:#032F62;">out/production/SimpleHelloWorld</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">./jni</span><span style="color:#24292E;"> </span><span style="color:#032F62;">com.test.Main</span></span></code></pre></div><p>生成的头文件位于jni文件夹下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span>
<span class="line"><span style="color:#e1e4e8;">#include &lt;jni.h&gt;</span></span>
<span class="line"><span style="color:#e1e4e8;">/* Header for class com_test_Main */</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#ifndef _Included_com_test_Main</span></span>
<span class="line"><span style="color:#e1e4e8;">#define _Included_com_test_Main</span></span>
<span class="line"><span style="color:#e1e4e8;">#ifdef __cplusplus</span></span>
<span class="line"><span style="color:#e1e4e8;">extern &quot;C&quot; {</span></span>
<span class="line"><span style="color:#e1e4e8;">#endif</span></span>
<span class="line"><span style="color:#e1e4e8;">/*</span></span>
<span class="line"><span style="color:#e1e4e8;"> * Class:     com_test_Main</span></span>
<span class="line"><span style="color:#e1e4e8;"> * Method:    sum</span></span>
<span class="line"><span style="color:#e1e4e8;"> * Signature: (II)V</span></span>
<span class="line"><span style="color:#e1e4e8;"> */</span></span>
<span class="line"><span style="color:#e1e4e8;">JNIEXPORT void JNICALL Java_com_test_Main_sum</span></span>
<span class="line"><span style="color:#e1e4e8;">  (JNIEnv *, jclass, jint, jint);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#ifdef __cplusplus</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span>
<span class="line"><span style="color:#e1e4e8;">#endif</span></span>
<span class="line"><span style="color:#e1e4e8;">#endif</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span>
<span class="line"><span style="color:#24292e;">#include &lt;jni.h&gt;</span></span>
<span class="line"><span style="color:#24292e;">/* Header for class com_test_Main */</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#ifndef _Included_com_test_Main</span></span>
<span class="line"><span style="color:#24292e;">#define _Included_com_test_Main</span></span>
<span class="line"><span style="color:#24292e;">#ifdef __cplusplus</span></span>
<span class="line"><span style="color:#24292e;">extern &quot;C&quot; {</span></span>
<span class="line"><span style="color:#24292e;">#endif</span></span>
<span class="line"><span style="color:#24292e;">/*</span></span>
<span class="line"><span style="color:#24292e;"> * Class:     com_test_Main</span></span>
<span class="line"><span style="color:#24292e;"> * Method:    sum</span></span>
<span class="line"><span style="color:#24292e;"> * Signature: (II)V</span></span>
<span class="line"><span style="color:#24292e;"> */</span></span>
<span class="line"><span style="color:#24292e;">JNIEXPORT void JNICALL Java_com_test_Main_sum</span></span>
<span class="line"><span style="color:#24292e;">  (JNIEnv *, jclass, jint, jint);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#ifdef __cplusplus</span></span>
<span class="line"><span style="color:#24292e;">}</span></span>
<span class="line"><span style="color:#24292e;">#endif</span></span>
<span class="line"><span style="color:#24292e;">#endif</span></span></code></pre></div><p>接着我们在CLion中新建一个C++项目，并引入刚刚生成的头文件，并导入jni相关头文件（在JDK文件夹中）首先修改CMake文件：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">cmake_minimum_required(VERSION 3.21)</span></span>
<span class="line"><span style="color:#e1e4e8;">project(JNITest)</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">include_directories(/Library/Java/JavaVirtualMachines/zulu-8.jdk/Contents/Home/include)</span></span>
<span class="line"><span style="color:#e1e4e8;">include_directories(/Library/Java/JavaVirtualMachines/zulu-8.jdk/Contents/Home/include/darwin)</span></span>
<span class="line"><span style="color:#e1e4e8;">set(CMAKE_CXX_STANDARD 14)</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">add_executable(JNITest com_test_Main.cpp com_test_Main.h)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">cmake_minimum_required(VERSION 3.21)</span></span>
<span class="line"><span style="color:#24292e;">project(JNITest)</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">include_directories(/Library/Java/JavaVirtualMachines/zulu-8.jdk/Contents/Home/include)</span></span>
<span class="line"><span style="color:#24292e;">include_directories(/Library/Java/JavaVirtualMachines/zulu-8.jdk/Contents/Home/include/darwin)</span></span>
<span class="line"><span style="color:#24292e;">set(CMAKE_CXX_STANDARD 14)</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">add_executable(JNITest com_test_Main.cpp com_test_Main.h)</span></span></code></pre></div><p>接着就可以编写实现了，首先认识一下引用类型对照表：<img src="/assets/image-20220326132905761.e56ce339.png" alt="image-20220326132905761"></p><p>所以我们这里直接返回a+b即可：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">#include &quot;com_test_Main.h&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">JNIEXPORT jint JNICALL Java_com_test_Main_sum</span></span>
<span class="line"><span style="color:#e1e4e8;">        (JNIEnv * env, jclass clazz, jint a, jint b){</span></span>
<span class="line"><span style="color:#e1e4e8;">    return a + b;</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">#include &quot;com_test_Main.h&quot;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">JNIEXPORT jint JNICALL Java_com_test_Main_sum</span></span>
<span class="line"><span style="color:#24292e;">        (JNIEnv * env, jclass clazz, jint a, jint b){</span></span>
<span class="line"><span style="color:#24292e;">    return a + b;</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><p>接着我们就可以将cpp编译为动态链接库，在MacOS下会生成<code>.dylib</code>文件，Windows下会生成<code>.dll</code>文件，我们这里就只以MacOS为例，命令有点长，因为还需要包含JDK目录下的头文件：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">gcc</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">com_test_Main.cpp</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-I</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/Library/Java/JavaVirtualMachines/zulu-8.jdk/Contents/Home/include</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-I</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/Library/Java/JavaVirtualMachines/zulu-8.jdk/Contents/Home/include/darwin</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-fPIC</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-shared</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">test.dylib</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-lstdc++</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">gcc</span><span style="color:#24292E;"> </span><span style="color:#032F62;">com_test_Main.cpp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-I</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/Library/Java/JavaVirtualMachines/zulu-8.jdk/Contents/Home/include</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-I</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/Library/Java/JavaVirtualMachines/zulu-8.jdk/Contents/Home/include/darwin</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-fPIC</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-shared</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">test.dylib</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-lstdc++</span></span></code></pre></div><p>编译完成后，得到<code>test.dylib</code>文件，这就是动态链接库了。</p><p>最后我们再将其放到桌面，然后在Java程序中加载：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">public class Main {</span></span>
<span class="line"><span style="color:#e1e4e8;">    static {</span></span>
<span class="line"><span style="color:#e1e4e8;">        System.load(&quot;/Users/nagocoler/Desktop/test.dylib&quot;);</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    public static void main(String[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8;">        System.out.println(sum(1, 2));</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    public static native int sum(int a, int b);</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">public class Main {</span></span>
<span class="line"><span style="color:#24292e;">    static {</span></span>
<span class="line"><span style="color:#24292e;">        System.load(&quot;/Users/nagocoler/Desktop/test.dylib&quot;);</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    public static void main(String[] args) {</span></span>
<span class="line"><span style="color:#24292e;">        System.out.println(sum(1, 2));</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    public static native int sum(int a, int b);</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><p>运行，成功得到结果：<img src="/assets/image-20220326132930985.731650e4.png" alt="image-20220326132930985"></p><h3 id="jvm内存模型" tabindex="-1">jvm内存模型 <a class="header-anchor" href="#jvm内存模型" aria-label="Permalink to &quot;jvm内存模型&quot;">​</a></h3><p><img src="/assets/image-20220326133403516.d7830bcc.png" alt="image-20220326133403516"></p><blockquote><p>内存区域一共分为5个区域，其中方法区和堆是所有线程共享的区域，随着虚拟机的创建而创建，虚拟机的结束而销毁，而虚拟机栈、本地方法栈、程序计数器都是线程之间相互隔离的，每个线程都有一个自己的区域，并且线程启动时会自动创建，结束之后会自动销毁。内存划分完成之后，我们的JVM执行引擎和本地库接口，也就是Java程序开始运行之后就会根据分区合理地使用对应区域的内存了。</p></blockquote><blockquote><p>总结各个内存区域的用途：</p><ul><li>（线程独有）程序计数器：保存当前程序的执行位置。</li><li>（线程独有）虚拟机栈：通过栈帧来维持方法调用顺序，帮助控制程序有序运行。</li><li>（线程独有）本地方法栈：同上，作用与本地方法。</li><li>堆：所有的对象和数组都在这里保存。(JDK7后<strong>字符串常量池</strong>从方法区移动到了堆中)</li><li>方法区：类信息、即时编译器的代码缓存、运行时常量池。</li></ul></blockquote><h4 id="程序计数器" tabindex="-1">程序计数器 <a class="header-anchor" href="#程序计数器" aria-label="Permalink to &quot;程序计数器&quot;">​</a></h4><blockquote><p>JVM中的程序计数器可以看做是当前线程所执行字节码的行号指示器，而行号正好就指的是某一条指令，字节码解释器在工作时也会改变这个值，来指定下一条即将执行的指令。</p><p>Java的多线程也是依靠时间片轮转算法进行的，因此一个CPU同一时间也只会处理一个线程，当某个线程的时间片消耗完成后，会自动切换到下一个线程继续执行，而当前线程的执行位置会被保存到当前线程的程序计数器中，当下次轮转到此线程时，又继续根据之前的执行位置继续向下执行。</p><p>程序计数器因为只需要记录很少的信息，所以只占用很少一部分内存。</p></blockquote><h4 id="虚拟机栈" tabindex="-1">虚拟机栈 <a class="header-anchor" href="#虚拟机栈" aria-label="Permalink to &quot;虚拟机栈&quot;">​</a></h4><blockquote><p>栈结构，每个方法被执行的时候，Java虚拟机都会同步创建一个栈帧（其实就是栈里面的一个元素），栈帧中包括了当前方法的一些信息，比如局部变量表、操作数栈、动态链接、方法出口等。</p><p><img src="/assets/image-20220326160110161.9657cd88.png" alt="image-20220326160110161"></p><p><strong>局部变量表</strong>就是我们方法中的局部变量,实际上局部变量表在class文件中就已经定义好了</p><p><strong>操作数栈</strong>就是字节码执行时使用到的栈结构</p><p>每个栈帧还保存了一个<strong>可以指向当前方法所在类</strong>的运行时常量池，目的是：当前方法中如果需要调用其他方法的时候，能够从运行时常量池中找到对应的符号引用，然后将符号引用转换为直接引用，然后就能直接调用对应方法，这就是<strong>动态链接</strong></p><p><strong>方法出口</strong>，也就是方法该如何结束，是抛出异常还是正常返回</p></blockquote><h5 id="虚拟机栈运作流程" tabindex="-1">虚拟机栈运作流程 <a class="header-anchor" href="#虚拟机栈运作流程" aria-label="Permalink to &quot;虚拟机栈运作流程&quot;">​</a></h5><blockquote><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> res </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">a</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(res);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">a</span><span style="color:#E1E4E8;">(){</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">b</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">b</span><span style="color:#E1E4E8;">(){</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">c</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">c</span><span style="color:#E1E4E8;">(){</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> b;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> res </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">a</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(res);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">a</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">b</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">b</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">c</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">c</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> b;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span></code></pre></div><p>当我们的主方法执行后，会依次执行三个方法<code>a() -&gt; b() -&gt; c() -&gt; 返回</code>，反编译之后的结果：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">public com.test.</span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;">();   #这个是构造方法</span></span>
<span class="line"><span style="color:#E1E4E8;"> descriptor: ()V</span></span>
<span class="line"><span style="color:#E1E4E8;">   flags: ACC_PUBLIC</span></span>
<span class="line"><span style="color:#E1E4E8;">    Code:</span></span>
<span class="line"><span style="color:#E1E4E8;">      stack</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, locals</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, args_size</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">: aload_0</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">: invokespecial #</span><span style="color:#79B8FF;">1</span><span style="color:#6A737D;">                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">      LineNumberTable:</span></span>
<span class="line"><span style="color:#E1E4E8;">        line </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">      LocalVariableTable:</span></span>
<span class="line"><span style="color:#E1E4E8;">        Start  Length  Slot  Name   Signature</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">  this   Lcom</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">Main;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">   public </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(java.lang.String</span><span style="color:#F97583;">[]</span><span style="color:#E1E4E8;">);    #主方法</span></span>
<span class="line"><span style="color:#E1E4E8;"> descriptor: ([Ljava</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lang</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">String;)V</span></span>
<span class="line"><span style="color:#E1E4E8;">   flags: ACC_PUBLIC, ACC_STATIC</span></span>
<span class="line"><span style="color:#E1E4E8;">    Code:</span></span>
<span class="line"><span style="color:#E1E4E8;">      stack</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, locals</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, args_size</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">: invokestatic  #</span><span style="color:#79B8FF;">2</span><span style="color:#6A737D;">                  // Method a:()I</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">: istore_1</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">: getstatic     #</span><span style="color:#79B8FF;">3</span><span style="color:#6A737D;">                  // Field java/lang/System.out:Ljava/io/PrintStream;</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">: iload_1</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">: invokevirtual #</span><span style="color:#79B8FF;">4</span><span style="color:#6A737D;">                  // Method java/io/PrintStream.println:(I)V</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">11</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">      LineNumberTable:</span></span>
<span class="line"><span style="color:#E1E4E8;">        line </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">        line </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">4</span></span>
<span class="line"><span style="color:#E1E4E8;">        line </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">11</span></span>
<span class="line"><span style="color:#E1E4E8;">      LocalVariableTable:</span></span>
<span class="line"><span style="color:#E1E4E8;">        Start  Length  Slot  Name   Signature</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">  args   [Ljava</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lang</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">String;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">   res   I</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">   public </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">a</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;"> descriptor: ()I</span></span>
<span class="line"><span style="color:#E1E4E8;">   flags: ACC_PUBLIC, ACC_STATIC</span></span>
<span class="line"><span style="color:#E1E4E8;">    Code:</span></span>
<span class="line"><span style="color:#E1E4E8;">      stack</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, locals</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, args_size</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">: invokestatic  #</span><span style="color:#79B8FF;">5</span><span style="color:#6A737D;">                  // Method b:()I</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">: ireturn</span></span>
<span class="line"><span style="color:#E1E4E8;">      LineNumberTable:</span></span>
<span class="line"><span style="color:#E1E4E8;">        line </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">   public </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">b</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;"> descriptor: ()I</span></span>
<span class="line"><span style="color:#E1E4E8;">   flags: ACC_PUBLIC, ACC_STATIC</span></span>
<span class="line"><span style="color:#E1E4E8;">    Code:</span></span>
<span class="line"><span style="color:#E1E4E8;">      stack</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, locals</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, args_size</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">: invokestatic  #</span><span style="color:#79B8FF;">6</span><span style="color:#6A737D;">                  // Method c:()I</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">: ireturn</span></span>
<span class="line"><span style="color:#E1E4E8;">      LineNumberTable:</span></span>
<span class="line"><span style="color:#E1E4E8;">        line </span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">   public </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">c</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;"> descriptor: ()I</span></span>
<span class="line"><span style="color:#E1E4E8;">   flags: ACC_PUBLIC, ACC_STATIC</span></span>
<span class="line"><span style="color:#E1E4E8;">    Code:</span></span>
<span class="line"><span style="color:#E1E4E8;">      stack</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, locals</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, args_size</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">: bipush        </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">: istore_0</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">: bipush        </span><span style="color:#79B8FF;">20</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">: istore_1</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">: iload_0</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">: iload_1</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">: iadd</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">9</span><span style="color:#E1E4E8;">: ireturn</span></span>
<span class="line"><span style="color:#E1E4E8;">      LineNumberTable:</span></span>
<span class="line"><span style="color:#E1E4E8;">        line </span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">        line </span><span style="color:#79B8FF;">19</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">        line </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">6</span></span>
<span class="line"><span style="color:#E1E4E8;">      LocalVariableTable:</span></span>
<span class="line"><span style="color:#E1E4E8;">        Start  Length  Slot  Name   Signature</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">     a   I</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     b   I</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">public com.test.</span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;">();   #这个是构造方法</span></span>
<span class="line"><span style="color:#24292E;"> descriptor: ()V</span></span>
<span class="line"><span style="color:#24292E;">   flags: ACC_PUBLIC</span></span>
<span class="line"><span style="color:#24292E;">    Code:</span></span>
<span class="line"><span style="color:#24292E;">      stack</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, locals</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, args_size</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">: aload_0</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">: invokespecial #</span><span style="color:#005CC5;">1</span><span style="color:#6A737D;">                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">      LineNumberTable:</span></span>
<span class="line"><span style="color:#24292E;">        line </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">      LocalVariableTable:</span></span>
<span class="line"><span style="color:#24292E;">        Start  Length  Slot  Name   Signature</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">  this   Lcom</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">test</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">Main;</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">   public </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(java.lang.String</span><span style="color:#D73A49;">[]</span><span style="color:#24292E;">);    #主方法</span></span>
<span class="line"><span style="color:#24292E;"> descriptor: ([Ljava</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lang</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">String;)V</span></span>
<span class="line"><span style="color:#24292E;">   flags: ACC_PUBLIC, ACC_STATIC</span></span>
<span class="line"><span style="color:#24292E;">    Code:</span></span>
<span class="line"><span style="color:#24292E;">      stack</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, locals</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, args_size</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">: invokestatic  #</span><span style="color:#005CC5;">2</span><span style="color:#6A737D;">                  // Method a:()I</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">: istore_1</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">: getstatic     #</span><span style="color:#005CC5;">3</span><span style="color:#6A737D;">                  // Field java/lang/System.out:Ljava/io/PrintStream;</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">: iload_1</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">: invokevirtual #</span><span style="color:#005CC5;">4</span><span style="color:#6A737D;">                  // Method java/io/PrintStream.println:(I)V</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">11</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">      LineNumberTable:</span></span>
<span class="line"><span style="color:#24292E;">        line </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">        line </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">4</span></span>
<span class="line"><span style="color:#24292E;">        line </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">11</span></span>
<span class="line"><span style="color:#24292E;">      LocalVariableTable:</span></span>
<span class="line"><span style="color:#24292E;">        Start  Length  Slot  Name   Signature</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">12</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">  args   [Ljava</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lang</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">String;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">   res   I</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">   public </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">a</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;"> descriptor: ()I</span></span>
<span class="line"><span style="color:#24292E;">   flags: ACC_PUBLIC, ACC_STATIC</span></span>
<span class="line"><span style="color:#24292E;">    Code:</span></span>
<span class="line"><span style="color:#24292E;">      stack</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, locals</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, args_size</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">: invokestatic  #</span><span style="color:#005CC5;">5</span><span style="color:#6A737D;">                  // Method b:()I</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">: ireturn</span></span>
<span class="line"><span style="color:#24292E;">      LineNumberTable:</span></span>
<span class="line"><span style="color:#24292E;">        line </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">   public </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">b</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;"> descriptor: ()I</span></span>
<span class="line"><span style="color:#24292E;">   flags: ACC_PUBLIC, ACC_STATIC</span></span>
<span class="line"><span style="color:#24292E;">    Code:</span></span>
<span class="line"><span style="color:#24292E;">      stack</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, locals</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, args_size</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">: invokestatic  #</span><span style="color:#005CC5;">6</span><span style="color:#6A737D;">                  // Method c:()I</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">: ireturn</span></span>
<span class="line"><span style="color:#24292E;">      LineNumberTable:</span></span>
<span class="line"><span style="color:#24292E;">        line </span><span style="color:#005CC5;">14</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">   public </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">c</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;"> descriptor: ()I</span></span>
<span class="line"><span style="color:#24292E;">   flags: ACC_PUBLIC, ACC_STATIC</span></span>
<span class="line"><span style="color:#24292E;">    Code:</span></span>
<span class="line"><span style="color:#24292E;">      stack</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, locals</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, args_size</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">: bipush        </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">: istore_0</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">: bipush        </span><span style="color:#005CC5;">20</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">: istore_1</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">: iload_0</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">: iload_1</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">: iadd</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">9</span><span style="color:#24292E;">: ireturn</span></span>
<span class="line"><span style="color:#24292E;">      LineNumberTable:</span></span>
<span class="line"><span style="color:#24292E;">        line </span><span style="color:#005CC5;">18</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">        line </span><span style="color:#005CC5;">19</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">        line </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">6</span></span>
<span class="line"><span style="color:#24292E;">      LocalVariableTable:</span></span>
<span class="line"><span style="color:#24292E;">        Start  Length  Slot  Name   Signature</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">     a   I</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     b   I</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span></code></pre></div><p>编译之后，我们整个方法的最大操作数栈深度、局部变量表都是已经确定好的，当我们程序开始执行时，会根据这些信息封装为对应的栈帧，我们从<code>main</code>方法开始看起：</p><p><img src="/assets/image-20220326160434325.916108c6.png" alt="image-20220326160434325"></p><p>接着我们继续往下，到了<code> 0: invokestatic #2 // Method a:()I</code>时，需要调用方法<code>a()</code>，这时当前方法就不会继续向下运行了，而是去执行方法<code>a()</code>，那么同样的，将此方法也入栈，注意是放入到栈顶位置，<code>main</code>方法的栈帧会被压下去：</p><p><img src="/assets/image-20220326160449689.1749ff89.png" alt="image-20220326160449689"></p><p>这时，进入方法a之后，又继而进入到方法b，最后在进入c，因此，到达方法c的时候，我们的虚拟机栈变成了：</p><p><img src="/assets/image-20220326160513446.5e8eb15d.png" alt="image-20220326160513446"></p><p>现在我们依次执行方法c中的指令，最后返回a+b的结果，在方法c返回之后，也就代表方法c已经执行结束了，栈帧4会自动出栈，这时栈帧3就得到了上一栈帧返回的结果，并继续执行，但是由于紧接着马上就返回，所以继续重复栈帧4的操作，此时栈帧3也出栈并继续将结果交给下一个栈帧2，最后栈帧2再将结果返回给栈帧1，然后栈帧1就可以继续向下运行了，最后输出结果。</p><p><img src="/assets/image-20220326160531200.cbdaf478.png" alt="image-20220326160531200"></p></blockquote><h4 id="本地方法栈" tabindex="-1">本地方法栈 <a class="header-anchor" href="#本地方法栈" aria-label="Permalink to &quot;本地方法栈&quot;">​</a></h4><blockquote><p>本地方法栈与虚拟机栈作用差不多,作用于<strong>本地方法</strong></p></blockquote><h4 id="堆" tabindex="-1">堆 <a class="header-anchor" href="#堆" aria-label="Permalink to &quot;堆&quot;">​</a></h4><blockquote><p>堆是整个Java应用程序共享的区域，也是整个虚拟机最大的一块内存空间，而此区域的职责就是存放和管理对象和数组，垃圾回收机制也是主要作用于这一部分内存区域</p></blockquote><h4 id="方法区" tabindex="-1">方法区 <a class="header-anchor" href="#方法区" aria-label="Permalink to &quot;方法区&quot;">​</a></h4><blockquote><p>方法区也是整个Java应用程序共享的区域，它用于存储所有的类信息、常量、静态变量、动态编译缓存等数据，可以大致分为两个部分</p><p>一个是类信息表，一个是运行时常量池。<img src="/assets/image-20220326160711468.769858ef.png" alt="image-20220326160711468"></p></blockquote><blockquote><p><strong>类信息表</strong>中存放的是当前应用程序加载的所有类信息，包括类的版本、字段、方法、接口等信息，同时会将编译时生成的常量池数据全部存放到运行时常量池中。当然，常量也并不是只能从类信息中获取，在程序运行时，也有可能会有新的常量进入到常量池。</p></blockquote><h3 id="jvm堆外内存" tabindex="-1">jvm堆外内存 <a class="header-anchor" href="#jvm堆外内存" aria-label="Permalink to &quot;jvm堆外内存&quot;">​</a></h3><blockquote><p>除了堆内存可以存放对象数据以外，我们也可以申请堆外内存（直接内存），也就是不受JVM管控的内存区域，这部分区域的内存需要我们自行去申请和释放，实际上本质就是JVM通过C/C++调用<code>malloc</code>函数申请的内存，当然得我们自己去释放了。不过虽然是直接内存，不会受到堆内存容量限制，但是依然会受到本机最大内存的限制，所以还是有可能抛出<code>OutOfMemoryError</code>异常。</p><p>一个堆外内存操作类：<code>Unsafe</code>，就像它的名字一样，虽然Java提供堆外内存的操作类，但是实际上它是不安全的，只有你完全了解底层原理并且能够合理控制堆外内存，才能安全地使用堆外内存。</p></blockquote><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Unsafe</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">native</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">registerNatives</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">registerNatives</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        sun.reflect.Reflection.</span><span style="color:#B392F0;">registerMethodsToFilter</span><span style="color:#E1E4E8;">(Unsafe.class, </span><span style="color:#9ECBFF;">&quot;getUnsafe&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Unsafe</span><span style="color:#E1E4E8;">() {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Unsafe theUnsafe </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Unsafe</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">CallerSensitive</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> Unsafe </span><span style="color:#B392F0;">getUnsafe</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">        Class&lt;</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">&gt; caller </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Reflection.</span><span style="color:#B392F0;">getCallerClass</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">VM.</span><span style="color:#B392F0;">isSystemDomainLoader</span><span style="color:#E1E4E8;">(caller.</span><span style="color:#B392F0;">getClassLoader</span><span style="color:#E1E4E8;">()))</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 不是JDK的类，不让用</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">SecurityException</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Unsafe&quot;</span><span style="color:#E1E4E8;">);   </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> theUnsafe;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Unsafe</span><span style="color:#24292E;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">native</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">registerNatives</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">registerNatives</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        sun.reflect.Reflection.</span><span style="color:#6F42C1;">registerMethodsToFilter</span><span style="color:#24292E;">(Unsafe.class, </span><span style="color:#032F62;">&quot;getUnsafe&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Unsafe</span><span style="color:#24292E;">() {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Unsafe theUnsafe </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Unsafe</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">CallerSensitive</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> Unsafe </span><span style="color:#6F42C1;">getUnsafe</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">        Class&lt;</span><span style="color:#D73A49;">?</span><span style="color:#24292E;">&gt; caller </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Reflection.</span><span style="color:#6F42C1;">getCallerClass</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">VM.</span><span style="color:#6F42C1;">isSystemDomainLoader</span><span style="color:#24292E;">(caller.</span><span style="color:#6F42C1;">getClassLoader</span><span style="color:#24292E;">()))</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 不是JDK的类，不让用</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">SecurityException</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Unsafe&quot;</span><span style="color:#24292E;">);   </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> theUnsafe;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><blockquote><p>通过反射获取<code>unSafe</code>：</p><p>成功拿到Unsafe类之后，开始申请堆外内存，比如我们现在想要申请一个int大小的内存空间，并在此空间中存放一个int类型的数据：</p></blockquote><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] args) throws IllegalAccessException {</span></span>
<span class="line"><span style="color:#E1E4E8;">    Field unsafeField </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Unsafe.class.</span><span style="color:#B392F0;">getDeclaredFields</span><span style="color:#E1E4E8;">()[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">    unsafeField.</span><span style="color:#B392F0;">setAccessible</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    Unsafe unsafe </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (Unsafe) unsafeField.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">//申请4字节大小的内存空间，并得到对应位置的地址</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> address </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> unsafe.</span><span style="color:#B392F0;">allocateMemory</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">//在对应的地址上设定int的值</span></span>
<span class="line"><span style="color:#E1E4E8;">    unsafe.</span><span style="color:#B392F0;">putInt</span><span style="color:#E1E4E8;">(address, </span><span style="color:#79B8FF;">6666666</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">//获取对应地址上的Int型数值</span></span>
<span class="line"><span style="color:#E1E4E8;">    System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(unsafe.</span><span style="color:#B392F0;">getInt</span><span style="color:#E1E4E8;">(address));</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">//释放申请到的内容</span></span>
<span class="line"><span style="color:#E1E4E8;">    unsafe.</span><span style="color:#B392F0;">freeMemory</span><span style="color:#E1E4E8;">(address);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">//由于内存已经释放，这时数据就没了</span></span>
<span class="line"><span style="color:#E1E4E8;">    System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(unsafe.</span><span style="color:#B392F0;">getInt</span><span style="color:#E1E4E8;">(address));</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] args) throws IllegalAccessException {</span></span>
<span class="line"><span style="color:#24292E;">    Field unsafeField </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Unsafe.class.</span><span style="color:#6F42C1;">getDeclaredFields</span><span style="color:#24292E;">()[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">];</span></span>
<span class="line"><span style="color:#24292E;">    unsafeField.</span><span style="color:#6F42C1;">setAccessible</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">true</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    Unsafe unsafe </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (Unsafe) unsafeField.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//申请4字节大小的内存空间，并得到对应位置的地址</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> address </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> unsafe.</span><span style="color:#6F42C1;">allocateMemory</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//在对应的地址上设定int的值</span></span>
<span class="line"><span style="color:#24292E;">    unsafe.</span><span style="color:#6F42C1;">putInt</span><span style="color:#24292E;">(address, </span><span style="color:#005CC5;">6666666</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//获取对应地址上的Int型数值</span></span>
<span class="line"><span style="color:#24292E;">    System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(unsafe.</span><span style="color:#6F42C1;">getInt</span><span style="color:#24292E;">(address));</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//释放申请到的内容</span></span>
<span class="line"><span style="color:#24292E;">    unsafe.</span><span style="color:#6F42C1;">freeMemory</span><span style="color:#24292E;">(address);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//由于内存已经释放，这时数据就没了</span></span>
<span class="line"><span style="color:#24292E;">    System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(unsafe.</span><span style="color:#6F42C1;">getInt</span><span style="color:#24292E;">(address));</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><blockquote><p>看一下<code>allocateMemory</code>底层是如何调用的，这是一个native方法，我们来看C++源码：</p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">UNSAFE_ENTRY(jlong, Unsafe_AllocateMemory0(JNIEnv *env, jobject unsafe, jlong size)) {</span></span>
<span class="line"><span style="color:#e1e4e8;">size_t sz = (size_t)size;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">sz = align_up(sz, HeapWordSize);</span></span>
<span class="line"><span style="color:#e1e4e8;">void* x = os::malloc(sz, mtOther);   //这里调用了os::malloc方法</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">return addr_to_java(x);</span></span>
<span class="line"><span style="color:#e1e4e8;">} UNSAFE_END</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">UNSAFE_ENTRY(jlong, Unsafe_AllocateMemory0(JNIEnv *env, jobject unsafe, jlong size)) {</span></span>
<span class="line"><span style="color:#24292e;">size_t sz = (size_t)size;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">sz = align_up(sz, HeapWordSize);</span></span>
<span class="line"><span style="color:#24292e;">void* x = os::malloc(sz, mtOther);   //这里调用了os::malloc方法</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">return addr_to_java(x);</span></span>
<span class="line"><span style="color:#24292e;">} UNSAFE_END</span></span></code></pre></div><blockquote><p><code>os::malloc方法</code></p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">void* os::malloc(size_t size, MEMFLAGS flags) {</span></span>
<span class="line"><span style="color:#e1e4e8;">return os::malloc(size, flags, CALLER_PC);</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">void* os::malloc(size_t size, MEMFLAGS memflags, const NativeCallStack&amp; stack) {</span></span>
<span class="line"><span style="color:#e1e4e8;">	...</span></span>
<span class="line"><span style="color:#e1e4e8;">u_char* ptr;</span></span>
<span class="line"><span style="color:#e1e4e8;">ptr = (u_char*)::malloc(alloc_size);   //调用C++标准库函数 malloc(size)</span></span>
<span class="line"><span style="color:#e1e4e8;">	....</span></span>
<span class="line"><span style="color:#e1e4e8;">// we do not track guard memory</span></span>
<span class="line"><span style="color:#e1e4e8;">return MemTracker::record_malloc((address)ptr, size, memflags, stack, level);</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">void* os::malloc(size_t size, MEMFLAGS flags) {</span></span>
<span class="line"><span style="color:#24292e;">return os::malloc(size, flags, CALLER_PC);</span></span>
<span class="line"><span style="color:#24292e;">}</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">void* os::malloc(size_t size, MEMFLAGS memflags, const NativeCallStack&amp; stack) {</span></span>
<span class="line"><span style="color:#24292e;">	...</span></span>
<span class="line"><span style="color:#24292e;">u_char* ptr;</span></span>
<span class="line"><span style="color:#24292e;">ptr = (u_char*)::malloc(alloc_size);   //调用C++标准库函数 malloc(size)</span></span>
<span class="line"><span style="color:#24292e;">	....</span></span>
<span class="line"><span style="color:#24292e;">// we do not track guard memory</span></span>
<span class="line"><span style="color:#24292e;">return MemTracker::record_malloc((address)ptr, size, memflags, stack, level);</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><blockquote><p>直接内存实际上就是JVM申请的一块额外的内存空间，但是它并不在受管控的几种内存空间中，当然这些内存依然属于是JVM的，由于JVM提供的堆内存会进行垃圾回收等工作，效率不如直接申请和操作内存来得快，一些比较追求极致性能的框架会用到堆外内存来提升运行速度，如nio框架。</p></blockquote><h3 id="垃圾回收机制" tabindex="-1">垃圾回收机制 <a class="header-anchor" href="#垃圾回收机制" aria-label="Permalink to &quot;垃圾回收机制&quot;">​</a></h3><h4 id="对象存活判定算法" tabindex="-1">对象存活判定算法 <a class="header-anchor" href="#对象存活判定算法" aria-label="Permalink to &quot;对象存活判定算法&quot;">​</a></h4><h5 id="引用计数法" tabindex="-1">引用计数法 <a class="header-anchor" href="#引用计数法" aria-label="Permalink to &quot;引用计数法&quot;">​</a></h5><p>要经常操作一个对象，那么首先一定会创建一个引用变量：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">//str就是一个引用类型的变量，它持有对后面字符串对象的引用，可以代表后面这个字符串对象本身</span></span>
<span class="line"><span style="color:#E1E4E8;">String str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;lbwnb&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#6A737D;">//str.xxxxx...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">//str就是一个引用类型的变量，它持有对后面字符串对象的引用，可以代表后面这个字符串对象本身</span></span>
<span class="line"><span style="color:#24292E;">String str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;lbwnb&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#6A737D;">//str.xxxxx...</span></span></code></pre></div><p>实际上，我们会发现，只要一个对象还有使用价值，我们就会通过它的引用变量来进行操作，那么可否这样判断一个对象是否还需要被使用：</p><ul><li>每个对象都包含一个 <strong>引用计数器</strong>，用于存放引用计数（其实就是存放被引用的次数）</li><li>每当有一个地方引用此对象时，引用计数<code>+1</code></li><li>当引用失效（ 比如离开了局部变量的作用域或是引用被设定为<code>null</code>）时，引用计数<code>-1</code></li><li>当引用计数为<code>0</code>时，表示此对象不可能再被使用，因为这时我们已经没有任何方法可以得到此对象的引用了</li></ul><p>但是这样存在一个问题，如果两个对象相互引用呢？</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        Test a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Test</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        Test b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Test</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        a.another </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> b;</span></span>
<span class="line"><span style="color:#E1E4E8;">        b.another </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> a;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">//这里直接把a和b赋值为null，这样前面的两个对象我们不可能再得到了</span></span>
<span class="line"><span style="color:#E1E4E8;">        a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Test</span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">        Test another;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        Test a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Test</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        Test b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Test</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        a.another </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> b;</span></span>
<span class="line"><span style="color:#24292E;">        b.another </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> a;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//这里直接把a和b赋值为null，这样前面的两个对象我们不可能再得到了</span></span>
<span class="line"><span style="color:#24292E;">        a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Test</span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">        Test another;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>按照引用计数算法，那么当出现以上情况时，虽然我们无法在得到此对象的引用了，并且此对象我们也无需再使用，但是由于这两个对象直接存在相互引用的情况，那么引用计数器的值将会永远是<code>1</code>，但是实际上此对象已经没有任何用途了。所以引用计数法并不是最好的解决方案。</p><h5 id="可达性分析算法" tabindex="-1">可达性分析算法 <a class="header-anchor" href="#可达性分析算法" aria-label="Permalink to &quot;可达性分析算法&quot;">​</a></h5><blockquote><p><strong>如果某个对象无法到达任何GC Roots，则证明此对象是不可能再被使用的。</strong></p></blockquote><p>目前比较主流的编程语言（包括Java），一般都会使用可达性分析算法来判断对象是否存活，它采用了类似于树结构的搜索机制。</p><p>首先每个对象的引用都有机会成为树的根节点（GC Roots），可以被选定作为根节点条件如下：</p><ul><li>位于虚拟机栈的栈帧中的本地变量表中所引用到的对象（其实就是我们方法中的局部变量）同样也包括本地方法栈中JNI引用的对象。</li><li>类的静态成员变量引用的对象。</li><li>方法区中，常量池里面引用的对象，比如我们之前提到的<code>String</code>类型对象。</li><li>被添加了锁的对象（比如synchronized关键字）</li><li>虚拟机内部需要用到的对象。</li></ul><p><img src="/assets/image-20220326164903503.d7f575f3.png" alt="image-20220326164903503"></p><p>一旦已经存在的根节点不满足存在的条件时，那么根节点与对象之间的连接将被断开。此时虽然对象1仍存在对其他对象的引用，但是由于其没有任何根节点引用，所以此对象即可被判定为不再使用。比如某个方法中的局部变量引用，在方法执行完成返回之后：</p><p><img src="/assets/image-20220326164916460.b5d33caf.png" alt="image-20220326164916460"></p><p>这样就能很好地解决我们刚刚提到的循环引用问题，我们再来重现一下出现循环引用的情况：<img src="/assets/image-20220326164959693.df7b62c5.png" alt="image-20220326164959693"></p><p>可以看到，对象1和对象2依然是存在循环引用的，但是只有他们各自的GC Roots断开，那么就会变成下面这样：</p><p><img src="/assets/image-20220326165021123.92a1560d.png" alt="image-20220326165021123"></p><h5 id="最终判定" tabindex="-1">最终判定 <a class="header-anchor" href="#最终判定" aria-label="Permalink to &quot;最终判定&quot;">​</a></h5><blockquote><p>虽然在经历了可达性分析算法之后基本可能判定哪些对象能够被回收，但是并不代表此对象一定会被回收，我们依然可以在最终判定阶段对其进行挽留。</p><p><img src="/assets/image-20220326165223418.0385732c.png" alt="image-20220326165223418"></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">* Called by the garbage collector on an object when garbage collection</span></span>
<span class="line"><span style="color:#6A737D;">* determines that there are no more references to the object.</span></span>
<span class="line"><span style="color:#6A737D;">* A subclass overrides the {@code finalize} method to dispose of</span></span>
<span class="line"><span style="color:#6A737D;">* system resources or to perform other cleanup.</span></span>
<span class="line"><span style="color:#6A737D;">* ...</span></span>
<span class="line"><span style="color:#6A737D;">*/</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">finalize</span><span style="color:#E1E4E8;">() throws Throwable { }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">* Called by the garbage collector on an object when garbage collection</span></span>
<span class="line"><span style="color:#6A737D;">* determines that there are no more references to the object.</span></span>
<span class="line"><span style="color:#6A737D;">* A subclass overrides the {@code finalize} method to dispose of</span></span>
<span class="line"><span style="color:#6A737D;">* system resources or to perform other cleanup.</span></span>
<span class="line"><span style="color:#6A737D;">* ...</span></span>
<span class="line"><span style="color:#6A737D;">*/</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">finalize</span><span style="color:#24292E;">() throws Throwable { }</span></span></code></pre></div></blockquote><blockquote><p>此方法正是最终判定方法，如果子类重写了此方法，那么子类对象在被判定为可回收时，会进行二次确认，也就是执行<code>finalize()</code>方法，而在此方法中，当前对象是完全有可能重新建立GC Roots的！所以，如果在二次确认后对象不满足可回收的条件，那么此对象不会被回收，巧妙地逃过了垃圾回收的命运。比如下面这个例子：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> Test a;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> InterruptedException {</span></span>
<span class="line"><span style="color:#E1E4E8;">       a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Test</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">//这里直接把a赋值为null，这样前面的对象我们不可能再得到了</span></span>
<span class="line"><span style="color:#E1E4E8;">       a  </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">//手动申请执行垃圾回收操作（注意只是申请，并不一定会执行，但是一般情况下都会执行）</span></span>
<span class="line"><span style="color:#E1E4E8;">       System.</span><span style="color:#B392F0;">gc</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">//等垃圾回收一下()</span></span>
<span class="line"><span style="color:#E1E4E8;">       Thread.</span><span style="color:#B392F0;">sleep</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">//我们来看看a有没有被回收</span></span>
<span class="line"><span style="color:#E1E4E8;">       System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(a);</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Test</span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">       @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">finalize</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> Throwable {</span></span>
<span class="line"><span style="color:#E1E4E8;">           System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&quot; 开始了它的救赎之路！&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">           a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">       }</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> Test a;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> InterruptedException {</span></span>
<span class="line"><span style="color:#24292E;">       a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Test</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6A737D;">//这里直接把a赋值为null，这样前面的对象我们不可能再得到了</span></span>
<span class="line"><span style="color:#24292E;">       a  </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6A737D;">//手动申请执行垃圾回收操作（注意只是申请，并不一定会执行，但是一般情况下都会执行）</span></span>
<span class="line"><span style="color:#24292E;">       System.</span><span style="color:#6F42C1;">gc</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6A737D;">//等垃圾回收一下()</span></span>
<span class="line"><span style="color:#24292E;">       Thread.</span><span style="color:#6F42C1;">sleep</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6A737D;">//我们来看看a有没有被回收</span></span>
<span class="line"><span style="color:#24292E;">       System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(a);</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Test</span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">       @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">finalize</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Throwable {</span></span>
<span class="line"><span style="color:#24292E;">           System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">this</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&quot; 开始了它的救赎之路！&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">           a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">       }</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>注意<code>finalize()</code>方法并不是在主线程调用的，而是虚拟机自动建立的一个低优先级的<code>Finalizer</code>线程（正是因为优先级比较低，所以前面才需要等待1秒钟）进行处理，我们可以稍微修改一下看看：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Test</span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">finalize</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> Throwable {</span></span>
<span class="line"><span style="color:#E1E4E8;">       System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">       a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Test</span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">finalize</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Throwable {</span></span>
<span class="line"><span style="color:#24292E;">       System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">       a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">this</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">Thread[Finalizer,8,system]</span></span>
<span class="line"><span style="color:#e1e4e8;">com.test.Main$Test@232204a1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">Thread[Finalizer,8,system]</span></span>
<span class="line"><span style="color:#24292e;">com.test.Main$Test@232204a1</span></span></code></pre></div><p>同时，同一个对象的<code>finalize()</code>方法只会有一次调用机会，也就是说，如果我们连续两次这样操作，那么第二次，对象必定被回收：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] args) throws InterruptedException {</span></span>
<span class="line"><span style="color:#E1E4E8;">   a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Test</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">//这里直接把a赋值为null，这样前面的对象我们不可能再得到了</span></span>
<span class="line"><span style="color:#E1E4E8;">   a  </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">//手动申请执行垃圾回收操作（注意只是申请，并不一定会执行，但是一般情况下都会执行）</span></span>
<span class="line"><span style="color:#E1E4E8;">   System.</span><span style="color:#B392F0;">gc</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">//等垃圾回收一下</span></span>
<span class="line"><span style="color:#E1E4E8;">   Thread.</span><span style="color:#B392F0;">sleep</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">   System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(a);</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">//这里直接把a赋值为null，这样前面的对象我们不可能再得到了</span></span>
<span class="line"><span style="color:#E1E4E8;">   a  </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">//手动申请执行垃圾回收操作（注意只是申请，并不一定会执行，但是一般情况下都会执行）</span></span>
<span class="line"><span style="color:#E1E4E8;">   System.</span><span style="color:#B392F0;">gc</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">//等垃圾回收一下</span></span>
<span class="line"><span style="color:#E1E4E8;">   Thread.</span><span style="color:#B392F0;">sleep</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">   System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(a);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] args) throws InterruptedException {</span></span>
<span class="line"><span style="color:#24292E;">   a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Test</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6A737D;">//这里直接把a赋值为null，这样前面的对象我们不可能再得到了</span></span>
<span class="line"><span style="color:#24292E;">   a  </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6A737D;">//手动申请执行垃圾回收操作（注意只是申请，并不一定会执行，但是一般情况下都会执行）</span></span>
<span class="line"><span style="color:#24292E;">   System.</span><span style="color:#6F42C1;">gc</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6A737D;">//等垃圾回收一下</span></span>
<span class="line"><span style="color:#24292E;">   Thread.</span><span style="color:#6F42C1;">sleep</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">   System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(a);</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6A737D;">//这里直接把a赋值为null，这样前面的对象我们不可能再得到了</span></span>
<span class="line"><span style="color:#24292E;">   a  </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6A737D;">//手动申请执行垃圾回收操作（注意只是申请，并不一定会执行，但是一般情况下都会执行）</span></span>
<span class="line"><span style="color:#24292E;">   System.</span><span style="color:#6F42C1;">gc</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6A737D;">//等垃圾回收一下</span></span>
<span class="line"><span style="color:#24292E;">   Thread.</span><span style="color:#6F42C1;">sleep</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">   System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(a);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>当然，<code>finalize()</code>方法也并不是专门防止对象被回收的，我们可以使用它来释放一些程序使用中的资源等。</p></blockquote><h4 id="分代收集机制" tabindex="-1">分代收集机制 <a class="header-anchor" href="#分代收集机制" aria-label="Permalink to &quot;分代收集机制&quot;">​</a></h4><blockquote><p>Java虚拟机将堆内存划分为<strong>新生代</strong>、<strong>老年代</strong>和<strong>永久代</strong>（其中永久代是HotSpot虚拟机特有的概念，在JDK8之前方法区实际上就是采用的永久代作为实现，而在JDK8之后，方法区由元空间实现，并且使用的是本地内存，容量大小取决于物理机实际大小，之后会详细介绍）这里我们主要讨论的是<strong>新生代</strong>和<strong>老年代</strong>。</p><p>不同的分代内存回收机制也存在一些不同之处，在HotSpot虚拟机中，新生代被划分为三块，一块较大的Eden空间和两块较小的Survivor空间，默认比例为8：1：1，老年代的GC评率相对较低，永久代一般存放类信息等（其实就是方法区的实现）如图所示：</p><p><img src="/assets/image-20220326165326942.b45f114f.png" alt="image-20220326165326942"></p><p>那么它是如何运作的呢？</p><p>首先，所有新创建的对象，在一开始都会进入到新生代的Eden区（如果是大对象会被直接丢进老年代），在进行新生代区域的垃圾回收时，首先会对所有新生代区域的对象进行扫描，并回收那些不再使用对象：<img src="/assets/image-20220326165352470.9697d44f.png" alt="image-20220326165352470"></p><p>接着，在一次垃圾回收之后，Eden区域没有被回收的对象，会进入到Survivor区。在一开始From和To都是空的，而GC之后，所有Eden区域存活的对象都会直接被放入到From区，最后From和To会发生一次交换，也就是说目前存放我们对象的From区，变为To区，而To区变为From区：</p><p><img src="/assets/image-20220326165407720.783be523.png" alt="image-20220326165407720"></p><p>接着就是下一次垃圾回收了，操作与上面是一样的，不过这时由于我们From区域中已经存在对象了，所以，在Eden区的存活对象复制到From区之后，所有To区域中的对象会进行年龄判定（每经历一轮GC年龄<code>+1</code>，如果对象的年龄大于<code>默认值为15</code>，那么会直接进入到老年代，否则移动到From区）</p><p><img src="/assets/image-20220326165419289.eceff473.png" alt="image-20220326165419289"></p><p>最后像上面一样交换To区和From区，之后不断重复以上步骤。</p><p>而垃圾收集也分为：</p><ul><li>Minor GC - 次要垃圾回收，主要进行新生代区域的垃圾收集。</li><li>触发条件：新生代的Eden区容量已满时。</li><li>Major GC - 主要垃圾回收，主要进行老年代的垃圾收集。</li><li>Full GC - 完全垃圾回收，对整个Java堆内存和方法区进行垃圾回收。</li><li>触发条件1：每次晋升到老年代的对象平均大小大于老年代剩余空间</li><li>触发条件2：Minor GC后存活的对象超过了老年代剩余空间</li><li>触发条件3：永久代内存不足（JDK8之前）</li><li>触发条件4：手动调用<code>System.gc()</code>方法</li></ul></blockquote><blockquote><p>我们可以添加启动参数来查看JVM的GC日志：</p><p><img src="/assets/e6c9d24egy1gzmd9jj8djj21m20gktav.5d855ce1.jpg" alt="image-20220222162536616"></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">       Object o </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Object</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">       o </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">       System.</span><span style="color:#B392F0;">gc</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">       Object o </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Object</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">       o </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">       System.</span><span style="color:#6F42C1;">gc</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[GC (System.gc()) [PSYoungGen: 2621K-&gt;528K(76288K)] 2621K-&gt;528K(251392K), 0.0006874 secs] [Times: user=0.01 sys=0.01, real=0.00 secs] </span></span>
<span class="line"><span style="color:#e1e4e8;">[Full GC (System.gc()) [PSYoungGen: 528K-&gt;0K(76288K)] [ParOldGen: 0K-&gt;332K(175104K)] 528K-&gt;332K(251392K), [Metaspace: 3073K-&gt;3073K(1056768K)], 0.0022693 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span></span>
<span class="line"><span style="color:#e1e4e8;">Heap</span></span>
<span class="line"><span style="color:#e1e4e8;">PSYoungGen      total 76288K, used 3277K [0x000000076ab00000, 0x0000000770000000, 0x00000007c0000000)</span></span>
<span class="line"><span style="color:#e1e4e8;"> eden space 65536K, 5% used [0x000000076ab00000,0x000000076ae334d8,0x000000076eb00000)</span></span>
<span class="line"><span style="color:#e1e4e8;"> from space 10752K, 0% used [0x000000076eb00000,0x000000076eb00000,0x000000076f580000)</span></span>
<span class="line"><span style="color:#e1e4e8;"> to   space 10752K, 0% used [0x000000076f580000,0x000000076f580000,0x0000000770000000)</span></span>
<span class="line"><span style="color:#e1e4e8;">ParOldGen       total 175104K, used 332K [0x00000006c0000000, 0x00000006cab00000, 0x000000076ab00000)</span></span>
<span class="line"><span style="color:#e1e4e8;"> object space 175104K, 0% used [0x00000006c0000000,0x00000006c00532d8,0x00000006cab00000)</span></span>
<span class="line"><span style="color:#e1e4e8;">Metaspace       used 3096K, capacity 4496K, committed 4864K, reserved 1056768K</span></span>
<span class="line"><span style="color:#e1e4e8;"> class space    used 333K, capacity 388K, committed 512K, reserved 1048576K</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[GC (System.gc()) [PSYoungGen: 2621K-&gt;528K(76288K)] 2621K-&gt;528K(251392K), 0.0006874 secs] [Times: user=0.01 sys=0.01, real=0.00 secs] </span></span>
<span class="line"><span style="color:#24292e;">[Full GC (System.gc()) [PSYoungGen: 528K-&gt;0K(76288K)] [ParOldGen: 0K-&gt;332K(175104K)] 528K-&gt;332K(251392K), [Metaspace: 3073K-&gt;3073K(1056768K)], 0.0022693 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span></span>
<span class="line"><span style="color:#24292e;">Heap</span></span>
<span class="line"><span style="color:#24292e;">PSYoungGen      total 76288K, used 3277K [0x000000076ab00000, 0x0000000770000000, 0x00000007c0000000)</span></span>
<span class="line"><span style="color:#24292e;"> eden space 65536K, 5% used [0x000000076ab00000,0x000000076ae334d8,0x000000076eb00000)</span></span>
<span class="line"><span style="color:#24292e;"> from space 10752K, 0% used [0x000000076eb00000,0x000000076eb00000,0x000000076f580000)</span></span>
<span class="line"><span style="color:#24292e;"> to   space 10752K, 0% used [0x000000076f580000,0x000000076f580000,0x0000000770000000)</span></span>
<span class="line"><span style="color:#24292e;">ParOldGen       total 175104K, used 332K [0x00000006c0000000, 0x00000006cab00000, 0x000000076ab00000)</span></span>
<span class="line"><span style="color:#24292e;"> object space 175104K, 0% used [0x00000006c0000000,0x00000006c00532d8,0x00000006cab00000)</span></span>
<span class="line"><span style="color:#24292e;">Metaspace       used 3096K, capacity 4496K, committed 4864K, reserved 1056768K</span></span>
<span class="line"><span style="color:#24292e;"> class space    used 333K, capacity 388K, committed 512K, reserved 1048576K</span></span></code></pre></div></blockquote><h4 id="空间分配担保机制" tabindex="-1">空间分配担保机制 <a class="header-anchor" href="#空间分配担保机制" aria-label="Permalink to &quot;空间分配担保机制&quot;">​</a></h4><blockquote><p>在一次GC后，新生代Eden区仍然存在大量的对象（因为GC之后存活对象会进入到一个Survivor区，但是很明显这时已经超出Survivor区的容量了，肯定是装不下的）那么现在该怎么办？</p><p>这时就需要用到<strong>空间分配担保机制</strong>了，可以把Survivor区无法容纳的对象直接送到老年代，让老年代进行分配担保（当然老年代也得装得下才行）在现实生活中，贷款会指定担保人，就是当借款人还不起钱的时候由担保人来还钱。</p><p>当新生代无法容纳更多的的对象时，可以把新生代中的对象移动到老年代中，这样新生代就腾出了空间来容纳更多的对象。</p><p>好，那既然新生代装不下就丢给老年代，那么要是老年代也装不下新生代的数据呢？这时，老年代肯定担保人是当不成了，那么这样的话，首先会判断一下之前的每次垃圾回收进入老年代的平均大小是否小于当前老年代的剩余空间，如果小于，那么说明也许可以放得下（不过也仅仅是也许，依然有可能放不下，因为判断的实际上只是平均值，万一这一次突然非常大呢），否则，会先来一次Full GC，进行一次大规模垃圾回收，来尝试腾出空间，再次判断老年代是否有空间存放，要是还是装不下，直接抛出OOM错误。</p><p>总结一下一次<strong>Minor GC</strong>的整个过程：<img src="/assets/image-20220326165742818.a9cfbc7f.png" alt="image-20220326165742818"></p></blockquote><h4 id="垃圾回收算法" tabindex="-1">垃圾回收算法 <a class="header-anchor" href="#垃圾回收算法" aria-label="Permalink to &quot;垃圾回收算法&quot;">​</a></h4><h5 id="标记-清除算法" tabindex="-1">标记-清除算法 <a class="header-anchor" href="#标记-清除算法" aria-label="Permalink to &quot;标记-清除算法&quot;">​</a></h5><blockquote><p>首先标记出所有需要回收的对象，然后再依次回收掉被标记的对象，或是标记出所有不需要回收的对象，只回收未标记的对象。</p><p><img src="/assets/image-20220326165854189.0d5b15ea.png" alt="image-20220326165854189"></p><p>此方法非常简单，但是缺点也是非常明显的 ，首先如果内存中存在大量的对象，那么可能就会存在大量的标记，并且大规模进行清除。并且一次标记清除之后，连续的内存空间可能会出现许许多多的空隙，碎片化会导致连续内存空间利用率降低。</p></blockquote><h5 id="标记-复制算法" tabindex="-1">标记-复制算法 <a class="header-anchor" href="#标记-复制算法" aria-label="Permalink to &quot;标记-复制算法&quot;">​</a></h5><blockquote><p>标记复制算法，实际上就是将内存区域划分为大小相同的两块区域，每次只使用其中的一块区域，每次垃圾回收结束后，将所有存活的对象全部复制到另一块区域中，并一次性清空当前区域。虽然浪费了一些时间进行复制操作，但是这样能够很好地解决对象大面积回收后空间碎片化严重的问题。</p><p><img src="/assets/image-20220326165926520.e83b3e6a.png" alt="image-20220326165926520"></p><p>这种算法就非常适用于新生代（因为新生代的回收效率极高，一般不会留下太多的对象）的垃圾回收，而我们之前所说的新生代Survivor区其实就是这个思路，包括8:1:1的比例也正是为了对标记复制算法进行优化而采取的。</p></blockquote><h5 id="标记-整理算法" tabindex="-1">标记-整理算法 <a class="header-anchor" href="#标记-整理算法" aria-label="Permalink to &quot;标记-整理算法&quot;">​</a></h5><blockquote><p>虽然标记-复制算法能够很好地应对新生代高回收率的场景，但是放到老年代，它就显得很鸡肋了。我们知道，一般长期都回收不到的对象，才有机会进入到老年代，所以老年代一般都是些钉子户，可能一次GC后，仍然存留很多对象。而标记复制算法会在GC后完整复制整个区域内容，并且会折损50%的区域，显然这并不适用于老年代。</p><p>那么我们能否这样，在标记所有待回收对象之后，不急着去进行回收操作，而是将所有待回收的对象整齐排列在一段内存空间中，而需要回收的对象全部往后丢，这样，前半部分的所有对象都是无需进行回收的，而后半部分直接一次性清除即可。</p><p><img src="/assets/image-20220326170026794.0c86812a.png" alt="image-20220326170026794"></p><p>虽然这样能保证内存空间充分使用，并且也没有标记复制算法那么繁杂，但是缺点也是显而易见的，它的效率比前两者都低。甚至，由于需要修改对象在内存中的位置，此时程序必须要暂停才可以，在极端情况下，可能会导致整个程序发生停顿（被称为“Stop The World”）。</p><p>所以，我们可以将标记清除算法和标记整理算法混合使用，在内存空间还不是很凌乱的时候，采用标记清除算法其实是没有多大问题的，当内存空间凌乱到一定程度后，我们可以进行一次标记整理算法。</p></blockquote><h4 id="垃圾收集器" tabindex="-1">垃圾收集器 <a class="header-anchor" href="#垃圾收集器" aria-label="Permalink to &quot;垃圾收集器&quot;">​</a></h4><h5 id="serial收集器" tabindex="-1">Serial收集器 <a class="header-anchor" href="#serial收集器" aria-label="Permalink to &quot;Serial收集器&quot;">​</a></h5><blockquote><p>在JDK1.3.1之前，是虚拟机新生代区域收集器的唯一选择。这是一款单线程的垃圾收集器，也就是说，当开始进行垃圾回收时，需要暂停所有的线程，直到垃圾收集工作结束。它的新生代收集算法采用的是标记复制算法，老年代采用的是标记整理算法。</p><p><img src="/assets/image-20220326170108369.a9866dba.png" alt="image-20220326170108369"></p><p>可以看到，当进入到垃圾回收阶段时，所有的用户线程必须等待GC线程完成工作，就相当于你打一把LOL 40分钟，中途每隔1分钟网络就卡5秒钟，可能这时你正在打团，结果你被物理控制直接在那里站了5秒钟，这确实让人难以接受。</p><p>虽然缺点很明显，但是优势也是显而易见的：</p><ol><li>设计简单而高效。</li><li>在用户的桌面应用场景中，内存一般不大，可以在较短时间内完成垃圾收集，只要不频繁发生，使用串行回收器是可以接受的。</li></ol><p>所以，在客户端模式（一般用于一些桌面级图形化界面应用程序）下的新生代中，默认垃圾收集器至今依然是Serial收集器。我们可以在<code>java -version</code>中查看默认的客户端模式：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">openjdk version &quot;1.8.0_322&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">OpenJDK Runtime Environment (Zulu 8.60.0.21-CA-macos-aarch64) (build 1.8.0_322-b06)</span></span>
<span class="line"><span style="color:#e1e4e8;">OpenJDK 64-Bit Server VM (Zulu 8.60.0.21-CA-macos-aarch64) (build 25.322-b06, mixed mode)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">openjdk version &quot;1.8.0_322&quot;</span></span>
<span class="line"><span style="color:#24292e;">OpenJDK Runtime Environment (Zulu 8.60.0.21-CA-macos-aarch64) (build 1.8.0_322-b06)</span></span>
<span class="line"><span style="color:#24292e;">OpenJDK 64-Bit Server VM (Zulu 8.60.0.21-CA-macos-aarch64) (build 25.322-b06, mixed mode)</span></span></code></pre></div><p>我们可以在jvm.cfg文件中切换JRE为Server VM或是Client VM，默认路径为：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">JDK安装目录/jre/lib/jvm.cfg</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">JDK安装目录/jre/lib/jvm.cfg</span></span></code></pre></div><p>比如我们需要将当前模式切换为客户端模式，那么我们可以这样编辑：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">-client KNOWN</span></span>
<span class="line"><span style="color:#e1e4e8;">-server IGNORE</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">-client KNOWN</span></span>
<span class="line"><span style="color:#24292e;">-server IGNORE</span></span></code></pre></div></blockquote><h5 id="parnew收集器" tabindex="-1">ParNew收集器 <a class="header-anchor" href="#parnew收集器" aria-label="Permalink to &quot;ParNew收集器&quot;">​</a></h5><blockquote><p>这款垃圾收集器相当于是Serial收集器的多线程版本，它能够支持多线程垃圾收集：<img src="/assets/image-20220326170143444.5c7abe8d.png" alt="image-20220326170143444"></p><p>除了多线程支持以外，其他内容基本与Serial收集器一致，并且目前某些JVM默认的服务端模式新生代收集器就是使用的ParNew收集器。</p></blockquote><h5 id="parallel-scavenge-parallel-old收集器" tabindex="-1">Parallel Scavenge/Parallel Old收集器 <a class="header-anchor" href="#parallel-scavenge-parallel-old收集器" aria-label="Permalink to &quot;Parallel Scavenge/Parallel Old收集器&quot;">​</a></h5><blockquote><p>Parallel Scavenge同样是一款面向新生代的垃圾收集器，同样采用标记复制算法实现，在JDK6时也推出了其老年代收集器Parallel Old，采用标记整理算法实现：<img src="/assets/image-20220326170218573.19637529.png" alt="image-20220326170218573"></p><p>与ParNew收集器不同的是，它会自动衡量一个吞吐量，并根据吞吐量来决定每次垃圾回收的时间，这种自适应机制，能够很好地权衡当前机器的性能，根据性能选择最优方案。</p><p>目前<strong>JDK8采用的就是这种 Parallel Scavenge + Parallel Old 的垃圾回收方案</strong></p></blockquote><h5 id="cms收集器" tabindex="-1">CMS收集器 <a class="header-anchor" href="#cms收集器" aria-label="Permalink to &quot;CMS收集器&quot;">​</a></h5><blockquote><p>在JDK1.5，HotSpot推出了一款在强交互应用中几乎可认为有划时代意义的垃圾收集器：CMS（Concurrent-Mark-Sweep）收集器，这款收集器是HotSpot虚拟机中第一款真正意义上的并发（注意这里的并发和之前的并行是有区别的，并发可以理解为同时运行用户线程和GC线程，而并行可以理解为多条GC线程同时工作）收集器，它第一次实现了让垃圾收集线程与用户线程同时工作。</p><p>它主要采用标记清除算法：<img src="/assets/image-20220326170309111.e19fdfe6.png" alt="image-20220326170309111"></p><p>它的垃圾回收分为4个阶段：</p><ul><li>初始标记（需要暂停用户线程）：这个阶段的主要任务仅仅只是标记出GC Roots能直接关联到的对象，速度比较快，不用担心会停顿太长时间。</li><li>并发标记：从GC Roots的直接关联对象开始遍历整个对象图的过程，这个过程耗时较长但是不需要停顿用户线程，可以与垃圾收集线程一起并发运行。</li><li>重新标记（需要暂停用户线程）：由于并发标记阶段可能某些用户线程会导致标记产生变得，因此这里需要再次暂停所有线程进行并行标记，这个时间会比初始标记时间长一丢丢。</li><li>并发清除：最后就可以直接将所有标记好的无用对象进行删除，因为这些对象程序中也用不到了，所以可以与用户线程并发运行。</li></ul><p>虽然它的优点非常之大，但是缺点也是显而易见的，我们之前说过，标记清除算法会产生大量的内存碎片，导致可用连续空间逐渐变少，长期这样下来，会有更高的概率触发Full GC，并且在与用户线程并发执行的情况下，也会占用一部分的系统资源，导致用户线程的运行速度一定程度上减慢。</p><p>不过，如果你希望的是最低的GC停顿时间，这款垃圾收集器无疑是最佳选择，不过<strong>自从G1收集器问世之后，CMS收集器不再推荐使用了</strong>。</p></blockquote><h5 id="garbage-first-g1-收集器" tabindex="-1">Garbage First (G1) 收集器 <a class="header-anchor" href="#garbage-first-g1-收集器" aria-label="Permalink to &quot;Garbage First (G1) 收集器&quot;">​</a></h5><blockquote><p>此垃圾收集器也是一款划时代的垃圾收集器，在JDK7的时候正式走上历史舞台，它是一款主要面向于服务端的垃圾收集器，并且在JDK9时，取代了JDK8默认的 Parallel Scavenge + Parallel Old 的回收方案。</p><p>垃圾回收分为<code>Minor GC</code>、<code>Major GC </code>和<code>Full GC</code>，它们分别对应的是新生代，老年代和整个堆内存的垃圾回收，而G1收集器巧妙地绕过了这些约定，它将整个Java堆划分成<code>2048</code>个大小相同的独立<code>Region</code>块，每个<code>Region块</code>的大小根据堆空间的实际大小而定，整体被控制在1MB到32MB之间，且都为2的N次幂。所有的<code>Region</code>大小相同，且在JVM的整个生命周期内不会发生改变。</p><p>每一个<code>Region</code>都可以根据需要，自由决定扮演哪个角色（Eden、Survivor和老年代），收集器会根据对应的角色采用不同的回收策略。此外，G1收集器还存在一个Humongous区域，它专门用于存放大对象（一般认为大小超过了Region容量一半的对象为大对象）这样，新生代、老年代在物理上，不再是一个连续的内存区域，而是到处分布的。</p><p><img src="/assets/image-20220326170452371.b074b758.png" alt="image-20220326170452371"></p><p>它的回收过程与CMS大体类似：<img src="/assets/image-20220326170503748.6dc41539.png" alt="image-20220326170503748"></p><p>分为以下四个步骤：</p><ul><li>初始标记（暂停用户线程）：仅仅只是标记一下GC Roots能直接关联到的对象，并且修改TAMS指针的值，让下一阶段用户线程并发运行时，能正确地在可用的Region中分配新对象。这个阶段需要停顿线程，但耗时很短，而且是借用进行Minor GC的时候同步完成的，所以G1收集器在这个阶段实际并没有额外的停顿。</li><li>并发标记：从GC Root开始对堆中对象进行可达性分析，递归扫描整个堆里的对象图，找出要回收的对象，这阶段耗时较长，但可与用户程序并发执行。</li><li>最终标记（暂停用户线程）：对用户线程做一个短暂的暂停，用于处理并发标记阶段漏标的那部分对象。</li><li>筛选回收：负责更新Region的统计数据，对各个Region的回收价值和成本进行排序，根据用户所期望的停顿时间来制定回收计划，可以自由选择任意多个Region构成回收集，然后把决定回收的那一部分Region的存活对象复制到空的Region中，再清理掉整个旧Region的全部空间。这里的操作涉及存活对象的移动，是必须暂停用户线程，由多个收集器线程并行完成的。</li></ul></blockquote><h3 id="类加载机制" tabindex="-1">类加载机制 <a class="header-anchor" href="#类加载机制" aria-label="Permalink to &quot;类加载机制&quot;">​</a></h3><h4 id="类文件结构" tabindex="-1">类文件结构 <a class="header-anchor" href="#类文件结构" aria-label="Permalink to &quot;类文件结构&quot;">​</a></h4><h5 id="类文件信息" tabindex="-1">类文件信息 <a class="header-anchor" href="#类文件信息" aria-label="Permalink to &quot;类文件信息&quot;">​</a></h5><blockquote><p>使用<code>javap</code>命令来对字节码文件进行反编译查看的，那么，它以二进制格式是怎么保存呢？我们可以使用WinHex软件来以十六进制查看字节码文件。</p></blockquote><h5 id="字节码指令" tabindex="-1">字节码指令 <a class="header-anchor" href="#字节码指令" aria-label="Permalink to &quot;字节码指令&quot;">​</a></h5><blockquote><p>虚拟机的指令是由一个字节长度的、代表某种特定操作含义的数字（操作码，类似于机器语言），操作后面也可以携带0个或多个参数一起执行。</p><p>JVM实际上并不是面向寄存器架构的，而是面向操作数栈，所以大多数指令都是不带参数的。</p><p>以当前的Main类中的main方法作为教材进行讲解：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">public static void main(String[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8;">   int i = 10;</span></span>
<span class="line"><span style="color:#e1e4e8;">   int a = i++;</span></span>
<span class="line"><span style="color:#e1e4e8;">   int b = ++i;</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">public static void main(String[] args) {</span></span>
<span class="line"><span style="color:#24292e;">   int i = 10;</span></span>
<span class="line"><span style="color:#24292e;">   int a = i++;</span></span>
<span class="line"><span style="color:#24292e;">   int b = ++i;</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><p>main方法中首先是定义了一个int类型的变量i，并赋值为10，然后变量a接收<code>i++</code>的值，变量b接收<code>++i</code>的值。</p><p>编译成字节码之后:</p><p><img src="/assets/image-20220326172930880.a65ca4b1.png" alt="image-20220326172930880"></p><ul><li>首先第一句，<code>bipush</code>，将10送至操作数栈顶。</li><li>接下来将操作数栈顶的数值存进1号本地变量，也就是变量i中。</li><li>接着将变量i中的值又丢向操作数栈顶</li><li>这里使用<code>iinc</code>指令，将1号本地变量的值增加1（结束之后i的值就是11了）</li><li>接着将操作数栈顶的值（操作数栈顶的值是10）存入2号本地变量（这下彻底知道i++到底干了啥才会先返回后自增了吧，从原理角度来说，实际上i是先自增了的，但由于这里取的是操作数栈中的值，所以说就得到了i之前的值）</li><li>接着往下，我们看到++i是先直接将i的值自增1</li><li>然后在将其值推向操作数栈顶</li></ul><p><img src="/assets/image-20220326172941902.aafb123d.png" alt="image-20220326172941902"></p></blockquote><h5 id="asm字节码编程" tabindex="-1">ASM字节码编程 <a class="header-anchor" href="#asm字节码编程" aria-label="Permalink to &quot;ASM字节码编程&quot;">​</a></h5><blockquote><p>既然字节码文件结构如此清晰，那么我们能否通过编程，来直接创建一个字节码文件呢？如果我们可以直接编写一个字节码文件，那么我们就可以省去编译的过程。ASM（某些JDK中内置）框架正是用于支持字节码编程的框架。</p><p>比如现在我们需要创建一个普通的Main类（暂时不写任何内容）</p><p>首先我们来看看如何通过编程创建一个Main类的字节码文件：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">public class Main {</span></span>
<span class="line"><span style="color:#e1e4e8;">   public static void main(String[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8;">       ClassWriter writer = new ClassWriter(ClassWriter.COMPUTE_MAXS);</span></span>
<span class="line"><span style="color:#e1e4e8;">   }</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">public class Main {</span></span>
<span class="line"><span style="color:#24292e;">   public static void main(String[] args) {</span></span>
<span class="line"><span style="color:#24292e;">       ClassWriter writer = new ClassWriter(ClassWriter.COMPUTE_MAXS);</span></span>
<span class="line"><span style="color:#24292e;">   }</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><p>首先需要获取<code>ClassWriter</code>对象，我们可以使用它来编辑类的字节码文件，在构造时需要传入参数：</p><ul><li>0 这种方式不会自动计算操作数栈和局部临时变量表大小，需要自己手动来指定</li><li>ClassWriter.COMPUTE_MAXS(1) 这种方式会自动计算上述操作数栈和局部临时变量表大小，但需要手动触发。</li><li>ClassWriter.COMPUTE_FRAMES(2) 这种方式不仅会计算上述操作数栈和局部临时变量表大小，而且会自动计算StackMapFrames</li></ul><p>这里我们使用<code>ClassWriter.COMPUTE_MAXS</code>即可。</p><p>接着我们首先需要指定类的一些基本信息：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">public class Main {</span></span>
<span class="line"><span style="color:#e1e4e8;">   public static void main(String[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8;">       ClassWriter writer = new ClassWriter(ClassWriter.COMPUTE_MAXS);</span></span>
<span class="line"><span style="color:#e1e4e8;">       //因为这里用到的常量比较多，所以说直接一次性静态导入：import static jdk.internal.org.objectweb.asm.Opcodes.*;</span></span>
<span class="line"><span style="color:#e1e4e8;">       writer.visit(V1_8, ACC_PUBLIC,&quot;com/test/Main&quot;, null, &quot;java/lang/Object&quot;,null);</span></span>
<span class="line"><span style="color:#e1e4e8;">   }</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">public class Main {</span></span>
<span class="line"><span style="color:#24292e;">   public static void main(String[] args) {</span></span>
<span class="line"><span style="color:#24292e;">       ClassWriter writer = new ClassWriter(ClassWriter.COMPUTE_MAXS);</span></span>
<span class="line"><span style="color:#24292e;">       //因为这里用到的常量比较多，所以说直接一次性静态导入：import static jdk.internal.org.objectweb.asm.Opcodes.*;</span></span>
<span class="line"><span style="color:#24292e;">       writer.visit(V1_8, ACC_PUBLIC,&quot;com/test/Main&quot;, null, &quot;java/lang/Object&quot;,null);</span></span>
<span class="line"><span style="color:#24292e;">   }</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><p>这里我们将字节码文件的版本设定位Java8，然后修饰符设定为<code>ACC_PUBLIC</code>代表<code>public class Main</code>，类名称注意要携带包名，标签设置为<code>null</code>，父类设定为Object类，然后没有实现任何接口，所以说最后一个参数也是<code>null</code>。</p><p>接着，一个简答的类字节码文件就创建好了，我们可以尝试将其进行保存：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">public class Main {</span></span>
<span class="line"><span style="color:#e1e4e8;">   public static void main(String[] args) {</span></span>
<span class="line"><span style="color:#e1e4e8;">       ClassWriter writer = new ClassWriter(ClassWriter.COMPUTE_MAXS);</span></span>
<span class="line"><span style="color:#e1e4e8;">       writer.visit(V1_8, ACC_PUBLIC,&quot;com/test/Main&quot;, null, &quot;java/lang/Object&quot;,null);</span></span>
<span class="line"><span style="color:#e1e4e8;">       //调用visitEnd表示结束编辑</span></span>
<span class="line"><span style="color:#e1e4e8;">       writer.visitEnd();</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">       try(FileOutputStream stream = new FileOutputStream(&quot;./Main.class&quot;)){</span></span>
<span class="line"><span style="color:#e1e4e8;">           stream.write(writer.toByteArray());  //直接通过ClassWriter将字节码文件转换为byte数组，并保存到根目录下</span></span>
<span class="line"><span style="color:#e1e4e8;">       } catch (IOException e) {</span></span>
<span class="line"><span style="color:#e1e4e8;">           e.printStackTrace();</span></span>
<span class="line"><span style="color:#e1e4e8;">       }</span></span>
<span class="line"><span style="color:#e1e4e8;">   }</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">public class Main {</span></span>
<span class="line"><span style="color:#24292e;">   public static void main(String[] args) {</span></span>
<span class="line"><span style="color:#24292e;">       ClassWriter writer = new ClassWriter(ClassWriter.COMPUTE_MAXS);</span></span>
<span class="line"><span style="color:#24292e;">       writer.visit(V1_8, ACC_PUBLIC,&quot;com/test/Main&quot;, null, &quot;java/lang/Object&quot;,null);</span></span>
<span class="line"><span style="color:#24292e;">       //调用visitEnd表示结束编辑</span></span>
<span class="line"><span style="color:#24292e;">       writer.visitEnd();</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">       try(FileOutputStream stream = new FileOutputStream(&quot;./Main.class&quot;)){</span></span>
<span class="line"><span style="color:#24292e;">           stream.write(writer.toByteArray());  //直接通过ClassWriter将字节码文件转换为byte数组，并保存到根目录下</span></span>
<span class="line"><span style="color:#24292e;">       } catch (IOException e) {</span></span>
<span class="line"><span style="color:#24292e;">           e.printStackTrace();</span></span>
<span class="line"><span style="color:#24292e;">       }</span></span>
<span class="line"><span style="color:#24292e;">   }</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><p>可以看到，在IDEA中反编译的结果为：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">package com.test;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">public class Main {</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">package com.test;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">public class Main {</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><p>我们知道，正常的类在编译之后，如果没有手动添加构造方法，那么会自带一个无参构造，但是我们这个类中还没有，所以我们来手动添加一个无参构造方法：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">//通过visitMethod方法可以添加一个新的方法</span></span>
<span class="line"><span style="color:#e1e4e8;">writer.visitMethod(ACC_PUBLIC, &quot;&lt;init&gt;&quot;, &quot;()V&quot;, null, null);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">//通过visitMethod方法可以添加一个新的方法</span></span>
<span class="line"><span style="color:#24292e;">writer.visitMethod(ACC_PUBLIC, &quot;&lt;init&gt;&quot;, &quot;()V&quot;, null, null);</span></span></code></pre></div><p>可以看到反编译的结果中已经存在了我们的构造方法：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">package com.test;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">public class Main {</span></span>
<span class="line"><span style="color:#e1e4e8;">   public Main() {</span></span>
<span class="line"><span style="color:#e1e4e8;">   }</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">package com.test;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">public class Main {</span></span>
<span class="line"><span style="color:#24292e;">   public Main() {</span></span>
<span class="line"><span style="color:#24292e;">   }</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><p>但是这样是不合法的，因为我们的构造方法还没有添加父类构造方法调用，所以说我们还需要在方法中添加父类构造方法调用指令：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">public com.test.Main();</span></span>
<span class="line"><span style="color:#e1e4e8;">   descriptor: ()V</span></span>
<span class="line"><span style="color:#e1e4e8;">   flags: ACC_PUBLIC</span></span>
<span class="line"><span style="color:#e1e4e8;">   Code:</span></span>
<span class="line"><span style="color:#e1e4e8;">     stack=1, locals=1, args_size=1</span></span>
<span class="line"><span style="color:#e1e4e8;">        0: aload_0</span></span>
<span class="line"><span style="color:#e1e4e8;">        1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="color:#e1e4e8;">        4: return</span></span>
<span class="line"><span style="color:#e1e4e8;">     LineNumberTable:</span></span>
<span class="line"><span style="color:#e1e4e8;">       line 11: 0</span></span>
<span class="line"><span style="color:#e1e4e8;">     LocalVariableTable:</span></span>
<span class="line"><span style="color:#e1e4e8;">       Start  Length  Slot  Name   Signature</span></span>
<span class="line"><span style="color:#e1e4e8;">           0       5     0  this   Lcom/test/Main;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">public com.test.Main();</span></span>
<span class="line"><span style="color:#24292e;">   descriptor: ()V</span></span>
<span class="line"><span style="color:#24292e;">   flags: ACC_PUBLIC</span></span>
<span class="line"><span style="color:#24292e;">   Code:</span></span>
<span class="line"><span style="color:#24292e;">     stack=1, locals=1, args_size=1</span></span>
<span class="line"><span style="color:#24292e;">        0: aload_0</span></span>
<span class="line"><span style="color:#24292e;">        1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="color:#24292e;">        4: return</span></span>
<span class="line"><span style="color:#24292e;">     LineNumberTable:</span></span>
<span class="line"><span style="color:#24292e;">       line 11: 0</span></span>
<span class="line"><span style="color:#24292e;">     LocalVariableTable:</span></span>
<span class="line"><span style="color:#24292e;">       Start  Length  Slot  Name   Signature</span></span>
<span class="line"><span style="color:#24292e;">           0       5     0  this   Lcom/test/Main;</span></span></code></pre></div><p>我们需要对方法进行详细编辑：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">//通过MethodVisitor接收返回值，进行进一步操作</span></span>
<span class="line"><span style="color:#E1E4E8;">MethodVisitor visitor </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> writer.</span><span style="color:#B392F0;">visitMethod</span><span style="color:#E1E4E8;">(ACC_PUBLIC, </span><span style="color:#9ECBFF;">&quot;&lt;init&gt;&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;()V&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#6A737D;">//开始编辑代码</span></span>
<span class="line"><span style="color:#E1E4E8;">visitor.</span><span style="color:#B392F0;">visitCode</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">//Label用于存储行号</span></span>
<span class="line"><span style="color:#E1E4E8;">Label l1 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Label</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#6A737D;">//当前代码写到哪行了，l1得到的就是多少行</span></span>
<span class="line"><span style="color:#E1E4E8;">visitor.</span><span style="color:#B392F0;">visitLabel</span><span style="color:#E1E4E8;">(l1);</span></span>
<span class="line"><span style="color:#6A737D;">//添加源码行数对应表（其实可以不用）</span></span>
<span class="line"><span style="color:#E1E4E8;">visitor.</span><span style="color:#B392F0;">visitLineNumber</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">11</span><span style="color:#E1E4E8;">, l1);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">//注意不同类型的指令需要用不同方法来调用，因为操作数不一致，具体的注释有写</span></span>
<span class="line"><span style="color:#E1E4E8;">visitor.</span><span style="color:#B392F0;">visitVarInsn</span><span style="color:#E1E4E8;">(ALOAD, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">visitor.</span><span style="color:#B392F0;">visitMethodInsn</span><span style="color:#E1E4E8;">(INVOKESPECIAL, </span><span style="color:#9ECBFF;">&quot;java/lang/Object&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;&lt;init&gt;&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;()V&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">visitor.</span><span style="color:#B392F0;">visitInsn</span><span style="color:#E1E4E8;">(RETURN);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">Label l2 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Label</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">visitor.</span><span style="color:#B392F0;">visitLabel</span><span style="color:#E1E4E8;">(l2);</span></span>
<span class="line"><span style="color:#6A737D;">//添加本地变量表，这里加的是this关键字，但是方法中没用到，其实可以不加</span></span>
<span class="line"><span style="color:#E1E4E8;">visitor.</span><span style="color:#B392F0;">visitLocalVariable</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;this&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;Lcom/test/Main;&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, l1, l2, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">//最后设定最大栈深度和本地变量数</span></span>
<span class="line"><span style="color:#E1E4E8;">visitor.</span><span style="color:#B392F0;">visitMaxs</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#6A737D;">//结束编辑</span></span>
<span class="line"><span style="color:#E1E4E8;">visitor.</span><span style="color:#B392F0;">visitEnd</span><span style="color:#E1E4E8;">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">//通过MethodVisitor接收返回值，进行进一步操作</span></span>
<span class="line"><span style="color:#24292E;">MethodVisitor visitor </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> writer.</span><span style="color:#6F42C1;">visitMethod</span><span style="color:#24292E;">(ACC_PUBLIC, </span><span style="color:#032F62;">&quot;&lt;init&gt;&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;()V&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6A737D;">//开始编辑代码</span></span>
<span class="line"><span style="color:#24292E;">visitor.</span><span style="color:#6F42C1;">visitCode</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">//Label用于存储行号</span></span>
<span class="line"><span style="color:#24292E;">Label l1 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Label</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#6A737D;">//当前代码写到哪行了，l1得到的就是多少行</span></span>
<span class="line"><span style="color:#24292E;">visitor.</span><span style="color:#6F42C1;">visitLabel</span><span style="color:#24292E;">(l1);</span></span>
<span class="line"><span style="color:#6A737D;">//添加源码行数对应表（其实可以不用）</span></span>
<span class="line"><span style="color:#24292E;">visitor.</span><span style="color:#6F42C1;">visitLineNumber</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">11</span><span style="color:#24292E;">, l1);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">//注意不同类型的指令需要用不同方法来调用，因为操作数不一致，具体的注释有写</span></span>
<span class="line"><span style="color:#24292E;">visitor.</span><span style="color:#6F42C1;">visitVarInsn</span><span style="color:#24292E;">(ALOAD, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">visitor.</span><span style="color:#6F42C1;">visitMethodInsn</span><span style="color:#24292E;">(INVOKESPECIAL, </span><span style="color:#032F62;">&quot;java/lang/Object&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;&lt;init&gt;&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;()V&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">visitor.</span><span style="color:#6F42C1;">visitInsn</span><span style="color:#24292E;">(RETURN);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">Label l2 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Label</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">visitor.</span><span style="color:#6F42C1;">visitLabel</span><span style="color:#24292E;">(l2);</span></span>
<span class="line"><span style="color:#6A737D;">//添加本地变量表，这里加的是this关键字，但是方法中没用到，其实可以不加</span></span>
<span class="line"><span style="color:#24292E;">visitor.</span><span style="color:#6F42C1;">visitLocalVariable</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;this&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;Lcom/test/Main;&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, l1, l2, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">//最后设定最大栈深度和本地变量数</span></span>
<span class="line"><span style="color:#24292E;">visitor.</span><span style="color:#6F42C1;">visitMaxs</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6A737D;">//结束编辑</span></span>
<span class="line"><span style="color:#24292E;">visitor.</span><span style="color:#6F42C1;">visitEnd</span><span style="color:#24292E;">();</span></span></code></pre></div><p>我们可以对编写好的class文件进行反编译，看看是不是和IDEA编译之后的结果差不多：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">{</span></span>
<span class="line"><span style="color:#e1e4e8;"> public com.test.Main();</span></span>
<span class="line"><span style="color:#e1e4e8;">   descriptor: ()V</span></span>
<span class="line"><span style="color:#e1e4e8;">   flags: ACC_PUBLIC</span></span>
<span class="line"><span style="color:#e1e4e8;">   Code:</span></span>
<span class="line"><span style="color:#e1e4e8;">     stack=1, locals=1, args_size=1</span></span>
<span class="line"><span style="color:#e1e4e8;">        0: aload_0</span></span>
<span class="line"><span style="color:#e1e4e8;">        1: invokespecial #8     // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="color:#e1e4e8;">        4: return</span></span>
<span class="line"><span style="color:#e1e4e8;">     LocalVariableTable:</span></span>
<span class="line"><span style="color:#e1e4e8;">       Start  Length  Slot  Name   Signature</span></span>
<span class="line"><span style="color:#e1e4e8;">           0       5     0  this   Lcom/test/Main</span></span>
<span class="line"><span style="color:#e1e4e8;">     LineNumberTable:</span></span>
<span class="line"><span style="color:#e1e4e8;">       line 11: 0</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">{</span></span>
<span class="line"><span style="color:#24292e;"> public com.test.Main();</span></span>
<span class="line"><span style="color:#24292e;">   descriptor: ()V</span></span>
<span class="line"><span style="color:#24292e;">   flags: ACC_PUBLIC</span></span>
<span class="line"><span style="color:#24292e;">   Code:</span></span>
<span class="line"><span style="color:#24292e;">     stack=1, locals=1, args_size=1</span></span>
<span class="line"><span style="color:#24292e;">        0: aload_0</span></span>
<span class="line"><span style="color:#24292e;">        1: invokespecial #8     // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="color:#24292e;">        4: return</span></span>
<span class="line"><span style="color:#24292e;">     LocalVariableTable:</span></span>
<span class="line"><span style="color:#24292e;">       Start  Length  Slot  Name   Signature</span></span>
<span class="line"><span style="color:#24292e;">           0       5     0  this   Lcom/test/Main</span></span>
<span class="line"><span style="color:#24292e;">     LineNumberTable:</span></span>
<span class="line"><span style="color:#24292e;">       line 11: 0</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><p>可以看到和之前的基本一致了，到此为止我们构造方法就编写完成了，接着我们来写一下main方法，一会我们就可以通过main方法来运行Java程序了。比如我们要编写这样一个程序：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] args) {</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(a);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] args) {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(a);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>看起来很简单的一个程序对吧，但是我们如果手动去组装指令，会极其麻烦！首先main方法是一个静态方法，并且方法是public权限，然后还有一个参数<code>String[] args</code>，所以说我们这里要写的内容有点小多：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">//开始安排main方法</span></span>
<span class="line"><span style="color:#E1E4E8;">MethodVisitor v2 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> writer.</span><span style="color:#B392F0;">visitMethod</span><span style="color:#E1E4E8;">(ACC_PUBLIC </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> ACC_STATIC, </span><span style="color:#9ECBFF;">&quot;main&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;([Ljava/lang/String;)V&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">v2.</span><span style="color:#B392F0;">visitCode</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#6A737D;">//记录起始行信息</span></span>
<span class="line"><span style="color:#E1E4E8;">Label l3 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Label</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">v2.</span><span style="color:#B392F0;">visitLabel</span><span style="color:#E1E4E8;">(l3);</span></span>
<span class="line"><span style="color:#E1E4E8;">v2.</span><span style="color:#B392F0;">visitLineNumber</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;">, l3);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">//首先是int a = 10的操作，执行指令依次为：</span></span>
<span class="line"><span style="color:#6A737D;">// bipush 10     将10推向操作数栈顶</span></span>
<span class="line"><span style="color:#6A737D;">// istore_1      将操作数栈顶元素保存到1号本地变量a中</span></span>
<span class="line"><span style="color:#E1E4E8;">v2.</span><span style="color:#B392F0;">visitIntInsn</span><span style="color:#E1E4E8;">(BIPUSH, </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">v2.</span><span style="color:#B392F0;">visitVarInsn</span><span style="color:#E1E4E8;">(ISTORE, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">Label l4 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Label</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">v2.</span><span style="color:#B392F0;">visitLabel</span><span style="color:#E1E4E8;">(l4);</span></span>
<span class="line"><span style="color:#6A737D;">//记录一下行信息</span></span>
<span class="line"><span style="color:#E1E4E8;">v2.</span><span style="color:#B392F0;">visitLineNumber</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">, l4);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">//这里是获取System类中的out静态变量（PrintStream接口），用于打印</span></span>
<span class="line"><span style="color:#E1E4E8;">v2.</span><span style="color:#B392F0;">visitFieldInsn</span><span style="color:#E1E4E8;">(GETSTATIC, </span><span style="color:#9ECBFF;">&quot;java/lang/System&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;out&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;Ljava/io/PrintStream;&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#6A737D;">//把a的值取出来</span></span>
<span class="line"><span style="color:#E1E4E8;">v2.</span><span style="color:#B392F0;">visitVarInsn</span><span style="color:#E1E4E8;">(ILOAD, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#6A737D;">//调用接口中的抽象方法println</span></span>
<span class="line"><span style="color:#E1E4E8;">v2.</span><span style="color:#B392F0;">visitMethodInsn</span><span style="color:#E1E4E8;">(INVOKEVIRTUAL, </span><span style="color:#9ECBFF;">&quot;java/io/PrintStream&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;println&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;(I)V&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">//再次记录行信息</span></span>
<span class="line"><span style="color:#E1E4E8;">Label l6 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Label</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">v2.</span><span style="color:#B392F0;">visitLabel</span><span style="color:#E1E4E8;">(l6);</span></span>
<span class="line"><span style="color:#E1E4E8;">v2.</span><span style="color:#B392F0;">visitLineNumber</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;">, l6);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">v2.</span><span style="color:#B392F0;">visitInsn</span><span style="color:#E1E4E8;">(RETURN);</span></span>
<span class="line"><span style="color:#E1E4E8;">Label l7 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Label</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">v2.</span><span style="color:#B392F0;">visitLabel</span><span style="color:#E1E4E8;">(l7);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">//最后是本地变量表中的各个变量</span></span>
<span class="line"><span style="color:#E1E4E8;">v2.</span><span style="color:#B392F0;">visitLocalVariable</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;args&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;[Ljava/lang/String;&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, l3, l7, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">v2.</span><span style="color:#B392F0;">visitLocalVariable</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;a&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;I&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, l4, l7, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">v2.</span><span style="color:#B392F0;">visitMaxs</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#6A737D;">//终于OK了</span></span>
<span class="line"><span style="color:#E1E4E8;">v2.</span><span style="color:#B392F0;">visitEnd</span><span style="color:#E1E4E8;">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">//开始安排main方法</span></span>
<span class="line"><span style="color:#24292E;">MethodVisitor v2 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> writer.</span><span style="color:#6F42C1;">visitMethod</span><span style="color:#24292E;">(ACC_PUBLIC </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> ACC_STATIC, </span><span style="color:#032F62;">&quot;main&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;([Ljava/lang/String;)V&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">v2.</span><span style="color:#6F42C1;">visitCode</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#6A737D;">//记录起始行信息</span></span>
<span class="line"><span style="color:#24292E;">Label l3 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Label</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">v2.</span><span style="color:#6F42C1;">visitLabel</span><span style="color:#24292E;">(l3);</span></span>
<span class="line"><span style="color:#24292E;">v2.</span><span style="color:#6F42C1;">visitLineNumber</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">13</span><span style="color:#24292E;">, l3);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">//首先是int a = 10的操作，执行指令依次为：</span></span>
<span class="line"><span style="color:#6A737D;">// bipush 10     将10推向操作数栈顶</span></span>
<span class="line"><span style="color:#6A737D;">// istore_1      将操作数栈顶元素保存到1号本地变量a中</span></span>
<span class="line"><span style="color:#24292E;">v2.</span><span style="color:#6F42C1;">visitIntInsn</span><span style="color:#24292E;">(BIPUSH, </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">v2.</span><span style="color:#6F42C1;">visitVarInsn</span><span style="color:#24292E;">(ISTORE, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">Label l4 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Label</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">v2.</span><span style="color:#6F42C1;">visitLabel</span><span style="color:#24292E;">(l4);</span></span>
<span class="line"><span style="color:#6A737D;">//记录一下行信息</span></span>
<span class="line"><span style="color:#24292E;">v2.</span><span style="color:#6F42C1;">visitLineNumber</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">, l4);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">//这里是获取System类中的out静态变量（PrintStream接口），用于打印</span></span>
<span class="line"><span style="color:#24292E;">v2.</span><span style="color:#6F42C1;">visitFieldInsn</span><span style="color:#24292E;">(GETSTATIC, </span><span style="color:#032F62;">&quot;java/lang/System&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;out&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;Ljava/io/PrintStream;&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6A737D;">//把a的值取出来</span></span>
<span class="line"><span style="color:#24292E;">v2.</span><span style="color:#6F42C1;">visitVarInsn</span><span style="color:#24292E;">(ILOAD, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6A737D;">//调用接口中的抽象方法println</span></span>
<span class="line"><span style="color:#24292E;">v2.</span><span style="color:#6F42C1;">visitMethodInsn</span><span style="color:#24292E;">(INVOKEVIRTUAL, </span><span style="color:#032F62;">&quot;java/io/PrintStream&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;println&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;(I)V&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">//再次记录行信息</span></span>
<span class="line"><span style="color:#24292E;">Label l6 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Label</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">v2.</span><span style="color:#6F42C1;">visitLabel</span><span style="color:#24292E;">(l6);</span></span>
<span class="line"><span style="color:#24292E;">v2.</span><span style="color:#6F42C1;">visitLineNumber</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">15</span><span style="color:#24292E;">, l6);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">v2.</span><span style="color:#6F42C1;">visitInsn</span><span style="color:#24292E;">(RETURN);</span></span>
<span class="line"><span style="color:#24292E;">Label l7 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Label</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">v2.</span><span style="color:#6F42C1;">visitLabel</span><span style="color:#24292E;">(l7);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">//最后是本地变量表中的各个变量</span></span>
<span class="line"><span style="color:#24292E;">v2.</span><span style="color:#6F42C1;">visitLocalVariable</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;args&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;[Ljava/lang/String;&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, l3, l7, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">v2.</span><span style="color:#6F42C1;">visitLocalVariable</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;a&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;I&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, l4, l7, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">v2.</span><span style="color:#6F42C1;">visitMaxs</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6A737D;">//终于OK了</span></span>
<span class="line"><span style="color:#24292E;">v2.</span><span style="color:#6F42C1;">visitEnd</span><span style="color:#24292E;">();</span></span></code></pre></div><p>可以看到，虽然很简单的一个程序，但是如果我们手动去编写字节码，实际上是非常麻烦的，但是要实现动态代理之类的操作（可以很方便地修改字节码创建子类），（其实Spring实现动态代理的CGLib框架底层正是调用了ASM框架来实现的）</p></blockquote><h4 id="类加载" tabindex="-1">类加载 <a class="header-anchor" href="#类加载" aria-label="Permalink to &quot;类加载&quot;">​</a></h4><h5 id="类加载过程" tabindex="-1">类加载过程 <a class="header-anchor" href="#类加载过程" aria-label="Permalink to &quot;类加载过程&quot;">​</a></h5><blockquote><p>一般在这些情况下，如果类没有被加载，那么会被自动加载：</p><ul><li>使用new关键字创建对象时</li><li>使用某个类的静态成员（包括方法和字段）的时候（当然，final类型的静态字段有可能在编译的时候被放到了当前类的常量池中，这种情况下是不会触发自动加载的）</li><li>使用反射对类信息进行获取的时候（之前的数据库驱动就是这样的）</li><li>加载一个类的子类时</li><li>加载接口的实现类，且接口带有<code>default</code>的方法默认实现时</li></ul></blockquote><blockquote><p>比如这种情况，那么需要用到另一个类中的成员字段，所以就必须将另一个类加载之后才能访问：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">       System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(Test.str);</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Test</span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">           System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;我被初始化了！&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">       }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> String str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;都看到这里了，不给个三连+关注吗？&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">       System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(Test.str);</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Test</span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">           System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;我被初始化了！&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">       }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> String str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;都看到这里了，不给个三连+关注吗？&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>这里我们就演示一个不太好理解的情况，我们现在将静态成员变量修改为final类型的：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">       System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(Test.str);</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Test</span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">           System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;我被初始化了！&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">       }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> String str </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;都看到这里了，不给个三连+关注吗？&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">       System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(Test.str);</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Test</span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">           System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;我被初始化了！&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">       }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> String str </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;都看到这里了，不给个三连+关注吗？&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>可以看到，在主方法中，我们使用了Test类的静态成员变量，并且此静态成员变量是一个final类型的，也就是说不可能再发生改变。那么各位觉得，Test类会像上面一样被初始化吗？</p><p>按照正常逻辑来说，既然要用到其他类中的字段，那么肯定需要加载其他类，但是这里我们结果发现，并没有对Test类进行加载，那么这是为什么呢？我们来看看Main类编译之后的字节码指令就知道了：<img src="/assets/image-20220326173153800.fef96f80.png" alt="image-20220326173153800"></p><p>很明显，这里使用的是<code>ldc</code>指令从常量池中将字符串取出并推向操作数栈顶，也就是说，在编译阶段，整个<code>Test.str</code>直接被替换为了对应的字符串（因为final不可能发生改变的，编译就会进行优化，直接来个字符串比你去加载类在获取快得多不是吗，反正结果都一样），所以说编译之后，实际上跟Test类半毛钱关系都没有了。</p><p>所以说，当你在某些情况下疑惑为什么类加载了或是没有加载时，可以从字节码指令的角度去进行分析，一般情况下，只要遇到<code>new</code>、<code>getstatic</code>、<code>putstatic</code>、<code>invokestatic</code>这些指令时，都会进行类加载，比如：<img src="/assets/image-20220326173205668.f57aaa48.png" alt="image-20220326173205668"></p><p>这里很明显，是一定会将Test类进行加载的。</p></blockquote><p>类的详细加载流程</p><blockquote><p><img src="/assets/image-20220326173258780.a9fa3edb.png" alt="image-20220326173258780"></p><p>首先类的生命周期一共有7个阶段，而首当其冲的就是加载，加载阶段需要获取此类的二进制数据流，比如我们要从硬盘中读取一个class文件，那么就可以通过文件输入流来获取类文件的<code>byte[]</code>，也可以是其他各种途径获取类文件的输入流，甚至网络传输并加载一个类也不是不可以。然后交给类加载器进行加载（类加载器可以是JDK内置的，也可以是开发者自己撸的，后面会详细介绍）类的所有信息会被加载到方法区中，并且在堆内存中会生成一个代表当前类的Class类对象（那么思考一下，同一个Class文件加载的类，是唯一存在的吗？），我们可以通过此对象以及反射机制来访问这个类的各种信息。</p><p>数组类要稍微特殊一点，通过前面的检验，我没发现数组在创建后是不会导致类加载的，数组类型本身不会通过类加载器进行加载的，不过你既然要往里面丢对象进去，那最终依然是要加载类的。</p><p>接着我们来看验证阶段，验证阶段相当于是对加载的类进行一次规范校验（因为一个类并不一定是由我们使用IDEA编译出来的，有可能是像我们之前那样直接用ASM框架写的一个），如果说类的任何地方不符合虚拟机规范，那么这个类是不会验证通过的，如果没有验证机制，那么一旦出现危害虚拟机的操作，整个程序会出现无法预料的后果。</p><p>验证阶段，首先是文件格式的验证：</p><ul><li>是否魔数为CAFEBABE开头。</li><li>主、次版本号是否可以由当前Java虚拟机运行</li><li>Class文件各个部分的完整性如何。</li></ul><p>有关类验证的详细过程，可以参考《深入理解Java虚拟机 第三版》268页。</p><p>接下来就是准备阶段了，这个阶段会为类变量分配内存，并为一些字段设定初始值，注意是系统规定的初始值，不是我们手动指定的初始值。</p><p>再往下就是解析阶段，此阶段是将常量池内的符号引用替换为直接引用的过程，也就是说，到这个时候，所有引用变量的指向都是已经切切实实地指向了内存中的对象了。</p><p>到这里，链接过程就结束了，也就是说这个时候类基本上已经完成大部分内容的初始化了。</p><p>最后就是真正的初始化阶段了，从这里开始，类中的Java代码部分，才会开始执行，还记得我们之前介绍的<code>&lt;clinit&gt;</code>方法吗，它就是在这个时候执行的，比如我们的类中存在一个静态成员变量，并且赋值为10，或是存在一个静态代码块，那么就会自动生成一个<code>&lt;clinit&gt;</code>方法来进行赋值操作，但是这个方法是自动生成的。</p><p>全部完成之后，我们的类就算是加载完成了。</p></blockquote><h5 id="类加载器" tabindex="-1">类加载器 <a class="header-anchor" href="#类加载器" aria-label="Permalink to &quot;类加载器&quot;">​</a></h5><blockquote><p>Java提供了类加载器，以便我们自己可以更好地控制类加载，我们可以自定义类加载器，也可以使用官方自带的类加载器去加载类。对于任意一个类，都必须由加载它的类加载器和这个类本身一起共同确立其在Java虚拟机中的唯一性。</p><p>也就是说，一个类可以由不同的类加载器加载，并且，不同的类加载器加载的出来的类，即使来自同一个Class文件，也是不同的，只有两个类来自同一个Class文件并且是由同一个类加载器加载的，才能判断为是同一个。默认情况下，所有的类都是由JDK自带的类加载器进行加载</p></blockquote><p>创建一个Test类用于测试：</p><blockquote><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> com.test;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Test</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> com.test;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Test</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>接着我们自己实现一个ClassLoader来加载我们的Test类，同时使用官方默认的类加载器来加载：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> ReflectiveOperationException {</span></span>
<span class="line"><span style="color:#E1E4E8;">       Class&lt;</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">&gt; testClass1 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Main.class.</span><span style="color:#B392F0;">getClassLoader</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">loadClass</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;com.test.Test&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">       CustomClassLoader customClassLoader </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CustomClassLoader</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">       Class&lt;</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">&gt; testClass2 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> customClassLoader.</span><span style="color:#B392F0;">loadClass</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;com.test.Test&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    	</span><span style="color:#6A737D;">//看看两个类的类加载器是不是同一个  --&gt;不是</span></span>
<span class="line"><span style="color:#E1E4E8;">       System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(testClass1.</span><span style="color:#B392F0;">getClassLoader</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">       System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(testClass2.</span><span style="color:#B392F0;">getClassLoader</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span></span>
<span class="line"><span style="color:#E1E4E8;">     	</span><span style="color:#6A737D;">//看看两个类是不是长得一模一样</span></span>
<span class="line"><span style="color:#E1E4E8;">       System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(testClass1);</span></span>
<span class="line"><span style="color:#E1E4E8;">       System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(testClass2);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">     	</span><span style="color:#6A737D;">//两个类是同一个吗？ --&gt;不是</span></span>
<span class="line"><span style="color:#E1E4E8;">       System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(testClass1 </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> testClass2);</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span></span>
<span class="line"><span style="color:#E1E4E8;">     	</span><span style="color:#6A737D;">//能成功实现类型转换吗？  --&gt;ClassCastException</span></span>
<span class="line"><span style="color:#E1E4E8;">       Test test </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (Test) testClass2.</span><span style="color:#B392F0;">newInstance</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CustomClassLoader</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">extends</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ClassLoader</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">       @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Class&lt;</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">&gt; </span><span style="color:#B392F0;">loadClass</span><span style="color:#E1E4E8;">(String </span><span style="color:#FFAB70;">name</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> ClassNotFoundException {</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> (FileInputStream stream </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">FileInputStream</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;./target/classes/&quot;</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">name.</span><span style="color:#B392F0;">replace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;.&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;/&quot;</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&quot;.class&quot;</span><span style="color:#E1E4E8;">)){</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#F97583;">byte</span><span style="color:#E1E4E8;">[] data </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">byte</span><span style="color:#E1E4E8;">[stream.</span><span style="color:#B392F0;">available</span><span style="color:#E1E4E8;">()];</span></span>
<span class="line"><span style="color:#E1E4E8;">               stream.</span><span style="color:#B392F0;">read</span><span style="color:#E1E4E8;">(data);</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;">(data.length </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">super</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">loadClass</span><span style="color:#E1E4E8;">(name);</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">defineClass</span><span style="color:#E1E4E8;">(name, data, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, data.length);</span></span>
<span class="line"><span style="color:#E1E4E8;">           } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (IOException </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">super</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">loadClass</span><span style="color:#E1E4E8;">(name);</span></span>
<span class="line"><span style="color:#E1E4E8;">           }</span></span>
<span class="line"><span style="color:#E1E4E8;">       }</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> ReflectiveOperationException {</span></span>
<span class="line"><span style="color:#24292E;">       Class&lt;</span><span style="color:#D73A49;">?</span><span style="color:#24292E;">&gt; testClass1 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Main.class.</span><span style="color:#6F42C1;">getClassLoader</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">loadClass</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;com.test.Test&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">       CustomClassLoader customClassLoader </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CustomClassLoader</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">       Class&lt;</span><span style="color:#D73A49;">?</span><span style="color:#24292E;">&gt; testClass2 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> customClassLoader.</span><span style="color:#6F42C1;">loadClass</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;com.test.Test&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    	</span><span style="color:#6A737D;">//看看两个类的类加载器是不是同一个  --&gt;不是</span></span>
<span class="line"><span style="color:#24292E;">       System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(testClass1.</span><span style="color:#6F42C1;">getClassLoader</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">       System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(testClass2.</span><span style="color:#6F42C1;">getClassLoader</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">				</span></span>
<span class="line"><span style="color:#24292E;">     	</span><span style="color:#6A737D;">//看看两个类是不是长得一模一样</span></span>
<span class="line"><span style="color:#24292E;">       System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(testClass1);</span></span>
<span class="line"><span style="color:#24292E;">       System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(testClass2);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">     	</span><span style="color:#6A737D;">//两个类是同一个吗？ --&gt;不是</span></span>
<span class="line"><span style="color:#24292E;">       System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(testClass1 </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> testClass2);</span></span>
<span class="line"><span style="color:#24292E;">     </span></span>
<span class="line"><span style="color:#24292E;">     	</span><span style="color:#6A737D;">//能成功实现类型转换吗？  --&gt;ClassCastException</span></span>
<span class="line"><span style="color:#24292E;">       Test test </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (Test) testClass2.</span><span style="color:#6F42C1;">newInstance</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CustomClassLoader</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">extends</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ClassLoader</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">       @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Class&lt;</span><span style="color:#D73A49;">?</span><span style="color:#24292E;">&gt; </span><span style="color:#6F42C1;">loadClass</span><span style="color:#24292E;">(String </span><span style="color:#E36209;">name</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> ClassNotFoundException {</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> (FileInputStream stream </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">FileInputStream</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;./target/classes/&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">name.</span><span style="color:#6F42C1;">replace</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;.&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;/&quot;</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&quot;.class&quot;</span><span style="color:#24292E;">)){</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#D73A49;">byte</span><span style="color:#24292E;">[] data </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">byte</span><span style="color:#24292E;">[stream.</span><span style="color:#6F42C1;">available</span><span style="color:#24292E;">()];</span></span>
<span class="line"><span style="color:#24292E;">               stream.</span><span style="color:#6F42C1;">read</span><span style="color:#24292E;">(data);</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">(data.length </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">super</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">loadClass</span><span style="color:#24292E;">(name);</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">defineClass</span><span style="color:#24292E;">(name, data, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, data.length);</span></span>
<span class="line"><span style="color:#24292E;">           } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (IOException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">super</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">loadClass</span><span style="color:#24292E;">(name);</span></span>
<span class="line"><span style="color:#24292E;">           }</span></span>
<span class="line"><span style="color:#24292E;">       }</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>通过结果我们发现，即使两个类是同一个Class文件加载的，只要类加载器不同，那么这两个类就是不同的两个类。</p><p>实际上，JDK内部提供的类加载器一共有三个，比如上面我们的Main类，其实是被AppClassLoader加载的，而JDK内部的类，都是由BootstrapClassLoader加载的，这其实就是为了实现<code>双亲委派机制</code>而做的。</p></blockquote><h5 id="双亲委派模型" tabindex="-1">双亲委派模型 <a class="header-anchor" href="#双亲委派模型" aria-label="Permalink to &quot;双亲委派模型&quot;">​</a></h5><p><img src="/assets/image-20220326174303809.78a2c82b.png" alt="image-20220326174303809"></p></div></div></main><footer class="VPDocFooter" data-v-6b87e69f data-v-ef5dee53><!--[--><!--]--><div class="edit-info" data-v-ef5dee53><!----><div class="last-updated" data-v-ef5dee53><p class="VPLastUpdated" data-v-ef5dee53 data-v-7e05ebdb>Last updated: <time datetime="2023-10-20T07:04:45.000Z" data-v-7e05ebdb></time></p></div></div><nav class="prev-next" data-v-ef5dee53><div class="pager" data-v-ef5dee53><a class="pager-link prev" href="/java/reactive.html" data-v-ef5dee53><span class="desc" data-v-ef5dee53>Previous page</span><span class="title" data-v-ef5dee53>Java响应式编程</span></a></div><div class="pager" data-v-ef5dee53><a class="pager-link next" href="/java/jvm2.html" data-v-ef5dee53><span class="desc" data-v-ef5dee53>Next page</span><span class="title" data-v-ef5dee53>Jvm调优</span></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"alg_algorithm_回溯.md\":\"63fd76b5\",\"alg_structure_图.md\":\"3f4997da\",\"bigdata_path.md\":\"1e7c9416\",\"alg_structure_堆.md\":\"cc3b05f0\",\"alg_structure_index.md\":\"cce38a97\",\"alg_algorithm_二分查找.md\":\"f2af1c41\",\"books_book0002_02演进-数据库_11-nosql：在高并发场景下，数据库和nosql如何做到互补？.md\":\"62bf4f30\",\"books_book0002_02演进-数据库_07-池化技术：如何减少频繁创建数据库连接的性能损耗？.md\":\"9bd7a64d\",\"books_book0002_08结束_结束语-学不可以已.md\":\"e2d8c12a\",\"books_book0002_07实战_40-信息流设计（二）：通用信息流系统的拉模式要如何做？.md\":\"a41541be\",\"books_book0002_02演进-数据库_10-发号器：如何保证分库分表后id的全局唯一性？.md\":\"89e17cad\",\"books_book0002_04演进-消息队列_20-当问到项目经历时，面试官究竟想要了解什么？.md\":\"e548f8e8\",\"books_book0002_04演进-消息队列_19-消息队列如何降低消息队列系统中消息的延迟？.md\":\"664abede\",\"books_book0002_03演进-缓存_13-缓存的使用姿势（一）：如何选择缓存的读写策略？.md\":\"4b10b9a2\",\"alg_algorithm_index.md\":\"eb34c27d\",\"books_book0002_06演进-维护_35-流量控制：高并发系统中我们如何操纵流量？.md\":\"b7bc10d8\",\"books_book0002_06演进-维护_33-配置管理：成千上万的配置项要如何管理？.md\":\"362a8aa7\",\"books_book0002_03演进-缓存_加餐-数据的签约应该如何做？.md\":\"bc42e56f\",\"books_book0002_05演进-分布式服务_25-分布式trace：横跨几十个分布式组件的慢请求要如何排查？.md\":\"05519a66\",\"books_book0002_07实战_38-计数系统设计（二）：50万qps下如何设计未读数系统？.md\":\"c4e51a03\",\"books_book0002_01基础_03-系统设计目标（一）：如何提升系统性能？.md\":\"828a371b\",\"cache_memcached.md\":\"9bfdb7fb\",\"books_book0002_05演进-分布式服务_23-rpc框架：10万qps下如何实现毫秒级的服务调用？.md\":\"7014f621\",\"books_book0002_05演进-分布式服务_26-负载均衡：怎样提升系统的横向扩展能力？.md\":\"11cb1eb0\",\"books_book0002_06演进-维护_32-压力测试：怎样设计全链路压力测试平台？.md\":\"e49818f2\",\"books_book0002_01基础_04-系统设计目标（二）：系统怎样做到高可用？.md\":\"14bcff24\",\"books_book0002_06演进-维护_30-给系统加上眼睛：服务端监控要怎么做？.md\":\"fb165392\",\"books_book0002_05演进-分布式服务_27-api网关：系统的门面要如何做呢？.md\":\"f2b1d784\",\"alg_topic_剑指offer_index.md\":\"a4fc4644\",\"bigdata_layering.md\":\"f37d055f\",\"books_book0002_07实战_39-信息流设计（一）：通用信息流系统的推模式要如何做？.md\":\"7613f5ef\",\"books_book0002_02演进-数据库_09-数据库优化方案（二）：写入数据量增加时，如何实现分库分表？.md\":\"18bd6529\",\"books_book0002_06演进-维护_34-降级熔断：如何屏蔽非核心系统故障的影响？.md\":\"cb20466b\",\"books_book0002_01基础_02-架构分层：我们为什么一定要这么做？.md\":\"68fea887\",\"books_book0002_00开篇_index.md\":\"bd860ba8\",\"books_book0002_05演进-分布式服务_21-系统架构：每秒1万次请求的系统要做服务化拆分吗？.md\":\"2a72629a\",\"alg_algorithm_双指针.md\":\"54d2e296\",\"books_book0002_04演进-消息队列_18-消息投递：如何保证消息仅仅被消费一次？.md\":\"2d4f0eb6\",\"books_book0002_03演进-缓存_15-缓存的使用姿势（三）：缓存穿透了怎么办？.md\":\"b4235165\",\"alg_structure_哈希表.md\":\"8848afe3\",\"alg_algorithm_排序.md\":\"bf9f753d\",\"books_book0002_03演进-缓存_16-cdn：静态资源如何加速？.md\":\"1dfd8901\",\"alg_topic_leetcode_index.md\":\"b8e7ac82\",\"alg_algorithm_动态规划.md\":\"3bad5ac3\",\"books_book0002_05演进-分布式服务_29-service mesh：如何屏蔽服务化系统的服务治理细节？.md\":\"95031c26\",\"books_book0002_01基础_05-系统设计目标（三）：如何让系统易于扩展？.md\":\"11e2466b\",\"books_book0002_03演进-缓存_12-缓存：数据库成为瓶颈后，动态数据的查询要如何加速？.md\":\"cc6fbde1\",\"books_book0002_05演进-分布式服务_28-多机房部署：跨地域的分布式系统如何做？.md\":\"6eaeeda8\",\"books_book0002_05演进-分布式服务_24-注册中心：分布式系统如何寻址？.md\":\"6247e583\",\"database_mongodb.md\":\"30b4cfb5\",\"books_book0002_01基础_01-高并发系统：它的通用设计方法是什么？.md\":\"7b0fe2a2\",\"books_book0002_03演进-缓存_14-缓存的使用姿势（二）：缓存如何做到高可用？.md\":\"9690b5eb\",\"books_book0003_index.md\":\"cd9614ff\",\"books_book0001_index.md\":\"aaaefa7e\",\"alg_structure_数组与链表.md\":\"8f6a99ff\",\"books_book0002_06演进-维护_31-应用性能管理：用户的使用体验应该如何监控？.md\":\"ed99301a\",\"books_book0002_04演进-消息队列_17-消息队列：秒杀如何处理每秒上万的下单请求？.md\":\"653b9831\",\"books_book0002_02演进-数据库_08-数据库优化方案（一）：查询请求增加时，如何做主从分离？.md\":\"54d40457\",\"container_k8s.md\":\"44295a7d\",\"books_book0002_05演进-分布式服务_22-微服务架构：微服务化后系统架构要如何改造？.md\":\"cbdf5050\",\"alg_structure_树.md\":\"f525f701\",\"design_skill.md\":\"d471477f\",\"design_log.md\":\"b185df3e\",\"database_index.md\":\"60934f9d\",\"database_oracle.md\":\"16ab0658\",\"container_linux.md\":\"2d4975cd\",\"cache_redisson.md\":\"88021973\",\"database_tidb.md\":\"adf76c65\",\"design_graypublish.md\":\"84cd856e\",\"books_book0002_07实战_37-计数系统设计（一）：面对海量数据的计数器要如何做？.md\":\"40916437\",\"design_electronicbusiness.md\":\"f4dd49fa\",\"design_distributedid.md\":\"b932e6c8\",\"framework_alibaba.md\":\"1a30e638\",\"design_thirdinterface.md\":\"b3f7dd76\",\"database_postgresql.md\":\"80dc00d2\",\"design_mallbff.md\":\"5e8b0ff7\",\"design_sso.md\":\"74776df0\",\"design_orderbusiness.md\":\"8f1abf52\",\"design_distributedtransaction.md\":\"ef95d62b\",\"design_index.md\":\"660f7902\",\"container_docker.md\":\"6de492fe\",\"alg_structure_队列与栈.md\":\"987e5d4e\",\"cache_redis.md\":\"ffbea791\",\"framework_springcloud.md\":\"a9352d21\",\"design_multicache.md\":\"7def197a\",\"middleware_auth.md\":\"b0dada6e\",\"middleware_mq.md\":\"4f60d427\",\"middleware_db.md\":\"5fa42524\",\"java_reactive.md\":\"86cb8206\",\"second_authority_satoken.md\":\"94236a8a\",\"second_cloud_hystrix.md\":\"66e272bf\",\"second_cloud_springcloudstream.md\":\"27b35ae8\",\"index.md\":\"72cc2e6d\",\"second_alibaba_nacos.md\":\"93a376e9\",\"optimize_index.md\":\"40bf5323\",\"java_jvm2.md\":\"832d0f64\",\"second_authority_oauth2.md\":\"1219d433\",\"second_alibaba_dubbo.md\":\"7064567c\",\"second_flow_flowable.md\":\"ef07872c\",\"design_synces.md\":\"2a3fbc5f\",\"problem_index.md\":\"03e6043b\",\"second_db_canal.md\":\"3ab73cc5\",\"middleware_task.md\":\"aef5837e\",\"middleware_server.md\":\"da957b0c\",\"second_alibaba_sentinel.md\":\"7fb764cf\",\"zeleted_util_feilong.md\":\"4ac0997c\",\"zeleted_standard_redis开发规范.md\":\"4bff1031\",\"second_server_nginx.md\":\"4b5499b7\",\"second_mq_pulsar.md\":\"0577889b\",\"second_search_elasticsearch.md\":\"c8959347\",\"second_alibaba_seata.md\":\"db4877bc\",\"second_flow_liteflow.md\":\"a4572424\",\"second_task_powerjob.md\":\"d9934c07\",\"middleware_flow.md\":\"fff46fa2\",\"problem_20230721q1.md\":\"1b6e651f\",\"second_mq_kafka.md\":\"b8d9cc86\",\"problem_20231020q1.md\":\"7c56edd8\",\"second_db_mybatis.md\":\"a921dc4e\",\"second_alibaba_zookeeper.md\":\"b38fd1d6\",\"problem_20230621q1.md\":\"c66905a5\",\"optimize_20230802q1.md\":\"dcf00778\",\"zeleted_util_log.md\":\"10772815\",\"second_task_xxljob.md\":\"fc4a7f5d\",\"problem_20230519q1.md\":\"c25cec78\",\"middleware_search.md\":\"c4cb0dcd\",\"updated_index.md\":\"a40cc695\",\"zeleted_test_testablemock.md\":\"35199cd9\",\"second_db_druid.md\":\"2035bcb5\",\"second_db_mybatisplus.md\":\"0159f364\",\"zeleted_standard_mysql规范.md\":\"40692829\",\"second_mq_rabbitmq.md\":\"2cb8e6f5\",\"second_cloud_springcloudgateway.md\":\"7753fe1a\",\"java_feature.md\":\"74b48f43\",\"zeleted_test_mockito.md\":\"b0291a0d\",\"second_flow_compileflow.md\":\"ea54f4c8\",\"zeleted_test_charles.md\":\"567b4067\",\"shorthand_index.md\":\"aaca2434\",\"framework_springboot.md\":\"1fe63edd\",\"second_server_openresty.md\":\"aa13c718\",\"second_cloud_openfeign.md\":\"eb5001b9\",\"java_jvm.md\":\"9e61a16e\",\"zeleted_test_jmh.md\":\"fe129a8a\",\"zeleted_standard_mysql习题.md\":\"0d93e461\",\"database_mysql.md\":\"f5fdf254\",\"zeleted_util_vavr.md\":\"f5d0420f\",\"zeleted_test_apachejmeter.md\":\"af5b8efa\",\"ide_index.md\":\"18ae803c\",\"second_mq_rocketmq.md\":\"60842893\",\"second_db_shardingjdbc.md\":\"6745aaf0\",\"java_index.md\":\"13e1531a\",\"second_server_netty.md\":\"e12e1461\",\"utils_index.md\":\"2f4de460\",\"framework_spring.md\":\"7b514879\",\"java_juc.md\":\"d1cd8981\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"某不知名小开发\",\"description\":\"在线文档\",\"base\":\"/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"siteTitle\":\"TheWe1\",\"logo\":\"/logo.png\",\"nav\":[{\"text\":\"更新日志\",\"link\":\"/updated/index\"},{\"text\":\"大数据\",\"items\":[{\"text\":\"大数据学习路线\",\"link\":\"/bigdata/path\"},{\"text\":\"数仓分层设计架构\",\"link\":\"/bigdata/layering\"}]},{\"text\":\"算法\",\"items\":[{\"text\":\"数据结构\",\"link\":\"/alg/structure/index\"},{\"text\":\"算法提升\",\"link\":\"/alg/algorithm/index\"},{\"text\":\"剑指Offer\",\"link\":\"https://doocs.github.io/leetcode/#/lcof2/README\"},{\"text\":\"LeetCode\",\"link\":\"https://doocs.github.io/leetcode/#/\"}]},{\"text\":\"经验\",\"items\":[{\"text\":\"生产问题排查\",\"link\":\"/problem/index\"},{\"text\":\"生产性能优化\",\"link\":\"/optimize/index\"},{\"text\":\"开发过程速记\",\"link\":\"/shorthand/index\"},{\"text\":\"常用工具类库\",\"link\":\"/utils/index\"},{\"text\":\"常用开发工具\",\"link\":\"/ide/index\"}]},{\"text\":\"文献\",\"items\":[{\"text\":\"如何设计一个秒杀系统\",\"link\":\"/books/book0001/index\"},{\"text\":\"高并发系统设计40问\",\"link\":\"/books/book0002/00开篇/index\"},{\"text\":\"DDD领域驱动设计\",\"link\":\"/books/book0003/index\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/liuxiaowei2018\"}],\"search\":{\"provider\":\"local\"},\"lastUpdated\":\"Last Updated\",\"smoothScroll\":true,\"sidebar\":{\"/java\":[{\"text\":\"JavaSe\",\"collapsible\":true,\"items\":[{\"text\":\"Java基础\",\"link\":\"/java/index\"},{\"text\":\"Java新特性\",\"link\":\"/java/feature\"},{\"text\":\"Java多线程\",\"link\":\"/java/juc\"},{\"text\":\"Java响应式编程\",\"link\":\"/java/reactive\"},{\"text\":\"Jvm基础\",\"link\":\"/java/jvm\"},{\"text\":\"Jvm调优\",\"link\":\"/java/jvm2\"}]}],\"/alg/structure\":[{\"text\":\"数据结构\",\"collapsible\":true,\"items\":[{\"text\":\"1.数据结构入门\",\"link\":\"/alg/structure/index\"},{\"text\":\"2.数组与链表\",\"link\":\"/alg/structure/数组与链表\"},{\"text\":\"3.队列与栈\",\"link\":\"/alg/structure/队列与栈\"},{\"text\":\"4.哈希表\",\"link\":\"/alg/structure/哈希表\"},{\"text\":\"5.树\",\"link\":\"/alg/structure/树\"}]}],\"/alg/algorithm\":[{\"text\":\"算法\",\"collapsible\":true,\"items\":[{\"text\":\"1.算法入门\",\"link\":\"/alg/algorithm/index\"},{\"text\":\"2.排序\",\"link\":\"/alg/algorithm/排序\"},{\"text\":\"3.二分查找\",\"link\":\"/alg/algorithm/二分查找\"},{\"text\":\"4.双指针\",\"link\":\"/alg/algorithm/双指针\"},{\"text\":\"5.回溯\",\"link\":\"/alg/algorithm/回溯\"},{\"text\":\"6.动态规划\",\"link\":\"/alg/algorithm/动态规划\"}]}],\"/framework\":[{\"text\":\"框架\",\"collapsible\":true,\"items\":[{\"text\":\"spring\",\"link\":\"/framework/spring\"},{\"text\":\"springBoot\",\"link\":\"/framework/springBoot\"},{\"text\":\"springCloud\",\"link\":\"/framework/springCloud\"},{\"text\":\"springCloudAlibaba\",\"link\":\"/framework/alibaba\"}]}],\"/database\":[{\"text\":\"数据库\",\"collapsible\":true,\"items\":[{\"text\":\"1.数据库设计\",\"link\":\"/database/index\"},{\"text\":\"2.MySQL\",\"link\":\"/database/mysql\"},{\"text\":\"3.Oracle\",\"link\":\"/database/oracle\"},{\"text\":\"4.PostgreSQL\",\"link\":\"/database/postgreSQL\"},{\"text\":\"5.MongoDB\",\"link\":\"/database/mongoDB\"},{\"text\":\"6.TiDB\",\"link\":\"/database/tiDB\"}]}],\"/cache\":[{\"text\":\"缓存\",\"collapsible\":true,\"items\":[{\"text\":\"1.redis\",\"link\":\"/cache/redis\"},{\"text\":\"2.redisson\",\"link\":\"/cache/redisson\"},{\"text\":\"3.memcached\",\"link\":\"/cache/memcached\"}]}],\"/middleware\":[{\"text\":\"中间件\",\"collapsible\":true,\"items\":[{\"text\":\"消息队列中间件\",\"link\":\"/middleware/mq\"},{\"text\":\"数据库中间件\",\"link\":\"/middleware/db\"},{\"text\":\"搜索中间件\",\"link\":\"/middleware/search\"},{\"text\":\"任务调度中间件\",\"link\":\"/middleware/task\"},{\"text\":\"工作流中间件\",\"link\":\"/middleware/flow\"},{\"text\":\"权限框架中间件\",\"link\":\"/middleware/auth\"},{\"text\":\"服务器中间件\",\"link\":\"/middleware/server\"}]}],\"/container\":[{\"text\":\"容器化技术\",\"collapsible\":true,\"items\":[{\"text\":\"linux\",\"link\":\"/container/linux\"},{\"text\":\"docker\",\"link\":\"/container/docker\"},{\"text\":\"k8s\",\"link\":\"/container/k8s\"}]}],\"/second/mq\":[{\"text\":\"消息中间件\",\"collapsible\":true,\"items\":[{\"text\":\"rabbitMQ\",\"link\":\"/second/mq/rabbitMQ\"},{\"text\":\"rocketMQ\",\"link\":\"/second/mq/rocketMQ\"},{\"text\":\"kafka\",\"link\":\"/second/mq/kafka\"},{\"text\":\"pluar\",\"link\":\"/second/mq/pulsar\"}]}],\"/second/db\":[{\"text\":\"数据库中间件\",\"collapsible\":true,\"items\":[{\"text\":\"mybatis\",\"link\":\"/second/db/mybatis\"},{\"text\":\"mybatisPlus\",\"link\":\"/second/db/mybatisPlus\"},{\"text\":\"druid\",\"link\":\"/second/db/druid\"},{\"text\":\"shardingJdbc\",\"link\":\"/second/db/shardingJdbc\"},{\"text\":\"canal\",\"link\":\"/second/db/canal\"}]}],\"/second/search\":[{\"text\":\"搜索中间件\",\"collapsible\":true,\"items\":[{\"text\":\"elasticsearch\",\"link\":\"/second/search/elasticsearch\"}]}],\"/second/task\":[{\"text\":\"任务调度中间件\",\"collapsible\":true,\"items\":[{\"text\":\"xxlJob\",\"link\":\"/second/task/xxlJob\"},{\"text\":\"powerJob\",\"link\":\"/second/task/powerJob\"}]}],\"/second/flow\":[{\"text\":\"工作流中间件\",\"collapsible\":true,\"items\":[{\"text\":\"flowable\",\"link\":\"/second/flow/flowable\"},{\"text\":\"compileflow\",\"link\":\"/second/flow/compileflow\"},{\"text\":\"liteflow\",\"link\":\"/second/flow/liteflow\"}]}],\"/second/server\":[{\"text\":\"服务器中间件\",\"collapsible\":true,\"items\":[{\"text\":\"nginx\",\"link\":\"/second/server/nginx\"},{\"text\":\"netty\",\"link\":\"/second/server/netty\"},{\"text\":\"openResty\",\"link\":\"/second/server/openresty\"}]}],\"/second/alibaba\":[{\"text\":\"阿里中间件\",\"collapsible\":true,\"items\":[{\"text\":\"dubbo\",\"link\":\"/second/alibaba/dubbo\"},{\"text\":\"nacos\",\"link\":\"/second/alibaba/nacos\"},{\"text\":\"seata\",\"link\":\"/second/alibaba/seata\"},{\"text\":\"sentinel\",\"link\":\"/second/alibaba/sentinel\"},{\"text\":\"zookeeper\",\"link\":\"/second/alibaba/zookeeper\"}]}],\"/second/cloud\":[{\"text\":\"SpringCloud\",\"collapsible\":true,\"items\":[{\"text\":\"springCloudOpenFeign\",\"link\":\"/second/cloud/openFeign\"},{\"text\":\"springCloudHystrix\",\"link\":\"/second/cloud/hystrix\"},{\"text\":\"springCloudGateway\",\"link\":\"/second/cloud/springCloudGateway\"},{\"text\":\"springCloudStream\",\"link\":\"/second/cloud/springCloudStream\"}]}],\"/second/authority\":[{\"text\":\"权限框架中间件\",\"collapsible\":true,\"items\":[{\"text\":\"oauth2\",\"link\":\"/second/authority/oauth2\"},{\"text\":\"saToken\",\"link\":\"/second/authority/saToken\"}]}],\"/design/\":[{\"text\":\"架构设计\",\"collapsible\":true,\"items\":[{\"text\":\"如何做好架构设计\",\"link\":\"/design/index\"},{\"text\":\"单点登录架构\",\"link\":\"/design/sso\"},{\"text\":\"多级缓存架构\",\"link\":\"/design/multiCache\"},{\"text\":\"灰度发布架构\",\"link\":\"/design/grayPublish\"},{\"text\":\"秒杀系统架构\",\"link\":\"/design/skill\"},{\"text\":\"日志系统架构\",\"link\":\"/design/log\"},{\"text\":\"电商业务架构\",\"link\":\"/design/electronicBusiness\"},{\"text\":\"订单系统架构\",\"link\":\"/design/orderBusiness\"},{\"text\":\"商城系统BFF演进架构\",\"link\":\"/design/mallBff\"},{\"text\":\"分布式ID架构\",\"link\":\"/design/distributedId\"},{\"text\":\"分布式事务架构\",\"link\":\"/design/distributedTransaction\"},{\"text\":\"ES数据同步架构\",\"link\":\"/design/syncEs\"},{\"text\":\"三方接口调用架构\",\"link\":\"/design/thirdInterface\"}]}],\"/problem\":[{\"text\":\"生产问题记录\",\"collapsible\":true,\"items\":[{\"text\":\"1.如何排查线上问题\",\"link\":\"/problem/index\"},{\"text\":\"2.线上服务器端口故障问题记录\",\"link\":\"/problem/20230519q1\"},{\"text\":\"3.线上pod 反复重启问题记录\",\"link\":\"/problem/20230621q1\"},{\"text\":\"4.线上pod OMM问题记录\",\"link\":\"/problem/20230721q1\"},{\"text\":\"5.线上pod 死锁问题记录\",\"link\":\"/problem/20231020q1\"}]}],\"/optimize\":[{\"text\":\"生产性能优化\",\"collapsible\":true,\"items\":[{\"text\":\"1.如何做好性能优化\",\"link\":\"/optimize/index\"},{\"text\":\"2.接口性能优化记录1\",\"link\":\"/optimize/20230802q1\"}]}],\"/books/book0001\":[{\"text\":\"如何设计一个秒杀系统\",\"collapsible\":true,\"items\":[{\"text\":\"如何设计一个秒杀系统-许令波\",\"link\":\"/books/book0001/index\"}]}],\"/books/book0002\":[{\"text\":\"开篇\",\"collapsible\":true,\"items\":[{\"text\":\"00-开篇词-为什么你要学习高并发系统设计？\",\"link\":\"/books/book0002/00开篇/index\"}]},{\"text\":\"基础\",\"collapsible\":true,\"items\":[{\"text\":\"01-高并发系统：它的通用设计方法是什么？\",\"link\":\"/books/book0002/01基础/01-高并发系统：它的通用设计方法是什么？\"},{\"text\":\"02-架构分层：我们为什么一定要这么做？\",\"link\":\"/books/book0002/01基础/02-架构分层：我们为什么一定要这么做？\"},{\"text\":\"03-系统设计目标（一）：如何提升系统性能？\",\"link\":\"/books/book0002/01基础/03-系统设计目标（一）：如何提升系统性能？\"},{\"text\":\"04-系统设计目标（二）：系统怎样做到高可用？\",\"link\":\"/books/book0002/01基础/04-系统设计目标（二）：系统怎样做到高可用？\"},{\"text\":\"05-系统设计目标（三）：如何让系统易于扩展？\",\"link\":\"/books/book0002/01基础/05-系统设计目标（三）：如何让系统易于扩展？\"}]},{\"text\":\"演进 - 数据库篇\",\"collapsible\":true,\"items\":[{\"text\":\"07-池化技术：如何减少频繁创建数据库连接的性能损耗？\",\"link\":\"/books/book0002/02演进-数据库/07-池化技术：如何减少频繁创建数据库连接的性能损耗？\"},{\"text\":\"08-数据库优化方案（一）：查询请求增加时，如何做主从分离？\",\"link\":\"/books/book0002/02演进-数据库/08-数据库优化方案（一）：查询请求增加时，如何做主从分离？\"},{\"text\":\"09-数据库优化方案（二）：写入数据量增加时，如何实现分库分表？\",\"link\":\"/books/book0002/02演进-数据库/09-数据库优化方案（二）：写入数据量增加时，如何实现分库分表？\"},{\"text\":\"10-发号器：如何保证分库分表后ID的全局唯一性？\",\"link\":\"/books/book0002/02演进-数据库/10-发号器：如何保证分库分表后ID的全局唯一性？\"},{\"text\":\"11-NoSQL：在高并发场景下，数据库和NoSQL如何做到互补？\",\"link\":\"/books/book0002/02演进-数据库/11-NoSQL：在高并发场景下，数据库和NoSQL如何做到互补？\"}]},{\"text\":\"演进 - 缓存篇\",\"collapsible\":true,\"items\":[{\"text\":\"12-缓存：数据库成为瓶颈后，动态数据的查询要如何加速？\",\"link\":\"/books/book0002/03演进-缓存/12-缓存：数据库成为瓶颈后，动态数据的查询要如何加速？\"},{\"text\":\"13-缓存的使用姿势（一）：如何选择缓存的读写策略？\",\"link\":\"/books/book0002/03演进-缓存/13-缓存的使用姿势（一）：如何选择缓存的读写策略？\"},{\"text\":\"14-缓存的使用姿势（二）：缓存如何做到高可用？\",\"link\":\"/books/book0002/03演进-缓存/14-缓存的使用姿势（二）：缓存如何做到高可用？\"},{\"text\":\"15-缓存的使用姿势（三）：缓存穿透了怎么办？\",\"link\":\"/books/book0002/03演进-缓存/15-缓存的使用姿势（三）：缓存穿透了怎么办？\"},{\"text\":\"加餐-数据的签约应该如何做？\",\"link\":\"/books/book0002/03演进-缓存/加餐-数据的签约应该如何做？\"}]},{\"text\":\"演进 - 消息队列篇\",\"collapsible\":true,\"items\":[{\"text\":\"17-消息队列：秒杀如何处理每秒上万的下单请求？\",\"link\":\"/books/book0002/04演进-消息队列/17-消息队列：秒杀如何处理每秒上万的下单请求？\"},{\"text\":\"18-消息投递：如何保证消息仅仅被消费一次？\",\"link\":\"/books/book0002/04演进-消息队列/18-消息投递：如何保证消息仅仅被消费一次？\"},{\"text\":\"19-消息队列如何降低消息队列系统中消息的延迟？\",\"link\":\"/books/book0002/04演进-消息队列/19-消息队列如何降低消息队列系统中消息的延迟？\"},{\"text\":\"20-当问到项目经历时，面试官究竟想要了解什么？\",\"link\":\"/books/book0002/04演进-消息队列/20-当问到项目经历时，面试官究竟想要了解什么？\"}]},{\"text\":\"演进 - 分布式服务\",\"collapsible\":true,\"items\":[{\"text\":\"21-系统架构：每秒1万次请求的系统要做服务化拆分吗？\",\"link\":\"/books/book0002/05演进-分布式服务/21-系统架构：每秒1万次请求的系统要做服务化拆分吗？\"},{\"text\":\"22-微服务架构：微服务化后系统架构要如何改造？\",\"link\":\"/books/book0002/05演进-分布式服务/22-微服务架构：微服务化后系统架构要如何改造？\"},{\"text\":\"23-系统架构：每秒1万次请求的系统要做服务化拆分吗？\",\"link\":\"/books/book0002/05演进-分布式服务/23-RPC框架：10万QPS下如何实现毫秒级的服务调用？\"},{\"text\":\"24-注册中心：分布式系统如何寻址？\",\"link\":\"/books/book0002/05演进-分布式服务/24-注册中心：分布式系统如何寻址？\"},{\"text\":\"25-分布式Trace：横跨几十个分布式组件的慢请求要如何排查？\",\"link\":\"/books/book0002/05演进-分布式服务/25-分布式Trace：横跨几十个分布式组件的慢请求要如何排查？\"},{\"text\":\"26-负载均衡：怎样提升系统的横向扩展能力？\",\"link\":\"/books/book0002/05演进-分布式服务/26-负载均衡：怎样提升系统的横向扩展能力？\"},{\"text\":\"27-API网关：系统的门面要如何做呢？\",\"link\":\"/books/book0002/05演进-分布式服务/27-API网关：系统的门面要如何做呢？\"},{\"text\":\"28-多机房部署：跨地域的分布式系统如何做？\",\"link\":\"/books/book0002/05演进-分布式服务/28-多机房部署：跨地域的分布式系统如何做？\"},{\"text\":\"29-Service Mesh：如何屏蔽服务化系统的服务治理细节？\",\"link\":\"/books/book0002/05演进-分布式服务/29-Service Mesh：如何屏蔽服务化系统的服务治理细节？\"}]},{\"text\":\"演进 - 维护\",\"collapsible\":true,\"items\":[{\"text\":\"30-为什么你要学习高并发系统设计？\",\"link\":\"/books/book0002/06演进-维护/30-给系统加上眼睛：服务端监控要怎么做？\"},{\"text\":\"31-应用性能管理：用户的使用体验应该如何监控？\",\"link\":\"/books/book0002/06演进-维护/31-应用性能管理：用户的使用体验应该如何监控？\"},{\"text\":\"32-压力测试：怎样设计全链路压力测试平台？\",\"link\":\"/books/book0002/06演进-维护/32-压力测试：怎样设计全链路压力测试平台？\"},{\"text\":\"33-配置管理：成千上万的配置项要如何管理？\",\"link\":\"/books/book0002/06演进-维护/33-配置管理：成千上万的配置项要如何管理？\"},{\"text\":\"34-降级熔断：如何屏蔽非核心系统故障的影响？\",\"link\":\"/books/book0002/06演进-维护/34-降级熔断：如何屏蔽非核心系统故障的影响？\"},{\"text\":\"35-流量控制：高并发系统中我们如何操纵流量？\",\"link\":\"/books/book0002/06演进-维护/35-流量控制：高并发系统中我们如何操纵流量？\"}]},{\"text\":\"实战\",\"collapsible\":true,\"items\":[{\"text\":\"37-计数系统设计（一）：面对海量数据的计数器要如何做？\",\"link\":\"/books/book0002/07实战/37-计数系统设计（一）：面对海量数据的计数器要如何做？\"},{\"text\":\"38-计数系统设计（二）：50万QPS下如何设计未读数系统？\",\"link\":\"/books/book0002/07实战/38-计数系统设计（二）：50万QPS下如何设计未读数系统？\"},{\"text\":\"39-信息流设计（一）：通用信息流系统的推模式要如何做？\",\"link\":\"/books/book0002/07实战/39-信息流设计（一）：通用信息流系统的推模式要如何做？\"},{\"text\":\"40-信息流设计（二）：通用信息流系统的拉模式要如何做？\",\"link\":\"/books/book0002/07实战/40-信息流设计（二）：通用信息流系统的拉模式要如何做？\"}]},{\"text\":\"结束\",\"collapsible\":true,\"items\":[{\"text\":\"结束语-学不可以已\",\"link\":\"/books/book0002/08结束/结束语-学不可以已\"}]}],\"/books/book0003\":[{\"text\":\"DDD领域驱动设计\",\"collapsible\":true,\"items\":[{\"text\":\"DDD入门&实践\",\"link\":\"/books/book0003/index\"}]}]}},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}");</script>
    
  </body>
</html>