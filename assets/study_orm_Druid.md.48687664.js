import{_ as s,c as a,o as n,a as l}from"./app.467f35a9.js";const A=JSON.parse('{"title":"Druid","description":"","frontmatter":{},"headers":[{"level":2,"title":"源码分析","slug":"源码分析","link":"#源码分析","children":[]},{"level":2,"title":"运用篇","slug":"运用篇","link":"#运用篇","children":[{"level":3,"title":"springboot整合druid","slug":"springboot整合druid","link":"#springboot整合druid","children":[]}]}],"relativePath":"study/orm/Druid.md"}'),p={name:"study/orm/Druid.md"},o=l(`<h1 id="druid" tabindex="-1">Druid <a class="header-anchor" href="#druid" aria-hidden="true">#</a></h1><blockquote><p>Druid是阿里巴巴开发的号称为监控而生的数据库连接池</p></blockquote><h2 id="源码分析" tabindex="-1">源码分析 <a class="header-anchor" href="#源码分析" aria-hidden="true">#</a></h2><blockquote><ul><li>stat：Druid内置提供一个<code>StatFilter</code>,用于统计监控信息。</li><li>wall：Druid防御SQL注入攻击的<code>WallFilter</code>就是通过Druid的SQL Parser分析。Druid提供的SQL Parser可以在JDBC层拦截SQL做相应处理，比如说分库分表、审计等。</li><li>log4j2：这个就是 日志记录的功能，可以把sql语句打印到log4j2 供排查问题。</li></ul></blockquote><h2 id="运用篇" tabindex="-1">运用篇 <a class="header-anchor" href="#运用篇" aria-hidden="true">#</a></h2><h3 id="springboot整合druid" tabindex="-1">springboot整合druid <a class="header-anchor" href="#springboot整合druid" aria-hidden="true">#</a></h3><h4 id="基本配置" tabindex="-1">基本配置 <a class="header-anchor" href="#基本配置" aria-hidden="true">#</a></h4><blockquote><p><code>pom.xml</code></p><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">&lt;!-- druid数据源 --&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">dependency</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">groupId</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">com.alibaba</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">groupId</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">artifactId</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">druid-spring-boot-starter</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">artifactId</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">version</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">1.1.23</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">version</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">dependency</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">&lt;!-- mysql8 驱动--&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">dependency</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">groupId</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">mysql</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">groupId</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">artifactId</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">mysql-connector-java</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">artifactId</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">scope</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">runtime</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">scope</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">dependency</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div></blockquote><blockquote><ul><li><strong>配置Druid数据源（连接池）</strong> ：如同以前 c3p0、dbcp 数据源可以设置数据源连接初始化大小、最大连接数、等待时间、最小连接数 等一样，Druid 数据源同理可以进行设置；</li><li><strong>配置 Druid web 监控 filter（<code>WebStatFilter</code>）</strong> ：这个过滤器的作用就是统计 web 应用请求中所有的数据库信息，比如 发出的 sql 语句，sql 执行的时间、请求次数、请求的 url 地址、以及seesion 监控、数据库表的访问次数 等等。</li><li><strong>配置 Druid 后台管理 Servlet（<code>StatViewServlet</code>）</strong> ：Druid 数据源具有监控的功能，并提供了一个 web 界面方便用户查看，类似安装 路由器 时，人家也提供了一个默认的 web 页面；需要设置 Druid 的后台管理页面的属性，比如 登录账号、密码 等；</li></ul></blockquote><blockquote><p><code>application.yml</code></p><p><code>com.alibaba.druid.spring.boot.autoconfigure.properties.DruidStatProperties</code> <code>org.springframework.boot.autoconfigure.jdbc.DataSourceProperties</code></p><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">########## 配置数据源 （Druid）##########</span></span>
<span class="line"><span style="color:#F07178;">spring</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">datasource</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;font-style:italic;">########## JDBC 基本配置 ##########</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#F07178;">username</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">xxx</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#F07178;">password</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">xxx</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#F07178;">driver-class-name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">com.mysql.cj.jdbc.Driver</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;"># mysql8 的连接驱动</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#F07178;">url</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">jdbc:mysql://127.0.0.1:3306/test?serverTimezone=Asia/Shanghai</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#F07178;">platform</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mysql</span><span style="color:#A6ACCD;">                               </span><span style="color:#676E95;font-style:italic;"># 数据库类型</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#F07178;">type</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">com.alibaba.druid.pool.DruidDataSource</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 指定数据源类型</span></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;font-style:italic;">########## 连接池 配置 ##########</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#F07178;">druid</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;"># 配置初始化大小、最小、最大</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">initial-size</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">5</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">minIdle</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">max-active</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">20</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;"># 配置获取连接等待超时的时间(单位：毫秒)</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">max-wait</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">60000</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;"># 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">time-between-eviction-runs-millis</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2000</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;"># 配置一个连接在池中最小生存的时间，单位是毫秒</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">min-evictable-idle-time-millis</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">600000</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">max-evictable-idle-time-millis</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">900000</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;"># 用来测试连接是否可用的SQL语句,默认值每种数据库都不相同,这是mysql</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">validationQuery</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">select 1</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;"># 应用向连接池申请连接，并且testOnBorrow为false时，连接池将会判断连接是否处于空闲状态，如果是，则验证这条连接是否可用</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">testWhileIdle</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;"># 如果为true，默认是false，应用向连接池申请连接时，连接池会判断这条连接是否是可用的</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">testOnBorrow</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;"># 如果为true（默认false），当应用使用完连接，连接池回收连接的时候会判断该连接是否还可用</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">testOnReturn</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;"># 是否缓存preparedStatement，也就是PSCache。PSCache对支持游标的数据库性能提升巨大，比如说oracle</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">poolPreparedStatements</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;"># 要启用PSCache，必须配置大于0，当大于0时， poolPreparedStatements自动触发修改为true，</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;"># 在Druid中，不会存在Oracle下PSCache占用内存过多的问题，</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;"># 可以把这个数值配置大一些，比如说100</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">maxOpenPreparedStatements</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">20</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;"># 连接池中的minIdle数量以内的连接，空闲时间超过minEvictableIdleTimeMillis，则会执行keepAlive操作</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">keepAlive</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;"># Spring 监控，利用aop 对指定接口的执行时间，jdbc数进行记录</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">aop-patterns</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.springboot.template.dao.*</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;">########### 启用内置过滤器（第一个 stat必须，否则监控不到SQL）##########</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">filters</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">stat,wall,log4j2</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;"># 自己配置监控统计拦截的filter</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">filter</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">       </span><span style="color:#676E95;font-style:italic;"># 开启druiddatasource的状态监控</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">stat</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#F07178;">enabled</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#F07178;">db-type</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mysql</span></span>
<span class="line"><span style="color:#89DDFF;">         </span><span style="color:#676E95;font-style:italic;"># 开启慢sql监控，超过2s 就认为是慢sql，记录到日志中</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#F07178;">log-slow-sql</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#F07178;">slow-sql-millis</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2000</span></span>
<span class="line"><span style="color:#89DDFF;">       </span><span style="color:#676E95;font-style:italic;"># 日志监控，使用slf4j 进行日志输出</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">slf4j</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#F07178;">enabled</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#F07178;">statement-log-error-enabled</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#F07178;">statement-create-after-log-enabled</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#F07178;">statement-close-after-log-enabled</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#F07178;">result-set-open-after-log-enabled</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#F07178;">result-set-close-after-log-enabled</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;">########## 配置WebStatFilter，用于采集web关联监控的数据 ##########</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">web-stat-filter</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">enabled</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;">                   </span><span style="color:#676E95;font-style:italic;"># 启动 StatFilter</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">url-pattern</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/*</span><span style="color:#A6ACCD;">                 </span><span style="color:#676E95;font-style:italic;"># 过滤所有url</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">exclusions</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 排除一些不必要的url</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">session-stat-enable</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;">       </span><span style="color:#676E95;font-style:italic;"># 开启session统计功能</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">session-stat-max-count</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1000</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># session的最大个数,默认100</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;">########## 配置StatViewServlet（监控页面），用于展示Druid的统计信息 ##########</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">stat-view-servlet</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">enabled</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;">                   </span><span style="color:#676E95;font-style:italic;"># 启用StatViewServlet</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">url-pattern</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/druid/*</span><span style="color:#A6ACCD;">           </span><span style="color:#676E95;font-style:italic;"># 访问内置监控页面的路径，内置监控页面的首页是/druid/index.html</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">reset-enable</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#A6ACCD;">              </span><span style="color:#676E95;font-style:italic;"># 不允许清空统计数据,重新计算</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">login-username</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span><span style="color:#A6ACCD;">            </span><span style="color:#676E95;font-style:italic;"># 配置监控页面访问密码</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">login-password</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">123</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">allow</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">127.0.0.1</span><span style="color:#A6ACCD;">           </span><span style="color:#676E95;font-style:italic;"># 允许访问的地址，如果allow没有配置或者为空，则允许所有访问</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">deny</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">                                        </span><span style="color:#676E95;font-style:italic;"># 拒绝访问的地址，deny优先于allow，如果在deny列表中，就算在allow列表中，也会被拒绝</span></span>
<span class="line"></span></code></pre></div></blockquote><h4 id="配置-filter" tabindex="-1">配置 Filter <a class="header-anchor" href="#配置-filter" aria-hidden="true">#</a></h4><blockquote><p><code>spring.datasource.druid.filters=stat,wall,log4j ...</code></p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;"># 配置StatFilter </span></span>
<span class="line"><span style="color:#A6ACCD;">spring.datasource.druid.filter.stat.enabled=true</span></span>
<span class="line"><span style="color:#A6ACCD;">spring.datasource.druid.filter.stat.db-type=h2</span></span>
<span class="line"><span style="color:#A6ACCD;">spring.datasource.druid.filter.stat.log-slow-sql=true</span></span>
<span class="line"><span style="color:#A6ACCD;">spring.datasource.druid.filter.stat.slow-sql-millis=2000</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"># 配置WallFilter </span></span>
<span class="line"><span style="color:#A6ACCD;">spring.datasource.druid.filter.wall.enabled=true</span></span>
<span class="line"><span style="color:#A6ACCD;">spring.datasource.druid.filter.wall.db-type=h2</span></span>
<span class="line"><span style="color:#A6ACCD;">spring.datasource.druid.filter.wall.config.delete-allow=false</span></span>
<span class="line"><span style="color:#A6ACCD;">spring.datasource.druid.filter.wall.config.drop-table-allow=false</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>目前为以下 Filter 提供了配置支持，根据（spring.datasource.druid.filter.*）进行配置。</p><ul><li>StatFilter</li><li>WallFilter</li><li>ConfigFilter</li><li>EncodingConvertFilter</li><li>Slf4jLogFilter</li><li>Log4jFilter</li><li>Log4j2Filter</li><li>CommonsLogFilter</li></ul><p>不想使用内置的 Filters，要想使自定义 Filter 配置生效需要将对应 Filter 的 enabled 设置为 true ，Druid Spring Boot Starter 默认禁用 StatFilter，可以将其 enabled 设置为 true 来启用它。</p></blockquote><h4 id="监控页面" tabindex="-1">监控页面 <a class="header-anchor" href="#监控页面" aria-hidden="true">#</a></h4><blockquote><p>/druid/login.html</p></blockquote><h4 id="sql监控" tabindex="-1">sql监控 <a class="header-anchor" href="#sql监控" aria-hidden="true">#</a></h4><blockquote><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F07178;">spring</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">datasource</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#F07178;">druid</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;font-style:italic;">########## 配置WebStatFilter，用于采集web关联监控的数据 ##########</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">web-stat-filter</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">enabled</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;">                   </span><span style="color:#676E95;font-style:italic;"># 启动 StatFilter</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">url-pattern</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/*</span><span style="color:#A6ACCD;">                 </span><span style="color:#676E95;font-style:italic;"># 过滤所有url</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">exclusions</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 排除一些不必要的url</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">session-stat-enable</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;">       </span><span style="color:#676E95;font-style:italic;"># 开启session统计功能</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">session-stat-max-count</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1000</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># session的最大个数,默认100</span></span>
<span class="line"></span></code></pre></div></blockquote><h4 id="spring监控" tabindex="-1">spring监控 <a class="header-anchor" href="#spring监控" aria-hidden="true">#</a></h4><blockquote><p>访问之后spring监控默认是没有数据的；这需要导入SprngBoot的AOP的Starter</p><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">dependency</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">groupId</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">org.springframework.boot</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">groupId</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">artifactId</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">spring-boot-starter-aop</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">artifactId</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">dependency</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p>application.yml 配置:</p><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">#Spring监控AOP切入点，如com.springboot.template.dao.*,配置多个英文逗号分隔</span></span>
<span class="line"><span style="color:#C3E88D;">spring.datasource.druid.aop-patterns=&quot;com.springboot.template.dao.*&quot;</span></span>
<span class="line"></span></code></pre></div></blockquote><h4 id="获取-druid-的监控数据" tabindex="-1">获取 Druid 的监控数据 <a class="header-anchor" href="#获取-druid-的监控数据" aria-hidden="true">#</a></h4><blockquote><p>Druid 的监控数据可以在 <strong>开启 StatFilter 后</strong> ，通过 <code>DruidStatManagerFacade</code> 进行获取;</p><p><code>DruidStatManagerFacade#getDataSourceStatDataList</code> 该方法可以获取所有数据源的监控数据，</p><p>除此之外 <code>DruidStatManagerFacade</code> 还提供了一些其他方法，可以按需选择使用。</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">RestController</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">RequestMapping</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">value</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/druid</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">DruidStatController</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">GetMapping</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/stat</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Object</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">druidStat</span><span style="color:#89DDFF;">(){</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;font-style:italic;">// 获取数据源的监控数据</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> DruidStatManagerFacade</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getInstance</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getDataSourceStatDataList</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div></blockquote>`,20),e=[o];function t(c,r,y,i,D,F){return n(),a("div",null,e)}const d=s(p,[["render",t]]);export{A as __pageData,d as default};
