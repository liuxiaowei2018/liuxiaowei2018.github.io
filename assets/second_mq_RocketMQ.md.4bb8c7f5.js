import{_ as s,c as n,o as a,a as l}from"./app.1af635ee.js";const p="/assets/image-20220705160256465.7740f1d0.png",o="/assets/image-20220705160345853.20867f92.png",e="/assets/image-20220706110703218.46377165.png",t="/assets/image-20220706111637175.c644aa5d.png",d=JSON.parse('{"title":"RocketMQ","description":"","frontmatter":{},"headers":[{"level":2,"title":"\u539F\u7406\u7BC7","slug":"\u539F\u7406\u7BC7","link":"#\u539F\u7406\u7BC7","children":[]},{"level":2,"title":"\u8FD0\u7EF4\u7BC7","slug":"\u8FD0\u7EF4\u7BC7","link":"#\u8FD0\u7EF4\u7BC7","children":[]},{"level":2,"title":"\u5E94\u7528\u7BC7","slug":"\u5E94\u7528\u7BC7","link":"#\u5E94\u7528\u7BC7","children":[]},{"level":2,"title":"\u6269\u5C55\u7BC7","slug":"\u6269\u5C55\u7BC7","link":"#\u6269\u5C55\u7BC7","children":[]}],"relativePath":"second/mq/RocketMQ.md"}'),c={name:"second/mq/RocketMQ.md"},r=l('<h1 id="rocketmq" tabindex="-1">RocketMQ <a class="header-anchor" href="#rocketmq" aria-hidden="true">#</a></h1><h2 id="\u539F\u7406\u7BC7" tabindex="-1">\u539F\u7406\u7BC7 <a class="header-anchor" href="#\u539F\u7406\u7BC7" aria-hidden="true">#</a></h2><h4 id="message-\u53D1\u9001\u4E0E\u63A5\u6536" tabindex="-1">Message \u53D1\u9001\u4E0E\u63A5\u6536 <a class="header-anchor" href="#message-\u53D1\u9001\u4E0E\u63A5\u6536" aria-hidden="true">#</a></h4><h5 id="producer-\u53D1\u9001\u6D88\u606F" tabindex="-1">Producer \u53D1\u9001\u6D88\u606F ---&gt; <a class="header-anchor" href="#producer-\u53D1\u9001\u6D88\u606F" aria-hidden="true">#</a></h5><p><img src="'+p+'" alt="image-20220705160256465"></p><p><img src="'+o+`" alt="image-20220705160345853"></p><p>DefaultMQProducer#send(Message)</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">SendResult</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">send</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Message</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws MQClientException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> RemotingException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> MQBrokerException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">defaultMQProducerImpl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">send</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><strong>\u8BF4\u660E\uFF1A\u53D1\u9001\u540C\u6B65\u6D88\u606F\uFF0C<code>DefaultMQProducer#send(Message)</code> \u5BF9<code>DefaultMQProducerImpl#send(Message)</code> \u8FDB\u884C\u5C01\u88C5\u3002</strong></p><p>DefaultMQProducerImpl#sendDefaultImpl()</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">SendResult</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">send</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Message</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws MQClientException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> RemotingException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> MQBrokerException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">send</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">defaultMQProducer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getSendMsgTimeout</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">SendResult</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">send</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Message</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> timeout</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws MQClientException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> RemotingException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> MQBrokerException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">sendDefaultImpl</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> CommunicationMode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SYNC</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null,</span><span style="color:#A6ACCD;"> timeout</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">SendResult</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">sendDefaultImpl</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Message</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CommunicationMode</span><span style="color:#A6ACCD;"> communicationMode</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">SendCallback</span><span style="color:#A6ACCD;"> sendCallback</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> timeout</span></span>
<span class="line"><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws MQClientException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> RemotingException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> MQBrokerException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u6821\u9A8C Producer \u5904\u4E8E\u8FD0\u884C\u72B6\u6001</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">makeSureStateOK</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u6821\u9A8C\u6D88\u606F\u683C\u5F0F</span></span>
<span class="line"><span style="color:#A6ACCD;">    Validators</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">checkMessage</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">defaultMQProducer</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> invokeID </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> random</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">nextLong</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u8C03\u7528\u7F16\u53F7\uFF1B\u7528\u4E8E\u4E0B\u9762\u6253\u5370\u65E5\u5FD7\uFF0C\u6807\u8BB0\u4E3A\u540C\u4E00\u6B21\u53D1\u9001\u6D88\u606F</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> beginTimestampFirst </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> beginTimestampPrev </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> beginTimestampFirst</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> endTimestamp </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> beginTimestampFirst</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u83B7\u53D6 Topic\u8DEF\u7531\u4FE1\u606F</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">TopicPublishInfo</span><span style="color:#A6ACCD;"> topicPublishInfo </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">tryToFindTopicPublishInfo</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getTopic</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">topicPublishInfo </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> topicPublishInfo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ok</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">MessageQueue</span><span style="color:#A6ACCD;"> mq </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u6700\u540E\u9009\u62E9\u6D88\u606F\u8981\u53D1\u9001\u5230\u7684\u961F\u5217</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Exception</span><span style="color:#A6ACCD;"> exception </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">SendResult</span><span style="color:#A6ACCD;"> sendResult </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u6700\u540E\u4E00\u6B21\u53D1\u9001\u7ED3\u679C</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> timesTotal </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> communicationMode </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> CommunicationMode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SYNC </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">defaultMQProducer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getRetryTimesWhenSendFailed</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u540C\u6B65\u591A\u6B21\u8C03\u7528</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> times </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u7B2C\u51E0\u6B21\u53D1\u9001</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> brokersSent </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">timesTotal</span><span style="color:#89DDFF;">];</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u5B58\u50A8\u6BCF\u6B21\u53D1\u9001\u6D88\u606F\u9009\u62E9\u7684broker\u540D</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u5FAA\u73AF\u8C03\u7528\u53D1\u9001\u6D88\u606F\uFF0C\u76F4\u5230\u6210\u529F</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(;</span><span style="color:#A6ACCD;"> times </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> timesTotal</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> times</span><span style="color:#89DDFF;">++)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> lastBrokerName </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> mq </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> mq</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getBrokerName</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">MessageQueue</span><span style="color:#A6ACCD;"> tmpmq </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">selectOneMessageQueue</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">topicPublishInfo</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> lastBrokerName</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u9009\u62E9\u6D88\u606F\u8981\u53D1\u9001\u5230\u7684\u961F\u5217</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tmpmq </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                mq </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> tmpmq</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                brokersSent</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">times</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> mq</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getBrokerName</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    beginTimestampPrev </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">                    </span><span style="color:#676E95;">// \u8C03\u7528\u53D1\u9001\u6D88\u606F\u6838\u5FC3\u65B9\u6CD5</span></span>
<span class="line"><span style="color:#A6ACCD;">                    sendResult </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">sendKernelImpl</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> mq</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> communicationMode</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> sendCallback</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> topicPublishInfo</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> timeout</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    endTimestamp </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">                    </span><span style="color:#676E95;">// \u66F4\u65B0Broker\u53EF\u7528\u6027\u4FE1\u606F</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">updateFaultItem</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mq</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getBrokerName</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> endTimestamp </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> beginTimestampPrev</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">switch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">communicationMode</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">case</span><span style="color:#A6ACCD;"> ASYNC</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">case</span><span style="color:#A6ACCD;"> ONEWAY</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">case</span><span style="color:#A6ACCD;"> SYNC</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">sendResult</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getSendStatus</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> SendStatus</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SEND_OK</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(this.</span><span style="color:#A6ACCD;">defaultMQProducer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isRetryAnotherBrokerWhenNotStoreOK</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u540C\u6B65\u53D1\u9001\u6210\u529F\u4F46\u5B58\u50A8\u6709\u95EE\u9898\u65F6 &amp;&amp; \u914D\u7F6E\u5B58\u50A8\u5F02\u5E38\u65F6\u91CD\u65B0\u53D1\u9001\u5F00\u5173 \u65F6\uFF0C\u8FDB\u884C\u91CD\u8BD5</span></span>
<span class="line"><span style="color:#A6ACCD;">                                    </span><span style="color:#89DDFF;">continue</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> sendResult</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">default:</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#89DDFF;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">RemotingException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u6253\u5370\u5F02\u5E38\uFF0C\u66F4\u65B0Broker\u53EF\u7528\u6027\u4FE1\u606F\uFF0C\u66F4\u65B0\u7EE7\u7EED\u5FAA\u73AF</span></span>
<span class="line"><span style="color:#A6ACCD;">                    endTimestamp </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">updateFaultItem</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mq</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getBrokerName</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> endTimestamp </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> beginTimestampPrev</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    log</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">warn</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">String</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">format</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> invokeID</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> endTimestamp </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> beginTimestampPrev</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> mq</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    log</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">warn</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">                    exception </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">continue</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">MQClientException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u6253\u5370\u5F02\u5E38\uFF0C\u66F4\u65B0Broker\u53EF\u7528\u6027\u4FE1\u606F\uFF0C\u7EE7\u7EED\u5FAA\u73AF</span></span>
<span class="line"><span style="color:#A6ACCD;">                    endTimestamp </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">updateFaultItem</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mq</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getBrokerName</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> endTimestamp </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> beginTimestampPrev</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    log</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">warn</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">String</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">format</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> invokeID</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> endTimestamp </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> beginTimestampPrev</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> mq</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    log</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">warn</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">                    exception </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">continue</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">MQBrokerException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u6253\u5370\u5F02\u5E38\uFF0C\u66F4\u65B0Broker\u53EF\u7528\u6027\u4FE1\u606F\uFF0C\u90E8\u5206\u60C5\u51B5\u4E0B\u7684\u5F02\u5E38\uFF0C\u76F4\u63A5\u8FD4\u56DE\uFF0C\u7ED3\u675F\u5FAA\u73AF</span></span>
<span class="line"><span style="color:#A6ACCD;">                    endTimestamp </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">updateFaultItem</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mq</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getBrokerName</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> endTimestamp </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> beginTimestampPrev</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    log</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">warn</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">String</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">format</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> invokeID</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> endTimestamp </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> beginTimestampPrev</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> mq</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    log</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">warn</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">                    exception </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">switch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getResponseCode</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">                            </span><span style="color:#676E95;">// \u5982\u4E0B\u5F02\u5E38continue\uFF0C\u8FDB\u884C\u53D1\u9001\u6D88\u606F\u91CD\u8BD5</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">case</span><span style="color:#A6ACCD;"> ResponseCode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">TOPIC_NOT_EXIST</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">case</span><span style="color:#A6ACCD;"> ResponseCode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SERVICE_NOT_AVAILABLE</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">case</span><span style="color:#A6ACCD;"> ResponseCode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SYSTEM_ERROR</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">case</span><span style="color:#A6ACCD;"> ResponseCode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">NO_PERMISSION</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">case</span><span style="color:#A6ACCD;"> ResponseCode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">NO_BUYER_ID</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">case</span><span style="color:#A6ACCD;"> ResponseCode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">NOT_IN_CURRENT_UNIT</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#89DDFF;">continue</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">                            </span><span style="color:#676E95;">// \u5982\u679C\u6709\u53D1\u9001\u7ED3\u679C\uFF0C\u8FDB\u884C\u8FD4\u56DE\uFF0C\u5426\u5219\uFF0C\u629B\u51FA\u5F02\u5E38\uFF1B</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">default:</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">sendResult </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> sendResult</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    endTimestamp </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">updateFaultItem</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mq</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getBrokerName</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> endTimestamp </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> beginTimestampPrev</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    log</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">warn</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">String</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">format</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">sendKernelImpl exception, throw exception, InvokeID: %s, RT: %sms, Broker: %s</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> invokeID</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> endTimestamp </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> beginTimestampPrev</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> mq</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    log</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">warn</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u8FD4\u56DE\u53D1\u9001\u7ED3\u679C</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">sendResult </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> sendResult</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u6839\u636E\u4E0D\u540C\u60C5\u51B5\uFF0C\u629B\u51FA\u4E0D\u540C\u7684\u5F02\u5E38</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> info </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> String</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">format</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Send [%d] times, still failed, cost [%d]ms, Topic: %s, BrokersSent: %s</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> times</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> 			System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> beginTimestampFirst</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                                    msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getTopic</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> Arrays</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">brokersSent</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> FAQUrl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">suggestTodo</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">FAQUrl</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SEND_MSG_FAILED</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">MQClientException</span><span style="color:#A6ACCD;"> mqClientException </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MQClientException</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">info</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> exception</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">exception </span><span style="color:#89DDFF;">instanceof</span><span style="color:#A6ACCD;"> MQBrokerException</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            mqClientException</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setResponseCode</span><span style="color:#89DDFF;">(((</span><span style="color:#A6ACCD;">MQBrokerException</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> exception</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">getResponseCode</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">exception </span><span style="color:#89DDFF;">instanceof</span><span style="color:#A6ACCD;"> RemotingConnectException</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            mqClientException</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setResponseCode</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ClientErrorCode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">CONNECT_BROKER_EXCEPTION</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">exception </span><span style="color:#89DDFF;">instanceof</span><span style="color:#A6ACCD;"> RemotingTimeoutException</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            mqClientException</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setResponseCode</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ClientErrorCode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">ACCESS_BROKER_TIMEOUT</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">exception </span><span style="color:#89DDFF;">instanceof</span><span style="color:#A6ACCD;"> MQClientException</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            mqClientException</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setResponseCode</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ClientErrorCode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">BROKER_NOT_EXIST_EXCEPTION</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> mqClientException</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// Namesrv\u627E\u4E0D\u5230\u5F02\u5E38</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> nsList </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">getmQClientFactory</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getMQClientAPIImpl</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getNameServerAddressList</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> nsList </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> nsList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isEmpty</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MQClientException</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">No name server address, please set it.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> FAQUrl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">suggestTodo</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">FAQUrl</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">NAME_SERVER_ADDR_NOT_EXIST_URL</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null).</span><span style="color:#82AAFF;">setResponseCode</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ClientErrorCode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">NO_NAME_SERVER_EXCEPTION</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u6D88\u606F\u8DEF\u7531\u627E\u4E0D\u5230\u5F02\u5E38</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MQClientException</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">No route info of this topic, </span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getTopic</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> FAQUrl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">suggestTodo</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">FAQUrl</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">NO_TOPIC_ROUTE_INFO</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">                                </span><span style="color:#89DDFF;">null).</span><span style="color:#82AAFF;">setResponseCode</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ClientErrorCode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">NOT_FOUND_TOPIC_EXCEPTION</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>DefaultMQProducerImpl#tryToFindTopicPublishInfo()</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TopicPublishInfo</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryToFindTopicPublishInfo</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> topic</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// \u7F13\u5B58\u4E2D\u83B7\u53D6 Topic\u53D1\u5E03\u4FE1\u606F</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TopicPublishInfo</span><span style="color:#A6ACCD;"> topicPublishInfo </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">topicPublishInfoTable</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">topic</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// \u5F53\u65E0\u53EF\u7528\u7684 Topic\u53D1\u5E03\u4FE1\u606F\u65F6\uFF0C\u4ECENamesrv\u83B7\u53D6\u4E00\u6B21</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> topicPublishInfo </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">topicPublishInfo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ok</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">topicPublishInfoTable</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">putIfAbsent</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">topic</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">TopicPublishInfo</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">mQClientFactory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">updateTopicRouteInfoFromNameServer</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">topic</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">	 topicPublishInfo </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">topicPublishInfoTable</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">topic</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// \u82E5\u83B7\u53D6\u7684 Topic\u53D1\u5E03\u4FE1\u606F\u65F6\u5019\u53EF\u7528\uFF0C\u5219\u8FD4\u56DE</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">topicPublishInfo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isHaveTopicRouterInfo</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> topicPublishInfo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ok</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> topicPublishInfo</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u4F7F\u7528 {@link DefaultMQProducer#createTopicKey} \u5BF9\u5E94\u7684 Topic\u53D1\u5E03\u4FE1\u606F\u3002\u7528\u4E8E Topic\u53D1\u5E03\u4FE1\u606F\u4E0D\u5B58\u5728 &amp;&amp; Broker\u652F\u6301\u81EA\u52A8\u521B\u5EFATopic</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">mQClientFactory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">updateTopicRouteInfoFromNameServer</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">topic</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">defaultMQProducer</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">	 topicPublishInfo </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">topicPublishInfoTable</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">topic</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> topicPublishInfo</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>MQFaultStrategy</p><p><img src="`+e+`" alt="image-20220706110703218"></p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MQFaultStrategy</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Logger</span><span style="color:#A6ACCD;"> log </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ClientLogger</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getLog</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">    /**</span></span>
<span class="line"><span style="color:#676E95;">      * \u5EF6\u8FDF\u6545\u969C\u5BB9\u9519\uFF0C\u7EF4\u62A4\u6BCF\u4E2ABroker\u7684\u53D1\u9001\u6D88\u606F\u7684\u5EF6\u8FDF</span></span>
<span class="line"><span style="color:#676E95;">      * key\uFF1AbrokerName</span></span>
<span class="line"><span style="color:#676E95;">      */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">LatencyFaultTolerance</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> latencyFaultTolerance </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">LatencyFaultToleranceImpl</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#676E95;">    /**</span></span>
<span class="line"><span style="color:#676E95;">      * \u53D1\u9001\u6D88\u606F\u5EF6\u8FDF\u5BB9\u9519\u5F00\u5173</span></span>
<span class="line"><span style="color:#676E95;">      */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> sendLatencyFaultEnable </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#676E95;">    /**</span></span>
<span class="line"><span style="color:#676E95;">      * \u5EF6\u8FDF\u7EA7\u522B\u6570\u7EC4</span></span>
<span class="line"><span style="color:#676E95;">      */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> latencyMax </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F78C6C;">50L</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100L</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">550L</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1000L</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2000L</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3000L</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">15000L</span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#676E95;">    /**</span></span>
<span class="line"><span style="color:#676E95;">      * \u4E0D\u53EF\u7528\u65F6\u957F\u6570\u7EC4</span></span>
<span class="line"><span style="color:#676E95;">      */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> notAvailableDuration </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F78C6C;">0L</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0L</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">30000L</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">60000L</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">120000L</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">180000L</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">600000L</span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">    /**</span></span>
<span class="line"><span style="color:#676E95;">      * \u6839\u636E Topic\u53D1\u5E03\u4FE1\u606F \u9009\u62E9\u4E00\u4E2A\u6D88\u606F\u961F\u5217</span></span>
<span class="line"><span style="color:#676E95;">      *</span></span>
<span class="line"><span style="color:#676E95;">      * </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">tpInfo</span><span style="color:#676E95;"> Topic\u53D1\u5E03\u4FE1\u606F</span></span>
<span class="line"><span style="color:#676E95;">      * </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">lastBrokerName</span><span style="color:#676E95;"> brokerName</span></span>
<span class="line"><span style="color:#676E95;">      * </span><span style="color:#F78C6C;">@return</span><span style="color:#676E95;"> \u6D88\u606F\u961F\u5217</span></span>
<span class="line"><span style="color:#676E95;">      */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">MessageQueue</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">selectOneMessageQueue</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TopicPublishInfo</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">tpInfo</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">lastBrokerName</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(this.</span><span style="color:#A6ACCD;">sendLatencyFaultEnable</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">                </span><span style="color:#676E95;">// \u83B7\u53D6 brokerName=lastBrokerName &amp;&amp; \u53EF\u7528\u7684\u4E00\u4E2A\u6D88\u606F\u961F\u5217</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> index </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> tpInfo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getSendWhichQueue</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getAndIncrement</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> tpInfo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getMessageQueueList</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">size</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> pos </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Math</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">abs</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">index</span><span style="color:#89DDFF;">++)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;"> tpInfo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getMessageQueueList</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">size</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">pos </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                        pos </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#C792EA;">MessageQueue</span><span style="color:#A6ACCD;"> mq </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> tpInfo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getMessageQueueList</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">pos</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">latencyFaultTolerance</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isAvailable</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mq</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getBrokerName</span><span style="color:#89DDFF;">()))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> lastBrokerName </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> mq</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getBrokerName</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">equals</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">lastBrokerName</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> mq</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">                </span><span style="color:#676E95;">// \u9009\u62E9\u4E00\u4E2A\u76F8\u5BF9\u597D\u7684broker\uFF0C\u5E76\u83B7\u5F97\u5176\u5BF9\u5E94\u7684\u4E00\u4E2A\u6D88\u606F\u961F\u5217\uFF0C\u4E0D\u8003\u8651\u8BE5\u961F\u5217\u7684\u53EF\u7528\u6027</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> notBestBroker </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> latencyFaultTolerance</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">pickOneAtLeast</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> writeQueueNums </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> tpInfo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getQueueIdByBroker</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">notBestBroker</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">writeQueueNums </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">MessageQueue</span><span style="color:#A6ACCD;"> mq </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> tpInfo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">selectOneMessageQueue</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">notBestBroker </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                        mq</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setBrokerName</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">notBestBroker</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                        mq</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setQueueId</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tpInfo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getSendWhichQueue</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getAndIncrement</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;"> writeQueueNums</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> mq</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    latencyFaultTolerance</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">remove</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">notBestBroker</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Exception</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                log</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">error</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Error occurred when selecting message queue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u9009\u62E9\u4E00\u4E2A\u6D88\u606F\u961F\u5217\uFF0C\u4E0D\u8003\u8651\u961F\u5217\u7684\u53EF\u7528\u6027</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> tpInfo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">selectOneMessageQueue</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u83B7\u5F97 lastBrokerName \u5BF9\u5E94\u7684\u4E00\u4E2A\u6D88\u606F\u961F\u5217\uFF0C\u4E0D\u8003\u8651\u8BE5\u961F\u5217\u7684\u53EF\u7528\u6027</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> tpInfo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">selectOneMessageQueue</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">lastBrokerName</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">    /**</span></span>
<span class="line"><span style="color:#676E95;">      * \u66F4\u65B0\u5EF6\u8FDF\u5BB9\u9519\u4FE1\u606F</span></span>
<span class="line"><span style="color:#676E95;">      *</span></span>
<span class="line"><span style="color:#676E95;">      * </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">brokerName</span><span style="color:#676E95;"> brokerName</span></span>
<span class="line"><span style="color:#676E95;">      * </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">currentLatency</span><span style="color:#676E95;"> \u5EF6\u8FDF</span></span>
<span class="line"><span style="color:#676E95;">      * </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">isolation</span><span style="color:#676E95;"> \u662F\u5426\u9694\u79BB\u3002\u5F53\u5F00\u542F\u9694\u79BB\u65F6\uFF0C\u9ED8\u8BA4\u5EF6\u8FDF\u4E3A30000\u3002\u76EE\u524D\u4E3B\u8981\u7528\u4E8E\u53D1\u9001\u6D88\u606F\u5F02\u5E38\u65F6</span></span>
<span class="line"><span style="color:#676E95;">      */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">updateFaultItem</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">brokerName</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">currentLatency</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">isolation</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(this.</span><span style="color:#A6ACCD;">sendLatencyFaultEnable</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> duration </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">computeNotAvailableDuration</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">isolation </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">30000</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> currentLatency</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">latencyFaultTolerance</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">updateFaultItem</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">brokerName</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> currentLatency</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> duration</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">    /**</span></span>
<span class="line"><span style="color:#676E95;">      * \u8BA1\u7B97\u5EF6\u8FDF\u5BF9\u5E94\u7684\u4E0D\u53EF\u7528\u65F6\u95F4</span></span>
<span class="line"><span style="color:#676E95;">      *</span></span>
<span class="line"><span style="color:#676E95;">      * </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">currentLatency</span><span style="color:#676E95;"> \u5EF6\u8FDF</span></span>
<span class="line"><span style="color:#676E95;">      * </span><span style="color:#F78C6C;">@return</span><span style="color:#676E95;"> \u4E0D\u53EF\u7528\u65F6\u95F4</span></span>
<span class="line"><span style="color:#676E95;">      */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">computeNotAvailableDuration</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">currentLatency</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> latencyMax</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">--)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">currentLatency </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> latencyMax</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">])</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">notAvailableDuration</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><ul><li><p>\u66F4\u65B0\u5EF6\u8FDF\u5BB9\u9519\u4FE1\u606F\u3002\u5F53 <code>Producer</code> \u53D1\u9001\u6D88\u606F\u65F6\u95F4\u8FC7\u957F\uFF0C\u5219\u903B\u8F91\u8BA4\u4E3AN\u79D2\u5185\u4E0D\u53EF\u7528\u3002\u6309\u7167<code>latencyMax</code>\uFF0C<code>notAvailableDuration</code>\u7684\u914D\u7F6E\uFF0C\u5BF9\u5E94\u5982\u4E0B\uFF1A</p><table><thead><tr><th style="text-align:left;">Producer\u53D1\u9001\u6D88\u606F\u6D88\u8017\u65F6\u957F</th><th style="text-align:left;">Broker\u4E0D\u53EF\u7528\u65F6\u957F</th></tr></thead><tbody><tr><td style="text-align:left;">&gt;= 15000 ms</td><td style="text-align:left;">600 * 1000 ms</td></tr><tr><td style="text-align:left;">&gt;= 3000 ms</td><td style="text-align:left;">180 * 1000 ms</td></tr><tr><td style="text-align:left;">&gt;= 2000 ms</td><td style="text-align:left;">120 * 1000 ms</td></tr><tr><td style="text-align:left;">&gt;= 1000 ms</td><td style="text-align:left;">60 * 1000 ms</td></tr><tr><td style="text-align:left;">&gt;= 550 ms</td><td style="text-align:left;">30 * 1000 ms</td></tr><tr><td style="text-align:left;">&gt;= 100 ms</td><td style="text-align:left;">0 ms</td></tr><tr><td style="text-align:left;">&gt;= 50 ms</td><td style="text-align:left;">0 ms</td></tr></tbody></table></li></ul><p>LatencyFaultTolerance</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">interface</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">LatencyFaultTolerance</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">    /**</span></span>
<span class="line"><span style="color:#676E95;">     * \u66F4\u65B0\u5BF9\u5E94\u7684\u5EF6\u8FDF\u548C\u4E0D\u53EF\u7528\u65F6\u957F</span></span>
<span class="line"><span style="color:#676E95;">     *</span></span>
<span class="line"><span style="color:#676E95;">     * </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">name</span><span style="color:#676E95;"> \u5BF9\u8C61</span></span>
<span class="line"><span style="color:#676E95;">     * </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">currentLatency</span><span style="color:#676E95;"> \u5EF6\u8FDF</span></span>
<span class="line"><span style="color:#676E95;">     * </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">notAvailableDuration</span><span style="color:#676E95;"> \u4E0D\u53EF\u7528\u65F6\u957F</span></span>
<span class="line"><span style="color:#676E95;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">updateFaultItem</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">T</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">currentLatency</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">notAvailableDuration</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">    /**</span></span>
<span class="line"><span style="color:#676E95;">     * \u5BF9\u8C61\u662F\u5426\u53EF\u7528</span></span>
<span class="line"><span style="color:#676E95;">     *</span></span>
<span class="line"><span style="color:#676E95;">     * </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">name</span><span style="color:#676E95;"> \u5BF9\u8C61</span></span>
<span class="line"><span style="color:#676E95;">     * </span><span style="color:#F78C6C;">@return</span><span style="color:#676E95;"> \u662F\u5426\u53EF\u7528</span></span>
<span class="line"><span style="color:#676E95;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isAvailable</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">T</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">    /**</span></span>
<span class="line"><span style="color:#676E95;">     * \u79FB\u9664\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#676E95;">     *</span></span>
<span class="line"><span style="color:#676E95;">     * </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">name</span><span style="color:#676E95;"> \u5BF9\u8C61</span></span>
<span class="line"><span style="color:#676E95;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">remove</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">T</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">    /**</span></span>
<span class="line"><span style="color:#676E95;">     * \u83B7\u53D6\u4E00\u4E2A\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#676E95;">     *</span></span>
<span class="line"><span style="color:#676E95;">     * </span><span style="color:#F78C6C;">@return</span><span style="color:#676E95;"> \u5BF9\u8C61</span></span>
<span class="line"><span style="color:#676E95;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">T</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">pickOneAtLeast</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><ul><li>\u8BF4\u660E \uFF1A\u5EF6\u8FDF\u6545\u969C\u5BB9\u9519\u63A5\u53E3</li></ul><p>LatencyFaultToleranceImpl</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">LatencyFaultToleranceImpl</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">implements</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">LatencyFaultTolerance</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"> /**</span></span>
<span class="line"><span style="color:#676E95;">  * \u5BF9\u8C61\u6545\u969C\u4FE1\u606FTable</span></span>
<span class="line"><span style="color:#676E95;">  */</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ConcurrentHashMap</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">FaultItem</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> faultItemTable </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ConcurrentHashMap</span><span style="color:#89DDFF;">&lt;&gt;(</span><span style="color:#F78C6C;">16</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#676E95;"> /**</span></span>
<span class="line"><span style="color:#676E95;">  * \u5BF9\u8C61\u9009\u62E9Index</span></span>
<span class="line"><span style="color:#676E95;">  * </span><span style="color:#F78C6C;">@see</span><span style="color:#676E95;"> #pickOneAtLeast()</span></span>
<span class="line"><span style="color:#676E95;">  */</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ThreadLocalIndex</span><span style="color:#A6ACCD;"> whichItemWorst </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ThreadLocalIndex</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">updateFaultItem</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">currentLatency</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">notAvailableDuration</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#C792EA;">FaultItem</span><span style="color:#A6ACCD;"> old </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">faultItemTable</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> old</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">		 </span><span style="color:#676E95;">// \u521B\u5EFA\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#A6ACCD;">		 </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">FaultItem</span><span style="color:#A6ACCD;"> faultItem </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">FaultItem</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">		 faultItem</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setCurrentLatency</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">currentLatency</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">		 faultItem</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setStartTimestamp</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> notAvailableDuration</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">		 </span><span style="color:#676E95;">// \u66F4\u65B0\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#A6ACCD;">		 old </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">faultItemTable</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">putIfAbsent</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> faultItem</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">		 </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">old </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">			 old</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setCurrentLatency</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">currentLatency</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">			 old</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setStartTimestamp</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> notAvailableDuration</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">		 </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u66F4\u65B0\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#A6ACCD;">		 old</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setCurrentLatency</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">currentLatency</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">		 old</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setStartTimestamp</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> notAvailableDuration</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isAvailable</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">FaultItem</span><span style="color:#A6ACCD;"> faultItem </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">faultItemTable</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">faultItem </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		 </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> faultItem</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isAvailable</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">remove</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">faultItemTable</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">remove</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"> /**</span></span>
<span class="line"><span style="color:#676E95;">  * \u9009\u62E9\u4E00\u4E2A\u76F8\u5BF9\u4F18\u79C0\u7684\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#676E95;">  *</span></span>
<span class="line"><span style="color:#676E95;">  * </span><span style="color:#F78C6C;">@return</span><span style="color:#676E95;"> \u5BF9\u8C61</span></span>
<span class="line"><span style="color:#676E95;">  */</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">pickOneAtLeast</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">	 </span><span style="color:#676E95;">// \u521B\u5EFA\u6570\u7EC4</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Enumeration</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">FaultItem</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> elements </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">faultItemTable</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">elements</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#C792EA;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">FaultItem</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> tmpList </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">LinkedList</span><span style="color:#89DDFF;">&lt;&gt;();</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#89DDFF;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">elements</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">hasMoreElements</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		 </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">FaultItem</span><span style="color:#A6ACCD;"> faultItem </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> elements</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">nextElement</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">		 tmpList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">faultItem</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">	 </span><span style="color:#676E95;">//</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#A6ACCD;">tmpList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isEmpty</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">		 </span><span style="color:#676E95;">// \u6253\u4E71 + \u6392\u5E8F\u3002TODO \u7591\u95EE\uFF1A\u5E94\u8BE5\u53EA\u80FD\u4E8C\u9009\u4E00\u3002\u731C\u6D4BCollections.shuffle(tmpList)\u53BB\u6389\u3002</span></span>
<span class="line"><span style="color:#A6ACCD;">		 Collections</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">shuffle</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tmpList</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">		 Collections</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sort</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tmpList</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">		 </span><span style="color:#676E95;">// \u9009\u62E9\u987A\u5E8F\u5728\u524D\u4E00\u534A\u7684\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#A6ACCD;">		 </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> half </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> tmpList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">size</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">		 </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">half </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">			 </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> tmpList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">getName</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">		 </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">			 </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">whichItemWorst</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getAndIncrement</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;"> half</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">			 </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> tmpList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">getName</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">		 </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	 </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><ul><li>\u8BF4\u660E \uFF1A\u5EF6\u8FDF\u6545\u969C\u5BB9\u9519\u5B9E\u73B0\u3002\u7EF4\u62A4\u6BCF\u4E2A\u5BF9\u8C61\u7684\u4FE1\u606F\u3002</li></ul><p>FaultItem</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FaultItem</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">implements</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Comparable</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">FaultItem</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;">    /**</span></span>
<span class="line"><span style="color:#676E95;">      * \u5BF9\u8C61\u540D</span></span>
<span class="line"><span style="color:#676E95;">      */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> name</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;">    /**</span></span>
<span class="line"><span style="color:#676E95;">      * \u5EF6\u8FDF</span></span>
<span class="line"><span style="color:#676E95;">      */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> currentLatency</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;">    /**</span></span>
<span class="line"><span style="color:#676E95;">      * \u5F00\u59CB\u53EF\u7528\u65F6\u95F4</span></span>
<span class="line"><span style="color:#676E95;">      */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> startTimestamp</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">FaultItem</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">name </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> name</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">    /**</span></span>
<span class="line"><span style="color:#676E95;">      * \u6BD4\u8F83\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#676E95;">      * \u53EF\u7528\u6027 &gt; \u5EF6\u8FDF &gt; \u5F00\u59CB\u53EF\u7528\u65F6\u95F4</span></span>
<span class="line"><span style="color:#676E95;">      *</span></span>
<span class="line"><span style="color:#676E95;">      * </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">other</span><span style="color:#676E95;"> other</span></span>
<span class="line"><span style="color:#676E95;">      * </span><span style="color:#F78C6C;">@return</span><span style="color:#676E95;"> \u5347\u5E8F</span></span>
<span class="line"><span style="color:#676E95;">      */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">compareTo</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">FaultItem</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">other</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(this.</span><span style="color:#82AAFF;">isAvailable</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isAvailable</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(this.</span><span style="color:#82AAFF;">isAvailable</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">other</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isAvailable</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(this.</span><span style="color:#A6ACCD;">currentLatency </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">currentLatency</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(this.</span><span style="color:#A6ACCD;">currentLatency </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">currentLatency</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(this.</span><span style="color:#A6ACCD;">startTimestamp </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">startTimestamp</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(this.</span><span style="color:#A6ACCD;">startTimestamp </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">startTimestamp</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">    /**</span></span>
<span class="line"><span style="color:#676E95;">      * \u662F\u5426\u53EF\u7528\uFF1A\u5F53\u5F00\u59CB\u53EF\u7528\u65F6\u95F4\u5927\u4E8E\u5F53\u524D\u65F6\u95F4</span></span>
<span class="line"><span style="color:#676E95;">      *</span></span>
<span class="line"><span style="color:#676E95;">      * </span><span style="color:#F78C6C;">@return</span><span style="color:#676E95;"> \u662F\u5426\u53EF\u7528</span></span>
<span class="line"><span style="color:#676E95;">      */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isAvailable</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> startTimestamp</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">hashCode</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> result </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getName</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getName</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">hashCode</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        result </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">31</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> result </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">getCurrentLatency</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">^</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">getCurrentLatency</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;&gt;&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">32</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">        result </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">31</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> result </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">getStartTimestamp</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">^</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">getStartTimestamp</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;&gt;&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">32</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> result</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">equals</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Object</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">o</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(this</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> o</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!(</span><span style="color:#A6ACCD;">o </span><span style="color:#89DDFF;">instanceof</span><span style="color:#A6ACCD;"> FaultItem</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">FaultItem</span><span style="color:#A6ACCD;"> faultItem </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">FaultItem</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> o</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">getCurrentLatency</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> faultItem</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getCurrentLatency</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">getStartTimestamp</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> faultItem</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getStartTimestamp</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getName</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getName</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">equals</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">faultItem</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getName</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> faultItem</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getName</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><ul><li>\u8BF4\u660E \uFF1A\u5BF9\u8C61\u6545\u969C\u4FE1\u606F\u3002\u7EF4\u62A4\u5BF9\u8C61\u7684\u540D\u5B57\u3001\u5EF6\u8FDF\u3001\u5F00\u59CB\u53EF\u7528\u7684\u65F6\u95F4\u3002</li></ul><p>DefaultMQProducerImpl#sendKernelImpl()</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">SendResult</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">sendKernelImpl</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Message</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">//</span></span>
<span class="line"><span style="color:#A6ACCD;">                                  </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">MessageQueue</span><span style="color:#A6ACCD;"> mq</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">//</span></span>
<span class="line"><span style="color:#A6ACCD;">                                  </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CommunicationMode</span><span style="color:#A6ACCD;"> communicationMode</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">//</span></span>
<span class="line"><span style="color:#A6ACCD;">                                  </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">SendCallback</span><span style="color:#A6ACCD;"> sendCallback</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">//</span></span>
<span class="line"><span style="color:#A6ACCD;">                                  </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TopicPublishInfo</span><span style="color:#A6ACCD;"> topicPublishInfo</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">//</span></span>
<span class="line"><span style="color:#A6ACCD;">                                  </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> timeout</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws MQClientException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> RemotingException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> MQBrokerException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u83B7\u53D6 broker\u5730\u5740</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> brokerAddr </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">mQClientFactory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">findBrokerAddressInPublish</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mq</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getBrokerName</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> brokerAddr</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">tryToFindTopicPublishInfo</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mq</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getTopic</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">        brokerAddr </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">mQClientFactory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">findBrokerAddressInPublish</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mq</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getBrokerName</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">SendMessageContext</span><span style="color:#A6ACCD;"> context </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">brokerAddr </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u662F\u5426\u4F7F\u7528broker vip\u901A\u9053\u3002broker\u4F1A\u5F00\u542F\u4E24\u4E2A\u7AEF\u53E3\u5BF9\u5916\u670D\u52A1\u3002</span></span>
<span class="line"><span style="color:#A6ACCD;">        brokerAddr </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> MixAll</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">brokerVIPChannel</span><span style="color:#89DDFF;">(this.</span><span style="color:#A6ACCD;">defaultMQProducer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isSendMessageWithVIPChannel</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> brokerAddr</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">byte</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> prevBody </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getBody</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u8BB0\u5F55\u6D88\u606F\u5185\u5BB9\u3002\u4E0B\u9762\u903B\u8F91\u53EF\u80FD\u6539\u53D8\u6D88\u606F\u5185\u5BB9\uFF0C\u4F8B\u5982\u6D88\u606F\u538B\u7F29\u3002</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u8BBE\u7F6E\u552F\u4E00\u7F16\u53F7</span></span>
<span class="line"><span style="color:#A6ACCD;">            MessageClientIDSetter</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setUniqID</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u6D88\u606F\u538B\u7F29</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> sysFlag </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(this.</span><span style="color:#82AAFF;">tryToCompressMessage</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                sysFlag </span><span style="color:#89DDFF;">|=</span><span style="color:#A6ACCD;"> MessageSysFlag</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">COMPRESSED_FLAG</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u4E8B\u52A1</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> tranMsg </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getProperty</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">MessageConst</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">PROPERTY_TRANSACTION_PREPARED</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tranMsg </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> Boolean</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">parseBoolean</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tranMsg</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                sysFlag </span><span style="color:#89DDFF;">|=</span><span style="color:#A6ACCD;"> MessageSysFlag</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">TRANSACTION_PREPARED_TYPE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// hook\uFF1A\u53D1\u9001\u6D88\u606F\u6821\u9A8C</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">hasCheckForbiddenHook</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">CheckForbiddenContext</span><span style="color:#A6ACCD;"> checkForbiddenContext </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CheckForbiddenContext</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                checkForbiddenContext</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setNameSrvAddr</span><span style="color:#89DDFF;">(this.</span><span style="color:#A6ACCD;">defaultMQProducer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getNamesrvAddr</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">                checkForbiddenContext</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setGroup</span><span style="color:#89DDFF;">(this.</span><span style="color:#A6ACCD;">defaultMQProducer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getProducerGroup</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">                checkForbiddenContext</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setCommunicationMode</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">communicationMode</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                checkForbiddenContext</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setBrokerAddr</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">brokerAddr</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                checkForbiddenContext</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setMessage</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                checkForbiddenContext</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setMq</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mq</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                checkForbiddenContext</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setUnitMode</span><span style="color:#89DDFF;">(this.</span><span style="color:#82AAFF;">isUnitMode</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">executeCheckForbiddenHook</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">checkForbiddenContext</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// hook\uFF1A\u53D1\u9001\u6D88\u606F\u524D\u903B\u8F91</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(this.</span><span style="color:#82AAFF;">hasSendMessageHook</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                context </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SendMessageContext</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setProducer</span><span style="color:#89DDFF;">(this);</span></span>
<span class="line"><span style="color:#A6ACCD;">                context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setProducerGroup</span><span style="color:#89DDFF;">(this.</span><span style="color:#A6ACCD;">defaultMQProducer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getProducerGroup</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">                context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setCommunicationMode</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">communicationMode</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setBornHost</span><span style="color:#89DDFF;">(this.</span><span style="color:#A6ACCD;">defaultMQProducer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getClientIP</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">                context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setBrokerAddr</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">brokerAddr</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setMessage</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setMq</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mq</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> isTrans </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getProperty</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">MessageConst</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">PROPERTY_TRANSACTION_PREPARED</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">isTrans </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> isTrans</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">equals</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">true</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setMsgType</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">MessageType</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Trans_Msg_Half</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getProperty</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">__STARTDELIVERTIME</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getProperty</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">MessageConst</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">PROPERTY_DELAY_TIME_LEVEL</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setMsgType</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">MessageType</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Delay_Msg</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">executeSendMessageHookBefore</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">context</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u6784\u5EFA\u53D1\u9001\u6D88\u606F\u8BF7\u6C42</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">SendMessageRequestHeader</span><span style="color:#A6ACCD;"> requestHeader </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SendMessageRequestHeader</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            requestHeader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setProducerGroup</span><span style="color:#89DDFF;">(this.</span><span style="color:#A6ACCD;">defaultMQProducer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getProducerGroup</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">            requestHeader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setTopic</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getTopic</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">            requestHeader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setDefaultTopic</span><span style="color:#89DDFF;">(this.</span><span style="color:#A6ACCD;">defaultMQProducer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getCreateTopicKey</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">            requestHeader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setDefaultTopicQueueNums</span><span style="color:#89DDFF;">(this.</span><span style="color:#A6ACCD;">defaultMQProducer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getDefaultTopicQueueNums</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">            requestHeader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setQueueId</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mq</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getQueueId</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">            requestHeader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setSysFlag</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">sysFlag</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            requestHeader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setBornTimestamp</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">            requestHeader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setFlag</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getFlag</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">            requestHeader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setProperties</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">MessageDecoder</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">messageProperties2String</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getProperties</span><span style="color:#89DDFF;">()));</span></span>
<span class="line"><span style="color:#A6ACCD;">            requestHeader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setReconsumeTimes</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            requestHeader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setUnitMode</span><span style="color:#89DDFF;">(this.</span><span style="color:#82AAFF;">isUnitMode</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">requestHeader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getTopic</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">startsWith</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">MixAll</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">RETRY_GROUP_TOPIC_PREFIX</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u6D88\u606F\u91CD\u53D1Topic</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> reconsumeTimes </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> MessageAccessor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getReconsumeTime</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">reconsumeTimes </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    requestHeader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setReconsumeTimes</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Integer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">valueOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">reconsumeTimes</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">                    MessageAccessor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">clearProperty</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> MessageConst</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">PROPERTY_RECONSUME_TIME</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> maxReconsumeTimes </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> MessageAccessor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getMaxReconsumeTimes</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">maxReconsumeTimes </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    requestHeader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setMaxReconsumeTimes</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Integer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">valueOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">maxReconsumeTimes</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">                    MessageAccessor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">clearProperty</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> MessageConst</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">PROPERTY_MAX_RECONSUME_TIMES</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u53D1\u9001\u6D88\u606F</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">SendResult</span><span style="color:#A6ACCD;"> sendResult </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">switch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">communicationMode</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">case</span><span style="color:#A6ACCD;"> ASYNC</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                    sendResult </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">mQClientFactory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getMQClientAPIImpl</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">sendMessage</span><span style="color:#89DDFF;">(</span><span style="color:#676E95;">//</span></span>
<span class="line"><span style="color:#A6ACCD;">                        brokerAddr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// 1</span></span>
<span class="line"><span style="color:#A6ACCD;">                        mq</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getBrokerName</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// 2</span></span>
<span class="line"><span style="color:#A6ACCD;">                        msg</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// 3</span></span>
<span class="line"><span style="color:#A6ACCD;">                        requestHeader</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// 4</span></span>
<span class="line"><span style="color:#A6ACCD;">                        timeout</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// 5</span></span>
<span class="line"><span style="color:#A6ACCD;">                        communicationMode</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// 6</span></span>
<span class="line"><span style="color:#A6ACCD;">                        sendCallback</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// 7</span></span>
<span class="line"><span style="color:#A6ACCD;">                        topicPublishInfo</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// 8</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">mQClientFactory</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// 9</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">defaultMQProducer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getRetryTimesWhenSendAsyncFailed</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// 10</span></span>
<span class="line"><span style="color:#A6ACCD;">                        context</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">//</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">this);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">case</span><span style="color:#A6ACCD;"> ONEWAY</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">case</span><span style="color:#A6ACCD;"> SYNC</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                    sendResult </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">mQClientFactory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getMQClientAPIImpl</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">sendMessage</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">                        brokerAddr</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                        mq</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getBrokerName</span><span style="color:#89DDFF;">(),</span></span>
<span class="line"><span style="color:#A6ACCD;">                        msg</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                        requestHeader</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                        timeout</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                        communicationMode</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                        context</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">this);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">default:</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">assert</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// hook\uFF1A\u53D1\u9001\u6D88\u606F\u540E\u903B\u8F91</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(this.</span><span style="color:#82AAFF;">hasSendMessageHook</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setSendResult</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">sendResult</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">executeSendMessageHookAfter</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">context</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u8FD4\u56DE\u53D1\u9001\u7ED3\u679C</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> sendResult</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">RemotingException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(this.</span><span style="color:#82AAFF;">hasSendMessageHook</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setException</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">executeSendMessageHookAfter</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">context</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">MQBrokerException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(this.</span><span style="color:#82AAFF;">hasSendMessageHook</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setException</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">executeSendMessageHookAfter</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">context</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(this.</span><span style="color:#82AAFF;">hasSendMessageHook</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setException</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">executeSendMessageHookAfter</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">context</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setBody</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">prevBody</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// broker\u4E3A\u7A7A\u629B\u51FA\u5F02\u5E38</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MQClientException</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">The broker[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> mq</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getBrokerName</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">] not exist</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="broker-\u53D1\u9001\u6D88\u606F" tabindex="-1">Broker \u53D1\u9001\u6D88\u606F ---&gt; <a class="header-anchor" href="#broker-\u53D1\u9001\u6D88\u606F" aria-hidden="true">#</a></h5><p><img src="`+t+`" alt="image-20220706111637175"></p><p>SendMessageProcessor#sendMessage</p><p>AbstractSendMessageProcessor#msgCheck</p><p>DefaultMessageStore#putMessage</p><h4 id="message-\u5B58\u50A8" tabindex="-1">Message \u5B58\u50A8 <a class="header-anchor" href="#message-\u5B58\u50A8" aria-hidden="true">#</a></h4><p>CommitLog</p><h2 id="\u8FD0\u7EF4\u7BC7" tabindex="-1">\u8FD0\u7EF4\u7BC7 <a class="header-anchor" href="#\u8FD0\u7EF4\u7BC7" aria-hidden="true">#</a></h2><h4 id="\u5B89\u88C5\u6307\u5357" tabindex="-1">\u5B89\u88C5\u6307\u5357 <a class="header-anchor" href="#\u5B89\u88C5\u6307\u5357" aria-hidden="true">#</a></h4><blockquote><p><code>docker-compose.yml</code>\u540C\u7EA7\u4E0B\u9762\u76F8\u5E94\u7684\u5EFA\u7ACB\u4E09\u4E2A\u6587\u4EF6\u5939<code>conf</code>\u3001<code>logs</code>\u3001<code>store</code></p><p><code>conf</code>\u6587\u4EF6\u5939\u4E0B\u9762\u5EFA\u7ACB<code>broker.conf</code>\u914D\u7F6E\u6587\u4EF6\uFF0C\u6240\u6709\u6587\u4EF6\u7684\u76EE\u5F55\u4F4D\u7F6E\u5982\u4E0B:</p><div class="language-"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">docker-compose.yml</span></span>
<span class="line"><span style="color:#A6ACCD;">conf</span></span>
<span class="line"><span style="color:#A6ACCD;">- broker.conf</span></span>
<span class="line"><span style="color:#A6ACCD;">logs</span></span>
<span class="line"><span style="color:#A6ACCD;">store</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p><code>broker.conf</code></p><div class="language-xml"><button class="copy"></button><span class="lang">xml</span><pre><code><span class="line"><span style="color:#A6ACCD;"># \u6240\u5C5E\u96C6\u7FA4\u540D\u5B57</span></span>
<span class="line"><span style="color:#A6ACCD;">brokerClusterName=DefaultCluster</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># broker \u540D\u5B57\uFF0C\u6CE8\u610F\u6B64\u5904\u4E0D\u540C\u7684\u914D\u7F6E\u6587\u4EF6\u586B\u5199\u7684\u4E0D\u4E00\u6837\uFF0C\u5982\u679C\u5728 broker-a.properties \u4F7F\u7528: broker-a,</span></span>
<span class="line"><span style="color:#A6ACCD;"># \u5728 broker-b.properties \u4F7F\u7528: broker-b</span></span>
<span class="line"><span style="color:#A6ACCD;">brokerName=broker-a</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># 0 \u8868\u793A Master\uFF0C</span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">gt</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> 0 \u8868\u793A Slave</span></span>
<span class="line"><span style="color:#A6ACCD;">brokerId=0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># nameServer\u5730\u5740\uFF0C\u5206\u53F7\u5206\u5272</span></span>
<span class="line"><span style="color:#A6ACCD;"># namesrvAddr=rocketmq-nameserver1:9876;rocketmq-nameserver2:9876</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># \u542F\u52A8IP,\u5982\u679C docker \u62A5 com.alibaba.rocketmq.remoting.exception.RemotingConnectException: connect to failed</span></span>
<span class="line"><span style="color:#A6ACCD;"># \u89E3\u51B3\u65B9\u5F0F1 \u52A0\u4E0A\u4E00\u53E5 producer.setVipChannelEnabled(false);\uFF0C\u89E3\u51B3\u65B9\u5F0F2brokerIP1 \u8BBE\u7F6E\u5BBF\u4E3B\u673AIP\uFF0C\u4E0D\u8981\u4F7F\u7528docker\u5185\u90E8IP</span></span>
<span class="line"><span style="color:#A6ACCD;">brokerIP1=192.168.1.16 #\u672C\u673A\u7684ip</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># \u5728\u53D1\u9001\u6D88\u606F\u65F6\uFF0C\u81EA\u52A8\u521B\u5EFA\u670D\u52A1\u5668\u4E0D\u5B58\u5728\u7684topic\uFF0C\u9ED8\u8BA4\u521B\u5EFA\u7684\u961F\u5217\u6570</span></span>
<span class="line"><span style="color:#A6ACCD;">defaultTopicQueueNums=4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># \u662F\u5426\u5141\u8BB8 Broker \u81EA\u52A8\u521B\u5EFA Topic\uFF0C\u5EFA\u8BAE\u7EBF\u4E0B\u5F00\u542F\uFF0C\u7EBF\u4E0A\u5173\u95ED \uFF01\uFF01\uFF01\u8FD9\u91CC\u4ED4\u7EC6\u770B\u662F false\uFF0Cfalse\uFF0Cfalse</span></span>
<span class="line"><span style="color:#A6ACCD;">autoCreateTopicEnable=true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># \u662F\u5426\u5141\u8BB8 Broker \u81EA\u52A8\u521B\u5EFA\u8BA2\u9605\u7EC4\uFF0C\u5EFA\u8BAE\u7EBF\u4E0B\u5F00\u542F\uFF0C\u7EBF\u4E0A\u5173\u95ED</span></span>
<span class="line"><span style="color:#A6ACCD;">autoCreateSubscriptionGroup=true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># Broker \u5BF9\u5916\u670D\u52A1\u7684\u76D1\u542C\u7AEF\u53E3</span></span>
<span class="line"><span style="color:#A6ACCD;">listenPort=10911</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># \u5220\u9664\u6587\u4EF6\u65F6\u95F4\u70B9\uFF0C\u9ED8\u8BA4\u51CC\u66684\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">deleteWhen=04</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># \u6587\u4EF6\u4FDD\u7559\u65F6\u95F4\uFF0C\u9ED8\u8BA448\u5C0F\u65F6</span></span>
<span class="line"><span style="color:#A6ACCD;">fileReservedTime=120</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># commitLog \u6BCF\u4E2A\u6587\u4EF6\u7684\u5927\u5C0F\u9ED8\u8BA41G</span></span>
<span class="line"><span style="color:#A6ACCD;">mapedFileSizeCommitLog=1073741824</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># ConsumeQueue \u6BCF\u4E2A\u6587\u4EF6\u9ED8\u8BA4\u5B58 30W \u6761\uFF0C\u6839\u636E\u4E1A\u52A1\u60C5\u51B5\u8C03\u6574</span></span>
<span class="line"><span style="color:#A6ACCD;">mapedFileSizeConsumeQueue=300000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># destroyMapedFileIntervalForcibly=120000</span></span>
<span class="line"><span style="color:#A6ACCD;"># redeleteHangedFileInterval=120000</span></span>
<span class="line"><span style="color:#A6ACCD;"># \u68C0\u6D4B\u7269\u7406\u6587\u4EF6\u78C1\u76D8\u7A7A\u95F4</span></span>
<span class="line"><span style="color:#A6ACCD;">diskMaxUsedSpaceRatio=88</span></span>
<span class="line"><span style="color:#A6ACCD;"># \u5B58\u50A8\u8DEF\u5F84</span></span>
<span class="line"><span style="color:#A6ACCD;"># storePathRootDir=/home/ztztdata/rocketmq-all-4.1.0-incubating/store</span></span>
<span class="line"><span style="color:#A6ACCD;"># commitLog \u5B58\u50A8\u8DEF\u5F84</span></span>
<span class="line"><span style="color:#A6ACCD;"># storePathCommitLog=/home/ztztdata/rocketmq-all-4.1.0-incubating/store/commitlog</span></span>
<span class="line"><span style="color:#A6ACCD;"># \u6D88\u8D39\u961F\u5217\u5B58\u50A8</span></span>
<span class="line"><span style="color:#A6ACCD;"># storePathConsumeQueue=/home/ztztdata/rocketmq-all-4.1.0-incubating/store/consumequeue</span></span>
<span class="line"><span style="color:#A6ACCD;"># \u6D88\u606F\u7D22\u5F15\u5B58\u50A8\u8DEF\u5F84</span></span>
<span class="line"><span style="color:#A6ACCD;"># storePathIndex=/home/ztztdata/rocketmq-all-4.1.0-incubating/store/index</span></span>
<span class="line"><span style="color:#A6ACCD;"># checkpoint \u6587\u4EF6\u5B58\u50A8\u8DEF\u5F84</span></span>
<span class="line"><span style="color:#A6ACCD;"># storeCheckpoint=/home/ztztdata/rocketmq-all-4.1.0-incubating/store/checkpoint</span></span>
<span class="line"><span style="color:#A6ACCD;"># abort \u6587\u4EF6\u5B58\u50A8\u8DEF\u5F84</span></span>
<span class="line"><span style="color:#A6ACCD;"># abortFile=/home/ztztdata/rocketmq-all-4.1.0-incubating/store/abort</span></span>
<span class="line"><span style="color:#A6ACCD;"># \u9650\u5236\u7684\u6D88\u606F\u5927\u5C0F</span></span>
<span class="line"><span style="color:#A6ACCD;">maxMessageSize=65536</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># flushCommitLogLeastPages=4</span></span>
<span class="line"><span style="color:#A6ACCD;"># flushConsumeQueueLeastPages=2</span></span>
<span class="line"><span style="color:#A6ACCD;"># flushCommitLogThoroughInterval=10000</span></span>
<span class="line"><span style="color:#A6ACCD;"># flushConsumeQueueThoroughInterval=60000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># Broker \u7684\u89D2\u8272</span></span>
<span class="line"><span style="color:#A6ACCD;"># - ASYNC_MASTER \u5F02\u6B65\u590D\u5236Master</span></span>
<span class="line"><span style="color:#A6ACCD;"># - SYNC_MASTER \u540C\u6B65\u53CC\u5199Master</span></span>
<span class="line"><span style="color:#A6ACCD;"># - SLAVE</span></span>
<span class="line"><span style="color:#A6ACCD;">brokerRole=ASYNC_MASTER</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># \u5237\u76D8\u65B9\u5F0F</span></span>
<span class="line"><span style="color:#A6ACCD;"># - ASYNC_FLUSH \u5F02\u6B65\u5237\u76D8</span></span>
<span class="line"><span style="color:#A6ACCD;"># - SYNC_FLUSH \u540C\u6B65\u5237\u76D8</span></span>
<span class="line"><span style="color:#A6ACCD;">flushDiskType=ASYNC_FLUSH</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"># \u53D1\u6D88\u606F\u7EBF\u7A0B\u6C60\u6570\u91CF</span></span>
<span class="line"><span style="color:#A6ACCD;"># sendMessageThreadPoolNums=128</span></span>
<span class="line"><span style="color:#A6ACCD;"># \u62C9\u6D88\u606F\u7EBF\u7A0B\u6C60\u6570\u91CF</span></span>
<span class="line"><span style="color:#A6ACCD;"># pullMessageThreadPoolNums=128</span></span>
<span class="line"></span></code></pre></div><p><code>http://xxx:8099/</code></p></blockquote><h2 id="\u5E94\u7528\u7BC7" tabindex="-1">\u5E94\u7528\u7BC7 <a class="header-anchor" href="#\u5E94\u7528\u7BC7" aria-hidden="true">#</a></h2><h4 id="springboot\u5E94\u7528" tabindex="-1">springboot\u5E94\u7528 <a class="header-anchor" href="#springboot\u5E94\u7528" aria-hidden="true">#</a></h4><blockquote><div class="language-xml"><button class="copy"></button><span class="lang">xml</span><pre><code><span class="line"><span style="color:#676E95;">&lt;!--\u5728pom.xml\u4E2D\u6DFB\u52A0\u4F9D\u8D56--&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">dependency</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">groupid</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">org.apache.rocketmq</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">groupid</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">artifactid</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">rocketmq-spring-boot-starter</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">artifactid</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">version</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">2.0.3</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">version</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">dependency</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p><code>\u6D88\u8D39\u670D\u52A1\u53D1\u9001\u65B9\u914D\u7F6E\u5982\u4E0B\uFF1A</code></p><div class="language-"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">## application.properties</span></span>
<span class="line"><span style="color:#A6ACCD;">rocketmq.name-server=ip:9876</span></span>
<span class="line"><span style="color:#A6ACCD;">rocketmq.producer.group=my-group</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p><code>\u6D88\u8D39\u670D\u52A1\u53D1\u9001\u65B9\u7A0B\u5E8F\u5982\u4E0B\uFF1A</code></p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">SpringBootApplication</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ProducerApplication</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">implements</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">CommandLineRunner</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Resource</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">RocketMQTemplate</span><span style="color:#A6ACCD;"> rocketMQTemplate</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">args</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#A6ACCD;">       SpringApplication</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ProducerApplication</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">run</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">...</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Exception</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       rocketMQTemplate</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">convertAndSend</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test-topic-1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello, World!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">       rocketMQTemplate</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">send</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test-topic-1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> MessageBuilder</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">withPayload</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello, World! I&#39;m from spring message</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">build</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><code>\u6D88\u606F\u6D88\u8D39\u65B9\u914D\u7F6E\u5982\u4E0B\uFF1A</code></p><div class="language-"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">## application.properties</span></span>
<span class="line"><span style="color:#A6ACCD;">rocketmq.name-server=ip:9876</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p><code>\u6D88\u606F\u6D88\u8D39\u65B9\u8FD0\u884C\u7A0B\u5E8F\u5982\u4E0B\uFF1A</code></p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">SpringBootApplication</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ConsumerApplication</span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">args</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#A6ACCD;">   SpringApplication</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ConsumerApplication</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Slf4j</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Service</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">RocketMQMessageListener</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">topic</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test-topic-1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">consumerGroup</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">my-consumer_test-topic-1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MyConsumer1</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">implements</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RocketMQListener</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">string</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">onMessage</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">message</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        log</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">info</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">received message: {}</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> message</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div></blockquote><h2 id="\u6269\u5C55\u7BC7" tabindex="-1">\u6269\u5C55\u7BC7 <a class="header-anchor" href="#\u6269\u5C55\u7BC7" aria-hidden="true">#</a></h2>`,42),D=[r];function y(A,F,C,i,u,m){return a(),n("div",null,D)}const g=s(c,[["render",y]]);export{d as __pageData,g as default};
