import{_ as s,c as n,o as a,a as l}from"./app.1af635ee.js";const p="/assets/e6c9d24ely1gzuppchmldj21lm078myf.09ed68ff.jpg",o="/assets/e6c9d24ely1gzuprj83gqj21hw0hqmz2.1b21c6ed.jpg",e="/assets/image-20220405200909856.c7a8afd2.png",t="/assets/image-20220405200921538.3d39fe90.png",c="/assets/image-20220405201001305.66947687.png",r="/assets/image-20220405201028135.a46099ef.png",D="/assets/image-20220405200130691.25217ec9.png",y="/assets/image-20220406101540742.db15bc3a.png",A="/assets/e6c9d24ely1gzwtkeydk7j2194068jsd.aa214fd0.jpg",F="/assets/e6c9d24ely1gzvdbajqhfj229a0u0te0.5a16c65c.jpg",C="/assets/e6c9d24ely1gzve59lrkqj21wq0ca76u.f1abc344.jpg",i="/assets/e6c9d24ely1gzvtjfgg91j21e00howh1.edff8a3d.jpg",u="/assets/e6c9d24ely1h016lyg63ij21ew0dsgnt.e5b8f8d2.jpg",E="/assets/e6c9d24ely1h016s4p0rfj21as0hg76w.669a1c67.jpg",d="/assets/e6c9d24ely1h018ts8x80j21to0eidix.dc3ca18b.jpg",g="/assets/image-20220406102137754.c1d49d07.png",h="/assets/image-20220406102232375.970b3c55.png",b="/assets/image-20220406102601299.016bc980.png",m="/assets/image-20220406102943972.91957123.png",v="/assets/image-20220406103844984.215420e8.png",S="/assets/e6c9d24egy1h02eg5qcfaj21pa0ekju1.f9cbe7d9.jpg",f="/assets/image-20220406100926787.f2b8031e.png",k="/assets/image-20220406181701396.c38b4853.png",w="/assets/image-20220405201620171.3b07f9ef.png",x="/assets/e6c9d24ely1h004uzeni8j224k0ca0w9.f320b575.jpg",T="/assets/e6c9d24ely1h007thq2x1j22ce0k879c.fb309f83.jpg",q="/assets/image-20220406112223538.6b32a17b.png",_=JSON.parse('{"title":"JUC","description":"","frontmatter":{},"headers":[{"level":2,"title":"\u539F\u7406\u7BC7","slug":"\u539F\u7406\u7BC7","link":"#\u539F\u7406\u7BC7","children":[]},{"level":2,"title":"\u6E90\u7801\u7BC7","slug":"\u6E90\u7801\u7BC7","link":"#\u6E90\u7801\u7BC7","children":[]},{"level":2,"title":"\u5E94\u7528\u7BC7","slug":"\u5E94\u7528\u7BC7","link":"#\u5E94\u7528\u7BC7","children":[]}],"relativePath":"study/java/JUC.md"}'),j={name:"study/java/JUC.md"},I=l('<h1 id="juc" tabindex="-1">JUC <a class="header-anchor" href="#juc" aria-hidden="true">#</a></h1><h2 id="\u539F\u7406\u7BC7" tabindex="-1">\u539F\u7406\u7BC7 <a class="header-anchor" href="#\u539F\u7406\u7BC7" aria-hidden="true">#</a></h2><h4 id="\u5E76\u53D1-\u5E76\u884C" tabindex="-1">\u5E76\u53D1&amp;\u5E76\u884C <a class="header-anchor" href="#\u5E76\u53D1-\u5E76\u884C" aria-hidden="true">#</a></h4><p><strong>\u5E76\u53D1\u6267\u884C</strong>\u4E5F\u662F\u6211\u4EEC\u540C\u4E00\u65F6\u95F4\u53EA\u80FD\u5904\u7406\u4E00\u4E2A\u4EFB\u52A1\uFF0C\u4F46\u662F\u6211\u4EEC\u53EF\u4EE5\u6BCF\u4E2A\u4EFB\u52A1\u8F6E\u7740\u505A\uFF08\u65F6\u95F4\u7247\u8F6E\u8F6C\uFF09\uFF1A</p><p><img src="'+p+'" alt="image-20220301214032719"></p><p>\u53EA\u8981\u6211\u4EEC\u5355\u6B21\u5904\u7406\u5206\u914D\u7684\u65F6\u95F4\u8DB3\u591F\u7684\u77ED\uFF0C\u5728\u5B8F\u89C2\u770B\u6765\uFF0C\u5C31\u662F\u4E09\u4E2A\u4EFB\u52A1\u5728\u540C\u65F6\u8FDB\u884C\u3002</p><p>\u800C\u6211\u4EECJava\u4E2D\u7684\u7EBF\u7A0B\uFF0C\u6B63\u662F\u8FD9\u79CD\u673A\u5236\uFF0C\u5F53\u6211\u4EEC\u9700\u8981\u540C\u65F6\u5904\u7406\u4E0A\u767E\u4E2A\u4E0A\u5343\u4E2A\u4EFB\u52A1\u65F6\uFF0C\u5F88\u660E\u663ECPU\u7684\u6570\u91CF\u662F\u4E0D\u53EF\u80FD\u8D76\u5F97\u4E0A\u6211\u4EEC\u7684\u7EBF\u7A0B\u6570\u7684\uFF0C\u6240\u4EE5\u8BF4\u8FD9\u65F6\u5C31\u8981\u6C42\u6211\u4EEC\u7684\u7A0B\u5E8F\u6709\u826F\u597D\u7684\u5E76\u53D1\u6027\u80FD\uFF0C\u6765\u5E94\u5BF9\u540C\u4E00\u65F6\u95F4\u5927\u91CF\u7684\u4EFB\u52A1\u5904\u7406\u3002</p><p><strong>\u5E76\u884C\u6267\u884C</strong>\u5C31\u7A81\u7834\u4E86\u540C\u4E00\u65F6\u95F4\u53EA\u80FD\u5904\u7406\u4E00\u4E2A\u4EFB\u52A1\u7684\u9650\u5236\uFF0C\u6211\u4EEC\u540C\u4E00\u65F6\u95F4\u53EF\u4EE5\u505A\u591A\u4E2A\u4EFB\u52A1\uFF1A</p><p><img src="'+o+`" alt="image-20220301214238743"></p><p>\u6BD4\u5982\u6211\u4EEC\u8981\u8FDB\u884C\u4E00\u4E9B\u6392\u5E8F\u64CD\u4F5C\uFF0C\u5C31\u53EF\u4EE5\u7528\u5230\u5E76\u884C\u8BA1\u7B97\uFF0C\u53EA\u9700\u8981\u7B49\u5F85\u6240\u6709\u5B50\u4EFB\u52A1\u5B8C\u6210\uFF0C\u6700\u540E\u5C06\u7ED3\u679C\u6C47\u603B\u5373\u53EF\u3002\u5305\u62EC\u5206\u5E03\u5F0F\u8BA1\u7B97\u6A21\u578BMapReduce\uFF0C\u4E5F\u662F\u91C7\u7528\u7684\u5E76\u884C\u8BA1\u7B97\u601D\u8DEF\u3002</p><h4 id="\u9501\u673A\u5236" tabindex="-1">\u9501\u673A\u5236 <a class="header-anchor" href="#\u9501\u673A\u5236" aria-hidden="true">#</a></h4><h5 id="\u91CD\u91CF\u7EA7\u9501" tabindex="-1">\u91CD\u91CF\u7EA7\u9501 <a class="header-anchor" href="#\u91CD\u91CF\u7EA7\u9501" aria-hidden="true">#</a></h5><p>\u5728JDK6\u4E4B\u524D\uFF0C<code>synchronized</code>\u4E00\u76F4\u88AB\u79F0\u4E3A\u91CD\u91CF\u7EA7\u9501\uFF0C<code>monitor</code>\u4F9D\u8D56\u4E8E\u5E95\u5C42\u64CD\u4F5C\u7CFB\u7EDF\u7684Lock\u5B9E\u73B0\uFF0CJava\u7684\u7EBF\u7A0B\u662F\u6620\u5C04\u5230\u64CD\u4F5C\u7CFB\u7EDF\u7684\u539F\u751F\u7EBF\u7A0B\u4E0A\uFF0C\u5207\u6362\u6210\u672C\u8F83\u9AD8\u3002\u800C\u5728JDK6\u4E4B\u540E\uFF0C\u9501\u7684\u5B9E\u73B0\u5F97\u5230\u4E86\u6539\u8FDB\u3002</p><p>\u6BCF\u4E2A\u5BF9\u8C61\u90FD\u6709\u4E00\u4E2Amonitor\u4E0E\u4E4B\u5173\u8054\uFF0C\u5728Java\u865A\u62DF\u673A\uFF08HotSpot\uFF09\u4E2D\uFF0Cmonitor\u662F\u7531ObjectMonitor\u5B9E\u73B0\u7684\uFF1A</p><div class="language-"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">ObjectMonitor() {</span></span>
<span class="line"><span style="color:#A6ACCD;">    _header       = NULL;</span></span>
<span class="line"><span style="color:#A6ACCD;">    _count        = 0; //\u8BB0\u5F55\u4E2A\u6570</span></span>
<span class="line"><span style="color:#A6ACCD;">    _waiters      = 0,</span></span>
<span class="line"><span style="color:#A6ACCD;">    _recursions   = 0;</span></span>
<span class="line"><span style="color:#A6ACCD;">    _object       = NULL;</span></span>
<span class="line"><span style="color:#A6ACCD;">    _owner        = NULL;</span></span>
<span class="line"><span style="color:#A6ACCD;">    _WaitSet      = NULL; //\u5904\u4E8Ewait\u72B6\u6001\u7684\u7EBF\u7A0B\uFF0C\u4F1A\u88AB\u52A0\u5165\u5230_WaitSet</span></span>
<span class="line"><span style="color:#A6ACCD;">    _WaitSetLock  = 0 ;</span></span>
<span class="line"><span style="color:#A6ACCD;">    _Responsible  = NULL ;</span></span>
<span class="line"><span style="color:#A6ACCD;">    _succ         = NULL ;</span></span>
<span class="line"><span style="color:#A6ACCD;">    _cxq          = NULL ;</span></span>
<span class="line"><span style="color:#A6ACCD;">    FreeNext      = NULL ;</span></span>
<span class="line"><span style="color:#A6ACCD;">    _EntryList    = NULL ; //\u5904\u4E8E\u7B49\u5F85\u9501block\u72B6\u6001\u7684\u7EBF\u7A0B\uFF0C\u4F1A\u88AB\u52A0\u5165\u5230\u8BE5\u5217\u8868</span></span>
<span class="line"><span style="color:#A6ACCD;">    _SpinFreq     = 0 ;</span></span>
<span class="line"><span style="color:#A6ACCD;">    _SpinClock    = 0 ;</span></span>
<span class="line"><span style="color:#A6ACCD;">    OwnerIsThread = 0 ;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>\u6BCF\u4E2A\u7B49\u5F85\u9501\u7684\u7EBF\u7A0B\u90FD\u4F1A\u88AB\u5C01\u88C5\u6210ObjectWaiter\u5BF9\u8C61\uFF0C\u8FDB\u5165\u5230\u5982\u4E0B\u673A\u5236\uFF1A</p><p><img src="`+e+'" alt="image-20220405200909856"></p><p>ObjectWaiter\u9996\u5148\u4F1A\u8FDB\u5165 Entry Set\u7B49\u7740\uFF0C\u5F53\u7EBF\u7A0B\u83B7\u53D6\u5230\u5BF9\u8C61\u7684<code>monitor</code>\u540E\u8FDB\u5165 The Owner \u533A\u57DF\u5E76\u628A<code>monitor</code>\u4E2D\u7684<code>owner</code>\u53D8\u91CF\u8BBE\u7F6E\u4E3A\u5F53\u524D\u7EBF\u7A0B\uFF0C\u540C\u65F6<code>monitor</code>\u4E2D\u7684\u8BA1\u6570\u5668<code>count</code>\u52A01\uFF0C\u82E5\u7EBF\u7A0B\u8C03\u7528<code>wait()</code>\u65B9\u6CD5\uFF0C\u5C06\u91CA\u653E\u5F53\u524D\u6301\u6709\u7684<code>monitor</code>\uFF0C<code>owner</code>\u53D8\u91CF\u6062\u590D\u4E3A<code>null</code>\uFF0C<code>count</code>\u81EA\u51CF1\uFF0C\u540C\u65F6\u8BE5\u7EBF\u7A0B\u8FDB\u5165 WaitSet\u96C6\u5408\u4E2D\u7B49\u5F85\u88AB\u5524\u9192\u3002\u82E5\u5F53\u524D\u7EBF\u7A0B\u6267\u884C\u5B8C\u6BD5\u4E5F\u5C06\u91CA\u653E<code>monitor</code>\u5E76\u590D\u4F4D\u53D8\u91CF\u7684\u503C\uFF0C\u4EE5\u4FBF\u5176\u4ED6\u7EBF\u7A0B\u8FDB\u5165\u83B7\u53D6\u5BF9\u8C61\u7684<code>monitor</code>\u3002</p><p>\u867D\u7136\u8FD9\u6837\u7684\u8BBE\u8BA1\u601D\u8DEF\u975E\u5E38\u5408\u7406\uFF0C\u4F46\u662F\u5728\u5927\u591A\u6570\u5E94\u7528\u4E0A\uFF0C\u6BCF\u4E00\u4E2A\u7EBF\u7A0B\u5360\u7528\u540C\u6B65\u4EE3\u7801\u5757\u7684\u65F6\u95F4\u5E76\u4E0D\u662F\u5F88\u957F\uFF0C\u6211\u4EEC\u5B8C\u5168\u6CA1\u6709\u5FC5\u8981\u5C06\u7ADE\u4E89\u4E2D\u7684\u7EBF\u7A0B\u6302\u8D77\u7136\u540E\u53C8\u5524\u9192\uFF0C\u5E76\u4E14\u73B0\u4EE3CPU\u57FA\u672C\u90FD\u662F\u591A\u6838\u5FC3\u8FD0\u884C\u7684\uFF0C\u6211\u4EEC\u53EF\u4EE5\u91C7\u7528\u4E00\u79CD\u65B0\u7684\u601D\u8DEF\u6765\u5B9E\u73B0\u9501\u3002</p><p>\u5728JDK1.4.2\u65F6\uFF0C\u5F15\u5165\u4E86\u81EA\u65CB\u9501\uFF08JDK6\u4E4B\u540E\u9ED8\u8BA4\u5F00\u542F\uFF09\uFF0C\u5B83\u4E0D\u4F1A\u5C06\u5904\u4E8E\u7B49\u5F85\u72B6\u6001\u7684\u7EBF\u7A0B\u6302\u8D77\uFF0C\u800C\u662F\u901A\u8FC7\u65E0\u9650\u5FAA\u73AF\u7684\u65B9\u5F0F\uFF0C\u4E0D\u65AD\u68C0\u6D4B\u662F\u5426\u80FD\u591F\u83B7\u53D6\u9501\uFF0C\u7531\u4E8E\u5355\u4E2A\u7EBF\u7A0B\u5360\u7528\u9501\u7684\u65F6\u95F4\u975E\u5E38\u77ED\uFF0C\u6240\u4EE5\u8BF4\u5FAA\u73AF\u6B21\u6570\u4E0D\u4F1A\u592A\u591A\uFF0C\u53EF\u80FD\u5F88\u5FEB\u5C31\u80FD\u591F\u62FF\u5230\u9501\u5E76\u8FD0\u884C\uFF0C\u8FD9\u5C31\u662F\u81EA\u65CB\u9501\u3002\u5F53\u7136\uFF0C\u4EC5\u4EC5\u662F\u5728\u7B49\u5F85\u65F6\u95F4\u975E\u5E38\u77ED\u7684\u60C5\u51B5\u4E0B\uFF0C\u81EA\u65CB\u9501\u7684\u8868\u73B0\u4F1A\u5F88\u597D\uFF0C\u4F46\u662F\u5982\u679C\u7B49\u5F85\u65F6\u95F4\u592A\u957F\uFF0C\u7531\u4E8E\u5FAA\u73AF\u662F\u9700\u8981\u5904\u7406\u5668\u7EE7\u7EED\u8FD0\u7B97\u7684\uFF0C\u6240\u4EE5\u8FD9\u6837\u53EA\u4F1A\u6D6A\u8D39\u5904\u7406\u5668\u8D44\u6E90\uFF0C\u56E0\u6B64\u81EA\u65CB\u9501\u7684\u7B49\u5F85\u65F6\u95F4\u662F\u6709\u9650\u5236\u7684\uFF0C\u9ED8\u8BA4\u60C5\u51B5\u4E0B\u4E3A10\u6B21\uFF0C\u5982\u679C\u5931\u8D25\uFF0C\u90A3\u4E48\u4F1A\u8FDB\u800C\u91C7\u7528\u91CD\u91CF\u7EA7\u9501\u673A\u5236\u3002</p><p><img src="'+t+'" alt="image-20220405200921538"></p><p>\u5728JDK6\u4E4B\u540E\uFF0C\u81EA\u65CB\u9501\u5F97\u5230\u4E86\u4E00\u6B21\u4F18\u5316\uFF0C\u81EA\u65CB\u7684\u6B21\u6570\u9650\u5236\u4E0D\u518D\u662F\u56FA\u5B9A\u7684\uFF0C\u800C\u662F\u81EA\u9002\u5E94\u53D8\u5316\u7684\uFF0C\u6BD4\u5982\u5728\u540C\u4E00\u4E2A\u9501\u5BF9\u8C61\u4E0A\uFF0C\u81EA\u65CB\u7B49\u5F85\u521A\u521A\u6210\u529F\u83B7\u5F97\u8FC7\u9501\uFF0C\u5E76\u4E14\u6301\u6709\u9501\u7684\u7EBF\u7A0B\u6B63\u5728\u8FD0\u884C\uFF0C\u90A3\u4E48\u8FD9\u6B21\u81EA\u65CB\u4E5F\u662F\u6709\u53EF\u80FD\u6210\u529F\u7684\uFF0C\u6240\u4EE5\u4F1A\u5141\u8BB8\u81EA\u65CB\u66F4\u591A\u6B21\u3002\u5F53\u7136\uFF0C\u5982\u679C\u67D0\u4E2A\u9501\u7ECF\u5E38\u90FD\u81EA\u65CB\u5931\u8D25\uFF0C\u90A3\u4E48\u6709\u53EF\u80FD\u4F1A\u4E0D\u518D\u91C7\u7528\u81EA\u65CB\u7B56\u7565\uFF0C\u800C\u662F\u76F4\u63A5\u4F7F\u7528\u91CD\u91CF\u7EA7\u9501\u3002</p><h5 id="\u8F7B\u91CF\u7EA7\u9501" tabindex="-1">\u8F7B\u91CF\u7EA7\u9501 <a class="header-anchor" href="#\u8F7B\u91CF\u7EA7\u9501" aria-hidden="true">#</a></h5><p>\u4ECEJDK 1.6\u5F00\u59CB\uFF0C\u4E3A\u4E86\u51CF\u5C11\u83B7\u5F97\u9501\u548C\u91CA\u653E\u9501\u5E26\u6765\u7684\u6027\u80FD\u6D88\u8017\uFF0C\u5C31\u5F15\u5165\u4E86\u8F7B\u91CF\u7EA7\u9501\u3002</p><p>\u8F7B\u91CF\u7EA7\u9501\u7684\u76EE\u6807\u662F\uFF0C\u5728\u65E0\u7ADE\u4E89\u60C5\u51B5\u4E0B\uFF0C\u51CF\u5C11\u91CD\u91CF\u7EA7\u9501\u4EA7\u751F\u7684\u6027\u80FD\u6D88\u8017\uFF08\u5E76\u4E0D\u662F\u4E3A\u4E86\u4EE3\u66FF\u91CD\u91CF\u7EA7\u9501\uFF0C\u5B9E\u9645\u4E0A\u5C31\u662F\u8D4C\u4E00\u624B\u540C\u4E00\u65F6\u95F4\u53EA\u6709\u4E00\u4E2A\u7EBF\u7A0B\u5728\u5360\u7528\u8D44\u6E90\uFF09\uFF0C\u5305\u62EC\u7CFB\u7EDF\u8C03\u7528\u5F15\u8D77\u7684\u5185\u6838\u6001\u4E0E\u7528\u6237\u6001\u5207\u6362\u3001\u7EBF\u7A0B\u963B\u585E\u9020\u6210\u7684\u7EBF\u7A0B\u5207\u6362\u7B49\u3002\u5B83\u4E0D\u50CF\u662F\u91CD\u91CF\u7EA7\u9501\u90A3\u6837\uFF0C\u9700\u8981\u5411\u64CD\u4F5C\u7CFB\u7EDF\u7533\u8BF7\u4E92\u65A5\u91CF\u3002\u5B83\u7684\u8FD0\u4F5C\u673A\u5236\u5982\u4E0B\uFF1A</p><p>\u5728\u5373\u5C06\u5F00\u59CB\u6267\u884C\u540C\u6B65\u4EE3\u7801\u5757\u4E2D\u7684\u5185\u5BB9\u65F6\uFF0C\u4F1A\u9996\u5148\u68C0\u67E5\u5BF9\u8C61\u7684Mark Word\uFF0C\u67E5\u770B\u9501\u5BF9\u8C61\u662F\u5426\u88AB\u5176\u4ED6\u7EBF\u7A0B\u5360\u7528\uFF0C\u5982\u679C\u6CA1\u6709\u4EFB\u4F55\u7EBF\u7A0B\u5360\u7528\uFF0C\u90A3\u4E48\u4F1A\u5728\u5F53\u524D\u7EBF\u7A0B\u4E2D\u6240\u5904\u7684\u6808\u5E27\u4E2D\u5EFA\u7ACB\u4E00\u4E2A\u540D\u4E3A\u9501\u8BB0\u5F55\uFF08Lock Record\uFF09\u7684\u7A7A\u95F4\uFF0C\u7528\u4E8E\u590D\u5236\u5E76\u5B58\u50A8\u5BF9\u8C61\u76EE\u524D\u7684Mark Word\u4FE1\u606F\uFF08\u5B98\u65B9\u79F0\u4E3ADisplaced Mark Word\uFF09\u3002</p><p>\u63A5\u7740\uFF0C\u865A\u62DF\u673A\u5C06\u4F7F\u7528CAS\u64CD\u4F5C\u5C06\u5BF9\u8C61\u7684Mark Word\u66F4\u65B0\u4E3A\u8F7B\u91CF\u7EA7\u9501\u72B6\u6001\uFF08\u6570\u636E\u7ED3\u6784\u53D8\u4E3A\u6307\u5411Lock Record\u7684\u6307\u9488\uFF0C\u6307\u5411\u7684\u662F\u5F53\u524D\u7684\u6808\u5E27\uFF09</p><blockquote><p>CAS\uFF08Compare And Swap\uFF09\u662F\u4E00\u79CD\u65E0\u9501\u7B97\u6CD5\uFF08\u6211\u4EEC\u4E4B\u524D\u5728Springboot\u9636\u6BB5\u5DF2\u7ECF\u8BB2\u89E3\u8FC7\u4E86\uFF09\uFF0C\u5B83\u5E76\u4E0D\u4F1A\u4E3A\u5BF9\u8C61\u52A0\u9501\uFF0C\u800C\u662F\u5728\u6267\u884C\u7684\u65F6\u5019\uFF0C\u770B\u770B\u5F53\u524D\u6570\u636E\u7684\u503C\u662F\u4E0D\u662F\u6211\u4EEC\u9884\u671F\u7684\u90A3\u6837\uFF0C\u5982\u679C\u662F\uFF0C\u90A3\u5C31\u6B63\u5E38\u8FDB\u884C\u66FF\u6362\uFF0C\u5982\u679C\u4E0D\u662F\uFF0C\u90A3\u4E48\u5C31\u66FF\u6362\u5931\u8D25\u3002\u6BD4\u5982\u6709\u4E24\u4E2A\u7EBF\u7A0B\u90FD\u9700\u8981\u4FEE\u6539\u53D8\u91CF<code>i</code>\u7684\u503C\uFF0C\u9ED8\u8BA4\u4E3A10\uFF0C\u73B0\u5728\u4E00\u4E2A\u7EBF\u7A0B\u8981\u5C06\u5176\u4FEE\u6539\u4E3A20\uFF0C\u53E6\u4E00\u4E2A\u8981\u4FEE\u6539\u4E3A30\uFF0C\u5982\u679C\u4ED6\u4EEC\u90FD\u4F7F\u7528CAS\u7B97\u6CD5\uFF0C\u90A3\u4E48\u5E76\u4E0D\u4F1A\u52A0\u9501\u8BBF\u95EE<code>i</code>\uFF0C\u800C\u662F\u76F4\u63A5\u5C1D\u8BD5\u4FEE\u6539<code>i</code>\u7684\u503C\uFF0C\u4F46\u662F\u5728\u4FEE\u6539\u65F6\uFF0C\u9700\u8981\u786E\u8BA4<code>i</code>\u662F\u4E0D\u662F10\uFF0C\u5982\u679C\u662F\uFF0C\u8868\u793A\u5176\u4ED6\u7EBF\u7A0B\u8FD8\u6CA1\u5BF9\u5176\u8FDB\u884C\u4FEE\u6539\uFF0C\u5982\u679C\u4E0D\u662F\uFF0C\u90A3\u4E48\u8BF4\u660E\u5176\u4ED6\u7EBF\u7A0B\u5DF2\u7ECF\u5C06\u5176\u4FEE\u6539\uFF0C\u6B64\u65F6\u4E0D\u80FD\u5B8C\u6210\u4FEE\u6539\u4EFB\u52A1\uFF0C\u4FEE\u6539\u5931\u8D25\u3002</p><p>\u5728CPU\u4E2D\uFF0CCAS\u64CD\u4F5C\u4F7F\u7528\u7684\u662F<code>cmpxchg</code>\u6307\u4EE4\uFF0C\u80FD\u591F\u4ECE\u6700\u5E95\u5C42\u786C\u4EF6\u5C42\u9762\u5F97\u5230\u6548\u7387\u7684\u63D0\u5347\u3002</p></blockquote><p>\u5982\u679CCAS\u64CD\u4F5C\u5931\u8D25\u4E86\u7684\u8BDD\uFF0C\u90A3\u4E48\u8BF4\u660E\u53EF\u80FD\u8FD9\u65F6\u6709\u7EBF\u7A0B\u5DF2\u7ECF\u8FDB\u5165\u8FD9\u4E2A\u540C\u6B65\u4EE3\u7801\u5757\u4E86\uFF0C\u8FD9\u65F6\u865A\u62DF\u673A\u4F1A\u518D\u6B21\u68C0\u67E5\u5BF9\u8C61\u7684Mark Word\uFF0C\u662F\u5426\u6307\u5411\u5F53\u524D\u7EBF\u7A0B\u7684\u6808\u5E27\uFF0C\u5982\u679C\u662F\uFF0C\u8BF4\u660E\u4E0D\u662F\u5176\u4ED6\u7EBF\u7A0B\uFF0C\u800C\u662F\u5F53\u524D\u7EBF\u7A0B\u5DF2\u7ECF\u6709\u4E86\u8FD9\u4E2A\u5BF9\u8C61\u7684\u9501\uFF0C\u76F4\u63A5\u653E\u5FC3\u5927\u80C6\u8FDB\u540C\u6B65\u4EE3\u7801\u5757\u5373\u53EF\u3002\u5982\u679C\u4E0D\u662F\uFF0C\u90A3\u786E\u5B9E\u662F\u88AB\u5176\u4ED6\u7EBF\u7A0B\u5360\u7528\u4E86\u3002</p><p>\u8FD9\u65F6\uFF0C\u8F7B\u91CF\u7EA7\u9501\u4E00\u5F00\u59CB\u7684\u60F3\u6CD5\u5C31\u662F\u9519\u7684\uFF08\u8FD9\u65F6\u6709\u5BF9\u8C61\u5728\u7ADE\u4E89\u8D44\u6E90\uFF0C\u5DF2\u7ECF\u8D4C\u8F93\u4E86\uFF09\uFF0C\u6240\u4EE5\u8BF4\u53EA\u80FD\u5C06\u9501\u81A8\u80C0\u4E3A\u91CD\u91CF\u7EA7\u9501\uFF0C\u6309\u7167\u91CD\u91CF\u7EA7\u9501\u7684\u64CD\u4F5C\u6267\u884C\uFF08\u6CE8\u610F\u9501\u7684\u81A8\u80C0\u662F\u4E0D\u53EF\u9006\u7684\uFF09</p><p><img src="'+c+'" alt="image-20220405201001305"></p><p>\u6240\u4EE5\uFF0C\u8F7B\u91CF\u7EA7\u9501 -&gt; \u5931\u8D25 -&gt; \u81EA\u9002\u5E94\u81EA\u65CB\u9501 -&gt; \u5931\u8D25 -&gt; \u91CD\u91CF\u7EA7\u9501</p><p>\u89E3\u9501\u8FC7\u7A0B\u540C\u6837\u91C7\u7528CAS\u7B97\u6CD5\uFF0C\u5982\u679C\u5BF9\u8C61\u7684MarkWord\u4ECD\u7136\u6307\u5411\u7EBF\u7A0B\u7684\u9501\u8BB0\u5F55\uFF0C\u90A3\u4E48\u5C31\u7528CAS\u64CD\u4F5C\u628A\u5BF9\u8C61\u7684MarkWord\u548C\u590D\u5236\u5230\u6808\u5E27\u4E2D\u7684Displaced Mark Word\u8FDB\u884C\u4EA4\u6362\u3002\u5982\u679C\u66FF\u6362\u5931\u8D25\uFF0C\u8BF4\u660E\u5176\u4ED6\u7EBF\u7A0B\u5C1D\u8BD5\u8FC7\u83B7\u53D6\u8BE5\u9501\uFF0C\u5728\u91CA\u653E\u9501\u7684\u540C\u65F6\uFF0C\u9700\u8981\u5524\u9192\u88AB\u6302\u8D77\u7684\u7EBF\u7A0B\u3002</p><h5 id="\u504F\u5411\u9501" tabindex="-1">\u504F\u5411\u9501 <a class="header-anchor" href="#\u504F\u5411\u9501" aria-hidden="true">#</a></h5><p>\u504F\u5411\u9501\u76F8\u6BD4\u8F7B\u91CF\u7EA7\u9501\u66F4\u7EAF\u7CB9\uFF0C\u5E72\u8106\u5C31\u628A\u6574\u4E2A\u540C\u6B65\u90FD\u6D88\u9664\u6389\uFF0C\u4E0D\u9700\u8981\u518D\u8FDB\u884CCAS\u64CD\u4F5C\u4E86\u3002\u5B83\u7684\u51FA\u73B0\u4E3B\u8981\u662F\u5F97\u76CA\u4E8E\u4EBA\u4EEC\u53D1\u73B0\u67D0\u4E9B\u60C5\u51B5\u4E0B\u67D0\u4E2A\u9501\u9891\u7E41\u5730\u88AB\u540C\u4E00\u4E2A\u7EBF\u7A0B\u83B7\u53D6\uFF0C\u8FD9\u79CD\u60C5\u51B5\u4E0B\uFF0C\u6211\u4EEC\u53EF\u4EE5\u5BF9\u8F7B\u91CF\u7EA7\u9501\u8FDB\u4E00\u6B65\u4F18\u5316\u3002</p><p>\u504F\u5411\u9501\u5B9E\u9645\u4E0A\u5C31\u662F\u4E13\u95E8\u4E3A\u5355\u4E2A\u7EBF\u7A0B\u800C\u751F\u7684\uFF0C\u5F53\u67D0\u4E2A\u7EBF\u7A0B\u7B2C\u4E00\u6B21\u83B7\u5F97\u9501\u65F6\uFF0C\u5982\u679C\u63A5\u4E0B\u6765\u90FD\u6CA1\u6709\u5176\u4ED6\u7EBF\u7A0B\u83B7\u53D6\u6B64\u9501\uFF0C\u90A3\u4E48\u6301\u6709\u9501\u7684\u7EBF\u7A0B\u5C06\u4E0D\u518D\u9700\u8981\u8FDB\u884C\u540C\u6B65\u64CD\u4F5C\u3002</p><p>\u53EF\u4EE5\u4ECE\u4E4B\u524D\u7684MarkWord\u7ED3\u6784\u4E2D\u770B\u5230\uFF0C\u504F\u5411\u9501\u4E5F\u4F1A\u901A\u8FC7CAS\u64CD\u4F5C\u8BB0\u5F55\u7EBF\u7A0B\u7684ID\uFF0C\u5982\u679C\u4E00\u76F4\u90FD\u662F\u540C\u4E00\u4E2A\u7EBF\u7A0B\u83B7\u53D6\u6B64\u9501\uFF0C\u90A3\u4E48\u5B8C\u5168\u6CA1\u6709\u5FC5\u8981\u5728\u8FDB\u884C\u989D\u5916\u7684CAS\u64CD\u4F5C\u3002\u5F53\u7136\uFF0C\u5982\u679C\u6709\u5176\u4ED6\u7EBF\u7A0B\u6765\u62A2\u4E86\uFF0C\u90A3\u4E48\u504F\u5411\u9501\u4F1A\u6839\u636E\u5F53\u524D\u72B6\u6001\uFF0C\u51B3\u5B9A\u662F\u5426\u8981\u6062\u590D\u5230\u672A\u9501\u5B9A\u6216\u662F\u81A8\u80C0\u4E3A\u8F7B\u91CF\u7EA7\u9501\u3002</p><p>\u5982\u679C\u6211\u4EEC\u9700\u8981\u4F7F\u7528\u504F\u5411\u9501\uFF0C\u53EF\u4EE5\u6DFB\u52A0<code>-XX:+UseBiased</code>\u53C2\u6570\u6765\u5F00\u542F\u3002</p><p>\u6240\u4EE5\uFF0C\u6700\u7EC8\u7684\u9501\u7B49\u7EA7\u4E3A\uFF1A\u672A\u9501\u5B9A &lt; \u504F\u5411\u9501 &lt; \u8F7B\u91CF\u7EA7\u9501 &lt; \u91CD\u91CF\u7EA7\u9501</p><p>\u503C\u5F97\u6CE8\u610F\u7684\u662F\uFF0C\u5982\u679C\u5BF9\u8C61\u901A\u8FC7\u8C03\u7528<code>hashCode()</code>\u65B9\u6CD5\u8BA1\u7B97\u8FC7\u5BF9\u8C61\u7684\u4E00\u81F4\u6027\u54C8\u5E0C\u503C\uFF0C\u90A3\u4E48\u5B83\u662F\u4E0D\u652F\u6301\u504F\u5411\u9501\u7684\uFF0C\u4F1A\u76F4\u63A5\u8FDB\u5165\u5230\u8F7B\u91CF\u7EA7\u9501\u72B6\u6001\uFF0C\u56E0\u4E3AHash\u662F\u9700\u8981\u88AB\u4FDD\u5B58\u7684\uFF0C\u800C\u504F\u5411\u9501\u7684Mark Word\u6570\u636E\u7ED3\u6784\uFF0C\u65E0\u6CD5\u4FDD\u5B58Hash\u503C\uFF1B\u5982\u679C\u5BF9\u8C61\u5DF2\u7ECF\u662F\u504F\u5411\u9501\u72B6\u6001\uFF0C\u518D\u53BB\u8C03\u7528<code>hashCode()</code>\u65B9\u6CD5\uFF0C\u90A3\u4E48\u4F1A\u76F4\u63A5\u5C06\u9501\u5347\u7EA7\u4E3A\u91CD\u91CF\u7EA7\u9501\uFF0C\u5E76\u5C06\u54C8\u5E0C\u503C\u5B58\u653E\u5728<code>monitor</code>\uFF08\u6709\u9884\u7559\u4F4D\u7F6E\u4FDD\u5B58\uFF09\u4E2D\u3002</p><p><img src="'+r+'" alt="image-20220405201028135"></p><h5 id="\u9501\u6D88\u9664-\u9501\u7C97\u5316" tabindex="-1">\u9501\u6D88\u9664&amp;\u9501\u7C97\u5316 <a class="header-anchor" href="#\u9501\u6D88\u9664-\u9501\u7C97\u5316" aria-hidden="true">#</a></h5><p>\u9501\u6D88\u9664\u548C\u9501\u7C97\u5316\u90FD\u662F\u5728\u8FD0\u884C\u65F6\u7684\u4E00\u4E9B\u4F18\u5316\u65B9\u6848\uFF0C\u6BD4\u5982\u6211\u4EEC\u67D0\u6BB5\u4EE3\u7801\u867D\u7136\u52A0\u4E86\u9501\uFF0C\u4F46\u662F\u5728\u8FD0\u884C\u65F6\u6839\u672C\u4E0D\u53EF\u80FD\u51FA\u73B0\u5404\u4E2A\u7EBF\u7A0B\u4E4B\u95F4\u8D44\u6E90\u4E89\u593A\u7684\u60C5\u51B5\uFF0C\u8FD9\u79CD\u60C5\u51B5\u4E0B\uFF0C\u5B8C\u5168\u4E0D\u9700\u8981\u4EFB\u4F55\u52A0\u9501\u673A\u5236\uFF0C\u6240\u4EE5\u9501\u4F1A\u88AB\u6D88\u9664\u3002\u9501\u7C97\u5316\u5219\u662F\u6211\u4EEC\u4EE3\u7801\u4E2D\u9891\u7E41\u5730\u51FA\u73B0\u4E92\u65A5\u540C\u6B65\u64CD\u4F5C\uFF0C\u6BD4\u5982\u5728\u4E00\u4E2A\u5FAA\u73AF\u5185\u90E8\u52A0\u9501\uFF0C\u8FD9\u6837\u660E\u663E\u662F\u975E\u5E38\u6D88\u8017\u6027\u80FD\u7684\uFF0C\u6240\u4EE5\u865A\u62DF\u673A\u4E00\u65E6\u68C0\u6D4B\u5230\u8FD9\u79CD\u64CD\u4F5C\uFF0C\u4F1A\u5C06\u6574\u4E2A\u540C\u6B65\u8303\u56F4\u8FDB\u884C\u6269\u5C55\u3002</p><h4 id="jmm\u5185\u5B58\u6A21\u578B" tabindex="-1">JMM\u5185\u5B58\u6A21\u578B <a class="header-anchor" href="#jmm\u5185\u5B58\u6A21\u578B" aria-hidden="true">#</a></h4><h5 id="java\u5185\u5B58\u6A21\u578B" tabindex="-1">Java\u5185\u5B58\u6A21\u578B <a class="header-anchor" href="#java\u5185\u5B58\u6A21\u578B" aria-hidden="true">#</a></h5><p><img src="'+D+`" alt="image-20220405200130691"></p><p>JMM\uFF08Java Memory Model\uFF09\u5185\u5B58\u6A21\u578B\u89C4\u5B9A\u5982\u4E0B\uFF1A</p><ul><li>\u6240\u6709\u7684\u53D8\u91CF\u5168\u90E8\u5B58\u50A8\u5728\u4E3B\u5185\u5B58\uFF08\u6CE8\u610F\u8FD9\u91CC\u5305\u62EC\u4E0B\u9762\u63D0\u5230\u7684\u53D8\u91CF\uFF0C\u6307\u7684\u90FD\u662F\u4F1A\u51FA\u73B0\u7ADE\u4E89\u7684\u53D8\u91CF\uFF0C\u5305\u62EC\u6210\u5458\u53D8\u91CF\u3001\u9759\u6001\u53D8\u91CF\u7B49\uFF0C\u800C\u5C40\u90E8\u53D8\u91CF\u8FD9\u79CD\u5C5E\u4E8E\u7EBF\u7A0B\u79C1\u6709\uFF0C\u4E0D\u5305\u62EC\u5728\u5185\uFF09</li><li>\u6BCF\u6761\u7EBF\u7A0B\u6709\u7740\u81EA\u5DF1\u7684\u5DE5\u4F5C\u5185\u5B58\uFF08\u53EF\u4EE5\u7C7B\u6BD4CPU\u7684\u9AD8\u901F\u7F13\u5B58\uFF09\u7EBF\u7A0B\u5BF9\u53D8\u91CF\u7684\u6240\u6709\u64CD\u4F5C\uFF0C\u5FC5\u987B\u5728\u5DE5\u4F5C\u5185\u5B58\u4E2D\u8FDB\u884C\uFF0C\u4E0D\u80FD\u76F4\u63A5\u64CD\u4F5C\u4E3B\u5185\u5B58\u4E2D\u7684\u6570\u636E\u3002</li><li>\u4E0D\u540C\u7EBF\u7A0B\u4E4B\u95F4\u7684\u5DE5\u4F5C\u5185\u5B58\u76F8\u4E92\u9694\u79BB\uFF0C\u5982\u679C\u9700\u8981\u5728\u7EBF\u7A0B\u4E4B\u95F4\u4F20\u9012\u5185\u5BB9\uFF0C\u53EA\u80FD\u901A\u8FC7\u4E3B\u5185\u5B58\u5B8C\u6210\uFF0C\u65E0\u6CD5\u76F4\u63A5\u8BBF\u95EE\u5BF9\u65B9\u7684\u5DE5\u4F5C\u5185\u5B58\u3002</li></ul><p>\u4E5F\u5C31\u662F\u8BF4\uFF0C\u6BCF\u4E00\u6761\u7EBF\u7A0B\u5982\u679C\u8981\u64CD\u4F5C\u4E3B\u5185\u5B58\u4E2D\u7684\u6570\u636E\uFF0C\u90A3\u4E48\u5F97\u5148\u62F7\u8D1D\u5230\u81EA\u5DF1\u7684\u5DE5\u4F5C\u5185\u5B58\u4E2D\uFF0C\u5E76\u5BF9\u5DE5\u4F5C\u5185\u5B58\u4E2D\u6570\u636E\u7684\u526F\u672C\u8FDB\u884C\u64CD\u4F5C\uFF0C\u64CD\u4F5C\u5B8C\u6210\u4E4B\u540E\uFF0C\u4E5F\u9700\u8981\u4ECE\u5DE5\u4F5C\u526F\u672C\u4E2D\u5C06\u7ED3\u679C\u62F7\u8D1D\u56DE\u4E3B\u5185\u5B58\u4E2D\uFF0C\u5177\u4F53\u7684\u64CD\u4F5C\u5C31\u662F<code>Save</code>\uFF08\u4FDD\u5B58\uFF09\u548C<code>Load</code>\uFF08\u52A0\u8F7D\uFF09\u64CD\u4F5C\u3002</p><p>\u5177\u4F53\u5B9E\u73B0\uFF1A</p><ul><li>\u4E3B\u5185\u5B58\uFF1A\u5BF9\u5E94\u5806\u4E2D\u5B58\u653E\u5BF9\u8C61\u7684\u5B9E\u4F8B\u7684\u90E8\u5206\u3002</li><li>\u5DE5\u4F5C\u5185\u5B58\uFF1A\u5BF9\u5E94\u7EBF\u7A0B\u7684\u865A\u62DF\u673A\u6808\u7684\u90E8\u5206\u533A\u57DF\uFF0C\u865A\u62DF\u673A\u53EF\u80FD\u4F1A\u5BF9\u8FD9\u90E8\u5206\u5185\u5B58\u8FDB\u884C\u4F18\u5316\uFF0C\u5C06\u5176\u653E\u5728CPU\u7684\u5BC4\u5B58\u5668\u6216\u662F\u9AD8\u901F\u7F13\u5B58\u4E2D\u3002\u6BD4\u5982\u5728\u8BBF\u95EE\u6570\u7EC4\u65F6\uFF0C\u7531\u4E8E\u6570\u7EC4\u662F\u4E00\u6BB5\u8FDE\u7EED\u7684\u5185\u5B58\u7A7A\u95F4\uFF0C\u6240\u4EE5\u53EF\u4EE5\u5C06\u4E00\u90E8\u5206\u8FDE\u7EED\u7A7A\u95F4\u653E\u5165\u5230CPU\u9AD8\u901F\u7F13\u5B58\u4E2D\uFF0C\u90A3\u4E48\u4E4B\u540E\u5982\u679C\u6211\u4EEC\u987A\u5E8F\u8BFB\u53D6\u8FD9\u4E2A\u6570\u7EC4\uFF0C\u90A3\u4E48\u5927\u6982\u7387\u4F1A\u76F4\u63A5\u7F13\u5B58\u547D\u4E2D\u3002</li></ul><h5 id="\u91CD\u6392\u5E8F" tabindex="-1">\u91CD\u6392\u5E8F <a class="header-anchor" href="#\u91CD\u6392\u5E8F" aria-hidden="true">#</a></h5><p>\u5728\u7F16\u8BD1\u6216\u6267\u884C\u65F6\uFF0C\u4E3A\u4E86\u4F18\u5316\u7A0B\u5E8F\u7684\u6267\u884C\u6548\u7387\uFF0C\u7F16\u8BD1\u5668\u6216\u5904\u7406\u5668\u5E38\u5E38\u4F1A\u5BF9\u6307\u4EE4\u8FDB\u884C\u91CD\u6392\u5E8F\uFF0C\u6709\u4EE5\u4E0B\u60C5\u51B5\uFF1A</p><ol><li>\u7F16\u8BD1\u5668\u91CD\u6392\u5E8F\uFF1AJava\u7F16\u8BD1\u5668\u901A\u8FC7\u5BF9Java\u4EE3\u7801\u8BED\u4E49\u7684\u7406\u89E3\uFF0C\u6839\u636E\u4F18\u5316\u89C4\u5219\u5BF9\u4EE3\u7801\u6307\u4EE4\u8FDB\u884C\u91CD\u6392\u5E8F\u3002</li><li>\u673A\u5668\u6307\u4EE4\u7EA7\u522B\u7684\u91CD\u6392\u5E8F\uFF1A\u73B0\u4EE3\u5904\u7406\u5668\u5F88\u9AD8\u7EA7\uFF0C\u80FD\u591F\u81EA\u4E3B\u5224\u65AD\u548C\u53D8\u66F4\u673A\u5668\u6307\u4EE4\u7684\u6267\u884C\u987A\u5E8F\u3002</li></ol><p>\u6307\u4EE4\u91CD\u6392\u5E8F\u80FD\u591F\u5728\u4E0D\u6539\u53D8\u7ED3\u679C\uFF08\u5355\u7EBF\u7A0B\uFF09\u7684\u60C5\u51B5\u4E0B\uFF0C\u4F18\u5316\u7A0B\u5E8F\u7684\u8FD0\u884C\u6548\u7387</p><h5 id="happens-before\u539F\u5219" tabindex="-1">happens-before\u539F\u5219 <a class="header-anchor" href="#happens-before\u539F\u5219" aria-hidden="true">#</a></h5><p>JMM\u63D0\u51FA\u4E86<code>happens-before</code>\uFF08\u5148\u884C\u53D1\u751F\uFF09\u539F\u5219\uFF0C\u5B9A\u4E49\u4E00\u4E9B\u7981\u6B62\u7F16\u8BD1\u4F18\u5316\u7684\u573A\u666F\uFF0C\u6765\u5411\u5404\u4F4D\u7A0B\u5E8F\u5458\u505A\u4E00\u4E9B\u4FDD\u8BC1\uFF0C\u53EA\u8981\u6211\u4EEC\u662F\u6309\u7167\u539F\u5219\u8FDB\u884C\u7F16\u7A0B\uFF0C\u90A3\u4E48\u5C31\u80FD\u591F\u4FDD\u6301\u5E76\u53D1\u7F16\u7A0B\u7684\u6B63\u786E\u6027\u3002\u5177\u4F53\u5982\u4E0B\uFF1A</p><ul><li>**\u7A0B\u5E8F\u6B21\u5E8F\u89C4\u5219\uFF1A**\u540C\u4E00\u4E2A\u7EBF\u7A0B\u4E2D\uFF0C\u6309\u7167\u7A0B\u5E8F\u7684\u987A\u5E8F\uFF0C\u524D\u9762\u7684\u64CD\u4F5Chappens-before\u540E\u7EED\u7684\u4EFB\u4F55\u64CD\u4F5C\u3002 <ul><li>\u540C\u4E00\u4E2A\u7EBF\u7A0B\u5185\uFF0C\u4EE3\u7801\u7684\u6267\u884C\u7ED3\u679C\u662F\u6709\u5E8F\u7684\u3002\u5176\u5B9E\u5C31\u662F\uFF0C\u53EF\u80FD\u4F1A\u53D1\u751F\u6307\u4EE4\u91CD\u6392\uFF0C\u4F46\u662F\u4FDD\u8BC1\u4EE3\u7801\u7684\u6267\u884C\u7ED3\u679C\u4E00\u5B9A\u662F\u548C\u6309\u7167\u987A\u5E8F\u6267\u884C\u5F97\u5230\u7684\u4E00\u81F4\uFF0C\u7A0B\u5E8F\u524D\u9762\u5BF9\u67D0\u4E00\u4E2A\u53D8\u91CF\u7684\u4FEE\u6539\u4E00\u5B9A\u5BF9\u540E\u7EED\u64CD\u4F5C\u53EF\u89C1\u7684\uFF0C\u4E0D\u53EF\u80FD\u4F1A\u51FA\u73B0\u524D\u9762\u624D\u628Aa\u4FEE\u6539\u4E3A1\uFF0C\u63A5\u7740\u8BFBa\u5C45\u7136\u662F\u4FEE\u6539\u524D\u7684\u7ED3\u679C\uFF0C\u8FD9\u4E5F\u662F\u7A0B\u5E8F\u8FD0\u884C\u6700\u57FA\u672C\u7684\u8981\u6C42\u3002</li></ul></li><li>**\u76D1\u89C6\u5668\u9501\u89C4\u5219\uFF1A**\u5BF9\u4E00\u4E2A\u9501\u7684\u89E3\u9501\u64CD\u4F5C\uFF0Chappens-before\u540E\u7EED\u5BF9\u8FD9\u4E2A\u9501\u7684\u52A0\u9501\u64CD\u4F5C\u3002 <ul><li>\u5C31\u662F\u65E0\u8BBA\u662F\u5728\u5355\u7EBF\u7A0B\u73AF\u5883\u8FD8\u662F\u591A\u7EBF\u7A0B\u73AF\u5883\uFF0C\u5BF9\u4E8E\u540C\u4E00\u4E2A\u9501\u6765\u8BF4\uFF0C\u4E00\u4E2A\u7EBF\u7A0B\u5BF9\u8FD9\u4E2A\u9501\u89E3\u9501\u4E4B\u540E\uFF0C\u53E6\u4E00\u4E2A\u7EBF\u7A0B\u83B7\u53D6\u4E86\u8FD9\u4E2A\u9501\u90FD\u80FD\u770B\u5230\u524D\u4E00\u4E2A\u7EBF\u7A0B\u7684\u64CD\u4F5C\u7ED3\u679C\u3002\u6BD4\u5982\u524D\u4E00\u4E2A\u7EBF\u7A0B\u5C06\u53D8\u91CF<code>x</code>\u7684\u503C\u4FEE\u6539\u4E3A\u4E86<code>12</code>\u5E76\u89E3\u9501\uFF0C\u4E4B\u540E\u53E6\u4E00\u4E2A\u7EBF\u7A0B\u62FF\u5230\u4E86\u8FD9\u628A\u9501\uFF0C\u5BF9\u4E4B\u524D\u7EBF\u7A0B\u7684\u64CD\u4F5C\u662F\u53EF\u89C1\u7684\uFF0C\u53EF\u4EE5\u5F97\u5230<code>x</code>\u662F\u524D\u4E00\u4E2A\u7EBF\u7A0B\u4FEE\u6539\u540E\u7684\u7ED3\u679C<code>12</code>\uFF08\u6240\u4EE5synchronized\u662F\u6709happens-before\u89C4\u5219\u7684\uFF09</li></ul></li><li>**volatile\u53D8\u91CF\u89C4\u5219\uFF1A**\u5BF9\u4E00\u4E2Avolatile\u53D8\u91CF\u7684\u5199\u64CD\u4F5Chappens-before\u540E\u7EED\u5BF9\u8FD9\u4E2A\u53D8\u91CF\u7684\u8BFB\u64CD\u4F5C\u3002 <ul><li>\u5C31\u662F\u5982\u679C\u4E00\u4E2A\u7EBF\u7A0B\u5148\u53BB\u5199\u4E00\u4E2A<code>volatile</code>\u53D8\u91CF\uFF0C\u7D27\u63A5\u7740\u53E6\u4E00\u4E2A\u7EBF\u7A0B\u53BB\u8BFB\u8FD9\u4E2A\u53D8\u91CF\uFF0C\u90A3\u4E48\u8FD9\u4E2A\u5199\u64CD\u4F5C\u7684\u7ED3\u679C\u4E00\u5B9A\u5BF9\u8BFB\u7684\u8FD9\u4E2A\u53D8\u91CF\u7684\u7EBF\u7A0B\u53EF\u89C1\u3002</li></ul></li><li>**\u7EBF\u7A0B\u542F\u52A8\u89C4\u5219\uFF1A**\u4E3B\u7EBF\u7A0BA\u542F\u52A8\u7EBF\u7A0BB\uFF0C\u7EBF\u7A0BB\u4E2D\u53EF\u4EE5\u770B\u5230\u4E3B\u7EBF\u7A0B\u542F\u52A8B\u4E4B\u524D\u7684\u64CD\u4F5C\u3002 <ul><li>\u5728\u4E3B\u7EBF\u7A0BA\u6267\u884C\u8FC7\u7A0B\u4E2D\uFF0C\u542F\u52A8\u5B50\u7EBF\u7A0BB\uFF0C\u90A3\u4E48\u7EBF\u7A0BA\u5728\u542F\u52A8\u5B50\u7EBF\u7A0BB\u4E4B\u524D\u5BF9\u5171\u4EAB\u53D8\u91CF\u7684\u4FEE\u6539\u7ED3\u679C\u5BF9\u7EBF\u7A0BB\u53EF\u89C1\u3002</li></ul></li><li>**\u7EBF\u7A0B\u52A0\u5165\u89C4\u5219\uFF1A**\u5982\u679C\u7EBF\u7A0BA\u6267\u884C\u64CD\u4F5C<code>join()</code>\u7EBF\u7A0BB\u5E76\u6210\u529F\u8FD4\u56DE\uFF0C\u90A3\u4E48\u7EBF\u7A0BB\u4E2D\u7684\u4EFB\u610F\u64CD\u4F5Chappens-before\u7EBF\u7A0BA<code>join()</code>\u64CD\u4F5C\u6210\u529F\u8FD4\u56DE\u3002</li><li>**\u4F20\u9012\u6027\u89C4\u5219\uFF1A**\u5982\u679CA happens-before B\uFF0CB happens-before C\uFF0C\u90A3\u4E48A happens-before C\u3002</li></ul><p>\u4ECEhappens-before\u539F\u5219\u7684\u89D2\u5EA6\uFF0C\u6765\u89E3\u91CA\u4E00\u4E0B\u4E0B\u9762\u7684\u7A0B\u5E8F\u7ED3\u679C\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Main</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> a </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  	</span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> b </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        a </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        b </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> a </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">if</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">b </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u6211\u4EEC\u5B9A\u4E49\u4EE5\u4E0A\u51FA\u73B0\u7684\u64CD\u4F5C\uFF1A</p><ul><li>**A\uFF1A**\u5C06\u53D8\u91CF<code>a</code>\u7684\u503C\u4FEE\u6539\u4E3A<code>10</code></li><li>**B\uFF1A**\u5C06\u53D8\u91CF<code>b</code>\u7684\u503C\u4FEE\u6539\u4E3A<code>a + 1</code></li><li>**C\uFF1A**\u4E3B\u7EBF\u7A0B\u542F\u52A8\u4E86\u4E00\u4E2A\u65B0\u7684\u7EBF\u7A0B\uFF0C\u5E76\u5728\u65B0\u7684\u7EBF\u7A0B\u4E2D\u83B7\u53D6<code>b</code>\uFF0C\u8FDB\u884C\u5224\u65AD\uFF0C\u5982\u679C\u5927\u4E8E<code>10</code>\u90A3\u4E48\u5C31\u6253\u5370<code>a</code></li></ul><p>\u6211\u4EEC\u6765\u5206\u6790\uFF0C\u7531\u4E8E\u662F\u540C\u4E00\u4E2A\u7EBF\u7A0B\uFF0C\u5E76\u4E14<strong>B</strong>\u662F\u4E00\u4E2A\u8D4B\u503C\u64CD\u4F5C\u4E14\u8BFB\u53D6\u4E86<strong>A</strong>\uFF0C\u90A3\u4E48\u6309\u7167<strong>\u7A0B\u5E8F\u6B21\u5E8F\u89C4\u5219</strong>\uFF0CA happens-before B\uFF0C\u63A5\u7740\u5728B\u4E4B\u540E\uFF0C\u9A6C\u4E0A\u6267\u884C\u4E86C\uFF0C\u6309\u7167<strong>\u7EBF\u7A0B\u542F\u52A8\u89C4\u5219</strong>\uFF0C\u5728\u65B0\u7684\u7EBF\u7A0B\u542F\u52A8\u4E4B\u524D\uFF0C\u5F53\u524D\u7EBF\u7A0B\u4E4B\u524D\u7684\u6240\u6709\u64CD\u4F5C\u5BF9\u65B0\u7684\u7EBF\u7A0B\u662F\u53EF\u89C1\u7684\uFF0C\u6240\u4EE5 B happens-before C\uFF0C\u6700\u540E\u6839\u636E<strong>\u4F20\u9012\u6027\u89C4\u5219</strong>\uFF0C\u7531\u4E8EA happens-before B\uFF0CB happens-before C\uFF0C\u6240\u4EE5A happens-before C\uFF0C\u56E0\u6B64\u5728\u65B0\u7684\u7EBF\u7A0B\u4E2D\u4F1A\u8F93\u51FA<code>a</code>\u4FEE\u6539\u540E\u7684\u7ED3\u679C<code>10</code>\u3002</p><h4 id="aba\u95EE\u9898\u53CA\u89E3\u51B3\u65B9\u6848" tabindex="-1">ABA\u95EE\u9898\u53CA\u89E3\u51B3\u65B9\u6848 <a class="header-anchor" href="#aba\u95EE\u9898\u53CA\u89E3\u51B3\u65B9\u6848" aria-hidden="true">#</a></h4><p><img src="`+y+`" alt="image-20220406101540742"></p><p>\u7EBF\u7A0B1\u548C\u7EBF\u7A0B2\u540C\u65F6\u5F00\u59CB\u5BF9<code>a</code>\u7684\u503C\u8FDB\u884CCAS\u4FEE\u6539\uFF0C\u4F46\u662F\u7EBF\u7A0B1\u7684\u901F\u5EA6\u6BD4\u8F83\u5FEB\uFF0C\u5C06a\u7684\u503C\u4FEE\u6539\u4E3A2\u4E4B\u540E\u7D27\u63A5\u7740\u53C8\u4FEE\u6539\u56DE1\uFF0C\u8FD9\u65F6\u7EBF\u7A0B2\u624D\u5F00\u59CB\u8FDB\u884C\u5224\u65AD\uFF0C\u53D1\u73B0a\u7684\u503C\u662F1\uFF0C\u6240\u4EE5CAS\u64CD\u4F5C\u6210\u529F\u3002</p><p>\u5F88\u660E\u663E\uFF0C\u8FD9\u91CC\u76841\u5DF2\u7ECF\u4E0D\u662F\u4E00\u5F00\u59CB\u7684\u90A3\u4E2A1\u4E86\uFF0C\u800C\u662F\u88AB\u91CD\u65B0\u8D4B\u503C\u76841\uFF0C\u8FD9\u4E5F\u662FCAS\u64CD\u4F5C\u5B58\u5728\u7684\u95EE\u9898\uFF08\u65E0\u9501\u867D\u597D\uFF0C\u4F46\u662F\u95EE\u9898\u591A\u591A\uFF09\uFF0C\u5B83\u53EA\u4F1A\u673A\u68B0\u5730\u6BD4\u8F83\u5F53\u524D\u503C\u662F\u4E0D\u662F\u9884\u671F\u503C\uFF0C\u4F46\u662F\u5E76\u4E0D\u4F1A\u5173\u5FC3\u5F53\u524D\u503C\u662F\u5426\u88AB\u4FEE\u6539\u8FC7\uFF0C\u8FD9\u79CD\u95EE\u9898\u79F0\u4E4B\u4E3A<code>ABA</code>\u95EE\u9898\u3002</p><h5 id="\u89E3\u51B3\u65B9\u6848" tabindex="-1">\u89E3\u51B3\u65B9\u6848 <a class="header-anchor" href="#\u89E3\u51B3\u65B9\u6848" aria-hidden="true">#</a></h5><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> a </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> b </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">World</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">AtomicStampedReference</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> reference </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">AtomicStampedReference</span><span style="color:#89DDFF;">&lt;&gt;(</span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//\u5728\u6784\u9020\u65F6\u9700\u8981\u6307\u5B9A\u521D\u59CB\u503C\u548C\u5BF9\u5E94\u7684\u7248\u672C\u53F7</span></span>
<span class="line"><span style="color:#A6ACCD;">    reference</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">attemptStamp</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u53EF\u4EE5\u4E2D\u9014\u5BF9\u7248\u672C\u53F7\u8FDB\u884C\u4FEE\u6539\uFF0C\u6CE8\u610F\u8981\u586B\u5199\u5F53\u524D\u7684\u5F15\u7528\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">reference</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">compareAndSet</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> b</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">));</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//CAS\u64CD\u4F5C\u65F6\u4E0D\u4EC5\u9700\u8981\u63D0\u4F9B\u9884\u671F\u503C\u548C\u4FEE\u6539\u503C\uFF0C\u8FD8\u8981\u63D0\u4F9B\u9884\u671F\u7248\u672C\u53F7\u548C\u65B0\u7684\u7248\u672C\u53F7</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="\u53EF\u91CD\u5165\u9501" tabindex="-1">\u53EF\u91CD\u5165\u9501 <a class="header-anchor" href="#\u53EF\u91CD\u5165\u9501" aria-hidden="true">#</a></h4><blockquote><p>\u540C\u4E00\u4E2A\u7EBF\u7A0B\uFF0C\u53EF\u4EE5\u53CD\u590D\u8FDB\u884C\u52A0\u9501\u64CD\u4F5C</p></blockquote><p><strong>ReentrantLock</strong>\u662F\u53EF\u91CD\u5165\u9501</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ReentrantLock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8FDE\u7EED\u52A0\u95012\u6B21</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u7EBF\u7A0B2\u60F3\u8981\u83B7\u53D6\u9501</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u7EBF\u7A0B2\u6210\u529F\u83B7\u53D6\u5230\u9501</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u7EBF\u7A0B1\u91CA\u653E\u4E86\u4E00\u6B21\u9501</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u7EBF\u7A0B1\u518D\u6B21\u91CA\u653E\u4E86\u4E00\u6B21\u9501</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//\u91CA\u653E\u4E24\u6B21\u540E\u5176\u4ED6\u7EBF\u7A0B\u624D\u80FD\u52A0\u9501</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u4E3B\u7EBF\u7A0B\u8FDE\u7EED\u8FDB\u884C\u4E86\u4E24\u6B21\u52A0\u9501\u64CD\u4F5C\uFF08\u6B64\u64CD\u4F5C\u662F\u4E0D\u4F1A\u88AB\u963B\u585E\u7684\uFF09\uFF0C\u5728\u5F53\u524D\u7EBF\u7A0B\u6301\u6709\u9501\u7684\u60C5\u51B5\u4E0B\u7EE7\u7EED\u52A0\u9501\u4E0D\u4F1A\u88AB\u963B\u585E\uFF0C\u5E76\u4E14\uFF0C\u52A0\u9501\u51E0\u6B21\uFF0C\u5C31\u5FC5\u987B\u8981\u89E3\u9501\u51E0\u6B21\uFF0C\u5426\u5219\u6B64\u7EBF\u7A0B\u4F9D\u65E7\u6301\u6709\u9501\u3002\u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528<code>getHoldCount()</code>\u65B9\u6CD5\u67E5\u770B\u5F53\u524D\u7EBF\u7A0B\u7684\u52A0\u9501\u6B21\u6570\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ReentrantLock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u5F53\u524D\u52A0\u9501\u6B21\u6570\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getHoldCount</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\uFF0C\u662F\u5426\u88AB\u9501\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isLocked</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u5F53\u524D\u52A0\u9501\u6B21\u6570\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getHoldCount</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\uFF0C\u662F\u5426\u88AB\u9501\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isLocked</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u5F53\u9501\u4E0D\u518D\u88AB\u4EFB\u4F55\u7EBF\u7A0B\u6301\u6709\u65F6\uFF0C\u503C\u4E3A\`0\`\uFF0C\u5E76\u4E14\u901A\u8FC7\`isLocked()\`\u65B9\u6CD5\u67E5\u8BE2\u7ED3\u679C\u4E3A\`false\`\u3002</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u5F53\u524D\u52A0\u9501\u6B21\u6570\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getHoldCount</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\uFF0C\u662F\u5426\u88AB\u9501\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isLocked</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5982\u679C\u5B58\u5728\u7EBF\u7A0B\u6301\u6709\u5F53\u524D\u7684\u9501\uFF0C\u90A3\u4E48\u5176\u4ED6\u7EBF\u7A0B\u5728\u83B7\u53D6\u9501\u65F6\uFF0C\u662F\u4F1A\u6682\u65F6\u8FDB\u5165\u5230\u7B49\u5F85\u961F\u5217\u7684\uFF0C\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7<code>getQueueLength()</code>\u65B9\u6CD5\u83B7\u53D6\u7B49\u5F85\u4E2D\u7EBF\u7A0B\u6570\u91CF\u7684\u9884\u4F30\u503C\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ReentrantLock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Thread</span><span style="color:#A6ACCD;"> t1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">::</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> t2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">::</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">);;</span></span>
<span class="line"><span style="color:#A6ACCD;">    t1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    t2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u5F53\u524D\u7B49\u5F85\u9501\u91CA\u653E\u7684\u7EBF\u7A0B\u6570\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getQueueLength</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u7EBF\u7A0B1\u662F\u5426\u5728\u7B49\u5F85\u961F\u5217\u4E2D\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">hasQueuedThread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t1</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u7EBF\u7A0B2\u662F\u5426\u5728\u7B49\u5F85\u961F\u5217\u4E2D\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">hasQueuedThread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t2</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u901A\u8FC7\`hasQueuedThread()\`\u65B9\u6CD5\u6765\u5224\u65AD\u67D0\u4E2A\u7EBF\u7A0B\u662F\u5426\u6B63\u5728\u7B49\u5F85\u83B7\u53D6\u9501\u72B6\u6001\u3002</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u5F53\u524D\u7EBF\u7A0B\u662F\u5426\u5728\u7B49\u5F85\u961F\u5217\u4E2D\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">hasQueuedThread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">()));</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><code>Condition</code>\u4E5F\u53EF\u4EE5\u8FDB\u884C\u5224\u65AD\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ReentrantLock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Condition</span><span style="color:#A6ACCD;"> condition </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newCondition</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            condition</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">printStackTrace</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u5F53\u524DCondition\u7684\u7B49\u5F85\u7EBF\u7A0B\u6570\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getWaitQueueLength</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">condition</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">    condition</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">signal</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u901A\u8FC7\u4F7F\u7528\`getWaitQueueLength()\`\u65B9\u6CD5\u80FD\u591F\u67E5\u770B\u540C\u4E00\u4E2ACondition\u76EE\u524D\u6709\u591A\u5C11\u7EBF\u7A0B\u5904\u4E8E\u7B49\u5F85\u72B6\u6001\u3002</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u5F53\u524DCondition\u7684\u7B49\u5F85\u7EBF\u7A0B\u6570\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getWaitQueueLength</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">condition</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="\u516C\u5E73\u9501\u4E0E\u975E\u516C\u5E73\u9501" tabindex="-1">\u516C\u5E73\u9501\u4E0E\u975E\u516C\u5E73\u9501 <a class="header-anchor" href="#\u516C\u5E73\u9501\u4E0E\u975E\u516C\u5E73\u9501" aria-hidden="true">#</a></h4><p>\u9501\u5206\u4E3A\u516C\u5E73\u9501\u548C\u975E\u516C\u5E73\u9501\uFF0C\u9ED8\u8BA4\u6211\u4EEC\u521B\u5EFA\u51FA\u6765\u7684ReentrantLock\u662F\u91C7\u7528\u7684\u975E\u516C\u5E73\u9501\u4F5C\u4E3A\u5E95\u5C42\u9501\u673A\u5236\u3002\u90A3\u4E48\u4EC0\u4E48\u662F\u516C\u5E73\u9501\u4EC0\u4E48\u53C8\u662F\u975E\u516C\u5E73\u9501\u5462\uFF1F</p><ul><li>\u516C\u5E73\u9501\uFF1A\u591A\u4E2A\u7EBF\u7A0B\u6309\u7167\u7533\u8BF7\u9501\u7684\u987A\u5E8F\u53BB\u83B7\u5F97\u9501\uFF0C\u7EBF\u7A0B\u4F1A\u76F4\u63A5\u8FDB\u5165\u961F\u5217\u53BB\u6392\u961F\uFF0C\u6C38\u8FDC\u90FD\u662F\u961F\u5217\u7684\u7B2C\u4E00\u4F4D\u624D\u80FD\u5F97\u5230\u9501\u3002</li><li>\u975E\u516C\u5E73\u9501\uFF1A\u591A\u4E2A\u7EBF\u7A0B\u53BB\u83B7\u53D6\u9501\u7684\u65F6\u5019\uFF0C\u4F1A\u76F4\u63A5\u53BB\u5C1D\u8BD5\u83B7\u53D6\uFF0C\u83B7\u53D6\u4E0D\u5230\uFF0C\u518D\u53BB\u8FDB\u5165\u7B49\u5F85\u961F\u5217\uFF0C\u5982\u679C\u80FD\u83B7\u53D6\u5230\uFF0C\u5C31\u76F4\u63A5\u83B7\u53D6\u5230\u9501\u3002</li></ul><p><strong>ReentrantLock</strong>\u53EF\u4EE5\u81EA\u5DF1\u6307\u5B9A\u516C\u5E73\u9501\u8FD8\u662F\u975E\u516C\u5E73\u9501</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ReentrantLock</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> fair</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// true-\u516C\u5E73\u9501  false-\u975E\u516C\u5E73\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">    sync </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> fair </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">FairSync</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">NonfairSync</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="\u6E90\u7801\u7BC7" tabindex="-1">\u6E90\u7801\u7BC7 <a class="header-anchor" href="#\u6E90\u7801\u7BC7" aria-hidden="true">#</a></h2><h4 id="volatile" tabindex="-1">volatile <a class="header-anchor" href="#volatile" aria-hidden="true">#</a></h4><h5 id="\u4FDD\u8BC1\u53D8\u91CF\u7684\u53EF\u89C1\u6027" tabindex="-1">\u4FDD\u8BC1\u53D8\u91CF\u7684\u53EF\u89C1\u6027 <a class="header-anchor" href="#\u4FDD\u8BC1\u53D8\u91CF\u7684\u53EF\u89C1\u6027" aria-hidden="true">#</a></h5><p>\u5F53\u5199\u4E00\u4E2A<code>volatile</code>\u53D8\u91CF\u65F6\uFF0CJMM\u4F1A\u628A\u8BE5\u7EBF\u7A0B\u672C\u5730\u5185\u5B58\u4E2D\u7684\u53D8\u91CF\u5F3A\u5236\u5237\u65B0\u5230\u4E3B\u5185\u5B58\u4E2D\u53BB\uFF0C\u5E76\u4E14\u8FD9\u4E2A\u5199\u64CD\u4F5C\u4F1A\u5BFC\u81F4\u5176\u4ED6\u7EBF\u7A0B\u4E2D\u7684<code>volatile</code>\u53D8\u91CF\u7F13\u5B58\u65E0\u6548\uFF0C\u8FD9\u6837\uFF0C\u53E6\u4E00\u4E2A\u7EBF\u7A0B\u4FEE\u6539\u4E86\u8FD9\u4E2A\u53D8\u65F6\uFF0C\u5F53\u524D\u7EBF\u7A0B\u4F1A\u7ACB\u5373\u5F97\u77E5\uFF0C\u5E76\u5C06\u5DE5\u4F5C\u5185\u5B58\u4E2D\u7684\u53D8\u91CF\u66F4\u65B0\u4E3A\u6700\u65B0\u7684\u7248\u672C\u3002</p><h5 id="\u7981\u6B62\u6307\u4EE4\u91CD\u6392" tabindex="-1">\u7981\u6B62\u6307\u4EE4\u91CD\u6392 <a class="header-anchor" href="#\u7981\u6B62\u6307\u4EE4\u91CD\u6392" aria-hidden="true">#</a></h5><p>\u7528volatile\u4FEE\u9970\u5171\u4EAB\u53D8\u91CF\uFF0C\u5728\u7F16\u8BD1\u65F6\uFF0C\u4F1A\u5728\u6307\u4EE4\u5E8F\u5217\u4E2D\u63D2\u5165<code>\u5185\u5B58\u5C4F\u969C</code>\u6765\u7981\u6B62\u7279\u5B9A\u7C7B\u578B\u7684\u5904\u7406\u5668\u91CD\u6392\u5E8F</p><blockquote><p>\u5185\u5B58\u5C4F\u969C\uFF08Memory Barrier\uFF09\u53C8\u79F0\u5185\u5B58\u6805\u680F\uFF0C\u662F\u4E00\u4E2ACPU\u6307\u4EE4\uFF0C\u5B83\u7684\u4F5C\u7528\u6709\u4E24\u4E2A\uFF1A</p><ol><li>\u4FDD\u8BC1\u7279\u5B9A\u64CD\u4F5C\u7684\u987A\u5E8F</li><li>\u4FDD\u8BC1\u67D0\u4E9B\u53D8\u91CF\u7684\u5185\u5B58\u53EF\u89C1\u6027\uFF08volatile\u7684\u5185\u5B58\u53EF\u89C1\u6027\uFF0C\u5176\u5B9E\u5C31\u662F\u4F9D\u9760\u8FD9\u4E2A\u5B9E\u73B0\u7684\uFF09</li></ol><p>\u7531\u4E8E\u7F16\u8BD1\u5668\u548C\u5904\u7406\u5668\u90FD\u80FD\u6267\u884C\u6307\u4EE4\u91CD\u6392\u7684\u4F18\u5316\uFF0C\u5982\u679C\u5728\u6307\u4EE4\u95F4\u63D2\u5165\u4E00\u6761Memory Barrier\u5219\u4F1A\u544A\u8BC9\u7F16\u8BD1\u5668\u548CCPU\uFF0C\u4E0D\u7BA1\u4EC0\u4E48\u6307\u4EE4\u90FD\u4E0D\u80FD\u548C\u8FD9\u6761Memory Barrier\u6307\u4EE4\u91CD\u6392\u5E8F\u3002</p><p><img src="`+A+`" alt="image-20220303172519404"></p><table><thead><tr><th>\u5C4F\u969C\u7C7B\u578B</th><th>\u6307\u4EE4\u793A\u4F8B</th><th>\u8BF4\u660E</th></tr></thead><tbody><tr><td>LoadLoad</td><td>Load1;LoadLoad;Load2</td><td>\u4FDD\u8BC1Load1\u7684\u8BFB\u53D6\u64CD\u4F5C\u5728Load2\u53CA\u540E\u7EED\u8BFB\u53D6\u64CD\u4F5C\u4E4B\u524D\u6267\u884C</td></tr><tr><td>StoreStore</td><td>Store1;StoreStore;Store2</td><td>\u5728Store2\u53CA\u5176\u540E\u7684\u5199\u64CD\u4F5C\u6267\u884C\u524D\uFF0C\u4FDD\u8BC1Store1\u7684\u5199\u64CD\u4F5C\u5DF2\u5237\u65B0\u5230\u4E3B\u5185\u5B58</td></tr><tr><td>LoadStore</td><td>Load1;LoadStore;Store2</td><td>\u5728Store2\u53CA\u5176\u540E\u7684\u5199\u64CD\u4F5C\u6267\u884C\u524D\uFF0C\u4FDD\u8BC1Load1\u7684\u8BFB\u64CD\u4F5C\u5DF2\u8BFB\u53D6\u7ED3\u675F</td></tr><tr><td>StoreLoad</td><td>Store1;StoreLoad;Load2</td><td>\u4FDD\u8BC1load1\u7684\u5199\u64CD\u4F5C\u5DF2\u5237\u65B0\u5230\u4E3B\u5185\u5B58\u4E4B\u540E\uFF0Cload2\u53CA\u5176\u540E\u7684\u8BFB\u64CD\u4F5C\u624D\u80FD\u6267\u884C</td></tr></tbody></table></blockquote><h4 id="synchronized" tabindex="-1">synchronized <a class="header-anchor" href="#synchronized" aria-hidden="true">#</a></h4><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">synchronized</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Main</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">//\u8FD9\u91CC\u4F7F\u7528\u7684\u662FMain\u7C7B\u7684Class\u5BF9\u8C61\u4F5C\u4E3A\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5B57\u8282\u7801\u7F16\u8BD1\uFF1A<img src="`+F+'" alt="image-20220302111724784"></p><p>\u5176\u4E2D\u6700\u5173\u952E\u7684\u5C31\u662F<code>monitorenter</code>\u6307\u4EE4\u4E86\uFF0C\u53EF\u4EE5\u770B\u5230\u4E4B\u540E\u4E5F\u6709<code>monitorexit</code>\u4E0E\u4E4B\u8FDB\u884C\u5339\u914D\uFF08\u6CE8\u610F\u8FD9\u91CC\u67092\u4E2A\uFF09\uFF0C<code>monitorenter</code>\u548C<code>monitorexit</code>\u5206\u522B\u5BF9\u5E94\u52A0\u9501\u548C\u91CA\u653E\u9501\uFF0C\u5728\u6267\u884C<code>monitorenter</code>\u4E4B\u524D\u9700\u8981\u5C1D\u8BD5\u83B7\u53D6\u9501\uFF0C\u6BCF\u4E2A\u5BF9\u8C61\u90FD\u6709\u4E00\u4E2A<code>monitor</code>\u76D1\u89C6\u5668\u4E0E\u4E4B\u5BF9\u5E94\uFF0C\u800C\u8FD9\u91CC\u6B63\u662F\u53BB\u83B7\u53D6\u5BF9\u8C61\u76D1\u89C6\u5668\u7684\u6240\u6709\u6743\uFF0C\u4E00\u65E6<code>monitor</code>\u6240\u6709\u6743\u88AB\u67D0\u4E2A\u7EBF\u7A0B\u6301\u6709\uFF0C\u90A3\u4E48\u5176\u4ED6\u7EBF\u7A0B\u5C06\u65E0\u6CD5\u83B7\u5F97\uFF08\u7BA1\u7A0B\u6A21\u578B\u7684\u4E00\u79CD\u5B9E\u73B0\uFF09\u3002</p><p>\u5728\u4EE3\u7801\u6267\u884C\u5B8C\u6210\u4E4B\u540E\uFF0C\u6211\u4EEC\u53EF\u4EE5\u770B\u5230\uFF0C\u4E00\u5171\u6709\u4E24\u4E2A<code>monitorexit</code>\u5728\u7B49\u7740\u6211\u4EEC\uFF0C\u90A3\u4E48\u4E3A\u4EC0\u4E48\u8FD9\u91CC\u4F1A\u6709\u4E24\u4E2A\u5462\uFF0C\u6309\u7406\u8BF4<code>monitorenter</code>\u548C<code>monitorexit</code>\u4E0D\u5E94\u8BE5\u4E00\u4E00\u5BF9\u5E94\u5417\uFF0C\u8FD9\u91CC\u4E3A\u4EC0\u4E48\u8981\u91CA\u653E\u9501\u4E24\u6B21\u5462\uFF1F</p><p>\u9996\u5148\u6211\u4EEC\u6765\u770B\u7B2C\u4E00\u4E2A\uFF0C\u8FD9\u91CC\u5728\u91CA\u653E\u9501\u4E4B\u540E\uFF0C\u4F1A\u9A6C\u4E0A\u8FDB\u5165\u5230\u4E00\u4E2Agoto\u6307\u4EE4\uFF0C\u8DF3\u8F6C\u523015\u884C\uFF0C\u800C\u6211\u4EEC\u768415\u884C\u5BF9\u5E94\u7684\u6307\u4EE4\u5C31\u662F\u65B9\u6CD5\u7684\u8FD4\u56DE\u6307\u4EE4\uFF0C\u5176\u5B9E\u6B63\u5E38\u60C5\u51B5\u4E0B\u53EA\u4F1A\u6267\u884C\u7B2C\u4E00\u4E2A<code>monitorexit</code>\u91CA\u653E\u9501\uFF0C\u5728\u91CA\u653E\u9501\u4E4B\u540E\u5C31\u63A5\u7740\u540C\u6B65\u4EE3\u7801\u5757\u540E\u9762\u7684\u5185\u5BB9\u7EE7\u7EED\u5411\u4E0B\u6267\u884C\u4E86\u3002\u800C\u7B2C\u4E8C\u4E2A\uFF0C\u5176\u5B9E\u662F\u7528\u6765\u5904\u7406\u5F02\u5E38\u7684\uFF0C\u53EF\u4EE5\u770B\u5230\uFF0C\u5B83\u7684\u4F4D\u7F6E\u662F\u572812\u884C\uFF0C\u5982\u679C\u7A0B\u5E8F\u8FD0\u884C\u53D1\u751F\u5F02\u5E38\uFF0C\u90A3\u4E48\u5C31\u4F1A\u6267\u884C\u7B2C\u4E8C\u4E2A<code>monitorexit</code>\uFF0C\u5E76\u4E14\u4F1A\u7EE7\u7EED\u5411\u4E0B\u901A\u8FC7<code>athrow</code>\u6307\u4EE4\u629B\u51FA\u5F02\u5E38\uFF0C\u800C\u4E0D\u662F\u76F4\u63A5\u8DF3\u8F6C\u523015\u884C\u6B63\u5E38\u8FD0\u884C\u4E0B\u53BB\u3002</p><p><img src="'+C+'" alt="image-20220302114613847"></p><p>\u5B9E\u9645\u4E0A<code>synchronized</code>\u4F7F\u7528\u7684\u9501\u5C31\u662F\u5B58\u50A8\u5728Java\u5BF9\u8C61\u5934\u4E2D\u7684\uFF0C\u6211\u4EEC\u77E5\u9053\uFF0C\u5BF9\u8C61\u662F\u5B58\u653E\u5728\u5806\u5185\u5B58\u4E2D\u7684\uFF0C\u800C\u6BCF\u4E2A\u5BF9\u8C61\u5185\u90E8\uFF0C\u90FD\u6709\u4E00\u90E8\u5206\u7A7A\u95F4\u7528\u4E8E\u5B58\u50A8\u5BF9\u8C61\u5934\u4FE1\u606F\uFF0C\u800C\u5BF9\u8C61\u5934\u4FE1\u606F\u4E2D\uFF0C\u5219\u5305\u542B\u4E86Mark Word\u7528\u4E8E\u5B58\u653E<code>hashCode</code>\u548C\u5BF9\u8C61\u7684\u9501\u4FE1\u606F\uFF0C\u5728\u4E0D\u540C\u72B6\u6001\u4E0B\uFF0C\u5B83\u5B58\u50A8\u7684\u6570\u636E\u7ED3\u6784\u6709\u4E00\u4E9B\u4E0D\u540C\u3002</p><p><img src="'+i+`" alt="image-20220302203846868"></p><h4 id="lock" tabindex="-1">Lock <a class="header-anchor" href="#lock" aria-hidden="true">#</a></h4><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">interface</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Lock</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u83B7\u53D6\u9501\uFF0C\u62FF\u4E0D\u5230\u9501\u4F1A\u963B\u585E\uFF0C\u7B49\u5F85\u5176\u4ED6\u7EBF\u7A0B\u91CA\u653E\u9501\uFF0C\u83B7\u53D6\u5230\u9501\u540E\u8FD4\u56DE</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u540C\u4E0A\uFF0C\u4F46\u662F\u7B49\u5F85\u8FC7\u7A0B\u4E2D\u4F1A\u54CD\u5E94\u4E2D\u65AD</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">lockInterruptibly</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u5C1D\u8BD5\u83B7\u53D6\u9501\uFF0C\u4F46\u662F\u4E0D\u4F1A\u963B\u585E\uFF0C\u5982\u679C\u80FD\u83B7\u53D6\u5230\u4F1A\u8FD4\u56DEtrue\uFF0C\u4E0D\u80FD\u8FD4\u56DEfalse</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryLock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u5C1D\u8BD5\u83B7\u53D6\u9501\uFF0C\u4F46\u662F\u53EF\u4EE5\u9650\u5B9A\u8D85\u65F6\u65F6\u95F4\uFF0C\u5982\u679C\u8D85\u51FA\u65F6\u95F4\u8FD8\u6CA1\u62FF\u5230\u9501\u8FD4\u56DEfalse\uFF0C\u5426\u5219\u8FD4\u56DEtrue\uFF0C\u53EF\u4EE5\u54CD\u5E94\u4E2D\u65AD</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryLock</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">time</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TimeUnit</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">unit</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u91CA\u653E\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u6682\u65F6\u53EF\u4EE5\u7406\u89E3\u4E3A\u66FF\u4EE3\u4F20\u7EDF\u7684Object\u7684wait()\u3001notify()\u7B49\u64CD\u4F5C\u7684\u5DE5\u5177</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Condition</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">newCondition</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="readwritelock" tabindex="-1">ReadWriteLock <a class="header-anchor" href="#readwritelock" aria-hidden="true">#</a></h4><p>\u9664\u4E86\u53EF\u91CD\u5165\u9501\u4E4B\u5916\uFF0C\u8FD8\u6709\u4E00\u79CD\u7C7B\u578B\u7684\u9501\u53EB\u505A\u8BFB\u5199\u9501\uFF0C\u5F53\u7136\u5B83\u5E76\u4E0D\u662F\u4E13\u95E8\u7528\u4F5C\u8BFB\u5199\u64CD\u4F5C\u7684\u9501\uFF0C\u5B83\u548C\u53EF\u91CD\u5165\u9501\u4E0D\u540C\u7684\u5730\u65B9\u5728\u4E8E\uFF0C\u53EF\u91CD\u5165\u9501\u662F\u4E00\u79CD\u6392\u4ED6\u9501\uFF0C\u5F53\u4E00\u4E2A\u7EBF\u7A0B\u5F97\u5230\u9501\u4E4B\u540E\uFF0C\u53E6\u4E00\u4E2A\u7EBF\u7A0B\u5FC5\u987B\u7B49\u5F85\u5176\u91CA\u653E\u9501\uFF0C\u5426\u5219\u4E00\u5F8B\u4E0D\u5141\u8BB8\u83B7\u53D6\u5230\u9501\u3002\u800C\u8BFB\u5199\u9501\u5728\u540C\u4E00\u65F6\u95F4\uFF0C\u662F\u53EF\u4EE5\u8BA9\u591A\u4E2A\u7EBF\u7A0B\u83B7\u53D6\u5230\u9501\u7684\uFF0C\u5B83\u5176\u5B9E\u5C31\u662F\u9488\u5BF9\u4E8E\u8BFB\u5199\u573A\u666F\u800C\u51FA\u73B0\u7684\u3002\u8BFB\u5199\u9501\u7EF4\u62A4\u4E86\u4E00\u4E2A\u8BFB\u9501\u548C\u4E00\u4E2A\u5199\u9501\uFF0C\u8FD9\u4E24\u4E2A\u9501\u7684\u673A\u5236\u662F\u4E0D\u540C\u7684\u3002</p><ul><li>\u8BFB\u9501\uFF1A\u5728\u6CA1\u6709\u4EFB\u4F55\u7EBF\u7A0B\u5360\u7528\u5199\u9501\u7684\u60C5\u51B5\u4E0B\uFF0C\u540C\u4E00\u65F6\u95F4\u53EF\u4EE5\u6709\u591A\u4E2A\u7EBF\u7A0B\u52A0\u8BFB\u9501\u3002</li><li>\u5199\u9501\uFF1A\u5728\u6CA1\u6709\u4EFB\u4F55\u7EBF\u7A0B\u5360\u7528\u8BFB\u9501\u7684\u60C5\u51B5\u4E0B\uFF0C\u540C\u4E00\u65F6\u95F4\u53EA\u80FD\u6709\u4E00\u4E2A\u7EBF\u7A0B\u52A0\u5199\u9501\u3002</li></ul><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">interface</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ReadWriteLock</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u83B7\u53D6\u8BFB\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Lock</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">readLock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">// \u83B7\u53D6\u5199\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Lock</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">writeLock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u6B64\u63A5\u53E3\u6709\u4E00\u4E2A\u5B9E\u73B0\u7C7BReentrantReadWriteLock\uFF08\u5B9E\u73B0\u7684\u662FReadWriteLock\u63A5\u53E3\uFF0C\u4E0D\u662FLock\u63A5\u53E3\uFF0C\u5B83\u672C\u8EAB\u5E76\u4E0D\u662F\u9501\uFF09\uFF0C\u6CE8\u610F\u6211\u4EEC\u64CD\u4F5CReentrantReadWriteLock\u65F6\uFF0C\u4E0D\u80FD\u76F4\u63A5\u4E0A\u9501\uFF0C\u800C\u662F\u9700\u8981\u83B7\u53D6\u8BFB\u9501\u6216\u662F\u5199\u9501\uFF0C\u518D\u8FDB\u884C\u9501\u64CD\u4F5C\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ReentrantReadWriteLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ReentrantReadWriteLock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readLock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readLock</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;">::</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u8FD9\u91CC\u6211\u4EEC\u5BF9\u8BFB\u9501\u52A0\u9501\uFF0C\u53EF\u4EE5\u770B\u5230\u53EF\u4EE5\u591A\u4E2A\u7EBF\u7A0B\u540C\u65F6\u5BF9\u8BFB\u9501\u52A0\u9501\u3002</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ReentrantReadWriteLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ReentrantReadWriteLock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readLock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeLock</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;">::</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u6709\u8BFB\u9501\u72B6\u6001\u4E0B\u65E0\u6CD5\u52A0\u5199\u9501\uFF0C\u53CD\u4E4B\u4EA6\u7136\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ReentrantReadWriteLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ReentrantReadWriteLock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeLock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readLock</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;">::</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>ReentrantReadWriteLock\u4E0D\u4EC5\u5177\u6709\u8BFB\u5199\u9501\u7684\u529F\u80FD\uFF0C\u8FD8\u4FDD\u7559\u4E86\u53EF\u91CD\u5165\u9501\u548C\u516C\u5E73/\u975E\u516C\u5E73\u673A\u5236\uFF0C\u540C\u4E00\u4E2A\u7EBF\u7A0B\u53EF\u4EE5\u91CD\u590D\u4E3A\u5199\u9501\u52A0\u9501\uFF0C\u5E76\u4E14\u5FC5\u987B\u5168\u90E8\u89E3\u9501\u624D\u771F\u6B63\u91CA\u653E\u9501\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ReentrantReadWriteLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ReentrantReadWriteLock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeLock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeLock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeLock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u6210\u529F\u83B7\u53D6\u5230\u5199\u9501\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u91CA\u653E\u7B2C\u4E00\u5C42\u9501\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeLock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u91CA\u653E\u7B2C\u4E8C\u5C42\u9501\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeLock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u901A\u8FC7\u4E4B\u524D\u7684\u4F8B\u5B50\u6765\u9A8C\u8BC1\u516C\u5E73\u548C\u975E\u516C\u5E73\uFF1A\u53EF\u4EE5\u770B\u5230\uFF0C\u7ED3\u679C\u662F\u4E00\u81F4\u7684\u3002</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ReentrantReadWriteLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ReentrantReadWriteLock</span><span style="color:#89DDFF;">(true);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> action </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u7EBF\u7A0B </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getName</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> \u5C06\u57281\u79D2\u540E\u5F00\u59CB\u83B7\u53D6\u9501...</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeLock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u7EBF\u7A0B </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getName</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> \u6210\u529F\u83B7\u53D6\u9501\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeLock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5EFA\u7ACB10\u4E2A\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">action</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">T</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="\u5199\u9501\u964D\u7EA7" tabindex="-1">\u5199\u9501\u964D\u7EA7 <a class="header-anchor" href="#\u5199\u9501\u964D\u7EA7" aria-hidden="true">#</a></h5><p>\u5199\u9501\u964D\u7EA7\u4E3A\u8BFB\u9501</p><p>\u5F53\u4E00\u4E2A\u7EBF\u7A0B\u6301\u6709\u5199\u9501\u7684\u60C5\u51B5\u4E0B\uFF0C\u867D\u7136\u5176\u4ED6\u7EBF\u7A0B\u4E0D\u80FD\u52A0\u8BFB\u9501\uFF0C\u4F46\u662F\u7EBF\u7A0B\u81EA\u5DF1\u662F\u53EF\u4EE5\u52A0\u8BFB\u9501\u7684\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ReentrantReadWriteLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ReentrantReadWriteLock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeLock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readLock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u6210\u529F\u52A0\u8BFB\u9501\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5728\u540C\u65F6\u52A0\u4E86\u5199\u9501\u548C\u8BFB\u9501\u7684\u60C5\u51B5\u4E0B\uFF0C\u91CA\u653E\u5199\u9501\uFF0C\u662F\u5426\u5176\u4ED6\u7684\u7EBF\u7A0B\u5C31\u53EF\u4EE5\u4E00\u8D77\u52A0\u8BFB\u9501\u4E86\u5462\uFF1F</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ReentrantReadWriteLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ReentrantReadWriteLock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeLock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readLock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u5F00\u59CB\u52A0\u8BFB\u9501\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readLock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u8BFB\u9501\u6DFB\u52A0\u6210\u529F\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeLock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5982\u679C\u91CA\u653E\u5199\u9501\uFF0C\u4F1A\u600E\u4E48\u6837\uFF1F</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u4E00\u65E6\u5199\u9501\u88AB\u91CA\u653E\uFF0C\u90A3\u4E48\u4E3B\u7EBF\u7A0B\u5C31\u53EA\u5269\u4E0B\u8BFB\u9501\u4E86\uFF0C\u56E0\u4E3A\u8BFB\u9501\u53EF\u4EE5\u88AB\u591A\u4E2A\u7EBF\u7A0B\u5171\u4EAB\uFF0C\u6240\u4EE5\u8FD9\u65F6\u7B2C\u4E8C\u4E2A\u7EBF\u7A0B\u4E5F\u6DFB\u52A0\u4E86\u8BFB\u9501\u3002\u800C\u8FD9\u79CD\u64CD\u4F5C\uFF0C\u5C31\u88AB\u79F0\u4E4B\u4E3A&quot;\u9501\u964D\u7EA7&quot;\uFF08\u6CE8\u610F\u4E0D\u662F\u5148\u91CA\u653E\u5199\u9501\u518D\u52A0\u8BFB\u9501\uFF0C\u800C\u662F\u6301\u6709\u5199\u9501\u7684\u60C5\u51B5\u4E0B\u7533\u8BF7\u8BFB\u9501\u518D\u91CA\u653E\u5199\u9501\uFF09</p><h5 id="\u8BFB\u9501\u5347\u7EA7" tabindex="-1">\u8BFB\u9501\u5347\u7EA7 <a class="header-anchor" href="#\u8BFB\u9501\u5347\u7EA7" aria-hidden="true">#</a></h5><p>\u5728\u4EC5\u6301\u6709\u8BFB\u9501\u7684\u60C5\u51B5\u4E0B\u53BB\u7533\u8BF7\u5199\u9501\uFF0C\u5C5E\u4E8E&quot;\u9501\u5347\u7EA7&quot;\uFF0C<strong>ReentrantReadWriteLock\u662F\u4E0D\u652F\u6301\u7684</strong></p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ReentrantReadWriteLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ReentrantReadWriteLock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readLock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u7EBF\u7A0B\u76F4\u63A5\u5361\u5728\u52A0\u5199\u9501\u8FD9\u91CC</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeLock</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u9501\u5347\u7EA7\u6210\u529F\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="condition" tabindex="-1">Condition <a class="header-anchor" href="#condition" aria-hidden="true">#</a></h4><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">interface</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Condition</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u4E0E\u8C03\u7528\u9501\u5BF9\u8C61\u7684wait\u65B9\u6CD5\u4E00\u6837\uFF0C\u4F1A\u8FDB\u5165\u5230\u7B49\u5F85\u72B6\u6001\uFF0C\u4F46\u662F\u8FD9\u91CC\u9700\u8981\u8C03\u7528Condition\u7684signal\u6216signalAll\u65B9\u6CD5\u8FDB\u884C\u5524\u9192</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//\u611F\u89C9\u5C31\u662F\u548C\u666E\u901A\u5BF9\u8C61\u7684wait\u548Cnotify\u662F\u5BF9\u5E94\u7684 \u540C\u65F6\uFF0C\u7B49\u5F85\u72B6\u6001\u4E0B\u662F\u53EF\u4EE5\u54CD\u5E94\u4E2D\u65AD\u7684</span></span>
<span class="line"><span style="color:#A6ACCD;"> 	</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u540C\u4E0A\uFF0C\u4F46\u4E0D\u54CD\u5E94\u4E2D\u65AD\uFF08\u770B\u540D\u5B57\u90FD\u80FD\u731C\u5230\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">  	</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">awaitUninterruptibly</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u7B49\u5F85\u6307\u5B9A\u65F6\u95F4\uFF0C\u5982\u679C\u5728\u6307\u5B9A\u65F6\u95F4\uFF08\u7EB3\u79D2\uFF09\u5185\u88AB\u5524\u9192\uFF0C\u4F1A\u8FD4\u56DE\u5269\u4F59\u65F6\u95F4\uFF0C\u5982\u679C\u8D85\u65F6\uFF0C\u4F1A\u8FD4\u56DE0\u6216\u8D1F\u6570\uFF0C\u53EF\u4EE5\u54CD\u5E94\u4E2D\u65AD</span></span>
<span class="line"><span style="color:#A6ACCD;">  	</span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">awaitNanos</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">nanosTimeout</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u7B49\u5F85\u6307\u5B9A\u65F6\u95F4\uFF08\u53EF\u4EE5\u6307\u5B9A\u65F6\u95F4\u5355\u4F4D\uFF09\uFF0C\u5982\u679C\u7B49\u5F85\u65F6\u95F4\u5185\u88AB\u5524\u9192\uFF0C\u8FD4\u56DEtrue\uFF0C\u5426\u5219\u8FD4\u56DEfalse\uFF0C\u53EF\u4EE5\u54CD\u5E94\u4E2D\u65AD</span></span>
<span class="line"><span style="color:#A6ACCD;">  	</span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">time</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TimeUnit</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">unit</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u53EF\u4EE5\u6307\u5B9A\u4E00\u4E2A\u660E\u786E\u7684\u65F6\u95F4\u70B9\uFF0C\u5982\u679C\u5728\u65F6\u95F4\u70B9\u4E4B\u524D\u88AB\u5524\u9192\uFF0C\u8FD4\u56DEtrue\uFF0C\u5426\u5219\u8FD4\u56DEfalse\uFF0C\u53EF\u4EE5\u54CD\u5E94\u4E2D\u65AD</span></span>
<span class="line"><span style="color:#A6ACCD;">  	</span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">awaitUntil</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Date</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">deadline</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u5524\u9192\u4E00\u4E2A\u5904\u4E8E\u7B49\u5F85\u72B6\u6001\u7684\u7EBF\u7A0B\uFF0C\u6CE8\u610F\u8FD8\u5F97\u83B7\u5F97\u9501\u624D\u80FD\u63A5\u7740\u8FD0\u884C</span></span>
<span class="line"><span style="color:#A6ACCD;">  	</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">signal</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u540C\u4E0A\uFF0C\u4F46\u662F\u662F\u5524\u9192\u6240\u6709\u7B49\u5F85\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">  	</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">signalAll</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="\u5E95\u5C42\u5B9E\u73B0" tabindex="-1">\u5E95\u5C42\u5B9E\u73B0 <a class="header-anchor" href="#\u5E95\u5C42\u5B9E\u73B0" aria-hidden="true">#</a></h5><p>\u5728AQS\u4E2D\uFF0CCondition\u6709\u4E00\u4E2A\u5B9E\u73B0\u7C7BConditionObject\uFF0C\u800C\u8FD9\u91CC\u4E5F\u662F\u4F7F\u7528\u4E86\u94FE\u8868\u5B9E\u73B0\u4E86\u6761\u4EF6\u961F\u5217\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ConditionObject</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">implements</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Condition</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> java.io.</span><span style="color:#FFCB6B;">Serializable</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> serialVersionUID </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1173984872572414699L</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;">    /** \u6761\u4EF6\u961F\u5217\u7684\u5934\u7ED3\u70B9 */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">transient</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> firstWaiter</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;">    /** \u6761\u4EF6\u961F\u5217\u7684\u5C3E\u7ED3\u70B9 */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">transient</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> lastWaiter</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//...</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u8FD9\u91CC\u662F\u76F4\u63A5\u4F7F\u7528\u4E86AQS\u4E2D\u7684Node\u7C7B\uFF0C\u4F46\u662F\u4F7F\u7528\u7684\u662FNode\u7C7B\u4E2D\u7684nextWaiter\u5B57\u6BB5\u8FDE\u63A5\u8282\u70B9\uFF0C\u5E76\u4E14Node\u7684status\u4E3ACONDITION\uFF1A</p><p><img src="`+u+`" alt="image-20220307115850295"></p><p>\u6211\u4EEC\u77E5\u9053\uFF0C\u5F53\u4E00\u4E2A\u7EBF\u7A0B\u8C03\u7528<code>await()</code>\u65B9\u6CD5\u65F6\uFF0C\u4F1A\u8FDB\u5165\u7B49\u5F85\u72B6\u6001\uFF0C\u76F4\u5230\u5176\u4ED6\u7EBF\u7A0B\u8C03\u7528<code>signal()</code>\u65B9\u6CD5\u5C06\u5176\u5524\u9192\uFF0C\u800C\u8FD9\u91CC\u7684\u6761\u4EF6\u961F\u5217\uFF0C\u6B63\u662F\u7528\u4E8E\u5B58\u50A8\u8FD9\u4E9B\u5904\u4E8E\u7B49\u5F85\u72B6\u6001\u7684\u7EBF\u7A0B\u3002</p><p>\u6211\u4EEC\u5148\u6765\u770B\u770B\u6700\u5173\u952E\u7684<code>await()</code>\u65B9\u6CD5\u662F\u5982\u4F55\u5B9E\u73B0\u7684\uFF0C\u4E3A\u4E86\u9632\u6B62\u4E00\u4F1A\u7ED5\u6655\uFF0C\u5728\u5F00\u59CB\u4E4B\u524D\uFF0C\u6211\u4EEC\u5148\u660E\u786E\u6B64\u65B9\u6CD5\u7684\u76EE\u6807\uFF1A</p><ul><li>\u53EA\u6709\u5DF2\u7ECF\u6301\u6709\u9501\u7684\u7EBF\u7A0B\u624D\u53EF\u4EE5\u4F7F\u7528\u6B64\u65B9\u6CD5</li><li>\u5F53\u8C03\u7528\u6B64\u65B9\u6CD5\u540E\uFF0C\u4F1A\u76F4\u63A5\u91CA\u653E\u9501\uFF0C\u65E0\u8BBA\u52A0\u4E86\u591A\u5C11\u6B21\u9501</li><li>\u53EA\u6709\u5176\u4ED6\u7EBF\u7A0B\u8C03\u7528<code>signal()</code>\u6216\u662F\u88AB\u4E2D\u65AD\u65F6\u624D\u4F1A\u5524\u9192\u7B49\u5F85\u4E2D\u7684\u7EBF\u7A0B</li><li>\u88AB\u5524\u9192\u540E\uFF0C\u9700\u8981\u7B49\u5F85\u5176\u4ED6\u7EBF\u7A0B\u91CA\u653E\u9501\uFF0C\u62FF\u5230\u9501\u4E4B\u540E\u624D\u53EF\u4EE5\u7EE7\u7EED\u6267\u884C\uFF0C\u5E76\u4E14\u4F1A\u6062\u590D\u5230\u4E4B\u524D\u7684\u72B6\u6001\uFF08await\u4E4B\u524D\u52A0\u4E86\u51E0\u5C42\u9501\u5524\u9192\u540E\u4F9D\u7136\u662F\u51E0\u5C42\u9501\uFF09</li></ul><p>\u6E90\u7801\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">interrupted</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">InterruptedException</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u5728\u8C03\u7528await\u4E4B\u524D\u5C31\u88AB\u6DFB\u52A0\u4E86\u4E2D\u65AD\u6807\u8BB0\uFF0C\u90A3\u4E48\u4F1A\u76F4\u63A5\u629B\u51FA\u4E2D\u65AD\u5F02\u5E38</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> node </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">addConditionWaiter</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u4E3A\u5F53\u524D\u7EBF\u7A0B\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684\u8282\u70B9\uFF0C\u5E76\u5C06\u5176\u52A0\u5165\u5230\u6761\u4EF6\u961F\u5217\u4E2D</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> savedState </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">fullyRelease</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5B8C\u5168\u91CA\u653E\u5F53\u524D\u7EBF\u7A0B\u6301\u6709\u7684\u9501\uFF0C\u5E76\u4E14\u4FDD\u5B58\u4E00\u4E0Bstate\u503C\uFF0C\u56E0\u4E3A\u5524\u9192\u4E4B\u540E\u8FD8\u5F97\u6062\u590D</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> interruptMode </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">//\u7528\u4E8E\u4FDD\u5B58\u4E2D\u65AD\u72B6\u6001</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#82AAFF;">isOnSyncQueue</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5FAA\u73AF\u5224\u65AD\u662F\u5426\u4F4D\u4E8E\u540C\u6B65\u961F\u5217\u4E2D\uFF0C\u5982\u679C\u7B49\u5F85\u72B6\u6001\u4E0B\u7684\u7EBF\u7A0B\u88AB\u5176\u4ED6\u7EBF\u7A0B\u5524\u9192\uFF0C\u90A3\u4E48\u4F1A\u6B63\u5E38\u8FDB\u5165\u5230AQS\u7684\u7B49\u5F85\u961F\u5217\u4E2D\uFF08\u4E4B\u540E\u6211\u4EEC\u4F1A\u8BB2\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">        LockSupport</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">park</span><span style="color:#89DDFF;">(this);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u4F9D\u7136\u5904\u4E8E\u7B49\u5F85\u72B6\u6001\uFF0C\u90A3\u4E48\u7EE7\u7EED\u6302\u8D77</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">interruptMode </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">checkInterruptWhileWaiting</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u770B\u770B\u7B49\u5F85\u7684\u65F6\u5019\u662F\u4E0D\u662F\u88AB\u4E2D\u65AD\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u51FA\u4E86\u5FAA\u73AF\u4E4B\u540E\uFF0C\u90A3\u7EBF\u7A0B\u80AF\u5B9A\u662F\u5DF2\u7ECF\u9192\u4E86\uFF0C\u8FD9\u65F6\u5C31\u5DEE\u62FF\u5230\u9501\u5C31\u53EF\u4EE5\u6062\u590D\u8FD0\u884C\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">acquireQueued</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> savedState</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> interruptMode </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> THROW_IE</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//\u76F4\u63A5\u5F00\u59CBacquireQueued\u5C1D\u8BD5\u62FF\u9501\uFF08\u4E4B\u524D\u5DF2\u7ECF\u8BB2\u8FC7\u4E86\uFF09\u4ECE\u8FD9\u91CC\u5F00\u59CB\u57FA\u672C\u5C31\u548C\u4E00\u4E2A\u7EBF\u7A0B\u53BB\u62A2\u9501\u662F\u4E00\u6837\u7684\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">        interruptMode </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> REINTERRUPT</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u5DF2\u7ECF\u62FF\u5230\u9501\u4E86\uFF0C\u57FA\u672C\u53EF\u4EE5\u5F00\u59CB\u7EE7\u7EED\u8FD0\u884C\u4E86\uFF0C\u8FD9\u91CC\u518D\u8FDB\u884C\u4E00\u4E0B\u540E\u671F\u6E05\u7406\u5DE5\u4F5C</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nextWaiter </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">unlinkCancelledWaiters</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//\u5C06\u7B49\u5F85\u961F\u5217\u4E2D\uFF0C\u4E0D\u662FNode.CONDITION\u72B6\u6001\u7684\u8282\u70B9\u79FB\u9664</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">interruptMode </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u4F9D\u7136\u662F\u54CD\u5E94\u4E2D\u65AD</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">reportInterruptAfterWait</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">interruptMode</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//OK\uFF0C\u63A5\u7740\u8BE5\u5E72\u561B\u5E72\u561B</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5B9E\u9645\u4E0A<code>await()</code>\u65B9\u6CD5\u6BD4\u8F83\u4E2D\u89C4\u4E2D\u77E9\uFF0C\u5927\u90E8\u5206\u64CD\u4F5C\u4E5F\u5728\u6211\u4EEC\u7684\u610F\u6599\u4E4B\u4E2D\uFF0C\u90A3\u4E48\u6211\u4EEC\u63A5\u7740\u6765\u770B<code>signal()</code>\u65B9\u6CD5\u662F\u5982\u4F55\u5B9E\u73B0\u7684\uFF0C\u540C\u6837\u7684\uFF0C\u4E3A\u4E86\u9632\u6B62\u5404\u4F4D\u7ED5\u6655\uFF0C\u5148\u660E\u786Esignal\u7684\u76EE\u6807\uFF1A</p><ul><li>\u53EA\u6709\u6301\u6709\u9501\u7684\u7EBF\u7A0B\u624D\u80FD\u5524\u9192\u9501\u6240\u5C5E\u7684Condition\u7B49\u5F85\u7684\u7EBF\u7A0B</li><li>\u4F18\u5148\u5524\u9192\u6761\u4EF6\u961F\u5217\u4E2D\u7684\u7B2C\u4E00\u4E2A\uFF0C\u5982\u679C\u5524\u9192\u8FC7\u7A0B\u4E2D\u51FA\u73B0\u95EE\u9898\uFF0C\u63A5\u7740\u627E\u5F80\u4E0B\u627E\uFF0C\u76F4\u5230\u627E\u5230\u4E00\u4E2A\u53EF\u4EE5\u5524\u9192\u7684</li><li>\u5524\u9192\u64CD\u4F5C\u672C\u8D28\u4E0A\u662F\u5C06\u6761\u4EF6\u961F\u5217\u4E2D\u7684\u7ED3\u70B9\u76F4\u63A5\u4E22\u8FDBAQS\u7B49\u5F85\u961F\u5217\u4E2D\uFF0C\u8BA9\u5176\u53C2\u4E0E\u5230\u9501\u7684\u7ADE\u4E89\u4E2D</li><li>\u62FF\u5230\u9501\u4E4B\u540E\uFF0C\u7EBF\u7A0B\u624D\u80FD\u6062\u590D\u8FD0\u884C</li></ul><p><img src="`+E+`" alt="image-20220307120449303"></p><p>\u6E90\u7801\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">signal</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#82AAFF;">isHeldExclusively</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5148\u770B\u770B\u5F53\u524D\u7EBF\u7A0B\u662F\u4E0D\u662F\u6301\u6709\u9501\u7684\u72B6\u6001</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IllegalMonitorStateException</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u4E0D\u662F\uFF1F\u90A3\u4F60\u4E0D\u914D\u5524\u9192\u522B\u4EBA</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> first </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> firstWaiter</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u83B7\u53D6\u6761\u4EF6\u961F\u5217\u7684\u7B2C\u4E00\u4E2A\u7ED3\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">first </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5982\u679C\u961F\u5217\u4E0D\u4E3A\u7A7A\uFF0C\u83B7\u53D6\u5230\u4E86\uFF0C\u90A3\u4E48\u5C31\u53EF\u4EE5\u5F00\u59CB\u5524\u9192\u64CD\u4F5C</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">doSignal</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">first</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">doSignal</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> first</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">do</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">firstWaiter </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> first</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nextWaiter</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u5F53\u524D\u8282\u70B9\u5728\u672C\u8F6E\u5FAA\u73AF\u6CA1\u6709\u540E\u7EE7\u8282\u70B9\u4E86\uFF0C\u6761\u4EF6\u961F\u5217\u5C31\u4E3A\u7A7A\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">            lastWaiter </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6240\u4EE5\u8FD9\u91CC\u76F8\u5F53\u4E8E\u662F\u76F4\u63A5\u6E05\u7A7A</span></span>
<span class="line"><span style="color:#A6ACCD;">        first</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nextWaiter </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5C06\u7ED9\u5B9A\u8282\u70B9\u7684\u4E0B\u4E00\u4E2A\u7ED3\u70B9\u8BBE\u7F6E\u4E3Anull\uFF0C\u56E0\u4E3A\u5F53\u524D\u7ED3\u70B9\u9A6C\u4E0A\u5C31\u4F1A\u79BB\u5F00\u6761\u4EF6\u961F\u5217\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#82AAFF;">transferForSignal</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">first</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u63A5\u7740\u5F80\u4E0B\u770B</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">first </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> firstWaiter</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u80FD\u8D70\u5230\u8FD9\u91CC\u53EA\u80FD\u8BF4\u660E\u7ED9\u5B9A\u8282\u70B9\u88AB\u8BBE\u5B9A\u4E3A\u4E86\u53D6\u6D88\u72B6\u6001\uFF0C\u90A3\u5C31\u7EE7\u7EED\u770B\u4E0B\u4E00\u4E2A\u7ED3\u70B9</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">transferForSignal</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">/*</span></span>
<span class="line"><span style="color:#676E95;">     * \u5982\u679C\u8FD9\u91CCCAS\u5931\u8D25\uFF0C\u90A3\u6709\u53EF\u80FD\u6B64\u8282\u70B9\u88AB\u8BBE\u5B9A\u4E3A\u4E86\u53D6\u6D88\u72B6\u6001</span></span>
<span class="line"><span style="color:#676E95;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#82AAFF;">compareAndSetWaitStatus</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">CONDITION</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//CAS\u6210\u529F\u4E4B\u540E\uFF0C\u7ED3\u70B9\u7684\u7B49\u5F85\u72B6\u6001\u5C31\u53D8\u6210\u4E86\u9ED8\u8BA4\u503C0\uFF0C\u63A5\u7740\u901A\u8FC7enq\u65B9\u6CD5\u76F4\u63A5\u5C06\u8282\u70B9\u4E22\u8FDBAQS\u7684\u7B49\u5F85\u961F\u5217\u4E2D\uFF0C\u76F8\u5F53\u4E8E\u5524\u9192\u5E76\u4E14\u53EF\u4EE5\u7B49\u5F85\u83B7\u53D6\u9501\u4E86</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u8FD9\u91CCenq\u65B9\u6CD5\u8FD4\u56DE\u7684\u662F\u52A0\u5165\u4E4B\u540E\u7B49\u5F85\u961F\u5217\u961F\u5C3E\u7684\u524D\u9A71\u8282\u70B9\uFF0C\u5C31\u662F\u539F\u6765\u7684tail</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> p </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">enq</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> ws </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> p</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">waitStatus</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u4FDD\u5B58\u524D\u9A71\u7ED3\u70B9\u7684\u7B49\u5F85\u72B6\u6001</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u5982\u679C\u4E0A\u4E00\u4E2A\u8282\u70B9\u7684\u72B6\u6001\u4E3A\u53D6\u6D88, \u6216\u8005\u5C1D\u8BD5\u8BBE\u7F6E\u4E0A\u4E00\u4E2A\u8282\u70B9\u7684\u72B6\u6001\u4E3ASIGNAL\u5931\u8D25\uFF08\u53EF\u80FD\u662F\u5728ws&gt;0\u5224\u65AD\u5B8C\u4E4B\u540E\u9A6C\u4E0A\u53D8\u6210\u4E86\u53D6\u6D88\u72B6\u6001\uFF0C\u5BFC\u81F4CAS\u5931\u8D25\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ws </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!</span><span style="color:#82AAFF;">compareAndSetWaitStatus</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> ws</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SIGNAL</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">        LockSupport</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unpark</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">thread</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//\u76F4\u63A5\u5524\u9192\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5176\u5B9E\u6700\u8BA9\u4EBA\u4E0D\u7406\u89E3\u7684\u5C31\u662F\u5012\u6570\u7B2C\u4E8C\u884C\uFF0C\u660E\u660E\u4E0A\u9762\u90FD\u6B63\u5E38\u8FDB\u5165\u5230AQS\u7B49\u5F85\u961F\u5217\u4E86\uFF0C\u5E94\u8BE5\u662F\u53EF\u4EE5\u5F00\u59CB\u8D70\u6B63\u5E38\u6D41\u7A0B\u4E86\uFF0C\u90A3\u4E48\u8FD9\u91CC\u4E3A\u4EC0\u4E48\u8FD8\u8981\u63D0\u524D\u6765\u4E00\u6B21unpark\u5462\uFF1F</p><p>\u8FD9\u91CC\u5176\u5B9E\u662F\u4E3A\u4E86\u8FDB\u884C\u4F18\u5316\u800C\u7F16\u5199\uFF0C\u76F4\u63A5unpark\u4F1A\u6709\u4E24\u79CD\u60C5\u51B5\uFF1A</p><ul><li>\u5982\u679C\u63D2\u5165\u7ED3\u70B9\u524D\uFF0CAQS\u7B49\u5F85\u961F\u5217\u7684\u961F\u5C3E\u8282\u70B9\u5C31\u5DF2\u7ECF\u88AB\u53D6\u6D88\uFF0C\u5219\u6EE1\u8DB3wc &gt; 0</li><li>\u5982\u679C\u63D2\u5165node\u540E\uFF0CAQS\u5185\u90E8\u7B49\u5F85\u961F\u5217\u7684\u961F\u5C3E\u8282\u70B9\u5DF2\u7ECF\u7A33\u5B9A\uFF0C\u6EE1\u8DB3tail.waitStatus == 0\uFF0C\u4F46\u5728\u6267\u884Cws &gt; 0\u4E4B\u540E!compareAndSetWaitStatus(p, ws, Node.SIGNAL)\u4E4B\u524D\u88AB\u53D6\u6D88\uFF0C\u5219CAS\u4E5F\u4F1A\u5931\u8D25\uFF0C\u6EE1\u8DB3compareAndSetWaitStatus(p, ws, Node.SIGNAL) == false</li></ul><p>\u5982\u679C\u8FD9\u91CC\u88AB\u63D0\u524Dunpark\uFF0C\u90A3\u4E48\u5728<code>await()</code>\u65B9\u6CD5\u4E2D\u5C06\u53EF\u4EE5\u88AB\u76F4\u63A5\u5524\u9192\uFF0C\u5E76\u8DF3\u51FAwhile\u5FAA\u73AF\uFF0C\u76F4\u63A5\u5F00\u59CB\u4E89\u62A2\u9501\uFF0C\u56E0\u4E3A\u524D\u4E00\u4E2A\u7B49\u5F85\u7ED3\u70B9\u662F\u88AB\u53D6\u6D88\u7684\u72B6\u6001\uFF0C\u6CA1\u6709\u5FC5\u8981\u518D\u7B49\u5B83\u4E86\u3002\u6240\u4EE5\uFF0C\u5927\u81F4\u6D41\u7A0B\u4E0B\uFF1A</p><p><img src="`+d+`" alt="image-20220307131536020"></p><h4 id="\u5E76\u53D1\u5BB9\u5668" tabindex="-1">\u5E76\u53D1\u5BB9\u5668 <a class="header-anchor" href="#\u5E76\u53D1\u5BB9\u5668" aria-hidden="true">#</a></h4><h5 id="copyonwritearraylist" tabindex="-1">CopyOnWriteArrayList <a class="header-anchor" href="#copyonwritearraylist" aria-hidden="true">#</a></h5><p><code>add()</code>\uFF1A\u6DFB\u52A0\u64CD\u4F5C\u662F\u76F4\u63A5\u4E0A\u9501\uFF0C\u5E76\u4E14\u4F1A\u5148\u62F7\u8D1D\u4E00\u4EFD\u5F53\u524D\u5B58\u653E\u5143\u7D20\u7684\u6570\u7EC4\uFF0C\u7136\u540E\u5BF9\u6570\u7EC4\u8FDB\u884C\u4FEE\u6539\uFF0C\u518D\u5C06\u6B64\u6570\u7EC4\u66FF\u6362\uFF08CopyOnWrite\uFF09</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u76F4\u63A5\u52A0\u9501\uFF0C\u4FDD\u8BC1\u540C\u4E00\u65F6\u95F4\u53EA\u6709\u4E00\u4E2A\u7EBF\u7A0B\u8FDB\u884C\u6DFB\u52A0\u64CD\u4F5C</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u83B7\u53D6\u5F53\u524D\u5B58\u50A8\u5143\u7D20\u7684\u6570\u7EC4</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Object</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> elements </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getArray</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> len </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> elements</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u76F4\u63A5\u590D\u5236\u4E00\u4EFD\u6570\u7EC4</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Object</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> newElements </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Arrays</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">copyOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">elements</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> len </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u4FEE\u6539\u590D\u5236\u51FA\u6765\u7684\u6570\u7EC4</span></span>
<span class="line"><span style="color:#A6ACCD;">        newElements</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">len</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u5C06\u5143\u7D20\u6570\u7EC4\u8BBE\u5B9A\u4E3A\u590D\u5236\u51FA\u6765\u7684\u6570\u7EC4</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">setArray</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">newElements</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><code>get(int index)</code>\uFF1A\u5BF9\u4E8E\u8BFB\u64CD\u4F5C\u4E0D\u52A0\u9501</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> index</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">getArray</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> index</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="concurrenthashmap" tabindex="-1">ConcurrentHashMap <a class="header-anchor" href="#concurrenthashmap" aria-hidden="true">#</a></h5><p>JDK7\u4E4B\u524D\uFF0CConcurrentHashMap\u7684\u539F\u7406\u4E5F\u6BD4\u8F83\u7C7B\u4F3C\uFF0C\u5B83\u5C06\u6240\u6709\u6570\u636E\u5206\u4E3A\u4E00\u6BB5\u4E00\u6BB5\u5730\u5B58\u50A8\uFF0C\u5148\u5206\u5F88\u591A\u6BB5\u51FA\u6765\uFF0C\u6BCF\u4E00\u6BB5\u90FD\u7ED9\u4E00\u628A\u9501\uFF0C\u5F53\u4E00\u4E2A\u7EBF\u7A0B\u5360\u9501\u8BBF\u95EE\u65F6\uFF0C\u53EA\u4F1A\u5360\u7528\u5176\u4E2D\u4E00\u628A\u9501\uFF0C\u4E5F\u5C31\u662F\u4EC5\u4EC5\u9501\u4E86\u4E00\u5C0F\u6BB5\u6570\u636E\uFF0C\u800C\u5176\u4ED6\u6BB5\u7684\u6570\u636E\u4F9D\u7136\u53EF\u4EE5\u88AB\u5176\u4ED6\u7EBF\u7A0B\u6B63\u5E38\u8BBF\u95EE\u3002</p><p><img src="`+g+'" alt="image-20220406102137754"></p><p>JDK8\u4E4B\u540E\uFF0C\u91C7\u7528\u4E86CAS\u7B97\u6CD5\u914D\u5408\u9501\u673A\u5236\u5B9E\u73B0</p><p><img src="'+h+`" alt="image-20220406102232375"></p><p><code>put()</code>\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">V</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">put</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">K</span><span style="color:#A6ACCD;"> key</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">V</span><span style="color:#A6ACCD;"> value</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">putVal</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">key</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> value</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span></span>
<span class="line"><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">V</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">putVal</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">K</span><span style="color:#A6ACCD;"> key</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">V</span><span style="color:#A6ACCD;"> value</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> onlyIfAbsent</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u952E\u503C\u4E0D\u80FD\u4E3A\u7A7A</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">key </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> value </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">NullPointerException</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u8BA1\u7B97\u952E\u7684hash\u503C\uFF0C\u7528\u4E8E\u786E\u5B9A\u5728\u54C8\u5E0C\u8868\u4E2D\u7684\u4F4D\u7F6E</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> hash </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">spread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">key</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">hashCode</span><span style="color:#89DDFF;">());</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u7528\u6765\u8BB0\u5F55\u94FE\u8868\u957F\u5EA6</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> binCount </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// CAS\u81EA\u65CB\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Node</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">K</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">V</span><span style="color:#89DDFF;">&gt;[]</span><span style="color:#A6ACCD;"> tab </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> table</span><span style="color:#89DDFF;">;;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Node</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">K</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">V</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> f</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> n</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> fh</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tab </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">n </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> tab</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u5982\u679C\u6570\u7EC4\uFF08\u54C8\u5E0C\u8868\uFF09\u4E3A\u7A7A\u80AF\u5B9A\u662F\u8981\u8FDB\u884C\u521D\u59CB\u5316\u7684\uFF0C\u7136\u540E\u518D\u91CD\u65B0\u8FDB\u4E0B\u4E00\u8F6E\u5FAA\u73AF</span></span>
<span class="line"><span style="color:#A6ACCD;">            tab </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">initTable</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u5982\u679C\u54C8\u5E0C\u8868\u8BE5\u4F4D\u7F6E\u4E3Anull\uFF0C\u76F4\u63A5CAS\u63D2\u5165\u7ED3\u70B9\u4F5C\u4E3A\u5934\u7ED3\u5373\u53EF\uFF08\u6CE8\u610F\u8FD9\u91CC\u4F1A\u5C06f\u8BBE\u7F6E\u5F53\u524D\u54C8\u5E0C\u8868\u4F4D\u7F6E\u4E0A\u7684\u5934\u7ED3\u70B9\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">f </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tabAt</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tab</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">n </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;"> hash</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">casTabAt</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tab</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null,</span></span>
<span class="line"><span style="color:#A6ACCD;">                         </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">K</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">V</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#A6ACCD;">hash</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> key</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> value</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)))</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#89DDFF;">                </span><span style="color:#676E95;">// \u5982\u679CCAS\u6210\u529F\uFF0C\u76F4\u63A5break\u7ED3\u675Fput\u65B9\u6CD5\uFF0C\u5931\u8D25\u90A3\u5C31\u7EE7\u7EED\u4E0B\u4E00\u8F6E\u5FAA\u73AF</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u5934\u7ED3\u70B9\u54C8\u5E0C\u503C\u4E3A-1\uFF0C\u8FD9\u91CC\u53EA\u9700\u8981\u77E5\u9053\u662F\u56E0\u4E3A\u6B63\u5728\u6269\u5BB9\u5373\u53EF</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">fh </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> f</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">hash</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> MOVED</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u5E2E\u52A9\u8FDB\u884C\u8FC1\u79FB\uFF0C\u5B8C\u4E8B\u4E4B\u540E\u518D\u6765\u4E0B\u4E00\u6B21\u5FAA\u73AF</span></span>
<span class="line"><span style="color:#A6ACCD;">            tab </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">helpTransfer</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tab</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> f</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u6B63\u5E38\u6D41\u7A0B\u8D70\u8FD9\u91CC</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">V</span><span style="color:#A6ACCD;"> oldVal </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u524D\u9762\u7684\u5FAA\u73AF\u4E2Df\u80AF\u5B9A\u662F\u88AB\u8BBE\u5B9A\u4E3A\u4E86\u54C8\u5E0C\u8868\u67D0\u4E2A\u4F4D\u7F6E\u4E0A\u7684\u5934\u7ED3\u70B9\uFF0C\u8FD9\u91CC\u628A\u5B83\u4F5C\u4E3A\u9501\u52A0\u9501\u4E86\uFF0C\u9632\u6B62\u540C\u4E00\u65F6\u95F4\u5176\u4ED6\u7EBF\u7A0B\u4E5F\u5728\u64CD\u4F5C\u54C8\u5E0C\u8868\u4E2D\u8FD9\u4E2A\u4F4D\u7F6E\u4E0A\u7684\u94FE\u8868\u6216\u662F\u7EA2\u9ED1\u6811</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">synchronized</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">f</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">tabAt</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tab</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> f</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">                    </span><span style="color:#676E95;">// \u5934\u7ED3\u70B9\u7684\u54C8\u5E0C\u503C\u5927\u4E8E\u7B49\u4E8E0\u8BF4\u660E\u662F\u94FE\u8868\uFF0C\u4E0B\u9762\u5C31\u662F\u9488\u5BF9\u94FE\u8868\u7684\u4E00\u4E9B\u5217\u64CD\u4F5C</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">fh </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">...</span><span style="color:#A6ACCD;">\u5B9E\u73B0\u7EC6\u8282\u7565</span></span>
<span class="line"><span style="color:#89DDFF;">                    </span><span style="color:#676E95;">// \u80AF\u5B9A\u4E0D\u5927\u4E8E0\uFF0C\u80AF\u5B9A\u4E5F\u4E0D\u662F-1\uFF0C\u8FD8\u5224\u65AD\u662F\u4E0D\u662FTreeBin\uFF0C\u6240\u4EE5\u4E0D\u7528\u731C\u4E86\uFF0C\u80AF\u5B9A\u662F\u7EA2\u9ED1\u6811\uFF0C\u4E0B\u9762\u5C31\u662F\u9488\u5BF9\u7EA2\u9ED1\u6811\u7684\u60C5\u51B5\u8FDB\u884C\u64CD\u4F5C        </span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">f </span><span style="color:#89DDFF;">instanceof</span><span style="color:#A6ACCD;"> TreeBin</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#89DDFF;">                      	</span><span style="color:#676E95;">// \u5728ConcurrentHashMap\u5E76\u4E0D\u662F\u76F4\u63A5\u5B58\u50A8\u7684TreeNode\uFF0C\u800C\u662FTreeBin</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">...</span><span style="color:#A6ACCD;">\u5B9E\u73B0\u7EC6\u8282\u7565</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">          	</span><span style="color:#676E95;">// \u6839\u636E\u94FE\u8868\u957F\u5EA6\u51B3\u5B9A\u662F\u5426\u8981\u8FDB\u5316\u4E3A\u7EA2\u9ED1\u6811</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">binCount </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">binCount </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> TREEIFY_THRESHOLD</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">                    </span><span style="color:#676E95;">// \u6CE8\u610F\u8FD9\u91CC\u53EA\u662F\u53EF\u80FD\u4F1A\u8FDB\u5316\u4E3A\u7EA2\u9ED1\u6811\uFF0C\u5982\u679C\u5F53\u524D\u54C8\u5E0C\u8868\u7684\u957F\u5EA6\u5C0F\u4E8E64\uFF0C\u5B83\u4F1A\u4F18\u5148\u8003\u8651\u5BF9\u54C8\u5E0C\u8868\u8FDB\u884C\u6269\u5BB9</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#82AAFF;">treeifyBin</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tab</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">oldVal </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> oldVal</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">addCount</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1L</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> binCount</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u603B\u7ED3\uFF1A</p><p><img src="`+b+`" alt="image-20220406102601299"></p><p><code>get()</code>\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">V</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Object</span><span style="color:#A6ACCD;"> key</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Node</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">K</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">V</span><span style="color:#89DDFF;">&gt;[]</span><span style="color:#A6ACCD;"> tab</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">K</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">V</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> p</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> n</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> eh</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">K</span><span style="color:#A6ACCD;"> ek</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u8BA1\u7B97\u54C8\u5E0C\u503C</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> h </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">spread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">key</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">hashCode</span><span style="color:#89DDFF;">());</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">tab </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> table</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">n </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> tab</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tabAt</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tab</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">n </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;"> h</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">// \u5982\u679C\u5934\u7ED3\u70B9\u5C31\u662F\u6211\u4EEC\u8981\u627E\u7684\uFF0C\u90A3\u76F4\u63A5\u8FD4\u56DE\u503C\u5C31\u884C\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">eh </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">hash</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> h</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">ek </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">key</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> key </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ek </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> key</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">equals</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ek</span><span style="color:#89DDFF;">)))</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">val</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//\u8981\u4E48\u662F\u6B63\u5728\u6269\u5BB9\uFF0C\u8981\u4E48\u5C31\u662F\u7EA2\u9ED1\u6811\uFF0C\u8D1F\u6570\u53EA\u6709\u8FD9\u4E24\u79CD\u60C5\u51B5</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">eh </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">find</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">h</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> key</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> p</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">val </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">// \u786E\u8BA4\u65E0\u8BEF\uFF0C\u80AF\u5B9A\u5728\u5217\u8868\u91CC\uFF0C\u5F00\u627E</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">e </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">next</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">hash </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> h </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">ek </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">key</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> key </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ek </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> key</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">equals</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ek</span><span style="color:#89DDFF;">))))</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">val</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">// \u6CA1\u627E\u5230\u53EA\u80FDnull\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u7EFC\u4E0A\uFF0CConcurrentHashMap\u7684put\u64CD\u4F5C\uFF0C\u5B9E\u9645\u4E0A\u662F\u5BF9\u54C8\u5E0C\u8868\u4E0A\u7684\u6240\u6709\u5934\u7ED3\u70B9\u5143\u7D20\u5206\u522B\u52A0\u9501\uFF0C\u7406\u8BBA\u4E0A\u6765\u8BF4\u54C8\u5E0C\u8868\u7684\u957F\u5EA6\u5F88\u5927\u7A0B\u5EA6\u4E0A\u51B3\u5B9A\u4E86ConcurrentHashMap\u5728\u540C\u4E00\u65F6\u95F4\u80FD\u591F\u5904\u7406\u7684\u7EBF\u7A0B\u6570\u91CF\uFF0C\u8FD9\u4E5F\u662F\u4E3A\u4EC0\u4E48<code>treeifyBin()</code>\u4F1A\u4F18\u5148\u8003\u8651\u4E3A\u54C8\u5E0C\u8868\u8FDB\u884C\u6269\u5BB9\u7684\u539F\u56E0\u3002\u663E\u7136\uFF0C\u8FD9\u79CD\u52A0\u9501\u65B9\u5F0F\u6BD4JDK7\u7684\u5206\u6BB5\u9501\u673A\u5236\u6027\u80FD\u66F4\u597D\u3002</p><h4 id="\u963B\u585E\u961F\u5217" tabindex="-1">\u963B\u585E\u961F\u5217 <a class="header-anchor" href="#\u963B\u585E\u961F\u5217" aria-hidden="true">#</a></h4><ul><li>ArrayBlockingQueue\uFF1A\u6709\u754C\u5E26\u7F13\u51B2\u963B\u585E\u961F\u5217\uFF08\u5C31\u662F\u961F\u5217\u662F\u6709\u5BB9\u91CF\u9650\u5236\u7684\uFF0C\u88C5\u6EE1\u4E86\u80AF\u5B9A\u662F\u4E0D\u80FD\u518D\u88C5\u7684\uFF0C\u53EA\u80FD\u963B\u585E\uFF0C\u6570\u7EC4\u5B9E\u73B0\uFF09</li><li>SynchronousQueue\uFF1A\u65E0\u7F13\u51B2\u963B\u585E\u961F\u5217\uFF08\u76F8\u5F53\u4E8E\u6CA1\u6709\u5BB9\u91CF\u7684ArrayBlockingQueue\uFF0C\u56E0\u6B64\u53EA\u6709\u963B\u585E\u7684\u60C5\u51B5\uFF09</li><li>LinkedBlockingQueue\uFF1A\u65E0\u754C\u5E26\u7F13\u51B2\u963B\u585E\u961F\u5217\uFF08\u6CA1\u6709\u5BB9\u91CF\u9650\u5236\uFF0C\u4E5F\u53EF\u4EE5\u9650\u5236\u5BB9\u91CF\uFF0C\u4E5F\u4F1A\u963B\u585E\uFF0C\u94FE\u8868\u5B9E\u73B0\uFF09</li><li>PriorityBlockingQueue - \u662F\u4E00\u4E2A\u652F\u6301\u4F18\u5148\u7EA7\u7684\u963B\u585E\u961F\u5217\uFF0C\u5143\u7D20\u7684\u83B7\u53D6\u987A\u5E8F\u6309\u4F18\u5148\u7EA7\u51B3\u5B9A\u3002</li><li>DelayQueue - \u5B83\u80FD\u591F\u5B9E\u73B0\u5EF6\u8FDF\u83B7\u53D6\u5143\u7D20\uFF0C\u540C\u6837\u652F\u6301\u4F18\u5148\u7EA7\u3002</li></ul><p>\u963B\u585E\u961F\u5217\u672C\u8EAB\u4E5F\u662F\u961F\u5217\uFF0C\u4F46\u662F\u5B83\u662F\u9002\u7528\u4E8E\u591A\u7EBF\u7A0B\u73AF\u5883\u4E0B\u7684\uFF0C\u57FA\u4E8EReentrantLock\u5B9E\u73B0\u7684\uFF0C\u5B83\u7684\u63A5\u53E3\u5B9A\u4E49\u5982\u4E0B\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">interface</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">BlockingQueue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">E</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Queue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">E</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">   	</span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u5165\u961F\uFF0C\u5982\u679C\u961F\u5217\u5DF2\u6EE1\uFF0C\u8FD4\u56DEfalse\u5426\u5219\u8FD4\u56DEtrue\uFF08\u975E\u963B\u585E\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">offer</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u5165\u961F\uFF0C\u5982\u679C\u961F\u5217\u5DF2\u6EE1\uFF0C\u963B\u585E\u7EBF\u7A0B\u76F4\u5230\u80FD\u5165\u961F\u4E3A\u6B62</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">put</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u5165\u961F\uFF0C\u5982\u679C\u961F\u5217\u5DF2\u6EE1\uFF0C\u963B\u585E\u7EBF\u7A0B\u76F4\u5230\u80FD\u5165\u961F\u6216\u8D85\u65F6\u3001\u4E2D\u65AD\u4E3A\u6B62\uFF0C\u5165\u961F\u6210\u529F\u8FD4\u56DEtrue\u5426\u5219false</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">offer</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">timeout</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TimeUnit</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">unit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u51FA\u961F\uFF0C\u5982\u679C\u961F\u5217\u4E3A\u7A7A\uFF0C\u963B\u585E\u7EBF\u7A0B\u76F4\u5230\u80FD\u51FA\u961F\u4E3A\u6B62</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">take</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u51FA\u961F\uFF0C\u5982\u679C\u961F\u5217\u4E3A\u7A7A\uFF0C\u963B\u585E\u7EBF\u7A0B\u76F4\u5230\u80FD\u51FA\u961F\u8D85\u65F6\u3001\u4E2D\u65AD\u4E3A\u6B62\uFF0C\u51FA\u961F\u6210\u529F\u6B63\u5E38\u8FD4\u56DE\uFF0C\u5426\u5219\u8FD4\u56DEnull</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">poll</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">timeout</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TimeUnit</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">unit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u8FD4\u56DE\u6B64\u961F\u5217\u7406\u60F3\u60C5\u51B5\u4E0B\uFF08\u5728\u6CA1\u6709\u5185\u5B58\u6216\u8D44\u6E90\u9650\u5236\u7684\u60C5\u51B5\u4E0B\uFF09\u53EF\u4EE5\u4E0D\u963B\u585E\u5730\u5165\u961F\u7684\u6570\u91CF\uFF0C\u5982\u679C\u6CA1\u6709\u9650\u5236\uFF0C\u5219\u8FD4\u56DE Integer.MAX_VALUE</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">remainingCapacity</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">remove</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Object</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">o</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">contains</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Object</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">o</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">// \u4E00\u6B21\u6027\u4ECEBlockingQueue\u4E2D\u83B7\u53D6\u6240\u6709\u53EF\u7528\u7684\u6570\u636E\u5BF9\u8C61\uFF08\u8FD8\u53EF\u4EE5\u6307\u5B9A\u83B7\u53D6\u6570\u636E\u7684\u4E2A\u6570\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">drainTo</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Collection</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">super</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">E</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">drainTo</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Collection</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">super</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">E</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">maxElements</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u6BD4\u5982\u73B0\u5728\u6709\u4E00\u4E2A\u5BB9\u91CF\u4E3A3\u7684\u963B\u585E\u961F\u5217\uFF0C\u8FD9\u4E2A\u65F6\u5019\u4E00\u4E2A\u7EBF\u7A0B<code>put</code>\u5411\u5176\u6DFB\u52A0\u4E86\u4E09\u4E2A\u5143\u7D20\uFF0C\u7B2C\u4E8C\u4E2A\u7EBF\u7A0B\u63A5\u7740<code>put</code>\u5411\u5176\u6DFB\u52A0\u4E09\u4E2A\u5143\u7D20\uFF0C\u90A3\u4E48\u8FD9\u4E2A\u65F6\u5019\u7531\u4E8E\u5BB9\u91CF\u5DF2\u6EE1\uFF0C\u4F1A\u76F4\u63A5\u88AB\u963B\u585E\uFF0C\u800C\u8FD9\u65F6\u7B2C\u4E09\u4E2A\u7EBF\u7A0B\u4ECE\u961F\u5217\u4E2D\u53D6\u8D702\u4E2A\u5143\u7D20\uFF0C\u7EBF\u7A0B\u4E8C\u505C\u6B62\u963B\u585E\uFF0C\u5148\u4E22\u4E24\u4E2A\u8FDB\u53BB\uFF0C\u8FD8\u6709\u4E00\u4E2A\u8FD8\u662F\u8FDB\u4E0D\u53BB\uFF0C\u6240\u4EE5\u8BF4\u7EE7\u7EED\u963B\u585E\u3002</p><p><img src="`+m+`" alt="image-20220406102943972"></p><h5 id="arrayblockingqueue" tabindex="-1"><code>ArrayBlockingQueue</code> <a class="header-anchor" href="#arrayblockingqueue" aria-hidden="true">#</a></h5><p>\u6784\u9020\u65B9\u6CD5\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> lock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Condition</span><span style="color:#A6ACCD;"> notEmpty</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Condition</span><span style="color:#A6ACCD;"> notFull</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ArrayBlockingQueue</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> capacity</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> fair</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">capacity </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IllegalArgumentException</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">items </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Object</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">capacity</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u5E95\u5C42\u91C7\u7528\u9501\u673A\u5236\u4FDD\u8BC1\u7EBF\u7A0B\u5B89\u5168\u6027\uFF0C\u8FD9\u91CC\u6211\u4EEC\u53EF\u4EE5\u9009\u62E9\u4F7F\u7528\u516C\u5E73\u9501\u6216\u662F\u975E\u516C\u5E73\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ReentrantLock</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">fair</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u8FD9\u91CC\u521B\u5EFA\u4E86\u4E24\u4E2ACondition\uFF08\u90FD\u5C5E\u4E8Elock\uFF09\u4E00\u4F1A\u7528\u4E8E\u5165\u961F\u548C\u51FA\u961F\u7684\u7EBF\u7A0B\u963B\u585E\u63A7\u5236</span></span>
<span class="line"><span style="color:#A6ACCD;">    notEmpty </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newCondition</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">    notFull </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">  lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newCondition</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><code>put</code>\u65B9\u6CD5\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">put</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">checkNotNull</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u9700\u8981\u8FDB\u884C\u52A0\u9501\u64CD\u4F5C</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u6CE8\u610F\u8FD9\u91CC\u662F\u53EF\u4EE5\u54CD\u5E94\u4E2D\u65AD\u7684</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lockInterruptibly</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">count </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> items</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u53EF\u4EE5\u770B\u5230\u5F53\u961F\u5217\u5DF2\u6EE1\u65F6\u4F1A\u76F4\u63A5\u6302\u8D77\u5F53\u524D\u7EBF\u7A0B\uFF0C\u5728\u5176\u4ED6\u7EBF\u7A0B\u51FA\u961F\u64CD\u4F5C\u65F6\u4F1A\u88AB\u5524\u9192</span></span>
<span class="line"><span style="color:#A6ACCD;">            notFull</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u76F4\u5230\u961F\u5217\u6709\u7A7A\u4F4D\u624D\u5C06\u7EBF\u7A0B\u5165\u961F</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">enqueue</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><code>offer</code>\u65B9\u6CD5\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">offer</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">checkNotNull</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u53EF\u4EE5\u770B\u5230\u8FD9\u91CC\u4E5F\u662F\u4F7F\u7528\u4E86\u7C7B\u91CC\u9762\u7684ReentrantLock\u8FDB\u884C\u52A0\u9501\u64CD\u4F5C</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u4FDD\u8BC1\u540C\u4E00\u65F6\u95F4\u53EA\u6709\u4E00\u4E2A\u7EBF\u7A0B\u8FDB\u5165</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u76F4\u63A5\u770B\u770B\u961F\u5217\u662F\u5426\u5DF2\u6EE1\uFF0C\u5982\u679C\u6CA1\u6EE1\u5219\u76F4\u63A5\u5165\u961F\uFF0C\u5982\u679C\u5DF2\u6EE1\u5219\u8FD4\u56DEfalse</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">count </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> items</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">enqueue</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">dequeue</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// assert lock.getHoldCount() == 1;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// assert items[takeIndex] != null;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Object</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> items </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">items</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">SuppressWarnings</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">unchecked</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> x </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">E</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> items</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">takeIndex</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#A6ACCD;">    items</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">takeIndex</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(++</span><span style="color:#A6ACCD;">takeIndex </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> items</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        takeIndex </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    count</span><span style="color:#89DDFF;">--;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">itrs </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span></span>
<span class="line"><span style="color:#A6ACCD;">        itrs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">elementDequeued</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u51FA\u961F\u64CD\u4F5C\u4F1A\u8C03\u7528notFull\u7684signal\u65B9\u6CD5\u5524\u9192\u88AB\u6302\u8D77\u5904\u4E8E\u7B49\u5F85\u72B6\u6001\u7684\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">    notFull</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">signal</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u51FA\u961F\u64CD\u4F5C\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">poll</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u51FA\u961F\u540C\u6837\u8FDB\u884C\u52A0\u9501\u64CD\u4F5C\uFF0C\u4FDD\u8BC1\u540C\u4E00\u65F6\u95F4\u53EA\u80FD\u6709\u4E00\u4E2A\u7EBF\u7A0B\u6267\u884C</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u5982\u679C\u961F\u5217\u4E0D\u4E3A\u7A7A\u5219\u51FA\u961F\uFF0C\u5426\u5219\u8FD4\u56DEnull</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">count </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">dequeue</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">take</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u53EF\u4EE5\u54CD\u5E94\u4E2D\u65AD\u8FDB\u884C\u52A0\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lockInterruptibly</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">count </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u548C\u5165\u961F\u76F8\u53CD\uFF0C\u4E5F\u662F\u4E00\u76F4\u7B49\u76F4\u5230\u961F\u5217\u4E2D\u6709\u5143\u7D20\u4E4B\u540E\u624D\u53EF\u4EE5\u51FA\u961F\uFF0C\u5728\u5165\u961F\u65F6\u4F1A\u5524\u9192\u6B64\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">            notEmpty</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">dequeue</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">enqueue</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// assert lock.getHoldCount() == 1;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// assert items[putIndex] == null;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Object</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> items </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">items</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    items</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">putIndex</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(++</span><span style="color:#A6ACCD;">putIndex </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> items</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        putIndex </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    count</span><span style="color:#89DDFF;">++;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u5BF9notEmpty\u7684signal\u5524\u9192\u64CD\u4F5C</span></span>
<span class="line"><span style="color:#A6ACCD;">    notEmpty</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">signal</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="synchronousqueue" tabindex="-1"><code>SynchronousQueue</code> <a class="header-anchor" href="#synchronousqueue" aria-hidden="true">#</a></h5><p>\u6CA1\u6709\u4EFB\u4F55\u5BB9\u91CF\uFF0C\u6B63\u5E38\u60C5\u51B5\u4E0B\u51FA\u961F\u5FC5\u987B\u548C\u5165\u961F\u64CD\u4F5C\u6210\u5BF9\u51FA\u73B0\uFF0C\u6211\u4EEC\u5148\u6765\u770B\u5B83\u7684\u5185\u90E8\uFF0C\u53EF\u4EE5\u770B\u5230\u5185\u90E8\u6709\u4E00\u4E2A\u62BD\u8C61\u7C7BTransferer\uFF0C\u5B83\u5B9A\u4E49\u4E86\u4E00\u4E2A<code>transfer</code>\u65B9\u6CD5\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">abstract</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Transferer</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">E</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;">    /**</span></span>
<span class="line"><span style="color:#676E95;">     * \u53EF\u4EE5\u662Fput\u4E5F\u53EF\u4EE5\u662Ftake\u64CD\u4F5C</span></span>
<span class="line"><span style="color:#676E95;">     *</span></span>
<span class="line"><span style="color:#676E95;">     * </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#676E95;"> \u5982\u679C\u4E0D\u662F\u7A7A\uFF0C\u5373\u4F5C\u4E3A\u751F\u4EA7\u8005\uFF0C\u90A3\u4E48\u8868\u793A\u4F1A\u5C06\u4F20\u5165\u53C2\u6570\u5143\u7D20e\u4EA4\u7ED9\u6D88\u8D39\u8005</span></span>
<span class="line"><span style="color:#676E95;">     *          \u5982\u679C\u4E3A\u7A7A\uFF0C\u5373\u4F5C\u4E3A\u6D88\u8D39\u8005\uFF0C\u90A3\u4E48\u8868\u793A\u4F1A\u4ECE\u751F\u4EA7\u8005\u90A3\u91CC\u5F97\u5230\u4E00\u4E2A\u5143\u7D20e\u5E76\u8FD4\u56DE</span></span>
<span class="line"><span style="color:#676E95;">     * </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">\u662F\u5426\u53EF\u4EE5\u8D85\u65F6</span></span>
<span class="line"><span style="color:#676E95;">     * </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">\u8D85\u65F6\u65F6\u95F4</span></span>
<span class="line"><span style="color:#676E95;">     * </span><span style="color:#F78C6C;">@return</span><span style="color:#676E95;"> \u4E0D\u4E3A\u7A7A\u5C31\u662F\u4ECE\u751F\u4EA7\u8005\u90A3\u91CC\u8FD4\u56DE\u7684\uFF0C\u4E3A\u7A7A\u8868\u793A\u8981\u4E48\u88AB\u4E2D\u65AD\u8981\u4E48\u8D85\u65F6\u3002</span></span>
<span class="line"><span style="color:#676E95;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">abstract</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">transfer</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">timed</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">nanos</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5B83\u662F\u76F4\u63A5\u4EE5\u751F\u4EA7\u8005\u6D88\u8D39\u8005\u6A21\u5F0F\u8FDB\u884C\u7684\uFF0C\u7531\u4E8E\u4E0D\u9700\u8981\u4F9D\u9760\u4EFB\u4F55\u5BB9\u5668\u7ED3\u6784\u6765\u6682\u65F6\u5B58\u653E\u6570\u636E\uFF0C\u6240\u4EE5\u6211\u4EEC\u53EF\u4EE5\u76F4\u63A5\u901A\u8FC7<code>transfer</code>\u65B9\u6CD5\u6765\u5BF9\u751F\u4EA7\u8005\u548C\u6D88\u8D39\u8005\u4E4B\u95F4\u7684\u6570\u636E\u8FDB\u884C\u4F20\u9012\u3002</p><p>\u6BD4\u5982\u4E00\u4E2A\u7EBF\u7A0Bput\u4E00\u4E2A\u65B0\u7684\u5143\u7D20\u8FDB\u5165\uFF0C\u8FD9\u65F6\u5982\u679C\u6CA1\u6709\u5176\u4ED6\u7EBF\u7A0B\u8C03\u7528take\u65B9\u6CD5\u83B7\u53D6\u5143\u7D20\uFF0C\u90A3\u4E48\u4F1A\u6301\u7EED\u88AB\u963B\u585E\uFF0C\u76F4\u5230\u6709\u7EBF\u7A0B\u53D6\u51FA\u5143\u7D20\uFF0C\u800C<code>transfer</code>\u6B63\u662F\u9700\u8981\u7B49\u751F\u4EA7\u8005\u6D88\u8D39\u8005\u53CC\u65B9\u90FD\u5230\u9F50\u4E86\u624D\u80FD\u8FDB\u884C\u4EA4\u63A5\u5DE5\u4F5C\uFF0C\u5355\u72EC\u53EA\u6709\u5176\u4E2D\u4E00\u65B9\u90FD\u9700\u8981\u8FDB\u884C\u7B49\u5F85\u3002</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">put</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u5224\u7A7A</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">NullPointerException</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u76F4\u63A5\u4F7F\u7528transfer\u65B9\u6CD5\u8FDB\u884C\u6570\u636E\u4F20\u9012</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">transferer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">transfer</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u4E3A\u7A7A\u8868\u793A\u8981\u4E48\u88AB\u4E2D\u65AD\u8981\u4E48\u8D85\u65F6</span></span>
<span class="line"><span style="color:#A6ACCD;">        Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">interrupted</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">InterruptedException</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5B83\u5728\u516C\u5E73\u548C\u975E\u516C\u5E73\u6A21\u5F0F\u4E0B\uFF0C\u6709\u4E24\u4E2A\u5B9E\u73B0\u3002</p><p><strong>\u516C\u5E73\u6A21\u5F0F</strong>\u4E0B\u7684SynchronousQueue\u662F\u5982\u4F55\u5B9E\u73B0\u7684\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">TransferQueue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">E</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Transferer</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">E</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;">//\u5934\u7ED3\u70B9\uFF08\u5934\u7ED3\u70B9\u4EC5\u4F5C\u4E3A\u5934\u7ED3\u70B9\uFF0C\u540E\u7EED\u8282\u70B9\u624D\u662F\u771F\u6B63\u7B49\u5F85\u7684\u7EBF\u7A0B\u8282\u70B9\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#C792EA;">transient</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">QNode</span><span style="color:#A6ACCD;"> head</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">     </span><span style="color:#676E95;">//\u5C3E\u7ED3\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#C792EA;">transient</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">QNode</span><span style="color:#A6ACCD;"> tail</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">    /** \u8282\u70B9\u6709\u751F\u4EA7\u8005\u548C\u6D88\u8D39\u8005\u89D2\u8272\u4E4B\u5206 */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">QNode</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">QNode</span><span style="color:#A6ACCD;"> next</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;">// \u540E\u7EE7\u8282\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Object</span><span style="color:#A6ACCD;"> item</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;">// \u5B58\u50A8\u7684\u5143\u7D20</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Thread</span><span style="color:#A6ACCD;"> waiter</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">       </span><span style="color:#676E95;">// \u5904\u4E8E\u7B49\u5F85\u7684\u7EBF\u7A0B\uFF0C\u548C\u4E4B\u524D\u7684AQS\u4E00\u6837\u7684\u601D\u8DEF\uFF0C\u6BCF\u4E2A\u7EBF\u7A0B\u7B49\u5F85\u7684\u65F6\u5019\u90FD\u4F1A\u88AB\u5C01\u88C5\u4E3A\u8282\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> isData</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;">// \u662F\u751F\u4EA7\u8005\u8282\u70B9\u8FD8\u662F\u6D88\u8D39\u8005\u8282\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">...</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u516C\u5E73\u6A21\u5F0F\u4E0B\uFF0CTransferer\u7684\u5B9E\u73B0\u662FTransferQueue\uFF0C\u662F\u4EE5\u5148\u8FDB\u5148\u51FA\u7684\u89C4\u5219\u7684\u8FDB\u884C\u7684\uFF0C\u5185\u90E8\u6709\u4E00\u4E2AQNode\u7C7B\u6765\u4FDD\u5B58\u7B49\u5F85\u7684\u7EBF\u7A0B\u3002</p><p><code>transfer()</code>\u65B9\u6CD5\u7684\u5B9E\u73B0:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">transfer</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> timed</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> nanos</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6CE8\u610F\u8FD9\u91CC\u9762\u6CA1\u52A0\u9501\uFF0C\u80AF\u5B9A\u4F1A\u591A\u4E2A\u7EBF\u7A0B\u4E4B\u95F4\u7ADE\u4E89</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">QNode</span><span style="color:#A6ACCD;"> s </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> isData </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//e\u4E3A\u7A7A\u8868\u793A\u6D88\u8D39\u8005\uFF0C\u4E0D\u4E3A\u7A7A\u8868\u793A\u751F\u4EA7\u8005</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(;;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">QNode</span><span style="color:#A6ACCD;"> t </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> tail</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">QNode</span><span style="color:#A6ACCD;"> h </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> head</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> h </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;">// \u5934\u7ED3\u70B9\u5C3E\u7ED3\u70B9\u4EFB\u610F\u4E3A\u7A7A\uFF08\u4F46\u662F\u5728\u6784\u9020\u7684\u65F6\u5019\u5C31\u5DF2\u7ECF\u4E0D\u662F\u7A7A\u4E86\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">continue</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">                       </span><span style="color:#676E95;">// \u81EA\u65CB</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">h </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> t </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> t</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">isData </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> isData</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u5934\u7ED3\u70B9\u7B49\u4E8E\u5C3E\u7ED3\u70B9\u8868\u793A\u961F\u5217\u4E2D\u53EA\u6709\u4E00\u4E2A\u5934\u7ED3\u70B9\uFF0C\u80AF\u5B9A\u662F\u7A7A\uFF0C\u6216\u8005\u5C3E\u7ED3\u70B9\u89D2\u8272\u548C\u5F53\u524D\u8282\u70B9\u4E00\u6837\uFF0C\u8FD9\u4E24\u79CD\u60C5\u51B5\u4E0B\uFF0C\u90FD\u9700\u8981\u8FDB\u884C\u5165\u961F\u64CD\u4F5C</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">QNode</span><span style="color:#A6ACCD;"> tn </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> t</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">next</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> tail</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">                  </span><span style="color:#676E95;">// \u5982\u679C\u8FD9\u6BB5\u65F6\u95F4\u5185t\u88AB\u5176\u4ED6\u7EBF\u7A0B\u4FEE\u6539\u4E86\uFF0C\u5982\u679C\u662F\u5C31\u8FDB\u4E0B\u4E00\u8F6E\u5FAA\u73AF\u91CD\u65B0\u6765</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">continue</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tn </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">               </span><span style="color:#676E95;">// \u7EE7\u7EED\u6821\u9A8C\u662F\u5426\u4E3A\u961F\u5C3E\uFF0C\u5982\u679Ctn\u4E0D\u4E3Anull\uFF0C\u90A3\u80AF\u5B9A\u662F\u5176\u4ED6\u7EBF\u7A0B\u6539\u4E86\u961F\u5C3E\uFF0C\u53EF\u4EE5\u8FDB\u4E0B\u4E00\u8F6E\u5FAA\u73AF\u91CD\u65B0\u6765\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">advanceTail</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> tn</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">					</span><span style="color:#676E95;">// CAS\u5C06\u65B0\u7684\u961F\u5C3E\u8282\u70B9\u8BBE\u7F6E\u4E3Atn\uFF0C\u6210\u4E0D\u6210\u529F\u90FD\u65E0\u6240\u8C13\uFF0C\u53CD\u6B63\u8FD9\u4E00\u8F6E\u80AF\u5B9A\u6CA1\u620F\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">continue</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">timed </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> nanos </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">        </span><span style="color:#676E95;">// \u8D85\u65F6\u8FD4\u56DEnull</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span></span>
<span class="line"><span style="color:#A6ACCD;">                s </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">QNode</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> isData</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6784\u9020\u5F53\u524D\u7ED3\u70B9\uFF0C\u51C6\u5907\u52A0\u5165\u7B49\u5F85\u961F\u5217</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">casNext</span><span style="color:#89DDFF;">(null,</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;">        </span><span style="color:#676E95;">// CAS\u6DFB\u52A0\u5F53\u524D\u8282\u70B9\u4E3A\u5C3E\u7ED3\u70B9\u7684\u4E0B\u4E00\u4E2A\uFF0C\u5982\u679C\u5931\u8D25\u80AF\u5B9A\u5176\u4ED6\u7EBF\u7A0B\u53C8\u62A2\u5148\u505A\u4E86\uFF0C\u76F4\u63A5\u8FDB\u4E0B\u4E00\u8F6E\u5FAA\u73AF\u91CD\u65B0\u6765</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">continue</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">advanceTail</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">              </span><span style="color:#676E95;">// \u4E0A\u9762\u7684\u64CD\u4F5C\u57FA\u672COK\u4E86\uFF0C\u90A3\u4E48\u65B0\u7684\u961F\u5C3E\u5143\u7D20\u5C31\u4FEE\u6539\u4E3As</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">Object</span><span style="color:#A6ACCD;"> x </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">awaitFulfill</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> timed</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> nanos</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5F00\u59CB\u7B49\u5F85s\u6240\u5BF9\u5E94\u7684\u6D88\u8D39\u8005\u6216\u662F\u751F\u4EA7\u8005\u8FDB\u884C\u4EA4\u63A5\uFF0C\u6BD4\u5982s\u73B0\u5728\u662F\u751F\u4EA7\u8005\uFF0C\u90A3\u4E48\u5B83\u5C31\u9700\u8981\u7B49\u5230\u4E00\u4E2A\u6D88\u8D39\u8005\u7684\u5230\u6765\u624D\u4F1A\u7EE7\u7EED\uFF08\u8FD9\u4E2A\u65B9\u6CD5\u4F1A\u5148\u8FDB\u884C\u81EA\u65CB\u7B49\u5F85\u5339\u914D\uFF0C\u5982\u679C\u81EA\u65CB\u4E00\u5B9A\u6B21\u6570\u540E\u8FD8\u662F\u6CA1\u6709\u5339\u914D\u6210\u529F\uFF0C\u90A3\u4E48\u5C31\u6302\u8D77\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">                   </span><span style="color:#676E95;">// \u5982\u679C\u8FD4\u56DEs\u672C\u8EAB\u8BF4\u660E\u7B49\u5F85\u72B6\u6001\u4E0B\u88AB\u53D6\u6D88</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">clean</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isOffList</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">           </span><span style="color:#676E95;">// \u5982\u679Cs\u64CD\u4F5C\u5B8C\u6210\u4E4B\u540E\u6CA1\u6709\u79BB\u5F00\u961F\u5217\uFF0C\u90A3\u4E48\u8FD9\u91CC\u5C06\u5176\u624B\u52A8\u4E22\u5F03</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">advanceHead</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;">// \u5C06s\u8BBE\u5B9A\u4E3A\u65B0\u7684\u9996\u8282\u70B9(\u6CE8\u610F\u5934\u8282\u70B9\u4EC5\u4F5C\u4E3A\u5934\u7ED3\u70B9\uFF0C\u5E76\u975E\u5904\u4E8E\u7B49\u5F85\u7684\u7EBF\u7A0B\u8282\u70B9)</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;">              </span><span style="color:#676E95;">// \u5220\u9664s\u5185\u7684\u5176\u4ED6\u4FE1\u606F</span></span>
<span class="line"><span style="color:#A6ACCD;">                    s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">item </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">waiter </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">E</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">x </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5047\u5982\u5F53\u524D\u662F\u6D88\u8D39\u8005\uFF0C\u76F4\u63A5\u8FD4\u56DEx\u5373\u53EF\uFF0Cx\u5C31\u662F\u4ECE\u751F\u4EA7\u8005\u90A3\u91CC\u62FF\u6765\u7684\u5143\u7D20</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">                            </span><span style="color:#676E95;">// \u8FD9\u79CD\u60C5\u51B5\u4E0B\u5C31\u662F\u4E0E\u961F\u5217\u4E2D\u7ED3\u70B9\u7C7B\u578B\u5339\u914D\u7684\u60C5\u51B5\u4E86\uFF08\u6CE8\u610F\u961F\u5217\u8981\u4E48\u4E3A\u7A7A\u8981\u4E48\u53EA\u4F1A\u5B58\u5728\u4E00\u79CD\u7C7B\u578B\u7684\u8282\u70B9\uFF0C\u56E0\u4E3A\u4E00\u65E6\u51FA\u73B0\u4E0D\u540C\u7C7B\u578B\u7684\u8282\u70B9\u9A6C\u4E0A\u4F1A\u88AB\u4EA4\u63A5\u6389\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">QNode</span><span style="color:#A6ACCD;"> m </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> h</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">next</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">               </span><span style="color:#676E95;">// \u83B7\u53D6\u5934\u7ED3\u70B9\u7684\u4E0B\u4E00\u4E2A\u63A5\u53E3\uFF0C\u51C6\u5907\u8FDB\u884C\u4EA4\u63A5\u5DE5\u4F5C</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> tail </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> m </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> h </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> head</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">continue</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">                   </span><span style="color:#676E95;">// \u5224\u65AD\u5176\u4ED6\u7EBF\u7A0B\u662F\u5426\u5148\u4FEE\u6539\uFF0C\u5982\u679C\u4FEE\u6539\u8FC7\u90A3\u4E48\u5F00\u4E0B\u4E00\u8F6E</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">Object</span><span style="color:#A6ACCD;"> x </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">item</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">isData </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">// \u5224\u65AD\u8282\u70B9\u7C7B\u578B\uFF0C\u5982\u679C\u662F\u76F8\u540C\u7684\u64CD\u4F5C\uFF0C\u90A3\u80AF\u5B9A\u4E5F\u662F\u6709\u95EE\u9898\u7684</span></span>
<span class="line"><span style="color:#A6ACCD;">                x </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> m </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;">                   </span><span style="color:#676E95;">// \u6216\u662F\u5F53\u524D\u64CD\u4F5C\u88AB\u53D6\u6D88</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">m</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">casItem</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;">// \u4E0A\u9762\u90FD\u4E0D\u662F\uFF1F\u90A3\u4E48\u6700\u540E\u518D\u8FDB\u884CCAS\u66FF\u6362m\u4E2D\u7684\u5143\u7D20\uFF0C\u6210\u529F\u8868\u793A\u4EA4\u63A5\u6210\u529F\uFF0C\u5931\u8D25\u5C31\u8001\u8001\u5B9E\u5B9E\u91CD\u5F00\u5427</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">advanceHead</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">h</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> m</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;">// dequeue and retry</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">continue</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">advanceHead</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">h</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> m</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">              </span><span style="color:#676E95;">// \u6210\u529F\u4EA4\u63A5\uFF0C\u65B0\u7684\u5934\u7ED3\u70B9\u53EF\u4EE5\u6539\u4E3Am\u4E86\uFF0C\u539F\u6709\u7684\u5934\u7ED3\u70B9\u76F4\u63A5\u4E0D\u8981\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">            LockSupport</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unpark</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">m</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">waiter</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">// m\u4E2D\u7684\u7B49\u5F85\u4EA4\u63A5\u7684\u7EBF\u7A0B\u53EF\u4EE5\u7EE7\u7EED\u4E86\uFF0C\u5DF2\u7ECF\u4EA4\u63A5\u5B8C\u6210</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">E</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">x </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">// \u540C\u4E0A\uFF0C\u8BE5\u8FD4\u56DE\u4EC0\u4E48\u5C31\u8FD4\u56DE\u4EC0\u4E48</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u603B\u7ED3\u4E3A\u4EE5\u4E0B\u6D41\u7A0B\uFF1A</p><p><img src="`+v+`" alt="image-20220406103844984"></p><p>\u5BF9\u4E8E<strong>\u975E\u516C\u5E73\u6A21\u5F0F</strong>\u4E0B\u7684SynchronousQueue\uFF0C\u5219\u662F\u91C7\u7528\u7684\u6808\u7ED3\u6784\u6765\u5B58\u50A8\u7B49\u5F85\u8282\u70B9</p><h5 id="linkedtransferqueue" tabindex="-1"><code>LinkedTransferQueue</code> <a class="header-anchor" href="#linkedtransferqueue" aria-hidden="true">#</a></h5><p>\u5728JDK7\u7684\u65F6\u5019\uFF0C\u57FA\u4E8ESynchronousQueue\u4EA7\u751F\u4E86\u4E00\u4E2A\u66F4\u5F3A\u5927\u7684TransferQueue\uFF0C\u5B83\u4FDD\u7559\u4E86SynchronousQueue\u7684\u5339\u914D\u4EA4\u63A5\u673A\u5236\uFF0C\u5E76\u4E14\u4E0E\u7B49\u5F85\u961F\u5217\u8FDB\u884C\u878D\u5408\u3002</p><p>SynchronousQueue\u5E76\u6CA1\u6709\u4F7F\u7528\u9501\uFF0C\u800C\u662F\u91C7\u7528CAS\u64CD\u4F5C\u4FDD\u8BC1\u751F\u4EA7\u8005\u4E0E\u6D88\u8D39\u8005\u7684\u534F\u8C03\uFF0C\u4F46\u662F\u5B83\u6CA1\u6709\u5BB9\u91CF\uFF0C\u800CLinkedBlockingQueue\u867D\u7136\u662F\u6709\u5BB9\u91CF\u4E14\u65E0\u754C\u7684\uFF0C\u4F46\u662F\u5185\u90E8\u57FA\u672C\u90FD\u662F\u57FA\u4E8E\u9501\u5B9E\u73B0\u7684\uFF0C\u6027\u80FD\u5E76\u4E0D\u662F\u5F88\u597D\uFF0C\u8FD9\u65F6\uFF0C\u6211\u4EEC\u5C31\u53EF\u4EE5\u5C06\u5B83\u4EEC\u5404\u81EA\u7684\u4F18\u70B9\u5355\u72EC\u62FF\u51FA\u6765\uFF0C\u63C9\u5728\u4E00\u8D77\uFF0C\u5C31\u6210\u4E86\u6027\u80FD\u66F4\u9AD8\u7684LinkedTransferQueue</p><p>\u76F8\u6BD4 <code>SynchronousQueue</code> \uFF0C\u5B83\u591A\u4E86\u4E00\u4E2A\u53EF\u4EE5\u5B58\u50A8\u7684\u961F\u5217\uFF0C\u6211\u4EEC\u4F9D\u7136\u53EF\u4EE5\u50CF\u963B\u585E\u961F\u5217\u90A3\u6837\u83B7\u53D6\u961F\u5217\u4E2D\u6240\u6709\u5143\u7D20\u7684\u503C\uFF0C\u7B80\u5355\u6765\u8BF4\uFF0C<code>LinkedTransferQueue</code>\u5176\u5B9E\u5C31\u662F\u4E00\u4E2A\u591A\u4E86\u5B58\u50A8\u961F\u5217\u7684<code>SynchronousQueue</code>\u3002</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">LinkedTransferQueue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> queue </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">LinkedTransferQueue</span><span style="color:#89DDFF;">&lt;&gt;();</span></span>
<span class="line"><span style="color:#A6ACCD;">    queue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">put</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//\u63D2\u5165\u65F6\uFF0C\u4F1A\u5148\u68C0\u67E5\u662F\u5426\u6709\u5176\u4ED6\u7EBF\u7A0B\u7B49\u5F85\u83B7\u53D6\uFF0C\u5982\u679C\u662F\uFF0C\u76F4\u63A5\u8FDB\u884C\u4EA4\u63A5\uFF0C\u5426\u5219\u63D2\u5165\u5230\u5B58\u50A8\u961F\u5217\u4E2D</span></span>
<span class="line"><span style="color:#A6ACCD;">   	queue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">put</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//\u4E0D\u4F1A\u50CFSynchronousQueue\u90A3\u6837\u5FC5\u987B\u7B49\u4E00\u4E2A\u5339\u914D\u7684\u624D\u53EF\u4EE5</span></span>
<span class="line"><span style="color:#A6ACCD;">    queue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">forEach</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">::</span><span style="color:#A6ACCD;">println</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u76F4\u63A5\u6253\u5370\u6240\u6709\u7684\u5143\u7D20\uFF0C\u8FD9\u5728SynchronousQueue\u4E0B\u53EA\u80FD\u662F\u7A7A\uFF0C\u56E0\u4E3A\u5355\u72EC\u7684\u5165\u961F\u6216\u51FA\u961F\u64CD\u4F5C\u90FD\u4F1A\u88AB\u963B\u585E</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="priorityblockingqueue" tabindex="-1"><code>PriorityBlockingQueue </code> <a class="header-anchor" href="#priorityblockingqueue" aria-hidden="true">#</a></h5><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u53EF\u4EE5\u6307\u5B9A\u521D\u59CB\u5BB9\u91CF\uFF08\u53EF\u6269\u5BB9\uFF09\u548C\u4F18\u5148\u7EA7\u6BD4\u8F83\u89C4\u5219\uFF0C\u8FD9\u91CC\u6211\u4EEC\u4F7F\u7528\u5347\u5E8F</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">PriorityBlockingQueue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Integer</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> queue </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">PriorityBlockingQueue</span><span style="color:#89DDFF;">&lt;&gt;(</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Integer</span><span style="color:#89DDFF;">::</span><span style="color:#A6ACCD;">compare</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">    queue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    queue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    queue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u6CE8\u610F\u4FDD\u5B58\u987A\u5E8F\u5E76\u4E0D\u4F1A\u6309\u7167\u4F18\u5148\u7EA7\u6392\u5217\uFF0C\u6240\u4EE5\u53EF\u4EE5\u770B\u5230\u7ED3\u679C\u5E76\u4E0D\u662F\u6392\u5E8F\u540E\u7684\u7ED3\u679C</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">queue</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u4F46\u662F\u51FA\u961F\u987A\u5E8F\u4E00\u5B9A\u662F\u6309\u7167\u4F18\u5148\u7EA7\u8FDB\u884C\u7684</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">queue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">poll</span><span style="color:#89DDFF;">());</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">queue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">poll</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">queue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">poll</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="delayqueue" tabindex="-1"><code>DelayQueue</code> <a class="header-anchor" href="#delayqueue" aria-hidden="true">#</a></h5><p>\u5B9E\u73B0\u5EF6\u65F6\u51FA\u961F\uFF0C\u4E5F\u5C31\u662F\u8BF4\u5F53\u4E00\u4E2A\u5143\u7D20\u63D2\u5165\u540E\uFF0C\u5982\u679C\u6CA1\u6709\u8D85\u8FC7\u4E00\u5B9A\u65F6\u95F4\uFF0C\u90A3\u4E48\u662F\u65E0\u6CD5\u8BA9\u6B64\u5143\u7D20\u51FA\u961F\u7684\u3002</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">DelayQueue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Delayed</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">AbstractQueue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">E</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">implements</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">BlockingQueue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">E</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{...}</span></span>
<span class="line"></span></code></pre></div><p>\u6B64\u7C7B\u53EA\u63A5\u53D7Delayed\u7684\u5B9E\u73B0\u7C7B\u4F5C\u4E3A\u5143\u7D20\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">// \u8FD9\u91CC\u7EE7\u627F\u4E86Comparable\uFF0C\u5B83\u652F\u6301\u4F18\u5148\u7EA7</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">interface</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Delayed</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Comparable</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Delayed</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u83B7\u53D6\u5269\u4F59\u7B49\u5F85\u65F6\u95F4\uFF0C\u6B63\u6570\u8868\u793A\u8FD8\u9700\u8981\u8FDB\u884C\u7B49\u5F85\uFF0C0\u6216\u8D1F\u6570\u8868\u793A\u7B49\u5F85\u7ED3\u675F</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getDelay</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">TimeUnit</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">unit</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><blockquote><p>\u624B\u52A8\u5B9E\u73B0\u4E00\u4E2A<code>Test.class</code>\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Test</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">implements</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Delayed</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> time</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5EF6\u8FDF\u65F6\u95F4\uFF0C\u8FD9\u91CC\u4EE5\u6BEB\u79D2\u4E3A\u5355\u4F4D</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> priority</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> startTime</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Test</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">time</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">priority</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">time </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toMillis</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">time</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u79D2\u8F6C\u6362\u4E3A\u6BEB\u79D2</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">priority </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> priority</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">startTime </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8FD9\u91CC\u6211\u4EEC\u4EE5\u6BEB\u79D2\u4E3A\u5355\u4F4D</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">data </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getDelay</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">TimeUnit</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">unit</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> leftTime </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> time </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> startTime</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">//\u8BA1\u7B97\u5269\u4F59\u65F6\u95F4 = \u8BBE\u5B9A\u65F6\u95F4 - \u5DF2\u5EA6\u8FC7\u65F6\u95F4(= \u5F53\u524D\u65F6\u95F4 - \u5F00\u59CB\u65F6\u95F4)</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> unit</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">convert</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">leftTime</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">MILLISECONDS</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6CE8\u610F\u8FDB\u884C\u5355\u4F4D\u8F6C\u6362\uFF0C\u5355\u4F4D\u7531\u961F\u5217\u6307\u5B9A\uFF08\u9ED8\u8BA4\u662F\u7EB3\u79D2\u5355\u4F4D\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">compareTo</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Delayed</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">o</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">if</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">o </span><span style="color:#89DDFF;">instanceof</span><span style="color:#A6ACCD;"> Test</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">           </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> priority </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">Test</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> o</span><span style="color:#89DDFF;">).</span><span style="color:#A6ACCD;">priority</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u4F18\u5148\u7EA7\u8D8A\u5C0F\u8D8A\u4F18\u5148</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">toString</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">DelayQueue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Test</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> queue </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">DelayQueue</span><span style="color:#89DDFF;">&lt;&gt;();</span></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;">// 1\u79D2\u949F\u5EF6\u65F6</span></span>
<span class="line"><span style="color:#A6ACCD;">   queue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Test</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">2\u53F7</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;">// 1\u79D2\u949F\u5EF6\u65F6\uFF0C\u4F18\u5148\u7EA7\u6700\u9AD8</span></span>
<span class="line"><span style="color:#A6ACCD;">   queue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Test</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1\u53F7</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// \u6CE8\u610F\u51FA\u961F\u987A\u5E8F\u662F\u4F9D\u7167\u4F18\u5148\u7EA7\u6765\u7684\uFF0C\u5373\u4F7F\u4E00\u4E2A\u5143\u7D20\u5DF2\u7ECF\u53EF\u4EE5\u51FA\u961F\u4E86\uFF0C\u4F9D\u7136\u9700\u8981\u7B49\u5F85\u4F18\u5148\u7EA7\u66F4\u9AD8\u7684\u5143\u7D20\u5230\u671F</span></span>
<span class="line"><span style="color:#A6ACCD;">   System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">queue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">take</span><span style="color:#89DDFF;">());</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">   System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">queue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">take</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div></blockquote><p><code>add()</code>\u65B9\u6CD5\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">offer</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">offer</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u6CE8\u610F\u8FD9\u91CC\u662F\u5411\u5185\u90E8\u7EF4\u62A4\u7684\u4E00\u4E2A\u4F18\u5148\u7EA7\u961F\u5217\u6DFB\u52A0\u5143\u7D20\uFF0C\u5E76\u4E0D\u662FDelayQueue\u672C\u8EAB\u5B58\u50A8\u5143\u7D20</span></span>
<span class="line"><span style="color:#A6ACCD;">        q</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">offer</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u5982\u679C\u5165\u961F\u540E\u961F\u9996\u5C31\u662F\u5F53\u524D\u5143\u7D20\uFF0C\u90A3\u4E48\u76F4\u63A5\u8FDB\u884C\u4E00\u6B21\u5524\u9192\u64CD\u4F5C\uFF08\u56E0\u4E3A\u6709\u53EF\u80FD\u4E4B\u524D\u5C31\u6709\u5176\u4ED6\u7EBF\u7A0B\u7B49\u7740take\u4E86\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">q</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">peek</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">            leader </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#A6ACCD;">            available</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">signal</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">put</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">offer</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><code>take()</code>\u65B9\u6CD5\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">take</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u51FA\u961F\u4E5F\u8981\u5148\u52A0\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">    lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lockInterruptibly</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u65E0\u9650\u5FAA\u73AF\u64CD\u4F5C</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(;;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u83B7\u53D6\u961F\u9996\u5143\u7D20</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">E</span><span style="color:#A6ACCD;"> first </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> q</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">peek</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u5982\u679C\u4E3A\u7A7A\u90A3\u80AF\u5B9A\u961F\u5217\u4E3A\u7A7A\uFF0C\u5148\u7B49\u7740\u5427\uFF0C\u7B49\u6709\u5143\u7D20\u8FDB\u6765</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">first </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">                available</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">                </span><span style="color:#676E95;">// \u83B7\u53D6\u5EF6\u8FDF\uFF0C\u8FD9\u91CC\u4F20\u5165\u7684\u65F6\u95F4\u5355\u4F4D\u662F\u7EB3\u79D2</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> delay </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> first</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getDelay</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">NANOSECONDS</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">delay </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">                    </span><span style="color:#676E95;">// \u5982\u679C\u83B7\u53D6\u5230\u5EF6\u8FDF\u65F6\u95F4\u5DF2\u7ECF\u5C0F\u4E8E0\u4E86\uFF0C\u90A3\u8BF4\u660Eok\uFF0C\u53EF\u4EE5\u76F4\u63A5\u51FA\u961F\u8FD4\u56DE</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> q</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">poll</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">                first </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#89DDFF;">                </span><span style="color:#676E95;">// \u8FD9\u91CC\u7528leader\u6765\u51CF\u5C11\u4E0D\u5FC5\u8981\u7684\u7B49\u5F85\u65F6\u95F4\uFF0C\u5982\u679C\u4E0D\u662Fnull\u90A3\u8BF4\u660E\u6709\u7EBF\u7A0B\u5728\u7B49\u5F85\uFF0C\u4E3Anull\u8BF4\u660E\u6CA1\u6709\u7EBF\u7A0B\u7B49\u5F85</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">leader </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;">                    </span><span style="color:#676E95;">// \u5982\u679C\u5176\u4ED6\u7EBF\u7A0B\u5DF2\u7ECF\u5728\u7B49\u5143\u7D20\u4E86\uFF0C\u90A3\u4E48\u5F53\u524D\u7EBF\u7A0B\u76F4\u63A5\u8FDB\u6C38\u4E45\u7B49\u5F85\u72B6\u6001</span></span>
<span class="line"><span style="color:#A6ACCD;">                    available</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#C792EA;">Thread</span><span style="color:#A6ACCD;"> thisThread </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">                     </span><span style="color:#676E95;">// \u6CA1\u6709\u7EBF\u7A0B\u7B49\u5F85\u5C31\u5C06leader\u8BBE\u5B9A\u4E3A\u5F53\u524D\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">                    leader </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> thisThread</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">                        </span><span style="color:#676E95;">// \u83B7\u53D6\u5230\u7684\u5EF6\u8FDF\u5927\u4E8E0\uFF0C\u90A3\u4E48\u5C31\u9700\u8981\u7B49\u5F85\u5EF6\u8FDF\u65F6\u95F4\uFF0C\u518D\u5F00\u59CB\u4E0B\u4E00\u6B21\u83B7\u53D6</span></span>
<span class="line"><span style="color:#A6ACCD;">                        available</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">awaitNanos</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">delay</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">leader </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> thisThread</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                            leader </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">leader </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> q</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">peek</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u5F53\u524Dtake\u7ED3\u675F\u4E4B\u540E\u5524\u9192\u4E00\u4E2A\u5176\u4ED6\u6C38\u4E45\u7B49\u5F85\u72B6\u6001\u4E0B\u7684\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">            available</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">signal</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u89E3\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">        lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="\u539F\u5B50\u7C7B" tabindex="-1">\u539F\u5B50\u7C7B <a class="header-anchor" href="#\u539F\u5B50\u7C7B" aria-hidden="true">#</a></h4><ul><li><p>AtomicInteger\uFF1A\u539F\u5B50\u66F4\u65B0int</p></li><li><p>AtomicLong\uFF1A\u539F\u5B50\u66F4\u65B0long</p></li><li><p>AtomicBoolean\uFF1A\u539F\u5B50\u66F4\u65B0boolean</p></li><li><p>AtomicIntegerArray\uFF1A\u539F\u5B50\u66F4\u65B0int\u6570\u7EC4</p></li><li><p>AtomicLongArray\uFF1A\u539F\u5B50\u66F4\u65B0long\u6570\u7EC4</p></li><li><p>AtomicReferenceArray\uFF1A\u539F\u5B50\u66F4\u65B0\u5F15\u7528\u6570\u7EC4</p></li><li><p>DoubleAdder</p></li><li><p>LongAdder</p></li><li><p>AtomicReference\uFF1A\u5F15\u7528\u7C7B\u578B</p></li><li><p>AtomicIntegerFieldUpdater\uFF1A\u5B57\u6BB5\u539F\u5B50\u66F4\u65B0\u5668</p></li></ul><h5 id="atomicinteger\u89E3\u6790" tabindex="-1"><code>AtomicInteger</code>\u89E3\u6790 <a class="header-anchor" href="#atomicinteger\u89E3\u6790" aria-hidden="true">#</a></h5><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> value</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">AtomicInteger</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> initialValue</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    value </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> initialValue</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">AtomicInteger</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><code>\u6784\u9020\u65B9\u6CD5</code></p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Unsafe</span><span style="color:#A6ACCD;"> unsafe </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Unsafe</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getUnsafe</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> valueOffset</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        valueOffset </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> unsafe</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">objectFieldOffset</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">AtomicInteger</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getDeclaredField</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">value</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Exception</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">ex</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Error</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ex</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u53EF\u4EE5\u770B\u5230\u6700\u4E0A\u9762\u662F\u548CAQS\u91C7\u7528\u4E86\u7C7B\u4F3C\u7684\u673A\u5236\uFF0C\u56E0\u4E3A\u8981\u4F7F\u7528CAS\u7B97\u6CD5\u66F4\u65B0value\u7684\u503C\uFF0C\u6240\u4EE5\u5F97\u5148\u8BA1\u7B97\u51FAvalue\u5B57\u6BB5\u5728\u5BF9\u8C61\u4E2D\u7684\u504F\u79FB\u5730\u5740\uFF0CCAS\u76F4\u63A5\u4FEE\u6539\u5BF9\u5E94\u4F4D\u7F6E\u7684\u5185\u5B58\u5373\u53EF\uFF08\u53EF\u89C1Unsafe\u7C7B\u7684\u4F5C\u7528\u5DE8\u5927\uFF0C\u5F88\u591A\u7684\u5E95\u5C42\u64CD\u4F5C\u90FD\u8981\u9760\u5B83\u6765\u5B8C\u6210\uFF09</p><p>\u81EA\u589E\u64CD\u4F5C\u662F\u600E\u4E48\u5728\u8FD0\u884C\u7684\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getAndIncrement</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> unsafe</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getAndAddInt</span><span style="color:#89DDFF;">(this,</span><span style="color:#A6ACCD;"> valueOffset</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u8C03\u7528\u4E86<code>unsafe.getAndAddInt()</code>\uFF0C\u6211\u4EEC\u63A5\u7740\u770B\u770BUnsafe\u91CC\u9762\u5199\u4E86\u4EC0\u4E48\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getAndAddInt</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Object</span><span style="color:#A6ACCD;"> o</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> offset</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> delta</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//delta\u5C31\u662F\u53D8\u5316\u7684\u503C\uFF0C++\u64CD\u4F5C\u5C31\u662F\u81EA\u589E1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> v</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">do</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//volatile\u7248\u672C\u7684getInt()</span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//\u80FD\u591F\u4FDD\u8BC1\u53EF\u89C1\u6027</span></span>
<span class="line"><span style="color:#A6ACCD;">        v </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getIntVolatile</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">o</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> offset</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#82AAFF;">compareAndSwapInt</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">o</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> offset</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> v</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> v </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> delta</span><span style="color:#89DDFF;">));</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//\u8FD9\u91CC\u662F\u5F00\u59CBcas\u66FF\u6362int\u7684\u503C\uFF0C\u6BCF\u6B21\u90FD\u53BB\u62FF\u6700\u65B0\u7684\u503C\u53BB\u8FDB\u884C\u66FF\u6362\uFF0C\u5982\u679C\u6210\u529F\u5219\u79BB\u5F00\u5FAA\u73AF\uFF0C\u4E0D\u6210\u529F\u8BF4\u660E\u8FD9\u4E2A\u65F6\u5019\u5176\u4ED6\u7EBF\u7A0B\u5148\u4FEE\u6539\u4E86\u503C\uFF0C\u5C31\u8FDB\u4E0B\u4E00\u6B21\u5FAA\u73AF\u518D\u83B7\u53D6\u6700\u65B0\u7684\u503C\u7136\u540E\u518Dcas\u4E00\u6B21\uFF0C\u76F4\u5230\u6210\u529F\u4E3A\u6B62</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> v</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u8FD9\u662F\u4E00\u4E2A<code>do-while</code>\u5FAA\u73AF\uFF0C\u91C7\u7528\u81EA\u65CB\u5F62\u5F0F\uFF0C\u6765\u4E0D\u65AD\u8FDB\u884CCAS\u64CD\u4F5C\uFF0C\u76F4\u5230\u6210\u529F\u3002</p><p><img src="`+S+`" alt="image-20220308131536403"></p><p>\u53EF\u89C1\uFF0C\u539F\u5B50\u7C7B\u5E95\u5C42\u4E5F\u662F\u91C7\u7528\u4E86CAS\u7B97\u6CD5\u6765\u4FDD\u8BC1\u7684\u539F\u5B50\u6027\uFF0C\u5305\u62EC<code>getAndSet</code>\u3001<code>getAndAdd</code>\u7B49\u65B9\u6CD5\u90FD\u662F\u8FD9\u6837\u3002\u539F\u5B50\u7C7B\u4E5F\u76F4\u63A5\u63D0\u4F9B\u4E86CAS\u64CD\u4F5C\u65B9\u6CD5\uFF0C\u6211\u4EEC\u53EF\u4EE5\u76F4\u63A5\u4F7F\u7528\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">AtomicInteger</span><span style="color:#A6ACCD;"> integer </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">AtomicInteger</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">integer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">compareAndSet</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">30</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">20</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">integer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">compareAndSet</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">20</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">integer</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5982\u679C\u60F3\u4EE5\u666E\u901A\u53D8\u91CF\u7684\u65B9\u5F0F\u6765\u8BBE\u5B9A\u503C\uFF0C\u90A3\u4E48\u53EF\u4EE5\u4F7F\u7528<code>lazySet()</code>\u65B9\u6CD5\uFF0C\u8FD9\u6837\u5C31\u4E0D\u91C7\u7528<code>volatile</code>\u7684\u7ACB\u5373\u53EF\u89C1\u673A\u5236\u4E86</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">AtomicInteger</span><span style="color:#A6ACCD;"> integer </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">AtomicInteger</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">integer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lazySet</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre></div><h5 id="atomicintegerarray\u89E3\u6790" tabindex="-1"><code>AtomicIntegerArray</code>\u89E3\u6790 <a class="header-anchor" href="#atomicintegerarray\u89E3\u6790" aria-hidden="true">#</a></h5><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">AtomicIntegerArray</span><span style="color:#A6ACCD;"> array </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">AtomicIntegerArray</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#89DDFF;">[]{</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> r </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100000</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span></span>
<span class="line"><span style="color:#A6ACCD;">            array</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getAndAdd</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">r</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">r</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">array</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="longadder\u89E3\u6790" tabindex="-1"><code>LongAdder</code>\u89E3\u6790 <a class="header-anchor" href="#longadder\u89E3\u6790" aria-hidden="true">#</a></h5><p>\u5728JDK8\u4E4B\u540E\uFF0C\u65B0\u589E\u4E86<code>DoubleAdder</code>\u548C<code>LongAdder</code>\uFF0C\u5728\u9AD8\u5E76\u53D1\u60C5\u51B5\u4E0B\uFF0C<code>LongAdder</code>\u7684\u6027\u80FD\u6BD4<code>AtomicLong</code>\u7684\u6027\u80FD\u66F4\u597D\uFF0C\u4E3B\u8981\u4F53\u73B0\u5728\u81EA\u589E\u4E0A\uFF0C\u5B83\u7684\u5927\u81F4\u539F\u7406\u5982\u4E0B\uFF1A\u5728\u4F4E\u5E76\u53D1\u60C5\u51B5\u4E0B\uFF0C\u548C<code>AtomicLong</code>\u662F\u4E00\u6837\u7684\uFF0C\u5BF9value\u503C\u8FDB\u884CCAS\u64CD\u4F5C\uFF0C\u4F46\u662F\u51FA\u73B0\u9AD8\u5E76\u53D1\u7684\u60C5\u51B5\u65F6\uFF0C<code>AtomicLong</code>\u4F1A\u8FDB\u884C\u5927\u91CF\u7684\u5FAA\u73AF\u64CD\u4F5C\u6765\u4FDD\u8BC1\u540C\u6B65\uFF0C\u800C<code>LongAdder</code>\u4F1A\u5C06\u5BF9value\u503C\u7684CAS\u64CD\u4F5C\u5206\u6563\u4E3A\u5BF9\u6570\u7EC4<code>cells</code>\u4E2D\u591A\u4E2A\u5143\u7D20\u7684CAS\u64CD\u4F5C\uFF08\u5185\u90E8\u7EF4\u62A4\u4E00\u4E2ACell[] as\u6570\u7EC4\uFF0C\u6BCF\u4E2ACell\u91CC\u9762\u6709\u4E00\u4E2A\u521D\u59CB\u503C\u4E3A0\u7684long\u578B\u53D8\u91CF\uFF0C\u5728\u9AD8\u5E76\u53D1\u65F6\u4F1A\u8FDB\u884C\u5206\u6563CAS\uFF0C\u5C31\u662F\u4E0D\u540C\u7684\u7EBF\u7A0B\u53EF\u4EE5\u5BF9\u6570\u7EC4\u4E2D\u4E0D\u540C\u7684\u5143\u7D20\u8FDB\u884CCAS\u81EA\u589E\uFF0C\u8FD9\u6837\u5C31\u907F\u514D\u4E86\u6240\u6709\u7EBF\u7A0B\u90FD\u5BF9\u540C\u4E00\u4E2A\u503C\u8FDB\u884CCAS\uFF09\uFF0C\u53EA\u9700\u8981\u6700\u540E\u518D\u5C06\u7ED3\u679C\u52A0\u8D77\u6765\u5373\u53EF\u3002</p><p><img src="`+f+`" alt="image-20220406100926787"></p><p>\u4F7F\u7528\u5982\u4E0B\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">LongAdder</span><span style="color:#A6ACCD;"> adder </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">LongAdder</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> r </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100000</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span></span>
<span class="line"><span style="color:#A6ACCD;">            adder</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">r</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//100\u4E2A\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">    TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">adder</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sum</span><span style="color:#89DDFF;">());</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6700\u540E\u6C42\u548C\u5373\u53EF</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><code>LongAdder</code>&amp;<code>AtomicLong</code>\u6027\u80FD\u5BF9\u6BD4:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Main</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u4F7F\u7528AtomicLong\u7684\u65F6\u95F4\u6D88\u8017\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#82AAFF;">test2</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ms</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u4F7F\u7528LongAdder\u7684\u65F6\u95F4\u6D88\u8017\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#82AAFF;">test1</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ms</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">test1</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">CountDownLatch</span><span style="color:#A6ACCD;"> latch </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CountDownLatch</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">LongAdder</span><span style="color:#A6ACCD;"> adder </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">LongAdder</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> timeStart </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> r </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100000</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span></span>
<span class="line"><span style="color:#A6ACCD;">                adder</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            latch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">countDown</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">r</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        latch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> timeStart</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">test2</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">CountDownLatch</span><span style="color:#A6ACCD;"> latch </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CountDownLatch</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">AtomicLong</span><span style="color:#A6ACCD;"> atomicLong </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">AtomicLong</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> timeStart </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> r </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100000</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span></span>
<span class="line"><span style="color:#A6ACCD;">                atomicLong</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">incrementAndGet</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            latch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">countDown</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">r</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        latch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> timeStart</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="atomicreference\u89E3\u6790" tabindex="-1"><code>AtomicReference</code>\u89E3\u6790 <a class="header-anchor" href="#atomicreference\u89E3\u6790" aria-hidden="true">#</a></h5><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> a </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> b </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">World</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">AtomicReference</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> reference </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">AtomicReference</span><span style="color:#89DDFF;">&lt;&gt;(</span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    reference</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">compareAndSet</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> b</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">reference</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="atomicintegerfieldupdater\u89E3\u6790" tabindex="-1"><code>AtomicIntegerFieldUpdater</code>\u89E3\u6790 <a class="header-anchor" href="#atomicintegerfieldupdater\u89E3\u6790" aria-hidden="true">#</a></h5><p>JUC\u8FD8\u63D0\u4F9B\u4E86\u5B57\u6BB5\u539F\u5B50\u66F4\u65B0\u5668\uFF0C\u53EF\u4EE5\u5BF9\u7C7B\u4E2D\u7684\u67D0\u4E2A\u6307\u5B9A\u5B57\u6BB5\u8FDB\u884C\u539F\u5B50\u64CD\u4F5C\uFF08\u6CE8\u610F\u5B57\u6BB5\u5FC5\u987B\u6DFB\u52A0volatile\u5173\u952E\u5B57\uFF09\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Main</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Student</span><span style="color:#A6ACCD;"> student </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Student</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">AtomicIntegerFieldUpdater</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Student</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> fieldUpdater </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#A6ACCD;">                AtomicIntegerFieldUpdater</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newUpdater</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Student</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">age</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">fieldUpdater</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">incrementAndGet</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">student</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Student</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> age</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="\u5E76\u53D1\u5DE5\u5177\u7C7B" tabindex="-1">\u5E76\u53D1\u5DE5\u5177\u7C7B <a class="header-anchor" href="#\u5E76\u53D1\u5DE5\u5177\u7C7B" aria-hidden="true">#</a></h4><h5 id="countdownlatch-\u8BA1\u6570\u5668\u9501" tabindex="-1">CountDownLatch \u8BA1\u6570\u5668\u9501 <a class="header-anchor" href="#countdownlatch-\u8BA1\u6570\u5668\u9501" aria-hidden="true">#</a></h5><blockquote><p>\u5141\u8BB8\u4E00\u4E2A\u6216\u591A\u4E2A\u7EBF\u7A0B\uFF0C\u7B49\u5F85\u5176\u4ED6\u7EBF\u7A0B\u5B8C\u6210\u5DE5\u4F5C</p></blockquote><p><strong>\u5B9E\u73B0\u539F\u7406</strong>\uFF1A</p><ul><li>\u5229\u7528\u5171\u4EAB\u9501\u5B9E\u73B0</li><li>\u5728\u4E00\u5F00\u59CB\u7684\u65F6\u5019\u5C31\u662F\u5DF2\u7ECF\u4E0A\u4E86count\u5C42\u9501\u7684\u72B6\u6001\uFF0C\u4E5F\u5C31\u662F<code>state = count</code></li><li><code>await()</code>\u5C31\u662F\u52A0\u5171\u4EAB\u9501\uFF0C\u4F46\u662F\u5FC5\u987B<code>state</code>\u4E3A<code>0</code>\u624D\u80FD\u52A0\u9501\u6210\u529F\uFF0C\u5426\u5219\u6309\u7167AQS\u7684\u673A\u5236\uFF0C\u4F1A\u8FDB\u5165\u7B49\u5F85\u961F\u5217\u963B\u585E\uFF0C\u52A0\u9501\u6210\u529F\u540E\u7ED3\u675F\u963B\u585E</li><li><code>countDown()</code>\u5C31\u662F\u89E3<code>1</code>\u5C42\u9501\uFF0C\u4E5F\u5C31\u662F\u9760\u8FD9\u4E2A\u65B9\u6CD5\u4E00\u70B9\u4E00\u70B9\u628A<code>state</code>\u7684\u503C\u51CF\u5230<code>0</code></li></ul><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">CountDownLatch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">   	</span><span style="color:#676E95;">//\u540C\u6837\u662F\u901A\u8FC7\u5185\u90E8\u7C7B\u5B9E\u73B0AbstractQueuedSynchronizer</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sync</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">AbstractQueuedSynchronizer</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">Sync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">count</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8FD9\u91CC\u76F4\u63A5\u4F7F\u7528AQS\u7684state\u4F5C\u4E3A\u8BA1\u6570\u5668\uFF08\u53EF\u89C1state\u80FD\u88AB\u73A9\u51FA\u5404\u79CD\u82B1\u6837\uFF09\uFF0C\u4E5F\u5C31\u662F\u8BF4\u4E00\u5F00\u59CB\u5C31\u52A0\u4E86count\u628A\u5171\u4EAB\u9501\uFF0C\u5F53\u7EBF\u7A0B\u8C03\u7528countdown\u65F6\uFF0C\u5C31\u89E3\u4E00\u5C42\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">setState</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">count</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getCount</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getState</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//\u91C7\u7528\u5171\u4EAB\u9501\u673A\u5236\uFF0C\u56E0\u4E3A\u53EF\u4EE5\u88AB\u4E0D\u540C\u7684\u7EBF\u7A0Bcountdown\uFF0C\u6240\u4EE5\u5B9E\u73B0\u7684tryAcquireShared\u548CtryReleaseShared</span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//\u83B7\u53D6\u8FD9\u628A\u5171\u4EAB\u9501\u5176\u5B9E\u5C31\u662F\u53BB\u7B49\u5F85state\u88AB\u5176\u4ED6\u7EBF\u7A0B\u51CF\u52300</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryAcquireShared</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">acquires</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">getState</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryReleaseShared</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">releases</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u6BCF\u6B21\u6267\u884C\u90FD\u4F1A\u5C06state\u503C-1\uFF0C\u76F4\u5230\u4E3A0</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(;;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> c </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getState</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u5DF2\u7ECF\u662F0\u4E86\uFF0C\u90A3\u5C31false</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> nextc </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> c</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">compareAndSetState</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> nextc</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//CAS\u8BBE\u7F6Estate\u503C\uFF0C\u5931\u8D25\u76F4\u63A5\u4E0B\u4E00\u8F6E\u5FAA\u73AF</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> nextc </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u8FD4\u56DEc-1\u4E4B\u540E\uFF0C\u662F\u4E0D\u662F0\uFF0C\u5982\u679C\u662F\u90A3\u5C31true\uFF0C\u5426\u5219false\uFF0C\u4E5F\u5C31\u662F\u8BF4\u53EA\u6709\u521A\u597D\u51CF\u52300\u7684\u65F6\u5019\u624D\u4F1A\u8FD4\u56DEtrue</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Sync</span><span style="color:#A6ACCD;"> sync</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CountDownLatch</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">count</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">count </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IllegalArgumentException</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">count &lt; 0</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//count\u90A3\u80AF\u5B9A\u4E0D\u80FD\u5C0F\u4E8E0\u554A</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">sync </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Sync</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">count</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6784\u9020Sync\u5BF9\u8C61\uFF0C\u5C06count\u4F5C\u4E3Astate\u521D\u59CB\u503C</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">   	</span><span style="color:#676E95;">//\u901A\u8FC7acquireSharedInterruptibly\u65B9\u6CD5\u83B7\u53D6\u5171\u4EAB\u9501\uFF0C\u4F46\u662F\u5982\u679Cstate\u4E0D\u4E3A0\uFF0C\u90A3\u4E48\u4F1A\u88AB\u6301\u7EED\u963B\u585E\uFF0C\u8BE6\u7EC6\u539F\u7406\u4E0B\u9762\u8BB2</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        sync</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">acquireSharedInterruptibly</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//\u540C\u4E0A\uFF0C\u4F46\u662F\u4F1A\u8D85\u65F6</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">timeout</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TimeUnit</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">unit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> sync</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">tryAcquireSharedNanos</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> unit</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toNanos</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">timeout</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">   	</span><span style="color:#676E95;">//countDown\u5176\u5B9E\u5C31\u662F\u89E3\u9501\u4E00\u6B21</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">countDown</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        sync</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">releaseShared</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//\u83B7\u53D6\u5F53\u524D\u7684\u8BA1\u6570\uFF0C\u4E5F\u5C31\u662FAQS\u4E2Dstate\u7684\u503C</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getCount</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> sync</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getCount</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//\u8FD9\u4E2A\u5C31\u4E0D\u8BF4\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">toString</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> super</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">[Count = </span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> sync</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getCount</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">]</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h6 id="\u5171\u4EAB\u9501\u5B9E\u73B0" tabindex="-1">\u5171\u4EAB\u9501\u5B9E\u73B0 <a class="header-anchor" href="#\u5171\u4EAB\u9501\u5B9E\u73B0" aria-hidden="true">#</a></h6><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">acquireShared</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> arg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">tryAcquireShared</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u4E0A\u6765\u5C31\u8C03\u7528tryAcquireShared\u5C1D\u8BD5\u4EE5\u5171\u4EAB\u6A21\u5F0F\u83B7\u53D6\u9501\uFF0C\u5C0F\u4E8E0\u5219\u5931\u8D25\uFF0C\u4E0A\u9762\u5224\u65AD\u7684\u662Fstate==0\u8FD4\u56DE1\uFF0C\u5426\u5219-1\uFF0C\u4E5F\u5C31\u662F\u8BF4\u5982\u679C\u8BA1\u6570\u5668\u4E0D\u4E3A0\uFF0C\u90A3\u4E48\u8FD9\u91CC\u4F1A\u5224\u65AD\u6210\u529F</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">doAcquireShared</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8BA1\u6570\u5668\u4E0D\u4E3A0\u7684\u65F6\u5019\uFF0C\u6309\u7167\u5B83\u7684\u673A\u5236\uFF0C\u90A3\u4E48\u4F1A\u963B\u585E\uFF0C\u6240\u4EE5\u6211\u4EEC\u6765\u770B\u770BdoAcquireShared\u4E2D\u662F\u600E\u4E48\u8FDB\u884C\u963B\u585E\u7684</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">doAcquireShared</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> arg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> node </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">addWaiter</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SHARED</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5411\u7B49\u5F85\u961F\u5217\u4E2D\u6DFB\u52A0\u4E00\u4E2A\u65B0\u7684\u5171\u4EAB\u6A21\u5F0F\u7ED3\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> failed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> interrupted </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(;;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u65E0\u9650\u5FAA\u73AF</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> p </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">predecessor</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u83B7\u53D6\u5F53\u524D\u8282\u70B9\u7684\u524D\u9A71\u7684\u7ED3\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> head</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5982\u679Cp\u5C31\u662F\u5934\u7ED3\u70B9\uFF0C\u90A3\u4E48\u8BF4\u660E\u5F53\u524D\u7ED3\u70B9\u5C31\u662F\u7B2C\u4E00\u4E2A\u7B49\u5F85\u8282\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> r </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryAcquireShared</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u4F1A\u518D\u6B21\u5C1D\u8BD5\u83B7\u53D6\u5171\u4EAB\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">r </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;">//\u8981\u662F\u83B7\u53D6\u6210\u529F</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#82AAFF;">setHeadAndPropagate</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> r</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u90A3\u4E48\u5C31\u5C06\u5F53\u524D\u8282\u70B9\u8BBE\u5B9A\u4E3A\u65B0\u7684\u5934\u7ED3\u70B9\uFF0C\u5E76\u4E14\u4F1A\u7EE7\u7EED\u5524\u9192\u540E\u7EE7\u8282\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">                    p</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">next </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// help GC</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">interrupted</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#82AAFF;">selfInterrupt</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                    failed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">shouldParkAfterFailedAcquire</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u548C\u72EC\u5360\u6A21\u5F0F\u4E0B\u4E00\u6837\u7684\u64CD\u4F5C\uFF0C\u8FD9\u91CC\u4E0D\u591A\u8BF4\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">parkAndCheckInterrupt</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">                interrupted </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">failed</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">cancelAcquire</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u6700\u540E\u90FD\u8FD8\u662F\u6CA1\u83B7\u53D6\u5230\uFF0C\u90A3\u4E48\u5C31cancel</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#676E95;">//\u5176\u5B9E\u611F\u89C9\u5927\u4F53\u4E0A\u548C\u72EC\u5360\u6A21\u5F0F\u7684\u83B7\u53D6\u6709\u70B9\u50CF\uFF0C\u4F46\u662F\u5B83\u591A\u4E86\u4E2A\u4F20\u64AD\u673A\u5236\uFF0C\u4F1A\u7EE7\u7EED\u5524\u9192\u540E\u7EED\u8282\u70B9</span></span>
<span class="line"></span></code></pre></div><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">setHeadAndPropagate</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> propagate</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> h </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> head</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u53D6\u51FA\u5934\u7ED3\u70B9\u5E76\u5C06\u5F53\u524D\u8282\u70B9\u8BBE\u5B9A\u4E3A\u65B0\u7684\u5934\u7ED3\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">setHead</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u56E0\u4E3A\u4E00\u4E2A\u7EBF\u7A0B\u6210\u529F\u83B7\u53D6\u5230\u5171\u4EAB\u9501\u4E4B\u540E\uFF0C\u6709\u53EF\u80FD\u5269\u4E0B\u7684\u7B49\u5F85\u4E2D\u7684\u8282\u70B9\u4E5F\u6709\u673A\u4F1A\u62FF\u5230\u5171\u4EAB\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">propagate </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> h </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> h</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">waitStatus </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">h </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> head</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> h</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">waitStatus </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679Cpropagate\u5927\u4E8E0\uFF08\u8868\u793A\u5171\u4EAB\u9501\u8FD8\u80FD\u7EE7\u7EED\u83B7\u53D6\uFF09\u6216\u662Fh.waitStatus &lt; 0\uFF0C\u8FD9\u662F\u7531\u4E8E\u5728\u5176\u4ED6\u7EBF\u7A0B\u91CA\u653E\u5171\u4EAB\u9501\u65F6\uFF0CdoReleaseShared\u4F1A\u5C06\u72B6\u6001\u8BBE\u5B9A\u4E3APROPAGATE\u8868\u793A\u53EF\u4EE5\u4F20\u64AD\u5524\u9192\uFF0C\u540E\u9762\u4F1A\u8BB2</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> s </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">next</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isShared</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">doReleaseShared</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u7EE7\u7EED\u5524\u9192\u4E0B\u4E00\u4E2A\u7B49\u5F85\u8282\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>countdown\u8FC7\u7A0B\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">releaseShared</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> arg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">tryReleaseShared</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u76F4\u63A5\u5C1D\u8BD5\u91CA\u653E\u9501\uFF0C\u5982\u679C\u6210\u529F\u8FD4\u56DEtrue\uFF08\u5728CountDownLatch\u4E2D\u53EA\u6709state\u51CF\u52300\u7684\u90A3\u4E00\u6B21\uFF0C\u4F1A\u8FD4\u56DEtrue\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">doReleaseShared</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u8FD9\u91CC\u4E5F\u4F1A\u8C03\u7528doReleaseShared\u7EE7\u7EED\u5524\u9192\u540E\u9762\u7684\u7ED3\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5176\u4ED6\u60C5\u51B5false</span></span>
<span class="line"><span style="color:#89DDFF;">  									</span><span style="color:#676E95;">//\u4E0D\u8FC7\u8FD9\u91CCcountdown\u5E76\u6CA1\u6709\u7528\u5230\u8FD9\u4E9B\u8FD4\u56DE\u503C</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">doReleaseShared</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(;;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u65E0\u9650\u5FAA\u73AF</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> h </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> head</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u83B7\u53D6\u5934\u7ED3\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">h </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> h </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> tail</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5982\u679C\u5934\u7ED3\u70B9\u4E0D\u4E3A\u7A7A\u4E14\u5934\u7ED3\u70B9\u4E0D\u662F\u5C3E\u7ED3\u70B9\uFF0C\u90A3\u4E48\u8BF4\u660E\u7B49\u5F85\u961F\u5217\u4E2D\u5B58\u5728\u8282\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> ws </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> h</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">waitStatus</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u53D6\u4E00\u4E0B\u5934\u7ED3\u70B9\u7684\u7B49\u5F85\u72B6\u6001</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ws </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> Node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SIGNAL</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5982\u679C\u662FSIGNAL\uFF0C\u90A3\u4E48\u5C31CAS\u5C06\u5934\u7ED3\u70B9\u7684\u72B6\u6001\u8BBE\u5B9A\u4E3A\u521D\u59CB\u503C</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#82AAFF;">compareAndSetWaitStatus</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">h</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SIGNAL</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">continue</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">            </span><span style="color:#676E95;">//\u5931\u8D25\u5C31\u5F00\u4E0B\u4E00\u8F6E\u5FAA\u73AF\u91CD\u6765</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">unparkSuccessor</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">h</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u548C\u72EC\u5360\u6A21\u5F0F\u4E00\u6837\uFF0C\u5F53\u9501\u88AB\u91CA\u653E\uFF0C\u90FD\u4F1A\u5524\u9192\u5934\u7ED3\u70B9\u7684\u540E\u7EE7\u8282\u70B9\uFF0CdoAcquireShared\u5FAA\u73AF\u7EE7\u7EED\uFF0C\u5982\u679C\u6210\u529F\uFF0C\u90A3\u4E48\u6839\u636EsetHeadAndPropagate\uFF0C\u53C8\u4F1A\u7EE7\u7EED\u8C03\u7528\u5F53\u524D\u65B9\u6CD5\uFF0C\u4E0D\u65AD\u5730\u4F20\u64AD\u4E0B\u53BB\uFF0C\u8BA9\u540E\u9762\u7684\u7EBF\u7A0B\u4E00\u4E2A\u4E00\u4E2A\u5730\u83B7\u53D6\u5230\u5171\u4EAB\u9501\uFF0C\u76F4\u5230\u4E0D\u80FD\u518D\u7EE7\u7EED\u83B7\u53D6\u4E3A\u6B62</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ws </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#A6ACCD;">                     </span><span style="color:#89DDFF;">!</span><span style="color:#82AAFF;">compareAndSetWaitStatus</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">h</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">PROPAGATE</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u7B49\u5F85\u72B6\u6001\u662F\u9ED8\u8BA4\u503C0\uFF0C\u90A3\u4E48\u8BF4\u660E\u540E\u7EE7\u8282\u70B9\u5DF2\u7ECF\u88AB\u5524\u9192\uFF0C\u76F4\u63A5\u5C06\u72B6\u6001\u8BBE\u5B9A\u4E3APROPAGATE\uFF0C\u5B83\u4EE3\u8868\u5728\u540E\u7EED\u83B7\u53D6\u8D44\u6E90\u7684\u65F6\u5019\uFF0C\u591F\u5411\u540E\u9762\u4F20\u64AD</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">continue</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">                </span><span style="color:#676E95;">//\u5931\u8D25\u5C31\u5F00\u4E0B\u4E00\u8F6E\u5FAA\u73AF\u91CD\u6765</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">h </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> head</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">                   </span><span style="color:#676E95;">// \u5982\u679C\u5934\u7ED3\u70B9\u53D1\u751F\u4E86\u53D8\u5316\uFF0C\u4E0D\u4F1Abreak\uFF0C\u800C\u662F\u7EE7\u7EED\u5FAA\u73AF\uFF0C\u5426\u5219\u76F4\u63A5break\u9000\u51FA</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u603B\u7ED3\uFF1A</p><ul><li>\u5171\u4EAB\u9501\u662F\u7EBF\u7A0B\u5171\u4EAB\u7684\uFF0C\u540C\u4E00\u65F6\u523B\u80FD\u6709\u591A\u4E2A\u7EBF\u7A0B\u62E5\u6709\u5171\u4EAB\u9501\u3002</li><li>\u5982\u679C\u4E00\u4E2A\u7EBF\u7A0B\u521A\u83B7\u53D6\u4E86\u5171\u4EAB\u9501\uFF0C\u90A3\u4E48\u5728\u5176\u4E4B\u540E\u7B49\u5F85\u7684\u7EBF\u7A0B\u4E5F\u5F88\u6709\u53EF\u80FD\u80FD\u591F\u83B7\u53D6\u5230\u9501\uFF0C\u6240\u4EE5\u5F97\u4F20\u64AD\u4E0B\u53BB\u7EE7\u7EED\u5C1D\u8BD5\u5524\u9192\u540E\u9762\u7684\u7ED3\u70B9\uFF0C\u4E0D\u50CF\u72EC\u5360\u9501\uFF0C\u72EC\u5360\u7684\u538B\u6839\u4E0D\u9700\u8981\u8003\u8651\u8FD9\u4E9B\u3002</li><li>\u5982\u679C\u4E00\u4E2A\u7EBF\u7A0B\u521A\u91CA\u653E\u4E86\u9501\uFF0C\u4E0D\u7BA1\u662F\u72EC\u5360\u9501\u8FD8\u662F\u5171\u4EAB\u9501\uFF0C\u90FD\u9700\u8981\u5524\u9192\u540E\u7EED\u7B49\u5F85\u7ED3\u70B9\u7684\u7EBF\u7A0B\u3002</li></ul><h6 id="\u4E3E\u4F8B\u5E94\u7528\u573A\u666F" tabindex="-1"><code>\u4E3E\u4F8B\u5E94\u7528\u573A\u666F</code> <a class="header-anchor" href="#\u4E3E\u4F8B\u5E94\u7528\u573A\u666F" aria-hidden="true">#</a></h6><blockquote><p>\u9700\u6C42\uFF1A</p><ul><li>\u670920\u4E2A\u8BA1\u7B97\u4EFB\u52A1\uFF0C\u6211\u4EEC\u9700\u8981\u5148\u5C06\u8FD9\u4E9B\u4EFB\u52A1\u7684\u7ED3\u679C\u5168\u90E8\u8BA1\u7B97\u51FA\u6765\uFF0C\u6BCF\u4E2A\u4EFB\u52A1\u7684\u6267\u884C\u65F6\u95F4\u672A\u77E5</li><li>\u5F53\u6240\u6709\u4EFB\u52A1\u7ED3\u675F\u4E4B\u540E\uFF0C\u7ACB\u5373\u6574\u5408\u7EDF\u8BA1\u6700\u7EC8\u7ED3\u679C</li></ul><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">CountDownLatch</span><span style="color:#A6ACCD;"> latch </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CountDownLatch</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">20</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//\u521B\u5EFA\u4E00\u4E2A\u521D\u59CB\u503C\u4E3A10\u7684\u8BA1\u6570\u5668\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">20</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> finalI </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">           </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">               Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">((</span><span style="color:#C792EA;">long</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2000</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Random</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">nextDouble</span><span style="color:#89DDFF;">()));</span></span>
<span class="line"><span style="color:#A6ACCD;">               System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u5B50\u4EFB\u52A1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> finalI </span><span style="color:#89DDFF;">+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u6267\u884C\u5B8C\u6210\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">           </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">               e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">printStackTrace</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">           </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">           latch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">countDown</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6BCF\u6267\u884C\u4E00\u6B21\u8BA1\u6570\u5668\u90FD\u4F1A-1</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;">//\u5F00\u59CB\u7B49\u5F85\u6240\u6709\u7684\u7EBF\u7A0B\u5B8C\u6210\uFF0C\u5F53\u8BA1\u6570\u5668\u4E3A0\u65F6\uFF0C\u6062\u590D\u8FD0\u884C</span></span>
<span class="line"><span style="color:#A6ACCD;">   latch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8FD9\u4E2A\u64CD\u4F5C\u53EF\u4EE5\u540C\u65F6\u88AB\u591A\u4E2A\u7EBF\u7A0B\u6267\u884C\uFF0C\u4E00\u8D77\u7B49\u5F85\uFF0C\u8FD9\u91CC\u53EA\u6F14\u793A\u4E86\u4E00\u4E2A</span></span>
<span class="line"><span style="color:#A6ACCD;">   System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u6240\u6709\u5B50\u4EFB\u52A1\u90FD\u5B8C\u6210\uFF01\u4EFB\u52A1\u5B8C\u6210\uFF01\uFF01\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;"> 	</span><span style="color:#676E95;">//\u6CE8\u610F\u8FD9\u4E2A\u8BA1\u6570\u5668\u53EA\u80FD\u4F7F\u7528\u4E00\u6B21\uFF0C\u7528\u5B8C\u53EA\u80FD\u91CD\u65B0\u521B\u4E00\u4E2A\uFF0C\u6CA1\u6709\u91CD\u7F6E\u7684\u8BF4\u6CD5</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5728\u8C03\u7528<code>await()</code>\u65B9\u6CD5\u4E4B\u540E\uFF0C\u5B9E\u9645\u4E0A\u5C31\u662F\u4E00\u4E2A\u7B49\u5F85\u8BA1\u6570\u5668\u8870\u51CF\u4E3A0\u7684\u8FC7\u7A0B\uFF0C\u800C\u8FDB\u884C\u81EA\u51CF\u64CD\u4F5C\u5219\u7531\u5404\u4E2A\u5B50\u7EBF\u7A0B\u6765\u5B8C\u6210\uFF0C\u5F53\u5B50\u7EBF\u7A0B\u5B8C\u6210\u5DE5\u4F5C\u540E\uFF0C\u90A3\u4E48\u5C31\u5C06\u8BA1\u6570\u5668-1\uFF0C\u6240\u6709\u7684\u5B50\u7EBF\u7A0B\u5B8C\u6210\u4E4B\u540E\uFF0C\u8BA1\u6570\u5668\u4E3A0\uFF0C\u7ED3\u675F\u7B49\u5F85\u3002</p></blockquote><h5 id="cyclicbarrier-\u5FAA\u73AF\u5C4F\u969C" tabindex="-1">CyclicBarrier \u5FAA\u73AF\u5C4F\u969C <a class="header-anchor" href="#cyclicbarrier-\u5FAA\u73AF\u5C4F\u969C" aria-hidden="true">#</a></h5><blockquote><p>\u5047\u5982\u73B0\u5728\u6E38\u620F\u623F\u95F4\u5185\u4E00\u51715\u4EBA\uFF0C\u4F46\u662F\u6E38\u620F\u5F00\u59CB\u9700\u898110\u4EBA\uFF0C\u6240\u4EE5\u6211\u4EEC\u5FC5\u987B\u7B49\u5F85\u5269\u4E0B5\u4EBA\u5230\u6765\u4E4B\u540E\u624D\u80FD\u5F00\u59CB\u6E38\u620F\uFF0C\u5E76\u4E14\u4FDD\u8BC1\u6E38\u620F\u5F00\u59CB\u65F6\u6240\u6709\u73A9\u5BB6\u90FD\u662F\u540C\u65F6\u8FDB\u5165\uFF0C\u90A3\u4E48\u600E\u4E48\u5B9E\u73B0\u8FD9\u4E2A\u529F\u80FD\u5462\uFF1F</p></blockquote><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">CyclicBarrier</span><span style="color:#A6ACCD;"> barrier </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CyclicBarrier</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u521B\u5EFA\u4E00\u4E2A\u521D\u59CB\u503C\u4E3A10\u7684\u5FAA\u73AF\u5C4F\u969C</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u98DE\u673A\u9A6C\u4E0A\u5C31\u8981\u8D77\u98DE\u4E86\uFF0C\u5404\u4F4D\u7279\u79CD\u5175\u8BF7\u51C6\u5907\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u4EBA\u7B49\u591F\u4E4B\u540E\u6267\u884C\u7684\u4EFB\u52A1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> finalI </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">((</span><span style="color:#C792EA;">long</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2000</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Random</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">nextDouble</span><span style="color:#89DDFF;">()));</span></span>
<span class="line"><span style="color:#A6ACCD;">                System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u73A9\u5BB6 </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> finalI </span><span style="color:#89DDFF;">+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> \u8FDB\u5165\u623F\u95F4\u8FDB\u884C\u7B49\u5F85... (</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">barrier</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getNumberWaiting</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/10)</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                barrier</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u8C03\u7528await\u65B9\u6CD5\u8FDB\u884C\u7B49\u5F85\uFF0C\u76F4\u5230\u7B49\u5F85\u7684\u7EBF\u7A0B\u8DB3\u591F\u591A\u4E3A\u6B62</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">                </span><span style="color:#676E95;">//\u5F00\u59CB\u6E38\u620F\uFF0C\u6240\u6709\u73A9\u5BB6\u4E00\u8D77\u8FDB\u5165\u6E38\u620F</span></span>
<span class="line"><span style="color:#A6ACCD;">                System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u73A9\u5BB6 </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> finalI </span><span style="color:#89DDFF;">+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> \u8FDB\u5165\u6E38\u620F\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">BrokenBarrierException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">printStackTrace</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><strong>\u5FAA\u73AF\u5C4F\u969C\u4F1A\u4E0D\u65AD\u963B\u6321\u7EBF\u7A0B\uFF0C\u76F4\u5230\u88AB\u963B\u6321\u7684\u7EBF\u7A0B\u8DB3\u591F\u591A\u65F6\uFF0C\u624D\u80FD\u4E00\u8D77\u51B2\u7834\u5C4F\u969C\uFF0C\u5E76\u4E14\u5728\u51B2\u7834\u5C4F\u969C\u65F6\uFF0C\u6211\u4EEC\u4E5F\u53EF\u4EE5\u505A\u4E00\u4E9B\u5176\u4ED6\u7684\u4EFB\u52A1\u3002</strong></p><p>\u5C4F\u969C\u7531\u4E8E\u662F\u53EF\u5FAA\u73AF\u7684\uFF0C\u6240\u4EE5\u5B83\u5728\u88AB\u51B2\u7834\u540E\uFF0C\u4F1A\u91CD\u65B0\u5F00\u59CB\u8BA1\u6570\uFF0C\u7EE7\u7EED\u963B\u6321\u540E\u7EED\u7684\u7EBF\u7A0B\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">CyclicBarrier</span><span style="color:#A6ACCD;"> barrier </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CyclicBarrier</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//\u521B\u5EFA\u4E00\u4E2A\u521D\u59CB\u503C\u4E3A5\u7684\u5FAA\u73AF\u5C4F\u969C</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u521B\u5EFA5\u4E2A\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> finalI </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">((</span><span style="color:#C792EA;">long</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2000</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Random</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">nextDouble</span><span style="color:#89DDFF;">()));</span></span>
<span class="line"><span style="color:#A6ACCD;">                System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u73A9\u5BB6 </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> finalI </span><span style="color:#89DDFF;">+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> \u8FDB\u5165\u623F\u95F4\u8FDB\u884C\u7B49\u5F85... (</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">barrier</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getNumberWaiting</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/5)</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                barrier</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u8C03\u7528await\u65B9\u6CD5\u8FDB\u884C\u7B49\u5F85\uFF0C\u76F4\u5230\u7B49\u5F85\u7EBF\u7A0B\u5230\u8FBE5\u624D\u4F1A\u4E00\u8D77\u7EE7\u7EED\u6267\u884C</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">                </span><span style="color:#676E95;">//\u4EBA\u6570\u5230\u9F50\u4E4B\u540E\uFF0C\u53EF\u4EE5\u5F00\u59CB\u6E38\u620F\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">                System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u73A9\u5BB6 </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> finalI </span><span style="color:#89DDFF;">+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> \u8FDB\u5165\u6E38\u620F\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">BrokenBarrierException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">printStackTrace</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u901A\u8FC7\u4F7F\u7528\u5FAA\u73AF\u5C4F\u969C\uFF0C\u6211\u4EEC\u53EF\u4EE5\u5BF9\u7EBF\u7A0B\u8FDB\u884C\u4E00\u6CE2\u4E00\u6CE2\u5730\u653E\u884C\uFF0C\u6BCF\u4E00\u6CE2\u90FD\u653E\u884C5\u4E2A\u7EBF\u7A0B\uFF0C\u5F53\u7136\u9664\u4E86\u81EA\u52A8\u91CD\u7F6E\u4E4B\u5916\uFF0C\u6211\u4EEC\u4E5F\u53EF\u4EE5\u8C03\u7528<code>reset()</code>\u65B9\u6CD5\u6765\u624B\u52A8\u8FDB\u884C\u91CD\u7F6E\u64CD\u4F5C\uFF0C\u540C\u6837\u4F1A\u91CD\u65B0\u8BA1\u6570\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">CyclicBarrier</span><span style="color:#A6ACCD;"> barrier </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CyclicBarrier</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//\u521B\u5EFA\u4E00\u4E2A\u521D\u59CB\u503C\u4E3A10\u7684\u8BA1\u6570\u5668\u9501</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                barrier</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">BrokenBarrierException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">printStackTrace</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">500</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u7B49\u4E00\u4E0B\u4E0A\u9762\u7684\u7EBF\u7A0B\u5F00\u59CB\u8FD0\u884C</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u5F53\u524D\u5C4F\u969C\u524D\u7684\u7B49\u5F85\u7EBF\u7A0B\u6570\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">barrier</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getNumberWaiting</span><span style="color:#89DDFF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    barrier</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">reset</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u91CD\u7F6E\u540E\u5C4F\u969C\u524D\u7684\u7B49\u5F85\u7EBF\u7A0B\u6570\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">barrier</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getNumberWaiting</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5728\u8C03\u7528<code>reset()</code>\u4E4B\u540E\uFF0C\u5904\u4E8E\u7B49\u5F85\u72B6\u6001\u4E0B\u7684\u7EBF\u7A0B\uFF0C\u5168\u90E8\u88AB\u4E2D\u65AD\u5E76\u4E14\u629B\u51FABrokenBarrierException\u5F02\u5E38\uFF0C\u5FAA\u73AF\u5C4F\u969C\u7B49\u5F85\u7EBF\u7A0B\u6570\u5F52\u96F6\u3002\u90A3\u4E48\u8981\u662F\u5904\u4E8E\u7B49\u5F85\u72B6\u6001\u4E0B\u7684\u7EBF\u7A0B\u88AB\u4E2D\u65AD\u4E86\u5462\uFF1F\u5C4F\u969C\u7684\u7EBF\u7A0B\u7B49\u5F85\u6570\u91CF\u4F1A\u4E0D\u4F1A\u81EA\u52A8\u51CF\u5C11\uFF1F</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">CyclicBarrier</span><span style="color:#A6ACCD;"> barrier </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CyclicBarrier</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> r </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            barrier</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">BrokenBarrierException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">printStackTrace</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Thread</span><span style="color:#A6ACCD;"> t </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">r</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    t</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    t</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">interrupt</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">r</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5F53<code>await()</code>\u72B6\u6001\u4E0B\u7684\u7EBF\u7A0B\u88AB\u4E2D\u65AD\uFF0C\u90A3\u4E48\u5C4F\u969C\u4F1A\u76F4\u63A5\u53D8\u6210\u635F\u574F\u72B6\u6001\uFF0C\u4E00\u65E6\u5C4F\u969C\u635F\u574F\uFF0C\u90A3\u4E48\u8FD9\u4E00\u8F6E\u5C31\u65E0\u6CD5\u518D\u505A\u4EFB\u4F55\u7B49\u5F85\u64CD\u4F5C\u4E86\u3002</p><p>\u53EA\u80FD\u8FDB\u884C<code>reset()</code>\u91CD\u7F6E\u64CD\u4F5C\u8FDB\u884C\u91CD\u7F6E\u624D\u80FD\u6062\u590D\u6B63\u5E38\u3002</p><p>**\u533A\u5206 **CountDownLatch&amp;CyclicBarrier\uFF1A</p><ul><li>CountDownLatch\uFF1A <ol><li>\u5B83\u53EA\u80FD\u4F7F\u7528\u4E00\u6B21\uFF0C\u662F\u4E00\u4E2A\u4E00\u6B21\u6027\u7684\u5DE5\u5177</li><li>\u5B83\u662F\u4E00\u4E2A\u6216\u591A\u4E2A\u7EBF\u7A0B\u7528\u4E8E\u7B49\u5F85\u5176\u4ED6\u7EBF\u7A0B\u5B8C\u6210\u7684\u540C\u6B65\u5DE5\u5177</li></ol></li><li>CyclicBarrier <ol><li>\u5B83\u53EF\u4EE5\u53CD\u590D\u4F7F\u7528\uFF0C\u5141\u8BB8\u81EA\u52A8\u6216\u624B\u52A8\u91CD\u7F6E\u8BA1\u6570</li><li>\u5B83\u662F\u8BA9\u4E00\u5B9A\u6570\u91CF\u7684\u7EBF\u7A0B\u5728\u540C\u4E00\u65F6\u95F4\u5F00\u59CB\u8FD0\u884C\u7684\u540C\u6B65\u5DE5\u5177</li></ol></li></ul><p><strong>\u5FAA\u73AF\u5C4F\u969C\u7684\u5B9E\u73B0\u7EC6\u8282\uFF1A</strong></p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">CyclicBarrier</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//\u5185\u90E8\u7C7B\uFF0C\u5B58\u653Ebroken\u6807\u8BB0\uFF0C\u8868\u793A\u5C4F\u969C\u662F\u5426\u635F\u574F\uFF0C\u635F\u574F\u7684\u5C4F\u969C\u662F\u65E0\u6CD5\u6B63\u5E38\u5DE5\u4F5C\u7684</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Generation</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> broken </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">    /** \u5185\u90E8\u7EF4\u62A4\u4E00\u4E2A\u53EF\u91CD\u5165\u9501 */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ReentrantLock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#676E95;">    /** \u518D\u7EF4\u62A4\u4E00\u4E2ACondition */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Condition</span><span style="color:#A6ACCD;"> trip </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newCondition</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#676E95;">    /** \u8FD9\u4E2A\u5C31\u662F\u5C4F\u969C\u7684\u6700\u5927\u963B\u6321\u5BB9\u91CF\uFF0C\u5C31\u662F\u6784\u9020\u65B9\u6CD5\u4F20\u5165\u7684\u521D\u59CB\u503C */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> parties</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">/* \u5728\u5C4F\u969C\u7834\u88C2\u65F6\u505A\u7684\u4E8B\u60C5 */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> barrierCommand</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;">    /** \u5F53\u524D\u8FD9\u4E00\u8F6E\u7684Generation\u5BF9\u8C61\uFF0C\u6BCF\u4E00\u8F6E\u90FD\u6709\u4E00\u4E2A\u65B0\u7684\uFF0C\u7528\u4E8E\u4FDD\u5B58broken\u6807\u8BB0 */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Generation</span><span style="color:#A6ACCD;"> generation </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Generation</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//\u9ED8\u8BA4\u4E3A\u6700\u5927\u963B\u6321\u5BB9\u91CF\uFF0C\u6BCF\u6765\u4E00\u4E2A\u7EBF\u7A0B-1\uFF0C\u548CCountDownLatch\u633A\u50CF\uFF0C\u5F53\u5C4F\u969C\u7834\u88C2\u6216\u662F\u88AB\u91CD\u7F6E\u65F6\uFF0C\u90FD\u4F1A\u5C06\u5176\u91CD\u7F6E\u4E3A\u6700\u5927\u963B\u6321\u5BB9\u91CF</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> count</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u6784\u9020\u65B9\u6CD5</span></span>
<span class="line"><span style="color:#A6ACCD;">  	</span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CyclicBarrier</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">parties</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">barrierAction</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">parties </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IllegalArgumentException</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">parties </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> parties</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">count </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> parties</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">barrierCommand </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> barrierAction</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CyclicBarrier</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">parties</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">this(</span><span style="color:#A6ACCD;">parties</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//\u5F00\u542F\u4E0B\u4E00\u8F6E\u5C4F\u969C\uFF0C\u4E00\u822C\u5C4F\u969C\u88AB\u51B2\u7834\u4E4B\u540E\uFF0C\u5C31\u81EA\u52A8\u91CD\u7F6E\u4E86\uFF0C\u8FDB\u5165\u5230\u4E0B\u4E00\u8F6E</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">nextGeneration</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u5524\u9192\u6240\u6709\u7B49\u5F85\u72B6\u6001\u7684\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">        trip</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">signalAll</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// \u91CD\u7F6Ecount\u7684\u503C</span></span>
<span class="line"><span style="color:#A6ACCD;">        count </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> parties</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//\u521B\u5EFA\u65B0\u7684Generation\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#A6ACCD;">        generation </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Generation</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//\u7834\u574F\u5F53\u524D\u5C4F\u969C\uFF0C\u53D8\u4E3A\u635F\u574F\u72B6\u6001\uFF0C\u4E4B\u540E\u5C31\u4E0D\u80FD\u518D\u4F7F\u7528\u4E86\uFF0C\u9664\u975E\u91CD\u7F6E</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">breakBarrier</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        generation</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">broken </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">        count </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> parties</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        trip</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">signalAll</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u5F00\u59CB\u7B49\u5F85</span></span>
<span class="line"><span style="color:#A6ACCD;">  	</span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">BrokenBarrierException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">dowait</span><span style="color:#89DDFF;">(false,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0L</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">TimeoutException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">toe</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Error</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">toe</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u56E0\u4E3A\u8FD9\u91CC\u6CA1\u6709\u4F7F\u7528\u5B9A\u65F6\u673A\u5236\uFF0C\u4E0D\u53EF\u80FD\u53D1\u751F\u5F02\u5E38\uFF0C\u5982\u679C\u53D1\u751F\u6015\u662F\u51FA\u4E86\u9519\u8BEF</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u53EF\u8D85\u65F6\u7684\u7B49\u5F85</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">timeout</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TimeUnit</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">unit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">BrokenBarrierException</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">TimeoutException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">dowait</span><span style="color:#89DDFF;">(true,</span><span style="color:#A6ACCD;"> unit</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toNanos</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">timeout</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//\u8FD9\u91CC\u5C31\u662F\u771F\u6B63\u7684\u7B49\u5F85\u6D41\u7A0B\u4E86\uFF0C\u8BA9\u6211\u4EEC\u7EC6\u7EC6\u9053\u6765</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">dowait</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">timed</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">nanos</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">BrokenBarrierException</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">TimeoutException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u52A0\u9501\uFF0C\u6CE8\u610F\uFF0C\u56E0\u4E3A\u591A\u4E2A\u7EBF\u7A0B\u90FD\u4F1A\u8C03\u7528await\u65B9\u6CD5\uFF0C\u56E0\u6B64\u53EA\u6709\u4E00\u4E2A\u7EBF\u7A0B\u80FD\u8FDB\uFF0C\u5176\u4ED6\u90FD\u88AB\u5361\u7740\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Generation</span><span style="color:#A6ACCD;"> g </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> generation</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u83B7\u53D6\u5F53\u524D\u8FD9\u4E00\u8F6E\u5C4F\u969C\u7684Generation\u5BF9\u8C61</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">g</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">broken</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BrokenBarrierException</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u8FD9\u4E00\u8F6E\u5C4F\u969C\u5DF2\u7ECF\u635F\u574F\uFF0C\u90A3\u5C31\u6CA1\u529E\u6CD5\u4F7F\u7528\u4E86</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">interrupted</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u5F53\u524D\u7B49\u5F85\u72B6\u6001\u7684\u7EBF\u7A0B\u88AB\u4E2D\u65AD\uFF0C\u90A3\u4E48\u4F1A\u76F4\u63A5\u7834\u574F\u6389\u5C4F\u969C\uFF0C\u5E76\u629B\u51FA\u4E2D\u65AD\u5F02\u5E38\uFF08\u7834\u574F\u5C4F\u969C\u7684\u7B2C1\u79CD\u60C5\u51B5\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">breakBarrier</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">InterruptedException</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> index </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">count</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">//\u5982\u679C\u4E0A\u9762\u90FD\u6CA1\u6709\u51FA\u73B0\u4E0D\u6B63\u5E38\uFF0C\u90A3\u4E48\u5C31\u8D70\u6B63\u5E38\u6D41\u7A0B\uFF0C\u9996\u5148count\u81EA\u51CF\u5E76\u8D4B\u503C\u7ED9index\uFF0Cindex\u8868\u793A\u5F53\u524D\u662F\u7B49\u5F85\u7684\u7B2C\u51E0\u4E2A\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">index </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">// \u5982\u679C\u81EA\u51CF\u4E4B\u540E\u5C31\u662F0\u4E86\uFF0C\u90A3\u4E48\u8BF4\u660E\u6765\u7684\u7EBF\u7A0B\u5DF2\u7ECF\u8DB3\u591F\uFF0C\u53EF\u4EE5\u51B2\u7834\u5C4F\u969C\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> ranAction </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> command </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> barrierCommand</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">command </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span></span>
<span class="line"><span style="color:#A6ACCD;">                        command</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6267\u884C\u51B2\u7834\u5C4F\u969C\u540E\u7684\u4EFB\u52A1\uFF0C\u5982\u679C\u8FD9\u91CC\u629B\u5F02\u5E38\u4E86\uFF0C\u90A3\u4E48\u4F1A\u8FDBfinally</span></span>
<span class="line"><span style="color:#A6ACCD;">                    ranAction </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#82AAFF;">nextGeneration</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u4E00\u5207\u6B63\u5E38\uFF0C\u5F00\u542F\u4E0B\u4E00\u8F6E\u5C4F\u969C\uFF08\u65B9\u6CD5\u8FDB\u5165\u4E4B\u540E\u4F1A\u5524\u9192\u6240\u6709\u7B49\u5F85\u7684\u7EBF\u7A0B\uFF0C\u8FD9\u6837\u6240\u6709\u7684\u7EBF\u7A0B\u90FD\u53EF\u4EE5\u540C\u65F6\u7EE7\u7EED\u8FD0\u884C\u4E86\uFF09\u7136\u540E\u8FD4\u56DE0\uFF0C\u6CE8\u610F\u6700\u4E0B\u9762finally\u4E2D\u4F1A\u89E3\u9501\uFF0C\u4E0D\u7136\u5176\u4ED6\u7EBF\u7A0B\u5524\u9192\u4E86\u4E5F\u62FF\u4E0D\u5230\u9501\u554A</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#A6ACCD;">ranAction</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u662F\u4E0A\u9762\u51FA\u73B0\u5F02\u5E38\u8FDB\u6765\u7684\uFF0C\u90A3\u4E48\u4E5F\u4F1A\u76F4\u63A5\u7834\u574F\u5C4F\u969C\uFF08\u7834\u574F\u5C4F\u969C\u7684\u7B2C2\u79CD\u60C5\u51B5\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#82AAFF;">breakBarrier</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u80FD\u8D70\u5230\u8FD9\u91CC\uFF0C\u90A3\u4E48\u8BF4\u660E\u5F53\u524D\u7B49\u5F85\u7684\u7EBF\u7A0B\u6570\u8FD8\u4E0D\u591F\u591A\uFF0C\u4E0D\u8DB3\u4EE5\u51B2\u7834\u5C4F\u969C</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(;;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u65E0\u9650\u5FAA\u73AF\uFF0C\u4E00\u76F4\u7B49\uFF0C\u7B49\u5230\u80FD\u51B2\u7834\u5C4F\u969C\u6216\u662F\u51FA\u73B0\u5F02\u5E38\u4E3A\u6B62</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#A6ACCD;">timed</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                        trip</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">await</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5982\u679C\u4E0D\u662F\u5B9A\u65F6\u7684\uFF0C\u90A3\u4E48\u5C31\u76F4\u63A5\u6C38\u4E45\u7B49\u5F85</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">nanos </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0L</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                        nanos </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> trip</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">awaitNanos</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">nanos</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5426\u5219\u6700\u591A\u7B49\u4E00\u6BB5\u65F6\u95F4</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">ie</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u7B49\u7684\u65F6\u5019\u4F1A\u5224\u65AD\u662F\u5426\u88AB\u4E2D\u65AD\uFF08\u4F9D\u7136\u662F\u7834\u574F\u5C4F\u969C\u7684\u7B2C1\u79CD\u60C5\u51B5\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">g </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> generation </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;"> g</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">broken</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#82AAFF;">breakBarrier</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> ie</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                        Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">interrupt</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">g</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">broken</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BrokenBarrierException</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u7EBF\u7A0B\u88AB\u5524\u9192\u4E4B\u540E\u53D1\u73B0\u5C4F\u969C\u5DF2\u7ECF\u88AB\u7834\u574F\uFF0C\u90A3\u4E48\u76F4\u63A5\u629B\u5F02\u5E38</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">g </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> generation</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6210\u529F\u51B2\u7834\u5C4F\u969C\u5F00\u542F\u4E0B\u4E00\u8F6E\uFF0C\u90A3\u4E48\u76F4\u63A5\u8FD4\u56DE\u5F53\u524D\u662F\u7B2C\u51E0\u4E2A\u7B49\u5F85\u7684\u7EBF\u7A0B\u3002</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> index</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">timed </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> nanos </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0L</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u7EBF\u7A0B\u7B49\u5F85\u8D85\u65F6\uFF0C\u4E5F\u4F1A\u7834\u574F\u5C4F\u969C\uFF08\u7834\u574F\u5C4F\u969C\u7684\u7B2C3\u79CD\u60C5\u51B5\uFF09\u7136\u540E\u629B\u5F02\u5E38</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#82AAFF;">breakBarrier</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">TimeoutException</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u6700\u540E\u522B\u5FD8\u4E86\u89E3\u9501\uFF0C\u4E0D\u7136\u5176\u4ED6\u7EBF\u7A0B\u62FF\u4E0D\u5230\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u4E0D\u591A\u8BF4\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getParties</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> parties</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u5224\u65AD\u662F\u5426\u88AB\u7834\u574F\uFF0C\u4E5F\u662F\u52A0\u9501\u8BBF\u95EE\uFF0C\u56E0\u4E3A\u6709\u53EF\u80FD\u8FD9\u65F6\u6709\u5176\u4ED6\u7EBF\u7A0B\u6B63\u5728\u6267\u884Cdowait</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isBroken</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> generation</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">broken</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u91CD\u7F6E\u64CD\u4F5C\uFF0C\u4E5F\u8981\u52A0\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">reset</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">breakBarrier</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">// \u5148\u7834\u574F\u8FD9\u4E00\u8F6E\u7684\u7EBF\u7A0B\uFF0C\u6CE8\u610F\u8FD9\u4E2A\u65B9\u6CD5\u4F1A\u5148\u7834\u574F\u518D\u5524\u9192\u6240\u6709\u7B49\u5F85\u7684\u7EBF\u7A0B\uFF0C\u90A3\u4E48\u6240\u6709\u7B49\u5F85\u7684\u7EBF\u7A0B\u4F1A\u76F4\u63A5\u629BBrokenBarrierException\u5F02\u5E38\uFF08\u8BE6\u60C5\u8BF7\u770B\u4E0A\u65B9dowait\u5012\u6570\u7B2C13\u884C\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">nextGeneration</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u5F00\u542F\u4E0B\u4E00\u8F6E</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u83B7\u53D6\u7B49\u5F85\u7EBF\u7A0B\u6570\u91CF\uFF0C\u4E5F\u8981\u52A0\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getNumberWaiting</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> lock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">lock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> parties </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> count</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6700\u5927\u5BB9\u91CF - \u5F53\u524D\u5269\u4F59\u5BB9\u91CF = \u6B63\u5728\u7B49\u5F85\u7EBF\u7A0B\u6570</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            lock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="semaphore-\u4FE1\u53F7\u91CF" tabindex="-1">Semaphore \u4FE1\u53F7\u91CF <a class="header-anchor" href="#semaphore-\u4FE1\u53F7\u91CF" aria-hidden="true">#</a></h5><blockquote><p>\u4FE1\u53F7\u91CF(Semaphore)\uFF0C\u6709\u65F6\u88AB\u79F0\u4E3A\u4FE1\u53F7\u706F\uFF0C\u662F\u5728\u591A\u7EBF\u7A0B\u73AF\u5883\u4E0B\u4F7F\u7528\u7684\u4E00\u79CD\u8BBE\u65BD\uFF0C\u662F\u53EF\u4EE5\u7528\u6765\u4FDD\u8BC1\u4E24\u4E2A\u6216\u591A\u4E2A\u5173\u952E\u4EE3\u7801\u6BB5\u4E0D\u88AB\u5E76\u53D1\u8C03\u7528\u3002\u5728\u8FDB\u5165\u4E00\u4E2A\u5173\u952E\u4EE3\u7801\u6BB5\u4E4B\u524D\uFF0C\u7EBF\u7A0B\u5FC5\u987B\u83B7\u53D6\u4E00\u4E2A\u4FE1\u53F7\u91CF\uFF1B\u4E00\u65E6\u8BE5\u5173\u952E\u4EE3\u7801\u6BB5\u5B8C\u6210\u4E86\uFF0C\u90A3\u4E48\u8BE5\u7EBF\u7A0B\u5FC5\u987B\u91CA\u653E\u4FE1\u53F7\u91CF\u3002\u5176\u5B83\u60F3\u8FDB\u5165\u8BE5\u5173\u952E\u4EE3\u7801\u6BB5\u7684\u7EBF\u7A0B\u5FC5\u987B\u7B49\u5F85\u76F4\u5230\u7B2C\u4E00\u4E2A\u7EBF\u7A0B\u91CA\u653E\u4FE1\u53F7\u91CF\u3002</p></blockquote><p>\u901A\u8FC7\u4F7F\u7528\u4FE1\u53F7\u91CF\uFF0C\u6211\u4EEC\u53EF\u4EE5\u51B3\u5B9A\u67D0\u4E2A\u8D44\u6E90\u540C\u4E00\u65F6\u95F4\u80FD\u591F\u88AB\u8BBF\u95EE\u7684\u6700\u5927\u7EBF\u7A0B\u6570\uFF0C\u5B83\u76F8\u5F53\u4E8E\u5BF9\u67D0\u4E2A\u8D44\u6E90\u7684\u8BBF\u95EE\u8FDB\u884C\u4E86\u6D41\u91CF\u63A7\u5236\u3002\u7B80\u5355\u6765\u8BF4\uFF0C\u5B83\u5C31\u662F\u4E00\u4E2A\u53EF\u4EE5\u88ABN\u4E2A\u7EBF\u7A0B\u5360\u7528\u7684\u6392\u5B83\u9501\uFF08\u56E0\u6B64\u4E5F\u652F\u6301\u516C\u5E73\u548C\u975E\u516C\u5E73\u6A21\u5F0F\uFF09\uFF0C\u6211\u4EEC\u53EF\u4EE5\u5728\u6700\u5F00\u59CB\u8BBE\u5B9ASemaphore\u7684\u8BB8\u53EF\u8BC1\u6570\u91CF\uFF0C\u6BCF\u4E2A\u7EBF\u7A0B\u90FD\u53EF\u4EE5\u83B7\u5F971\u4E2A\u6216n\u4E2A\u8BB8\u53EF\u8BC1\uFF0C\u5F53\u8BB8\u53EF\u8BC1\u8017\u5C3D\u6216\u4E0D\u8DB3\u4EE5\u4F9B\u5176\u4ED6\u7EBF\u7A0B\u83B7\u53D6\u65F6\uFF0C\u5176\u4ED6\u7EBF\u7A0B\u5C06\u88AB\u963B\u585E\u3002</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws ExecutionException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//\u6BCF\u4E00\u4E2ASemaphore\u90FD\u4F1A\u5728\u4E00\u5F00\u59CB\u83B7\u5F97\u6307\u5B9A\u7684\u8BB8\u53EF\u8BC1\u6570\u6570\u91CF\uFF0C\u4E5F\u5C31\u662F\u8BB8\u53EF\u8BC1\u914D\u989D</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Semaphore</span><span style="color:#A6ACCD;"> semaphore </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Semaphore</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8BB8\u53EF\u8BC1\u914D\u989D\u8BBE\u5B9A\u4E3A2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                semaphore</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">acquire</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u7533\u8BF7\u4E00\u4E2A\u8BB8\u53EF\u8BC1</span></span>
<span class="line"><span style="color:#A6ACCD;">                System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u8BB8\u53EF\u8BC1\u7533\u8BF7\u6210\u529F\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                semaphore</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">release</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5F52\u8FD8\u4E00\u4E2A\u8BB8\u53EF\u8BC1</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">printStackTrace</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws ExecutionException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//\u6BCF\u4E00\u4E2ASemaphore\u90FD\u4F1A\u5728\u4E00\u5F00\u59CB\u83B7\u5F97\u6307\u5B9A\u7684\u8BB8\u53EF\u8BC1\u6570\u6570\u91CF\uFF0C\u4E5F\u5C31\u662F\u8BB8\u53EF\u8BC1\u914D\u989D</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Semaphore</span><span style="color:#A6ACCD;"> semaphore </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Semaphore</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8BB8\u53EF\u8BC1\u914D\u989D\u8BBE\u5B9A\u4E3A3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                semaphore</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">acquire</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u4E00\u6B21\u6027\u7533\u8BF7\u4E24\u4E2A\u8BB8\u53EF\u8BC1</span></span>
<span class="line"><span style="color:#A6ACCD;">                System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u8BB8\u53EF\u8BC1\u7533\u8BF7\u6210\u529F\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">printStackTrace</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u901A\u8FC7Semaphore\u83B7\u53D6\u4E00\u4E9B\u5E38\u89C4\u4FE1\u606F\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Semaphore</span><span style="color:#A6ACCD;"> semaphore </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Semaphore</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u53EA\u914D\u7F6E\u4E00\u4E2A\u8BB8\u53EF\u8BC1\uFF0C5\u4E2A\u7EBF\u7A0B\u8FDB\u884C\u4E89\u62A2\uFF0C\u4E0D\u5185\u5377\u8FD8\u60F3\u8981\u8BB8\u53EF\u8BC1\uFF1F</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">semaphore</span><span style="color:#89DDFF;">::</span><span style="color:#A6ACCD;">acquireUninterruptibly</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u53EF\u4EE5\u4EE5\u4E0D\u54CD\u5E94\u4E2D\u65AD\uFF08\u4E3B\u8981\u662F\u80FD\u7B80\u5199\u4E00\u884C\uFF0C\u65B9\u4FBF\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">    Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">500</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u5269\u4F59\u8BB8\u53EF\u8BC1\u6570\u91CF\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">semaphore</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">availablePermits</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u662F\u5426\u5B58\u5728\u7EBF\u7A0B\u7B49\u5F85\u8BB8\u53EF\u8BC1\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+(</span><span style="color:#A6ACCD;">semaphore</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">hasQueuedThreads</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u662F</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u5426</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u7B49\u5F85\u8BB8\u53EF\u8BC1\u7EBF\u7A0B\u6570\u91CF\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">semaphore</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getQueueLength</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u624B\u52A8\u56DE\u6536\u6389\u6240\u6709\u7684\u8BB8\u53EF\u8BC1\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Semaphore</span><span style="color:#A6ACCD;"> semaphore </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Semaphore</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">semaphore</span><span style="color:#89DDFF;">::</span><span style="color:#A6ACCD;">acquireUninterruptibly</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">500</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u6536\u56DE\u5269\u4F59\u8BB8\u53EF\u6570\u91CF\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">semaphore</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">drainPermits</span><span style="color:#89DDFF;">());</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u76F4\u63A5\u56DE\u6536\u6389\u5269\u4F59\u7684\u8BB8\u53EF\u8BC1</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="exchanger-\u6570\u636E\u4EA4\u6362" tabindex="-1">Exchanger \u6570\u636E\u4EA4\u6362 <a class="header-anchor" href="#exchanger-\u6570\u636E\u4EA4\u6362" aria-hidden="true">#</a></h5><p>Exchanger\uFF0C\u5B83\u80FD\u591F\u5B9E\u73B0\u7EBF\u7A0B\u4E4B\u95F4\u7684\u6570\u636E\u4EA4\u6362\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Exchanger</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> exchanger </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Exchanger</span><span style="color:#89DDFF;">&lt;&gt;();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u6536\u5230\u4E3B\u7EBF\u7A0B\u4F20\u9012\u7684\u4EA4\u6362\u6570\u636E\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">exchanger</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">exchange</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">AAAA</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">printStackTrace</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u6536\u5230\u5B50\u7EBF\u7A0B\u4F20\u9012\u7684\u4EA4\u6362\u6570\u636E\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">exchanger</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">exchange</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">BBBB</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5728\u8C03\u7528<code>exchange</code>\u65B9\u6CD5\u540E\uFF0C\u5F53\u524D\u7EBF\u7A0B\u4F1A\u7B49\u5F85\u5176\u4ED6\u7EBF\u7A0B\u8C03\u7528\u540C\u4E00\u4E2Aexchanger\u5BF9\u8C61\u7684<code>exchange</code>\u65B9\u6CD5\uFF0C\u5F53\u53E6\u4E00\u4E2A\u7EBF\u7A0B\u4E5F\u8C03\u7528\u4E4B\u540E\uFF0C\u65B9\u6CD5\u4F1A\u8FD4\u56DE\u5BF9\u65B9\u7EBF\u7A0B\u4F20\u5165\u7684\u53C2\u6570\u3002</p><h5 id="fork-join\u6846\u67B6" tabindex="-1">Fork/Join\u6846\u67B6 <a class="header-anchor" href="#fork-join\u6846\u67B6" aria-hidden="true">#</a></h5><ul><li><p>\u4F7F\u7528\u591A\u7EBF\u7A0B\u62C6\u5206\u4EFB\u52A1</p></li><li><p>\u5229\u7528\u5DE5\u4F5C\u7A83\u53D6\u7B97\u6CD5,\u63D0\u9AD8\u7EBF\u7A0B\u7684\u5229\u7528\u7387</p><ul><li><p>**\u5DE5\u4F5C\u7A83\u53D6\u7B97\u6CD5\uFF1A**\u662F\u6307\u67D0\u4E2A\u7EBF\u7A0B\u4ECE\u5176\u4ED6\u961F\u5217\u91CC\u7A83\u53D6\u4EFB\u52A1\u6765\u6267\u884C\u3002\u4E00\u4E2A\u5927\u4EFB\u52A1\u5206\u5272\u4E3A\u82E5\u5E72\u4E2A\u4E92\u4E0D\u4F9D\u8D56\u7684\u5B50\u4EFB\u52A1\uFF0C\u4E3A\u4E86\u51CF\u5C11\u7EBF\u7A0B\u95F4\u7684\u7ADE\u4E89\uFF0C\u628A\u8FD9\u4E9B\u5B50\u4EFB\u52A1\u5206\u522B\u653E\u5230\u4E0D\u540C\u7684\u961F\u5217\u91CC\uFF0C\u5E76\u4E3A\u6BCF\u4E2A\u961F\u5217\u521B\u5EFA\u4E00\u4E2A\u5355\u72EC\u7684\u7EBF\u7A0B\u6765\u6267\u884C\u961F\u5217\u91CC\u7684\u4EFB\u52A1\uFF0C\u7EBF\u7A0B\u548C\u961F\u5217\u4E00\u4E00\u5BF9\u5E94\u3002\u4F46\u662F\u6709\u7684\u7EBF\u7A0B\u4F1A\u5148\u628A\u81EA\u5DF1\u961F\u5217\u91CC\u7684\u4EFB\u52A1\u5E72\u5B8C\uFF0C\u800C\u5176\u4ED6\u7EBF\u7A0B\u5BF9\u5E94\u7684\u961F\u5217\u91CC\u8FD8\u6709\u4EFB\u52A1\u5F85\u5904\u7406\u3002\u5E72\u5B8C\u6D3B\u7684\u7EBF\u7A0B\u4E0E\u5176\u7B49\u7740\uFF0C\u4E0D\u5982\u5E2E\u5176\u4ED6\u7EBF\u7A0B\u5E72\u6D3B\uFF0C\u4E8E\u662F\u5B83\u5C31\u53BB\u5176\u4ED6\u7EBF\u7A0B\u7684\u961F\u5217\u91CC\u7A83\u53D6\u4E00\u4E2A\u4EFB\u52A1\u6765\u6267\u884C\u3002</p></li><li><p><img src="`+k+`" alt="image-20220406181701396"></p></li><li><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Main</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ExecutionException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">ForkJoinPool</span><span style="color:#A6ACCD;"> pool </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ForkJoinPool</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">pool</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">submit</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SubTask</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1000</span><span style="color:#89DDFF;">)).</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u7EE7\u627FRecursiveTask\uFF0C\u8FD9\u6837\u624D\u53EF\u4EE5\u4F5C\u4E3A\u4E00\u4E2A\u4EFB\u52A1\uFF0C\u6CDB\u578B\u5C31\u662F\u8BA1\u7B97\u7ED3\u679C\u7C7B\u578B</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">SubTask</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RecursiveTask</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Integer</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> start</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6BD4\u5982\u6211\u4EEC\u8981\u8BA1\u7B97\u4E00\u4E2A\u8303\u56F4\u5185\u6240\u6709\u6570\u7684\u548C\uFF0C\u90A3\u4E48\u5C31\u9700\u8981\u9650\u5B9A\u4E00\u4E0B\u8303\u56F4\uFF0C\u8FD9\u91CC\u7528\u4E86\u4E24\u4E2Aint\u5B58\u653E</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> end</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SubTask</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">start</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">end</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">start </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> start</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">end </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> end</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Integer</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">compute</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">end </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> start </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">125</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u6BCF\u4E2A\u4EFB\u52A1\u6700\u591A\u8BA1\u7B97125\u4E2A\u6570\u7684\u548C\uFF0C\u5982\u679C\u5927\u4E8E\u7EE7\u7EED\u62C6\u5206\uFF0C\u5C0F\u4E8E\u5C31\u53EF\u4EE5\u5F00\u59CB\u7B97\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">SubTask</span><span style="color:#A6ACCD;"> subTask1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SubTask</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">start</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">end </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> start</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                subTask1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fork</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u4F1A\u7EE7\u7EED\u5212\u5206\u5B50\u4EFB\u52A1\u6267\u884C</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">SubTask</span><span style="color:#A6ACCD;"> subTask2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SubTask</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">end </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> start</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> end</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                subTask2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fork</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u4F1A\u7EE7\u7EED\u5212\u5206\u5B50\u4EFB\u52A1\u6267\u884C</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> subTask1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> subTask2</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8D8A\u73A9\u8D8A\u6709\u9012\u5F52\u90A3\u5473\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getName</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> \u5F00\u59CB\u8BA1\u7B97 </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">start</span><span style="color:#89DDFF;">+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">-</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">end</span><span style="color:#89DDFF;">+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> \u7684\u503C!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> res </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> start</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#A6ACCD;"> end</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    res </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> res</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8FD4\u56DE\u7684\u7ED3\u679C\u4F1A\u4F5C\u4E3Ajoin\u7684\u7ED3\u679C</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div></li></ul></li></ul><p>Arrays\u5DE5\u5177\u7C7B\u63D0\u4F9B\u7684\u5E76\u884C\u6392\u5E8F\u4E5F\u662F\u5229\u7528\u4E86ForkJoinPool\u6765\u5B9E\u73B0\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">parallelSort</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">byte</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> a</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> n </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> a</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> p</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> g</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">n </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#A6ACCD;"> MIN_ARRAY_SORT_GRAN </span><span style="color:#89DDFF;">||</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ForkJoinPool</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getCommonPoolParallelism</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        DualPivotQuicksort</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sort</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> n </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">else</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ArraysParallelSortHelpers</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">FJByte</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Sorter</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">(null,</span><span style="color:#A6ACCD;"> a</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">byte</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">n</span><span style="color:#89DDFF;">],</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> n</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">g </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> n </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#A6ACCD;"> MIN_ARRAY_SORT_GRAN</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span></span>
<span class="line"><span style="color:#A6ACCD;">             MIN_ARRAY_SORT_GRAN </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> g</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">invoke</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="\u961F\u5217\u540C\u6B65\u5668aqs" tabindex="-1">\u961F\u5217\u540C\u6B65\u5668AQS <a class="header-anchor" href="#\u961F\u5217\u540C\u6B65\u5668aqs" aria-hidden="true">#</a></h4><h5 id="\u5E95\u5C42\u5B9E\u73B0-1" tabindex="-1">\u5E95\u5C42\u5B9E\u73B0 <a class="header-anchor" href="#\u5E95\u5C42\u5B9E\u73B0-1" aria-hidden="true">#</a></h5><p>AbstractQueuedSynchronizer\uFF0C\u7B80\u79F0\u961F\u5217\u540C\u6B65\u5668\uFF1A\u5185\u90E8\u5C01\u88C5\u4E86\u5305\u62EC\u9501\u7684\u83B7\u53D6\u3001\u91CA\u653E\u3001\u4EE5\u53CA\u7B49\u5F85\u961F\u5217\u3002</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">abstract</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sync</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">AbstractQueuedSynchronizer</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;">//...</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">NonfairSync</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sync</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FairSync</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sync</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"></span></code></pre></div><p>\u4E00\u4E2A\u9501\uFF08\u6392\u4ED6\u9501\u4E3A\u4F8B\uFF09\u7684\u57FA\u672C\u529F\u80FD\u5C31\u662F\u83B7\u53D6\u9501\u3001\u91CA\u653E\u9501\u3001\u5F53\u9501\u88AB\u5360\u7528\u65F6\uFF0C\u5176\u4ED6\u7EBF\u7A0B\u6765\u4E89\u62A2\u4F1A\u8FDB\u5165\u7B49\u5F85\u961F\u5217\uFF0CAQS\u5DF2\u7ECF\u5C06\u8FD9\u4E9B\u57FA\u672C\u7684\u529F\u80FD\u5C01\u88C5\u5B8C\u6210\u4E86\uFF0C\u5176\u4E2D\u7B49\u5F85\u961F\u5217\u662F\u6838\u5FC3\u5185\u5BB9\uFF0C\u7B49\u5F85\u961F\u5217\u662F\u7531\u53CC\u5411\u94FE\u8868\u6570\u636E\u7ED3\u6784\u5B9E\u73B0\u7684\uFF0C\u6BCF\u4E2A\u7B49\u5F85\u72B6\u6001\u4E0B\u7684\u7EBF\u7A0B\u90FD\u53EF\u4EE5\u88AB\u5C01\u88C5\u8FDB\u7ED3\u70B9\u4E2D\u5E76\u653E\u5165\u53CC\u5411\u94FE\u8868\u4E2D\uFF0C\u800C\u5BF9\u4E8E\u53CC\u5411\u94FE\u8868\u662F\u4EE5\u961F\u5217\u7684\u5F62\u5F0F\u8FDB\u884C\u64CD\u4F5C\u7684\uFF0C\u5982\u4E0B\uFF1A</p><p><img src="`+w+`" alt="image-20220405201620171"></p><p>AQS\u4E2D\u6709\u4E00\u4E2A<code>head</code>\u5B57\u6BB5\u548C\u4E00\u4E2A<code>tail</code>\u5B57\u6BB5\u5206\u522B\u8BB0\u5F55\u53CC\u5411\u94FE\u8868\u7684\u5934\u7ED3\u70B9\u548C\u5C3E\u7ED3\u70B9\uFF0C\u800C\u4E4B\u540E\u7684\u4E00\u7CFB\u5217\u64CD\u4F5C\u90FD\u662F\u56F4\u7ED5\u6B64\u961F\u5217\u6765\u8FDB\u884C\u7684\u3002</p><p>\u4E86\u54EA\u4E9B\u5185\u5BB9\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">//\u6BCF\u4E2A\u5904\u4E8E\u7B49\u5F85\u72B6\u6001\u7684\u7EBF\u7A0B\u90FD\u53EF\u4EE5\u662F\u4E00\u4E2A\u8282\u70B9\uFF0C\u5E76\u4E14\u6BCF\u4E2A\u8282\u70B9\u662F\u6709\u5F88\u591A\u72B6\u6001\u7684</span></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Node</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u6BCF\u4E2A\u8282\u70B9\u90FD\u53EF\u4EE5\u88AB\u5206\u4E3A\u72EC\u5360\u6A21\u5F0F\u8282\u70B9\u6216\u662F\u5171\u4EAB\u6A21\u5F0F\u8282\u70B9\uFF0C\u5206\u522B\u9002\u7528\u4E8E\u72EC\u5360\u9501\u548C\u5171\u4EAB\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> SHARED </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Node</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> EXCLUSIVE </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u7B49\u5F85\u72B6\u6001\uFF0C\u8FD9\u91CC\u90FD\u5B9A\u4E49\u597D\u4E86</span></span>
<span class="line"><span style="color:#89DDFF;">   	</span><span style="color:#676E95;">//\u552F\u4E00\u4E00\u4E2A\u5927\u4E8E0\u7684\u72B6\u6001\uFF0C\u8868\u793A\u5DF2\u5931\u6548\uFF0C\u53EF\u80FD\u662F\u7531\u4E8E\u8D85\u65F6\u6216\u4E2D\u65AD\uFF0C\u6B64\u8282\u70B9\u88AB\u53D6\u6D88\u3002</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> CANCELLED </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u6B64\u8282\u70B9\u540E\u9762\u7684\u8282\u70B9\u88AB\u6302\u8D77\uFF08\u8FDB\u5165\u7B49\u5F85\u72B6\u6001\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> SIGNAL    </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">	</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u5728\u6761\u4EF6\u961F\u5217\u4E2D\u7684\u8282\u70B9\u624D\u662F\u8FD9\u4E2A\u72B6\u6001</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> CONDITION </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u4F20\u64AD\uFF0C\u4E00\u822C\u7528\u4E8E\u5171\u4EAB\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> PROPAGATE </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> waitStatus</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u7B49\u5F85\u72B6\u6001\u503C</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> prev</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u53CC\u5411\u94FE\u8868\u57FA\u64CD</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> next</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Thread</span><span style="color:#A6ACCD;"> thread</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6BCF\u4E00\u4E2A\u7EBF\u7A0B\u90FD\u53EF\u4EE5\u88AB\u5C01\u88C5\u8FDB\u4E00\u4E2A\u8282\u70B9\u8FDB\u5165\u5230\u7B49\u5F85\u961F\u5217</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> nextWaiter</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5728\u7B49\u5F85\u961F\u5217\u4E2D\u8868\u793A\u6A21\u5F0F\uFF0C\u6761\u4EF6\u961F\u5217\u4E2D\u4F5C\u4E3A\u4E0B\u4E00\u4E2A\u7ED3\u70B9\u7684\u6307\u9488</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isShared</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> nextWaiter </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> SHARED</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">predecessor</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">NullPointerException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> p </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> prev</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">NullPointerException</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">else</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> p</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Node</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Node</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Thread</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">thread</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">mode</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">nextWaiter </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> mode</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">thread </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> thread</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Node</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Thread</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">thread</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">waitStatus</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">waitStatus </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> waitStatus</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">thread </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> thread</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5728\u4E00\u5F00\u59CB\u7684\u65F6\u5019\uFF0C<code>head</code>\u548C<code>tail</code>\u90FD\u662F<code>null</code>\uFF0C<code>state</code>\u4E3A\u9ED8\u8BA4\u503C<code>0</code>\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">transient</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> head</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">transient</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> tail</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> state</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p>\u4E0D\u7528\u62C5\u5FC3\u53CC\u5411\u94FE\u8868\u4E0D\u4F1A\u8FDB\u884C\u521D\u59CB\u5316\uFF0C\u521D\u59CB\u5316\u662F\u5728\u5B9E\u9645\u4F7F\u7528\u65F6\u624D\u5F00\u59CB\u7684\uFF0C\u5148\u4E0D\u7BA1\uFF0C\u6211\u4EEC\u63A5\u7740\u6765\u770B\u5176\u4ED6\u7684\u521D\u59CB\u5316\u5185\u5BB9\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">//\u76F4\u63A5\u4F7F\u7528Unsafe\u7C7B\u8FDB\u884C\u64CD\u4F5C</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Unsafe</span><span style="color:#A6ACCD;"> unsafe </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Unsafe</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getUnsafe</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#676E95;">//\u8BB0\u5F55\u7C7B\u4E2D\u5C5E\u6027\u7684\u5728\u5185\u5B58\u4E2D\u7684\u504F\u79FB\u5730\u5740\uFF0C\u65B9\u4FBFUnsafe\u7C7B\u76F4\u63A5\u64CD\u4F5C\u5185\u5B58\u8FDB\u884C\u8D4B\u503C\u7B49\uFF08\u76F4\u63A5\u4FEE\u6539\u5BF9\u5E94\u5730\u5740\u7684\u5185\u5B58\uFF09</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> stateOffset</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8FD9\u91CC\u5BF9\u5E94\u7684\u5C31\u662FAQS\u7C7B\u4E2D\u7684state\u6210\u5458\u5B57\u6BB5</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> headOffset</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u8FD9\u91CC\u5BF9\u5E94\u7684\u5C31\u662FAQS\u7C7B\u4E2D\u7684head\u5934\u7ED3\u70B9\u6210\u5458\u5B57\u6BB5</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> tailOffset</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> waitStatusOffset</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> nextOffset</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u9759\u6001\u4EE3\u7801\u5757\uFF0C\u5728\u7C7B\u52A0\u8F7D\u7684\u65F6\u5019\u5C31\u4F1A\u81EA\u52A8\u83B7\u53D6\u504F\u79FB\u5730\u5740</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        stateOffset </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> unsafe</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">objectFieldOffset</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">AbstractQueuedSynchronizer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getDeclaredField</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">state</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">        headOffset </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> unsafe</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">objectFieldOffset</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">AbstractQueuedSynchronizer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getDeclaredField</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">head</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">        tailOffset </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> unsafe</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">objectFieldOffset</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">AbstractQueuedSynchronizer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getDeclaredField</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">tail</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">        waitStatusOffset </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> unsafe</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">objectFieldOffset</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getDeclaredField</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">waitStatus</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">        nextOffset </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> unsafe</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">objectFieldOffset</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getDeclaredField</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">next</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Exception</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">ex</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Error</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ex</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">//\u901A\u8FC7CAS\u64CD\u4F5C\u6765\u4FEE\u6539\u5934\u7ED3\u70B9</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">compareAndSetHead</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> update</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u8C03\u7528\u7684\u662FUnsafe\u7C7B\u7684compareAndSwapObject\u65B9\u6CD5\uFF0C\u901A\u8FC7CAS\u7B97\u6CD5\u6BD4\u8F83\u5BF9\u8C61\u5E76\u66FF\u6362</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> unsafe</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">compareAndSwapObject</span><span style="color:#89DDFF;">(this,</span><span style="color:#A6ACCD;"> headOffset</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null,</span><span style="color:#A6ACCD;"> update</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">//\u540C\u4E0A\uFF0C\u7701\u7565\u90E8\u5206\u4EE3\u7801</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">compareAndSetTail</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> expect</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> update</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">compareAndSetWaitStatus</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> expect</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> update</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">compareAndSetNext</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> expect</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> update</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span></code></pre></div><p>\u53EF\u4EE5\u53D1\u73B0\uFF0C\u961F\u5217\u540C\u6B65\u5668\u7531\u4E8E\u8981\u4F7F\u7528\u5230CAS\u7B97\u6CD5\uFF0C\u6240\u4EE5\uFF0C\u76F4\u63A5\u4F7F\u7528\u4E86Unsafe\u5DE5\u5177\u7C7B\uFF0CUnsafe\u7C7B\u4E2D\u63D0\u4F9B\u4E86CAS\u64CD\u4F5C\u7684\u65B9\u6CD5\uFF08Java\u65E0\u6CD5\u5B9E\u73B0\uFF0C\u5E95\u5C42\u7531C++\u5B9E\u73B0\uFF09\u6240\u6709\u5BF9AQS\u7C7B\u4E2D\u6210\u5458\u5B57\u6BB5\u7684\u4FEE\u6539\uFF0C\u90FD\u6709\u5BF9\u5E94\u7684CAS\u64CD\u4F5C\u5C01\u88C5\u3002</p><p>\u73B0\u5728\u6211\u4EEC\u5927\u81F4\u4E86\u89E3\u4E86\u4E00\u4E0B\u5B83\u7684\u5E95\u5C42\u8FD0\u4F5C\u673A\u5236\uFF0C\u6211\u4EEC\u63A5\u7740\u6765\u770B\u8FD9\u4E2A\u7C7B\u662F\u5982\u4F55\u8FDB\u884C\u4F7F\u7528\u7684\uFF0C\u5B83\u63D0\u4F9B\u4E86\u4E00\u4E9B\u53EF\u91CD\u5199\u7684\u65B9\u6CD5\uFF08\u6839\u636E\u4E0D\u540C\u7684\u9501\u7C7B\u578B\u548C\u673A\u5236\uFF0C\u53EF\u4EE5\u81EA\u7531\u5B9A\u5236\u89C4\u5219\uFF0C\u5E76\u4E14\u4E3A\u72EC\u5360\u5F0F\u548C\u975E\u72EC\u5360\u5F0F\u9501\u90FD\u63D0\u4F9B\u4E86\u5BF9\u5E94\u7684\u65B9\u6CD5\uFF09\uFF0C\u4EE5\u53CA\u4E00\u4E9B\u5DF2\u7ECF\u5199\u597D\u7684\u6A21\u677F\u65B9\u6CD5\uFF08\u6A21\u677F\u65B9\u6CD5\u4F1A\u8C03\u7528\u8FD9\u4E9B\u53EF\u91CD\u5199\u7684\u65B9\u6CD5\uFF09\uFF0C\u4F7F\u7528\u6B64\u7C7B\u53EA\u9700\u8981\u5C06\u53EF\u91CD\u5199\u7684\u65B9\u6CD5\u8FDB\u884C\u91CD\u5199\uFF0C\u5E76\u8C03\u7528\u63D0\u4F9B\u7684\u6A21\u677F\u65B9\u6CD5\uFF0C\u4ECE\u800C\u5B9E\u73B0\u9501\u529F\u80FD\uFF08\u5B66\u4E60\u8FC7\u8BBE\u8BA1\u6A21\u5F0F\u4F1A\u6BD4\u8F83\u597D\u7406\u89E3\u4E00\u4E9B\uFF09</p><p>\u6211\u4EEC\u9996\u5148\u6765\u770B\u53EF\u91CD\u5199\u65B9\u6CD5\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">//\u72EC\u5360\u5F0F\u83B7\u53D6\u540C\u6B65\u72B6\u6001\uFF0C\u67E5\u770B\u540C\u6B65\u72B6\u6001\u662F\u5426\u548C\u53C2\u6570\u4E00\u81F4\uFF0C\u5982\u679C\u8FD4\u6CA1\u6709\u95EE\u9898\uFF0C\u90A3\u4E48\u4F1A\u4F7F\u7528CAS\u64CD\u4F5C\u8BBE\u7F6E\u540C\u6B65\u72B6\u6001\u5E76\u8FD4\u56DEtrue</span></span>
<span class="line"><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryAcquire</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> arg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UnsupportedOperationException</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">//\u72EC\u5360\u5F0F\u91CA\u653E\u540C\u6B65\u72B6\u6001</span></span>
<span class="line"><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryRelease</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> arg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UnsupportedOperationException</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">//\u5171\u4EAB\u5F0F\u83B7\u53D6\u540C\u6B65\u72B6\u6001\uFF0C\u8FD4\u56DE\u503C\u5927\u4E8E0\u8868\u793A\u6210\u529F\uFF0C\u5426\u5219\u5931\u8D25</span></span>
<span class="line"><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryAcquireShared</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> arg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UnsupportedOperationException</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">//\u5171\u4EAB\u5F0F\u91CA\u653E\u540C\u6B65\u72B6\u6001</span></span>
<span class="line"><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryReleaseShared</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> arg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UnsupportedOperationException</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">//\u662F\u5426\u5728\u72EC\u5360\u6A21\u5F0F\u4E0B\u88AB\u5F53\u524D\u7EBF\u7A0B\u5360\u7528\uFF08\u9501\u662F\u5426\u88AB\u5F53\u524D\u7EBF\u7A0B\u6301\u6709\uFF09</span></span>
<span class="line"><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isHeldExclusively</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UnsupportedOperationException</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u8FD9\u4E9B\u9700\u8981\u91CD\u5199\u7684\u65B9\u6CD5\u9ED8\u8BA4\u662F\u76F4\u63A5\u629B\u51FA<code>UnsupportedOperationException</code>\uFF0C\u4E5F\u5C31\u662F\u8BF4\u6839\u636E\u4E0D\u540C\u7684\u9501\u7C7B\u578B\uFF0C\u6211\u4EEC\u9700\u8981\u53BB\u5B9E\u73B0\u5BF9\u5E94\u7684\u65B9\u6CD5\uFF0C\u6211\u4EEC\u53EF\u4EE5\u6765\u770B\u4E00\u4E0BReentrantLock\uFF08\u6B64\u7C7B\u662F\u5168\u5C40\u72EC\u5360\u5F0F\u7684\uFF09\u4E2D\u7684\u516C\u5E73\u9501\u662F\u5982\u4F55\u501F\u52A9AQS\u5B9E\u73B0\u7684\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FairSync</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sync</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> serialVersionUID </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">3000897897090466540L</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u52A0\u9501\u64CD\u4F5C\u8C03\u7528\u4E86\u6A21\u677F\u65B9\u6CD5acquire</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u4E3A\u4E86\u9632\u6B62\u5404\u4F4D\u7ED5\u6655\uFF0C\u8BF7\u65F6\u523B\u8BB0\u4F4F\uFF0Clock\u65B9\u6CD5\u4E00\u5B9A\u662F\u5728\u67D0\u4E2A\u7EBF\u7A0B\u4E0B\u4E3A\u4E86\u52A0\u9501\u800C\u8C03\u7528\u7684\uFF0C\u5E76\u4E14\u540C\u4E00\u65F6\u95F4\u53EF\u80FD\u4F1A\u6709\u5176\u4ED6\u7EBF\u7A0B\u4E5F\u5728\u8C03\u7528\u6B64\u65B9\u6CD5</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">acquire</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">...</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u6211\u4EEC\u5148\u770B\u770B\u52A0\u9501\u64CD\u4F5C\u5E72\u4E86\u4EC0\u4E48\u4E8B\u60C5\uFF0C\u8FD9\u91CC\u76F4\u63A5\u8C03\u7528\u4E86AQS\u63D0\u4F9B\u7684\u6A21\u677F\u65B9\u6CD5<code>acquire()</code>\uFF0C\u6211\u4EEC\u6765\u770B\u770B\u5B83\u5728AQS\u7C7B\u4E2D\u7684\u5B9E\u73B0\u7EC6\u8282\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">ReservedStackAccess</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">//\u8FD9\u4E2A\u662FJEP 270\u6DFB\u52A0\u7684\u65B0\u6CE8\u89E3\uFF0C\u5B83\u4F1A\u4FDD\u62A4\u88AB\u6CE8\u89E3\u7684\u65B9\u6CD5\uFF0C\u901A\u8FC7\u6DFB\u52A0\u4E00\u4E9B\u989D\u5916\u7684\u7A7A\u95F4\uFF0C\u9632\u6B62\u5728\u591A\u7EBF\u7A0B\u8FD0\u884C\u7684\u65F6\u5019\u51FA\u73B0\u6808\u6EA2\u51FA\uFF0C\u4E0B\u540C</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">acquire</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> arg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#82AAFF;">tryAcquire</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">acquireQueued</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">addWaiter</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">EXCLUSIVE</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> arg</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8282\u70B9\u4E3A\u72EC\u5360\u6A21\u5F0FNode.EXCLUSIVE</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">selfInterrupt</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u9996\u5148\u4F1A\u8C03\u7528<code>tryAcquire()</code>\u65B9\u6CD5\uFF08\u8FD9\u91CC\u662F\u7531FairSync\u7C7B\u5B9E\u73B0\u7684\uFF09\uFF0C\u5982\u679C\u5C1D\u8BD5\u52A0\u72EC\u5360\u9501\u5931\u8D25\uFF08\u8FD4\u56DEfalse\u4E86\uFF09\u8BF4\u660E\u53EF\u80FD\u8FD9\u4E2A\u65F6\u5019\u6709\u5176\u4ED6\u7EBF\u7A0B\u6301\u6709\u4E86\u6B64\u72EC\u5360\u9501\uFF0C\u6240\u4EE5\u5F53\u524D\u7EBF\u7A0B\u5F97\u5148\u7B49\u7740\uFF0C\u90A3\u4E48\u4F1A\u8C03\u7528<code>addWaiter()</code>\u65B9\u6CD5\u5C06\u7EBF\u7A0B\u52A0\u5165\u7B49\u5F85\u961F\u5217\u4E2D\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">addWaiter</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> mode</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> node </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Node</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> mode</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u5148\u5C1D\u8BD5\u4F7F\u7528CAS\u76F4\u63A5\u5165\u961F\uFF0C\u5982\u679C\u8FD9\u4E2A\u65F6\u5019\u5176\u4ED6\u7EBF\u7A0B\u4E5F\u5728\u5165\u961F\uFF08\u5C31\u662F\u4E0D\u6B62\u4E00\u4E2A\u7EBF\u7A0B\u5728\u540C\u4E00\u65F6\u95F4\u4E89\u62A2\u8FD9\u628A\u9501\uFF09\u5C31\u8FDB\u5165enq()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> pred </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> tail</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">pred </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">prev </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pred</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">compareAndSetTail</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">pred</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            pred</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">next </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u6B64\u65B9\u6CD5\u662FCAS\u5FEB\u901F\u5165\u961F\u5931\u8D25\u65F6\u8C03\u7528</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">enq</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">enq</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u81EA\u65CB\u5F62\u5F0F\u5165\u961F\uFF0C\u53EF\u4EE5\u770B\u5230\u8FD9\u91CC\u662F\u4E00\u4E2A\u65E0\u9650\u5FAA\u73AF</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(;;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> t </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> tail</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//\u8FD9\u79CD\u60C5\u51B5\u53EA\u80FD\u8BF4\u660E\u5934\u7ED3\u70B9\u548C\u5C3E\u7ED3\u70B9\u90FD\u8FD8\u6CA1\u521D\u59CB\u5316</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">compareAndSetHead</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Node</span><span style="color:#89DDFF;">()))</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u521D\u59CB\u5316\u5934\u7ED3\u70B9\u548C\u5C3E\u7ED3\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">                tail </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> head</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">prev </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> t</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">compareAndSetTail</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                t</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">next </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> t</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u53EA\u6709CAS\u6210\u529F\u7684\u60C5\u51B5\u4E0B\uFF0C\u624D\u7B97\u5165\u961F\u6210\u529F\uFF0C\u5982\u679CCAS\u5931\u8D25\uFF0C\u90A3\u8BF4\u660E\u5176\u4ED6\u7EBF\u7A0B\u540C\u4E00\u65F6\u95F4\u4E5F\u5728\u5165\u961F\uFF0C\u5E76\u4E14\u624B\u901F\u8FD8\u6BD4\u5F53\u524D\u7EBF\u7A0B\u5FEB\uFF0C\u521A\u597D\u8D70\u5230CAS\u64CD\u4F5C\u7684\u65F6\u5019\uFF0C\u5176\u4ED6\u7EBF\u7A0B\u5C31\u5148\u5165\u961F\u4E86\uFF0C\u90A3\u4E48\u8FD9\u4E2A\u65F6\u5019node.prev\u5C31\u4E0D\u662F\u6211\u4EEC\u9884\u671F\u7684\u8282\u70B9\u4E86\uFF0C\u800C\u662F\u53E6\u4E00\u4E2A\u7EBF\u7A0B\u65B0\u5165\u961F\u7684\u8282\u70B9\uFF0C\u6240\u4EE5\u8BF4\u5F97\u8FDB\u4E0B\u4E00\u6B21\u5FAA\u73AF\u518D\u6765\u4E00\u6B21CAS\uFF0C\u8FD9\u79CD\u5F62\u5F0F\u5C31\u662F\u81EA\u65CB</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5728\u4E86\u89E3\u4E86<code>addWaiter()</code>\u65B9\u6CD5\u4F1A\u5C06\u8282\u70B9\u52A0\u5165\u7B49\u5F85\u961F\u5217\u4E4B\u540E\uFF0C\u6211\u4EEC\u63A5\u7740\u6765\u770B\uFF0C<code>addWaiter()</code>\u4F1A\u8FD4\u56DE\u5DF2\u7ECF\u52A0\u5165\u7684\u8282\u70B9\uFF0C<code>acquireQueued()</code>\u5728\u5F97\u5230\u8FD4\u56DE\u7684\u8282\u70B9\u65F6\uFF0C\u4E5F\u4F1A\u8FDB\u5165\u81EA\u65CB\u72B6\u6001\uFF0C\u7B49\u5F85\u5524\u9192\uFF08\u4E5F\u5C31\u662F\u5F00\u59CB\u8FDB\u5165\u5230\u62FF\u9501\u7684\u73AF\u8282\u4E86\uFF09\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">ReservedStackAccess</span></span>
<span class="line"><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">acquireQueued</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> arg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> failed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> interrupted </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(;;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> p </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">predecessor</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> head </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryAcquire</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u53EF\u4EE5\u770B\u5230\u5F53\u6B64\u8282\u70B9\u4F4D\u4E8E\u961F\u9996(node.prev == head)\u65F6\uFF0C\u4F1A\u518D\u6B21\u8C03\u7528tryAcquire\u65B9\u6CD5\u83B7\u53D6\u9501\uFF0C\u5982\u679C\u83B7\u53D6\u6210\u529F\uFF0C\u4F1A\u8FD4\u56DE\u6B64\u8FC7\u7A0B\u4E2D\u662F\u5426\u88AB\u4E2D\u65AD\u7684\u503C</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">setHead</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u65B0\u7684\u5934\u7ED3\u70B9\u8BBE\u7F6E\u4E3A\u5F53\u524D\u7ED3\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">                p</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">next </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u539F\u6709\u7684\u5934\u7ED3\u70B9\u6CA1\u6709\u5B58\u5728\u7684\u610F\u4E49\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">                failed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6CA1\u6709\u5931\u8D25</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> interrupted</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u76F4\u63A5\u8FD4\u56DE\u7B49\u5F85\u8FC7\u7A0B\u4E2D\u662F\u5426\u88AB\u4E2D\u65AD</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">	</span></span>
<span class="line"><span style="color:#89DDFF;">          	</span><span style="color:#676E95;">//\u4F9D\u7136\u6CA1\u83B7\u53D6\u6210\u529F\uFF0C</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">shouldParkAfterFailedAcquire</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5C06\u5F53\u524D\u8282\u70B9\u7684\u524D\u9A71\u8282\u70B9\u7B49\u5F85\u72B6\u6001\u8BBE\u7F6E\u4E3ASIGNAL\uFF0C\u5982\u679C\u5931\u8D25\u5C06\u76F4\u63A5\u5F00\u542F\u4E0B\u4E00\u8F6E\u5FAA\u73AF\uFF0C\u76F4\u5230\u6210\u529F\u4E3A\u6B62\uFF0C\u5982\u679C\u6210\u529F\u63A5\u7740\u5F80\u4E0B</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">parkAndCheckInterrupt</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6302\u8D77\u7EBF\u7A0B\u8FDB\u5165\u7B49\u5F85\u72B6\u6001\uFF0C\u7B49\u5F85\u88AB\u5524\u9192\uFF0C\u5982\u679C\u5728\u7B49\u5F85\u72B6\u6001\u4E0B\u88AB\u4E2D\u65AD\uFF0C\u90A3\u4E48\u4F1A\u8FD4\u56DEtrue\uFF0C\u76F4\u63A5\u5C06\u4E2D\u65AD\u6807\u5FD7\u8BBE\u4E3Atrue\uFF0C\u5426\u5219\u5C31\u662F\u6B63\u5E38\u5524\u9192\uFF0C\u7EE7\u7EED\u81EA\u65CB</span></span>
<span class="line"><span style="color:#A6ACCD;">                interrupted </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">failed</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">cancelAcquire</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">parkAndCheckInterrupt</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    LockSupport</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">park</span><span style="color:#89DDFF;">(this);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u901A\u8FC7unsafe\u7C7B\u64CD\u4F5C\u5E95\u5C42\u6302\u8D77\u7EBF\u7A0B\uFF08\u4F1A\u76F4\u63A5\u8FDB\u5165\u963B\u585E\u72B6\u6001\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">interrupted</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">shouldParkAfterFailedAcquire</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> pred</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> ws </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pred</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">waitStatus</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ws </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> Node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SIGNAL</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5DF2\u7ECF\u662FSIGNAL\uFF0C\u76F4\u63A5true</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ws </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u4E0D\u80FD\u662F\u5DF2\u7ECF\u53D6\u6D88\u7684\u8282\u70B9\uFF0C\u5FC5\u987B\u627E\u5230\u4E00\u4E2A\u6CA1\u88AB\u53D6\u6D88\u7684</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">do</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">prev </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pred </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pred</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">prev</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">pred</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">waitStatus </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        pred</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">next </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u76F4\u63A5\u629B\u5F03\u88AB\u53D6\u6D88\u7684\u8282\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">//\u4E0D\u662FSIGNAL\uFF0C\u5148CAS\u8BBE\u7F6E\u4E3ASIGNAL\uFF08\u8FD9\u91CC\u6CA1\u6709\u8FD4\u56DEtrue\u56E0\u4E3ACAS\u4E0D\u4E00\u5B9A\u6210\u529F\uFF0C\u9700\u8981\u4E0B\u4E00\u8F6E\u518D\u5224\u65AD\u4E00\u6B21\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">compareAndSetWaitStatus</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">pred</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> ws</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SIGNAL</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8FD4\u56DEfalse\uFF0C\u9A6C\u4E0A\u5F00\u542F\u4E0B\u4E00\u8F6E\u5FAA\u73AF</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u6240\u4EE5\uFF0C<code>acquire()</code>\u4E2D\u7684if\u6761\u4EF6\u5982\u679C\u4E3Atrue\uFF0C\u90A3\u4E48\u53EA\u6709\u4E00\u79CD\u60C5\u51B5\uFF0C\u5C31\u662F\u7B49\u5F85\u8FC7\u7A0B\u4E2D\u88AB\u4E2D\u65AD\u4E86\uFF0C\u5176\u4ED6\u4EFB\u4F55\u60C5\u51B5\u4E0B\u90FD\u662F\u6210\u529F\u83B7\u53D6\u5230\u72EC\u5360\u9501\uFF0C\u6240\u4EE5\u5F53\u7B49\u5F85\u8FC7\u7A0B\u88AB\u4E2D\u65AD\u65F6\uFF0C\u4F1A\u8C03\u7528<code>selfInterrupt()</code>\u65B9\u6CD5\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">selfInterrupt</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">interrupt</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u8FD9\u91CC\u5C31\u662F\u76F4\u63A5\u5411\u5F53\u524D\u7EBF\u7A0B\u53D1\u9001\u4E2D\u65AD\u4FE1\u53F7\u4E86\u3002</p><p>\u4E0A\u9762\u63D0\u5230\u4E86LockSupport\u7C7B\uFF0C\u5B83\u662F\u4E00\u4E2A\u5DE5\u5177\u7C7B\uFF0C\u6211\u4EEC\u4E5F\u53EF\u4EE5\u6765\u73A9\u4E00\u4E0B\u8FD9\u4E2A<code>park</code>\u548C<code>unpark</code>:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Thread</span><span style="color:#A6ACCD;"> t </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//\u5148\u62FF\u5230\u4E3B\u7EBF\u7A0B\u7684Thread\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u4E3B\u7EBF\u7A0B\u53EF\u4EE5\u7EE7\u7EED\u8FD0\u884C\u4E86\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            LockSupport</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unpark</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">          	</span><span style="color:#676E95;">//t.interrupt();   \u53D1\u9001\u4E2D\u65AD\u4FE1\u53F7\u4E5F\u53EF\u4EE5\u6062\u590D\u8FD0\u884C</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">printStackTrace</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u4E3B\u7EBF\u7A0B\u88AB\u6302\u8D77\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    LockSupport</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">park</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u4E3B\u7EBF\u7A0B\u7EE7\u7EED\u8FD0\u884C\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u8FD9\u91CC\u6211\u4EEC\u5C31\u628A\u516C\u5E73\u9501\u7684<code>lock()</code>\u65B9\u6CD5\u5B9E\u73B0\u8BB2\u89E3\u5B8C\u6BD5\u4E86\uFF08\u8BA9\u6211\u731C\u731C\uFF0C\u5DF2\u7ECF\u6655\u4E86\u5BF9\u5427\uFF0C\u8D8A\u662F\u5230\u6E90\u7801\u8D8A\u8003\u9A8C\u4E2A\u4EBA\u7684\u57FA\u7840\u77E5\u8BC6\u638C\u63E1\uFF0C\u57FA\u7840\u4E0D\u7262\u5730\u52A8\u5C71\u6447\uFF09\u63A5\u7740\u6211\u4EEC\u6765\u770B\u516C\u5E73\u9501\u7684<code>tryAcquire()</code>\u65B9\u6CD5\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FairSync</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sync</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u53EF\u91CD\u5165\u72EC\u5360\u9501\u7684\u516C\u5E73\u5B9E\u73B0</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">ReservedStackAccess</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryAcquire</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">acquires</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Thread</span><span style="color:#A6ACCD;"> current </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5148\u83B7\u53D6\u5F53\u524D\u7EBF\u7A0B\u7684Thread\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> c </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getState</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">//\u83B7\u53D6\u5F53\u524DAQS\u5BF9\u8C61\u72B6\u6001\uFF08\u72EC\u5360\u6A21\u5F0F\u4E0B0\u4E3A\u672A\u5360\u7528\uFF0C\u5927\u4E8E0\u8868\u793A\u5DF2\u5360\u7528\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">       </span><span style="color:#676E95;">//\u5982\u679C\u662F0\uFF0C\u90A3\u5C31\u8868\u793A\u6CA1\u6709\u5360\u7528\uFF0C\u73B0\u5728\u6211\u4EEC\u7684\u7EBF\u7A0B\u5C31\u8981\u6765\u5C1D\u8BD5\u5360\u7528\u5B83</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#82AAFF;">hasQueuedPredecessors</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u7B49\u5F85\u961F\u5217\u662F\u5426\u4E0D\u4E3A\u7A7A\u4E14\u5F53\u524D\u7EBF\u7A0B\u6CA1\u6709\u62FF\u5230\u9501\uFF0C\u5176\u5B9E\u5C31\u662F\u770B\u770B\u5F53\u524D\u7EBF\u7A0B\u6709\u6CA1\u6709\u5FC5\u8981\u8FDB\u884C\u6392\u961F\uFF0C\u5982\u679C\u6CA1\u5FC5\u8981\u6392\u961F\uFF0C\u5C31\u8BF4\u660E\u53EF\u4EE5\u76F4\u63A5\u83B7\u53D6\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">compareAndSetState</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> acquires</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//CAS\u8BBE\u7F6E\u72B6\u6001\uFF0C\u5982\u679C\u6210\u529F\u5219\u8BF4\u660E\u6210\u529F\u62FF\u5230\u4E86\u8FD9\u628A\u9501\uFF0C\u5931\u8D25\u5219\u8BF4\u660E\u53EF\u80FD\u8FD9\u4E2A\u65F6\u5019\u5176\u4ED6\u7EBF\u7A0B\u5728\u4E89\u62A2\uFF0C\u5E76\u4E14\u8FD8\u6BD4\u4F60\u5148\u62A2\u5230</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">setExclusiveOwnerThread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u6210\u529F\u62FF\u5230\u9501\uFF0C\u4F1A\u5C06\u72EC\u5360\u6A21\u5F0F\u6240\u6709\u8005\u7EBF\u7A0B\u8BBE\u5B9A\u4E3A\u5F53\u524D\u7EBF\u7A0B\uFF08\u8FD9\u4E2A\u65B9\u6CD5\u662F\u7236\u7C7BAbstractOwnableSynchronizer\u4E2D\u7684\uFF0C\u5C31\u8868\u793A\u5F53\u524D\u8FD9\u628A\u9501\u5DF2\u7ECF\u662F\u8FD9\u4E2A\u7EBF\u7A0B\u7684\u4E86\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5360\u7528\u9501\u6210\u529F\uFF0C\u8FD4\u56DEtrue</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">current </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getExclusiveOwnerThread</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u4E0D\u662F0\uFF0C\u90A3\u5C31\u8868\u793A\u88AB\u7EBF\u7A0B\u5360\u7528\u4E86\uFF0C\u8FD9\u4E2A\u65F6\u5019\u770B\u770B\u662F\u4E0D\u662F\u81EA\u5DF1\u5360\u7528\u7684\uFF0C\u5982\u679C\u662F\uFF0C\u7531\u4E8E\u662F\u53EF\u91CD\u5165\u9501\uFF0C\u53EF\u4EE5\u7EE7\u7EED\u52A0\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> nextc </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> c </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> acquires</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u591A\u6B21\u52A0\u9501\u4F1A\u5C06\u72B6\u6001\u503C\u8FDB\u884C\u589E\u52A0\uFF0C\u72B6\u6001\u503C\u5C31\u662F\u52A0\u9501\u6B21\u6570</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">nextc </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u52A0\u5230int\u503C\u6EA2\u51FA\u4E86\uFF1F</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Error</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Maximum lock count exceeded</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">setState</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">nextc</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8BBE\u7F6E\u4E3A\u65B0\u7684\u52A0\u9501\u6B21\u6570</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5176\u4ED6\u4EFB\u4F55\u60C5\u51B5\u90FD\u662F\u52A0\u9501\u5931\u8D25</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5728\u4E86\u89E3\u4E86\u516C\u5E73\u9501\u7684\u5B9E\u73B0\u4E4B\u540E\uFF0C\u662F\u4E0D\u662F\u611F\u89C9\u6709\u70B9\u604D\u7136\u5927\u609F\u7684\u611F\u89C9\uFF0C\u867D\u7136\u6574\u4E2A\u8FC7\u7A0B\u975E\u5E38\u590D\u6742\uFF0C\u4F46\u662F\u53EA\u8981\u7406\u6E05\u601D\u8DEF\uFF0C\u8FD8\u662F\u6BD4\u8F83\u7B80\u5355\u7684\u3002</p><p>\u52A0\u9501\u8FC7\u7A0B\u5DF2\u7ECFOK\uFF0C\u6211\u4EEC\u63A5\u7740\u6765\u770B\uFF0C\u5B83\u7684\u89E3\u9501\u8FC7\u7A0B\uFF0C<code>unlock()</code>\u65B9\u6CD5\u662F\u5728AQS\u4E2D\u5B9E\u73B0\u7684\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    sync</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">release</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u76F4\u63A5\u8C03\u7528\u4E86AQS\u4E2D\u7684release\u65B9\u6CD5\uFF0C\u53C2\u6570\u4E3A1\u8868\u793A\u89E3\u9501\u4E00\u6B21state\u503C-1</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">ReservedStackAccess</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">release</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> arg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">tryRelease</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u548CtryAcquire\u4E00\u6837\uFF0C\u4E5F\u5F97\u5B50\u7C7B\u53BB\u91CD\u5199\uFF0C\u91CA\u653E\u9501\u64CD\u4F5C</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> h </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> head</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u91CA\u653E\u9501\u6210\u529F\u540E\uFF0C\u83B7\u53D6\u65B0\u7684\u5934\u7ED3\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">h </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> h</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">waitStatus </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u65B0\u7684\u5934\u7ED3\u70B9\u4E0D\u4E3A\u7A7A\u5E76\u4E14\u4E0D\u662F\u521A\u521A\u5EFA\u7ACB\u7684\u7ED3\u70B9\uFF08\u521D\u59CB\u72B6\u6001\u4E0Bstatus\u4E3A\u9ED8\u8BA4\u503C0\uFF0C\u800C\u4E0A\u9762\u5728\u8FDB\u884C\u4E86shouldParkAfterFailedAcquire\u4E4B\u540E\uFF0C\u4F1A\u88AB\u8BBE\u5B9A\u4E3ASIGNAL\u72B6\u6001\uFF0C\u503C\u4E3A-1\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">unparkSuccessor</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">h</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5524\u9192\u5934\u8282\u70B9\u4E0B\u4E00\u4E2A\u8282\u70B9\u4E2D\u7684\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">unparkSuccessor</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u5C06\u7B49\u5F85\u72B6\u6001waitStatus\u8BBE\u7F6E\u4E3A\u521D\u59CB\u503C0</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> ws </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">waitStatus</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ws </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">compareAndSetWaitStatus</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> ws</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//\u83B7\u53D6\u4E0B\u4E00\u4E2A\u7ED3\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> s </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">next</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">waitStatus </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u4E0B\u4E00\u4E2A\u7ED3\u70B9\u4E3A\u7A7A\u6216\u662F\u7B49\u5F85\u72B6\u6001\u662F\u5DF2\u53D6\u6D88\uFF0C\u90A3\u80AF\u5B9A\u662F\u4E0D\u80FD\u901A\u77E5unpark\u7684\uFF0C\u8FD9\u65F6\u5C31\u8981\u904D\u5386\u6240\u6709\u8282\u70B9\u518D\u53E6\u5916\u627E\u4E00\u4E2A\u7B26\u5408unpark\u8981\u6C42\u7684\u8282\u70B9\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">        s </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> t </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> tail</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> t </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> t </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> t </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> t</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">prev</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8FD9\u91CC\u662F\u4ECE\u961F\u5C3E\u5411\u524D\uFF0C\u56E0\u4E3Aenq()\u65B9\u6CD5\u4E2D\u7684t.next = node\u662F\u5728CAS\u4E4B\u540E\u8FDB\u884C\u7684\uFF0C\u800C node.prev = t \u662FCAS\u4E4B\u524D\u8FDB\u884C\u7684\uFF0C\u6240\u4EE5\u4ECE\u540E\u5F80\u524D\u4E00\u5B9A\u80FD\u591F\u4FDD\u8BC1\u904D\u5386\u6240\u6709\u8282\u70B9</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">waitStatus </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                s </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> t</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8981\u662F\u627E\u5230\u4E86\uFF0C\u5C31\u76F4\u63A5unpark\uFF0C\u8981\u662F\u8FD8\u662F\u6CA1\u627E\u5230\uFF0C\u90A3\u5C31\u7B97\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">        LockSupport</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unpark</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">thread</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u90A3\u4E48\u6211\u4EEC\u6765\u770B\u770B<code>tryRelease()</code>\u65B9\u6CD5\u662F\u600E\u4E48\u5B9E\u73B0\u7684\uFF0C\u5177\u4F53\u5B9E\u73B0\u5728Sync\u4E2D\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">ReservedStackAccess</span></span>
<span class="line"><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryRelease</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> releases</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> c </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getState</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> releases</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5148\u8BA1\u7B97\u672C\u6B21\u89E3\u9501\u4E4B\u540E\u7684\u72B6\u6001\u503C</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getExclusiveOwnerThread</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u56E0\u4E3A\u662F\u72EC\u5360\u9501\uFF0C\u90A3\u80AF\u5B9A\u8FD9\u628A\u9501\u5F97\u662F\u5F53\u524D\u7EBF\u7A0B\u6301\u6709\u624D\u884C</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IllegalMonitorStateException</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5426\u5219\u76F4\u63A5\u629B\u5F02\u5E38</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> free </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//\u5982\u679C\u89E3\u9501\u4E4B\u540E\u7684\u503C\u4E3A0\uFF0C\u8868\u793A\u5DF2\u7ECF\u5B8C\u5168\u91CA\u653E\u6B64\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">        free </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">setExclusiveOwnerThread</span><span style="color:#89DDFF;">(null);</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//\u5C06\u72EC\u5360\u9501\u6301\u6709\u7EBF\u7A0B\u8BBE\u7F6E\u4E3Anull</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">setState</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u72B6\u6001\u503C\u8BBE\u5B9A\u4E3Ac</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> free</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//\u5982\u679C\u4E0D\u662F0\u8868\u793A\u6B64\u9501\u8FD8\u6CA1\u5B8C\u5168\u91CA\u653E\uFF0C\u8FD4\u56DEfalse\uFF0C\u662F0\u5C31\u8FD4\u56DEtrue</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u7EFC\u4E0A\uFF0C\u6211\u4EEC\u6765\u753B\u4E00\u4E2A \u516C\u5E73\u9501 \u5B8C\u6574\u7684\u6D41\u7A0B\u56FE\uFF1A</p><p><img src="`+x+`" alt="image-20220306141248030"></p><h5 id="\u516C\u5E73\u9501\u7684\u4E0D\u516C\u5E73\u6027" tabindex="-1">\u516C\u5E73\u9501\u7684\u4E0D\u516C\u5E73\u6027 <a class="header-anchor" href="#\u516C\u5E73\u9501\u7684\u4E0D\u516C\u5E73\u6027" aria-hidden="true">#</a></h5><p><code>tryAcquire()</code>\u5B9E\u73B0\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">ReservedStackAccess</span></span>
<span class="line"><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryAcquire</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> acquires</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Thread</span><span style="color:#A6ACCD;"> current </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> c </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getState</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#82AAFF;">hasQueuedPredecessors</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6CE8\u610F\u8FD9\u91CC\uFF0C\u516C\u5E73\u9501\u7684\u673A\u5236\u662F\uFF0C\u4E00\u5F00\u59CB\u4F1A\u67E5\u770B\u662F\u5426\u6709\u8282\u70B9\u5904\u4E8E\u7B49\u5F85</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">compareAndSetState</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> acquires</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u524D\u9762\u7684\u65B9\u6CD5\u6267\u884C\u540E\u53D1\u73B0\u6CA1\u6709\u7B49\u5F85\u8282\u70B9\uFF0C\u5C31\u76F4\u63A5\u8FDB\u5165\u5360\u9501\u73AF\u8282\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">setExclusiveOwnerThread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">current </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getExclusiveOwnerThread</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> nextc </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> c </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> acquires</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">nextc </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Error</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Maximum lock count exceeded</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">setState</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">nextc</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u6240\u4EE5<code>hasQueuedPredecessors()</code>\u8FD9\u4E2A\u73AF\u8282\u5BB9\u4E0D\u5F97\u534A\u70B9\u95EA\u5931\uFF0C\u5426\u5219\u4F1A\u76F4\u63A5\u7834\u574F\u6389\u516C\u5E73\u6027\uFF0C\u5047\u5982\u73B0\u5728\u51FA\u73B0\u4E86\u8FD9\u6837\u7684\u60C5\u51B5\uFF1A</p><p>\u7EBF\u7A0B1\u5DF2\u7ECF\u6301\u6709\u9501\u4E86\uFF0C\u8FD9\u65F6\u7EBF\u7A0B2\u6765\u4E89\u62A2\u8FD9\u628A\u9501\uFF0C\u8D70\u5230<code>hasQueuedPredecessors()</code>\uFF0C\u5224\u65AD\u51FA\u4E3A <code>false</code>\uFF0C\u7EBF\u7A0B2\u7EE7\u7EED\u8FD0\u884C\uFF0C\u7136\u540E\u7EBF\u7A0B2\u80AF\u5B9A\u83B7\u53D6\u9501\u5931\u8D25\uFF08\u56E0\u4E3A\u9501\u8FD9\u65F6\u662F\u88AB\u7EBF\u7A0B1\u5360\u6709\u7684\uFF09\uFF0C\u56E0\u6B64\u5C31\u8FDB\u5165\u5230\u7B49\u5F85\u961F\u5217\u4E2D\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">enq</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(;;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> t </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> tail</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u7EBF\u7A0B2\u8FDB\u6765\u4E4B\u540E\uFF0C\u80AF\u5B9A\u662F\u8981\u5148\u8D70\u8FD9\u91CC\u7684\uFF0C\u56E0\u4E3Ahead\u548Ctail\u90FD\u662Fnull</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">compareAndSetHead</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Node</span><span style="color:#89DDFF;">()))</span></span>
<span class="line"><span style="color:#A6ACCD;">                tail </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> head</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8FD9\u91CC\u5C31\u5C06tail\u76F4\u63A5\u7B49\u4E8Ehead\u4E86\uFF0C\u6CE8\u610F\u8FD9\u91CC\u5B8C\u4E86\u4E4B\u540E\u8FD8\u6CA1\u5B8C\uFF0C\u8FD9\u91CC\u53EA\u662F\u521D\u59CB\u5316\u8FC7\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">prev </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> t</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">compareAndSetTail</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                t</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">next </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> t</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">addWaiter</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> mode</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> node </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Node</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> mode</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> pred </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> tail</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">pred </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u7531\u4E8E\u4E00\u5F00\u59CBhead\u548Ctail\u90FD\u662Fnull\uFF0C\u6240\u4EE5\u7EBF\u7A0B2\u76F4\u63A5\u5C31\u8FDBenq()\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">        node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">prev </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pred</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">compareAndSetTail</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">pred</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            pred</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">next </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">enq</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8BF7\u770B\u4E0A\u9762</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u800C\u78B0\u5DE7\u4E0D\u5DE7\uFF0C\u8FD9\u4E2A\u65F6\u5019\u7EBF\u7A0B3\u4E5F\u6765\u62A2\u9501\u4E86\uFF0C\u6309\u7167\u6B63\u5E38\u6D41\u7A0B\u8D70\u5230\u4E86<code>hasQueuedPredecessors()</code>\u65B9\u6CD5\uFF0C\u800C\u5728\u6B64\u65B9\u6CD5\u4E2D\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">hasQueuedPredecessors</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> t </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> tail</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// Read fields in reverse initialization order</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> h </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> head</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Node</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u8FD9\u91CC\u76F4\u63A5\u5224\u65ADh != t\uFF0C\u800C\u6B64\u65F6\u7EBF\u7A0B2\u624D\u521A\u521A\u6267\u884C\u5B8C tail = head\uFF0C\u6240\u4EE5\u76F4\u63A5\u5C31\u8FD4\u56DEfalse\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> h </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> t </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">s </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> h</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">next</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">thread </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u56E0\u6B64\uFF0C\u7EBF\u7A0B3\u8FD9\u65F6\u5C31\u7D27\u63A5\u7740\u51C6\u5907\u5F00\u59CBCAS\u64CD\u4F5C\u4E86\uFF0C\u53C8\u78B0\u5DE7\uFF0C\u8FD9\u65F6\u7EBF\u7A0B1\u91CA\u653E\u9501\u4E86\uFF0C\u73B0\u5728\u7684\u60C5\u51B5\u5C31\u662F\uFF0C\u7EBF\u7A0B3\u76F4\u63A5\u5F00\u59CBCAS\u5224\u65AD\uFF0C\u800C\u7EBF\u7A0B2\u8FD8\u5728\u63D2\u5165\u8282\u70B9\u72B6\u6001\uFF0C\u7ED3\u679C\u53EF\u60F3\u800C\u77E5\uFF0C\u5C45\u7136\u662F\u7EBF\u7A0B3\u5148\u62FF\u5230\u4E86\u9501\uFF0C\u8FD9\u663E\u7136\u662F\u8FDD\u80CC\u4E86\u516C\u5E73\u9501\u7684\u516C\u5E73\u673A\u5236\u3002\u4E00\u5F20\u56FE\u5C31\u662F\uFF1A</p><p><img src="`+T+`" alt="image-20220306155509195"></p><p>\u56E0\u6B64\u516C\u4E0D\u516C\u5E73\u5168\u770B<code>hasQueuedPredecessors()</code>\uFF0C\u800C\u6B64\u65B9\u6CD5\u53EA\u6709\u5728\u7B49\u5F85\u961F\u5217\u4E2D\u5B58\u5728\u8282\u70B9\u65F6\u624D\u80FD\u4FDD\u8BC1\u4E0D\u4F1A\u51FA\u73B0\u95EE\u9898\u3002\u6240\u4EE5\u516C\u5E73\u9501\uFF0C\u53EA\u6709\u5728\u7B49\u5F85\u961F\u5217\u5B58\u5728\u8282\u70B9\u65F6\uFF0C\u624D\u662F\u771F\u6B63\u516C\u5E73\u7684\u3002</p><h4 id="\u7EBF\u7A0B\u6C60" tabindex="-1">\u7EBF\u7A0B\u6C60 <a class="header-anchor" href="#\u7EBF\u7A0B\u6C60" aria-hidden="true">#</a></h4><blockquote><p>\u5C06\u5DF2\u521B\u5EFA\u7684\u7EBF\u7A0B\u590D\u7528\uFF0C\u5229\u7528\u6C60\u5316\u6280\u672F\uFF0C\u5C31\u50CF\u6570\u636E\u5E93\u8FDE\u63A5\u6C60\u4E00\u6837\uFF0C\u6211\u4EEC\u4E5F\u53EF\u4EE5\u521B\u5EFA\u5F88\u591A\u4E2A\u7EBF\u7A0B\uFF0C\u7136\u540E\u53CD\u590D\u5730\u4F7F\u7528\u8FD9\u4E9B\u7EBF\u7A0B\uFF0C\u800C\u4E0D\u5BF9\u5B83\u4EEC\u8FDB\u884C\u9500\u6BC1\u3002</p></blockquote><h5 id="\u6784\u9020\u65B9\u6CD5" tabindex="-1">\u6784\u9020\u65B9\u6CD5 <a class="header-anchor" href="#\u6784\u9020\u65B9\u6CD5" aria-hidden="true">#</a></h5><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ThreadPoolExecutor</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> corePoolSize</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                          </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> maximumPoolSize</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                          </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> keepAliveTime</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                          </span><span style="color:#C792EA;">TimeUnit</span><span style="color:#A6ACCD;"> unit</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                          </span><span style="color:#C792EA;">BlockingQueue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Runnable</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> workQueue</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                          </span><span style="color:#C792EA;">ThreadFactory</span><span style="color:#A6ACCD;"> threadFactory</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                          </span><span style="color:#C792EA;">RejectedExecutionHandler</span><span style="color:#A6ACCD;"> handler</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">corePoolSize </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span></span>
<span class="line"><span style="color:#A6ACCD;">        maximumPoolSize </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span></span>
<span class="line"><span style="color:#A6ACCD;">        maximumPoolSize </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> corePoolSize </span><span style="color:#89DDFF;">||</span></span>
<span class="line"><span style="color:#A6ACCD;">        keepAliveTime </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IllegalArgumentException</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">workQueue </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> threadFactory </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> handler </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">NullPointerException</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">acc </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getSecurityManager</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">            AccessController</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getContext</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">corePoolSize </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> corePoolSize</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">maximumPoolSize </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> maximumPoolSize</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">workQueue </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> workQueue</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">keepAliveTime </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> unit</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toNanos</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">keepAliveTime</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">threadFactory </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> threadFactory</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">handler </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> handler</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u53C2\u6570\u8BB2\u89E3\uFF1A</p><ul><li>corePoolSize\uFF1A<strong>\u6838\u5FC3\u7EBF\u7A0B\u6C60\u5927\u5C0F</strong>\uFF0C\u6211\u4EEC\u6BCF\u5411\u7EBF\u7A0B\u6C60\u63D0\u4EA4\u4E00\u4E2A\u591A\u7EBF\u7A0B\u4EFB\u52A1\u65F6\uFF0C\u90FD\u4F1A\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684<code>\u6838\u5FC3\u7EBF\u7A0B</code>\uFF0C\u65E0\u8BBA\u662F\u5426\u5B58\u5728\u5176\u4ED6\u7A7A\u95F2\u7EBF\u7A0B\uFF0C\u76F4\u5230\u5230\u8FBE\u6838\u5FC3\u7EBF\u7A0B\u6C60\u5927\u5C0F\u4E3A\u6B62\uFF0C\u4E4B\u540E\u4F1A\u5C1D\u8BD5\u590D\u7528\u7EBF\u7A0B\u8D44\u6E90\u3002\u5F53\u7136\u4E5F\u53EF\u4EE5\u5728\u4E00\u5F00\u59CB\u5C31\u5168\u90E8\u521D\u59CB\u5316\u597D\uFF0C\u8C03\u7528<code> prestartAllCoreThreads()</code>\u5373\u53EF\u3002</li><li>maximumPoolSize\uFF1A<strong>\u6700\u5927\u7EBF\u7A0B\u6C60\u5927\u5C0F</strong>\uFF0C\u5F53\u76EE\u524D\u7EBF\u7A0B\u6C60\u4E2D\u6240\u6709\u7684\u7EBF\u7A0B\u90FD\u5904\u4E8E\u8FD0\u884C\u72B6\u6001\uFF0C\u5E76\u4E14\u8FD9\u65F6\u6765\u4E86\u65B0\u7684\u591A\u7EBF\u7A0B\u4EFB\u52A1\uFF0C\u5982\u679C\u5F53\u524D\u7EBF\u7A0B\u6C60\u4E2D\u7EBF\u7A0B\u6570\u91CF\u5C0F\u4E8E\u6700\u5927\u7EBF\u7A0B\u6C60\u5927\u5C0F\uFF0C\u90A3\u4E48\u4F1A\u7EE7\u7EED\u521B\u5EFA\u65B0\u7684<code>\u975E\u6838\u5FC3\u7EBF\u7A0B</code>\u8FD0\u884C\uFF0C\u76F4\u5230\u6700\u5927\u5927\u5C0F\u3002</li><li>keepAliveTime\uFF1A<strong>\u7EBF\u7A0B\u6700\u5927\u7A7A\u95F2\u65F6\u95F4</strong>\uFF0C\u5F53\u4E00\u4E2A<code>\u975E\u6838\u5FC3\u7EBF\u7A0B</code>\u7A7A\u95F2\u8D85\u8FC7\u4E00\u5B9A\u65F6\u95F4\uFF0C\u4F1A\u81EA\u52A8\u9500\u6BC1\u3002</li><li>unit\uFF1A<strong>\u7EBF\u7A0B\u6700\u5927\u7A7A\u95F2\u65F6\u95F4\u7684\u65F6\u95F4\u5355\u4F4D</strong></li><li>workQueue\uFF1A<strong>\u7EBF\u7A0B\u7B49\u5F85\u961F\u5217</strong>\uFF0C\u5F53\u7EBF\u7A0B\u6C60\u4E2D\u786E\u5B9E\u65E0\u6CD5\u5206\u914D\u7EBF\u7A0B\u6267\u884C\u4EFB\u52A1\u7684\u65F6\u5019\uFF0C\u5C31\u4F1A\u5C06\u4EFB\u52A1\u6682\u65F6\u5B58\u5230\u7B49\u5F85\u961F\u5217\u4E2D\uFF0C\u76F4\u5230\u6709\u7EBF\u7A0B\u8D44\u6E90\u53EF\u7528\u4E3A\u6B62\uFF0C\u8FD9\u91CC\u53EF\u4EE5\u4F7F\u7528\u6211\u4EEC\u4E0A\u4E00\u7AE0\u5B66\u5230\u7684\u963B\u585E\u961F\u5217\u3002</li><li>threadFactory\uFF1A<strong>\u7EBF\u7A0B\u521B\u5EFA\u5DE5\u5382</strong>\uFF0C\u6211\u4EEC\u53EF\u4EE5\u5E72\u6D89\u7EBF\u7A0B\u6C60\u4E2D\u7EBF\u7A0B\u7684\u521B\u5EFA\u8FC7\u7A0B\uFF0C\u8FDB\u884C\u81EA\u5B9A\u4E49\u3002</li><li>handler\uFF1A<strong>\u62D2\u7EDD\u7B56\u7565</strong>\uFF0C\u5F53\u7B49\u5F85\u961F\u5217\u548C\u7EBF\u7A0B\u6C60\u90FD\u6CA1\u6709\u7A7A\u95F4\u4E86\uFF0C\u771F\u7684\u4E0D\u80FD\u518D\u6765\u65B0\u7684\u4EFB\u52A1\u65F6\uFF0C\u6765\u4E86\u4E2A\u65B0\u7684\u591A\u7EBF\u7A0B\u4EFB\u52A1\uFF0C\u90A3\u4E48\u53EA\u80FD\u62D2\u7EDD\u4E86\uFF0C\u8FD9\u65F6\u5C31\u4F1A\u6839\u636E\u5F53\u524D\u8BBE\u5B9A\u7684\u62D2\u7EDD\u7B56\u7565\u8FDB\u884C\u5904\u7406\u3002</li></ul><p>\u6700\u4E3A\u91CD\u8981\u7684\u5C31\u662F\u7EBF\u7A0B\u6C60\u5927\u5C0F\u7684\u9650\u5B9A\u4E86\uFF0C\u8FD9\u4E2A\u4E5F\u662F\u5F88\u6709\u5B66\u95EE\u7684\uFF0C\u5408\u7406\u5730\u5206\u914D\u5927\u5C0F\u4F1A\u4F7F\u5F97\u7EBF\u7A0B\u6C60\u7684\u6267\u884C\u6548\u7387\u4E8B\u534A\u529F\u500D\uFF1A</p><ul><li>\u9996\u5148\u6211\u4EEC\u53EF\u4EE5\u5206\u6790\u4E00\u4E0B\uFF0C\u7EBF\u7A0B\u6C60\u6267\u884C\u4EFB\u52A1\u7684\u7279\u6027\uFF0C\u662FCPU \u5BC6\u96C6\u578B\u8FD8\u662F IO \u5BC6\u96C6\u578B <ul><li>**CPU\u5BC6\u96C6\u578B\uFF1A**\u4E3B\u8981\u662F\u6267\u884C\u8BA1\u7B97\u4EFB\u52A1\uFF0C\u54CD\u5E94\u65F6\u95F4\u5F88\u5FEB\uFF0CCPU\u4E00\u76F4\u5728\u8FD0\u884C\uFF0C\u8FD9\u79CD\u4EFB\u52A1CPU\u7684\u5229\u7528\u7387\u5F88\u9AD8\uFF0C\u90A3\u4E48\u7EBF\u7A0B\u6570\u5E94\u8BE5\u662F\u6839\u636E CPU \u6838\u5FC3\u6570\u6765\u51B3\u5B9A\uFF0CCPU \u6838\u5FC3\u6570 = \u6700\u5927\u540C\u65F6\u6267\u884C\u7EBF\u7A0B\u6570\uFF0C\u4EE5 i5-9400F \u5904\u7406\u5668\u4E3A\u4F8B\uFF0CCPU \u6838\u5FC3\u6570\u4E3A 6\uFF0C\u90A3\u4E48\u6700\u591A\u5C31\u80FD\u540C\u65F6\u6267\u884C 6 \u4E2A\u7EBF\u7A0B\u3002</li><li>**IO\u5BC6\u96C6\u578B\uFF1A**\u4E3B\u8981\u662F\u8FDB\u884C IO \u64CD\u4F5C\uFF0C\u56E0\u4E3A\u6267\u884C IO \u64CD\u4F5C\u7684\u65F6\u95F4\u6BD4\u8F83\u8F83\u957F\uFF0C\u6BD4\u5982\u4ECE\u786C\u76D8\u8BFB\u53D6\u6570\u636E\u4E4B\u7C7B\u7684\uFF0CCPU\u5C31\u5F97\u7B49\u7740IO\u64CD\u4F5C\uFF0C\u5F88\u5BB9\u6613\u51FA\u73B0\u7A7A\u95F2\u72B6\u6001\uFF0C\u5BFC\u81F4 CPU \u7684\u5229\u7528\u7387\u4E0D\u9AD8\uFF0C\u8FD9\u79CD\u60C5\u51B5\u4E0B\u53EF\u4EE5\u9002\u5F53\u589E\u52A0\u7EBF\u7A0B\u6C60\u7684\u5927\u5C0F\uFF0C\u8BA9\u66F4\u591A\u7684\u7EBF\u7A0B\u53EF\u4EE5\u4E00\u8D77\u8FDB\u884CIO\u64CD\u4F5C\uFF0C\u4E00\u822C\u53EF\u4EE5\u914D\u7F6E\u4E3ACPU\u6838\u5FC3\u6570\u76842\u500D\u3002</li></ul></li></ul><p>\u624B\u52A8\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684\u7EBF\u7A0B\u6C60\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ThreadPoolExecutor</span><span style="color:#A6ACCD;"> executor </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ThreadPoolExecutor</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//2\u4E2A\u6838\u5FC3\u7EBF\u7A0B\uFF0C\u6700\u5927\u7EBF\u7A0B\u6570\u4E3A4\u4E2A</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">        </span><span style="color:#676E95;">//\u6700\u5927\u7A7A\u95F2\u65F6\u95F4\u4E3A3\u79D2\u949F</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ArrayBlockingQueue</span><span style="color:#89DDFF;">&lt;&gt;(</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">));</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">//\u8FD9\u91CC\u4F7F\u7528\u5BB9\u91CF\u4E3A2\u7684ArrayBlockingQueue\u961F\u5217</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">6</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5F00\u59CB6\u4E2A\u4EFB\u52A1</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> finalI </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">execute</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getName</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> \u5F00\u59CB\u6267\u884C\uFF01\uFF08</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> finalI</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getName</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> \u5DF2\u7ED3\u675F\uFF01\uFF08</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">finalI</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">printStackTrace</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u770B\u770B\u5F53\u524D\u7EBF\u7A0B\u6C60\u4E2D\u7684\u7EBF\u7A0B\u6570\u91CF</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u7EBF\u7A0B\u6C60\u4E2D\u7EBF\u7A0B\u6570\u91CF\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getPoolSize</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">//\u7B49\u5230\u8D85\u8FC7\u7A7A\u95F2\u65F6\u95F4</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u7EBF\u7A0B\u6C60\u4E2D\u7EBF\u7A0B\u6570\u91CF\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getPoolSize</span><span style="color:#89DDFF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">shutdownNow</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u4F7F\u7528\u5B8C\u7EBF\u7A0B\u6C60\u8BB0\u5F97\u5173\u95ED\uFF0C\u4E0D\u7136\u7A0B\u5E8F\u4E0D\u4F1A\u7ED3\u675F\uFF0C\u5B83\u4F1A\u53D6\u6D88\u6240\u6709\u7B49\u5F85\u4E2D\u7684\u4EFB\u52A1\u4EE5\u53CA\u8BD5\u56FE\u4E2D\u65AD\u6B63\u5728\u6267\u884C\u7684\u4EFB\u52A1\uFF0C\u5173\u95ED\u540E\uFF0C\u65E0\u6CD5\u518D\u63D0\u4EA4\u4EFB\u52A1\uFF0C\u4E00\u5F8B\u62D2\u7EDD</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//executor.shutdown();     \u540C\u6837\u53EF\u4EE5\u5173\u95ED\uFF0C\u4F46\u662F\u4F1A\u6267\u884C\u5B8C\u7B49\u5F85\u961F\u5217\u4E2D\u7684\u4EFB\u52A1\u518D\u5173\u95ED</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u521B\u5EFA\u4E86\u4E00\u4E2A\u6838\u5FC3\u5BB9\u91CF\u4E3A2\uFF0C\u6700\u5927\u5BB9\u91CF\u4E3A4\uFF0C\u7B49\u5F85\u961F\u5217\u957F\u5EA6\u4E3A2\uFF0C\u7A7A\u95F2\u65F6\u95F4\u4E3A3\u79D2\u7684\u7EBF\u7A0B\u6C60\uFF0C\u73B0\u5728\u6211\u4EEC\u5411\u5176\u4E2D\u6267\u884C6\u4E2A\u4EFB\u52A1\uFF0C\u6BCF\u4E2A\u4EFB\u52A1\u90FD\u4F1A\u8FDB\u884C1\u79D2\u949F\u4F11\u7720\uFF0C\u90A3\u4E48\u5F53\u7EBF\u7A0B\u6C60\u4E2D4\u4E2A\u7EBF\u7A0B\u90FD\u88AB\u5360\u7528\u65F6\uFF0C\u8FD8\u6709\u4E24\u4E2A\u7EBF\u7A0B\u5C31\u53EA\u80FD\u8FDB\u5165\u5230\u7B49\u5F85\u961F\u5217\u4E2D\u4E86\uFF0C\u5F53\u7EBF\u7A0B\u6C60\u4E2D4\u4E2A\u7EBF\u7A0B\u5B8C\u6210\u540E\uFF0C\u7B49\u5F85\u961F\u5217\u4E2D\u7684\u4E24\u4E2A\u4EFB\u52A1\u624D\u80FD\u5F00\u59CB\u6267\u884C\u3002\u5E76\u4E14\u5728\u7B49\u5F855\u79D2\u540E\uFF0C\u8D85\u8FC7\u4E86\u7EBF\u7A0B\u6C60\u7684\u6700\u5927\u7A7A\u95F2\u65F6\u95F4\uFF0C<code>\u975E\u6838\u5FC3\u7EBF\u7A0B</code>\u88AB\u56DE\u6536\u4E86\uFF0C\u6240\u4EE5\u7EBF\u7A0B\u6C60\u4E2D\u53EA\u67092\u4E2A\u7EBF\u7A0B\u5B58\u5728\u3002</p><p><strong>\u5F53\u7B49\u5F85\u961F\u5217\u8D85\u8FC7\u5BB9\u91CF\uFF0C\u6267\u884C\u62D2\u7EDD\u4EFB\u52A1\uFF0C\u62D2\u7EDD\u7684\u64CD\u4F5C\u4F1A\u6839\u636E\u62D2\u7EDD\u7B56\u7565\u51B3\u5B9A</strong></p><p>\u7EBF\u7A0B\u6C60\u7684\u62D2\u7EDD\u7B56\u7565\uFF1A</p><ul><li>AbortPolicy(\u9ED8\u8BA4)\uFF1A\u50CF\u4E0A\u9762\u4E00\u6837\uFF0C\u76F4\u63A5\u629B\u5F02\u5E38\u3002</li><li>CallerRunsPolicy\uFF1A\u76F4\u63A5\u8BA9\u63D0\u4EA4\u4EFB\u52A1\u7684\u7EBF\u7A0B\u8FD0\u884C\u8FD9\u4E2A\u4EFB\u52A1\uFF0C\u6BD4\u5982\u5728\u4E3B\u7EBF\u7A0B\u5411\u7EBF\u7A0B\u6C60\u63D0\u4EA4\u4E86\u4EFB\u52A1\uFF0C\u90A3\u4E48\u5C31\u76F4\u63A5\u7531\u4E3B\u7EBF\u7A0B\u6267\u884C\u3002</li><li>DiscardOldestPolicy\uFF1A\u4E22\u5F03\u961F\u5217\u4E2D\u6700\u8FD1\u7684\u4E00\u4E2A\u4EFB\u52A1\uFF0C\u66FF\u6362\u4E3A\u5F53\u524D\u4EFB\u52A1\u3002</li><li>DiscardPolicy\uFF1A\u4EC0\u4E48\u4E5F\u4E0D\u7528\u505A\u3002</li></ul><p><code>DiscardOldestPolicy</code></p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">DiscardOldestPolicy</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">implements</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RejectedExecutionHandler</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">DiscardOldestPolicy</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">rejectedExecution</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">r</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ThreadPoolExecutor</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isShutdown</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u4F1A\u5148\u6267\u884C\u4E00\u6B21\u51FA\u961F\u64CD\u4F5C</span></span>
<span class="line"><span style="color:#A6ACCD;">            e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getQueue</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">poll</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u8FD9\u91CC\u4F1A\u518D\u6B21\u8C03\u7528execute\u65B9\u6CD5</span></span>
<span class="line"><span style="color:#A6ACCD;">            e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">execute</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">r</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u9664\u4E86\u4F7F\u7528\u5B98\u65B9\u63D0\u4F9B\u76844\u79CD\u7B56\u7565\u4E4B\u5916\uFF0C\u6211\u4EEC\u8FD8\u53EF\u4EE5\u4F7F\u7528\u81EA\u5B9A\u4E49\u7684\u7B56\u7565\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ThreadPoolExecutor</span><span style="color:#A6ACCD;"> executor </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ThreadPoolExecutor</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">SynchronousQueue</span><span style="color:#89DDFF;">&lt;&gt;(),</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">r</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> executor1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6BD4\u5982\u8FD9\u91CC\u6211\u4EEC\u4E5F\u6765\u5B9E\u73B0\u4E00\u4E2A\u5C31\u5728\u5F53\u524D\u7EBF\u7A0B\u6267\u884C\u7684\u7B56\u7565</span></span>
<span class="line"><span style="color:#A6ACCD;">                        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u54CE\u5440\uFF0C\u7EBF\u7A0B\u6C60\u548C\u7B49\u5F85\u961F\u5217\u90FD\u6EE1\u4E86\uFF0C\u4F60\u81EA\u5DF1\u8017\u5B50\u5C3E\u6C41\u5427</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                        r</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u76F4\u63A5\u8FD0\u884C</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"></span></code></pre></div><p><code>ThreadFactory</code></p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ThreadPoolExecutor</span><span style="color:#A6ACCD;"> executor </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ThreadPoolExecutor</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">SynchronousQueue</span><span style="color:#89DDFF;">&lt;&gt;(),</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ThreadFactory</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> counter </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#89DDFF;">                        </span><span style="color:#676E95;">// \u4F20\u5165\u7684Runnable\u5BF9\u8C61\u5C31\u662F\u6211\u4EEC\u63D0\u4EA4\u7684\u4EFB\u52A1</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Thread</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">newThread</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">r</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">r</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u6211\u7684\u81EA\u5B9A\u4E49\u7EBF\u7A0B-</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">counter</span><span style="color:#89DDFF;">++);</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">execute</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getName</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> \u5F00\u59CB\u6267\u884C\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="executors\u5DE5\u5177\u7C7B" tabindex="-1"><code>Executors</code>\u5DE5\u5177\u7C7B <a class="header-anchor" href="#executors\u5DE5\u5177\u7C7B" aria-hidden="true">#</a></h5><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ExecutorService</span><span style="color:#A6ACCD;"> executor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Executors</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newFixedThreadPool</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u76F4\u63A5\u521B\u5EFA\u4E00\u4E2A\u56FA\u5B9A\u5BB9\u91CF\u7684\u7EBF\u7A0B\u6C60</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5185\u90E8\u5B9E\u73B0\u4E3A\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ExecutorService</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">newFixedThreadPool</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> nThreads</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ThreadPoolExecutor</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">nThreads</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> nThreads</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                                  </span><span style="color:#F78C6C;">0L</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">MILLISECONDS</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                                  </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">LinkedBlockingQueue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Runnable</span><span style="color:#89DDFF;">&gt;());</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u8FD9\u91CC\u76F4\u63A5\u5C06\u6700\u5927\u7EBF\u7A0B\u548C\u6838\u5FC3\u7EBF\u7A0B\u6570\u91CF\u8BBE\u5B9A\u4E3A\u4E00\u6837\u7684\uFF0C\u5E76\u4E14\u7B49\u5F85\u65F6\u95F4\u4E3A0\uFF0C\u56E0\u4E3A\u538B\u6839\u4E0D\u9700\u8981\uFF0C\u5E76\u4E14\u91C7\u7528\u7684\u662F\u4E00\u4E2A\u65E0\u754C\u7684LinkedBlockingQueue\u4F5C\u4E3A\u7B49\u5F85\u961F\u5217\u3002</p><p>\u4F7F\u7528newSingleThreadExecutor\u6765\u521B\u5EFA\u53EA\u6709\u4E00\u4E2A\u7EBF\u7A0B\u7684\u7EBF\u7A0B\u6C60\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ExecutorService</span><span style="color:#A6ACCD;"> executor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Executors</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newSingleThreadExecutor</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//\u521B\u5EFA\u4E00\u4E2A\u53EA\u6709\u4E00\u4E2A\u7EBF\u7A0B\u7684\u7EBF\u7A0B\u6C60</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u539F\u7406\u5982\u4E0B\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ExecutorService</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">newSingleThreadExecutor</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">FinalizableDelegatedExecutorService</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ThreadPoolExecutor</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                                </span><span style="color:#F78C6C;">0L</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">MILLISECONDS</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                                </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">LinkedBlockingQueue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Runnable</span><span style="color:#89DDFF;">&gt;()));</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u53EF\u4EE5\u770B\u5230\u8FD9\u91CC\u5E76\u4E0D\u662F\u76F4\u63A5\u521B\u5EFA\u7684\u4E00\u4E2AThreadPoolExecutor\u5BF9\u8C61\uFF0C\u800C\u662F\u5957\u4E86\u4E00\u5C42FinalizableDelegatedExecutorService\uFF0C\u90A3\u4E48\u8FD9\u4E2A\u53C8\u662F\u4EC0\u4E48\u4E1C\u897F\u5462\uFF1F</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FinalizableDelegatedExecutorService</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">DelegatedExecutorService</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">FinalizableDelegatedExecutorService</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">ExecutorService</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">executor</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        super</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">executor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">finalize</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5728GC\u65F6\uFF0C\u4F1A\u6267\u884Cfinalize\u65B9\u6CD5\uFF0C\u6B64\u65B9\u6CD5\u4E2D\u4F1A\u5173\u95ED\u6389\u7EBF\u7A0B\u6C60\uFF0C\u91CA\u653E\u8D44\u6E90</span></span>
<span class="line"><span style="color:#A6ACCD;">        super</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">shutdown</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">DelegatedExecutorService</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">AbstractExecutorService</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ExecutorService</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u88AB\u59D4\u6D3E\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">DelegatedExecutorService</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">ExecutorService</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">executor</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> e </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5B9E\u9645\u4E0A\u6240\u4EE5\u7684\u64CD\u4F5C\u90FD\u662F\u8BA9\u59D4\u6D3E\u5BF9\u8C61\u6267\u884C\u7684\uFF0C\u6709\u70B9\u50CF\u4EE3\u7406</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">execute</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">command</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">execute</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">command</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">shutdown</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">shutdown</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Runnable</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">shutdownNow</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">shutdownNow</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u6240\u4EE5\uFF0C\u4E0B\u9762\u4E24\u79CD\u5199\u6CD5\u7684\u533A\u522B\u5728\u4E8E\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ExecutorService</span><span style="color:#A6ACCD;"> executor1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Executors</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newSingleThreadExecutor</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ExecutorService</span><span style="color:#A6ACCD;"> executor2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Executors</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newFixedThreadPool</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u524D\u8005\u5B9E\u9645\u4E0A\u662F\u88AB\u4EE3\u7406\u4E86\uFF0C\u6211\u4EEC\u6CA1\u529E\u6CD5\u76F4\u63A5\u4FEE\u6539\u524D\u8005\u7684\u76F8\u5173\u5C5E\u6027\uFF0C\u663E\u7136\u4F7F\u7528\u524D\u8005\u521B\u5EFA\u53EA\u6709\u4E00\u4E2A\u7EBF\u7A0B\u7684\u7EBF\u7A0B\u6C60\u66F4\u52A0\u4E13\u4E1A\u548C\u5B89\u5168\uFF08\u53EF\u4EE5\u9632\u6B62\u5C5E\u6027\u88AB\u4FEE\u6539\uFF09\u4E00\u4E9B\u3002</p><p>\u6700\u540E\u6211\u4EEC\u6765\u770B<code>newCachedThreadPool</code>\u65B9\u6CD5\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ExecutorService</span><span style="color:#A6ACCD;"> executor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Executors</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newCachedThreadPool</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//\u5B83\u662F\u4E00\u4E2A\u4F1A\u6839\u636E\u9700\u8981\u65E0\u9650\u5236\u521B\u5EFA\u65B0\u7EBF\u7A0B\u7684\u7EBF\u7A0B\u6C60</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u6211\u4EEC\u6765\u770B\u770B\u5B83\u7684\u5B9E\u73B0\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ExecutorService</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">newCachedThreadPool</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ThreadPoolExecutor</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Integer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">MAX_VALUE</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                                  </span><span style="color:#F78C6C;">60L</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                                  </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">SynchronousQueue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Runnable</span><span style="color:#89DDFF;">&gt;());</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u6838\u5FC3\u7EBF\u7A0B\u6570\u4E3A0\uFF0C\u90A3\u4E48\u4E5F\u5C31\u662F\u8BF4\u6240\u6709\u7684\u7EBF\u7A0B\u90FD\u662F<code>\u975E\u6838\u5FC3\u7EBF\u7A0B</code>\uFF0C\u4E5F\u5C31\u662F\u8BF4\u7EBF\u7A0B\u7A7A\u95F2\u65F6\u95F4\u8D85\u8FC71\u79D2\u949F\uFF0C\u4E00\u5F8B\u9500\u6BC1\u3002\u4F46\u662F\u5B83\u7684\u6700\u5927\u5BB9\u91CF\u662F<code>Integer.MAX_VALUE</code>\uFF0C\u4E5F\u5C31\u662F\u8BF4\uFF0C\u5B83\u53EF\u4EE5\u65E0\u9650\u5236\u5730\u589E\u957F\u4E0B\u53BB\uFF0C\u6240\u4EE5\u8FD9\u73A9\u610F\u4E00\u5B9A\u8981\u614E\u7528\u3002</p><h5 id="\u6267\u884C\u5E26\u8FD4\u56DE\u503C\u7684\u4EFB\u52A1" tabindex="-1">\u6267\u884C\u5E26\u8FD4\u56DE\u503C\u7684\u4EFB\u52A1 <a class="header-anchor" href="#\u6267\u884C\u5E26\u8FD4\u56DE\u503C\u7684\u4EFB\u52A1" aria-hidden="true">#</a></h5><p><strong>\u53EF\u4EE5\u4F7F\u7528Future</strong>\uFF0C\u5B83\u53EF\u4EE5\u8FD4\u56DE\u4EFB\u52A1\u7684\u8BA1\u7B97\u7ED3\u679C\uFF0C\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7\u5B83\u6765\u83B7\u53D6\u4EFB\u52A1\u7684\u7ED3\u679C\u4EE5\u53CA\u4EFB\u52A1\u5F53\u524D\u662F\u5426\u5B8C\u6210\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> ExecutionException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ExecutorService</span><span style="color:#A6ACCD;"> executor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Executors</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newSingleThreadExecutor</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u76F4\u63A5\u7528Executors\u521B\u5EFA\uFF0C\u65B9\u4FBF\u5C31\u5B8C\u4E8B\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Future</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> future </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">submit</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u6211\u662F\u5B57\u7B26\u4E32!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">//\u4F7F\u7528submit\u63D0\u4EA4\u4EFB\u52A1\uFF0C\u4F1A\u8FD4\u56DE\u4E00\u4E2AFuture\u5BF9\u8C61\uFF0C\u6CE8\u610F\u63D0\u4EA4\u7684\u5BF9\u8C61\u53EF\u4EE5\u662FRunable\u4E5F\u53EF\u4EE5\u662FCallable\uFF0C\u8FD9\u91CC\u4F7F\u7528\u7684\u662FCallable\u80FD\u591F\u81EA\u5B9A\u4E49\u8FD4\u56DE\u503C</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">future</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">());</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5982\u679C\u4EFB\u52A1\u672A\u5B8C\u6210\uFF0Cget\u4F1A\u88AB\u963B\u585E\uFF0C\u4EFB\u52A1\u5B8C\u6210\u8FD4\u56DECallable\u6267\u884C\u7ED3\u679C\u8FD4\u56DE\u503C</span></span>
<span class="line"><span style="color:#A6ACCD;">    executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">shutdown</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">//\u7ED3\u679C\u4E5F\u53EF\u4EE5\u4E00\u5F00\u59CB\u5C31\u5B9A\u4E49\u597D\uFF0C\u7136\u540E\u7B49\u5F85Runnable\u6267\u884C\u5B8C\u4E4B\u540E\u518D\u8FD4\u56DE\uFF1A</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> ExecutionException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ExecutorService</span><span style="color:#A6ACCD;"> executor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Executors</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newSingleThreadExecutor</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Future</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> future </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">submit</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">printStackTrace</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u6211\u662F\u5B57\u7B26\u4E32\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">future</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">shutdown</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">//\u901A\u8FC7Future\u5BF9\u8C61\u83B7\u53D6\u5F53\u524D\u4EFB\u52A1\u7684\u4E00\u4E9B\u72B6\u6001\uFF1A</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws ExecutionException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ExecutorService</span><span style="color:#A6ACCD;"> executor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Executors</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newSingleThreadExecutor</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Future</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> future </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">submit</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u90FD\u770B\u5230\u8FD9\u91CC\u4E86\uFF0C\u4E0D\u8D4FUP\u4E3B\u4E00\u4E2A\u4E00\u952E\u4E09\u8FDE\u5417\uFF1F</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">future</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u4EFB\u52A1\u662F\u5426\u6267\u884C\u5B8C\u6210\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">future</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isDone</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u4EFB\u52A1\u662F\u5426\u88AB\u53D6\u6D88\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">future</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isCancelled</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">shutdown</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">//\u5728\u4EFB\u52A1\u6267\u884C\u9014\u4E2D\u53D6\u6D88\u4EFB\u52A1\uFF1A</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws ExecutionException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ExecutorService</span><span style="color:#A6ACCD;"> executor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Executors</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newSingleThreadExecutor</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Future</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> future </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">submit</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u8FD9\u6B21\u4E00\u5B9A\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">future</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">cancel</span><span style="color:#89DDFF;">(true));</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">future</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isCancelled</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">shutdown</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><strong>\u901A\u8FC7\u4F20\u5165FutureTask\u5BF9\u8C61</strong>\u7684\u65B9\u5F0F\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws ExecutionException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ExecutorService</span><span style="color:#A6ACCD;"> service </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Executors</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newSingleThreadExecutor</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">FutureTask</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> task </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">FutureTask</span><span style="color:#89DDFF;">&lt;&gt;(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u6211\u662F\u5B57\u7B26\u4E32\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    service</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">submit</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">task</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">task</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">shutdown</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="\u6267\u884C\u5B9A\u65F6\u4EFB\u52A1" tabindex="-1">\u6267\u884C\u5B9A\u65F6\u4EFB\u52A1 <a class="header-anchor" href="#\u6267\u884C\u5B9A\u65F6\u4EFB\u52A1" aria-hidden="true">#</a></h5><blockquote><p>JDK5\u4E4B\u540E\uFF0C\u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528ScheduledThreadPoolExecutor\u6765\u63D0\u4EA4\u5B9A\u65F6\u4EFB\u52A1\uFF0C\u5B83\u7EE7\u627F\u81EAThreadPoolExecutor\uFF0C\u5E76\u4E14\u6240\u6709\u7684\u6784\u9020\u65B9\u6CD5\u90FD\u5FC5\u987B\u8981\u6C42\u6700\u5927\u7EBF\u7A0B\u6C60\u5BB9\u91CF\u4E3AInteger.MAX_VALUE\uFF0C\u5E76\u4E14\u90FD\u662F\u91C7\u7528\u7684DelayedWorkQueue\u4F5C\u4E3A\u7B49\u5F85\u961F\u5217\u3002</p></blockquote><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ScheduledThreadPoolExecutor</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> corePoolSize</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    super</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">corePoolSize</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Integer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">MAX_VALUE</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> NANOSECONDS</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">DelayedWorkQueue</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ScheduledThreadPoolExecutor</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> corePoolSize</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                                   </span><span style="color:#C792EA;">ThreadFactory</span><span style="color:#A6ACCD;"> threadFactory</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    super</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">corePoolSize</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Integer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">MAX_VALUE</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> NANOSECONDS</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">DelayedWorkQueue</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> threadFactory</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ScheduledThreadPoolExecutor</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> corePoolSize</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                                   </span><span style="color:#C792EA;">RejectedExecutionHandler</span><span style="color:#A6ACCD;"> handler</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    super</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">corePoolSize</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Integer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">MAX_VALUE</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> NANOSECONDS</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">DelayedWorkQueue</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> handler</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ScheduledThreadPoolExecutor</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> corePoolSize</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                                   </span><span style="color:#C792EA;">ThreadFactory</span><span style="color:#A6ACCD;"> threadFactory</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                                   </span><span style="color:#C792EA;">RejectedExecutionHandler</span><span style="color:#A6ACCD;"> handler</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    super</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">corePoolSize</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Integer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">MAX_VALUE</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> NANOSECONDS</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">DelayedWorkQueue</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> threadFactory</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> handler</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u6D4B\u8BD5\u4E00\u4E0B\u5B83\u7684\u65B9\u6CD5\uFF0C\u8FD9\u4E2A\u65B9\u6CD5\u53EF\u4EE5\u63D0\u4EA4\u4E00\u4E2A\u5EF6\u65F6\u4EFB\u52A1\uFF0C\u53EA\u6709\u5230\u8FBE\u6307\u5B9A\u65F6\u95F4\u4E4B\u540E\u624D\u4F1A\u5F00\u59CB\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws ExecutionException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u76F4\u63A5\u8BBE\u5B9A\u6838\u5FC3\u7EBF\u7A0B\u6570\u4E3A1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ScheduledThreadPoolExecutor</span><span style="color:#A6ACCD;"> executor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ScheduledThreadPoolExecutor</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//\u8FD9\u91CC\u6211\u4EEC\u8BA1\u5212\u57283\u79D2\u540E\u6267\u884C</span></span>
<span class="line"><span style="color:#A6ACCD;">    executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">schedule</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">HelloWorld!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">shutdown</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u6211\u4EEC\u4E5F\u53EF\u4EE5\u50CF\u4E4B\u524D\u4E00\u6837\uFF0C\u4F20\u5165\u4E00\u4E2ACallable\u5BF9\u8C61\uFF0C\u7528\u4E8E\u63A5\u6536\u8FD4\u56DE\u503C\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws ExecutionException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ScheduledThreadPoolExecutor</span><span style="color:#A6ACCD;"> executor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ScheduledThreadPoolExecutor</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u8FD9\u91CC\u4F7F\u7528ScheduledFuture</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ScheduledFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> future </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">schedule</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">????</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u4EFB\u52A1\u5269\u4F59\u7B49\u5F85\u65F6\u95F4\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">future</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getDelay</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">MILLISECONDS</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1000.0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u4EFB\u52A1\u6267\u884C\u7ED3\u679C\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">future</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">shutdown</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u53EF\u4EE5\u770B\u5230<code>schedule</code>\u65B9\u6CD5\u8FD4\u56DE\u4E86\u4E00\u4E2AScheduledFuture\u5BF9\u8C61\uFF0C\u548CFuture\u4E00\u6837\uFF0C\u5B83\u4E5F\u652F\u6301\u8FD4\u56DE\u503C\u7684\u83B7\u53D6\u3001\u5305\u62EC\u5BF9\u4EFB\u52A1\u7684\u53D6\u6D88\u540C\u65F6\u8FD8\u652F\u6301\u83B7\u53D6\u5269\u4F59\u7B49\u5F85\u65F6\u95F4\u3002</p><p>\u90A3\u4E48\u5982\u679C\u6211\u4EEC\u5E0C\u671B\u6309\u7167\u4E00\u5B9A\u7684\u9891\u7387\u4E0D\u65AD\u6267\u884C\u4EFB\u52A1\u5462\uFF1F</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws ExecutionException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ScheduledThreadPoolExecutor</span><span style="color:#A6ACCD;"> executor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ScheduledThreadPoolExecutor</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    executor</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">scheduleAtFixedRate</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello World!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u4E09\u79D2\u949F\u5EF6\u8FDF\u5F00\u59CB\uFF0C\u4E4B\u540E\u6BCF\u9694\u4E00\u79D2\u949F\u6267\u884C\u4E00\u6B21</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>Executors\u4E5F\u4E3A\u6211\u4EEC\u9884\u7F6E\u4E86newScheduledThreadPool\u65B9\u6CD5\u7528\u4E8E\u521B\u5EFA\u7EBF\u7A0B\u6C60\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws ExecutionException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">ScheduledExecutorService</span><span style="color:#A6ACCD;"> service </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Executors</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newScheduledThreadPool</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    service</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">schedule</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello World!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="\u7EBF\u7A0B\u6C60\u5B9E\u73B0\u539F\u7406" tabindex="-1">\u7EBF\u7A0B\u6C60\u5B9E\u73B0\u539F\u7406 <a class="header-anchor" href="#\u7EBF\u7A0B\u6C60\u5B9E\u73B0\u539F\u7406" aria-hidden="true">#</a></h5><h6 id="ctl\u53D8\u91CF" tabindex="-1">ctl\u53D8\u91CF <a class="header-anchor" href="#ctl\u53D8\u91CF" aria-hidden="true">#</a></h6><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">//\u8FD9\u4E2A\u53D8\u91CF\u6BD4\u8F83\u5173\u952E\uFF0C\u7528\u5230\u4E86\u539F\u5B50AtomicInteger\uFF0C\u7528\u4E8E\u540C\u65F6\u4FDD\u5B58\u7EBF\u7A0B\u6C60\u8FD0\u884C\u72B6\u6001\u548C\u7EBF\u7A0B\u6570\u91CF\uFF08\u4F7F\u7528\u539F\u5B50\u7C7B\u662F\u4E3A\u4E86\u4FDD\u8BC1\u539F\u5B50\u6027\uFF09</span></span>
<span class="line"><span style="color:#676E95;">//\u5B83\u662F\u901A\u8FC7\u62C6\u520632\u4E2Abit\u4F4D\u6765\u4FDD\u5B58\u6570\u636E\u7684\uFF0C\u524D3\u4F4D\u4FDD\u5B58\u72B6\u6001\uFF0C\u540E29\u4F4D\u4FDD\u5B58\u5DE5\u4F5C\u7EBF\u7A0B\u6570\u91CF\uFF08\u90A3\u8981\u662F\u5DE5\u4F5C\u7EBF\u7A0B\u6570\u91CF29\u4F4D\u88C5\u4E0D\u4E0B\u4E0D\u5C31GG\uFF1F\uFF09</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">AtomicInteger</span><span style="color:#A6ACCD;"> ctl </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">AtomicInteger</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">ctlOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">RUNNING</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> COUNT_BITS </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Integer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SIZE </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//29\u4F4D\uFF0C\u7EBF\u7A0B\u6570\u91CF\u4F4D</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> CAPACITY   </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#A6ACCD;"> COUNT_BITS</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8BA1\u7B97\u5F97\u51FA\u6700\u5927\u5BB9\u91CF\uFF081\u5DE6\u79FB29\u4F4D\uFF0C\u6700\u5927\u5BB9\u91CF\u4E3A2\u768429\u6B21\u65B9-1\uFF09</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// \u6240\u6709\u7684\u8FD0\u884C\u72B6\u6001\uFF0C\u6CE8\u610F\u90FD\u662F\u53EA\u5360\u7528\u524D3\u4F4D\uFF0C\u4E0D\u4F1A\u5360\u7528\u540E29\u4F4D</span></span>
<span class="line"><span style="color:#676E95;">// \u63A5\u6536\u65B0\u4EFB\u52A1\uFF0C\u5E76\u7B49\u5F85\u6267\u884C\u961F\u5217\u4E2D\u7684\u4EFB\u52A1</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> RUNNING    </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#A6ACCD;"> COUNT_BITS</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//111 | 0000... (\u540E29\u6570\u91CF\u4F4D\uFF0C\u4E0B\u540C)</span></span>
<span class="line"><span style="color:#676E95;">// \u4E0D\u63A5\u6536\u65B0\u4EFB\u52A1\uFF0C\u4F46\u662F\u4F9D\u7136\u7B49\u5F85\u6267\u884C\u961F\u5217\u4E2D\u7684\u4EFB\u52A1</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> SHUTDOWN   </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#A6ACCD;"> COUNT_BITS</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//000 | \u6570\u91CF\u4F4D</span></span>
<span class="line"><span style="color:#676E95;">// \u4E0D\u63A5\u6536\u65B0\u4EFB\u52A1\uFF0C\u4E5F\u4E0D\u6267\u884C\u961F\u5217\u4E2D\u7684\u4EFB\u52A1\uFF0C\u5E76\u4E14\u8FD8\u8981\u4E2D\u65AD\u6B63\u5728\u6267\u884C\u4E2D\u7684\u4EFB\u52A1</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> STOP       </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#A6ACCD;"> COUNT_BITS</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//001 | \u6570\u91CF\u4F4D</span></span>
<span class="line"><span style="color:#676E95;">// \u6240\u6709\u7684\u4EFB\u52A1\u90FD\u5DF2\u7ED3\u675F\uFF0C\u7EBF\u7A0B\u6570\u91CF\u4E3A0\uFF0C\u5373\u5C06\u5B8C\u5168\u5173\u95ED</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> TIDYING    </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#A6ACCD;"> COUNT_BITS</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//010 | \u6570\u91CF\u4F4D</span></span>
<span class="line"><span style="color:#676E95;">// \u5B8C\u5168\u5173\u95ED</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> TERMINATED </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#A6ACCD;"> COUNT_BITS</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//011 | \u6570\u91CF\u4F4D</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// \u5C01\u88C5\u548C\u89E3\u6790ctl\u53D8\u91CF\u7684\u4E00\u4E9B\u65B9\u6CD5</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">runStateOf</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> c</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> c </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">CAPACITY</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5BF9CAPACITY\u53D6\u53CD\u5C31\u662F\u540E29\u4F4D\u5168\u90E8\u4E3A0\uFF0C\u524D\u4E09\u4F4D\u5168\u90E8\u4E3A1\uFF0C\u63A5\u7740\u4E0Ec\u8FDB\u884C\u4E0E\u8FD0\u7B97\uFF0C\u8FD9\u6837\u5C31\u53EF\u4EE5\u53EA\u5F97\u5230\u524D\u4E09\u4F4D\u7684\u7ED3\u679C\u4E86\uFF0C\u6240\u4EE5\u8FD9\u91CC\u662F\u53D6\u8FD0\u884C\u72B6\u6001</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">workerCountOf</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> c</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> c </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;"> CAPACITY</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#676E95;">//\u540C\u4E0A\uFF0C\u8FD9\u91CC\u662F\u4E3A\u4E86\u5F97\u5230\u540E29\u4F4D\u7684\u7ED3\u679C\uFF0C\u6240\u4EE5\u8FD9\u91CC\u662F\u53D6\u7EBF\u7A0B\u6570\u91CF</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ctlOf</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> rs</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> wc</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> rs </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> wc</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#676E95;">// \u6BD4\u5982\u4E0A\u9762\u7684RUNNING, 0\uFF0C\u8FDB\u884C\u4E0E\u8FD0\u7B97\u4E4B\u540E\uFF1A</span></span>
<span class="line"><span style="color:#676E95;">// 111 | 0000000000000000000000000</span></span>
<span class="line"></span></code></pre></div><p><img src="`+q+`" alt="image-20220406112223538"></p><p>\u5728\u8C03\u7528<code>execute</code>\u65B9\u6CD5\u4E4B\u540E\uFF0C\u7EBF\u7A0B\u6C60\u4F1A\u505A\u4E9B\u4EC0\u4E48\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">//\u8FD9\u4E2A\u5C31\u662F\u6211\u4EEC\u6307\u5B9A\u7684\u963B\u585E\u961F\u5217</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">BlockingQueue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Runnable</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> workQueue</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">//\u518D\u6B21\u63D0\u9192\uFF0C\u8FD9\u91CC\u6CA1\u52A0\u9501\uFF01\uFF01\u8BE5\u6709\u4EC0\u4E48\u610F\u8BC6\u4E0D\u7528\u6211\u8BF4\u4E86\u5427\uFF0C\u6240\u4EE5\u8BF4ctl\u624D\u4F1A\u4F7F\u7528\u539F\u5B50\u7C7B\u3002</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">execute</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> command</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">command </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">NullPointerException</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">//\u5982\u679C\u4EFB\u52A1\u4E3Anull\uFF0C\u90A3\u6267\u884C\u4E2A\u5BC2\u5BDE\uFF0C\u6240\u4EE5\u8BF4\u76F4\u63A5\u7A7A\u6307\u9488</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> c </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ctl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;">//\u83B7\u53D6ctl\u7684\u503C\uFF0C\u4E00\u4F1A\u8981\u8BFB\u53D6\u4FE1\u606F\u7684</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">workerCountOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> corePoolSize</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5224\u65AD\u5DE5\u4F5C\u7EBF\u7A0B\u6570\u91CF\u662F\u5426\u5C0F\u4E8E\u6838\u5FC3\u7EBF\u7A0B\u6570</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">addWorker</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">command</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true))</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5982\u679C\u662F\uFF0C\u90A3\u4E0D\u7BA1\u4E09\u4E03\u4E8C\u5341\u4E00\uFF0C\u76F4\u63A5\u52A0\u65B0\u7684\u7EBF\u7A0B\u6267\u884C\uFF0C\u7136\u540E\u8FD4\u56DE\u5373\u53EF</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        c </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ctl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5982\u679C\u7EBF\u7A0B\u6DFB\u52A0\u5931\u8D25\uFF08\u6709\u53EF\u80FD\u5176\u4ED6\u7EBF\u7A0B\u4E5F\u5728\u5BF9\u7EBF\u7A0B\u6C60\u8FDB\u884C\u64CD\u4F5C\uFF09\uFF0C\u90A3\u5C31\u66F4\u65B0\u4E00\u4E0Bc\u7684\u503C</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">isRunning</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> workQueue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">offer</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">command</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u7EE7\u7EED\u5224\u65AD\uFF0C\u5982\u679C\u5F53\u524D\u7EBF\u7A0B\u6C60\u662F\u8FD0\u884C\u72B6\u6001\uFF0C\u90A3\u5C31\u5C1D\u8BD5\u5411\u963B\u585E\u961F\u5217\u4E2D\u6DFB\u52A0\u4E00\u4E2A\u65B0\u7684\u7B49\u5F85\u4EFB\u52A1</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> recheck </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ctl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u518D\u6B21\u83B7\u53D6ctl\u7684\u503C</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isRunning</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">recheck</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">remove</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">command</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8FD9\u91CC\u662F\u518D\u6B21\u786E\u8BA4\u5F53\u524D\u7EBF\u7A0B\u6C60\u662F\u5426\u5173\u95ED\uFF0C\u5982\u679C\u6DFB\u52A0\u7B49\u5F85\u4EFB\u52A1\u540E\u7EBF\u7A0B\u6C60\u5173\u95ED\u4E86\uFF0C\u90A3\u5C31\u628A\u521A\u521A\u52A0\u8FDB\u53BB\u4EFB\u52A1\u7684\u53C8\u62FF\u51FA\u6765</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">reject</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">command</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u7136\u540E\u76F4\u63A5\u62D2\u7EDD\u5F53\u524D\u4EFB\u52A1\u7684\u63D0\u4EA4\uFF08\u4F1A\u6839\u636E\u6211\u4EEC\u7684\u62D2\u7EDD\u7B56\u7565\u51B3\u5B9A\u5982\u4F55\u8FDB\u884C\u62D2\u7EDD\u64CD\u4F5C\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">workerCountOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">recheck</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u8FD9\u4E2A\u65F6\u5019\u7EBF\u7A0B\u6C60\u4F9D\u7136\u5728\u8FD0\u884C\u72B6\u6001\uFF0C\u90A3\u4E48\u5C31\u68C0\u67E5\u4E00\u4E0B\u5F53\u524D\u5DE5\u4F5C\u7EBF\u7A0B\u6570\u662F\u5426\u4E3A0\uFF0C\u5982\u679C\u662F\u90A3\u5C31\u76F4\u63A5\u6DFB\u52A0\u65B0\u7EBF\u7A0B\u6267\u884C</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">addWorker</span><span style="color:#89DDFF;">(null,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6DFB\u52A0\u4E00\u4E2A\u65B0\u7684\u975E\u6838\u5FC3\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//\u5176\u4ED6\u60C5\u51B5\u5C31\u5565\u4E5F\u4E0D\u7528\u505A\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#82AAFF;">addWorker</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">command</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false))</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8FD9\u79CD\u60C5\u51B5\u8981\u4E48\u5C31\u662F\u7EBF\u7A0B\u6C60\u6CA1\u6709\u8FD0\u884C\uFF0C\u8981\u4E48\u5C31\u662F\u961F\u5217\u6EE1\u4E86\uFF0C\u8FD9\u91CC\u518D\u5C1D\u8BD5\u6DFB\u52A0\u4E00\u4E2A\u975E\u6838\u5FC3\u7EBF\u7A0B\u78B0\u78B0\u8FD0\u6C14</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">reject</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">command</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8981\u662F\u5B9E\u5728\u4E0D\u884C\u5C31\u62D2\u7EDD</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><code>addWorker</code>\u662F\u600E\u4E48\u521B\u5EFA\u548C\u6267\u884C\u4EFB\u52A1\u7684\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">addWorker</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> firstTask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> core</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u8FD9\u91CC\u7ED9\u6700\u5916\u5C42\u5FAA\u73AF\u6253\u4E86\u4E2A\u6807\u7B7E\uFF0C\u65B9\u4FBF\u4E00\u4F1A\u7684\u8DF3\u8F6C\u64CD\u4F5C</span></span>
<span class="line"><span style="color:#A6ACCD;">    retry</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(;;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u65E0\u9650\u5FAA\u73AF\uFF0C\u8001\u5957\u8DEF\u4E86\uFF0C\u6CE8\u610F\u8FD9\u91CC\u5168\u7A0B\u6CA1\u52A0\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> c </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ctl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">//\u83B7\u53D6ctl\u503C</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> rs </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">runStateOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u89E3\u6790\u5F53\u524D\u7684\u8FD0\u884C\u72B6\u6001</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// Check if queue empty only if necessary.</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">rs </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> SHUTDOWN </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5224\u65AD\u7EBF\u7A0B\u6C60\u662F\u5426\u4E0D\u662F\u5904\u4E8E\u8FD0\u884C\u72B6\u6001</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">rs </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> SHUTDOWN </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u4E0D\u662F\u8FD0\u884C\u72B6\u6001\uFF0C\u5224\u65AD\u7EBF\u7A0B\u662FSHUTDOWN\u72B6\u6001\u5E76\u3001\u4EFB\u52A1\u4E0D\u4E3Anull\u3001\u7B49\u5F85\u961F\u5217\u4E0D\u4E3A\u7A7A\uFF0C\u53EA\u8981\u6709\u5176\u4E2D\u4E00\u8005\u4E0D\u6EE1\u8DB3\uFF0C\u76F4\u63A5\u8FD4\u56DEfalse\uFF0C\u6DFB\u52A0\u5931\u8D25</span></span>
<span class="line"><span style="color:#A6ACCD;">               firstTask </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;"> workQueue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isEmpty</span><span style="color:#89DDFF;">()))</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(;;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5185\u5C42\u53C8\u4E00\u8F6E\u65E0\u9650\u5FAA\u73AF\uFF0C\u8FD9\u4E2A\u5FAA\u73AF\u662F\u4E3A\u4E86\u5C06\u7EBF\u7A0B\u8BA1\u6570\u589E\u52A0\uFF0C\u7136\u540E\u624D\u53EF\u4EE5\u771F\u6B63\u5730\u6DFB\u52A0\u4E00\u4E2A\u65B0\u7684\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> wc </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">workerCountOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u89E3\u6790\u5F53\u524D\u7684\u5DE5\u4F5C\u7EBF\u7A0B\u6570\u91CF</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">wc </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> CAPACITY </span><span style="color:#89DDFF;">||</span></span>
<span class="line"><span style="color:#A6ACCD;">                wc </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">core </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> corePoolSize </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> maximumPoolSize</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5224\u65AD\u4E00\u4E0B\u8FD8\u88C5\u5F97\u4E0B\u4E0D\uFF0C\u5982\u679C\u88C5\u5F97\u4E0B\uFF0C\u770B\u770B\u662F\u6838\u5FC3\u7EBF\u7A0B\u8FD8\u662F\u975E\u6838\u5FC3\u7EBF\u7A0B\uFF0C\u5982\u679C\u662F\u6838\u5FC3\u7EBF\u7A0B\uFF0C\u4E0D\u80FD\u5927\u4E8E\u6838\u5FC3\u7EBF\u7A0B\u6570\u7684\u9650\u5236\uFF0C\u5982\u679C\u662F\u975E\u6838\u5FC3\u7EBF\u7A0B\uFF0C\u4E0D\u80FD\u5927\u4E8E\u6700\u5927\u7EBF\u7A0B\u6570\u9650\u5236</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">compareAndIncrementWorkerCount</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//CAS\u81EA\u589E\u7EBF\u7A0B\u8BA1\u6570\uFF0C\u5982\u679C\u589E\u52A0\u6210\u529F\uFF0C\u4EFB\u52A1\u5B8C\u6210\uFF0C\u76F4\u63A5\u8DF3\u51FA\u7EE7\u7EED</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">break</span><span style="color:#A6ACCD;"> retry</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u6CE8\u610F\u8FD9\u91CC\u8981\u76F4\u63A5\u8DF3\u51FA\u6700\u5916\u5C42\u5FAA\u73AF\uFF0C\u6240\u4EE5\u7528\u5230\u4E86\u6807\u7B7E\uFF08\u7C7B\u4F3C\u4E8Egoto\u8BED\u53E5\uFF09</span></span>
<span class="line"><span style="color:#A6ACCD;">            c </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ctl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">// \u5982\u679CCAS\u5931\u8D25\uFF0C\u66F4\u65B0\u4E00\u4E0Bc\u7684\u503C</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">runStateOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> rs</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5982\u679CCAS\u5931\u8D25\u7684\u539F\u56E0\u662F\u56E0\u4E3A\u7EBF\u7A0B\u6C60\u72B6\u6001\u548C\u4E00\u5F00\u59CB\u7684\u4E0D\u4E00\u6837\u4E86\uFF0C\u90A3\u4E48\u5C31\u91CD\u65B0\u4ECE\u5916\u5C42\u5FAA\u73AF\u518D\u6765\u4E00\u6B21</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">continue</span><span style="color:#A6ACCD;"> retry</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u6CE8\u610F\u8FD9\u91CC\u8981\u76F4\u63A5\u4ECE\u6700\u5916\u5C42\u5FAA\u73AF\u7EE7\u7EED\uFF0C\u6240\u4EE5\u7528\u5230\u4E86\u6807\u7B7E\uFF08\u7C7B\u4F3C\u4E8Egoto\u8BED\u53E5\uFF09</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// \u5982\u679C\u662F\u5176\u4ED6\u539F\u56E0\u5BFC\u81F4\u7684CAS\u5931\u8D25\uFF0C\u90A3\u53EA\u53EF\u80FD\u662F\u5176\u4ED6\u7EBF\u7A0B\u540C\u65F6\u5728\u81EA\u589E\uFF0C\u6240\u4EE5\u91CD\u65B0\u518D\u6765\u4E00\u6B21\u5185\u5C42\u5FAA\u73AF</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  	</span><span style="color:#676E95;">//\u597D\u4E86\uFF0C\u7EBF\u7A0B\u8BA1\u6570\u81EA\u589E\u4E5F\u5B8C\u4E86\uFF0C\u63A5\u7740\u5C31\u662F\u6DFB\u52A0\u65B0\u7684\u5DE5\u4F5C\u7EBF\u7A0B\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> workerStarted </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5DE5\u4F5C\u7EBF\u7A0B\u662F\u5426\u5DF2\u542F\u52A8</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> workerAdded </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5DE5\u4F5C\u7EBF\u7A0B\u662F\u5426\u5DF2\u6DFB\u52A0</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Worker</span><span style="color:#A6ACCD;"> w </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">//\u6682\u65F6\u7406\u89E3\u4E3A\u5DE5\u4F5C\u7EBF\u7A0B\uFF0C\u522B\u6025\uFF0C\u6211\u4EEC\u4E4B\u540E\u4F1A\u89E3\u8BFBWorker\u7C7B</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        w </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Worker</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">firstTask</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">//\u521B\u5EFA\u65B0\u7684\u5DE5\u4F5C\u7EBF\u7A0B\uFF0C\u4F20\u5165\u6211\u4EEC\u63D0\u4EA4\u7684\u4EFB\u52A1</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Thread</span><span style="color:#A6ACCD;"> t </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> w</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">thread</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u62FF\u5230\u5DE5\u4F5C\u7EBF\u7A0B\u4E2D\u5C01\u88C5\u7684Thread\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;">//\u5982\u679C\u7EBF\u7A0B\u4E0D\u4E3Anull\uFF0C\u90A3\u5C31\u53EF\u4EE5\u5B89\u6392\u5E72\u6D3B\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> mainLock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">mainLock</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;">//\u53C8\u662FReentrantLock\u52A0\u9501\u73AF\u8282\uFF0C\u8FD9\u91CC\u5F00\u59CB\u5C31\u662F\u53EA\u6709\u4E00\u4E2A\u7EBF\u7A0B\u80FD\u8FDB\u5165\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">            mainLock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">                </span><span style="color:#676E95;">// Recheck while holding lock.</span></span>
<span class="line"><span style="color:#89DDFF;">                </span><span style="color:#676E95;">// Back out on ThreadFactory failure or if</span></span>
<span class="line"><span style="color:#89DDFF;">                </span><span style="color:#676E95;">// shut down before lock acquired.</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> rs </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">runStateOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ctl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">());</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u83B7\u53D6\u5F53\u524D\u7EBF\u7A0B\u7684\u8FD0\u884C\u72B6\u6001</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">rs </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> SHUTDOWN </span><span style="color:#89DDFF;">||</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">rs </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> SHUTDOWN </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> firstTask </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u53EA\u6709\u5F53\u524D\u7EBF\u7A0B\u6C60\u662F\u6B63\u5728\u8FD0\u884C\u72B6\u6001\uFF0C\u6216\u662FSHUTDOWN\u72B6\u6001\u4E14firstTask\u4E3A\u7A7A\uFF0C\u90A3\u4E48\u5C31\u7EE7\u7EED</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isAlive</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u68C0\u67E5\u4E00\u4E0B\u7EBF\u7A0B\u662F\u5426\u6B63\u5728\u8FD0\u884C\u72B6\u6001</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IllegalThreadStateException</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u662F\u90A3\u80AF\u5B9A\u662F\u4E0D\u80FD\u8FD0\u884C\u6211\u4EEC\u7684\u4EFB\u52A1\u7684</span></span>
<span class="line"><span style="color:#A6ACCD;">                    workers</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">w</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u76F4\u63A5\u5C06\u65B0\u521B\u5EFA\u7684Work\u4E22\u8FDB workers \u96C6\u5408\u4E2D</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> s </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> workers</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">size</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u770B\u770B\u5F53\u524Dworkers\u7684\u5927\u5C0F</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> largestPoolSize</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8FD9\u91CC\u662F\u8BB0\u5F55\u7EBF\u7A0B\u6C60\u8FD0\u884C\u4EE5\u6765\uFF0C\u5386\u53F2\u4E0A\u7684\u6700\u591A\u7EBF\u7A0B\u6570</span></span>
<span class="line"><span style="color:#A6ACCD;">                        largestPoolSize </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                    workerAdded </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5DE5\u4F5C\u7EBF\u7A0B\u5DF2\u6DFB\u52A0</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                mainLock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u89E3\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">workerAdded</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                t</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u542F\u52A8\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">                workerStarted </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//\u5DE5\u4F5C\u7EBF\u7A0B\u5DF2\u542F\u52A8</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#A6ACCD;"> workerStarted</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5982\u679C\u7EBF\u7A0B\u5728\u4E0A\u9762\u7684\u542F\u52A8\u8FC7\u7A0B\u4E2D\u5931\u8D25\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">addWorkerFailed</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">w</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5C06w\u79FB\u51FAworkers\u5E76\u5C06\u8BA1\u6570\u5668-1\uFF0C\u6700\u540E\u5982\u679C\u7EBF\u7A0B\u6C60\u662F\u7EC8\u6B62\u72B6\u6001\uFF0C\u4F1A\u5C1D\u8BD5\u52A0\u901F\u7EC8\u6B62\u7EBF\u7A0B\u6C60</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> workerStarted</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8FD4\u56DE\u662F\u5426\u6210\u529F</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>Worker\u7C7B\u662F\u5982\u4F55\u5B9E\u73B0\u7684\uFF0C\u5B83\u7EE7\u627F\u81EAAbstractQueuedSynchronizer\uFF0C\u65F6\u9694\u4E24\u7AE0\uFF0C\u5C45\u7136\u518D\u6B21\u9047\u5230AQS\uFF0C\u90A3\u4E5F\u5C31\u662F\u8BF4\uFF0C\u5B83\u672C\u8EAB\u5C31\u662F\u4E00\u628A\u9501\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Worker</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">AbstractQueuedSynchronizer</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">implements</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Runnable</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//\u7528\u6765\u5E72\u6D3B\u7684\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Thread</span><span style="color:#A6ACCD;"> thread</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//\u8981\u6267\u884C\u7684\u7B2C\u4E00\u4E2A\u4EFB\u52A1\uFF0C\u6784\u9020\u65F6\u5C31\u786E\u5B9A\u4E86\u7684</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> firstTask</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">//\u5E72\u6D3B\u6570\u91CF\u8BA1\u6570\u5668\uFF0C\u4E5F\u5C31\u662F\u8FD9\u4E2A\u7EBF\u7A0B\u5B8C\u6210\u4E86\u591A\u5C11\u4E2A\u4EFB\u52A1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> completedTasks</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">Worker</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">firstTask</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">setState</span><span style="color:#89DDFF;">(-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u6267\u884CTask\u4E4B\u524D\u4E0D\u8BA9\u4E2D\u65AD\uFF0C\u5C06AQS\u7684state\u8BBE\u5B9A\u4E3A-1</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">firstTask </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> firstTask</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">thread </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getThreadFactory</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">newThread</span><span style="color:#89DDFF;">(this);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u901A\u8FC7\u9884\u5B9A\u4E49\u6216\u662F\u6211\u4EEC\u81EA\u5B9A\u4E49\u7684\u7EBF\u7A0B\u5DE5\u5382\u521B\u5EFA\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">run</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">runWorker</span><span style="color:#89DDFF;">(this);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u771F\u6B63\u5F00\u59CB\u5E72\u6D3B\uFF0C\u5305\u62EC\u5F53\u524D\u6D3B\u5E72\u5B8C\u4E86\u53C8\u8981\u7B49\u65B0\u7684\u6D3B\u6765\uFF0C\u5C31\u4ECE\u8FD9\u91CC\u5F00\u59CB\uFF0C\u4E00\u4F1A\u8BE6\u7EC6\u4ECB\u7ECD</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">   	</span><span style="color:#676E95;">//0\u5C31\u662F\u6CA1\u52A0\u9501\uFF0C1\u5C31\u662F\u5DF2\u52A0\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isHeldExclusively</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getState</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">...</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>Worker\u5230\u5E95\u662F\u600E\u4E48\u5728\u8FDB\u884C\u4EFB\u52A1\u7684\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">runWorker</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Worker</span><span style="color:#A6ACCD;"> w</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Thread</span><span style="color:#A6ACCD;"> wt </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u83B7\u53D6\u5F53\u524D\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> task </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> w</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">firstTask</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u53D6\u51FA\u8981\u6267\u884C\u7684\u4EFB\u52A1</span></span>
<span class="line"><span style="color:#A6ACCD;">    w</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">firstTask </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u7136\u540E\u628AWorker\u4E2D\u7684\u4EFB\u52A1\u8BBE\u5B9A\u4E3Anull</span></span>
<span class="line"><span style="color:#A6ACCD;">    w</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u56E0\u4E3A\u4E00\u5F00\u59CB\u4E3A-1\uFF0C\u8FD9\u91CC\u662F\u901A\u8FC7unlock\u64CD\u4F5C\u5C06\u5176\u4FEE\u6539\u56DE0\uFF0C\u53EA\u6709state\u5927\u4E8E\u7B49\u4E8E0\u624D\u80FD\u54CD\u5E94\u4E2D\u65AD</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> completedAbruptly </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//\u53EA\u8981\u4EFB\u52A1\u4E0D\u4E3Anull\uFF0C\u6216\u662F\u4EFB\u52A1\u4E3A\u7A7A\u4F46\u662F\u53EF\u4EE5\u4ECE\u7B49\u5F85\u961F\u5217\u4E2D\u53D6\u51FA\u4EFB\u52A1\u4E0D\u4E3A\u7A7A\uFF0C\u90A3\u4E48\u5C31\u5F00\u59CB\u6267\u884C\u8FD9\u4E2A\u4EFB\u52A1\uFF0C\u6CE8\u610F\u8FD9\u91CC\u662F\u65E0\u9650\u5FAA\u73AF\uFF0C\u4E5F\u5C31\u662F\u8BF4\u5982\u679C\u5F53\u524D\u6CA1\u6709\u4EFB\u52A1\u4E86\uFF0C\u90A3\u4E48\u4F1A\u5728getTask\u65B9\u6CD5\u4E2D\u5361\u4F4F\uFF0C\u56E0\u4E3A\u8981\u4ECE\u963B\u585E\u961F\u5217\u4E2D\u7B49\u7740\u53D6\u4EFB\u52A1</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">task </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">task </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getTask</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            w</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5BF9\u5F53\u524DWorker\u52A0\u9501\uFF0C\u8FD9\u91CC\u5176\u5B9E\u5E76\u4E0D\u662F\u9632\u5176\u4ED6\u7EBF\u7A0B\uFF0C\u800C\u662F\u5728shutdown\u65F6\u4FDD\u62A4\u6B64\u4EFB\u52A1\u7684\u8FD0\u884C</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;">//\u7531\u4E8E\u7EBF\u7A0B\u6C60\u5728STOP\u72B6\u6001\u53CA\u4EE5\u4E0A\u4F1A\u7981\u6B62\u65B0\u7EBF\u7A0B\u52A0\u5165\u5E76\u4E14\u4E2D\u65AD\u6B63\u5728\u8FDB\u884C\u7684\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">((</span><span style="color:#82AAFF;">runStateAtLeast</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ctl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> STOP</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u53EA\u8981\u7EBF\u7A0B\u6C60\u662FSTOP\u53CA\u4EE5\u4E0A\u7684\u72B6\u6001\uFF0C\u90A3\u80AF\u5B9A\u662F\u4E0D\u80FD\u5F00\u59CB\u65B0\u4EFB\u52A1\u7684</span></span>
<span class="line"><span style="color:#A6ACCD;">                 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">interrupted</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;">    					 </span><span style="color:#676E95;">//\u7EBF\u7A0B\u662F\u5426\u5DF2\u7ECF\u88AB\u6253\u4E0A\u4E2D\u65AD\u6807\u8BB0\u5E76\u4E14\u7EBF\u7A0B\u4E00\u5B9A\u662FSTOP\u53CA\u4EE5\u4E0A</span></span>
<span class="line"><span style="color:#A6ACCD;">                  </span><span style="color:#82AAFF;">runStateAtLeast</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ctl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> STOP</span><span style="color:#89DDFF;">)))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">wt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isInterrupted</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u518D\u6B21\u786E\u4FDD\u7EBF\u7A0B\u88AB\u6CA1\u6709\u6253\u4E0A\u4E2D\u65AD\u6807\u8BB0</span></span>
<span class="line"><span style="color:#A6ACCD;">                wt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">interrupt</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">//\u6253\u4E2D\u65AD\u6807\u8BB0</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">beforeExecute</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">wt</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> task</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">//\u5F00\u59CB\u4E4B\u524D\u7684\u51C6\u5907\u5DE5\u4F5C\uFF0C\u8FD9\u91CC\u6682\u65F6\u6CA1\u6709\u5B9E\u73B0</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">Throwable</span><span style="color:#A6ACCD;"> thrown </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    task</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//OK\uFF0C\u5F00\u59CB\u6267\u884C\u4EFB\u52A1</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">RuntimeException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    thrown </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Error</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    thrown </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Throwable</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    thrown </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Error</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#82AAFF;">afterExecute</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">task</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> thrown</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u6267\u884C\u4E4B\u540E\u7684\u5DE5\u4F5C\uFF0C\u4E5F\u6CA1\u5B9E\u73B0</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                task </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u4EFB\u52A1\u5DF2\u5B8C\u6210\uFF0C\u4E0D\u9700\u8981\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">                w</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">completedTasks</span><span style="color:#89DDFF;">++;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u4EFB\u52A1\u5B8C\u6210\u6570++</span></span>
<span class="line"><span style="color:#A6ACCD;">                w</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u89E3\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        completedAbruptly </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//\u5982\u679C\u80FD\u8D70\u5230\u8FD9\u4E00\u6B65\uFF0C\u90A3\u8BF4\u660E\u4E0A\u9762\u7684\u5FAA\u73AF\u80AF\u5B9A\u662F\u8DF3\u51FA\u4E86\uFF0C\u4E5F\u5C31\u662F\u8BF4\u8FD9\u4E2AWorker\u53EF\u4EE5\u4E22\u5F03\u4E86</span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//\u6240\u4EE5\u8FD9\u91CC\u4F1A\u76F4\u63A5\u5C06 Worker \u4ECE workers \u91CC\u5220\u9664\u6389</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">processWorkerExit</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">w</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> completedAbruptly</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5B83\u662F\u600E\u4E48\u4ECE\u963B\u585E\u961F\u5217\u91CC\u9762\u83B7\u53D6\u4EFB\u52A1\u7684\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getTask</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> timedOut </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// Did the last poll() time out?</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(;;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u65E0\u9650\u5FAA\u73AF\u83B7\u53D6</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> c </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ctl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u83B7\u53D6ctl </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> rs </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">runStateOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;">//\u89E3\u6790\u7EBF\u7A0B\u6C60\u8FD0\u884C\u72B6\u6001</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// Check if queue empty only if necessary.</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">rs </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> SHUTDOWN </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">rs </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> STOP </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> workQueue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isEmpty</span><span style="color:#89DDFF;">()))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;">//\u5224\u65AD\u662F\u4E0D\u662F\u6CA1\u6709\u5FC5\u8981\u518D\u6267\u884C\u7B49\u5F85\u961F\u5217\u4E2D\u7684\u4EFB\u52A1\u4E86\uFF0C\u4E5F\u5C31\u662F\u5904\u4E8E\u5173\u95ED\u7EBF\u7A0B\u6C60\u7684\u72B6\u6001\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">decrementWorkerCount</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">//\u76F4\u63A5\u51CF\u5C11\u4E00\u4E2A\u5DE5\u4F5C\u7EBF\u7A0B\u6570\u91CF</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u8FD4\u56DEnull\uFF0C\u8FD9\u6837\u4E0A\u9762\u7684runWorker\u5C31\u76F4\u63A5\u7ED3\u675F\u4E86\uFF0C\u4E0B\u540C</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> wc </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">workerCountOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u7EBF\u7A0B\u6C60\u8FD0\u884C\u6B63\u5E38\uFF0C\u90A3\u5C31\u83B7\u53D6\u5F53\u524D\u7684\u5DE5\u4F5C\u7EBF\u7A0B\u6570\u91CF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// Are workers subject to culling?</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> timed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> allowCoreThreadTimeOut </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> wc </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> corePoolSize</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u7EBF\u7A0B\u6570\u5927\u4E8E\u6838\u5FC3\u7EBF\u7A0B\u6570\u6216\u662F\u5141\u8BB8\u6838\u5FC3\u7EBF\u7A0B\u7B49\u5F85\u8D85\u65F6\uFF0C\u90A3\u4E48\u5C31\u6807\u8BB0\u4E3A\u53EF\u8D85\u65F6\u7684</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//\u8D85\u65F6\u6216maximumPoolSize\u5728\u8FD0\u884C\u671F\u95F4\u88AB\u4FEE\u6539\u4E86\uFF0C\u5E76\u4E14\u7EBF\u7A0B\u6570\u5927\u4E8E1\u6216\u7B49\u5F85\u961F\u5217\u4E3A\u7A7A\uFF0C\u90A3\u4E5F\u662F\u4E0D\u80FD\u83B7\u53D6\u5230\u4EFB\u52A1\u7684</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">wc </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> maximumPoolSize </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">timed </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> timedOut</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">wc </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> workQueue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isEmpty</span><span style="color:#89DDFF;">()))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">compareAndDecrementWorkerCount</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679CCAS\u51CF\u5C11\u5DE5\u4F5C\u7EBF\u7A0B\u6210\u529F</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u8FD4\u56DEnull</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">continue</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5426\u5219\u5F00\u4E0B\u4E00\u8F6E\u5FAA\u73AF</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> r </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> timed </span><span style="color:#89DDFF;">?</span></span>
<span class="line"><span style="color:#A6ACCD;">                workQueue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">poll</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">keepAliveTime</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">NANOSECONDS</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u53EF\u8D85\u65F6\uFF0C\u90A3\u4E48\u6700\u591A\u7B49\u5230\u8D85\u65F6\u65F6\u95F4</span></span>
<span class="line"><span style="color:#A6ACCD;">                workQueue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">take</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5982\u679C\u4E0D\u53EF\u8D85\u65F6\uFF0C\u90A3\u5C31\u4E00\u76F4\u7B49\u7740\u62FF\u4EFB\u52A1</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">r </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5982\u679C\u6210\u529F\u62FF\u5230\u4EFB\u52A1\uFF0Cok\uFF0C\u8FD4\u56DE</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> r</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            timedOut </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5426\u5219\u5C31\u662F\u8D85\u65F6\u4E86\uFF0C\u4E0B\u4E00\u8F6E\u5FAA\u73AF\u5C06\u76F4\u63A5\u8FD4\u56DEnull</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">retry</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            timedOut </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//\u5F00\u4E0B\u4E00\u8F6E\u5FAA\u73AF\u5427</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5F53\u7EBF\u7A0B\u6C60\u5173\u95ED\u65F6\u4F1A\u505A\u4EC0\u4E48\u4E8B\u60C5\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">//\u666E\u901A\u7684shutdown\u4F1A\u7EE7\u7EED\u5C06\u7B49\u5F85\u961F\u5217\u4E2D\u7684\u7EBF\u7A0B\u6267\u884C\u5B8C\u6210\u540E\u518D\u5173\u95ED\u7EBF\u7A0B\u6C60</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">shutdown</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> mainLock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">mainLock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    mainLock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//\u5224\u65AD\u662F\u5426\u6709\u6743\u9650\u7EC8\u6B62</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">checkShutdownAccess</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//CAS\u5C06\u7EBF\u7A0B\u6C60\u8FD0\u884C\u72B6\u6001\u6539\u4E3ASHUTDOWN\u72B6\u6001\uFF0C\u8FD8\u7B97\u6BD4\u8F83\u6E29\u67D4\uFF0C\u8BE6\u7EC6\u8FC7\u7A0B\u770B\u4E0B\u9762</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">advanceRunState</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SHUTDOWN</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">       	</span><span style="color:#676E95;">//\u8BA9\u95F2\u7740\u7684\u7EBF\u7A0B\uFF08\u6BD4\u5982\u6B63\u5728\u7B49\u65B0\u7684\u4EFB\u52A1\uFF09\u4E2D\u65AD\uFF0C\u4F46\u662F\u5E76\u4E0D\u4F1A\u5F71\u54CD\u6B63\u5728\u8FD0\u884C\u7684\u7EBF\u7A0B\uFF0C\u8BE6\u7EC6\u8FC7\u7A0B\u8BF7\u770B\u4E0B\u9762</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">interruptIdleWorkers</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">onShutdown</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">//\u7ED9ScheduledThreadPoolExecutor\u63D0\u4F9B\u7684\u94A9\u5B50\u65B9\u6CD5\uFF0C\u5C31\u662F\u7B49ScheduledThreadPoolExecutor\u53BB\u5B9E\u73B0\u7684\uFF0C\u5F53\u524D\u7C7B\u6CA1\u6709\u5B9E\u73B0</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        mainLock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">tryTerminate</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6700\u540E\u5C1D\u8BD5\u7EC8\u6B62\u7EBF\u7A0B\u6C60</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">advanceRunState</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> targetState</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(;;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> c </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ctl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u83B7\u53D6ctl</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">runStateAtLeast</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> targetState</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u662F\u5426\u5927\u4E8E\u7B49\u4E8E\u6307\u5B9A\u7684\u72B6\u6001</span></span>
<span class="line"><span style="color:#A6ACCD;">            ctl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">compareAndSet</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ctlOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">targetState</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">workerCountOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">))))</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//CAS\u8BBE\u7F6Ectl\u7684\u503C</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">break</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u4EFB\u610F\u4E00\u4E2A\u6761\u4EF6OK\u5C31\u53EF\u4EE5\u7ED3\u675F\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">interruptIdleWorkers</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> onlyOne</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> mainLock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">mainLock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    mainLock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Worker</span><span style="color:#A6ACCD;"> w </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> workers</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">Thread</span><span style="color:#A6ACCD;"> t </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> w</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">thread</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u62FF\u5230Worker\u4E2D\u7684\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isInterrupted</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> w</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">tryLock</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5148\u5224\u65AD\u4E00\u4E0B\u7EBF\u7A0B\u662F\u4E0D\u662F\u6CA1\u6709\u88AB\u4E2D\u65AD\u7136\u540E\u5C1D\u8BD5\u52A0\u9501\uFF0C\u4F46\u662F\u901A\u8FC7\u524D\u9762\u7684runWorker()\u6E90\u4EE3\u7801\u6211\u4EEC\u5F97\u77E5\uFF0C\u5F00\u59CB\u4E4B\u540E\u662F\u8BA9Worker\u52A0\u4E86\u9501\u7684\uFF0C\u6240\u4EE5\u5982\u679C\u7EBF\u7A0B\u8FD8\u5728\u6267\u884C\u4EFB\u52A1\uFF0C\u90A3\u4E48\u8FD9\u91CC\u80AF\u5B9A\u4F1Afalse</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    t</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">interrupt</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5982\u679C\u8D70\u5230\u8FD9\u91CC\uFF0C\u90A3\u4E48\u8BF4\u660E\u7EBF\u7A0B\u80AF\u5B9A\u662F\u4E00\u4E2A\u95F2\u7740\u7684\u7EBF\u7A0B\uFF0C\u76F4\u63A5\u7ED9\u4E2D\u65AD\u5427</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">SecurityException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">ignore</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    w</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u89E3\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">onlyOne</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5982\u679C\u53EA\u9488\u5BF9\u4E00\u4E2AWorker\uFF0C\u90A3\u4E48\u5C31\u7ED3\u675F\u5FAA\u73AF</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        mainLock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><code>shutdownNow()</code>\u65B9\u6CD5\u89E3\u6790\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">//shutdownNow\u5F00\u59CB\u540E\uFF0C\u4E0D\u4EC5\u4E0D\u5141\u8BB8\u65B0\u7684\u4EFB\u52A1\u5230\u6765\uFF0C\u4E5F\u4E0D\u4F1A\u518D\u6267\u884C\u7B49\u5F85\u961F\u5217\u7684\u7EBF\u7A0B\uFF0C\u800C\u4E14\u4F1A\u7EC8\u6B62\u6B63\u5728\u6267\u884C\u7684\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Runnable</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">shutdownNow</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Runnable</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> tasks</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> mainLock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">mainLock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    mainLock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">checkShutdownAccess</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//\u8FD9\u91CC\u5C31\u662F\u76F4\u63A5\u8BBE\u5B9A\u4E3ASTOP\u72B6\u6001\u4E86\uFF0C\u4E0D\u518D\u50CFshutdown\u90A3\u4E48\u6E29\u67D4</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">advanceRunState</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">STOP</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//\u76F4\u63A5\u4E2D\u65AD\u6240\u6709\u5DE5\u4F5C\u7EBF\u7A0B\uFF0C\u8BE6\u7EC6\u8FC7\u7A0B\u770B\u4E0B\u9762</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">interruptWorkers</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//\u53D6\u51FA\u4ECD\u5904\u4E8E\u963B\u585E\u961F\u5217\u4E2D\u7684\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">        tasks </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">drainQueue</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        mainLock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">tryTerminate</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> tasks</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6700\u540E\u8FD4\u56DE\u8FD8\u6CA1\u5F00\u59CB\u7684\u4EFB\u52A1</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">interruptWorkers</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> mainLock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">mainLock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    mainLock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Worker</span><span style="color:#A6ACCD;"> w </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> workers</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u904D\u5386\u6240\u6709Worker</span></span>
<span class="line"><span style="color:#A6ACCD;">            w</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">interruptIfStarted</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u65E0\u5DEE\u522B\u5BF9\u5F85\uFF0C\u4E00\u5F8B\u52A0\u4E2D\u65AD\u6807\u8BB0</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        mainLock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><code>tryTerminate()</code>\u7EC8\u6B62\u6389\u4E00\u4E2A\u7EBF\u7A0B\u6C60\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryTerminate</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(;;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">//\u65E0\u9650\u5FAA\u73AF</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> c </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ctl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u4E0A\u6765\u5148\u83B7\u53D6\u4E00\u4E0Bctl\u503C</span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//\u53EA\u8981\u662F\u6B63\u5728\u8FD0\u884C \u6216\u662F \u7EBF\u7A0B\u6C60\u57FA\u672C\u4E0A\u5173\u95ED\u4E86 \u6216\u662F \u5904\u4E8ESHUTDOWN\u72B6\u6001\u4E14\u5DE5\u4F5C\u961F\u5217\u4E0D\u4E3A\u7A7A\uFF0C\u90A3\u4E48\u8FD9\u65F6\u8FD8\u4E0D\u80FD\u5173\u95ED\u7EBF\u7A0B\u6C60\uFF0C\u8FD4\u56DE</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">isRunning</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">runStateAtLeast</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> TIDYING</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">runStateOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> SHUTDOWN </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;"> workQueue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isEmpty</span><span style="color:#89DDFF;">()))</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//\u8D70\u5230\u8FD9\u91CC\uFF0C\u8981\u4E48\u5904\u4E8ESHUTDOWN\u72B6\u6001\u4E14\u7B49\u5F85\u961F\u5217\u4E3A\u7A7A\u6216\u662FSTOP\u72B6\u6001</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">workerCountOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// \u5982\u679C\u5DE5\u4F5C\u7EBF\u7A0B\u6570\u4E0D\u662F0\uFF0C\u8FD9\u91CC\u4E5F\u4F1A\u4E2D\u65AD\u7A7A\u95F2\u72B6\u6001\u4E0B\u7684\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">interruptIdleWorkers</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ONLY_ONE</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u8FD9\u91CC\u6700\u591A\u53EA\u4E2D\u65AD\u4E00\u4E2A\u7A7A\u95F2\u7EBF\u7A0B\uFF0C\u7136\u540E\u8FD4\u56DE</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">      	</span><span style="color:#676E95;">//\u8D70\u5230\u8FD9\u91CC\uFF0C\u5DE5\u4F5C\u7EBF\u7A0B\u4E5F\u4E3A\u7A7A\u4E86\uFF0C\u53EF\u4EE5\u7EC8\u6B62\u7EBF\u7A0B\u6C60\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ReentrantLock</span><span style="color:#A6ACCD;"> mainLock </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">mainLock</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        mainLock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ctl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">compareAndSet</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ctlOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">TIDYING</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u5148CAS\u5C06\u72B6\u6001\u8BBE\u5B9A\u4E3ATIDYING\u8868\u793A\u57FA\u672C\u7EC8\u6B62\uFF0C\u6B63\u5728\u505A\u6700\u540E\u7684\u64CD\u4F5C</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#82AAFF;">terminated</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u7EC8\u6B62\uFF0C\u6682\u65F6\u6CA1\u6709\u5B9E\u73B0</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    ctl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">ctlOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">TERMINATED</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">));</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6700\u540E\u5C06\u72B6\u6001\u8BBE\u5B9A\u4E3ATERMINATED\uFF0C\u7EBF\u7A0B\u6C60\u7ED3\u675F\u4E86\u5B83\u5E74\u8F7B\u7684\u751F\u547D</span></span>
<span class="line"><span style="color:#A6ACCD;">                    termination</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">signalAll</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u5982\u679C\u6709\u7EBF\u7A0B\u8C03\u7528\u4E86awaitTermination\u65B9\u6CD5\uFF0C\u4F1A\u7B49\u5F85\u5F53\u524D\u7EBF\u7A0B\u6C60\u7EC8\u6B62\uFF0C\u5230\u8FD9\u91CC\u5DEE\u4E0D\u591A\u5C31\u53EF\u4EE5\u5524\u9192\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u7ED3\u675F</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">          	</span><span style="color:#676E95;">//\u6CE8\u610F\u5982\u679CCAS\u5931\u8D25\u4F1A\u76F4\u63A5\u8FDB\u4E0B\u4E00\u8F6E\u5FAA\u73AF\u91CD\u65B0\u5224\u65AD</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            mainLock</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// else retry on failed CAS</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="\u5E94\u7528\u7BC7" tabindex="-1">\u5E94\u7528\u7BC7 <a class="header-anchor" href="#\u5E94\u7528\u7BC7" aria-hidden="true">#</a></h2><h4 id="\u624B\u5199\u9501" tabindex="-1">\u624B\u5199\u9501 <a class="header-anchor" href="#\u624B\u5199\u9501" aria-hidden="true">#</a></h4><p>\u8981\u6C42\uFF1A\u540C\u4E00\u65F6\u95F4\u53EA\u80FD\u6709\u4E00\u4E2A\u7EBF\u7A0B\u6301\u6709\u9501\uFF0C\u4E0D\u8981\u6C42\u53EF\u91CD\u5165\uFF08\u65E0\u89C6\u53CD\u590D\u52A0\u9501\uFF09</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Main</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">    /**</span></span>
<span class="line"><span style="color:#676E95;">     * \u81EA\u884C\u5B9E\u73B0\u4E00\u4E2A\u6700\u666E\u901A\u7684\u72EC\u5360\u9501</span></span>
<span class="line"><span style="color:#676E95;">     * \u8981\u6C42\uFF1A\u540C\u4E00\u65F6\u95F4\u53EA\u80FD\u6709\u4E00\u4E2A\u7EBF\u7A0B\u6301\u6709\u9501\uFF0C\u4E0D\u8981\u6C42\u53EF\u91CD\u5165</span></span>
<span class="line"><span style="color:#676E95;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MyLock</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">implements</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Lock</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">        /**</span></span>
<span class="line"><span style="color:#676E95;">         * \u8BBE\u8BA1\u601D\u8DEF\uFF1A</span></span>
<span class="line"><span style="color:#676E95;">         * 1. \u9501\u88AB\u5360\u7528\uFF0C\u90A3\u4E48exclusiveOwnerThread\u5E94\u8BE5\u88AB\u8BB0\u5F55\uFF0C\u5E76\u4E14state = 1</span></span>
<span class="line"><span style="color:#676E95;">         * 2. \u9501\u6CA1\u6709\u88AB\u5360\u7528\uFF0C\u90A3\u4E48exclusiveOwnerThread\u4E3Anull\uFF0C\u5E76\u4E14state = 0</span></span>
<span class="line"><span style="color:#676E95;">         */</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Sync</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">AbstractQueuedSynchronizer</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryAcquire</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">isHeldExclusively</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">//\u65E0\u9700\u53EF\u91CD\u5165\u529F\u80FD\uFF0C\u5982\u679C\u662F\u5F53\u524D\u7EBF\u7A0B\u76F4\u63A5\u8FD4\u56DEtrue</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">compareAndSetState</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> arg</span><span style="color:#89DDFF;">)){</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//CAS\u64CD\u4F5C\u8FDB\u884C\u72B6\u6001\u66FF\u6362</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#82AAFF;">setExclusiveOwnerThread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">());</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u6210\u529F\u540E\u8BBE\u7F6E\u5F53\u524D\u7684\u6240\u6709\u8005\u7EBF\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryRelease</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">getState</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">throw</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IllegalMonitorStateException</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">//\u6CA1\u52A0\u9501\u60C5\u51B5\u4E0B\u662F\u4E0D\u80FD\u76F4\u63A5\u89E3\u9501\u7684</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">isHeldExclusively</span><span style="color:#89DDFF;">()){</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">//\u53EA\u6709\u6301\u6709\u9501\u7684\u7EBF\u7A0B\u624D\u80FD\u89E3\u9501</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#82AAFF;">setExclusiveOwnerThread</span><span style="color:#89DDFF;">(null);</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u8BBE\u7F6E\u6240\u6709\u8005\u7EBF\u7A0B\u4E3Anull</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#82AAFF;">setState</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u72B6\u6001\u53D8\u4E3A0</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isHeldExclusively</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getExclusiveOwnerThread</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Condition</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">newCondition</span><span style="color:#89DDFF;">(){</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ConditionObject</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">//\u76F4\u63A5\u7528\u73B0\u6210\u7684</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Sync</span><span style="color:#A6ACCD;"> sync </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Sync</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">lock</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            sync</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">acquire</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">lockInterruptibly</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            sync</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">acquireInterruptibly</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryLock</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> sync</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">tryAcquire</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryLock</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">time</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TimeUnit</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">unit</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> sync</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">tryAcquireNanos</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> unit</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toNanos</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">time</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">unlock</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            sync</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">release</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Condition</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">newCondition</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> sync</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newCondition</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="\u6D88\u8D39\u8005\u548C\u751F\u4EA7\u8005\u6A21\u578B" tabindex="-1">\u6D88\u8D39\u8005\u548C\u751F\u4EA7\u8005\u6A21\u578B <a class="header-anchor" href="#\u6D88\u8D39\u8005\u548C\u751F\u4EA7\u8005\u6A21\u578B" aria-hidden="true">#</a></h4><h5 id="\u963B\u585E\u961F\u5217\u5B9E\u73B0" tabindex="-1">\u963B\u585E\u961F\u5217\u5B9E\u73B0 <a class="header-anchor" href="#\u963B\u585E\u961F\u5217\u5B9E\u73B0" aria-hidden="true">#</a></h5><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Main</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">BlockingQueue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Object</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> queue </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ArrayBlockingQueue</span><span style="color:#89DDFF;">&lt;&gt;(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> supplier </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(true){</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> name </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getName</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">time</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u751F\u4EA7\u8005 </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> \u6B63\u5728\u51C6\u5907\u9910\u54C1...</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">time</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u751F\u4EA7\u8005 </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> \u5DF2\u51FA\u9910\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    queue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">put</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Object</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">printStackTrace</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> consumer </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(true){</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> name </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getName</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">time</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u6D88\u8D39\u8005 </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> \u6B63\u5728\u7B49\u5F85\u51FA\u9910...</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    queue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">take</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">time</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u6D88\u8D39\u8005 </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> \u53D6\u5230\u4E86\u9910\u54C1\u3002</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SECONDS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">time</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">\u6D88\u8D39\u8005 </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> \u5DF2\u7ECF\u5C06\u996D\u83DC\u5403\u5B8C\u4E86\uFF01</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">printStackTrace</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">supplier</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Supplier-</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">consumer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Consumer-</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">time</span><span style="color:#89DDFF;">(){</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">SimpleDateFormat</span><span style="color:#A6ACCD;"> format </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SimpleDateFormat</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">HH:mm:ss</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">format</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">format</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Date</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">] </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="completablefuture" tabindex="-1">completableFuture <a class="header-anchor" href="#completablefuture" aria-hidden="true">#</a></h4><blockquote><p>\u521D\u59CB\u5316\u7EBF\u7A0B\u76844\u79CD\u65B9\u5F0F\uFF1A</p><p>\u7EE7\u627FThread \u5B9E\u73B0Runnable\u63A5\u53E3 \u5B9E\u73B0Callable\u63A5\u53E3 + FutureTask \uFF08\u53EF\u4EE5\u62FF\u5230\u8FD4\u56DE\u7ED3\u679C\uFF0C\u53EF\u4EE5\u5904\u7406\u5F02\u5E38\uFF09 \u7EBF\u7A0B\u6C60 \u65B9\u5F0F1\u548C\u65B9\u5F0F2\uFF1A\u4E3B\u8FDB\u7A0B\u65E0\u6CD5\u83B7\u53D6\u7EBF\u7A0B\u7684\u8FD0\u7B97\u7ED3\u679C\u3002\u4E0D\u9002\u5408\u5F53\u524D\u573A\u666F</p><p>\u65B9\u5F0F3\uFF1A\u4E3B\u8FDB\u7A0B\u53EF\u4EE5\u83B7\u53D6\u7EBF\u7A0B\u7684\u8FD0\u7B97\u7ED3\u679C\uFF0C\u5E76\u8BBE\u7F6E\u7ED9itemVO\uFF0C\u4F46\u662F\u4E0D\u5229\u4E8E\u63A7\u5236\u670D\u52A1\u5668\u4E2D\u7684\u7EBF\u7A0B\u8D44\u6E90\u3002\u53EF\u4EE5\u5BFC\u81F4\u670D\u52A1\u5668\u8D44\u6E90\u8017\u5C3D\u3002</p><p>\u65B9\u5F0F4\uFF1A\u901A\u8FC7\u5982\u4E0B\u4E24\u79CD\u65B9\u5F0F\u521D\u59CB\u5316\u7EBF\u7A0B\u6C60\uFF1A</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#A6ACCD;">Executors</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newFiexedThreadPool</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#676E95;">//\u6216\u8005</span></span>
<span class="line"><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ThreadPoolExecutor</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">corePoolSize</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> maximumPoolSize</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> keepAliveTime</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TimeUnit</span><span style="color:#A6ACCD;"> unit</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> workQueue</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> threadFactory</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> handler</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre></div></blockquote><h6 id="\u521B\u5EFA\u5F02\u6B65\u5BF9\u8C61" tabindex="-1">\u521B\u5EFA\u5F02\u6B65\u5BF9\u8C61 <a class="header-anchor" href="#\u521B\u5EFA\u5F02\u6B65\u5BF9\u8C61" aria-hidden="true">#</a></h6><blockquote><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">runAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> runnable</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">runAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> runnable</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Executor</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">supplyAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Supplier</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> supplier</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">supplyAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Supplier</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> supplier</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Executor</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><blockquote><p><strong>\u6CA1\u6709\u6307\u5B9AExecutor\u7684\u65B9\u6CD5\u4F1A\u4F7F\u7528ForkJoinPool.commonPool() \u4F5C\u4E3A\u5B83\u7684\u7EBF\u7A0B\u6C60\u6267\u884C\u5F02\u6B65\u4EE3\u7801</strong>\u3002\u5982\u679C\u6307\u5B9A\u7EBF\u7A0B\u6C60\uFF0C\u5219\u4F7F\u7528\u6307\u5B9A\u7684\u7EBF\u7A0B\u6C60\u8FD0\u884C\u3002</p></blockquote><blockquote><ul><li>runAsync\u65B9\u6CD5\u4E0D\u652F\u6301\u8FD4\u56DE\u503C\u3002</li><li>supplyAsync\u53EF\u4EE5\u652F\u6301\u8FD4\u56DE\u503C\u3002</li></ul></blockquote></blockquote><h6 id="\u8BA1\u7B97\u5B8C\u6210\u65F6\u56DE\u8C03\u65B9\u6CD5" tabindex="-1">\u8BA1\u7B97\u5B8C\u6210\u65F6\u56DE\u8C03\u65B9\u6CD5 <a class="header-anchor" href="#\u8BA1\u7B97\u5B8C\u6210\u65F6\u56DE\u8C03\u65B9\u6CD5" aria-hidden="true">#</a></h6><blockquote><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">whenComplete</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">BiConsumer</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super Throwable</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">whenCompleteAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">BiConsumer</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super Throwable</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">whenCompleteAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">BiConsumer</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super Throwable</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Executor</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">exceptionally</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Function</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Throwable</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> fn</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre></div><blockquote><p>whenComplete\u53EF\u4EE5\u5904\u7406\u6B63\u5E38\u548C\u5F02\u5E38\u7684\u8BA1\u7B97\u7ED3\u679C\uFF0Cexceptionally\u5904\u7406\u5F02\u5E38\u60C5\u51B5\u3002BiConsumer&lt;? super T,? super Throwable&gt;\u53EF\u4EE5\u5B9A\u4E49\u5904\u7406\u4E1A\u52A1</p></blockquote><blockquote><p>whenComplete \u548C whenCompleteAsync \u7684\u533A\u522B\uFF1A whenComplete\uFF1A\u662F\u6267\u884C\u5F53\u524D\u4EFB\u52A1\u7684\u7EBF\u7A0B\u6267\u884C\u7EE7\u7EED\u6267\u884C whenComplete \u7684\u4EFB\u52A1\u3002 whenCompleteAsync\uFF1A\u662F\u6267\u884C\u628A whenCompleteAsync \u8FD9\u4E2A\u4EFB\u52A1\u7EE7\u7EED\u63D0\u4EA4\u7ED9\u7EBF\u7A0B\u6C60\u6765\u8FDB\u884C\u6267\u884C\u3002</p></blockquote><blockquote><p>\u65B9\u6CD5\u4E0D\u4EE5Async\u7ED3\u5C3E\uFF0CAction\u4F7F\u7528\u76F8\u540C\u7684\u7EBF\u7A0B\u6267\u884C\uFF0C\u800CAsync\u53EF\u80FD\u4F1A\u4F7F\u7528\u5176\u4ED6\u7EBF\u7A0B\u6267\u884C\uFF08\u5982\u679C\u662F\u4F7F\u7528\u76F8\u540C\u7684\u7EBF\u7A0B\u6C60\uFF0C\u4E5F\u53EF\u80FD\u4F1A\u88AB\u540C\u4E00\u4E2A\u7EBF\u7A0B\u9009\u4E2D\u6267\u884C\uFF09</p></blockquote><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">CompletableFutureDemo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ExecutionException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">CompletableFuture</span><span style="color:#A6ACCD;"> future </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> CompletableFuture</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">supplyAsync</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Supplier</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Object</span><span style="color:#89DDFF;">&gt;()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Object</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getName</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">\\t</span><span style="color:#C3E88D;"> completableFuture</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1024</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">whenComplete</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">BiConsumer</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Object</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Throwable</span><span style="color:#89DDFF;">&gt;()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">accept</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Object</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">o</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Throwable</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">throwable</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">-------o=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> o</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">          System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">-------throwable=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> throwable</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">exceptionally</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Function</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Throwable</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Object</span><span style="color:#89DDFF;">&gt;()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Object</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">apply</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Throwable</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">throwable</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">throwable=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> throwable</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">6666</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#A6ACCD;">System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">future</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div></blockquote><h6 id="handle-\u65B9\u6CD5" tabindex="-1">handle \u65B9\u6CD5 <a class="header-anchor" href="#handle-\u65B9\u6CD5" aria-hidden="true">#</a></h6><blockquote><p>handle \u662F\u6267\u884C<strong>\u4EFB\u52A1\u5B8C\u6210\u65F6</strong>\u5BF9\u7ED3\u679C\u7684\u5904\u7406\u3002 handle \u662F\u5728\u4EFB\u52A1\u5B8C\u6210\u540E\u518D\u6267\u884C\uFF0C\u8FD8\u53EF\u4EE5\u5904\u7406\u5F02\u5E38\u7684\u4EFB\u52A1\u3002</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">handle</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">BiFunction</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Throwable</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> fn</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">handleAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">BiFunction</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Throwable</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> fn</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">handleAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">BiFunction</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Throwable</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> fn</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">Executor</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre></div></blockquote><h6 id="\u7EBF\u7A0B\u4E32\u884C\u5316\u65B9\u6CD5" tabindex="-1">\u7EBF\u7A0B\u4E32\u884C\u5316\u65B9\u6CD5 <a class="header-anchor" href="#\u7EBF\u7A0B\u4E32\u884C\u5316\u65B9\u6CD5" aria-hidden="true">#</a></h6><blockquote><p>thenApply \u65B9\u6CD5\uFF1A\u5F53\u4E00\u4E2A\u7EBF\u7A0B\u4F9D\u8D56\u53E6\u4E00\u4E2A\u7EBF\u7A0B\u65F6\uFF0C\u83B7\u53D6\u4E0A\u4E00\u4E2A\u4EFB\u52A1\u8FD4\u56DE\u7684\u7ED3\u679C\uFF0C\u5E76\u8FD4\u56DE\u5F53\u524D\u4EFB\u52A1\u7684\u8FD4\u56DE\u503C\u3002</p><p>thenAccept\u65B9\u6CD5\uFF1A\u6D88\u8D39\u5904\u7406\u7ED3\u679C\u3002\u63A5\u6536\u4EFB\u52A1\u7684\u5904\u7406\u7ED3\u679C\uFF0C\u5E76\u6D88\u8D39\u5904\u7406\uFF0C\u65E0\u8FD4\u56DE\u7ED3\u679C\u3002</p><p>thenRun\u65B9\u6CD5\uFF1A\u53EA\u8981\u4E0A\u9762\u7684\u4EFB\u52A1\u6267\u884C\u5B8C\u6210\uFF0C\u5C31\u5F00\u59CB\u6267\u884CthenRun\uFF0C\u53EA\u662F\u5904\u7406\u5B8C\u4EFB\u52A1\u540E\uFF0C\u6267\u884C thenRun\u7684\u540E\u7EED\u64CD\u4F5C</p><p>\u5E26\u6709Async\u9ED8\u8BA4\u662F\u5F02\u6B65\u6267\u884C\u7684\u3002\u8FD9\u91CC\u6240\u8C13\u7684\u5F02\u6B65\u6307\u7684\u662F\u4E0D\u5728\u5F53\u524D\u7EBF\u7A0B\u5185\u6267\u884C\u3002</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">thenApply</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Function</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> fn</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">thenApplyAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Function</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> fn</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">thenApplyAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Function</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> fn</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Executor</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">thenAccept</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Consumer</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">thenAcceptAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Consumer</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">thenAcceptAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Consumer</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">Executor</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">thenRun</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">thenRunAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">thenRunAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">Executor</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre></div><blockquote><p>Function&lt;? super T,? extends U&gt; T\uFF1A\u4E0A\u4E00\u4E2A\u4EFB\u52A1\u8FD4\u56DE\u7ED3\u679C\u7684\u7C7B\u578B U\uFF1A\u5F53\u524D\u4EFB\u52A1\u7684\u8FD4\u56DE\u503C\u7C7B\u578B</p></blockquote><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws ExecutionException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Integer</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> future </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> CompletableFuture</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">supplyAsync</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Supplier</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Integer</span><span style="color:#89DDFF;">&gt;()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Integer</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentThread</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getName</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">\\t</span><span style="color:#C3E88D;"> completableFuture</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;">//int i = 10 / 0;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1024</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">thenApply</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Function</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Integer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Integer</span><span style="color:#89DDFF;">&gt;()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Integer</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">apply</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Integer</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">o</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">thenApply\u65B9\u6CD5\uFF0C\u4E0A\u6B21\u8FD4\u56DE\u7ED3\u679C\uFF1A</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> o</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;">  o </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">whenComplete</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">BiConsumer</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Integer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Throwable</span><span style="color:#89DDFF;">&gt;()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">accept</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Integer</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">o</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Throwable</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">throwable</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">-------o=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> o</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">      System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">-------throwable=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> throwable</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">exceptionally</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Function</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Throwable</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Integer</span><span style="color:#89DDFF;">&gt;()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Integer</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">apply</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Throwable</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">throwable</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">throwable=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> throwable</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">6666</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">handle</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">BiFunction</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Integer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Throwable</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Integer</span><span style="color:#89DDFF;">&gt;()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Integer</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">apply</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Integer</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">integer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Throwable</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">throwable</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">handle o=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> integer</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">      System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">handle throwable=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> throwable</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">8888</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#A6ACCD;">System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">future</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div></blockquote><h6 id="\u4E24\u4EFB\u52A1\u7EC4\u5408-\u90FD\u5B8C\u6210" tabindex="-1">\u4E24\u4EFB\u52A1\u7EC4\u5408-\u90FD\u5B8C\u6210 <a class="header-anchor" href="#\u4E24\u4EFB\u52A1\u7EC4\u5408-\u90FD\u5B8C\u6210" aria-hidden="true">#</a></h6><blockquote><p>\u4E24\u4E2A\u4EFB\u52A1\u5FC5\u987B\u90FD\u5B8C\u6210\uFF0C\u89E6\u53D1\u8BE5\u4EFB\u52A1\u3002</p><p>thenCombine\uFF1A\u7EC4\u5408\u4E24\u4E2Afuture\uFF0C\u83B7\u53D6\u4E24\u4E2Afuture\u7684\u8FD4\u56DE\u7ED3\u679C\uFF0C\u5E76\u8FD4\u56DE\u5F53\u524D\u4EFB\u52A1\u7684\u8FD4\u56DE\u503C</p><p>thenAcceptBoth\uFF1A\u7EC4\u5408\u4E24\u4E2Afuture\uFF0C\u83B7\u53D6\u4E24\u4E2Afuture\u4EFB\u52A1\u7684\u8FD4\u56DE\u7ED3\u679C\uFF0C\u7136\u540E\u5904\u7406\u4EFB\u52A1\uFF0C\u6CA1\u6709\u8FD4\u56DE\u503C\u3002</p><p>runAfterBoth\uFF1A\u7EC4\u5408\u4E24\u4E2Afuture\uFF0C\u4E0D\u9700\u8981\u83B7\u53D6future\u7684\u7ED3\u679C\uFF0C\u53EA\u9700\u4E24\u4E2Afuture\u5904\u7406\u5B8C\u4EFB\u52A1\u540E\uFF0C\u5904\u7406\u8BE5\u4EFB\u52A1\u3002</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">V</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">V</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">thenCombine</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#C792EA;">BiFunction</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super U</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends V</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> fn</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">V</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">V</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">thenCombineAsync</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#C792EA;">BiFunction</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super U</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends V</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> fn</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">V</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">V</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">thenCombineAsync</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#C792EA;">BiFunction</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super U</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends V</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> fn</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Executor</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">thenAcceptBoth</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#C792EA;">BiConsumer</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">thenAcceptBothAsync</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#C792EA;">BiConsumer</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">thenAcceptBothAsync</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#C792EA;">BiConsumer</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Executor</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">runAfterBoth</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">runAfterBothAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">runAfterBothAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">Executor</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre></div><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">CompletableFuture</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">supplyAsync</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">thenApplyAsync</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> t </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> world!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">thenCombineAsync</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">CompletableFuture</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">completedFuture</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> CompletableFuture</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> u</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> t </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> u</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}).</span><span style="color:#82AAFF;">whenComplete</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> u</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div></blockquote><h6 id="\u4E24\u4EFB\u52A1\u7EC4\u5408-\u4E00\u4E2A\u5B8C\u6210" tabindex="-1">\u4E24\u4EFB\u52A1\u7EC4\u5408 - \u4E00\u4E2A\u5B8C\u6210 <a class="header-anchor" href="#\u4E24\u4EFB\u52A1\u7EC4\u5408-\u4E00\u4E2A\u5B8C\u6210" aria-hidden="true">#</a></h6><blockquote><p>\u5F53\u4E24\u4E2A\u4EFB\u52A1\u4E2D\uFF0C\u4EFB\u610F\u4E00\u4E2Afuture\u4EFB\u52A1\u5B8C\u6210\u7684\u65F6\u5019\uFF0C\u6267\u884C\u4EFB\u52A1\u3002</p><p>applyToEither\uFF1A\u4E24\u4E2A\u4EFB\u52A1\u6709\u4E00\u4E2A\u6267\u884C\u5B8C\u6210\uFF0C\u83B7\u53D6\u5B83\u7684\u8FD4\u56DE\u503C\uFF0C\u5904\u7406\u4EFB\u52A1\u5E76\u6709\u65B0\u7684\u8FD4\u56DE\u503C\u3002</p><p>acceptEither\uFF1A\u4E24\u4E2A\u4EFB\u52A1\u6709\u4E00\u4E2A\u6267\u884C\u5B8C\u6210\uFF0C\u83B7\u53D6\u5B83\u7684\u8FD4\u56DE\u503C\uFF0C\u5904\u7406\u4EFB\u52A1\uFF0C\u6CA1\u6709\u65B0\u7684\u8FD4\u56DE\u503C\u3002</p><p>runAfterEither\uFF1A\u4E24\u4E2A\u4EFB\u52A1\u6709\u4E00\u4E2A\u6267\u884C\u5B8C\u6210\uFF0C\u4E0D\u9700\u8981\u83B7\u53D6future\u7684\u7ED3\u679C\uFF0C\u5904\u7406\u4EFB\u52A1\uFF0C\u4E5F\u6CA1\u6709\u8FD4\u56DE\u503C\u3002</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">applyToEither</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Function</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> fn</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">applyToEitherAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Function</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> fn</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">applyToEitherAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Function</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> U</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> fn</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                                        </span><span style="color:#C792EA;">Executor</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">acceptEither</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Consumer</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">acceptEitherAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Consumer</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">acceptEitherAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> extends T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">                                      </span><span style="color:#C792EA;">Consumer</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> super T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">Executor</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">runAfterEither</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">runAfterEitherAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">runAfterEitherAsync</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">CompletionStage</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> other</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">Runnable</span><span style="color:#A6ACCD;"> action</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">Executor</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre></div></blockquote><h6 id="\u591A\u4EFB\u52A1\u7EC4\u5408" tabindex="-1">\u591A\u4EFB\u52A1\u7EC4\u5408 <a class="header-anchor" href="#\u591A\u4EFB\u52A1\u7EC4\u5408" aria-hidden="true">#</a></h6><blockquote><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">allOf</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#89DDFF;">&gt;...</span><span style="color:#A6ACCD;"> cfs</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Object</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">anyOf</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">?</span><span style="color:#89DDFF;">&gt;...</span><span style="color:#A6ACCD;"> cfs</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre></div><p>allOf\uFF1A\u7B49\u5F85\u6240\u6709\u4EFB\u52A1\u5B8C\u6210</p><p>anyOf\uFF1A\u53EA\u8981\u6709\u4E00\u4E2A\u4EFB\u52A1\u5B8C\u6210</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> futures </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Arrays</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">asList</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">CompletableFuture</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">completedFuture</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">                                              CompletableFuture</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">completedFuture</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> world!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">                                              CompletableFuture</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">completedFuture</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">                                              CompletableFuture</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">completedFuture</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">java!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> allCompleted </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> CompletableFuture</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">allOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">futures</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toArray</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">[]{}));</span></span>
<span class="line"><span style="color:#A6ACCD;">allCompleted</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">thenRun</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">futures</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stream</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">forEach</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">future </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">get future at:</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">System</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">currentTimeMillis</span><span style="color:#89DDFF;">()+</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">, result:</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">future</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ExecutionException</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">printStackTrace</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div></blockquote><h6 id="\u5B9E\u4F8B" tabindex="-1">\u5B9E\u4F8B <a class="header-anchor" href="#\u5B9E\u4F8B" aria-hidden="true">#</a></h6><blockquote><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Service</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ItemServiceImpl</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">implements</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ItemService</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Autowired</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">GmallPmsFeign</span><span style="color:#A6ACCD;"> pmsFeign</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Autowired</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">GmallSmsFeign</span><span style="color:#A6ACCD;"> smsFeign</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Autowired</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">GmallWmsFeign</span><span style="color:#A6ACCD;"> wmsFeign</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Autowired</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ThreadPoolExecutor</span><span style="color:#A6ACCD;"> threadPoolExecutor</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ItemVO</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">loadData</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">skuId</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ExecutionException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InterruptedException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">ItemVO</span><span style="color:#A6ACCD;"> itemVO </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ItemVO</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// 1. \u83B7\u53D6sku\u7684\u57FA\u672C\u4FE1\u606F</span></span>
<span class="line"><span style="color:#676E95;">// \u540E\u7EED\u83B7\u53D6sku\u7684\u4FC3\u9500\u4FE1\u606F\u3001spu\u7684\u9500\u552E\u5C5E\u6027\u548Cspu\u8BE6\u60C5\u4FE1\u606F\uFF08\u9700\u8981sku\u4E2D\u7684spuId\uFF09\u90FD\u9700\u8981skuInfoEntity</span></span>
<span class="line"><span style="color:#676E95;">// supplyAsync\u6709\u8FD4\u56DE\u503C</span></span>
<span class="line"><span style="color:#676E95;">// runAsync\u65E0\u8FD4\u56DE\u503C</span></span>
<span class="line"><span style="color:#676E95;">// \u6240\u4EE5\u8FD9\u91CC\u9700\u8981\u4F7F\u7528supplyAsync</span></span>
<span class="line"><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">SkuInfoEntity</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> skuFuture </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> CompletableFuture</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">supplyAsync</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">Resp</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">SkuInfoEntity</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> skuInfoEntityResp </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">pmsFeign</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">querySkuById</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">skuId</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">SkuInfoEntity</span><span style="color:#A6ACCD;"> skuInfoEntity </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> skuInfoEntityResp</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getData</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">skuInfoEntity </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          BeanUtils</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">copyProperties</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">skuInfoEntity</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> itemVO</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> skuInfoEntity</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;"> threadPoolExecutor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// 2. \u83B7\u53D6sku\u7684\u56FE\u7247\u4FE1\u606F</span></span>
<span class="line"><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> skuImageFuture </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> CompletableFuture</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">runAsync</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">Resp</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">SkuImagesEntity</span><span style="color:#89DDFF;">&gt;&gt;</span><span style="color:#A6ACCD;"> listResp </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">pmsFeign</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">queryImagesBySkuId</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">skuId</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">SkuImagesEntity</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> images </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> listResp</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getData</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#A6ACCD;">CollectionUtils</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isEmpty</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">images</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#C792EA;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> imageUrls </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> images</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stream</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">map</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">image </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> image</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getImgUrl</span><span style="color:#89DDFF;">()).</span><span style="color:#82AAFF;">collect</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Collectors</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toList</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">          itemVO</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setPics</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">imageUrls</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;"> threadPoolExecutor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// 3. \u83B7\u53D6sku\u7684\u4FC3\u9500\u4FE1\u606F TODO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// 4. \u83B7\u53D6spu\u7684\u6240\u6709\u9500\u552E\u5C5E\u6027</span></span>
<span class="line"><span style="color:#676E95;">// thenAcceptAsync\uFF1A\u6709\u53C2\u6570\uFF0C\u65E0\u8FD4\u56DE</span></span>
<span class="line"><span style="color:#676E95;">// thenApplyAsync: \u6709\u53C2\u6570\uFF0C\u6709\u8FD4\u56DE</span></span>
<span class="line"><span style="color:#676E95;">// \u540E\u7EEDspu\u8BE6\u60C5\u4E5F\u9700\u8981skuInfoEntity\u4E2D\u7684spuId\uFF0C\u6240\u4EE5\u8FD9\u91CC\u4F7F\u7528thenApplyAsync</span></span>
<span class="line"><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">SkuInfoEntity</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> spuFuture </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> skuFuture</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">thenApplyAsync</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">skuInfoEntity </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">Resp</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">SkuSaleAttrValueEntity</span><span style="color:#89DDFF;">&gt;&gt;</span><span style="color:#A6ACCD;"> skuSaleAttrValueResp </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">pmsFeign</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">querySkuSaleAttrValueBySpuId</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">skuInfoEntity</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getSpuId</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">SkuSaleAttrValueEntity</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> skuSaleAttrValueEntities </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> skuSaleAttrValueResp</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getData</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">      itemVO</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setSaleAttrs</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">skuSaleAttrValueEntities</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> skuInfoEntity</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;"> threadPoolExecutor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// 5. \u83B7\u53D6\u89C4\u683C\u53C2\u6570\u7EC4\u53CA\u7EC4\u4E0B\u7684\u89C4\u683C\u53C2\u6570 TODO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// 6. spu\u8BE6\u60C5 TODO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> future </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> CompletableFuture</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">allOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">skuFuture</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> skuImageFuture</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> spuFuture</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#676E95;">// \u963B\u585E\u4E3B\u8FDB\u7A0B\uFF0C\u7B49\u5F85\u5B50\u8FDB\u7A0B\u5168\u90E8\u6267\u884C\u5B8C\u6BD5\uFF01</span></span>
<span class="line"><span style="color:#A6ACCD;">future</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> itemVO</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// SkuInfoServiceImpl</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">SkuItemVo</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">item</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Long</span><span style="color:#A6ACCD;"> skuId</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws ExecutionException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">SkuItemVo</span><span style="color:#A6ACCD;"> skuItemVo </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SkuItemVo</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">SkuInfoEntity</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> infoFutrue </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> CompletableFuture</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">supplyAsync</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;">//1 sku\u57FA\u672C\u4FE1\u606F</span></span>
<span class="line"><span style="color:#C792EA;">SkuInfoEntity</span><span style="color:#A6ACCD;"> info </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getById</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">skuId</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">skuItemVo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setInfo</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">info</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> info</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> ImgageFuture </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> CompletableFuture</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">runAsync</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;">//2 sku\u56FE\u7247\u4FE1\u606F</span></span>
<span class="line"><span style="color:#C792EA;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">SkuImagesEntity</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> images </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> imagesService</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getImagesBySkuId</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">skuId</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">skuItemVo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setImages</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">images</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> saleAttrFuture </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">infoFutrue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">thenAcceptAsync</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">res </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;">//3 \u83B7\u53D6spu\u9500\u552E\u5C5E\u6027\u7EC4\u5408 list</span></span>
<span class="line"><span style="color:#C792EA;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">ItemSaleAttrVo</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> saleAttrVos </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> skuSaleAttrValueService</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getSaleAttrsBuSpuId</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getSpuId</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">skuItemVo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setSaleAttr</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">saleAttrVos</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;">executor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> descFuture </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> infoFutrue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">thenAcceptAsync</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">res </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;">//4 \u83B7\u53D6spu\u4ECB\u7ECD</span></span>
<span class="line"><span style="color:#C792EA;">SpuInfoDescEntity</span><span style="color:#A6ACCD;"> spuInfo </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> spuInfoDescService</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getById</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getSpuId</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">skuItemVo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setDesc</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">spuInfo</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;">executor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> baseAttrFuture </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> infoFutrue</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">thenAcceptAsync</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">res </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;">//5 \u83B7\u53D6spu\u89C4\u683C\u53C2\u6570\u4FE1\u606F</span></span>
<span class="line"><span style="color:#C792EA;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">SpuItemAttrGroup</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> attrGroups </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> attrGroupService</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getAttrGroupWithAttrsBySpuId</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getSpuId</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getCatalogId</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">skuItemVo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setGroupAttrs</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">attrGroups</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// 6.\u67E5\u8BE2\u5F53\u524Dsku\u662F\u5426\u53C2\u4E0E\u79D2\u6740\u4F18\u60E0</span></span>
<span class="line"><span style="color:#C792EA;">CompletableFuture</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> secKillFuture </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> CompletableFuture</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">runAsync</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">R</span><span style="color:#A6ACCD;"> skuSeckillInfo </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> seckillFeignService</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getSkuSeckillInfo</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">skuId</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">skuSeckillInfo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getCode</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">SeckillInfoVo</span><span style="color:#A6ACCD;"> seckillInfoVo </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> skuSeckillInfo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getData</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TypeReference</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">SeckillInfoVo</span><span style="color:#89DDFF;">&gt;()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{});</span></span>
<span class="line"><span style="color:#A6ACCD;">      skuItemVo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setSeckillInfoVo</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">seckillInfoVo</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;"> executor</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// \u7B49\u5F85\u6240\u6709\u4EFB\u52A1\u90FD\u5B8C\u6210\u518D\u8FD4\u56DE</span></span>
<span class="line"><span style="color:#A6ACCD;">CompletableFuture</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">allOf</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ImgageFuture</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">saleAttrFuture</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">descFuture</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">baseAttrFuture</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">secKillFuture</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> skuItemVo</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u7EBF\u7A0B\u6C60\u53C2\u6570\uFF1A</p><ul><li>20-50\u6838\u5FC3\u7EBF\u7A0B\uFF0C200\u6700\u5927\u7EBF\u7A0B\uFF0C1W\u957F\u5EA6\u7B49\u5F85\u961F\u5217</li></ul></blockquote>`,456),L=[I];function N(B,O,R,U,P,W){return a(),n("div",null,L)}const V=s(j,[["render",N]]);export{_ as __pageData,V as default};
