import{_ as s,c as n,o as a,N as l}from"./chunks/framework.0799945b.js";const p="/assets/image-20230212144109161.98e6561b.png",o="/assets/image-20230212144134036.216e477d.png",E=JSON.parse('{"title":"Sharding-JDBC","description":"","frontmatter":{},"headers":[],"relativePath":"second/db/shardingJdbc.md"}'),e={name:"second/db/shardingJdbc.md"},r=l('<h1 id="sharding-jdbc" tabindex="-1">Sharding-JDBC <a class="header-anchor" href="#sharding-jdbc" aria-label="Permalink to &quot;Sharding-JDBC&quot;">​</a></h1><nav class="table-of-contents"><ul><li><a href="#sharding-jdbc原理篇">Sharding-JDBC原理篇</a><ul><li><a href="#sql解析">SQL解析</a></li><li><a href="#sql路由">SQL路由</a></li><li><a href="#sql改写">SQL改写</a></li><li><a href="#sql执行">SQL执行</a></li><li><a href="#结果归并">结果归并</a></li><li><a href="#分布式事务">分布式事务</a></li></ul></li><li><a href="#sharding-jdbc应用篇">Sharding-JDBC应用篇</a><ul><li><a href="#分库分表示例">分库分表示例</a></li><li><a href="#读写分离示例">读写分离示例</a></li></ul></li></ul></nav><h2 id="sharding-jdbc原理篇" tabindex="-1">Sharding-JDBC原理篇 <a class="header-anchor" href="#sharding-jdbc原理篇" aria-label="Permalink to &quot;Sharding-JDBC原理篇&quot;">​</a></h2><blockquote><p>ShardingSphere 提供。</p><ul><li><a href="https://shardingsphere.apache.org/document/current/cn/manual/sharding-proxy/" target="_blank" rel="noreferrer">《Sharding-Proxy》</a></li><li><a href="https://shardingsphere.apache.org/document/current/cn/manual/sharding-ui/" target="_blank" rel="noreferrer">《Sharding-UI》</a></li><li><a href="https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/usage/orchestration/" target="_blank" rel="noreferrer">《编排治理》</a></li><li><a href="https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/usage/transaction/" target="_blank" rel="noreferrer">《分布式事务》</a></li><li><a href="https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/usage/encrypt/" target="_blank" rel="noreferrer">《数据脱敏》</a></li></ul></blockquote><h3 id="sql解析" tabindex="-1">SQL解析 <a class="header-anchor" href="#sql解析" aria-label="Permalink to &quot;SQL解析&quot;">​</a></h3><p>当Sharding-JDBC接受到一条SQL语句时，会陆续执行 SQL解析 =&gt; 查询优化 =&gt; SQL路由 =&gt; SQL改写 =&gt; SQL执行=&gt; 结果归并 ，最终返回执行结果。</p><p>SQL解析过程分为词法解析和语法解析。 词法解析器用于将SQL拆解为不可再分的原子符号，称为Token。并根据不同数据库方言所提供的字典，将其归类为关键字，表达式，字面量和操作符。 再使用语法解析器将SQL转换为抽象语法树。</p><p>供分片使用的解析上下文包含查询选择项（Select Items）、表信息（Table）、分片条件（Sharding Condition）、 自增主键信息（Auto increment Primary Key）、排序信息（Order By）、分组信息（Group By）以及分页信息（Limit、Rownum、Top）</p><h3 id="sql路由" tabindex="-1">SQL路由 <a class="header-anchor" href="#sql路由" aria-label="Permalink to &quot;SQL路由&quot;">​</a></h3><h3 id="sql改写" tabindex="-1">SQL改写 <a class="header-anchor" href="#sql改写" aria-label="Permalink to &quot;SQL改写&quot;">​</a></h3><h3 id="sql执行" tabindex="-1">SQL执行 <a class="header-anchor" href="#sql执行" aria-label="Permalink to &quot;SQL执行&quot;">​</a></h3><h3 id="结果归并" tabindex="-1">结果归并 <a class="header-anchor" href="#结果归并" aria-label="Permalink to &quot;结果归并&quot;">​</a></h3><h3 id="分布式事务" tabindex="-1">分布式事务 <a class="header-anchor" href="#分布式事务" aria-label="Permalink to &quot;分布式事务&quot;">​</a></h3><p>Sharding-JDBC 提供了两种 <strong>柔性事务</strong>：</p><ul><li>最大努力送达型 BED ：已经实现</li><li>事务补偿型 TCC ：计划中</li></ul><h4 id="最大努力送达型" tabindex="-1">最大努力送达型 <a class="header-anchor" href="#最大努力送达型" aria-label="Permalink to &quot;最大努力送达型&quot;">​</a></h4><p><img src="'+p+'" alt="image-20230212144109161"></p><p>执行过程有 <strong>四种</strong> 情况：</p><ol><li>【红线】执行成功</li><li>【棕线】执行失败，同步重试成功</li><li>【粉线】执行失败，同步重试失败，异步重试成功</li><li>【绿线】执行失败，同步重试失败，异步重试失败，事务日志保留</li></ol><p>整体成漏斗倒三角，上一个阶段失败，交给下一个阶段重试：</p><p><img src="'+o+`" alt="image-20230212144134036"></p><p>整个过程通过如下 <strong>组件</strong> 完成：</p><ul><li>柔性事务管理器</li><li>最大努力送达型柔性事务</li><li>最大努力送达型事务监听器</li><li>事务日志存储器</li><li>最大努力送达型异步作业</li></ul><h2 id="sharding-jdbc应用篇" tabindex="-1">Sharding-JDBC应用篇 <a class="header-anchor" href="#sharding-jdbc应用篇" aria-label="Permalink to &quot;Sharding-JDBC应用篇&quot;">​</a></h2><h3 id="分库分表示例" tabindex="-1">分库分表示例 <a class="header-anchor" href="#分库分表示例" aria-label="Permalink to &quot;分库分表示例&quot;">​</a></h3><blockquote><p>代码对应仓库：<a href="https://gitee.com/git_liuxiaowei/hello-sharding-jdbc/tree/master/sharding-induction" target="_blank" rel="noreferrer">https://gitee.com/git_liuxiaowei/hello-sharding-jdbc/tree/master/sharding-induction</a></p></blockquote><h4 id="需求说明" tabindex="-1">需求说明 <a class="header-anchor" href="#需求说明" aria-label="Permalink to &quot;需求说明&quot;">​</a></h4><p>将 <code>orders</code> 订单表，拆分到 <strong>2</strong> 个库，每个库 <strong>4</strong> 个订单表，一共 <strong>8</strong> 个表。库表的情况如下：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">orders_0 库</span></span>
<span class="line"><span style="color:#A6ACCD;">  ├── orders_0</span></span>
<span class="line"><span style="color:#A6ACCD;">  └── orders_2</span></span>
<span class="line"><span style="color:#A6ACCD;">  └── orders_4</span></span>
<span class="line"><span style="color:#A6ACCD;">  └── orders_6</span></span>
<span class="line"><span style="color:#A6ACCD;">orders_1 库</span></span>
<span class="line"><span style="color:#A6ACCD;">  ├── orders_1</span></span>
<span class="line"><span style="color:#A6ACCD;">  └── orders_3</span></span>
<span class="line"><span style="color:#A6ACCD;">  └── orders_5</span></span>
<span class="line"><span style="color:#A6ACCD;">  └── orders_7</span></span></code></pre></div><ul><li>偶数后缀的表，在 <code>orders_0</code> 库下。</li><li>奇数后缀的表，在 <code>orders_1</code> 库下。</li></ul><p>使用订单表上的 <code>user_id</code> 用户编号，进行分库分表的规则：</p><ul><li>首先，按照 <code>index = user_id % 2</code> 计算，将记录路由到 <code>orders_\${index}</code> 库。</li><li>然后，按照 <code>index = user_id % 8</code> 计算，将记录路由到 <code>orders_\${index}</code> 表。</li></ul><p>部分表不需要分库分表，例如说 <code>order_config</code> 订单配置表，所以我们会配置路由到 <code>orders_0</code> 库下。</p><h4 id="数据准备" tabindex="-1">数据准备 <a class="header-anchor" href="#数据准备" aria-label="Permalink to &quot;数据准备&quot;">​</a></h4><p>在 <code>orders_0</code> 数据库下，创建 <code>orders_0</code>、<code>orders_2</code>、<code>orders_4</code>、<code>orders_6</code> 数据表。SQL 如下：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> NAMES utf8mb4;</span></span>
<span class="line"><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> FOREIGN_KEY_CHECKS </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">DROP</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">orders_0</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> \`</span><span style="color:#82AAFF;">orders_0</span><span style="color:#A6ACCD;">\` (</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">bigint</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> AUTO_INCREMENT COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">user_id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">16</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">用户编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">) ENGINE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">InnoDB AUTO_INCREMENT</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">8</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> CHARSET</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4 </span><span style="color:#C792EA;">COLLATE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4_bin COMMENT</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单表</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">DROP</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">orders_2</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> \`</span><span style="color:#82AAFF;">orders_2</span><span style="color:#A6ACCD;">\` (</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">bigint</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> AUTO_INCREMENT COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">user_id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">16</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">用户编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">) ENGINE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">InnoDB AUTO_INCREMENT</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">8</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> CHARSET</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4 </span><span style="color:#C792EA;">COLLATE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4_bin COMMENT</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单表</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">DROP</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">orders_4</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> \`</span><span style="color:#82AAFF;">orders_4</span><span style="color:#A6ACCD;">\` (</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">bigint</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> AUTO_INCREMENT COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">user_id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">16</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">用户编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">) ENGINE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">InnoDB AUTO_INCREMENT</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">8</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> CHARSET</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4 </span><span style="color:#C792EA;">COLLATE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4_bin COMMENT</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单表</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">DROP</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">orders_6</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> \`</span><span style="color:#82AAFF;">orders_6</span><span style="color:#A6ACCD;">\` (</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">bigint</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> AUTO_INCREMENT COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">user_id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">16</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">用户编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">) ENGINE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">InnoDB AUTO_INCREMENT</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">8</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> CHARSET</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4 </span><span style="color:#C792EA;">COLLATE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4_bin COMMENT</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单表</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> FOREIGN_KEY_CHECKS </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><p>在 <code>orders_1</code> 数据库下，创建 <code>orders_1</code>、<code>orders_3</code>、<code>orders_5</code>、<code>orders_7</code> 数据表。SQL 如下：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> NAMES utf8mb4;</span></span>
<span class="line"><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> FOREIGN_KEY_CHECKS </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">DROP</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">orders_1</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> \`</span><span style="color:#82AAFF;">orders_1</span><span style="color:#A6ACCD;">\` (</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">bigint</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> AUTO_INCREMENT COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">user_id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">16</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">用户编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">) ENGINE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">InnoDB AUTO_INCREMENT</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">400675304294580226</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> CHARSET</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4 </span><span style="color:#C792EA;">COLLATE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4_bin COMMENT</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单表</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">DROP</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">orders_3</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> \`</span><span style="color:#82AAFF;">orders_3</span><span style="color:#A6ACCD;">\` (</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">bigint</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> AUTO_INCREMENT COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">user_id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">16</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">用户编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">) ENGINE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">InnoDB AUTO_INCREMENT</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">8</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> CHARSET</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4 </span><span style="color:#C792EA;">COLLATE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4_bin COMMENT</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单表</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">DROP</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">orders_5</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> \`</span><span style="color:#82AAFF;">orders_5</span><span style="color:#A6ACCD;">\` (</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">bigint</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> AUTO_INCREMENT COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">user_id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">16</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">用户编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">) ENGINE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">InnoDB AUTO_INCREMENT</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">8</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> CHARSET</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4 </span><span style="color:#C792EA;">COLLATE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4_bin COMMENT</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单表</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">DROP</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">orders_7</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> \`</span><span style="color:#82AAFF;">orders_7</span><span style="color:#A6ACCD;">\` (</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">bigint</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> AUTO_INCREMENT COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">user_id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">16</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">用户编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">) ENGINE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">InnoDB AUTO_INCREMENT</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">8</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> CHARSET</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4 </span><span style="color:#C792EA;">COLLATE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4_bin COMMENT</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单表</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> FOREIGN_KEY_CHECKS </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><p>在 <code>orders_0</code> 数据库下，创建 <code>order_config</code> 数据表。SQL 如下：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">DROP</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">order_config</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> \`</span><span style="color:#82AAFF;">order_config</span><span style="color:#A6ACCD;">\` (</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> AUTO_INCREMENT COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">pay_timeout</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">支付超时时间;单位：分钟</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">) ENGINE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">InnoDB </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> CHARSET</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4 </span><span style="color:#C792EA;">COLLATE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4_bin COMMENT</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单配置表</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><h4 id="pom依赖" tabindex="-1">Pom依赖 <a class="header-anchor" href="#pom依赖" aria-label="Permalink to &quot;Pom依赖&quot;">​</a></h4><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">&lt;!-- 实现对 Sharding-JDBC 的自动化配置 --&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">dependency</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">groupId</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">org.apache.shardingsphere</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">groupId</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">artifactId</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">sharding-jdbc-spring-boot-starter</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">artifactId</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">version</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">4.0.0-RC2</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">version</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">dependency</span><span style="color:#89DDFF;">&gt;</span></span></code></pre></div><h4 id="实体类" tabindex="-1">实体类 <a class="header-anchor" href="#实体类" aria-label="Permalink to &quot;实体类&quot;">​</a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * 订单 DO</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Data</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">OrderDO</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 订单编号</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Long</span><span style="color:#A6ACCD;"> id</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 用户编号</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Integer</span><span style="color:#A6ACCD;"> userId</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * 订单配置 DO</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Data</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">OrderConfigDO</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 编号</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Integer</span><span style="color:#A6ACCD;"> id</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 支付超时时间</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 单位：分钟</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Integer</span><span style="color:#A6ACCD;"> payTimeout</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h4 id="mapper类" tabindex="-1">Mapper类 <a class="header-anchor" href="#mapper类" aria-label="Permalink to &quot;Mapper类&quot;">​</a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Mapper</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">interface</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">OrderMapper</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">OrderDO</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">selectById</span><span style="color:#89DDFF;">(@</span><span style="color:#C792EA;">Param</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Integer</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">id</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">OrderDO</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">selectListByUserId</span><span style="color:#89DDFF;">(@</span><span style="color:#C792EA;">Param</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">userId</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Integer</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">userId</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">insert</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">OrderDO</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Mapper</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">interface</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">OrderConfigMapper</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">OrderConfigDO</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">selectById</span><span style="color:#89DDFF;">(@</span><span style="color:#C792EA;">Param</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Integer</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">id</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>在 <code>resources/mapper</code> 路径下，创建 <code>OrderMapper.xml</code> <code>OrderConfigMapper.xml</code></p><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;?</span><span style="color:#F07178;">xml</span><span style="color:#C792EA;"> version</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1.0</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;"> encoding</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">UTF-8</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">?&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;!</span><span style="color:#F78C6C;">DOCTYPE</span><span style="color:#89DDFF;"> </span><span style="color:#A6ACCD;">mapper</span><span style="color:#89DDFF;"> PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">mapper</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">namespace</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.open.sharding.mapper.OrderMapper</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">sql</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">id</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">FIELDS</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">        id, user_id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">sql</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">select</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">id</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">selectById</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">parameterType</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Integer</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">resultType</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">OrderDO</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">        SELECT</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">include</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">refid</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">FIELDS</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">        FROM orders</span></span>
<span class="line"><span style="color:#A6ACCD;">        WHERE id = #{id}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">select</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">select</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">id</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">selectListByUserId</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">parameterType</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Integer</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">resultType</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">OrderDO</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">        SELECT</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">include</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">refid</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">FIELDS</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">        FROM orders</span></span>
<span class="line"><span style="color:#A6ACCD;">        WHERE user_id = #{userId}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">select</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">insert</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">id</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">insert</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">parameterType</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">OrderDO</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">useGeneratedKeys</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">true</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">keyProperty</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">        INSERT INTO orders (</span></span>
<span class="line"><span style="color:#A6ACCD;">            user_id</span></span>
<span class="line"><span style="color:#A6ACCD;">        ) VALUES (</span></span>
<span class="line"><span style="color:#A6ACCD;">            #{userId}</span></span>
<span class="line"><span style="color:#A6ACCD;">        )</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">insert</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">mapper</span><span style="color:#89DDFF;">&gt;</span></span></code></pre></div><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;?</span><span style="color:#F07178;">xml</span><span style="color:#C792EA;"> version</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1.0</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;"> encoding</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">UTF-8</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">?&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;!</span><span style="color:#F78C6C;">DOCTYPE</span><span style="color:#89DDFF;"> </span><span style="color:#A6ACCD;">mapper</span><span style="color:#89DDFF;"> PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">mapper</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">namespace</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.open.sharding.mapper.OrderConfigMapper</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">sql</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">id</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">FIELDS</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">        id, pay_timeout</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">sql</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">select</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">id</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">selectById</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">parameterType</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Integer</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">resultType</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">OrderConfigDO</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">        SELECT</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">include</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">refid</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">FIELDS</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">        FROM order_config</span></span>
<span class="line"><span style="color:#A6ACCD;">        WHERE id = #{id}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">select</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">mapper</span><span style="color:#89DDFF;">&gt;</span></span></code></pre></div><h4 id="全局配置文件" tabindex="-1">全局配置文件 <a class="header-anchor" href="#全局配置文件" aria-label="Permalink to &quot;全局配置文件&quot;">​</a></h4><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F07178;">spring</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;"># ShardingSphere 配置项</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">shardingsphere</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">datasource</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;"># 所有数据源的名字</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">names</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ds-orders-0, ds-orders-1</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;"># 订单 orders 数据源配置 00</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">ds-orders-0</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">type</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">com.zaxxer.hikari.HikariDataSource</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">driver-class-name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">com.mysql.cj.jdbc.Driver</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">jdbc-url</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">jdbc:mysql://127.0.0.1:3306/orders_0?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">username</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">password</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">xxxxxx</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;"># 订单 orders 数据源配置 01</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">ds-orders-1</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">type</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">com.zaxxer.hikari.HikariDataSource</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">driver-class-name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">com.mysql.cj.jdbc.Driver</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">jdbc-url</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">jdbc:mysql://127.0.0.1:3306/orders_1?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">username</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">password</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">xxxxxx</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;"># 分片规则</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">sharding</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">tables</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;"># orders 表配置</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">orders</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># 映射到 ds-orders-0 和 ds-orders-1 数据源的 orders 表们</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">actualDataNodes</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ds-orders-0.orders_$-&gt;{[0,2,4,6]}, ds-orders-1.orders_$-&gt;{[1,3,5,7]}</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">key-generator</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 主键生成策略</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F07178;">column</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">id</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F07178;">type</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">SNOWFLAKE</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">database-strategy</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F07178;">inline</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#F07178;">algorithm-expression</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ds-orders-$-&gt;{user_id % 2}</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#F07178;">sharding-column</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">user_id</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">table-strategy</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F07178;">inline</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#F07178;">algorithm-expression</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">orders_$-&gt;{user_id % 8}</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#F07178;">sharding-column</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">user_id</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;"># order_config 表配置</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">order_config</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># 仅映射到 ds-orders-0 数据源的 order_config 表</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">actualDataNodes</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ds-orders-0.order_config</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;"># 拓展属性配置</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">props</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">sql</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">show</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 打印 SQL</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># mybatis-plus 配置内容</span></span>
<span class="line"><span style="color:#F07178;">mybatis-plus</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">configuration</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">map-underscore-to-camel-case</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 默认为 true</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">global-config</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">db-config</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">id-type</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">none</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 虽然 MyBatis Plus 也提供 ID 生成策略，但是还是使用 Sharding-JDBC 的</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">logic-delete-value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 逻辑已删除值(默认为 1)</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">logic-not-delete-value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 逻辑未删除值(默认为 0)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">mapper-locations</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">classpath*:mapper/*.xml</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">type-aliases-package</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">com.open.sharding.pojo</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">logging</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">level</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">root</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">info</span></span></code></pre></div><ul><li><p>在 <code>spring.shardingsphere</code> 配置项下，设置 <code>sharding-jdbc-spring-boot-starter</code> 自动化配置 Sharding-JDBC 需要的参数。</p><p><code>spring.shardingsphere.datasource</code> 配置项，我们配置了 <code>ds-orders-0</code> 和 <code>ds-orders-1</code> 两个数据源，分别对应 <code>orders_0</code> 和 <code>orders_1</code> 两个数据库。</p><p><code>spring.shardingsphere.sharding</code> 配置项，我们配置了 <code>orders</code> 和 <code>order_config</code> <a href="https://shardingsphere.apache.org/document/current/cn/features/sharding/concept/sql/" target="_blank" rel="noreferrer">逻辑表</a> 。</p><blockquote><p><strong>逻辑表</strong> ：水平拆分的数据库（表）的相同逻辑和数据结构表的总称。逻辑表名为 <code>orders</code> 。</p><p><strong>真实表</strong> ：在分片的数据库中真实存在的物理表。即示例中的 <code>orders_0</code> 到 <code>orders_7</code> 。</p><p><strong>数据节点</strong> ：数据分片的最小单元。由数据源名称和数据表组成，例：<code>ds-orders-0.orders_0</code> 。</p></blockquote></li><li><p><code>orders</code>配置项，设置<code>orders</code>逻辑表，使用分库分表的规则。</p><ul><li><p><code>actualDataNodes</code> ：对应的数据节点，使用的是<a href="https://shardingsphere.apache.org/document/current/cn/features/sharding/other-features/inline-expression/" target="_blank" rel="noreferrer">行表达式</a> 。</p><p><code>ds-orders-0.orders_0</code>, <code>ds-orders-0.orders_2</code>, <code>ds-orders-0.orders_4</code>, <code>ds-orders-0.orders_6</code>;</p><p><code>ds-orders-1.orders_1</code>, <code>ds-orders-1.orders_3</code>, <code>ds-orders-1.orders_5</code>, <code>ds-orders-1.orders_7</code></p></li><li><p><code>key-generator</code> ：主键生成策略。这里采用分布式主键 SNOWFLAKE 方案。参考 <a href="https://shardingsphere.apache.org/document/current/cn/features/sharding/other-features/key-generator/" target="_blank" rel="noreferrer">《 ShardingSphere &gt; 概念 &amp; 功能 &gt; 数据分片 &gt; 其他功能 &gt; 分布式主键》</a> 文档。</p></li><li><p><code>database-strategy</code> ：按照 <code>index = user_id % 2</code> 分库，路由到 <code>ds-orders-\${index}</code> 数据源（库）。</p></li><li><p><code>table-strategy</code> ：<code>index = user_id % 8</code> 分表，路由到 <code>orders_\${index}</code> 数据表。</p></li></ul></li><li><p><code>order_config</code>配置项，设置<code>order_config</code>逻辑表，不使用分库分表。</p><ul><li><code>actualDataNodes</code> ：对应的数据节点，只对应数据源（库）为 <code>ds-orders-0</code> 的 <code>order_config</code> 表。</li></ul></li><li><p><code>spring.shardingsphere.props</code> 配置项，设置拓展属性配置。</p><ul><li><code>sql.show</code> ：设置打印 SQL</li></ul></li></ul><h4 id="单元测试" tabindex="-1">单元测试 <a class="header-anchor" href="#单元测试" aria-label="Permalink to &quot;单元测试&quot;">​</a></h4><h5 id="orderconfigmappertest-testselectbyid" tabindex="-1">OrderConfigMapperTest#testSelectById() <a class="header-anchor" href="#orderconfigmappertest-testselectbyid" aria-label="Permalink to &quot;OrderConfigMapperTest#testSelectById()&quot;">​</a></h5><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">RunWith</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SpringRunner</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">SpringBootTest</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">classes</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Application</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">OrderConfigMapperTest</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Autowired</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">OrderConfigMapper</span><span style="color:#A6ACCD;"> orderConfigMapper</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Test</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">testSelectById</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">OrderConfigDO</span><span style="color:#A6ACCD;"> orderConfig </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orderConfigMapper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">selectById</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">orderConfig</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>执行日志：</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">02</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">54.561</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">13348</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : Rule Type: sharding</span></span>
<span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">02</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">54.561</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">13348</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : \`Logic SQL\`: SELECT</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span></span>
<span class="line"><span style="color:#A6ACCD;">        id, pay_timeout</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">        FROM order_config</span></span>
<span class="line"><span style="color:#A6ACCD;">        WHERE id = ?</span></span>
<span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">02</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">54.561</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">13348</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : \`Actual SQL\`: ds-orders</span><span style="color:#F78C6C;">-0</span><span style="color:#A6ACCD;"> ::: SELECT</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span></span>
<span class="line"><span style="color:#A6ACCD;">        id, pay_timeout</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">        FROM order_config</span></span>
<span class="line"><span style="color:#A6ACCD;">        WHERE id = ? ::: </span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">OrderConfigDO(id=</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">, payTimeout=</span><span style="color:#F78C6C;">30</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><ul><li>Logic SQL ：逻辑 SQL 日志，就是我们编写的。</li><li>Actual SQL ：物理 SQL 日志，实际 Sharding-JDBC 向数据库真正发起的日志。 <ul><li>在这里，我们可以看到 <code>ds-orders-0</code> ，表名该物理 SQL ，是路由到 <code>ds-orders-0</code> 数据源执行。</li><li>同时，查询的是 <code>order_config</code> 表。</li><li>符合我们配置的 <code>order_config</code> 逻辑表，不使用分库分表，对应的数据节点仅有 <code>ds-orders-0.order_config</code> 。</li></ul></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">RunWith</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SpringRunner</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">SpringBootTest</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">classes</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> HelloShardingJdbcApplication</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">OrderMapperTest</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Autowired</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">OrderMapper</span><span style="color:#A6ACCD;"> orderMapper</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Test</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">testSelectById</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 根据订单id查询结果集</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">OrderDO</span><span style="color:#A6ACCD;"> order </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orderMapper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">selectById</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">order</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Test</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">testSelectListByUserId</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 根据用户id查询结果集</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">OrderDO</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> orders </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orderMapper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">selectListByUserId</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">orders</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">size</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Test</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">testInsert</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">OrderDO</span><span style="color:#A6ACCD;"> order </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">OrderDO</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        order</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setUserId</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        orderMapper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">insert</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">order</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h5 id="ordermappertest-testselectbyid" tabindex="-1">OrderMapperTest#testSelectById() <a class="header-anchor" href="#ordermappertest-testselectbyid" aria-label="Permalink to &quot;OrderMapperTest#testSelectById()&quot;">​</a></h5><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">06</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">59.063</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">12768</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : Rule Type: sharding</span></span>
<span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">06</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">59.063</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">12768</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : \`Logic SQL\`: SELECT</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span></span>
<span class="line"><span style="color:#A6ACCD;">        id, user_id</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">        FROM orders</span></span>
<span class="line"><span style="color:#A6ACCD;">        WHERE id = ?</span></span>
<span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">06</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">59.064</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">12768</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : Actual SQL: ds-orders</span><span style="color:#F78C6C;">-0</span><span style="color:#A6ACCD;"> ::: SELECT</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span></span>
<span class="line"><span style="color:#A6ACCD;">        id, user_id</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">        FROM orders_</span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">        WHERE id = ? ::: </span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">06</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">59.064</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">12768</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : Actual SQL: ds-orders</span><span style="color:#F78C6C;">-0</span><span style="color:#A6ACCD;"> ::: SELECT</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span></span>
<span class="line"><span style="color:#A6ACCD;">        id, user_id</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">        FROM orders_</span><span style="color:#F78C6C;">2</span></span>
<span class="line"><span style="color:#A6ACCD;">        WHERE id = ? ::: </span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">06</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">59.064</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">12768</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : Actual SQL: ds-orders</span><span style="color:#F78C6C;">-0</span><span style="color:#A6ACCD;"> ::: SELECT</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span></span>
<span class="line"><span style="color:#A6ACCD;">        id, user_id</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">        FROM orders_</span><span style="color:#F78C6C;">4</span></span>
<span class="line"><span style="color:#A6ACCD;">        WHERE id = ? ::: </span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">06</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">59.064</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">12768</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : Actual SQL: ds-orders</span><span style="color:#F78C6C;">-0</span><span style="color:#A6ACCD;"> ::: SELECT</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span></span>
<span class="line"><span style="color:#A6ACCD;">        id, user_id</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">        FROM orders_</span><span style="color:#F78C6C;">6</span></span>
<span class="line"><span style="color:#A6ACCD;">        WHERE id = ? ::: </span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">06</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">59.064</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">12768</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : Actual SQL: ds-orders</span><span style="color:#F78C6C;">-1</span><span style="color:#A6ACCD;"> ::: SELECT</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span></span>
<span class="line"><span style="color:#A6ACCD;">        id, user_id</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">        FROM orders_</span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">        WHERE id = ? ::: </span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">06</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">59.064</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">12768</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : Actual SQL: ds-orders</span><span style="color:#F78C6C;">-1</span><span style="color:#A6ACCD;"> ::: SELECT</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span></span>
<span class="line"><span style="color:#A6ACCD;">        id, user_id</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">        FROM orders_</span><span style="color:#F78C6C;">3</span></span>
<span class="line"><span style="color:#A6ACCD;">        WHERE id = ? ::: </span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">06</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">59.064</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">12768</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : Actual SQL: ds-orders</span><span style="color:#F78C6C;">-1</span><span style="color:#A6ACCD;"> ::: SELECT</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span></span>
<span class="line"><span style="color:#A6ACCD;">        id, user_id</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">        FROM orders_</span><span style="color:#F78C6C;">5</span></span>
<span class="line"><span style="color:#A6ACCD;">        WHERE id = ? ::: </span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">06</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">59.064</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">12768</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : Actual SQL: ds-orders</span><span style="color:#F78C6C;">-1</span><span style="color:#A6ACCD;"> ::: SELECT</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span></span>
<span class="line"><span style="color:#A6ACCD;">        id, user_id</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">        FROM orders_</span><span style="color:#F78C6C;">7</span></span>
<span class="line"><span style="color:#A6ACCD;">        WHERE id = ? ::: </span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#89DDFF;">null</span></span></code></pre></div><ul><li><p>明明只有一条 Logic SQL 操作，却发起了 8 条 Actual SQL 操作。这是为什么呢？</p></li><li><p>我们使用 <code>id = ?</code> 作为查询条件，因为 Sharding-JDBC 解析不到我们配置的 <code>user_id</code> 片键（分库分表字段），作为查询字段，所以只好 <a href="https://shardingsphere.apache.org/document/current/cn/features/sharding/principle/route/#%E5%85%A8%E5%BA%93%E8%A1%A8%E8%B7%AF%E7%94%B1" target="_blank" rel="noreferrer">全库表路由</a> ，查询所有对应的数据节点，也就是配置的所有数据库的数据表。这样，在获得所有查询结果后，通过 <a href="https://shardingsphere.apache.org/document/current/cn/features/sharding/principle/merge/" target="_blank" rel="noreferrer">归并引擎</a> 合并返回最终结果。</p><blockquote><p>通过将 Actual SQL 在每个数据库的数据表执行，返回的结果都是符合条件的。</p><p>这样，和使用 Logic SQL 在逻辑表中执行的结果，实际是一致的。</p><p>胖友可以试着想一想噢。如果还是有疑惑，可以给艿艿留言。</p></blockquote></li><li><p>那么，一次性发起这么多条 Actual SQL 是不是会顺序执行，导致很慢呢？实际上，Sharding-JDBC 有 <a href="https://shardingsphere.apache.org/document/current/cn/features/sharding/principle/execute/" target="_blank" rel="noreferrer">执行引擎</a> ，会并行执行这多条 Actual SQL 操作。所以呢，最终操作时长，由最慢的 Actual SQL 所决定。</p></li><li><p>虽然说，<a href="https://shardingsphere.apache.org/document/current/cn/features/sharding/principle/execute/" target="_blank" rel="noreferrer">执行引擎</a> 提供了并行执行 Actual SQL 操作的能力，我们还是推荐尽可能查询的时候，带有片键（分库分表字段）。对 Sharding-JDBC 性能感兴趣的胖友，可以看看 <a href="https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/stress-test/" target="_blank" rel="noreferrer">《Sharding-JDBC 性能测试报告》</a> 。</p></li></ul><h5 id="ordermappertest-testselectlistbyuserid" tabindex="-1">OrderMapperTest#testSelectListByUserId() <a class="header-anchor" href="#ordermappertest-testselectlistbyuserid" aria-label="Permalink to &quot;OrderMapperTest#testSelectListByUserId()&quot;">​</a></h5><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">54.621</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">13152</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : Rule Type: sharding</span></span>
<span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">54.621</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">13152</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : \`Logic SQL\`: SELECT</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span></span>
<span class="line"><span style="color:#A6ACCD;">        id, user_id</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">        FROM orders</span></span>
<span class="line"><span style="color:#A6ACCD;">        WHERE user_id = ?</span></span>
<span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">54.621</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">13152</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : \`Actual SQL\`: ds-orders</span><span style="color:#F78C6C;">-1</span><span style="color:#A6ACCD;"> ::: SELECT</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span></span>
<span class="line"><span style="color:#A6ACCD;">        id, user_id</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">        FROM orders_</span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">        WHERE user_id = ? ::: </span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#F78C6C;">2</span></span></code></pre></div><ul><li>一条 Logic SQL 操作，发起了 1 条 Actual SQL 操作。这是为什么呢？</li><li>我们使用<code>user_id = ?</code>作为查询条件，因为 Sharding-JDBC 解析到我们配置的<code>user_id</code>片键（分库分表字段），作为查询字段，所以可以标准路由，仅查询一个数据节点。这种，是 Sharding-JDBC 最为推荐使用的分片方式。 <ul><li>分库：<code>user_id % 2 = 1 % 2 = 1</code> ，所以路由到 <code>ds-orders-1</code> 数据源。</li><li>分表：<code>user_id % 8 = 1 % 8 = 1</code> ，所以路由到 <code>orders_1</code> 数据表。</li><li>两者一结合，只查询 <code>ds-orders-1.orders_1</code> 数据节点。</li></ul></li></ul><h5 id="ordermappertest-testinsert" tabindex="-1">OrderMapperTest#testInsert() <a class="header-anchor" href="#ordermappertest-testinsert" aria-label="Permalink to &quot;OrderMapperTest#testInsert()&quot;">​</a></h5><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">13</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">21.115</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">14180</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : Rule Type: sharding</span></span>
<span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">13</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">21.115</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">14180</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : \`Logic SQL\`: INSERT INTO orders (</span></span>
<span class="line"><span style="color:#A6ACCD;">            user_id</span></span>
<span class="line"><span style="color:#A6ACCD;">        ) VALUES (</span></span>
<span class="line"><span style="color:#A6ACCD;">            ?</span></span>
<span class="line"><span style="color:#A6ACCD;">        )</span></span>
<span class="line"><span style="color:#F78C6C;">2023-02-12</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">13</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">21.116</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">14180</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : \`Actual SQL\`: ds-orders</span><span style="color:#F78C6C;">-1</span><span style="color:#A6ACCD;"> ::: INSERT INTO orders_</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> (</span></span>
<span class="line"><span style="color:#A6ACCD;">            user_id</span></span>
<span class="line"><span style="color:#A6ACCD;">        , id) VALUES (?, ?) ::: </span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">831532516513939457</span><span style="color:#89DDFF;">]</span></span></code></pre></div><ul><li>不考虑 <a href="https://shardingsphere.apache.org/document/current/cn/features/sharding/concept/sql/" target="_blank" rel="noreferrer">广播表</a> 的情况下，插入语句必须带有片键（分库分表字段），否则 <a href="https://shardingsphere.apache.org/document/current/cn/features/sharding/principle/execute/" target="_blank" rel="noreferrer">执行引擎</a> 不知道插入到哪个数据库的哪个数据表中。毕竟，插入操作必然是单库单表。</li><li>我们会发现，Actual SQL 相比 Logic SQL 来说，增加了主键 <code>id</code> 为 <code>400772257330233345</code> 。这是为什么呢？我们配置 <code>orders</code> 逻辑表，使用 SNOWFLAKE 算法生成分布式主键，而 <a href="https://shardingsphere.apache.org/document/current/cn/features/sharding/principle/rewrite/" target="_blank" rel="noreferrer">改写引擎</a> 在发现我们的 Logic SQL 并未设置插入的 <code>id</code> 主键编号，它会自动生成主键，改写 Logic SQL ，附加 <code>id</code> 成 Logic SQL 。</li></ul><h3 id="读写分离示例" tabindex="-1">读写分离示例 <a class="header-anchor" href="#读写分离示例" aria-label="Permalink to &quot;读写分离示例&quot;">​</a></h3><h4 id="数据准备-1" tabindex="-1">数据准备 <a class="header-anchor" href="#数据准备-1" aria-label="Permalink to &quot;数据准备&quot;">​</a></h4><p>创建表的 SQL 如下：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">DROP</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">orders</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> \`</span><span style="color:#82AAFF;">orders</span><span style="color:#A6ACCD;">\` (</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> AUTO_INCREMENT COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">user_id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">16</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">用户编号</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">) ENGINE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">InnoDB AUTO_INCREMENT</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> CHARSET</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4 </span><span style="color:#C792EA;">COLLATE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4_bin COMMENT</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单表</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><h4 id="全局配置文件-1" tabindex="-1">全局配置文件 <a class="header-anchor" href="#全局配置文件-1" aria-label="Permalink to &quot;全局配置文件&quot;">​</a></h4><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F07178;">spring</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;"># ShardingSphere 配置项</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">shardingsphere</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;"># 数据源配置</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">datasource</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;"># 所有数据源的名字</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">names</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ds-master, ds-slave-1, ds-slave-2</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;"># 订单 orders 主库的数据源配置</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">ds-master</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">type</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">com.zaxxer.hikari.HikariDataSource</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 使用 Hikari 数据库连接池</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">driver-class-name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">com.mysql.cj.jdbc.Driver</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">jdbc-url</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">jdbc:mysql://127.0.0.1:3306/test_orders?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">username</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">password</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">xxxxxx</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;"># 订单 orders 从库数据源配置</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">ds-slave-1</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">type</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">com.zaxxer.hikari.HikariDataSource</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 使用 Hikari 数据库连接池</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">driver-class-name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">com.mysql.cj.jdbc.Driver</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">jdbc-url</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">jdbc:mysql://127.0.0.1:3306/test_orders_01?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">username</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">password</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">xxxxxx</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;"># 订单 orders 从库数据源配置</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">ds-slave-2</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">type</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">com.zaxxer.hikari.HikariDataSource</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 使用 Hikari 数据库连接池</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">driver-class-name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">com.mysql.cj.jdbc.Driver</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">jdbc-url</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">jdbc:mysql://127.0.0.1:3306/test_orders_02?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">username</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">password</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">xxxxxx</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;"># 读写分离配置，对应 YamlMasterSlaveRuleConfiguration 配置类</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">masterslave</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ms</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 名字，任意，需要保证唯一</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">master-data-source-name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ds-master</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 主库数据源</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">slave-data-source-names</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ds-slave-1, ds-slave-2</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 从库数据源</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;"># 拓展属性配置</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">props</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">sql</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">show</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 打印 SQL</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># mybatis-plus 配置内容</span></span>
<span class="line"><span style="color:#F07178;">mybatis-plus</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">configuration</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">map-underscore-to-camel-case</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 默认为 true</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">global-config</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">db-config</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">id-type</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">none</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 虽然 MyBatis Plus 也提供 ID 生成策略，但是还是使用 Sharding-JDBC 的</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">logic-delete-value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 逻辑已删除值(默认为 1)</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">logic-not-delete-value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 逻辑未删除值(默认为 0)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">mapper-locations</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">classpath*:mapper/*.xml</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">type-aliases-package</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">com.open.sharding.pojo</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">logging</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">level</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">root</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">info</span></span></code></pre></div><ul><li><code>spring.shardingsphere.datasource</code> 配置项下，我们配置了 一个主数据源 <code>ds-master</code> 、两个从数据源 <code>ds-slave-1</code>、<code>ds-slave-2</code> 。</li><li><code>spring.shardingsphere.masterslave</code> 配置项下，配置了读写分离。对于从库来说，Sharding-JDBC 提供了多种负载均衡策略，默认为轮询。</li><li>因为艿艿本地并未搭建 MySQL 一主多从的环境，所以是通过创建了 <code>test_orders_01</code>、<code>test_orders_02</code> 库，手动模拟作为 <code>test_orders</code> 的从库。</li></ul><h4 id="单元测试-1" tabindex="-1">单元测试 <a class="header-anchor" href="#单元测试-1" aria-label="Permalink to &quot;单元测试&quot;">​</a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">RunWith</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SpringRunner</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">SpringBootTest</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">classes</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Application</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">OrderMapperTest</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Autowired</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">OrderMapper</span><span style="color:#A6ACCD;"> orderMapper</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Test</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">testSelectById</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 测试从库的负载均衡</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">OrderDO</span><span style="color:#A6ACCD;"> order </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orderMapper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">selectById</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">order</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Test</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">testSelectById02</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 测试强制访问主库</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">HintManager</span><span style="color:#A6ACCD;"> hintManager </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> HintManager</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getInstance</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;font-style:italic;">// 设置强制访问主库</span></span>
<span class="line"><span style="color:#A6ACCD;">            hintManager</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setMasterRouteOnly</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;font-style:italic;">// 执行查询</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">OrderDO</span><span style="color:#A6ACCD;"> order </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orderMapper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">selectById</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">order</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Test</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">testInsert</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">OrderDO</span><span style="color:#A6ACCD;"> order </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">OrderDO</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        order</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setUserId</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 插入</span></span>
<span class="line"><span style="color:#A6ACCD;">        orderMapper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">insert</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">order</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>① <code>#testSelectById()</code> 测试方法</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 第 1 次查询</span></span>
<span class="line"><span style="color:#F78C6C;">2022-11-11</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">23</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">49</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">27.414</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">35306</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : Rule Type: master-slave</span></span>
<span class="line"><span style="color:#F78C6C;">2022-11-11</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">23</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">49</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">27.414</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">35306</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : SQL: SELECT id,user_id FROM orders WHERE id=?  ::: DataSources: ds-slave</span><span style="color:#F78C6C;">-1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 第 2 次查询</span></span>
<span class="line"><span style="color:#F78C6C;">2022-11-11</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">23</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">49</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">27.454</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">35306</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : Rule Type: master-slave</span></span>
<span class="line"><span style="color:#F78C6C;">2022-11-11</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">23</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">49</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">27.454</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">35306</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : SQL: SELECT id,user_id FROM orders WHERE id=?  ::: DataSources: ds-slave</span><span style="color:#F78C6C;">-2</span></span></code></pre></div><ul><li>默认情况下，Sharding-JDBC 使用 <a href="https://shardingsphere.apache.org/document/current/cn/features/read-write-split/" target="_blank" rel="noreferrer">读写分离</a> 功能时，读取从库。</li><li>并且，支持从库的负载均衡，默认采用<strong>轮询</strong>的算法。所以，我们可以看到第 1 次查询 <code>ds-slave-1</code> 数据源，第 2 次查询 <code>ds-slave-2</code> 数据源。</li></ul><p>② <code>#testSelectById02()</code> 测试方法</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">2022-11-11</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">23</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">56</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">09.669</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">35430</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : Rule Type: master-slave</span></span>
<span class="line"><span style="color:#F78C6C;">2022-11-11</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">23</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">56</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">09.669</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">35430</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : SQL: SELECT id,user_id FROM orders WHERE id=?  ::: DataSources: ds-master</span></span></code></pre></div><ul><li><p>测试强制访问主库。在一些业务场景下，对数据延迟敏感，所以只能强制读取主库。此时，可以使用</p><p><code>HintManager</code>强制访问主库。</p><ul><li>不过要注意，在使用完后，需要去清理下 HintManager （HintManager 是基于线程变量，透传给 Sharding-JDBC 的内部实现），避免污染下次请求，一直强制访问主库。</li><li>Sharding-JDBC 比较贴心，HintManager 实现了 AutoCloseable 接口，可以通过 <a href="https://www.cnblogs.com/barrywxx/p/9993005.html" target="_blank" rel="noreferrer">Try-with-resources</a> 机制，自动关闭。</li></ul></li></ul><p>③ <code>#testInsert()</code> 测试方法</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">2022-11-11</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">23</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">57</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">27.046</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">35469</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : Rule Type: master-slave</span></span>
<span class="line"><span style="color:#F78C6C;">2022-11-11</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">23</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">57</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">27.047</span><span style="color:#A6ACCD;">  INFO </span><span style="color:#F78C6C;">35469</span><span style="color:#A6ACCD;"> --- </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">           main</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> ShardingSphere-SQL                       : SQL: INSERT INTO orders  ( id,</span></span>
<span class="line"><span style="color:#A6ACCD;">user_id )  VALUES  ( ?, ? ) ::: DataSources: ds-master</span></span></code></pre></div><ul><li>写入操作时，直接访问主库 <code>ds-master</code> 数据源。</li></ul><h4 id="业务测试" tabindex="-1">业务测试 <a class="header-anchor" href="#业务测试" aria-label="Permalink to &quot;业务测试&quot;">​</a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Service</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">OrderService</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Autowired</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">OrderMapper</span><span style="color:#A6ACCD;"> orderMapper</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Transactional</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">OrderDO</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// &lt;1.1&gt; 这里会读取从库</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">OrderDO</span><span style="color:#A6ACCD;"> exists </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orderMapper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">selectById</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">exists</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// &lt;1.2&gt; 插入订单</span></span>
<span class="line"><span style="color:#A6ACCD;">        orderMapper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">insert</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">order</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// &lt;1.3&gt; 这里会读取主库</span></span>
<span class="line"><span style="color:#A6ACCD;">        exists </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orderMapper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">selectById</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">exists</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">OrderDO</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">findById</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Integer</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">id</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> orderMapper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">selectById</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><ul><li>在<code>#add(OrderDO order)</code>方法中，开启事务，插入一条订单记录。 <ul><li><code>&lt;1.1&gt;</code> 处，往<strong>从库</strong>发起一次订单查询。在 Sharding-JDBC 的读写分离策略里，默认读取从库。</li><li><code>&lt;1.2&gt;</code> 处，往<strong>主库</strong>发起一次订单写入。写入，肯定是操作主库的。</li><li><code>&lt;1.3&gt;</code> 处，往<strong>主库</strong>发起一次订单查询。在 Sharding-JDBC 中，读写分离约定：<strong>同一线程且同一数据库连接内，如有写入操作，以后的读操作均从主库读取，用于保证数据一致性。</strong></li></ul></li><li>在 <code>#findById(Integer id)</code> 方法，往<strong>从库</strong>发起一次订单查询。</li></ul>`,91),t=[r];function c(C,y,D,A,F,i){return a(),n("div",null,t)}const u=s(e,[["render",c]]);export{E as __pageData,u as default};
